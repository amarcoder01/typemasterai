{"file_contents":{"client/src/pages/login.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useLocation, useSearch } from \"wouter\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { AlertCircle, Mail, Lock } from \"lucide-react\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Label } from \"@/components/ui/label\";\nimport confetti from \"canvas-confetti\";\nimport {\n  AuthLayout,\n  AuthPanel,\n  AuthPanelHeader,\n  AuthPanelContent,\n  AuthPanelFooter,\n  AuthInput,\n  CapsLockWarning,\n  SocialButton,\n  SubmitButton,\n  AuthDivider,\n  AuthLink,\n} from \"@/components/auth\";\n\ninterface ProviderAvailability {\n  google: boolean;\n  github: boolean;\n  facebook: boolean;\n}\n\nexport default function Login() {\n  const [, setLocation] = useLocation();\n  const searchString = useSearch();\n  const { login } = useAuth();\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [rememberMe, setRememberMe] = useState(false);\n  const [error, setError] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [isSuccess, setIsSuccess] = useState(false);\n  const [capsLockOn, setCapsLockOn] = useState(false);\n\n  const { data: providers } = useQuery<ProviderAvailability>({\n    queryKey: [\"provider-availability\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/auth/providers/availability\");\n      if (!response.ok) {\n        return { google: false, github: false, facebook: false };\n      }\n      return response.json();\n    },\n    staleTime: 5 * 60 * 1000,\n  });\n\n  const isProviderAvailable = (provider: keyof ProviderAvailability) => {\n    return providers?.[provider] ?? false;\n  };\n\n  const anyProviderAvailable = providers && (providers.google || providers.github || providers.facebook);\n\n  useEffect(() => {\n    const params = new URLSearchParams(searchString);\n    const errorParam = params.get(\"error\");\n    if (errorParam) {\n      const errorMessages: Record<string, string> = {\n        google_failed: \"Google sign-in failed. Please try again.\",\n        github_failed: \"GitHub sign-in failed. Please try again.\",\n        facebook_failed: \"Facebook sign-in failed. Please try again.\",\n        oauth_error: \"An error occurred during sign-in. Please try again.\",\n        invalid_state: \"Session expired. Please try signing in again.\",\n        provider_not_configured: \"This sign-in method is not available.\",\n      };\n      setError(errorMessages[errorParam] || \"Sign-in failed. Please try again.\");\n    }\n  }, [searchString]);\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    setCapsLockOn(e.getModifierState(\"CapsLock\"));\n  };\n\n  const triggerSuccessConfetti = () => {\n    confetti({\n      particleCount: 100,\n      spread: 70,\n      origin: { y: 0.6 },\n      colors: ['#6366f1', '#8b5cf6', '#a855f7'],\n    });\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(\"\");\n    setIsLoading(true);\n\n    try {\n      await login(email, password, rememberMe);\n      setIsSuccess(true);\n      triggerSuccessConfetti();\n      setTimeout(() => setLocation(\"/\"), 800);\n    } catch (err: any) {\n      setError(err.message || \"Invalid email or password. Please try again.\");\n      setIsLoading(false);\n    }\n  };\n\n  const handleSocialLogin = (provider: \"google\" | \"github\" | \"facebook\") => {\n    if (!isProviderAvailable(provider)) {\n      setError(\"This sign-in method is not currently available.\");\n      return;\n    }\n    window.location.href = `/api/auth/${provider}`;\n  };\n\n  return (\n    <AuthLayout\n      title=\"Welcome Back\"\n      subtitle=\"Sign in to continue your typing journey. Track your progress, compete with others, and improve your skills with AI-powered practice.\"\n    >\n      <AuthPanel>\n        <form onSubmit={handleSubmit}>\n          <AuthPanelHeader\n            title=\"Sign In\"\n            description=\"Enter your credentials to access your account\"\n          />\n          \n          <AuthPanelContent>\n            <AnimatePresence mode=\"wait\">\n              {error && (\n                <motion.div\n                  initial={{ opacity: 0, y: -10, scale: 0.95 }}\n                  animate={{ opacity: 1, y: 0, scale: 1 }}\n                  exit={{ opacity: 0, y: -10, scale: 0.95 }}\n                  transition={{ duration: 0.2 }}\n                >\n                  <Alert variant=\"destructive\" className=\"bg-red-500/10 border-red-500/30\">\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <AlertDescription>{error}</AlertDescription>\n                  </Alert>\n                </motion.div>\n              )}\n            </AnimatePresence>\n\n            {anyProviderAvailable && (\n              <motion.div \n                className=\"grid gap-3\"\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                transition={{ delay: 0.1 }}\n              >\n                {isProviderAvailable(\"google\") && (\n                  <SocialButton\n                    provider=\"google\"\n                    onClick={() => handleSocialLogin(\"google\")}\n                    delay={1}\n                    disabled={isLoading}\n                  />\n                )}\n                {isProviderAvailable(\"github\") && (\n                  <SocialButton\n                    provider=\"github\"\n                    onClick={() => handleSocialLogin(\"github\")}\n                    delay={2}\n                    disabled={isLoading}\n                  />\n                )}\n                {isProviderAvailable(\"facebook\") && (\n                  <SocialButton\n                    provider=\"facebook\"\n                    onClick={() => handleSocialLogin(\"facebook\")}\n                    delay={3}\n                    disabled={isLoading}\n                  />\n                )}\n              </motion.div>\n            )}\n\n            {anyProviderAvailable && <AuthDivider />}\n\n            <AuthInput\n              label=\"Email\"\n              type=\"email\"\n              placeholder=\"you@example.com\"\n              value={email}\n              onChange={(e) => setEmail(e.target.value)}\n              required\n              data-testid=\"input-email\"\n              tooltip=\"Enter the email address you used to create your account\"\n              icon={<Mail className=\"h-4 w-4\" />}\n              delay={4}\n            />\n\n            <div className=\"space-y-2\">\n              <AuthInput\n                label=\"Password\"\n                type=\"password\"\n                placeholder=\"Enter your password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                onKeyDown={handleKeyDown}\n                required\n                data-testid=\"input-password\"\n                tooltip=\"Enter your account password\"\n                icon={<Lock className=\"h-4 w-4\" />}\n                delay={5}\n              />\n              \n              <AnimatePresence>\n                <CapsLockWarning show={capsLockOn} />\n              </AnimatePresence>\n\n              <motion.div \n                className=\"flex justify-end\"\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                transition={{ delay: 0.6 }}\n              >\n                <button\n                  type=\"button\"\n                  onClick={() => setLocation(\"/forgot-password\")}\n                  className=\"text-xs text-primary hover:text-primary/80 transition-colors\"\n                  data-testid=\"link-forgot-password\"\n                >\n                  Forgot password?\n                </button>\n              </motion.div>\n            </div>\n\n            <motion.div \n              className=\"flex items-center space-x-2\"\n              initial={{ opacity: 0, x: -20 }}\n              animate={{ opacity: 1, x: 0 }}\n              transition={{ delay: 0.6 }}\n            >\n              <Checkbox\n                id=\"remember-me\"\n                checked={rememberMe}\n                onCheckedChange={(checked) => setRememberMe(checked === true)}\n                data-testid=\"checkbox-remember-me\"\n                className=\"border-zinc-700 data-[state=checked]:bg-primary data-[state=checked]:border-primary\"\n              />\n              <Label htmlFor=\"remember-me\" className=\"text-sm font-normal cursor-pointer text-zinc-400\">\n                Remember me for 30 days\n              </Label>\n            </motion.div>\n          </AuthPanelContent>\n          \n          <AuthPanelFooter>\n            <div className=\"space-y-4\">\n              <SubmitButton\n                isLoading={isLoading}\n                isSuccess={isSuccess}\n                disabled={isLoading || isSuccess}\n              >\n                Sign In\n              </SubmitButton>\n\n              <AuthLink\n                text=\"Don't have an account?\"\n                linkText=\"Sign up\"\n                onClick={() => setLocation(\"/register\")}\n                testId=\"link-register\"\n              />\n            </div>\n          </AuthPanelFooter>\n        </form>\n      </AuthPanel>\n    </AuthLayout>\n  );\n}\n","path":null,"size_bytes":9157,"size_tokens":null},"client/src/pages/terms-of-service.tsx":{"content":"import { Link } from \"wouter\";\n\nexport default function TermsOfService() {\n  return (\n    <div className=\"max-w-4xl mx-auto\" data-testid=\"page-terms-of-service\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-4xl font-bold mb-2\" data-testid=\"heading-terms-of-service\">Terms of Service</h1>\n        <p className=\"text-muted-foreground text-sm mb-4\">Last Updated: December 9, 2025</p>\n        <p className=\"text-muted-foreground text-lg\">\n          Welcome to TypeMasterAI! These Terms of Service govern your use of our typing test platform. By using TypeMasterAI, you agree to these terms.\n        </p>\n      </div>\n\n      <div className=\"space-y-10 prose prose-invert max-w-none\">\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">1. Acceptance of Terms</h2>\n          <p className=\"text-muted-foreground\">\n            By accessing or using TypeMasterAI (\"the Service\"), you agree to be bound by these Terms of Service and our <Link href=\"/privacy-policy\" className=\"text-primary hover:underline\">Privacy Policy</Link>. If you do not agree to these terms, please do not use the Service.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">2. Description of Service</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            TypeMasterAI provides:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>AI-powered typing speed tests in 23+ languages</li>\n            <li>Real-time performance analytics and progress tracking</li>\n            <li>Global leaderboards and competitive rankings</li>\n            <li>AI chat assistant for typing improvement tips</li>\n            <li>Custom content generation and paragraph modes</li>\n            <li>Downloadable achievement certificates</li>\n            <li>User profiles and personalization features</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">3. User Accounts</h2>\n          \n          <h3 className=\"text-xl font-semibold text-foreground mb-3\">3.1 Account Creation</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            To access certain features, you must create an account. You agree to:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Provide accurate, current, and complete information</li>\n            <li>Maintain and update your information as needed</li>\n            <li>Keep your password secure and confidential</li>\n            <li>Be at least 13 years of age</li>\n            <li>Notify us immediately of any unauthorized access</li>\n          </ul>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">3.2 Account Responsibility</h3>\n          <p className=\"text-muted-foreground\">\n            You are responsible for all activities that occur under your account. TypeMasterAI is not liable for any loss or damage arising from unauthorized use of your account.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">4. Acceptable Use Policy</h2>\n          \n          <h3 className=\"text-xl font-semibold text-foreground mb-3\">4.1 Permitted Use</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            You may use TypeMasterAI for:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Personal typing practice and skill improvement</li>\n            <li>Educational purposes and learning</li>\n            <li>Fair competition on leaderboards</li>\n            <li>Legitimate interaction with AI features</li>\n          </ul>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">4.2 Prohibited Activities</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            You must not:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Use automated scripts, bots, or cheating tools to manipulate test results</li>\n            <li>Create multiple accounts to artificially inflate rankings</li>\n            <li>Attempt to gain unauthorized access to our systems or other users' accounts</li>\n            <li>Harass, abuse, or harm other users</li>\n            <li>Upload malicious code, viruses, or harmful content</li>\n            <li>Scrape, copy, or replicate our content or data without permission</li>\n            <li>Reverse engineer, decompile, or disassemble any part of the Service</li>\n            <li>Use the Service for any illegal or unauthorized purpose</li>\n            <li>Violate any applicable laws or regulations</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">5. AI-Generated Content</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            TypeMasterAI uses third-party artificial intelligence services for content generation. You acknowledge that:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>AI-generated content may occasionally contain errors or inaccuracies</li>\n            <li>Content is generated in real-time and may vary in quality</li>\n            <li>We do not guarantee the suitability of all AI-generated content</li>\n            <li>You should report any inappropriate or offensive content immediately</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">6. Intellectual Property Rights</h2>\n          \n          <h3 className=\"text-xl font-semibold text-foreground mb-3\">6.1 Our Property</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            TypeMasterAI and all content, features, and functionality are owned by TypeMasterAI and protected by copyright, trademark, and other intellectual property laws. This includes:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Website design, graphics, and user interface</li>\n            <li>TypeMasterAI name, logo, and branding</li>\n            <li>Software, code, and algorithms</li>\n            <li>Typing test paragraphs and content database</li>\n          </ul>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">6.2 Your Content</h3>\n          <p className=\"text-muted-foreground\">\n            You retain ownership of your profile information and custom content. By using TypeMasterAI, you grant us a worldwide, non-exclusive, royalty-free license to use, display, and process your data as necessary to provide the Service and as described in our Privacy Policy.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">7. Leaderboards and Rankings</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            Our leaderboards display typing performance publicly. By participating:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Your username and scores will be publicly visible</li>\n            <li>Rankings are calculated based on legitimate test results</li>\n            <li>We reserve the right to remove suspicious or fraudulent scores</li>\n            <li>Cheating or manipulation may result in account suspension or ban</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">8. Disclaimer of Warranties</h2>\n          <p className=\"text-muted-foreground\">\n            THE SERVICE IS PROVIDED \"AS IS\" AND \"AS AVAILABLE\" WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR IMPLIED. TypeMasterAI DOES NOT WARRANT THAT:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2 mt-4\">\n            <li>The Service will be uninterrupted, secure, or error-free</li>\n            <li>Results from typing tests are completely accurate</li>\n            <li>Defects will be corrected immediately</li>\n            <li>The Service is free from viruses or harmful components</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">9. Limitation of Liability</h2>\n          <p className=\"text-muted-foreground\">\n            TO THE MAXIMUM EXTENT PERMITTED BY LAW, TypeMasterAI SHALL NOT BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, CONSEQUENTIAL, OR PUNITIVE DAMAGES, OR ANY LOSS OF PROFITS OR REVENUES, WHETHER INCURRED DIRECTLY OR INDIRECTLY, OR ANY LOSS OF DATA, USE, OR OTHER INTANGIBLE LOSSES.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">10. Indemnification</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            You agree to indemnify, defend, and hold harmless TypeMasterAI, its affiliates, officers, directors, employees, agents, licensors, and suppliers from and against any claims, liabilities, damages, judgments, awards, losses, costs, expenses, or fees (including reasonable attorneys' fees) arising out of or relating to:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Your violation of these Terms of Service</li>\n            <li>Your use of the Service in a manner that infringes intellectual property rights or violates laws</li>\n            <li>Any content you submit, post, or transmit through the Service</li>\n            <li>Your violation of any rights of another user or third party</li>\n            <li>Any fraudulent or manipulative activity on your account</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">11. Force Majeure</h2>\n          <p className=\"text-muted-foreground\">\n            TypeMasterAI shall not be liable for any failure or delay in performing its obligations under these Terms if such failure or delay results from circumstances beyond its reasonable control, including but not limited to: acts of God, natural disasters, pandemics, war, terrorism, riots, government actions, power failures, internet outages, third-party service provider failures, or cyberattacks. In such events, our obligations shall be suspended for the duration of the force majeure event.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">12. Account Termination</h2>\n          \n          <h3 className=\"text-xl font-semibold text-foreground mb-3\">12.1 Termination by You</h3>\n          <p className=\"text-muted-foreground\">\n            You may delete your account at any time through your account settings. Upon deletion, your personal data will be removed in accordance with our Privacy Policy.\n          </p>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">12.2 Termination by Us</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            We may suspend or terminate your account if:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>You violate these Terms of Service</li>\n            <li>You engage in fraudulent, abusive, or illegal activities</li>\n            <li>Your account has been inactive for an extended period</li>\n            <li>We are required to do so by law</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">13. Service Availability</h2>\n          <p className=\"text-muted-foreground\">\n            TypeMasterAI is currently free to use. We reserve the right to:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Introduce premium features or subscription plans in the future</li>\n            <li>Modify, suspend, or discontinue any part of the Service</li>\n            <li>Change pricing with reasonable notice</li>\n            <li>Implement usage limits or rate limiting</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">14. Changes to Terms</h2>\n          <p className=\"text-muted-foreground\">\n            We may update these Terms of Service at any time. Significant changes will be communicated via email or a prominent notice on the platform. Your continued use of TypeMasterAI after changes constitutes acceptance of the new terms.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">15. Governing Law</h2>\n          <p className=\"text-muted-foreground\">\n            These Terms shall be governed by and construed in accordance with the laws of India, without regard to its conflict of law provisions. Any disputes arising from these Terms or your use of the Service shall be subject to the exclusive jurisdiction of the courts in Solapur, Maharashtra, India.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">16. Severability</h2>\n          <p className=\"text-muted-foreground\">\n            If any provision of these Terms is found to be invalid or unenforceable, the remaining provisions shall continue in full force and effect.\n          </p>\n        </section>\n\n        <section className=\"bg-card/30 p-8 rounded-xl border border-border\">\n          <h2 className=\"text-2xl font-bold text-foreground mb-6\">Contact Information</h2>\n          <p className=\"text-muted-foreground mb-6\">\n            For questions about these Terms of Service, please contact us:\n          </p>\n          <div className=\"space-y-4\">\n            <div>\n              <p className=\"text-sm font-semibold text-foreground mb-1\">Email</p>\n              <a href=\"mailto:support@typemasterai.com\" className=\"text-primary hover:underline text-lg\">\n                support@typemasterai.com\n              </a>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-foreground mb-1\">Mailing Address</p>\n              <p className=\"text-muted-foreground\">\n                TypeMasterAI<br />\n                Solapur, Maharashtra 413224<br />\n                India\n              </p>\n            </div>\n          </div>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":14962,"size_tokens":null},"client/src/pages/contact.tsx":{"content":"import { Button } from \"@/components/ui/button\";\n\nexport default function Contact() {\n  return (\n    <div className=\"max-w-4xl mx-auto\" data-testid=\"page-contact\">\n      <div className=\"mb-16 text-center\">\n        <h1 className=\"text-5xl font-bold mb-4\" data-testid=\"heading-contact\">Contact Support</h1>\n        <p className=\"text-xl text-muted-foreground max-w-2xl mx-auto leading-relaxed\">\n          Our support team is here to assist you. Reach out to us through the channels below.\n        </p>\n      </div>\n\n      <div className=\"space-y-12 mb-12\">\n        <section>\n          <h2 className=\"text-3xl font-bold mb-8 pb-3 border-b-2 border-primary/20\">\n            Contact Channels\n          </h2>\n          <div className=\"grid md:grid-cols-2 gap-8\">\n            <div className=\"bg-card/30 p-10 rounded-xl border border-border\">\n              <h3 className=\"font-semibold text-2xl mb-4 text-primary\">Support</h3>\n              <p className=\"text-muted-foreground mb-6 leading-relaxed text-lg\">\n                Get in touch with our support team for assistance.\n              </p>\n              <a\n                href=\"mailto:support@typemasterai.com\"\n                className=\"text-primary hover:underline font-medium text-xl\"\n                data-testid=\"link-email-general\"\n              >\n                support@typemasterai.com\n              </a>\n            </div>\n\n            <div className=\"bg-card/30 p-10 rounded-xl border border-border\">\n              <h3 className=\"font-semibold text-2xl mb-4 text-primary\">Business Inquiries</h3>\n              <p className=\"text-muted-foreground mb-6 leading-relaxed text-lg\">\n                For partnerships and business opportunities.\n              </p>\n              <a\n                href=\"mailto:business@typemasterai.com\"\n                className=\"text-primary hover:underline font-medium text-xl\"\n                data-testid=\"link-email-business\"\n              >\n                business@typemasterai.com\n              </a>\n            </div>\n          </div>\n        </section>\n\n        <section className=\"bg-gradient-to-r from-primary/10 via-purple-500/10 to-primary/10 p-12 rounded-2xl border border-primary/20\">\n          <div className=\"text-center\">\n            <h2 className=\"text-3xl font-bold mb-6\">Response Time</h2>\n            <p className=\"text-muted-foreground text-lg leading-relaxed max-w-2xl mx-auto\">\n              We typically respond to all inquiries within <span className=\"text-primary font-semibold\">24-48 hours</span> during business days.\n            </p>\n          </div>\n        </section>\n\n        <section className=\"text-center pt-8\">\n          <h2 className=\"text-3xl font-bold mb-6\">Get in Touch</h2>\n          <p className=\"text-muted-foreground text-lg mb-10 max-w-xl mx-auto\">\n            Our team is ready to help you with whatever you need.\n          </p>\n          <a\n            href=\"mailto:support@typemasterai.com\"\n            data-testid=\"link-email-footer\"\n          >\n            <Button size=\"lg\" className=\"px-12 py-6 text-lg\" data-testid=\"button-contact-support\">\n              Contact Support\n            </Button>\n          </a>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":3197,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500 data-[state=open]:animate-in data-[state=closed]:animate-out\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4 border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n      {children}\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4280,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 text-sm font-medium transition-all hover:underline text-left [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 text-muted-foreground transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":2001,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":724,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-9 items-center justify-center rounded-lg bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-md px-3 py-1 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1877,"size_tokens":null},"server/app.ts":{"content":"import { type Server } from \"node:http\";\n\nimport express, { type Express, type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { requestIdMiddleware, errorHandler, notFoundHandler } from \"./error-middleware\";\nimport { metricsCollector } from \"./metrics\";\nimport { registerShutdownHandlers } from \"./graceful-shutdown\";\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport const app = express();\n\napp.set('trust proxy', 1);\n\napp.use(requestIdMiddleware);\n\napp.use((req, _res, next) => {\n  (req as any).startTime = Date.now();\n  next();\n});\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\napp.use(express.json({\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  },\n  limit: '10mb',\n}));\napp.use(express.urlencoded({ extended: false, limit: '10mb' }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  metricsCollector.recordRequest();\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    metricsCollector.recordResponseTime(duration);\n    \n    if (res.statusCode >= 500) {\n      metricsCollector.recordError();\n    }\n    \n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"â€¦\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\nexport default async function runApp(\n  setup: (app: Express, server: Server) => Promise<void>,\n) {\n  metricsCollector.initialize();\n  \n  const server = await registerRoutes(app);\n\n  registerShutdownHandlers(server);\n\n  app.use(\"/api/*\", notFoundHandler);\n  \n  app.use(errorHandler);\n\n  // importantly run the final setup after setting up all the other routes so\n  // the catch-all route doesn't interfere with the other routes\n  await setup(app, server);\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n}\n","path":null,"size_bytes":2905,"size_tokens":null},"client/src/lib/theme-context.tsx":{"content":"import { createContext, useContext, useState, useEffect, ReactNode } from \"react\";\n\ntype Theme = \"focus\" | \"light\" | \"ocean\" | \"forest\" | \"dracula\" | \"minimal\" | \"sunset\" | \"retro\" | \"cyber\";\n\ninterface ThemeContextType {\n  theme: Theme;\n  setTheme: (theme: Theme) => void;\n}\n\nconst ThemeContext = createContext<ThemeContextType | undefined>(undefined);\n\nexport function ThemeProvider({ children }: { children: ReactNode }) {\n  const [theme, setThemeState] = useState<Theme>(() => {\n    const stored = localStorage.getItem(\"typemasterai-theme\");\n    return (stored as Theme) || \"focus\";\n  });\n\n  useEffect(() => {\n    const root = document.documentElement;\n    root.classList.remove(\"focus\", \"light\", \"ocean\", \"forest\", \"dracula\", \"minimal\", \"sunset\", \"retro\", \"cyber\");\n    root.classList.add(theme);\n    localStorage.setItem(\"typemasterai-theme\", theme);\n  }, [theme]);\n\n  const setTheme = (newTheme: Theme) => {\n    setThemeState(newTheme);\n  };\n\n  return (\n    <ThemeContext.Provider value={{ theme, setTheme }}>\n      {children}\n    </ThemeContext.Provider>\n  );\n}\n\nexport function useTheme() {\n  const context = useContext(ThemeContext);\n  if (context === undefined) {\n    throw new Error(\"useTheme must be used within a ThemeProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":1268,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-300 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5124,"size_tokens":null},"client/src/index.css":{"content":"@import \"tailwindcss\";\n@import \"tw-animate-css\";\n\n@custom-variant dark (&:is(.dark *));\n\n@theme inline {\n  --color-background: hsl(var(--background));\n  --color-foreground: hsl(var(--foreground));\n  --color-card: hsl(var(--card));\n  --color-card-foreground: hsl(var(--card-foreground));\n  --color-popover: hsl(var(--popover));\n  --color-popover-foreground: hsl(var(--popover-foreground));\n  --color-primary: hsl(var(--primary));\n  --color-primary-foreground: hsl(var(--primary-foreground));\n  --color-secondary: hsl(var(--secondary));\n  --color-secondary-foreground: hsl(var(--secondary-foreground));\n  --color-muted: hsl(var(--muted));\n  --color-muted-foreground: hsl(var(--muted-foreground));\n  --color-accent: hsl(var(--accent));\n  --color-accent-foreground: hsl(var(--accent-foreground));\n  --color-destructive: hsl(var(--destructive));\n  --color-destructive-foreground: hsl(var(--destructive-foreground));\n  --color-border: hsl(var(--border));\n  --color-input: hsl(var(--input));\n  --color-ring: hsl(var(--ring));\n  --color-chart-1: hsl(var(--chart-1));\n  --color-chart-2: hsl(var(--chart-2));\n  --color-chart-3: hsl(var(--chart-3));\n  --color-chart-4: hsl(var(--chart-4));\n  --color-chart-5: hsl(var(--chart-5));\n  \n  --font-sans: \"DM Sans\", sans-serif;\n  --font-mono: \"JetBrains Mono\", monospace;\n\n  --radius: 0.5rem;\n}\n\n/* Focus Flow Theme - Dark (Default) */\n:root.focus,\n:root {\n  --background: 220 15% 10%;\n  --foreground: 220 10% 90%;\n  --card: 220 15% 13%;\n  --card-foreground: 220 10% 90%;\n  --popover: 220 15% 13%;\n  --popover-foreground: 220 10% 90%;\n  --primary: 45 100% 50%;\n  --primary-foreground: 220 15% 10%;\n  --secondary: 220 15% 20%;\n  --secondary-foreground: 220 10% 90%;\n  --muted: 220 15% 20%;\n  --muted-foreground: 220 10% 60%;\n  --accent: 220 15% 25%;\n  --accent-foreground: 45 100% 50%;\n  --destructive: 0 85% 60%;\n  --destructive-foreground: 210 40% 98%;\n  --border: 220 15% 20%;\n  --input: 220 15% 20%;\n  --ring: 45 100% 50%;\n  --radius: 0.5rem;\n  --chart-1: 45 100% 50%;\n  --chart-2: 170 100% 50%;\n  --chart-3: 280 80% 60%;\n  --chart-4: 340 80% 60%;\n  --chart-5: 20 80% 60%;\n}\n\n/* Light Theme */\n:root.light {\n  --background: 0 0% 100%;\n  --foreground: 222 47% 11%;\n  --card: 0 0% 98%;\n  --card-foreground: 222 47% 11%;\n  --popover: 0 0% 100%;\n  --popover-foreground: 222 47% 11%;\n  --primary: 45 93% 47%;\n  --primary-foreground: 0 0% 100%;\n  --secondary: 210 40% 96%;\n  --secondary-foreground: 222 47% 11%;\n  --muted: 210 40% 96%;\n  --muted-foreground: 215 16% 47%;\n  --accent: 210 40% 96%;\n  --accent-foreground: 222 47% 11%;\n  --destructive: 0 85% 60%;\n  --destructive-foreground: 0 0% 98%;\n  --border: 214 32% 91%;\n  --input: 214 32% 91%;\n  --ring: 45 93% 47%;\n  --chart-1: 45 93% 47%;\n  --chart-2: 160 60% 45%;\n  --chart-3: 280 65% 60%;\n  --chart-4: 340 75% 55%;\n  --chart-5: 20 70% 50%;\n}\n\n/* Cyberpunk Theme */\n:root.cyber {\n  --background: 280 50% 5%;\n  --foreground: 310 100% 95%;\n  --card: 280 50% 8%;\n  --card-foreground: 310 100% 95%;\n  --popover: 280 50% 8%;\n  --popover-foreground: 310 100% 95%;\n  --primary: 310 100% 60%;\n  --primary-foreground: 280 50% 5%;\n  --secondary: 280 40% 15%;\n  --secondary-foreground: 310 100% 95%;\n  --muted: 280 40% 15%;\n  --muted-foreground: 310 50% 70%;\n  --accent: 180 100% 50%;\n  --accent-foreground: 280 50% 5%;\n  --destructive: 0 100% 60%;\n  --destructive-foreground: 0 0% 100%;\n  --border: 280 40% 20%;\n  --input: 280 40% 20%;\n  --ring: 310 100% 60%;\n  --chart-1: 310 100% 60%;\n  --chart-2: 180 100% 50%;\n  --chart-3: 45 100% 50%;\n  --chart-4: 120 100% 50%;\n  --chart-5: 0 100% 60%;\n}\n\n/* Ocean Theme - Nordic inspired with cool blues */\n:root.ocean {\n  --background: 215 25% 12%;\n  --foreground: 215 20% 92%;\n  --card: 215 25% 15%;\n  --card-foreground: 215 20% 92%;\n  --popover: 215 25% 15%;\n  --popover-foreground: 215 20% 92%;\n  --primary: 195 85% 55%;\n  --primary-foreground: 215 25% 12%;\n  --secondary: 215 20% 20%;\n  --secondary-foreground: 215 20% 92%;\n  --muted: 215 20% 20%;\n  --muted-foreground: 215 15% 65%;\n  --accent: 195 70% 25%;\n  --accent-foreground: 195 85% 55%;\n  --destructive: 0 85% 60%;\n  --destructive-foreground: 210 40% 98%;\n  --border: 215 20% 22%;\n  --input: 215 20% 22%;\n  --ring: 195 85% 55%;\n  --chart-1: 195 85% 55%;\n  --chart-2: 165 75% 50%;\n  --chart-3: 235 70% 60%;\n  --chart-4: 280 65% 55%;\n  --chart-5: 145 80% 50%;\n}\n\n/* Forest Theme - Natural greens and earth tones */\n:root.forest {\n  --background: 140 20% 11%;\n  --foreground: 140 15% 90%;\n  --card: 140 20% 14%;\n  --card-foreground: 140 15% 90%;\n  --popover: 140 20% 14%;\n  --popover-foreground: 140 15% 90%;\n  --primary: 140 60% 50%;\n  --primary-foreground: 140 20% 11%;\n  --secondary: 140 15% 19%;\n  --secondary-foreground: 140 15% 90%;\n  --muted: 140 15% 19%;\n  --muted-foreground: 140 12% 62%;\n  --accent: 140 40% 24%;\n  --accent-foreground: 140 60% 50%;\n  --destructive: 0 85% 60%;\n  --destructive-foreground: 210 40% 98%;\n  --border: 140 15% 21%;\n  --input: 140 15% 21%;\n  --ring: 140 60% 50%;\n  --chart-1: 140 60% 50%;\n  --chart-2: 170 65% 45%;\n  --chart-3: 100 70% 50%;\n  --chart-4: 45 80% 55%;\n  --chart-5: 190 75% 50%;\n}\n\n/* Dracula Theme - Dark purple with vibrant accents */\n:root.dracula {\n  --background: 265 20% 13%;\n  --foreground: 265 10% 92%;\n  --card: 265 20% 16%;\n  --card-foreground: 265 10% 92%;\n  --popover: 265 20% 16%;\n  --popover-foreground: 265 10% 92%;\n  --primary: 330 85% 70%;\n  --primary-foreground: 265 20% 13%;\n  --secondary: 265 15% 21%;\n  --secondary-foreground: 265 10% 92%;\n  --muted: 265 15% 21%;\n  --muted-foreground: 265 10% 65%;\n  --accent: 265 30% 26%;\n  --accent-foreground: 330 85% 70%;\n  --destructive: 0 100% 67%;\n  --destructive-foreground: 0 0% 100%;\n  --border: 265 15% 23%;\n  --input: 265 15% 23%;\n  --ring: 330 85% 70%;\n  --chart-1: 330 85% 70%;\n  --chart-2: 195 80% 65%;\n  --chart-3: 135 75% 60%;\n  --chart-4: 265 85% 75%;\n  --chart-5: 50 90% 65%;\n}\n\n/* Minimal Theme - Clean monochromatic */\n:root.minimal {\n  --background: 0 0% 8%;\n  --foreground: 0 0% 95%;\n  --card: 0 0% 11%;\n  --card-foreground: 0 0% 95%;\n  --popover: 0 0% 11%;\n  --popover-foreground: 0 0% 95%;\n  --primary: 0 0% 85%;\n  --primary-foreground: 0 0% 10%;\n  --secondary: 0 0% 16%;\n  --secondary-foreground: 0 0% 95%;\n  --muted: 0 0% 16%;\n  --muted-foreground: 0 0% 60%;\n  --accent: 0 0% 21%;\n  --accent-foreground: 0 0% 95%;\n  --destructive: 0 85% 60%;\n  --destructive-foreground: 0 0% 98%;\n  --border: 0 0% 18%;\n  --input: 0 0% 18%;\n  --ring: 0 0% 85%;\n  --chart-1: 0 0% 75%;\n  --chart-2: 0 0% 65%;\n  --chart-3: 0 0% 55%;\n  --chart-4: 0 0% 45%;\n  --chart-5: 0 0% 35%;\n}\n\n/* Sunset Theme - Warm orange and pink tones */\n:root.sunset {\n  --background: 15 25% 12%;\n  --foreground: 30 15% 92%;\n  --card: 15 25% 15%;\n  --card-foreground: 30 15% 92%;\n  --popover: 15 25% 15%;\n  --popover-foreground: 30 15% 92%;\n  --primary: 25 90% 60%;\n  --primary-foreground: 15 25% 12%;\n  --secondary: 15 20% 20%;\n  --secondary-foreground: 30 15% 92%;\n  --muted: 15 20% 20%;\n  --muted-foreground: 30 12% 65%;\n  --accent: 340 70% 55%;\n  --accent-foreground: 15 25% 12%;\n  --destructive: 0 85% 60%;\n  --destructive-foreground: 210 40% 98%;\n  --border: 15 20% 22%;\n  --input: 15 20% 22%;\n  --ring: 25 90% 60%;\n  --chart-1: 25 90% 60%;\n  --chart-2: 340 80% 60%;\n  --chart-3: 10 85% 58%;\n  --chart-4: 350 75% 55%;\n  --chart-5: 35 85% 55%;\n}\n\n/* Retro Theme */\n:root.retro {\n  --background: 30 20% 15%;\n  --foreground: 40 70% 85%;\n  --card: 30 20% 18%;\n  --card-foreground: 40 70% 85%;\n  --popover: 30 20% 18%;\n  --popover-foreground: 40 70% 85%;\n  --primary: 25 95% 53%;\n  --primary-foreground: 30 20% 15%;\n  --secondary: 30 15% 25%;\n  --secondary-foreground: 40 70% 85%;\n  --muted: 30 15% 25%;\n  --muted-foreground: 40 40% 60%;\n  --accent: 160 70% 45%;\n  --accent-foreground: 30 20% 15%;\n  --destructive: 0 70% 55%;\n  --destructive-foreground: 0 0% 98%;\n  --border: 30 15% 30%;\n  --input: 30 15% 30%;\n  --ring: 25 95% 53%;\n  --chart-1: 25 95% 53%;\n  --chart-2: 160 70% 45%;\n  --chart-3: 200 80% 50%;\n  --chart-4: 340 70% 55%;\n  --chart-5: 50 90% 55%;\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n/* Custom Typing Animation - Legacy */\n@keyframes cursor-blink {\n  0%, 100% { opacity: 1; }\n  50% { opacity: 0; }\n}\n\n.animate-cursor-blink {\n  animation: cursor-blink 1s infinite;\n}\n\n/* Smooth Caret Blink Animation - Monkeytype/VSCode style */\n@keyframes caret-blink-phase {\n  0%, 40% { opacity: 1; }\n  50%, 90% { opacity: 0; }\n  100% { opacity: 1; }\n}\n\n.animate-caret-blink {\n  animation: caret-blink-phase 1.1s steps(1) infinite;\n  will-change: opacity;\n}\n\n/* Smooth caret with glow effect */\n@keyframes caret-glow {\n  0%, 100% { \n    box-shadow: 0 0 8px hsl(var(--primary) / 0.6), 0 0 16px hsl(var(--primary) / 0.3);\n    opacity: 1;\n  }\n  50% { \n    box-shadow: 0 0 4px hsl(var(--primary) / 0.3);\n    opacity: 0.4;\n  }\n}\n\n.animate-caret-smooth {\n  animation: caret-glow 1s ease-in-out infinite;\n  will-change: opacity, box-shadow;\n}\n\n/* Character typing animation */\n@keyframes char-appear {\n  0% { \n    opacity: 0.5;\n    transform: scale(0.95);\n  }\n  100% { \n    opacity: 1;\n    transform: scale(1);\n  }\n}\n\n.animate-char-type {\n  animation: char-appear 0.1s ease-out forwards;\n}\n\n/* Active line highlight */\n.typing-line-active {\n  background: linear-gradient(90deg, hsl(var(--primary) / 0.08) 0%, transparent 100%);\n  border-left: 2px solid hsl(var(--primary) / 0.3);\n  margin-left: -2px;\n}\n\n/* Error character styling */\n.typing-error {\n  position: relative;\n}\n\n.typing-error::after {\n  content: '';\n  position: absolute;\n  bottom: -2px;\n  left: 0;\n  right: 0;\n  height: 2px;\n  background: linear-gradient(90deg, \n    transparent 0%, \n    hsl(var(--destructive)) 25%, \n    transparent 50%, \n    hsl(var(--destructive)) 75%, \n    transparent 100%\n  );\n  background-size: 8px 2px;\n}\n\n/* GPU acceleration helper */\n.backface-visibility-hidden {\n  backface-visibility: hidden;\n  -webkit-backface-visibility: hidden;\n}\n\n/* Reduced motion support for accessibility */\n@media (prefers-reduced-motion: reduce) {\n  .animate-caret-blink,\n  .animate-caret-smooth,\n  [class*=\"animate-[caret-blink\"] {\n    animation: none !important;\n    opacity: 1 !important;\n  }\n}\n\n.glass-panel {\n  background: rgba(30, 35, 45, 0.7);\n  backdrop-filter: blur(12px);\n  border: 1px solid rgba(255, 255, 255, 0.05);\n}\n\n/* Web Search Animation Effects */\n@keyframes shimmer {\n  0% { background-position: 200% 0; }\n  100% { background-position: -200% 0; }\n}\n\n@keyframes progress-indeterminate {\n  0% { transform: translateX(-100%); }\n  50% { transform: translateX(0%); }\n  100% { transform: translateX(100%); }\n}\n\n.animate-shimmer {\n  animation: shimmer 2s linear infinite;\n  background-size: 200% 100%;\n}\n","path":null,"size_bytes":10735,"size_tokens":null},"client/src/pages/home.tsx":{"content":"import TypingTest from \"@/components/typing-test\";\nimport generatedImage from '@assets/generated_images/subtle_dark_geometric_pattern_background_for_typing_app.png';\n\nexport default function Home() {\n  return (\n      <div className=\"relative\">\n         {/* Ambient Background */}\n        <div className=\"fixed inset-0 z-[-1] opacity-20 pointer-events-none\">\n           <img src={generatedImage} alt=\"\" className=\"w-full h-full object-cover\" />\n           <div className=\"absolute inset-0 bg-background/80 backdrop-blur-[2px]\" />\n        </div>\n\n        <div className=\"flex flex-col items-center gap-3 sm:gap-4 mb-8 sm:mb-12 px-4 sm:px-0\">\n          <h2 className=\"text-3xl sm:text-4xl md:text-6xl font-bold tracking-tight text-center bg-clip-text text-transparent bg-gradient-to-b from-foreground to-foreground/40\">\n            Master the Flow\n          </h2>\n          <p className=\"text-muted-foreground text-base sm:text-lg max-w-xl text-center\">\n            Test your typing speed, track your progress, and compete with others in a distraction-free environment.\n          </p>\n        </div>\n\n        <TypingTest />\n      </div>\n  );\n}\n","path":null,"size_bytes":1141,"size_tokens":null},"client/src/components/ui/spinner.tsx":{"content":"import { Loader2Icon } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction Spinner({ className, ...props }: React.ComponentProps<\"svg\">) {\n  return (\n    <Loader2Icon\n      role=\"status\"\n      aria-label=\"Loading\"\n      className={cn(\"size-4 animate-spin\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Spinner }\n","path":null,"size_bytes":331,"size_tokens":null},"client/src/components/ui/kbd.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Kbd({ className, ...props }: React.ComponentProps<\"kbd\">) {\n  return (\n    <kbd\n      data-slot=\"kbd\"\n      className={cn(\n        \"bg-muted text-muted-foreground pointer-events-none inline-flex h-5 w-fit min-w-5 select-none items-center justify-center gap-1 rounded-sm px-1 font-sans text-xs font-medium\",\n        \"[&_svg:not([class*='size-'])]:size-3\",\n        \"[[data-slot=tooltip-content]_&]:bg-background/20 [[data-slot=tooltip-content]_&]:text-background dark:[[data-slot=tooltip-content]_&]:bg-background/10\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction KbdGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <kbd\n      data-slot=\"kbd-group\"\n      className={cn(\"inline-flex items-center gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Kbd, KbdGroup }\n","path":null,"size_bytes":862,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"client/src/lib/typing-utils.ts":{"content":"import { type ClassValue, clsx } from \"clsx\";\nimport { twMerge } from \"tailwind-merge\";\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs));\n}\n\nexport const WORDS = [\n  \"the\", \"be\", \"of\", \"and\", \"a\", \"to\", \"in\", \"he\", \"have\", \"it\", \"that\", \"for\", \"they\", \"I\", \"with\", \"as\", \"not\", \"on\", \"she\", \"at\", \"by\", \"this\", \"we\", \"you\", \"do\", \"but\", \"from\", \"or\", \"which\", \"one\", \"would\", \"all\", \"will\", \"there\", \"say\", \"who\", \"make\", \"when\", \"can\", \"more\", \"if\", \"no\", \"man\", \"out\", \"other\", \"so\", \"what\", \"time\", \"up\", \"go\", \"about\", \"than\", \"into\", \"could\", \"state\", \"only\", \"new\", \"year\", \"some\", \"take\", \"come\", \"these\", \"know\", \"see\", \"use\", \"get\", \"like\", \"then\", \"first\", \"any\", \"work\", \"now\", \"may\", \"such\", \"give\", \"over\", \"think\", \"most\", \"even\", \"find\", \"day\", \"also\", \"after\", \"way\", \"many\", \"must\", \"look\", \"before\", \"great\", \"back\", \"through\", \"long\", \"where\", \"much\", \"should\", \"well\", \"people\", \"down\", \"own\", \"just\", \"because\", \"good\", \"each\", \"those\", \"feel\", \"seem\", \"how\", \"high\", \"too\", \"place\", \"little\", \"world\", \"very\", \"still\", \"nation\", \"hand\", \"old\", \"life\", \"tell\", \"write\", \"become\", \"here\", \"show\", \"house\", \"both\", \"between\", \"need\", \"mean\", \"call\", \"develop\", \"under\", \"last\", \"right\", \"move\", \"thing\", \"general\", \"school\", \"never\", \"same\", \"another\", \"begin\", \"while\", \"number\", \"part\", \"turn\", \"real\", \"leave\", \"might\", \"want\", \"point\", \"form\", \"off\", \"child\", \"few\", \"small\", \"since\", \"against\", \"ask\", \"late\", \"home\", \"interest\", \"large\", \"person\", \"end\", \"open\", \"public\", \"follow\", \"during\", \"present\", \"without\", \"again\", \"hold\", \"govern\", \"around\", \"possible\", \"head\", \"consider\", \"word\", \"program\", \"problem\", \"however\", \"lead\", \"system\", \"set\", \"order\", \"eye\", \"plan\", \"run\", \"keep\", \"face\", \"fact\", \"group\", \"play\", \"stand\", \"increase\", \"early\", \"course\", \"change\", \"help\", \"line\"\n];\n\nexport function generateText(wordCount: number = 50): string {\n  const text = [];\n  for (let i = 0; i < wordCount; i++) {\n    text.push(WORDS[Math.floor(Math.random() * WORDS.length)]);\n  }\n  return text.join(\" \");\n}\n\nexport function calculateWPM(correctChars: number, timeElapsedSeconds: number): number {\n  if (timeElapsedSeconds === 0) return 0;\n  const words = correctChars / 5;\n  const minutes = timeElapsedSeconds / 60;\n  return Math.round(words / minutes);\n}\n\nexport function calculateAccuracy(correctChars: number, totalChars: number): number {\n  if (totalChars === 0) return 100;\n  return Math.round((correctChars / totalChars) * 100);\n}\n","path":null,"size_bytes":2492,"size_tokens":null},"client/src/components/ui/item.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Separator } from \"@/components/ui/separator\"\n\nfunction ItemGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      role=\"list\"\n      data-slot=\"item-group\"\n      className={cn(\"group/item-group flex flex-col\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction ItemSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"item-separator\"\n      orientation=\"horizontal\"\n      className={cn(\"my-0\", className)}\n      {...props}\n    />\n  )\n}\n\nconst itemVariants = cva(\n  \"group/item [a]:hover:bg-accent/50 focus-visible:border-ring focus-visible:ring-ring/50 [a]:transition-colors flex flex-wrap items-center rounded-md border border-transparent text-sm outline-none transition-colors duration-100 focus-visible:ring-[3px]\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline: \"border-border\",\n        muted: \"bg-muted/50\",\n      },\n      size: {\n        default: \"gap-4 p-4 \",\n        sm: \"gap-2.5 px-4 py-3\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction Item({\n  className,\n  variant = \"default\",\n  size = \"default\",\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> &\n  VariantProps<typeof itemVariants> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n  return (\n    <Comp\n      data-slot=\"item\"\n      data-variant={variant}\n      data-size={size}\n      className={cn(itemVariants({ variant, size, className }))}\n      {...props}\n    />\n  )\n}\n\nconst itemMediaVariants = cva(\n  \"flex shrink-0 items-center justify-center gap-2 group-has-[[data-slot=item-description]]/item:translate-y-0.5 group-has-[[data-slot=item-description]]/item:self-start [&_svg]:pointer-events-none\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        icon: \"bg-muted size-8 rounded-sm border [&_svg:not([class*='size-'])]:size-4\",\n        image:\n          \"size-10 overflow-hidden rounded-sm [&_img]:size-full [&_img]:object-cover\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nfunction ItemMedia({\n  className,\n  variant = \"default\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof itemMediaVariants>) {\n  return (\n    <div\n      data-slot=\"item-media\"\n      data-variant={variant}\n      className={cn(itemMediaVariants({ variant, className }))}\n      {...props}\n    />\n  )\n}\n\nfunction ItemContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-content\"\n      className={cn(\n        \"flex flex-1 flex-col gap-1 [&+[data-slot=item-content]]:flex-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-title\"\n      className={cn(\n        \"flex w-fit items-center gap-2 text-sm font-medium leading-snug\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <p\n      data-slot=\"item-description\"\n      className={cn(\n        \"text-muted-foreground line-clamp-2 text-balance text-sm font-normal leading-normal\",\n        \"[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemActions({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-actions\"\n      className={cn(\"flex items-center gap-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction ItemHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-header\"\n      className={cn(\n        \"flex basis-full items-center justify-between gap-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ItemFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"item-footer\"\n      className={cn(\n        \"flex basis-full items-center justify-between gap-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Item,\n  ItemMedia,\n  ItemContent,\n  ItemActions,\n  ItemGroup,\n  ItemSeparator,\n  ItemTitle,\n  ItemDescription,\n  ItemHeader,\n  ItemFooter,\n}\n","path":null,"size_bytes":4494,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-primary/10\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":266,"size_tokens":null},"client/src/components/ui/empty.tsx":{"content":"import { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction Empty({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty\"\n      className={cn(\n        \"flex min-w-0 flex-1 flex-col items-center justify-center gap-6 text-balance rounded-lg border-dashed p-6 text-center md:p-12\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-header\"\n      className={cn(\n        \"flex max-w-sm flex-col items-center gap-2 text-center\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst emptyMediaVariants = cva(\n  \"mb-2 flex shrink-0 items-center justify-center [&_svg]:pointer-events-none [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        icon: \"bg-muted text-foreground flex size-10 shrink-0 items-center justify-center rounded-lg [&_svg:not([class*='size-'])]:size-6\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nfunction EmptyMedia({\n  className,\n  variant = \"default\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof emptyMediaVariants>) {\n  return (\n    <div\n      data-slot=\"empty-icon\"\n      data-variant={variant}\n      className={cn(emptyMediaVariants({ variant, className }))}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-title\"\n      className={cn(\"text-lg font-medium tracking-tight\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <div\n      data-slot=\"empty-description\"\n      className={cn(\n        \"text-muted-foreground [&>a:hover]:text-primary text-sm/relaxed [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction EmptyContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"empty-content\"\n      className={cn(\n        \"flex w-full min-w-0 max-w-sm flex-col items-center gap-4 text-balance text-sm\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Empty,\n  EmptyHeader,\n  EmptyTitle,\n  EmptyDescription,\n  EmptyContent,\n  EmptyMedia,\n}\n","path":null,"size_bytes":2396,"size_tokens":null},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"import * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogTrigger,\n  DialogClose,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3835,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { leaderboardCache } from \"./leaderboard-cache\";\nimport { streamChatCompletionWithSearch, shouldPerformWebSearch, generateConversationTitle, type ChatMessage, type StreamEvent } from \"./chat-service\";\nimport { generateTypingParagraph } from \"./ai-paragraph-generator\";\nimport { generateCodeSnippet } from \"./ai-code-generator\";\nimport { analyzeFile } from \"./file-analyzer\";\nimport { processFeedbackInBackground } from \"./feedback-processor\";\nimport session from \"express-session\";\nimport passport from \"passport\";\nimport { Strategy as LocalStrategy } from \"passport-local\";\nimport bcrypt from \"bcryptjs\";\nimport { insertUserSchema, loginSchema, insertTestResultSchema, updateProfileSchema, insertKeystrokeAnalyticsSchema, insertCodeTypingTestSchema, insertSharedCodeResultSchema, insertBookTypingTestSchema, insertDictationTestSchema, submitFeedbackSchema, updateFeedbackStatusSchema, feedbackResponseSchema, insertCertificateSchema, type User } from \"@shared/schema\";\nimport { fromError } from \"zod-validation-error\";\nimport ConnectPgSimple from \"connect-pg-simple\";\nimport { Pool } from \"@neondatabase/serverless\";\nimport rateLimit from \"express-rate-limit\";\nimport DOMPurify from \"isomorphic-dompurify\";\nimport { raceWebSocket } from \"./websocket\";\nimport { botNamePool } from \"./bot-name-pool\";\nimport { botService } from \"./bot-service\";\nimport multer from \"multer\";\nimport { createNotificationRoutes } from \"./notification-routes\";\nimport { NotificationScheduler } from \"./notification-scheduler\";\nimport { AchievementService } from \"./achievement-service\";\nimport { AuthSecurityService } from \"./auth-security-service\";\nimport {\n  initializeOAuthStrategies,\n  rememberMeMiddleware,\n  setupRememberMeOnLogin,\n  clearRememberMeOnLogout,\n  REMEMBER_ME_COOKIE,\n  oauthRateLimitMiddleware,\n  initiateOAuthFlow,\n  handleOAuthCallbackFlow,\n  canUnlinkProvider,\n  getProviderAvailability,\n  logAuthEvent,\n  extractDeviceInfo,\n  regenerateSession,\n  checkRateLimit,\n} from \"./oauth-service\";\nimport { securityHeaders, csrfProtection } from \"./auth-security\";\nimport {\n  AuthError,\n  AuthErrorCode,\n  InputSanitizer,\n  PasswordValidator,\n  TokenSecurity,\n  DatabaseErrorHandler,\n  AuthLogger,\n  authErrors,\n  authErrorMiddleware,\n  payloadLimitMiddleware,\n  requestIdMiddleware,\n  addTimingJitter,\n  generateIdempotencyKey,\n  checkIdempotency,\n  storeIdempotencyResult,\n} from \"./auth-error-handling\";\n\nconst PgSession = ConnectPgSimple(session);\n\n// Generate cool guest usernames for anonymous players\nconst guestNamePrefixes = [\n  'Swift', 'Quick', 'Fast', 'Speedy', 'Rapid', 'Turbo', 'Nitro', 'Zoom', 'Dash', 'Flash',\n  'Pro', 'Ace', 'Champ', 'Star', 'Ninja', 'Wizard', 'Master', 'Legend', 'Elite', 'Epic',\n  'Cool', 'Super', 'Mega', 'Ultra', 'Hyper', 'Cyber', 'Tech', 'Pixel', 'Neon', 'Cosmic',\n  'Shadow', 'Ghost', 'Thunder', 'Storm', 'Blaze', 'Frost', 'Iron', 'Steel', 'Golden', 'Silver',\n  'Clever', 'Smart', 'Bright', 'Bold', 'Brave', 'Noble', 'Royal', 'Mystic', 'Magic', 'Power'\n];\nconst guestNameSuffixes = [\n  'Typer', 'Fingers', 'Keys', 'Writer', 'Racer', 'Runner', 'Coder', 'Dev', 'Fox', 'Wolf',\n  'Hawk', 'Eagle', 'Tiger', 'Lion', 'Bear', 'Shark', 'Dragon', 'Phoenix', 'Panther', 'Falcon',\n  'Rider', 'Knight', 'Hunter', 'Striker', 'Blazer', 'Glider', 'Crusher', 'Breaker', 'Slayer', 'Chaser',\n  'Spark', 'Pulse', 'Wave', 'Bolt', 'Blade', 'Arrow', 'Comet', 'Meteor', 'Nova', 'Vortex'\n];\n\nfunction generateGuestUsername(): string {\n  const prefix = guestNamePrefixes[Math.floor(Math.random() * guestNamePrefixes.length)];\n  const suffix = guestNameSuffixes[Math.floor(Math.random() * guestNameSuffixes.length)];\n  const num = Math.floor(Math.random() * 99) + 1;\n  return `${prefix}${suffix}${num}`;\n}\n\ndeclare global {\n  namespace Express {\n    interface User {\n      id: string;\n      username: string;\n      email: string;\n      avatarColor?: string | null;\n      bio?: string | null;\n      country?: string | null;\n      keyboardLayout?: string | null;\n    }\n  }\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  if (!process.env.DATABASE_URL) {\n    throw new Error(\"DATABASE_URL must be set\");\n  }\n\n  // Enforce SESSION_SECRET in production\n  if (process.env.NODE_ENV === \"production\" && !process.env.SESSION_SECRET) {\n    throw new Error(\n      \"ðŸš¨ CRITICAL SECURITY ERROR: SESSION_SECRET must be set in production!\\n\" +\n      \"Using a predictable session secret allows attackers to forge session cookies.\\n\" +\n      \"Set SESSION_SECRET environment variable to a secure random value (minimum 32 characters).\\n\" +\n      \"Generate one using: openssl rand -base64 32\"\n    );\n  }\n\n  const sessionSecret = process.env.SESSION_SECRET || \"typemasterai-secret-key-change-in-production\";\n  \n  botNamePool.initialize().catch(error => {\n    console.error(\"Failed to initialize bot name pool:\", error);\n  });\n\n  // Initialize notification system\n  const notificationScheduler = new NotificationScheduler(storage);\n  const achievementService = new AchievementService(storage, notificationScheduler);\n  \n  // Initialize achievements in database\n  achievementService.initializeAchievements().catch(error => {\n    console.error(\"Failed to initialize achievements:\", error);\n  });\n  \n  // Start notification scheduler\n  notificationScheduler.start();\n  \n  // Initialize authentication security service\n  const authSecurityService = new AuthSecurityService(storage);\n\n  const sessionPool = new Pool({ connectionString: process.env.DATABASE_URL });\n\n  app.use(\n    session({\n      store: new PgSession({\n        pool: sessionPool,\n        createTableIfMissing: true,\n      }),\n      secret: sessionSecret,\n      resave: false,\n      saveUninitialized: false,\n      cookie: {\n        maxAge: 30 * 24 * 60 * 60 * 1000,\n        httpOnly: true,\n        secure: process.env.NODE_ENV === \"production\",\n        sameSite: \"lax\",\n      },\n    })\n  );\n\n  app.use(passport.initialize());\n  app.use(passport.session());\n  app.use(rememberMeMiddleware());\n\n  // Apply security headers to all API routes\n  app.use(\"/api\", securityHeaders());\n\n  // Apply CSRF protection to all mutating API endpoints\n  app.use(\"/api\", csrfProtection());\n\n  initializeOAuthStrategies();\n\n  const authLimiter = rateLimit({\n    windowMs: 15 * 60 * 1000,\n    max: 10,\n    message: { message: \"Too many authentication attempts, please try again later\" },\n    standardHeaders: true,\n    legacyHeaders: false,\n  });\n\n  const chatLimiter = rateLimit({\n    windowMs: 1 * 60 * 1000,\n    max: 30,\n    message: { message: \"Too many chat requests, please slow down\" },\n    standardHeaders: true,\n    legacyHeaders: false,\n  });\n\n  const aiGenerationLimiter = rateLimit({\n    windowMs: 5 * 60 * 1000,\n    max: 20,\n    message: { message: \"Too many AI generation requests, please try again later\" },\n    standardHeaders: true,\n    legacyHeaders: false,\n  });\n\n  const leaderboardLimiter = rateLimit({\n    windowMs: 1 * 60 * 1000,\n    max: 60,\n    message: { message: \"Too many leaderboard requests, please slow down\" },\n    standardHeaders: true,\n    legacyHeaders: false,\n  });\n\n  const leaderboardAroundMeLimiter = rateLimit({\n    windowMs: 1 * 60 * 1000,\n    max: 30,\n    message: { message: \"Too many personalized leaderboard requests, please slow down\" },\n    standardHeaders: true,\n    legacyHeaders: false,\n  });\n\n  passport.use(\n    new LocalStrategy(\n      { usernameField: \"email\", passReqToCallback: true },\n      async (req, email, password, done) => {\n        try {\n          const user = await storage.getUserByEmail(email);\n          \n          if (!user) {\n            // Record failed login attempt for unknown email\n            await authSecurityService.recordLoginAttempt(\n              null,\n              email,\n              req,\n              false,\n              \"Invalid email\"\n            );\n            return done(null, false, { message: \"Invalid email or password\" });\n          }\n\n          // Check if account is locked\n          const lockoutCheck = await authSecurityService.checkAccountLockout(user.id);\n          if (!lockoutCheck.allowed) {\n            return done(null, false, { message: lockoutCheck.message || \"Account temporarily locked\" });\n          }\n\n          // Check if account is inactive\n          if (!user.isActive) {\n            await authSecurityService.recordLoginAttempt(\n              user.id,\n              email,\n              req,\n              false,\n              \"Account inactive\"\n            );\n            return done(null, false, { message: \"Account has been deactivated. Please contact support.\" });\n          }\n\n          // Handle OAuth-only accounts (no password set)\n          if (!user.password) {\n            await authSecurityService.recordLoginAttempt(\n              user.id,\n              email,\n              req,\n              false,\n              \"OAuth-only account\"\n            );\n            return done(null, false, { message: \"This account uses social login. Please sign in with your connected provider.\" });\n          }\n\n          const isValidPassword = await bcrypt.compare(password, user.password);\n          \n          if (!isValidPassword) {\n            // Handle failed login attempt\n            await authSecurityService.handleFailedLogin(user.id, email, req, \"Invalid password\");\n            \n            const attemptsRemaining = await authSecurityService.getRemainingAttempts(user.id);\n            const message = attemptsRemaining > 0\n              ? `Invalid email or password. ${attemptsRemaining} attempt${attemptsRemaining > 1 ? 's' : ''} remaining.`\n              : \"Invalid email or password\";\n            \n            return done(null, false, { message });\n          }\n\n          // Handle successful login\n          await authSecurityService.handleSuccessfulLogin(user.id, email, req);\n\n          return done(null, {\n            id: user.id,\n            username: user.username,\n            email: user.email,\n          });\n        } catch (error) {\n          return done(error);\n        }\n      }\n    )\n  );\n\n  passport.serializeUser((user, done) => {\n    done(null, user.id);\n  });\n\n  passport.deserializeUser(async (id: string, done) => {\n    try {\n      const user = await storage.getUser(id);\n      if (!user) {\n        return done(null, false);\n      }\n      done(null, {\n        id: user.id,\n        username: user.username,\n        email: user.email,\n        avatarColor: user.avatarColor,\n        bio: user.bio,\n        country: user.country,\n        keyboardLayout: user.keyboardLayout,\n      });\n    } catch (error) {\n      done(error);\n    }\n  });\n\n  function isAuthenticated(req: any, res: any, next: any) {\n    if (req.isAuthenticated()) {\n      return next();\n    }\n    res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  app.get(\"/api/health\", (_req, res) => {\n    res.status(200).json({ \n      status: \"ok\", \n      timestamp: new Date().toISOString(),\n      uptime: process.uptime()\n    });\n  });\n\n  app.head(\"/api/health\", (_req, res) => {\n    res.status(200).end();\n  });\n\n  const errorReportLimiter = rateLimit({\n    windowMs: 1 * 60 * 1000,\n    max: 10,\n    message: { success: true },\n    standardHeaders: false,\n    legacyHeaders: false,\n    skipFailedRequests: true,\n  });\n\n  app.post(\"/api/error-report\", errorReportLimiter, async (req, res) => {\n    try {\n      const { error, context, timestamp, url, userAgent } = req.body;\n      \n      if (!error || typeof error !== 'object') {\n        return res.status(200).json({ success: true });\n      }\n\n      const sanitizedUrl = typeof url === 'string' \n        ? url.replace(/[?#].*$/, '').slice(0, 200) \n        : 'unknown';\n      \n      const sanitizedMessage = typeof error.message === 'string'\n        ? error.message.slice(0, 500).replace(/password|secret|token|key|auth/gi, '[REDACTED]')\n        : 'Unknown error';\n\n      console.error(\"[Client Error Report]\", {\n        message: sanitizedMessage,\n        code: typeof error.code === 'string' ? error.code.slice(0, 50) : undefined,\n        url: sanitizedUrl,\n        timestamp: typeof timestamp === 'string' ? timestamp.slice(0, 30) : new Date().toISOString(),\n        userId: (req.user as any)?.id,\n      });\n      \n      res.status(200).json({ success: true });\n    } catch (err) {\n      res.status(200).json({ success: true });\n    }\n  });\n\n  app.get(\"/api/error-stats\", isAuthenticated, async (req, res) => {\n    try {\n      res.json({\n        success: true,\n        stats: {\n          message: \"Error statistics available in server logs\",\n        },\n      });\n    } catch (error) {\n      res.status(500).json({ message: \"Failed to retrieve error stats\" });\n    }\n  });\n\n  app.post(\"/api/auth/register\", authLimiter, payloadLimitMiddleware(10), async (req, res, next) => {\n    const startTime = Date.now();\n    let normalizedEmail = \"\";\n    let normalizedUsername = \"\";\n    \n    try {\n      const parsed = insertUserSchema.safeParse(req.body);\n      \n      if (!parsed.success) {\n        AuthLogger.logRegistration(req, req.body?.email || \"unknown\", false, undefined, \"Validation failed\");\n        return res.status(400).json({\n          error: {\n            code: AuthErrorCode.VALIDATION_FAILED,\n            message: \"Validation failed\",\n            details: fromError(parsed.error).toString(),\n          },\n        });\n      }\n\n      try {\n        normalizedEmail = InputSanitizer.normalizeEmail(parsed.data.email);\n        normalizedUsername = InputSanitizer.normalizeUsername(parsed.data.username);\n      } catch (sanitizeError) {\n        if (sanitizeError instanceof AuthError) {\n          AuthLogger.logRegistration(req, parsed.data.email, false, undefined, sanitizeError.message);\n          return res.status(sanitizeError.statusCode).json(sanitizeError.toJSON());\n        }\n        throw sanitizeError;\n      }\n\n      if (!parsed.data.password) {\n        const error = new AuthError({\n          code: AuthErrorCode.PASSWORD_TOO_WEAK,\n          message: \"Password is required\",\n          statusCode: 400,\n          field: \"password\",\n        });\n        AuthLogger.logRegistration(req, normalizedEmail, false, undefined, \"Password missing\");\n        return res.status(400).json(error.toJSON());\n      }\n\n      try {\n        PasswordValidator.validate(parsed.data.password, normalizedEmail, normalizedUsername);\n      } catch (passwordError) {\n        if (passwordError instanceof AuthError) {\n          AuthLogger.logRegistration(req, normalizedEmail, false, undefined, passwordError.message);\n          return res.status(passwordError.statusCode).json(passwordError.toJSON());\n        }\n        throw passwordError;\n      }\n\n      const idempotencyKey = generateIdempotencyKey(normalizedEmail, \"register\");\n      const idempotencyCheck = checkIdempotency(idempotencyKey);\n      if (idempotencyCheck.isDuplicate && idempotencyCheck.cachedResponse) {\n        AuthLogger.logAuthEvent(\"REGISTRATION_DUPLICATE_REQUEST\", req, { email: normalizedEmail });\n        return res.status(201).json(idempotencyCheck.cachedResponse);\n      }\n\n      const existingUserByEmail = await storage.getUserByEmail(normalizedEmail);\n      if (existingUserByEmail) {\n        AuthLogger.logRegistration(req, normalizedEmail, false, undefined, \"Email already exists\");\n        const error = authErrors.emailExists();\n        return res.status(error.statusCode).json(error.toJSON());\n      }\n\n      const existingUserByUsername = await storage.getUserByUsername(normalizedUsername);\n      if (existingUserByUsername) {\n        AuthLogger.logRegistration(req, normalizedEmail, false, undefined, \"Username already exists\");\n        const error = authErrors.usernameExists();\n        return res.status(error.statusCode).json(error.toJSON());\n      }\n\n      const hashedPassword = await bcrypt.hash(parsed.data.password, 12);\n\n      let user;\n      try {\n        user = await DatabaseErrorHandler.withRetry(async () => {\n          return await storage.createUser({\n            ...parsed.data,\n            email: normalizedEmail,\n            username: normalizedUsername,\n            password: hashedPassword,\n          });\n        });\n      } catch (dbError: any) {\n        const errorInfo = DatabaseErrorHandler.handle(dbError, \"registration\");\n        if (errorInfo.shouldLog) {\n          AuthLogger.logRegistration(req, normalizedEmail, false, undefined, `Database error: ${dbError.code}`);\n        }\n        return res.status(errorInfo.authError.statusCode).json(errorInfo.authError.toJSON());\n      }\n\n      await storage.createSecuritySettings(user.id).catch(error => {\n        AuthLogger.logAuthEvent(\"SECURITY_SETTINGS_CREATION_FAILED\", req, {\n          level: \"warn\",\n          userId: user.id,\n          error,\n        });\n      });\n\n      authSecurityService.sendVerificationEmail(user.id, user.email, user.username).catch(error => {\n        AuthLogger.logAuthEvent(\"VERIFICATION_EMAIL_FAILED\", req, {\n          level: \"warn\",\n          userId: user.id,\n          email: user.email,\n          error,\n        });\n      });\n\n      await authSecurityService.recordLoginAttempt(user.id, user.email, req, true);\n\n      try {\n        await regenerateSession(req);\n      } catch (sessionErr) {\n        AuthLogger.logAuthEvent(\"SESSION_REGENERATION_FAILED\", req, {\n          level: \"warn\",\n          userId: user.id,\n          error: sessionErr as Error,\n        });\n      }\n\n      const responseData = {\n        message: \"Registration successful. Please check your email to verify your account.\",\n        user: {\n          id: user.id,\n          username: user.username,\n          email: user.email,\n          emailVerified: user.emailVerified,\n          avatarColor: user.avatarColor,\n          bio: user.bio,\n          country: user.country,\n          keyboardLayout: user.keyboardLayout,\n        },\n      };\n\n      storeIdempotencyResult(idempotencyKey, responseData);\n\n      req.login(\n        {\n          id: user.id,\n          username: user.username,\n          email: user.email,\n        },\n        (err) => {\n          if (err) {\n            AuthLogger.logRegistration(req, normalizedEmail, false, user.id, \"Login after registration failed\");\n            return next(err);\n          }\n          AuthLogger.logRegistration(req, normalizedEmail, true, user.id);\n          res.status(201).json(responseData);\n        }\n      );\n    } catch (error: any) {\n      const durationMs = Date.now() - startTime;\n      AuthLogger.logAuthEvent(\"REGISTRATION_ERROR\", req, {\n        level: \"error\",\n        email: normalizedEmail || req.body?.email,\n        error,\n        durationMs,\n      });\n      \n      if (error instanceof AuthError) {\n        return res.status(error.statusCode).json(error.toJSON());\n      }\n      \n      res.status(500).json({\n        error: {\n          code: AuthErrorCode.INTERNAL_ERROR,\n          message: \"An unexpected error occurred. Please try again.\",\n        },\n      });\n    }\n  });\n\n  app.post(\"/api/auth/login\", authLimiter, payloadLimitMiddleware(5), async (req, res, next) => {\n    const startTime = Date.now();\n    let normalizedEmail = \"\";\n    \n    try {\n      const parsed = loginSchema.safeParse(req.body);\n      const rememberMe = req.body.rememberMe === true;\n      \n      if (!parsed.success) {\n        AuthLogger.logLoginAttempt(req, req.body?.email || \"unknown\", false, undefined, \"Validation failed\");\n        return res.status(400).json({\n          error: {\n            code: AuthErrorCode.VALIDATION_FAILED,\n            message: \"Validation failed\",\n            details: fromError(parsed.error).toString(),\n          },\n        });\n      }\n\n      try {\n        normalizedEmail = InputSanitizer.normalizeEmail(parsed.data.email);\n        req.body.email = normalizedEmail;\n      } catch (sanitizeError) {\n        if (sanitizeError instanceof AuthError) {\n          AuthLogger.logLoginAttempt(req, parsed.data.email, false, undefined, sanitizeError.message);\n          return res.status(sanitizeError.statusCode).json(sanitizeError.toJSON());\n        }\n        throw sanitizeError;\n      }\n\n      passport.authenticate(\"local\", async (err: any, user: Express.User | false, info: any) => {\n        const durationMs = Date.now() - startTime;\n        \n        if (err) {\n          AuthLogger.logLoginAttempt(req, normalizedEmail, false, undefined, `Authentication error: ${err.message}`);\n          return next(err);\n        }\n        \n        if (!user) {\n          AuthLogger.logLoginAttempt(req, normalizedEmail, false, undefined, info?.message || \"Invalid credentials\");\n          \n          const errorResponse: any = {\n            error: {\n              code: AuthErrorCode.INVALID_CREDENTIALS,\n              message: info?.message || \"Invalid email or password\",\n            },\n          };\n          \n          if (info?.attemptsRemaining !== undefined) {\n            errorResponse.error.attemptsRemaining = info.attemptsRemaining;\n          }\n          if (info?.lockoutMinutes !== undefined) {\n            errorResponse.error.lockoutMinutes = info.lockoutMinutes;\n            errorResponse.error.code = AuthErrorCode.ACCOUNT_LOCKED;\n          }\n          \n          return res.status(401).json(errorResponse);\n        }\n\n        try {\n          await regenerateSession(req);\n        } catch (sessionErr) {\n          AuthLogger.logAuthEvent(\"SESSION_REGENERATION_FAILED\", req, {\n            level: \"warn\",\n            userId: user.id,\n            error: sessionErr as Error,\n          });\n        }\n\n        req.login(user, async (loginErr) => {\n          if (loginErr) {\n            AuthLogger.logLoginAttempt(req, normalizedEmail, false, user.id, \"Session login failed\");\n            return next(loginErr);\n          }\n          \n          if (rememberMe) {\n            try {\n              await setupRememberMeOnLogin(req, res, user.id);\n            } catch (error) {\n              AuthLogger.logAuthEvent(\"REMEMBER_ME_SETUP_FAILED\", req, {\n                level: \"warn\",\n                userId: user.id,\n                error: error as Error,\n              });\n            }\n          }\n          \n          AuthLogger.logLoginAttempt(req, normalizedEmail, true, user.id);\n          \n          res.json({\n            message: \"Login successful\",\n            user: {\n              id: user.id,\n              username: user.username,\n              email: user.email,\n              avatarColor: user.avatarColor,\n              bio: user.bio,\n              country: user.country,\n              keyboardLayout: user.keyboardLayout,\n            },\n          });\n        });\n      })(req, res, next);\n    } catch (error: any) {\n      const durationMs = Date.now() - startTime;\n      AuthLogger.logAuthEvent(\"LOGIN_ERROR\", req, {\n        level: \"error\",\n        email: normalizedEmail || req.body?.email,\n        error,\n        durationMs,\n      });\n      \n      if (error instanceof AuthError) {\n        return res.status(error.statusCode).json(error.toJSON());\n      }\n      \n      res.status(500).json({\n        error: {\n          code: AuthErrorCode.INTERNAL_ERROR,\n          message: \"An unexpected error occurred. Please try again.\",\n        },\n      });\n    }\n  });\n\n  app.post(\"/api/auth/logout\", async (req, res) => {\n    try {\n      await clearRememberMeOnLogout(req, res);\n    } catch (error) {\n      console.error(\"Error clearing remember-me token:\", error);\n    }\n    \n    req.logout((err) => {\n      if (err) {\n        return res.status(500).json({ message: \"Logout failed\" });\n      }\n      res.json({ message: \"Logout successful\" });\n    });\n  });\n\n  app.get(\"/api/auth/me\", isAuthenticated, (req, res) => {\n    res.json({ user: req.user });\n  });\n\n  app.get(\"/api/auth/google\", \n    oauthRateLimitMiddleware(), \n    initiateOAuthFlow(\"google\")\n  );\n\n  app.get(\"/api/auth/callback/google\",\n    oauthRateLimitMiddleware(),\n    handleOAuthCallbackFlow(\"google\")\n  );\n\n  app.get(\"/api/auth/github\", \n    oauthRateLimitMiddleware(),\n    initiateOAuthFlow(\"github\")\n  );\n\n  app.get(\"/api/auth/callback/github\",\n    oauthRateLimitMiddleware(),\n    handleOAuthCallbackFlow(\"github\")\n  );\n\n  app.get(\"/api/auth/facebook\", \n    oauthRateLimitMiddleware(),\n    initiateOAuthFlow(\"facebook\")\n  );\n\n  app.get(\"/api/auth/callback/facebook\",\n    oauthRateLimitMiddleware(),\n    handleOAuthCallbackFlow(\"facebook\")\n  );\n\n  app.get(\"/api/auth/link/google\", isAuthenticated,\n    oauthRateLimitMiddleware(),\n    (req, res, next) => initiateOAuthFlow(\"google\", req.user?.id)(req, res, next)\n  );\n\n  app.get(\"/api/auth/link/github\", isAuthenticated,\n    oauthRateLimitMiddleware(),\n    (req, res, next) => initiateOAuthFlow(\"github\", req.user?.id)(req, res, next)\n  );\n\n  app.get(\"/api/auth/link/facebook\", isAuthenticated,\n    oauthRateLimitMiddleware(),\n    (req, res, next) => initiateOAuthFlow(\"facebook\", req.user?.id)(req, res, next)\n  );\n\n  app.get(\"/api/auth/providers/available\", (req, res) => {\n    const availability = getProviderAvailability();\n    res.json({ providers: availability });\n  });\n\n  app.get(\"/api/auth/providers/availability\", (req, res) => {\n    const availability = getProviderAvailability();\n    res.json(availability);\n  });\n\n  app.get(\"/api/auth/providers\", isAuthenticated, async (req, res) => {\n    try {\n      const accounts = await storage.getUserOAuthAccounts(req.user!.id);\n      const linkedProviders = accounts.map(acc => ({\n        provider: acc.provider,\n        profileName: acc.profileName,\n        email: acc.email,\n        linkedAt: acc.linkedAt,\n      }));\n      const availability = getProviderAvailability();\n      res.json({ linkedProviders, availableProviders: availability });\n    } catch (error: any) {\n      console.error(\"Get linked providers error:\", error);\n      res.status(500).json({ message: \"Failed to fetch linked providers\" });\n    }\n  });\n\n  app.delete(\"/api/auth/providers/:provider\", isAuthenticated, async (req, res) => {\n    try {\n      const provider = req.params.provider as \"google\" | \"github\" | \"facebook\";\n      if (![\"google\", \"github\", \"facebook\"].includes(provider)) {\n        return res.status(400).json({ message: \"Invalid provider\" });\n      }\n\n      const rateLimitCheck = checkRateLimit(req.user!.id, \"unlink\");\n      if (!rateLimitCheck.allowed) {\n        return res.status(429).json({ \n          message: \"Too many unlink attempts. Please try again later.\",\n          retryAfterMs: rateLimitCheck.retryAfterMs\n        });\n      }\n\n      const unlinkCheck = await canUnlinkProvider(req.user!.id, provider);\n      if (!unlinkCheck.allowed) {\n        return res.status(400).json({ message: unlinkCheck.reason });\n      }\n\n      const deviceInfo = extractDeviceInfo(req);\n      \n      await storage.unlinkOAuthAccount(req.user!.id, provider);\n      \n      logAuthEvent({\n        eventType: \"oauth_unlink\",\n        userId: req.user!.id,\n        provider,\n        ipAddress: deviceInfo.ipAddress,\n        userAgent: deviceInfo.userAgent,\n        deviceFingerprint: deviceInfo.fingerprint,\n        success: true,\n      });\n      \n      res.json({ message: `${provider} account unlinked successfully` });\n    } catch (error: any) {\n      console.error(\"Unlink provider error:\", error);\n      res.status(500).json({ message: \"Failed to unlink provider\" });\n    }\n  });\n\n  app.post(\"/api/test-results\", isAuthenticated, async (req, res) => {\n    try {\n      const parsed = insertTestResultSchema.safeParse({\n        ...req.body,\n        userId: req.user!.id,\n      });\n\n      if (!parsed.success) {\n        return res.status(400).json({\n          message: \"Validation failed\",\n          errors: fromError(parsed.error).toString(),\n        });\n      }\n\n      const result = await storage.createTestResult(parsed.data);\n      \n      // Update user streak after completing a test\n      await storage.updateUserStreak(req.user!.id);\n      \n      // Check for achievement unlocks and return newly unlocked achievements\n      let newAchievements: Array<{\n        key: string;\n        name: string;\n        description: string;\n        tier: string;\n        points: number;\n        icon: string;\n        category: string;\n      }> = [];\n      \n      let nearCompletionAchievements: Array<{\n        key: string;\n        name: string;\n        description: string;\n        category: string;\n        tier: string;\n        points: number;\n        icon: string;\n        color: string;\n        progress: number;\n        currentValue: number;\n        targetValue: number;\n      }> = [];\n      \n      try {\n        const unlocked = await achievementService.checkAchievements(req.user!.id, result);\n        newAchievements = unlocked.map(a => ({\n          key: a.key,\n          name: a.name,\n          description: a.description,\n          tier: a.tier,\n          points: a.points,\n          icon: a.icon,\n          category: a.category,\n        }));\n        \n        // Get achievements at 80%+ progress for \"Almost There\" notifications\n        // Pass the result to include fresh data from the just-completed test\n        nearCompletionAchievements = await achievementService.getNearCompletionAchievements(req.user!.id, 80, result);\n      } catch (error) {\n        console.error(\"Achievement check error:\", error);\n      }\n      \n      res.status(201).json({ \n        message: \"Test result saved\", \n        result, \n        id: result.id, \n        newAchievements,\n        nearCompletionAchievements \n      });\n    } catch (error: any) {\n      console.error(\"Save test result error:\", error);\n      res.status(500).json({ message: \"Failed to save test result\" });\n    }\n  });\n\n  app.get(\"/api/test-results\", isAuthenticated, async (req, res) => {\n    try {\n      const limit = req.query.limit ? parseInt(req.query.limit as string) : 10;\n      const results = await storage.getUserTestResults(req.user!.id, limit);\n      res.json({ results });\n    } catch (error: any) {\n      console.error(\"Get test results error:\", error);\n      res.status(500).json({ message: \"Failed to fetch test results\" });\n    }\n  });\n\n  app.get(\"/api/stats\", isAuthenticated, async (req, res) => {\n    try {\n      const stats = await storage.getUserStats(req.user!.id);\n      res.json({ stats });\n    } catch (error: any) {\n      console.error(\"Get stats error:\", error);\n      res.status(500).json({ message: \"Failed to fetch stats\" });\n    }\n  });\n\n  app.get(\"/api/badges\", isAuthenticated, async (req, res) => {\n    try {\n      const badgeData = await storage.getUserBadgeData(req.user!.id);\n      res.json({ badgeData });\n    } catch (error: any) {\n      console.error(\"Get badges error:\", error);\n      res.status(500).json({ message: \"Failed to fetch badges\" });\n    }\n  });\n\n  app.get(\"/api/achievements\", isAuthenticated, async (req, res) => {\n    try {\n      const achievements = await storage.getUserAchievements(req.user!.id);\n      res.json({ achievements });\n    } catch (error: any) {\n      console.error(\"Get achievements error:\", error);\n      res.status(500).json({ message: \"Failed to fetch achievements\" });\n    }\n  });\n\n  app.get(\"/api/gamification\", isAuthenticated, async (req, res) => {\n    try {\n      const gamification = await storage.getUserGamification(req.user!.id);\n      res.json({ gamification: gamification || { totalPoints: 0, level: 1, experiencePoints: 0, totalAchievements: 0 } });\n    } catch (error: any) {\n      console.error(\"Get gamification error:\", error);\n      res.status(500).json({ message: \"Failed to fetch gamification data\" });\n    }\n  });\n\n  app.get(\"/api/showcase-badges\", isAuthenticated, async (req, res) => {\n    try {\n      const gamification = await storage.getUserGamification(req.user!.id);\n      const showcaseBadges = (gamification?.featuredBadges as string[] | null) || [];\n      res.json({ showcaseBadges });\n    } catch (error: any) {\n      console.error(\"Get showcase badges error:\", error);\n      res.status(500).json({ message: \"Failed to fetch showcase badges\" });\n    }\n  });\n\n  app.put(\"/api/showcase-badges\", isAuthenticated, async (req, res) => {\n    try {\n      const { badgeKeys } = req.body;\n      \n      if (!Array.isArray(badgeKeys)) {\n        return res.status(400).json({ message: \"badgeKeys must be an array\" });\n      }\n      \n      if (badgeKeys.length > 5) {\n        return res.status(400).json({ message: \"Maximum 5 badges can be showcased\" });\n      }\n      \n      const validKeys = badgeKeys.filter((key: any) => typeof key === \"string\" && key.length > 0);\n      \n      const userAchievements = await storage.getUserAchievements(req.user!.id);\n      const unlockedKeys = new Set(userAchievements.map(a => a.achievement.key));\n      const validUnlockedKeys = validKeys.filter((key: string) => unlockedKeys.has(key));\n      \n      if (validUnlockedKeys.length > 0 && validUnlockedKeys.length < 3) {\n        return res.status(400).json({ message: \"Minimum 3 badges required for showcase (or 0 to clear)\" });\n      }\n      \n      if (validUnlockedKeys.length > 5) {\n        return res.status(400).json({ message: \"Maximum 5 badges can be showcased\" });\n      }\n      \n      let gamification = await storage.getUserGamification(req.user!.id);\n      if (!gamification) {\n        gamification = await storage.createUserGamification({\n          userId: req.user!.id,\n          totalPoints: 0,\n          level: 1,\n          experiencePoints: 0,\n          totalAchievements: 0,\n          totalChallengesCompleted: 0,\n          totalShares: 0,\n        });\n      }\n      \n      await storage.updateUserGamification(req.user!.id, {\n        featuredBadges: validUnlockedKeys,\n      });\n      \n      res.json({ showcaseBadges: validUnlockedKeys });\n    } catch (error: any) {\n      console.error(\"Update showcase badges error:\", error);\n      res.status(500).json({ message: \"Failed to update showcase badges\" });\n    }\n  });\n\n  app.get(\"/api/achievements/near-completion\", isAuthenticated, async (req, res) => {\n    try {\n      const minProgress = parseInt(req.query.minProgress as string) || 80;\n      const nearCompletion = await achievementService.getNearCompletionAchievements(req.user!.id, minProgress);\n      res.json({ nearCompletion });\n    } catch (error: any) {\n      console.error(\"Get near-completion achievements error:\", error);\n      res.status(500).json({ message: \"Failed to fetch near-completion achievements\" });\n    }\n  });\n\n  app.get(\"/api/achievements/next\", isAuthenticated, async (req, res) => {\n    try {\n      const nextAchievement = await achievementService.getNextAchievementToUnlock(req.user!.id);\n      res.json({ nextAchievement });\n    } catch (error: any) {\n      console.error(\"Get next achievement error:\", error);\n      res.status(500).json({ message: \"Failed to fetch next achievement\" });\n    }\n  });\n\n  app.get(\"/api/leaderboard\", leaderboardLimiter, async (req, res) => {\n    try {\n      const limit = Math.min(Math.max(1, parseInt(req.query.limit as string) || 20), 100);\n      const offset = Math.max(0, parseInt(req.query.offset as string) || 0);\n      const cursor = req.query.cursor as string | undefined;\n      const rawTimeframe = (req.query.timeframe as string) || \"all\";\n      const validTimeframes = [\"all\", \"daily\", \"weekly\", \"monthly\"];\n      const timeframe = validTimeframes.includes(rawTimeframe) ? rawTimeframe : \"all\";\n      const language = (req.query.language as string) || \"en\";\n      \n      const actualOffset = cursor ? leaderboardCache.decodeCursor(cursor) : offset;\n      \n      const result = await leaderboardCache.getGlobalLeaderboard({\n        timeframe: timeframe as any,\n        limit,\n        offset: actualOffset,\n        language,\n      });\n      \n      res.set('Cache-Control', 'public, max-age=30');\n      res.set('X-Cache', result.metadata.cacheHit ? 'HIT' : 'MISS');\n      res.set('X-Total-Count', String(result.pagination.total));\n      \n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Get leaderboard error:\", error);\n      res.status(500).json({ message: \"Failed to fetch leaderboard\" });\n    }\n  });\n\n  app.get(\"/api/leaderboard/around-me\", isAuthenticated, leaderboardAroundMeLimiter, async (req, res) => {\n    try {\n      const range = Math.min(Math.max(1, parseInt(req.query.range as string) || 5), 20);\n      const rawTimeframe = (req.query.timeframe as string) || \"all\";\n      const validTimeframes = [\"all\", \"daily\", \"weekly\", \"monthly\"];\n      const timeframe = validTimeframes.includes(rawTimeframe) ? rawTimeframe as \"all\" | \"daily\" | \"weekly\" | \"monthly\" : \"all\";\n      const language = (req.query.language as string) || \"en\";\n      \n      const result = await leaderboardCache.getAroundMe(\"global\", req.user!.id, { range, timeframe, language });\n      \n      res.set('Cache-Control', 'private, max-age=10');\n      res.set('X-Cache', result.cacheHit ? 'HIT' : 'MISS');\n      \n      res.json({\n        userRank: result.userRank,\n        entries: result.entries,\n        timeframe,\n      });\n    } catch (error: any) {\n      console.error(\"Get leaderboard around me error:\", error);\n      res.status(500).json({ message: \"Failed to fetch leaderboard\" });\n    }\n  });\n\n  app.get(\"/api/leaderboard/time-based\", leaderboardLimiter, async (req, res) => {\n    try {\n      const rawTimeframe = req.query.timeframe as string;\n      const validTimeframes = [\"daily\", \"weekly\", \"monthly\"];\n      if (!validTimeframes.includes(rawTimeframe)) {\n        return res.status(400).json({ message: \"Invalid timeframe. Must be daily, weekly, or monthly\" });\n      }\n      const timeframe = rawTimeframe as \"daily\" | \"weekly\" | \"monthly\";\n      const limit = Math.min(Math.max(1, parseInt(req.query.limit as string) || 20), 100);\n      const offset = Math.max(0, parseInt(req.query.offset as string) || 0);\n      \n      const entries = await storage.getTimeBasedLeaderboard(timeframe, limit, offset);\n      const total = await storage.getTimeBasedLeaderboardCount(timeframe);\n      \n      res.set('Cache-Control', 'public, max-age=60');\n      \n      res.json({\n        entries,\n        pagination: {\n          total,\n          limit,\n          offset,\n          hasMore: offset + entries.length < total,\n        },\n        metadata: {\n          timeframe,\n          lastUpdated: Date.now(),\n        },\n      });\n    } catch (error: any) {\n      console.error(\"Get time-based leaderboard error:\", error);\n      res.status(500).json({ message: \"Failed to fetch leaderboard\" });\n    }\n  });\n\n  app.get(\"/api/leaderboard/cache-stats\", async (req, res) => {\n    try {\n      const stats = leaderboardCache.getStats();\n      res.json({ stats });\n    } catch (error: any) {\n      console.error(\"Get cache stats error:\", error);\n      res.status(500).json({ message: \"Failed to fetch cache stats\" });\n    }\n  });\n\n  app.get(\"/api/platform-stats\", async (req, res) => {\n    try {\n      const stats = await storage.getPlatformStats();\n      res.json({ stats });\n    } catch (error: any) {\n      console.error(\"Get platform stats error:\", error);\n      res.status(500).json({ message: \"Failed to fetch platform stats\" });\n    }\n  });\n\n  app.get(\"/api/analytics\", isAuthenticated, async (req, res) => {\n    try {\n      // Validate and clamp days parameter to safe range (7-365)\n      let days = req.query.days ? parseInt(req.query.days as string) : 30;\n      if (isNaN(days) || days < 7) days = 7;\n      if (days > 365) days = 365;\n      \n      const analytics = await storage.getUserAnalytics(req.user!.id, days);\n      res.json({ analytics });\n    } catch (error: any) {\n      console.error(\"Analytics fetch error:\", error);\n      res.status(500).json({ message: \"Failed to fetch analytics\" });\n    }\n  });\n\n  app.get(\"/api/analytics/trends\", isAuthenticated, async (req, res) => {\n    try {\n      const trends = await storage.getHistoricalTrends(req.user!.id);\n      res.json({ trends });\n    } catch (error: any) {\n      console.error(\"Historical trends fetch error:\", error);\n      res.status(500).json({ message: \"Failed to fetch historical trends\" });\n    }\n  });\n\n  app.post(\"/api/analytics/keystrokes\", isAuthenticated, async (req, res) => {\n    try {\n      const { testResultId, keystrokes } = req.body;\n      \n      if (!testResultId || !Array.isArray(keystrokes) || keystrokes.length === 0) {\n        return res.status(400).json({ message: \"Invalid request: testResultId and keystrokes array required\" });\n      }\n\n      // Verify test result belongs to authenticated user\n      const ownsTest = await storage.verifyTestResultOwnership(testResultId, req.user!.id);\n      \n      if (!ownsTest) {\n        return res.status(403).json({ message: \"Unauthorized: test result does not belong to user\" });\n      }\n\n      // Validate and sanitize each keystroke, injecting server-side userId and testResultId\n      const validatedKeystrokes = [];\n      for (const keystroke of keystrokes) {\n        const parsed = insertKeystrokeAnalyticsSchema.safeParse({\n          ...keystroke,\n          userId: req.user!.id,\n          testResultId: testResultId,\n        });\n\n        if (!parsed.success) {\n          return res.status(400).json({\n            message: \"Keystroke validation failed\",\n            errors: fromError(parsed.error).toString(),\n          });\n        }\n\n        validatedKeystrokes.push(parsed.data);\n      }\n\n      await storage.saveBulkKeystrokeAnalytics(validatedKeystrokes);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error(\"Keystroke analytics save error:\", error);\n      res.status(500).json({ message: \"Failed to save keystroke analytics\" });\n    }\n  });\n\n  app.patch(\"/api/profile\", isAuthenticated, async (req, res) => {\n    try {\n      const parsed = updateProfileSchema.safeParse(req.body);\n\n      if (!parsed.success) {\n        return res.status(400).json({\n          message: \"Validation failed\",\n          errors: fromError(parsed.error).toString(),\n        });\n      }\n\n      const sanitizedData = {\n        ...parsed.data,\n        bio: parsed.data.bio ? DOMPurify.sanitize(parsed.data.bio, { ALLOWED_TAGS: [] }) : parsed.data.bio,\n      };\n\n      const updatedUser = await storage.updateUserProfile(req.user!.id, sanitizedData);\n      res.json({\n        message: \"Profile updated successfully\",\n        user: {\n          id: updatedUser.id,\n          username: updatedUser.username,\n          email: updatedUser.email,\n          avatarColor: updatedUser.avatarColor,\n          bio: updatedUser.bio,\n          country: updatedUser.country,\n          keyboardLayout: updatedUser.keyboardLayout,\n        },\n      });\n    } catch (error: any) {\n      console.error(\"Update profile error:\", error);\n      res.status(500).json({ message: \"Failed to update profile\" });\n    }\n  });\n\n  // Track social shares and award bonus XP\n  app.post(\"/api/share/track\", isAuthenticated, async (req, res) => {\n    try {\n      const { platform, resultId } = req.body;\n      const SHARE_BONUS_XP = 5; // Bonus XP for each share\n      \n      // Get or create gamification profile\n      let gamification = await storage.getUserGamification(req.user!.id);\n      if (!gamification) {\n        gamification = await storage.createUserGamification({\n          userId: req.user!.id,\n          totalPoints: 0,\n          level: 1,\n          experiencePoints: 0,\n          totalAchievements: 0,\n          totalChallengesCompleted: 0,\n        });\n      }\n      \n      // Increment share count and add bonus XP\n      const newShareCount = (gamification.totalShares || 0) + 1;\n      const newXP = gamification.experiencePoints + SHARE_BONUS_XP;\n      const newPoints = gamification.totalPoints + SHARE_BONUS_XP;\n      const newLevel = Math.floor(newXP / 100) + 1;\n      \n      await storage.updateUserGamification(req.user!.id, {\n        totalShares: newShareCount,\n        experiencePoints: newXP,\n        totalPoints: newPoints,\n        level: newLevel,\n      });\n      \n      // Check for social sharing achievements\n      achievementService.checkSocialAchievements(req.user!.id, newShareCount).catch(error => {\n        console.error(\"Social achievement check error:\", error);\n      });\n      \n      res.json({ \n        success: true, \n        bonusXP: SHARE_BONUS_XP,\n        totalShares: newShareCount,\n        newXP: newXP,\n        newLevel: newLevel,\n        message: `+${SHARE_BONUS_XP} XP for sharing!`\n      });\n    } catch (error: any) {\n      console.error(\"Track share error:\", error);\n      res.status(500).json({ message: \"Failed to track share\" });\n    }\n  });\n\n  app.post(\"/api/auth/change-password\", authLimiter, isAuthenticated, async (req, res) => {\n    try {\n      const { currentPassword, newPassword } = req.body;\n\n      if (!currentPassword || !newPassword) {\n        return res.status(400).json({ message: \"Current password and new password are required\" });\n      }\n\n      // Comprehensive password validation\n      if (newPassword.length < 8) {\n        return res.status(400).json({ message: \"Password must be at least 8 characters\" });\n      }\n\n      if (!/[A-Z]/.test(newPassword)) {\n        return res.status(400).json({ message: \"Password must contain at least one uppercase letter\" });\n      }\n\n      if (!/[a-z]/.test(newPassword)) {\n        return res.status(400).json({ message: \"Password must contain at least one lowercase letter\" });\n      }\n\n      if (!/\\d/.test(newPassword)) {\n        return res.status(400).json({ message: \"Password must contain at least one number\" });\n      }\n\n      const user = await storage.getUser(req.user!.id);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      // Handle OAuth-only accounts (no password set)\n      if (!user.password) {\n        return res.status(400).json({ message: \"Cannot change password for accounts using social login. Please set a password first.\" });\n      }\n\n      const isValidPassword = await bcrypt.compare(currentPassword, user.password);\n      if (!isValidPassword) {\n        return res.status(401).json({ message: \"Current password is incorrect\" });\n      }\n\n      // Ensure new password is different from current password\n      const isSameAsOld = await bcrypt.compare(newPassword, user.password);\n      if (isSameAsOld) {\n        return res.status(400).json({ message: \"New password must be different from current password\" });\n      }\n\n      const hashedPassword = await bcrypt.hash(newPassword, 10);\n      await storage.updateUserPassword(req.user!.id, hashedPassword);\n\n      res.json({ message: \"Password changed successfully\" });\n    } catch (error: any) {\n      console.error(\"Change password error:\", error);\n      res.status(500).json({ message: \"Failed to change password\" });\n    }\n  });\n\n  app.delete(\"/api/auth/delete-account\", authLimiter, isAuthenticated, async (req, res) => {\n    try {\n      await storage.deleteUser(req.user!.id);\n      \n      req.logout((err) => {\n        if (err) {\n          console.error(\"Logout error after account deletion:\", err);\n        }\n        \n        req.session.destroy((destroyErr) => {\n          if (destroyErr) {\n            console.error(\"Session destroy error after account deletion:\", destroyErr);\n          }\n          res.json({ message: \"Account deleted successfully\" });\n        });\n      });\n    } catch (error: any) {\n      console.error(\"Delete account error:\", error);\n      res.status(500).json({ message: \"Failed to delete account\" });\n    }\n  });\n\n  app.post(\"/api/auth/forgot-password\", authLimiter, payloadLimitMiddleware(5), async (req, res) => {\n    const startTime = Date.now();\n    const successMessage = \"If an account exists with that email, a reset link has been sent.\";\n    \n    try {\n      const { email, timezone } = req.body;\n\n      if (!email || typeof email !== \"string\") {\n        AuthLogger.logPasswordReset(req, \"unknown\", \"failed\", \"Email missing\");\n        return res.status(400).json({\n          error: {\n            code: AuthErrorCode.VALIDATION_FAILED,\n            message: \"Email is required\",\n            field: \"email\",\n          },\n        });\n      }\n\n      let normalizedEmail: string;\n      try {\n        normalizedEmail = InputSanitizer.normalizeEmail(email);\n      } catch (sanitizeError) {\n        await addTimingJitter(100, 300);\n        AuthLogger.logPasswordReset(req, email, \"failed\", \"Invalid email format\");\n        return res.json({ message: successMessage });\n      }\n\n      const idempotencyKey = generateIdempotencyKey(normalizedEmail, \"forgot-password\");\n      const idempotencyCheck = checkIdempotency(idempotencyKey);\n      if (idempotencyCheck.isDuplicate) {\n        AuthLogger.logAuthEvent(\"FORGOT_PASSWORD_DUPLICATE_REQUEST\", req, { email: normalizedEmail });\n        return res.json({ message: successMessage });\n      }\n\n      const user = await storage.getUserByEmail(normalizedEmail);\n      \n      if (!user) {\n        await addTimingJitter(150, 350);\n        AuthLogger.logPasswordReset(req, normalizedEmail, \"requested\", \"User not found (hidden)\");\n        storeIdempotencyResult(idempotencyKey, { message: successMessage });\n        return res.json({ message: successMessage });\n      }\n\n      const MAX_RESETS_PER_HOUR = 3;\n      const recentRequests = await storage.getRecentPasswordResetRequests(user.id, 60);\n      if (recentRequests >= MAX_RESETS_PER_HOUR) {\n        AuthLogger.logAuthEvent(\"FORGOT_PASSWORD_USER_RATE_LIMITED\", req, {\n          userId: user.id,\n          email: normalizedEmail,\n          metadata: { recentRequests },\n        });\n        await addTimingJitter(100, 300);\n        storeIdempotencyResult(idempotencyKey, { message: successMessage });\n        return res.json({ message: successMessage });\n      }\n\n      const ipAddress = req.ip || req.socket.remoteAddress || \"unknown\";\n\n      try {\n        const clientTimezone = typeof timezone === 'string' && timezone.length > 0 ? timezone : undefined;\n        console.log(`[ForgotPassword] Sending reset email to ${normalizedEmail} for user ${user.id}, timezone: ${clientTimezone || 'UTC'}`);\n        const emailResult = await authSecurityService.sendPasswordResetEmail(user.id, user.email, ipAddress, user.username, clientTimezone);\n        if (emailResult.success) {\n          console.log(`[ForgotPassword] Email sent successfully to ${normalizedEmail}, messageId: ${emailResult.messageId}`);\n        } else {\n          console.error(`[ForgotPassword] Email sending failed for ${normalizedEmail}:`, emailResult.error);\n        }\n        AuthLogger.logPasswordReset(req, normalizedEmail, \"requested\");\n      } catch (emailError: any) {\n        console.error(`[ForgotPassword] Exception sending email to ${normalizedEmail}:`, emailError.message, emailError.stack);\n        AuthLogger.logAuthEvent(\"PASSWORD_RESET_EMAIL_FAILED\", req, {\n          level: \"error\",\n          userId: user.id,\n          email: normalizedEmail,\n          error: emailError as Error,\n        });\n      }\n\n      storeIdempotencyResult(idempotencyKey, { message: successMessage });\n      res.json({ message: successMessage });\n    } catch (error: any) {\n      const durationMs = Date.now() - startTime;\n      AuthLogger.logAuthEvent(\"FORGOT_PASSWORD_ERROR\", req, {\n        level: \"error\",\n        email: req.body?.email,\n        error,\n        durationMs,\n      });\n      \n      await addTimingJitter(100, 300);\n      res.json({ message: successMessage });\n    }\n  });\n\n  app.get(\"/api/auth/validate-reset-token\", async (req, res) => {\n    res.setHeader(\"Referrer-Policy\", \"no-referrer\");\n    \n    try {\n      const token = req.query.token as string;\n\n      if (!token) {\n        return res.json({ valid: false });\n      }\n\n      const resetToken = await storage.getPasswordResetToken(token);\n\n      if (!resetToken) {\n        return res.json({ valid: false });\n      }\n\n      if (resetToken.usedAt) {\n        return res.json({ valid: false, reason: \"already_used\" });\n      }\n\n      if (new Date() > resetToken.expiresAt) {\n        return res.json({ valid: false, reason: \"expired\" });\n      }\n\n      if (resetToken.lockedAt) {\n        return res.json({ valid: false, reason: \"locked\" });\n      }\n\n      res.json({ valid: true });\n    } catch (error: any) {\n      console.error(\"Validate reset token error:\", error);\n      res.json({ valid: false });\n    }\n  });\n\n  app.post(\"/api/auth/reset-password\", authLimiter, payloadLimitMiddleware(5), async (req, res) => {\n    res.setHeader(\"Referrer-Policy\", \"no-referrer\");\n    const startTime = Date.now();\n    \n    try {\n      const { token, password, timezone } = req.body;\n\n      if (!token || typeof token !== \"string\") {\n        AuthLogger.logPasswordReset(req, \"unknown\", \"failed\", \"Token missing\");\n        return res.status(400).json({\n          error: {\n            code: AuthErrorCode.TOKEN_INVALID,\n            message: \"Reset token is required\",\n            field: \"token\",\n          },\n        });\n      }\n\n      if (!password || typeof password !== \"string\") {\n        AuthLogger.logPasswordReset(req, \"unknown\", \"failed\", \"Password missing\");\n        return res.status(400).json({\n          error: {\n            code: AuthErrorCode.PASSWORD_TOO_WEAK,\n            message: \"Password is required\",\n            field: \"password\",\n          },\n        });\n      }\n\n      let sanitizedToken: string;\n      try {\n        sanitizedToken = InputSanitizer.sanitizeToken(token);\n      } catch (tokenError) {\n        if (tokenError instanceof AuthError) {\n          AuthLogger.logPasswordReset(req, \"unknown\", \"failed\", \"Invalid token format\");\n          return res.status(tokenError.statusCode).json(tokenError.toJSON());\n        }\n        throw tokenError;\n      }\n\n      try {\n        PasswordValidator.validate(password);\n      } catch (passwordError) {\n        if (passwordError instanceof AuthError) {\n          AuthLogger.logPasswordReset(req, \"unknown\", \"failed\", passwordError.message);\n          return res.status(passwordError.statusCode).json(passwordError.toJSON());\n        }\n        throw passwordError;\n      }\n\n      const resetToken = await storage.getPasswordResetToken(sanitizedToken);\n\n      try {\n        TokenSecurity.validateTokenState(resetToken);\n      } catch (tokenStateError) {\n        if (tokenStateError instanceof AuthError) {\n          if (resetToken?.tokenHash) {\n            const attemptResult = await storage.incrementTokenFailedAttempts(resetToken.tokenHash);\n            AuthLogger.logAuthEvent(\"TOKEN_VALIDATION_FAILED\", req, {\n              metadata: { failedAttempts: attemptResult.failedAttempts, locked: attemptResult.locked },\n            });\n            if (attemptResult.locked) {\n              AuthLogger.logPasswordReset(req, \"unknown\", \"failed\", \"Token locked due to too many attempts\");\n              return res.status(429).json({\n                error: {\n                  code: AuthErrorCode.RATE_LIMITED,\n                  message: \"Too many failed attempts. This reset link has been disabled for security.\",\n                },\n              });\n            }\n          }\n          AuthLogger.logPasswordReset(req, \"unknown\", \"failed\", tokenStateError.message);\n          return res.status(tokenStateError.statusCode).json(tokenStateError.toJSON());\n        }\n        throw tokenStateError;\n      }\n\n      if (resetToken!.lockedAt) {\n        AuthLogger.logPasswordReset(req, \"unknown\", \"failed\", \"Token already locked\");\n        return res.status(429).json({\n          error: {\n            code: AuthErrorCode.RATE_LIMITED,\n            message: \"This reset link has been disabled due to too many failed attempts.\",\n          },\n        });\n      }\n\n      const user = await storage.getUser(resetToken!.userId);\n      const userEmail = user?.email || \"unknown\";\n      const username = user?.username;\n\n      const hashedPassword = await bcrypt.hash(password, 12);\n      const ipAddress = req.ip || req.socket.remoteAddress || \"unknown\";\n      \n      try {\n        const result = await DatabaseErrorHandler.withRetry(async () => {\n          return await storage.atomicPasswordReset(\n            resetToken!.tokenHash,\n            resetToken!.userId,\n            hashedPassword\n          );\n        });\n\n        if (!result.success) {\n          if (result.alreadyUsed) {\n            AuthLogger.logPasswordReset(req, userEmail, \"failed\", \"Token already used (replay attempt)\");\n            return res.status(400).json({\n              error: {\n                code: AuthErrorCode.TOKEN_INVALID,\n                message: \"This reset link has already been used. Please request a new one.\",\n              },\n            });\n          }\n          AuthLogger.logPasswordReset(req, userEmail, \"failed\", \"Token not found during atomic reset\");\n          return res.status(400).json({\n            error: {\n              code: AuthErrorCode.TOKEN_INVALID,\n              message: \"Invalid reset link. Please request a new one.\",\n            },\n          });\n        }\n      } catch (dbError: any) {\n        const errorInfo = DatabaseErrorHandler.handle(dbError, \"reset-password\");\n        AuthLogger.logPasswordReset(req, userEmail, \"failed\", `Database error: ${dbError.code}`);\n        return res.status(errorInfo.authError.statusCode).json(errorInfo.authError.toJSON());\n      }\n\n      if (user) {\n        try {\n          const clientTimezone = typeof timezone === 'string' && timezone.length > 0 ? timezone : undefined;\n          const { emailService } = require(\"./email-service\");\n          await emailService.sendPasswordChangedEmail(userEmail, {\n            username,\n            ipAddress,\n            timezone: clientTimezone,\n          });\n          AuthLogger.logAuthEvent(\"PASSWORD_CHANGED_EMAIL_SENT\", req, { userId: user.id });\n        } catch (emailError) {\n          AuthLogger.logAuthEvent(\"PASSWORD_CHANGED_EMAIL_FAILED\", req, {\n            level: \"warn\",\n            userId: user.id,\n            error: emailError as Error,\n          });\n        }\n      }\n\n      try {\n        await storage.cleanupUsedPasswordResetTokens(resetToken!.userId);\n      } catch (cleanupError) {\n        AuthLogger.logAuthEvent(\"TOKEN_CLEANUP_FAILED\", req, {\n          level: \"warn\",\n          userId: resetToken!.userId,\n          error: cleanupError as Error,\n        });\n      }\n\n      AuthLogger.logPasswordReset(req, userEmail, \"completed\");\n      res.json({ message: \"Password reset successfully\" });\n    } catch (error: any) {\n      const durationMs = Date.now() - startTime;\n      AuthLogger.logAuthEvent(\"RESET_PASSWORD_ERROR\", req, {\n        level: \"error\",\n        error,\n        durationMs,\n      });\n      \n      if (error instanceof AuthError) {\n        return res.status(error.statusCode).json(error.toJSON());\n      }\n      \n      res.status(500).json({\n        error: {\n          code: AuthErrorCode.INTERNAL_ERROR,\n          message: \"Failed to reset password. Please try again.\",\n        },\n      });\n    }\n  });\n\n  app.post(\"/api/auth/verify-email\", async (req, res) => {\n    try {\n      const { token } = req.body;\n\n      if (!token) {\n        return res.status(400).json({ message: \"Verification token is required\" });\n      }\n\n      const verificationToken = await storage.getEmailVerificationToken(token);\n\n      if (!verificationToken) {\n        return res.status(400).json({ message: \"Invalid verification link\" });\n      }\n\n      if (verificationToken.verifiedAt) {\n        return res.status(400).json({ message: \"Email has already been verified\" });\n      }\n\n      if (new Date() > verificationToken.expiresAt) {\n        return res.status(400).json({ message: \"Verification link has expired\", code: \"TOKEN_EXPIRED\" });\n      }\n\n      // Mark email as verified\n      await storage.markEmailVerified(verificationToken.userId, token);\n\n      res.json({ message: \"Email verified successfully\" });\n    } catch (error: any) {\n      console.error(\"Verify email error:\", error);\n      res.status(500).json({ message: \"Failed to verify email\" });\n    }\n  });\n\n  app.post(\"/api/auth/resend-verification\", authLimiter, isAuthenticated, async (req, res) => {\n    try {\n      const user = await storage.getUser(req.user!.id);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n\n      if (user.emailVerified) {\n        return res.status(400).json({ message: \"Email is already verified\" });\n      }\n\n      // Send new verification email (old tokens are deleted inside the service)\n      await authSecurityService.sendVerificationEmail(user.id, user.email, user.username);\n\n      res.json({ message: \"Verification email sent\" });\n    } catch (error: any) {\n      console.error(\"Resend verification error:\", error);\n      res.status(500).json({ message: \"Failed to send verification email\" });\n    }\n  });\n\n  app.get(\"/api/typing/paragraph\", aiGenerationLimiter, async (req, res) => {\n    try {\n      const language = (req.query.language as string) || \"en\";\n      const mode = req.query.mode as string | undefined;\n      const difficulty = req.query.difficulty as string | undefined;\n      const customPrompt = req.query.customPrompt as string | undefined;\n      const generateIfMissing = req.query.generate === \"true\";\n      const forceGenerate = req.query.forceGenerate === \"true\";\n      \n      let paragraph: any = undefined;\n      let isGenerated = false;\n      \n      // If forceGenerate is true, always create new AI content\n      if (forceGenerate && mode) {\n        console.log(`ðŸ”„ Force generating new AI paragraph for ${language}/${mode}/${difficulty || 'medium'}`);\n        \n        try {\n          const content = await generateTypingParagraph(\n            language, \n            mode, \n            (difficulty as \"easy\" | \"medium\" | \"hard\") || \"medium\"\n          );\n          const wordCount = content.split(/\\s+/).length;\n          \n          // Save to database\n          paragraph = await storage.createTypingParagraph({\n            language,\n            mode,\n            difficulty: (difficulty as \"easy\" | \"medium\" | \"hard\") || \"medium\",\n            content,\n            wordCount,\n          });\n          \n          isGenerated = true;\n          console.log(`âœ… Force generated and saved new paragraph`);\n        } catch (aiError) {\n          console.error(\"âŒ Force generation failed:\", aiError);\n          // Continue to try other methods\n        }\n      }\n      \n      // If custom prompt is provided, always generate with AI\n      if (!paragraph && customPrompt && customPrompt.trim()) {\n        console.log(`ðŸ¤– Generating custom AI paragraph: \"${customPrompt}\"`);\n        \n        try {\n          const content = await generateTypingParagraph(\n            language, \n            mode || \"general\", \n            (difficulty as \"easy\" | \"medium\" | \"hard\") || \"medium\",\n            customPrompt.trim()\n          );\n          const wordCount = content.split(/\\s+/).length;\n          \n          // Save to database with custom mode name\n          paragraph = await storage.createTypingParagraph({\n            language,\n            mode: `custom_${Date.now()}`, // Unique mode for custom content\n            difficulty: (difficulty as \"easy\" | \"medium\" | \"hard\") || \"medium\",\n            content,\n            wordCount,\n          });\n          \n          isGenerated = true;\n          console.log(`âœ… Generated custom paragraph: ${wordCount} words`);\n        } catch (aiError) {\n          console.error(\"âŒ Custom AI generation failed:\", aiError);\n          return res.status(500).json({ message: \"Failed to generate custom content\" });\n        }\n      } \n      // Check for exact match first (no fallbacks)\n      else if (mode) {\n        console.log(`ðŸ” Looking for exact match: ${language}/${mode}/${difficulty || 'medium'}`);\n        paragraph = await storage.getExactParagraph(language, mode, difficulty);\n        if (paragraph) {\n          console.log(`âœ… Found exact match: ID ${paragraph.id}, \"${paragraph.content.substring(0, 50)}...\"`);\n        } else {\n          console.log(`âŒ No exact match found`);\n        }\n      }\n      \n      // If no exact match found and AI generation is requested\n      if (!paragraph && generateIfMissing && mode && !customPrompt) {\n        console.log(`ðŸ¤– Generating AI paragraph for ${language}/${mode}/${difficulty || 'medium'}`);\n        \n        try {\n          const content = await generateTypingParagraph(\n            language, \n            mode, \n            (difficulty as \"easy\" | \"medium\" | \"hard\") || \"medium\"\n          );\n          const wordCount = content.split(/\\s+/).length;\n          \n          // Save to database\n          paragraph = await storage.createTypingParagraph({\n            language,\n            mode,\n            difficulty: (difficulty as \"easy\" | \"medium\" | \"hard\") || \"medium\",\n            content,\n            wordCount,\n          });\n          \n          isGenerated = true;\n          console.log(`âœ… Successfully generated and saved paragraph: ID ${paragraph.id}, ${wordCount} words`);\n        } catch (aiError) {\n          console.error(\"âŒ AI generation failed:\", aiError);\n          // Fall back to existing logic if AI generation fails\n          console.log(`ðŸ”„ Falling back to random paragraph from database`);\n          paragraph = await storage.getRandomParagraph(language, mode, difficulty);\n          if (paragraph) {\n            console.log(`âœ… Fallback success: ID ${paragraph.id}`);\n          }\n        }\n      }\n      \n      // If still no paragraph, use fallback system\n      if (!paragraph) {\n        console.log(`ðŸ”„ Using fallback system for ${language}/${mode || 'any'}/${difficulty || 'any'}`);\n        paragraph = await storage.getRandomParagraph(language, mode, difficulty);\n        if (paragraph) {\n          console.log(`âœ… Fallback paragraph: ID ${paragraph.id}, mode=${paragraph.mode}`);\n        }\n      }\n      \n      if (!paragraph) {\n        console.error(`âŒ No paragraphs available for ${language}/${mode || 'any'}/${difficulty || 'any'}`);\n        return res.status(500).json({ message: \"No paragraphs available in database\" });\n      }\n      \n      console.log(`ðŸ“¤ Returning paragraph ID ${paragraph.id} for ${language}/${mode || 'any'}/${difficulty || 'any'}`);\n\n      \n      // Prevent caching so each request gets a new paragraph\n      res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, private');\n      res.setHeader('Pragma', 'no-cache');\n      res.setHeader('Expires', '0');\n      \n      res.json({ \n        paragraph,\n        fallbackUsed: !isGenerated && (paragraph.language !== language || (mode && paragraph.mode !== mode)),\n        isGenerated,\n      });\n    } catch (error: any) {\n      console.error(\"Get paragraph error:\", error);\n      res.status(500).json({ message: \"Failed to fetch paragraph\" });\n    }\n  });\n\n  // Fast batch endpoint - database only, no AI generation (for pre-fetching)\n  app.get(\"/api/typing/paragraphs/batch\", async (req, res) => {\n    try {\n      const language = (req.query.language as string) || \"en\";\n      const mode = req.query.mode as string | undefined;\n      const difficulty = req.query.difficulty as string | undefined;\n      const count = Math.min(parseInt(req.query.count as string) || 5, 10); // Max 10\n      \n      console.log(`ðŸ“¦ Batch request: ${count} paragraphs for ${language}/${mode || 'any'}/${difficulty || 'any'}`);\n      \n      // Use efficient batch fetch with single query and shuffle\n      const paragraphs = await storage.getRandomParagraphs(language, count, mode, difficulty);\n      \n      console.log(`ðŸ“¤ Returning batch: ${paragraphs.length} paragraphs, IDs: [${paragraphs.map(p => p.id).join(', ')}]`);\n      \n      res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, private');\n      res.json({ \n        paragraphs,\n        count: paragraphs.length,\n      });\n    } catch (error: any) {\n      console.error(\"Get batch paragraphs error:\", error);\n      res.status(500).json({ message: \"Failed to fetch paragraphs\" });\n    }\n  });\n\n  app.get(\"/api/typing/languages\", async (req, res) => {\n    try {\n      const languages = await storage.getAvailableLanguages();\n      res.json({ languages });\n    } catch (error: any) {\n      console.error(\"Get languages error:\", error);\n      res.status(500).json({ message: \"Failed to fetch languages\" });\n    }\n  });\n\n  app.get(\"/api/typing/modes\", async (req, res) => {\n    try {\n      const modes = await storage.getAvailableModes();\n      res.json({ modes });\n    } catch (error: any) {\n      console.error(\"Get modes error:\", error);\n      res.status(500).json({ message: \"Failed to fetch modes\" });\n    }\n  });\n\n  app.get(\"/api/conversations\", isAuthenticated, async (req, res) => {\n    try {\n      const conversations = await storage.getUserConversations(req.user!.id);\n      res.json({ conversations });\n    } catch (error: any) {\n      console.error(\"Get conversations error:\", error);\n      res.status(500).json({ message: \"Failed to fetch conversations\" });\n    }\n  });\n\n  app.post(\"/api/conversations\", isAuthenticated, async (req, res) => {\n    try {\n      const conversation = await storage.createConversation({\n        userId: req.user!.id,\n        title: req.body.title || \"New Chat\",\n        isPinned: 0,\n      });\n      res.json({ conversation });\n    } catch (error: any) {\n      console.error(\"Create conversation error:\", error);\n      res.status(500).json({ message: \"Failed to create conversation\" });\n    }\n  });\n\n  app.patch(\"/api/conversations/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const conversation = await storage.updateConversation(id, req.user!.id, req.body);\n      if (!conversation) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n      res.json({ conversation });\n    } catch (error: any) {\n      console.error(\"Update conversation error:\", error);\n      res.status(500).json({ message: \"Failed to update conversation\" });\n    }\n  });\n\n  app.delete(\"/api/conversations/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const conversation = await storage.getConversation(id, req.user!.id);\n      if (!conversation) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n      await storage.deleteConversation(id, req.user!.id);\n      res.json({ message: \"Conversation deleted\" });\n    } catch (error: any) {\n      console.error(\"Delete conversation error:\", error);\n      res.status(500).json({ message: \"Failed to delete conversation\" });\n    }\n  });\n\n  app.get(\"/api/conversations/:id/messages\", isAuthenticated, async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const conversation = await storage.getConversation(id, req.user!.id);\n      if (!conversation) {\n        return res.status(404).json({ message: \"Conversation not found\" });\n      }\n      const messages = await storage.getConversationMessages(id);\n      res.json({ messages });\n    } catch (error: any) {\n      console.error(\"Get messages error:\", error);\n      res.status(500).json({ message: \"Failed to fetch messages\" });\n    }\n  });\n\n  // File upload middleware - memory storage for immediate processing\n  const upload = multer({\n    storage: multer.memoryStorage(),\n    limits: {\n      fileSize: 10 * 1024 * 1024, // 10MB limit\n    },\n    fileFilter: (req: any, file: any, cb: any) => {\n      const allowedMimeTypes = [\n        'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp',\n        'application/pdf',\n        'application/msword',\n        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n        'text/plain'\n      ];\n\n      if (allowedMimeTypes.includes(file.mimetype)) {\n        cb(null, true);\n      } else {\n        cb(new Error('Invalid file type. Only images, PDFs, Word documents, and text files are allowed.'));\n      }\n    },\n  });\n\n  // File analysis endpoint\n  app.post(\"/api/analyze-file\", isAuthenticated, upload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n\n      const analysis = await analyzeFile(req.file);\n\n      res.json({\n        success: true,\n        analysis,\n        fileName: req.file.originalname,\n        fileSize: req.file.size,\n        mimeType: req.file.mimetype,\n      });\n    } catch (error) {\n      console.error(\"File analysis error:\", error);\n      res.status(500).json({\n        success: false,\n        message: error instanceof Error ? error.message : \"Failed to analyze file\",\n      });\n    }\n  });\n\n  app.post(\"/api/chat\", isAuthenticated, chatLimiter, async (req, res) => {\n    try {\n      const { messages: requestMessages, conversationId } = req.body;\n\n      if (!requestMessages || !Array.isArray(requestMessages)) {\n        return res.status(400).json({ message: \"Invalid request: messages array required\" });\n      }\n\n      if (!process.env.OPENAI_API_KEY) {\n        return res.status(503).json({ message: \"AI service not configured\" });\n      }\n\n      const sanitizedMessages = requestMessages.map((m: ChatMessage) => ({\n        ...m,\n        content: DOMPurify.sanitize(m.content, { ALLOWED_TAGS: [] }),\n      }));\n\n      const lastUserMessage = sanitizedMessages.filter((m: ChatMessage) => m.role === \"user\").pop();\n      if (!lastUserMessage) {\n        return res.status(400).json({ message: \"No user message found\" });\n      }\n\n      let convId = conversationId;\n      let isNewConversation = false;\n      \n      if (!convId) {\n        // Create conversation with temporary title\n        const conversation = await storage.createConversation({\n          userId: req.user!.id,\n          title: \"New Chat\",\n          isPinned: 0,\n        });\n        convId = conversation.id;\n        isNewConversation = true;\n      } else {\n        const conversation = await storage.getConversation(convId, req.user!.id);\n        if (!conversation) {\n          return res.status(404).json({ message: \"Conversation not found\" });\n        }\n        // Check if this is the first message in an existing \"New Chat\" conversation\n        const existingMessages = await storage.getConversationMessages(convId);\n        if (existingMessages.length === 0 && conversation.title === \"New Chat\") {\n          isNewConversation = true;\n        }\n      }\n\n      await storage.createMessage({\n        conversationId: convId,\n        role: \"user\",\n        content: lastUserMessage.content,\n      });\n\n      res.setHeader(\"Content-Type\", \"text/event-stream\");\n      res.setHeader(\"Cache-Control\", \"no-cache\");\n      res.setHeader(\"Connection\", \"keep-alive\");\n\n      try {\n        let assistantResponse = \"\";\n        \n        for await (const event of streamChatCompletionWithSearch(sanitizedMessages, true)) {\n          switch (event.type) {\n            case \"searching\":\n              res.write(`data: ${JSON.stringify({ \n                type: \"searching\", \n                status: event.data.status,\n                query: event.data.query,\n                conversationId: convId \n              })}\\n\\n`);\n              break;\n            case \"search_complete\":\n              res.write(`data: ${JSON.stringify({ \n                type: \"search_complete\", \n                results: event.data.results,\n                query: event.data.query,\n                conversationId: convId \n              })}\\n\\n`);\n              break;\n            case \"content\":\n              assistantResponse += event.data;\n              res.write(`data: ${JSON.stringify({ content: event.data, conversationId: convId })}\\n\\n`);\n              break;\n            case \"sources\":\n              res.write(`data: ${JSON.stringify({ \n                type: \"sources\", \n                sources: event.data,\n                conversationId: convId \n              })}\\n\\n`);\n              break;\n            case \"error\":\n              res.write(`data: ${JSON.stringify({ error: event.data })}\\n\\n`);\n              break;\n          }\n        }\n        \n        await storage.createMessage({\n          conversationId: convId,\n          role: \"assistant\",\n          content: assistantResponse,\n        });\n\n        if (isNewConversation) {\n          generateConversationTitle(lastUserMessage.content)\n            .then(async (title) => {\n              try {\n                await storage.updateConversation(convId!, req.user!.id, { title });\n                console.log(`[Chat] Generated title for conversation ${convId}: \"${title}\"`);\n              } catch (err) {\n                console.error(`[Chat] Failed to update conversation title:`, err);\n              }\n            })\n            .catch((err) => {\n              console.error(`[Chat] Title generation failed:`, err);\n            });\n        }\n\n        res.write(\"data: [DONE]\\n\\n\");\n        res.end();\n      } catch (streamError: any) {\n        console.error(\"Streaming error:\", streamError);\n        res.write(`data: ${JSON.stringify({ error: streamError.message })}\\n\\n`);\n        res.end();\n      }\n    } catch (error: any) {\n      console.error(\"Chat API error:\", error);\n      res.status(500).json({ message: \"Chat service error\" });\n    }\n  });\n\n  // Multiplayer Racing Routes\n  app.post(\"/api/races/quick-match\", async (req, res) => {\n    try {\n      const user = req.user;\n      const { guestId, raceType, timeLimitSeconds } = req.body;\n      let username: string;\n      \n      if (user) {\n        username = user.username;\n      } else {\n        username = generateGuestUsername();\n      }\n      \n      const avatarColor = user?.avatarColor || \"bg-primary\";\n      \n      // Default to timed race with 60 seconds if not specified\n      const effectiveRaceType = raceType || \"timed\";\n      const effectiveTimeLimit = timeLimitSeconds || 60;\n\n      const activeRaces = await storage.getActiveRaces();\n      \n      // Find a waiting public race with matching type/duration and available slots\n      let availableRace = null;\n      for (const r of activeRaces) {\n        if (r.status === \"waiting\" && r.isPrivate === 0) {\n          // For timed races, match by duration\n          if (effectiveRaceType === \"timed\") {\n            if (r.raceType !== \"timed\" || r.timeLimitSeconds !== effectiveTimeLimit) {\n              continue;\n            }\n          } else {\n            // For standard races, don't match with timed races\n            if (r.raceType === \"timed\") {\n              continue;\n            }\n          }\n          \n          const participants = await storage.getRaceParticipants(r.id);\n          // Count only human participants (bots can be replaced)\n          const humanCount = participants.filter(p => p.isBot !== 1).length;\n          if (humanCount < r.maxPlayers) {\n            availableRace = r;\n            break;\n          }\n        }\n      }\n\n      let race;\n      let paragraphContent: string;\n      let paragraphId: number | undefined;\n      \n      if (availableRace) {\n        race = availableRace;\n      } else {\n        // For timed races, generate more content\n        if (effectiveRaceType === \"timed\") {\n          const paragraphs: string[] = [];\n          // Generate enough content for the duration (estimate ~60 WPM, 5 chars/word)\n          const estimatedCharsNeeded = Math.ceil((effectiveTimeLimit / 60) * 60 * 5 * 2);\n          let totalChars = 0;\n          \n          while (totalChars < estimatedCharsNeeded) {\n            const para = await storage.getRandomParagraph(\"english\", \"quote\");\n            if (para) {\n              paragraphs.push(para.content);\n              totalChars += para.content.length;\n            } else {\n              break;\n            }\n          }\n          paragraphContent = paragraphs.join(\" \");\n        } else {\n          const paragraph = await storage.getRandomParagraph(\"english\", \"quote\");\n          if (!paragraph) {\n            return res.status(500).json({ message: \"No paragraph available\" });\n          }\n          paragraphContent = paragraph.content;\n          paragraphId = paragraph.id;\n        }\n\n        if (!paragraphContent) {\n          return res.status(500).json({ message: \"No paragraph available\" });\n        }\n\n        const roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();\n        race = await storage.createRace({\n          roomCode,\n          status: \"waiting\",\n          raceType: effectiveRaceType,\n          timeLimitSeconds: effectiveRaceType === \"timed\" ? effectiveTimeLimit : null,\n          paragraphId,\n          paragraphContent,\n          maxPlayers: 8, // Allow up to 8 players, bots will be replaced when humans join\n          isPrivate: 0,\n        });\n      }\n\n      const participants = await storage.getRaceParticipants(race.id);\n      let participant = participants.find(p => {\n        if (user) {\n          return p.userId === user.id;\n        } else {\n          return p.guestName === guestId;\n        }\n      });\n\n      if (!participant) {\n        const inactive = await storage.findInactiveParticipant(race.id, user?.id, guestId);\n        \n        if (inactive) {\n          participant = await storage.reactivateRaceParticipant(inactive.id);\n        } else {\n          // Check if race is full\n          if (participants.length >= race.maxPlayers) {\n            // Try to replace a bot with the human player\n            const botToReplace = participants.find(p => p.isBot === 1);\n            if (botToReplace) {\n              // Remove the bot to make room for the human\n              await storage.deleteRaceParticipant(botToReplace.id);\n              console.log(`[Quick Match] Replaced bot ${botToReplace.username} with human ${username}`);\n            } else {\n              return res.status(400).json({ message: \"Race is full\" });\n            }\n          }\n\n          participant = await storage.createRaceParticipant({\n            raceId: race.id,\n            userId: user?.id,\n            guestName: user ? undefined : guestId,\n            username,\n            avatarColor,\n            progress: 0,\n            wpm: 0,\n            accuracy: 0,\n            errors: 0,\n            isFinished: 0,\n            isBot: 0,\n          });\n        }\n      }\n\n      res.json({ race, participant });\n    } catch (error: any) {\n      console.error(\"Quick match error:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/races/create\", async (req, res) => {\n    try {\n      const { isPrivate, maxPlayers: rawMaxPlayers, guestId, timeLimitSeconds: rawTimeLimit, textSource } = req.body;\n      const user = req.user;\n      \n      // Validate and sanitize room settings\n      const maxPlayers = Math.max(2, Math.min(10, Number(rawMaxPlayers) || 4));\n      \n      // Validate duration (30, 60, 90, 120 seconds)\n      const validDurations = [30, 60, 90, 120];\n      const timeLimitSeconds = validDurations.includes(Number(rawTimeLimit)) ? Number(rawTimeLimit) : 60;\n      \n      // Validate text source\n      const validTextSources = [\"general\", \"quotes\", \"programming\", \"technical\", \"news\", \"entertainment\", \"random\"];\n      const selectedTextSource = validTextSources.includes(textSource) ? textSource : \"general\";\n      \n      let username: string;\n      \n      if (user) {\n        username = user.username;\n      } else {\n        username = generateGuestUsername();\n      }\n      \n      const avatarColor = user?.avatarColor || \"bg-primary\";\n\n      let paragraphContent = \"\";\n      let paragraphId: number | undefined;\n      \n      // All races are timed - generate enough content for the maximum duration (120s)\n      // Estimate: 80 WPM * 5 chars/word = 400 chars/min, add buffer for 2 min max\n      const estimatedChars = Math.ceil((120 / 60) * 400 * 2);\n      const paragraphsNeeded = Math.ceil(estimatedChars / 300);\n      \n      const paragraphs: string[] = [];\n      \n      // Map client text source to database mode names\n      // Database modes: general, technical, entertainment, quotes, programming, business, stories, news\n      const modeMapping: Record<string, string | null> = {\n        \"general\": \"general\",\n        \"quotes\": \"quotes\",\n        \"programming\": \"programming\", \n        \"technical\": \"technical\",\n        \"news\": \"news\",\n        \"entertainment\": \"entertainment\",\n        \"random\": null, // null means pick from all available modes\n      };\n      \n      const dbMode = modeMapping[selectedTextSource];\n      \n      console.log(`[Race Create] Text source: ${selectedTextSource}, DB mode: ${dbMode}`);\n      \n      if (dbMode === null) {\n        // Random mode: pick from multiple categories for variety\n        const availableModes = [\"general\", \"quotes\", \"programming\", \"technical\", \"news\", \"entertainment\"];\n        const usedParagraphIds = new Set<number>();\n        \n        for (let i = 0; i < Math.max(paragraphsNeeded, 3); i++) {\n          // Pick a random mode for each paragraph\n          const randomMode = availableModes[Math.floor(Math.random() * availableModes.length)];\n          const p = await storage.getRandomParagraph(\"english\", randomMode);\n          if (p && !usedParagraphIds.has(p.id)) {\n            usedParagraphIds.add(p.id);\n            paragraphs.push(p.content);\n            if (i === 0) paragraphId = p.id;\n          } else {\n            // Fallback to general mode if we get a duplicate\n            const fallbackP = await storage.getRandomParagraph(\"english\", \"general\");\n            if (fallbackP && !usedParagraphIds.has(fallbackP.id)) {\n              usedParagraphIds.add(fallbackP.id);\n              paragraphs.push(fallbackP.content);\n              if (i === 0) paragraphId = fallbackP.id;\n            }\n          }\n        }\n      } else {\n        // Specific mode selected - use getRandomParagraphs for efficiency and uniqueness\n        const selectedParagraphs = await storage.getRandomParagraphs(\"english\", Math.max(paragraphsNeeded, 3), dbMode);\n        \n        if (selectedParagraphs.length > 0) {\n          for (let i = 0; i < selectedParagraphs.length; i++) {\n            paragraphs.push(selectedParagraphs[i].content);\n            if (i === 0) paragraphId = selectedParagraphs[i].id;\n          }\n        } else {\n          // Fallback: if the specific mode has no content, use general\n          console.log(`[Race Create] No paragraphs found for mode \"${dbMode}\", falling back to general`);\n          const fallbackParagraphs = await storage.getRandomParagraphs(\"english\", Math.max(paragraphsNeeded, 3), \"general\");\n          for (let i = 0; i < fallbackParagraphs.length; i++) {\n            paragraphs.push(fallbackParagraphs[i].content);\n            if (i === 0) paragraphId = fallbackParagraphs[i].id;\n          }\n        }\n      }\n      \n      paragraphContent = paragraphs.join(\" \");\n      console.log(`[Race Create] Generated ${paragraphs.length} paragraphs, total ${paragraphContent.length} chars`);\n\n      if (!paragraphContent) {\n        return res.status(500).json({ message: \"No paragraph available\" });\n      }\n\n      const roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();\n      const race = await storage.createRace({\n        roomCode,\n        status: \"waiting\",\n        raceType: \"timed\",\n        timeLimitSeconds,\n        paragraphId,\n        paragraphContent,\n        maxPlayers: maxPlayers || 4,\n        isPrivate: isPrivate ? 1 : 0,\n      });\n\n      let participant = await storage.createRaceParticipant({\n        raceId: race.id,\n        userId: user?.id,\n        guestName: user ? undefined : guestId,\n        username,\n        avatarColor,\n        progress: 0,\n        wpm: 0,\n        accuracy: 0,\n        errors: 0,\n        isFinished: 0,\n        isBot: 0,\n      });\n\n      // Bots and race duration will be configured by host in waiting room before starting\n\n      res.json({ race, participant });\n    } catch (error: any) {\n      console.error(\"Create race error:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.post(\"/api/races/join/:roomCode\", async (req, res) => {\n    try {\n      const { roomCode } = req.params;\n      const { guestId } = req.body;\n      const user = req.user;\n      let username: string;\n      \n      if (user) {\n        username = user.username;\n      } else {\n        username = generateGuestUsername();\n      }\n      \n      const avatarColor = user?.avatarColor || \"bg-primary\";\n\n      const race = await storage.getRaceByCode(roomCode.toUpperCase());\n      if (!race) {\n        return res.status(404).json({ message: \"Race not found\" });\n      }\n\n      if (race.status !== \"waiting\") {\n        const statusMessages: Record<string, string> = {\n          countdown: \"Race is about to start - cannot join during countdown\",\n          racing: \"Race is in progress - cannot join an active race\",\n          finished: \"Race has ended - please join a new room\",\n        };\n        return res.status(409).json({ \n          message: statusMessages[race.status] || \"Race has already started\",\n          code: \"RACE_STARTED\"\n        });\n      }\n\n      const participants = await storage.getRaceParticipants(race.id);\n      \n      let participant = participants.find(p => {\n        if (user) {\n          return p.userId === user.id;\n        } else {\n          return p.guestName === guestId;\n        }\n      });\n\n      if (!participant) {\n        const inactive = await storage.findInactiveParticipant(race.id, user?.id, guestId);\n        \n        if (inactive) {\n          participant = await storage.reactivateRaceParticipant(inactive.id);\n        } else {\n          // Check if race is full\n          if (participants.length >= race.maxPlayers) {\n            // If there are bots, remove one to make room for the human player\n            const botParticipants = participants.filter(p => p.isBot === 1);\n            if (botParticipants.length > 0) {\n              // Remove a bot to make room for the human\n              const botToRemove = botParticipants[botParticipants.length - 1];\n              await storage.deleteRaceParticipant(botToRemove.id);\n              console.log(`[Join Room] Removed bot ${botToRemove.username} to make room for human player`);\n            } else {\n              // No bots to remove - race is truly full with humans\n              return res.status(400).json({ message: \"Race is full\" });\n            }\n          }\n\n          participant = await storage.createRaceParticipant({\n            raceId: race.id,\n            userId: user?.id,\n            guestName: user ? undefined : guestId,\n            username,\n            avatarColor,\n            progress: 0,\n            wpm: 0,\n            accuracy: 0,\n            errors: 0,\n            isFinished: 0,\n            isBot: 0,\n          });\n          \n          // CRITICAL: Update the race cache with the new participant\n          // This ensures WebSocket can find the participant when they connect\n          const { raceCache } = await import(\"./race-cache\");\n          const updatedParticipants = await storage.getRaceParticipants(race.id);\n          raceCache.updateParticipants(race.id, updatedParticipants);\n          console.log(`[Join Room] Updated race cache with new participant ${username} (${participant.id})`);\n        }\n      }\n\n      res.json({ race, participant });\n    } catch (error: any) {\n      console.error(\"Join race error:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Active races route must be before :id route to avoid matching \"active\" as an id\n  app.get(\"/api/races/active\", async (req, res) => {\n    try {\n      const { raceCache } = await import(\"./race-cache\");\n      const cachedRaces = raceCache.getActiveRaces();\n      \n      if (cachedRaces.length > 0) {\n        return res.json(cachedRaces);\n      }\n      \n      const activeRaces = await storage.getActiveRaces();\n      res.json(activeRaces);\n    } catch (error: any) {\n      console.error(\"Get active races error:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // Health check endpoints for load balancers and monitoring\n  app.get(\"/health\", async (req, res) => {\n    try {\n      const { performHealthCheck } = await import(\"./health-check\");\n      const includeMetrics = req.query.metrics === \"true\";\n      const result = await performHealthCheck(includeMetrics);\n      \n      const statusCode = result.status === \"healthy\" ? 200 : result.status === \"degraded\" ? 200 : 503;\n      res.status(statusCode).json(result);\n    } catch (error: any) {\n      res.status(503).json({ status: \"unhealthy\", error: error.message });\n    }\n  });\n\n  app.get(\"/health/live\", async (req, res) => {\n    try {\n      const { performLivenessCheck } = await import(\"./health-check\");\n      const result = await performLivenessCheck();\n      res.status(result.alive ? 200 : 503).json(result);\n    } catch (error: any) {\n      res.status(503).json({ alive: false, error: error.message });\n    }\n  });\n\n  app.get(\"/health/ready\", async (req, res) => {\n    try {\n      const { performReadinessCheck } = await import(\"./health-check\");\n      const result = await performReadinessCheck();\n      res.status(result.ready ? 200 : 503).json(result);\n    } catch (error: any) {\n      res.status(503).json({ ready: false, error: error.message });\n    }\n  });\n\n  // Scalability stats endpoint for monitoring\n  app.get(\"/api/races/stats\", async (req, res) => {\n    try {\n      const { raceWebSocket } = await import(\"./websocket\");\n      const { metricsCollector } = await import(\"./metrics\");\n      \n      res.json({\n        websocket: raceWebSocket.getStats(),\n        cache: raceWebSocket.getCacheStats(),\n        rateLimiter: raceWebSocket.getRateLimiterStats(),\n        cleanup: raceWebSocket.getCleanupStats(),\n        loadState: raceWebSocket.getLoadState(),\n        isUnderPressure: raceWebSocket.isUnderPressure(),\n        metrics: metricsCollector.getStats(),\n      });\n    } catch (error: any) {\n      console.error(\"Get race stats error:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  app.get(\"/api/races/:id\", async (req, res) => {\n    try {\n      const id = req.params.id;\n      \n      let raceData;\n      if (/^\\d+$/.test(id)) {\n        const raceId = parseInt(id);\n        raceData = await storage.getRaceWithParticipants(raceId);\n      } else {\n        const race = await storage.getRaceByCode(id);\n        if (race) {\n          raceData = await storage.getRaceWithParticipants(race.id);\n        }\n      }\n      \n      if (!raceData) {\n        return res.status(404).json({ message: \"Race not found\" });\n      }\n\n      res.json(raceData);\n    } catch (error: any) {\n      console.error(\"Get race error:\", error);\n      res.status(500).json({ message: error.message });\n    }\n  });\n\n  // ============================================================================\n  // MULTIPLAYER RACING ENHANCED FEATURES API\n  // ============================================================================\n\n  const ratingLimiter = rateLimit({\n    windowMs: 60 * 1000,\n    max: 30,\n    message: { message: \"Too many requests, please try again later\" },\n    standardHeaders: true,\n    legacyHeaders: false,\n  });\n\n  // User Ratings API\n  app.get(\"/api/ratings/me\", isAuthenticated, ratingLimiter, async (req, res) => {\n    try {\n      const rating = await storage.getOrCreateUserRating(req.user!.id);\n      const { eloRatingService } = await import(\"./elo-rating-service\");\n      const tierInfo = eloRatingService.getTierInfo(rating.tier);\n      res.json({ rating: { ...rating, tierInfo } });\n    } catch (error: any) {\n      console.error(\"Get user rating error:\", error);\n      res.status(500).json({ message: \"Failed to fetch rating\" });\n    }\n  });\n\n  app.get(\"/api/ratings/leaderboard\", ratingLimiter, async (req, res) => {\n    try {\n      const tier = req.query.tier as string | undefined;\n      const limit = Math.min(Math.max(1, parseInt(req.query.limit as string) || 50), 100);\n      const offset = Math.max(0, parseInt(req.query.offset as string) || 0);\n      const cursor = req.query.cursor as string | undefined;\n      \n      if (tier && ![\"bronze\", \"silver\", \"gold\", \"platinum\", \"diamond\", \"master\", \"grandmaster\"].includes(tier)) {\n        return res.status(400).json({ message: \"Invalid tier\" });\n      }\n      \n      const actualOffset = cursor ? leaderboardCache.decodeCursor(cursor) : offset;\n      \n      const result = await leaderboardCache.getRatingLeaderboard({\n        tier,\n        limit,\n        offset: actualOffset,\n      });\n      \n      const { eloRatingService } = await import(\"./elo-rating-service\");\n      const enrichedEntries = result.entries.map((entry: any) => ({\n        ...entry,\n        tierInfo: eloRatingService.getTierInfo(entry.tier),\n      }));\n      \n      res.set('Cache-Control', 'public, max-age=15');\n      res.set('X-Cache', result.metadata.cacheHit ? 'HIT' : 'MISS');\n      res.set('X-Total-Count', String(result.pagination.total));\n\n      res.json({\n        ...result,\n        entries: enrichedEntries,\n      });\n    } catch (error: any) {\n      console.error(\"Get rating leaderboard error:\", error);\n      res.status(500).json({ message: \"Failed to fetch leaderboard\" });\n    }\n  });\n\n  app.get(\"/api/ratings/leaderboard/around-me\", isAuthenticated, ratingLimiter, async (req, res) => {\n    try {\n      const tier = req.query.tier as string | undefined;\n      const range = Math.min(Math.max(1, parseInt(req.query.range as string) || 5), 20);\n      \n      const result = await leaderboardCache.getAroundMe(\"rating\", req.user!.id, { tier, range });\n      \n      res.set('Cache-Control', 'private, max-age=10');\n      res.set('X-Cache', result.cacheHit ? 'HIT' : 'MISS');\n      \n      res.json({\n        userRank: result.userRank,\n        entries: result.entries,\n      });\n    } catch (error: any) {\n      console.error(\"Get rating leaderboard around me error:\", error);\n      res.status(500).json({ message: \"Failed to fetch leaderboard\" });\n    }\n  });\n\n  app.get(\"/api/ratings/:userId\", ratingLimiter, async (req, res) => {\n    try {\n      const userId = req.params.userId;\n      \n      if (!userId || typeof userId !== 'string' || userId.length > 100) {\n        return res.status(400).json({ message: \"Invalid user ID\" });\n      }\n      \n      const rating = await storage.getUserRating(userId);\n      \n      if (!rating) {\n        return res.status(404).json({ message: \"Rating not found\" });\n      }\n\n      const { eloRatingService } = await import(\"./elo-rating-service\");\n      const tierInfo = eloRatingService.getTierInfo(rating.tier);\n      res.json({ rating: { ...rating, tierInfo } });\n    } catch (error: any) {\n      console.error(\"Get user rating error:\", error);\n      res.status(500).json({ message: \"Failed to fetch rating\" });\n    }\n  });\n\n  // Match History API\n  app.get(\"/api/match-history\", isAuthenticated, ratingLimiter, async (req, res) => {\n    try {\n      const limitParam = req.query.limit ? parseInt(req.query.limit as string) : 20;\n      const limit = Math.min(Math.max(1, limitParam), 100);\n      const history = await storage.getUserMatchHistory(req.user!.id, limit);\n      res.json({ history });\n    } catch (error: any) {\n      console.error(\"Get match history error:\", error);\n      res.status(500).json({ message: \"Failed to fetch match history\" });\n    }\n  });\n\n  // Race Replays API\n  app.get(\"/api/replays/public\", ratingLimiter, async (req, res) => {\n    try {\n      const limitParam = req.query.limit ? parseInt(req.query.limit as string) : 20;\n      const limit = Math.min(Math.max(1, limitParam), 50);\n      const replays = await storage.getPublicReplays(limit);\n      res.json({ replays });\n    } catch (error: any) {\n      console.error(\"Get public replays error:\", error);\n      res.status(500).json({ message: \"Failed to fetch replays\" });\n    }\n  });\n\n  app.get(\"/api/replays/:raceId\", ratingLimiter, async (req, res) => {\n    try {\n      const raceIdParam = req.params.raceId;\n      \n      if (!raceIdParam || !/^\\d+$/.test(raceIdParam)) {\n        return res.status(400).json({ message: \"Invalid race ID\" });\n      }\n      \n      const raceId = parseInt(raceIdParam);\n      \n      if (raceId <= 0 || raceId > 2147483647) {\n        return res.status(400).json({ message: \"Invalid race ID\" });\n      }\n      \n      const replay = await storage.getRaceReplay(raceId);\n      \n      if (!replay) {\n        return res.status(404).json({ message: \"Replay not found\" });\n      }\n\n      if (!replay.isPublic) {\n        const race = await storage.getRace(raceId);\n        if (race) {\n          const participants = await storage.getRaceParticipants(raceId);\n          const userId = req.user?.id;\n          const isParticipant = userId && participants.some(p => p.userId === userId);\n          \n          if (!isParticipant) {\n            return res.status(403).json({ message: \"Access denied: private replay\" });\n          }\n        }\n      }\n\n      await storage.incrementReplayViewCount(raceId);\n      res.json({ replay });\n    } catch (error: any) {\n      console.error(\"Get replay error:\", error);\n      res.status(500).json({ message: \"Failed to fetch replay\" });\n    }\n  });\n\n  // Race Chat History API\n  app.get(\"/api/races/:raceId/chat\", ratingLimiter, async (req, res) => {\n    try {\n      const raceIdParam = req.params.raceId;\n      \n      if (!raceIdParam || !/^\\d+$/.test(raceIdParam)) {\n        return res.status(400).json({ message: \"Invalid race ID\" });\n      }\n      \n      const raceId = parseInt(raceIdParam);\n      const limitParam = req.query.limit ? parseInt(req.query.limit as string) : 100;\n      const limit = Math.min(Math.max(1, limitParam), 500);\n      const messages = await storage.getRaceChatMessages(raceId, limit);\n      res.json({ messages });\n    } catch (error: any) {\n      console.error(\"Get race chat error:\", error);\n      res.status(500).json({ message: \"Failed to fetch chat messages\" });\n    }\n  });\n\n  // Anti-Cheat Certification API\n  app.get(\"/api/anti-cheat/certification\", isAuthenticated, async (req, res) => {\n    try {\n      const certification = await storage.getUserCertification(req.user!.id);\n      res.json({ \n        certified: !!certification,\n        certification: certification || null,\n      });\n    } catch (error: any) {\n      console.error(\"Get certification error:\", error);\n      res.status(500).json({ message: \"Failed to fetch certification\" });\n    }\n  });\n\n  app.post(\"/api/anti-cheat/challenge\", isAuthenticated, async (req, res) => {\n    try {\n      const { antiCheatService } = await import(\"./anticheat-service\");\n      const challengeText = await antiCheatService.triggerVerificationChallenge(\n        req.user!.id,\n        req.body.triggeredWpm || 100\n      );\n      res.json({ challengeText });\n    } catch (error: any) {\n      console.error(\"Create challenge error:\", error);\n      res.status(500).json({ message: \"Failed to create challenge\" });\n    }\n  });\n\n  // Skill-Based Matchmaking API\n  app.get(\"/api/matchmaking/pool\", isAuthenticated, ratingLimiter, async (req, res) => {\n    try {\n      const toleranceParam = req.query.tolerance ? parseInt(req.query.tolerance as string) : 200;\n      const tolerance = Math.min(Math.max(50, toleranceParam), 500);\n      const { eloRatingService } = await import(\"./elo-rating-service\");\n      const pool = await eloRatingService.getMatchmakingPool(req.user!.id, tolerance);\n      \n      const enrichedPool = await Promise.all(\n        pool.map(async (rating) => {\n          const user = await storage.getUser(rating.userId);\n          return {\n            ...rating,\n            username: user?.username || \"Unknown\",\n            avatarColor: user?.avatarColor,\n            tierInfo: eloRatingService.getTierInfo(rating.tier),\n          };\n        })\n      );\n\n      res.json({ matchmakingPool: enrichedPool });\n    } catch (error: any) {\n      console.error(\"Get matchmaking pool error:\", error);\n      res.status(500).json({ message: \"Failed to fetch matchmaking pool\" });\n    }\n  });\n\n  // Flagged Keystrokes API (Admin)\n  app.get(\"/api/admin/flagged-keystrokes\", isAuthenticated, async (req, res) => {\n    try {\n      const limit = req.query.limit ? parseInt(req.query.limit as string) : 50;\n      const flagged = await storage.getFlaggedKeystrokes(limit);\n      res.json({ flagged });\n    } catch (error: any) {\n      console.error(\"Get flagged keystrokes error:\", error);\n      res.status(500).json({ message: \"Failed to fetch flagged keystrokes\" });\n    }\n  });\n\n  app.get(\"/api/code/snippet\", aiGenerationLimiter, async (req, res) => {\n    try {\n      const { z } = await import(\"zod\");\n      \n      const querySchema = z.object({\n        language: z.string().min(1).max(50).regex(/^[a-zA-Z0-9+#_-]+$/),\n        difficulty: z.enum([\"easy\", \"medium\", \"hard\"]).optional(),\n        framework: z.string().max(50).optional(),\n        generate: z.enum([\"true\", \"false\"]).optional(),\n        forceNew: z.enum([\"true\", \"false\"]).optional(),\n        timeLimit: z.string().regex(/^\\d+$/).optional(),\n        testMode: z.enum([\"normal\", \"expert\", \"master\"]).optional(),\n        customPrompt: z.string().max(500).optional(),\n      });\n      \n      const parsed = querySchema.safeParse(req.query);\n      \n      if (!parsed.success) {\n        return res.status(400).json({ \n          message: \"Invalid request parameters\",\n          errors: fromError(parsed.error).toString()\n        });\n      }\n      \n      const { language, difficulty, framework, generate, forceNew, timeLimit, testMode, customPrompt } = parsed.data;\n      const timeLimitNum = timeLimit ? parseInt(timeLimit, 10) : 0;\n\n      let snippet = null;\n      \n      // Only use cached snippets if not forcing new generation\n      if (forceNew !== \"true\") {\n        snippet = await storage.getRandomCodeSnippet(language, difficulty, framework);\n      }\n\n      // Generate new snippet if none found or force new is requested\n      if ((!snippet || forceNew === \"true\") && generate === \"true\") {\n        console.log(`ðŸ¤– Generating fresh code snippet for ${language}/${difficulty || 'medium'} (${timeLimitNum}s, ${testMode || 'normal'} mode)${customPrompt ? ` [Custom: ${customPrompt.substring(0, 50)}...]` : ''}`);\n        \n        try {\n          const { content, description } = await generateCodeSnippet(\n            language,\n            difficulty || \"medium\",\n            framework,\n            timeLimitNum,\n            testMode || \"normal\",\n            customPrompt\n          );\n          \n          const lineCount = content.split('\\n').length;\n          const characterCount = content.length;\n          \n          snippet = await storage.createCodeSnippet({\n            programmingLanguage: language,\n            framework,\n            difficulty: difficulty || \"medium\",\n            content,\n            lineCount,\n            characterCount,\n            description,\n          });\n          \n          console.log(`âœ… Generated and saved ${lineCount}-line ${language} code snippet`);\n        } catch (error) {\n          console.error(\"âŒ Code generation failed:\", error);\n          // If generation fails and we have no snippet, try to get a random one as fallback\n          if (!snippet) {\n            snippet = await storage.getRandomCodeSnippet(language, difficulty, framework);\n          }\n        }\n      }\n\n      if (!snippet) {\n        return res.status(404).json({ message: \"No code snippets available for these criteria\" });\n      }\n\n      // Disable caching for this endpoint to ensure fresh responses\n      res.set('Cache-Control', 'no-store, no-cache, must-revalidate, private');\n      res.json({ snippet });\n    } catch (error: any) {\n      console.error(\"Get code snippet error:\", error);\n      res.status(500).json({ message: \"Failed to fetch code snippet\" });\n    }\n  });\n\n  app.get(\"/api/code/languages\", async (req, res) => {\n    try {\n      const languages = await storage.getAvailableProgrammingLanguages();\n      res.json({ languages });\n    } catch (error: any) {\n      console.error(\"Get programming languages error:\", error);\n      res.status(500).json({ message: \"Failed to fetch programming languages\" });\n    }\n  });\n\n  app.get(\"/api/code/frameworks\", async (req, res) => {\n    try {\n      const language = req.query.language as string | undefined;\n      const frameworks = await storage.getAvailableFrameworks(language);\n      res.json({ frameworks });\n    } catch (error: any) {\n      console.error(\"Get frameworks error:\", error);\n      res.status(500).json({ message: \"Failed to fetch frameworks\" });\n    }\n  });\n\n  app.post(\"/api/code/test-results\", isAuthenticated, async (req, res) => {\n    try {\n      const parsed = insertCodeTypingTestSchema.safeParse({\n        ...req.body,\n        userId: req.user!.id,\n      });\n\n      if (!parsed.success) {\n        return res.status(400).json({\n          message: \"Validation failed\",\n          errors: fromError(parsed.error).toString(),\n        });\n      }\n\n      const test = await storage.createCodeTypingTest(parsed.data);\n\n      res.status(201).json({ message: \"Code typing test saved\", test });\n    } catch (error: any) {\n      console.error(\"Save code test error:\", error);\n      res.status(500).json({ message: \"Failed to save code typing test\" });\n    }\n  });\n\n  app.get(\"/api/code/test-results\", isAuthenticated, async (req, res) => {\n    try {\n      const limit = req.query.limit ? parseInt(req.query.limit as string) : 10;\n      const tests = await storage.getUserCodeTypingTests(req.user!.id, limit);\n      res.json({ tests });\n    } catch (error: any) {\n      console.error(\"Get code test results error:\", error);\n      res.status(500).json({ message: \"Failed to fetch code test results\" });\n    }\n  });\n\n  app.get(\"/api/code/stats\", isAuthenticated, async (req, res) => {\n    try {\n      const language = req.query.language as string | undefined;\n      const stats = await storage.getUserCodeStats(req.user!.id, language);\n      res.json({ stats });\n    } catch (error: any) {\n      console.error(\"Get code stats error:\", error);\n      res.status(500).json({ message: \"Failed to fetch code stats\" });\n    }\n  });\n\n  app.get(\"/api/code/leaderboard\", leaderboardLimiter, async (req, res) => {\n    try {\n      const rawLanguage = req.query.language as string | undefined;\n      const validLanguages = [\"javascript\", \"typescript\", \"python\", \"java\", \"go\", \"rust\", \"csharp\"];\n      const language = rawLanguage && validLanguages.includes(rawLanguage) ? rawLanguage : undefined;\n      const limit = Math.min(Math.max(1, parseInt(req.query.limit as string) || 20), 100);\n      const offset = Math.max(0, parseInt(req.query.offset as string) || 0);\n      const cursor = req.query.cursor as string | undefined;\n      \n      const actualOffset = cursor ? leaderboardCache.decodeCursor(cursor) : offset;\n      \n      const result = await leaderboardCache.getCodeLeaderboard({\n        language,\n        limit,\n        offset: actualOffset,\n      });\n      \n      res.set('Cache-Control', 'public, max-age=30');\n      res.set('X-Cache', result.metadata.cacheHit ? 'HIT' : 'MISS');\n      res.set('X-Total-Count', String(result.pagination.total));\n      \n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Get code leaderboard error:\", error);\n      res.status(500).json({ message: \"Failed to fetch code leaderboard\" });\n    }\n  });\n\n  app.get(\"/api/code/leaderboard/around-me\", isAuthenticated, leaderboardAroundMeLimiter, async (req, res) => {\n    try {\n      const rawLanguage = req.query.language as string | undefined;\n      const validLanguages = [\"javascript\", \"typescript\", \"python\", \"java\", \"go\", \"rust\", \"csharp\"];\n      const language = rawLanguage && validLanguages.includes(rawLanguage) ? rawLanguage : undefined;\n      const range = Math.min(Math.max(1, parseInt(req.query.range as string) || 5), 20);\n      \n      const result = await leaderboardCache.getAroundMe(\"code\", req.user!.id, { language, range });\n      \n      res.set('Cache-Control', 'private, max-age=10');\n      res.set('X-Cache', result.cacheHit ? 'HIT' : 'MISS');\n      \n      res.json({\n        userRank: result.userRank,\n        entries: result.entries,\n      });\n    } catch (error: any) {\n      console.error(\"Get code leaderboard around me error:\", error);\n      res.status(500).json({ message: \"Failed to fetch leaderboard\" });\n    }\n  });\n\n  app.post(\"/api/code/share\", isAuthenticated, async (req, res) => {\n    try {\n      const user = req.user as any;\n      \n      const sanitizedCodeContent = DOMPurify.sanitize(req.body.codeContent, {\n        ALLOWED_TAGS: [],\n        ALLOWED_ATTR: [],\n      });\n\n      let sharedResult;\n      let attempts = 0;\n      const maxAttempts = 5;\n\n      while (attempts < maxAttempts) {\n        try {\n          const shareId = Math.random().toString(36).substring(2, 12).toUpperCase();\n          \n          const dataToValidate = {\n            shareId,\n            userId: user.id,\n            username: user.username,\n            programmingLanguage: req.body.programmingLanguage,\n            framework: req.body.framework,\n            difficulty: req.body.difficulty,\n            testMode: req.body.testMode,\n            wpm: req.body.wpm,\n            accuracy: req.body.accuracy,\n            errors: req.body.errors,\n            syntaxErrors: req.body.syntaxErrors,\n            duration: req.body.duration,\n            codeContent: sanitizedCodeContent,\n          };\n\n          const validationResult = insertSharedCodeResultSchema.safeParse(dataToValidate);\n\n          if (!validationResult.success) {\n            const validationError = fromError(validationResult.error);\n            return res.status(400).json({ \n              message: \"Validation error\", \n              error: validationError.toString() \n            });\n          }\n          \n          sharedResult = await storage.createSharedCodeResult(validationResult.data);\n          \n          break;\n        } catch (err: any) {\n          if (err.code === '23505' && err.constraint === 'shared_code_results_share_id_unique') {\n            attempts++;\n            if (attempts >= maxAttempts) {\n              throw new Error(\"Failed to generate unique share ID\");\n            }\n            continue;\n          }\n          throw err;\n        }\n      }\n      \n      res.json(sharedResult);\n    } catch (error: any) {\n      console.error(\"Share code result error:\", error);\n      res.status(500).json({ message: error.message || \"Failed to share result\" });\n    }\n  });\n\n  app.get(\"/api/code/share/:shareId\", async (req, res) => {\n    try {\n      const { shareId } = req.params;\n      const sharedResult = await storage.getSharedCodeResult(shareId);\n      \n      if (!sharedResult) {\n        return res.status(404).json({ message: \"Shared result not found\" });\n      }\n      \n      const certificate = await storage.getCertificateByCodeTestId(sharedResult.id);\n      \n      res.json({\n        ...sharedResult,\n        certificate: certificate || null,\n      });\n    } catch (error: any) {\n      console.error(\"Get shared result error:\", error);\n      res.status(500).json({ message: \"Failed to fetch shared result\" });\n    }\n  });\n\n  app.get(\"/api/book-paragraphs\", async (req, res) => {\n    try {\n      const difficulty = req.query.difficulty as string | undefined;\n      const topic = req.query.topic as string | undefined;\n      const durationMode = req.query.durationMode ? parseInt(req.query.durationMode as string) : undefined;\n      const limit = req.query.limit ? parseInt(req.query.limit as string) : 10;\n      \n      if (difficulty && !['easy', 'medium', 'hard'].includes(difficulty)) {\n        return res.status(400).json({ \n          message: \"Invalid difficulty\", \n          code: \"INVALID_DIFFICULTY\",\n          validValues: ['easy', 'medium', 'hard'] \n        });\n      }\n      \n      if (durationMode && ![30, 60, 90, 120].includes(durationMode)) {\n        return res.status(400).json({ \n          message: \"Invalid duration mode\",\n          code: \"INVALID_DURATION\",\n          validValues: [30, 60, 90, 120]\n        });\n      }\n      \n      if (limit < 1 || limit > 100) {\n        return res.status(400).json({ \n          message: \"Limit must be between 1 and 100\",\n          code: \"INVALID_LIMIT\"\n        });\n      }\n      \n      const paragraphs = await storage.getBookParagraphs({\n        difficulty,\n        topic,\n        durationMode,\n        limit,\n      });\n      \n      res.json({ paragraphs });\n    } catch (error: any) {\n      console.error(\"Get book paragraphs error:\", error);\n      res.status(500).json({ \n        message: \"Failed to fetch book paragraphs\",\n        code: \"SERVER_ERROR\"\n      });\n    }\n  });\n\n  app.get(\"/api/book-paragraphs/random\", async (req, res) => {\n    try {\n      const difficulty = req.query.difficulty as string | undefined;\n      const topic = req.query.topic as string | undefined;\n      const durationMode = req.query.durationMode ? parseInt(req.query.durationMode as string) : undefined;\n      \n      if (difficulty && !['easy', 'medium', 'hard'].includes(difficulty)) {\n        return res.status(400).json({ \n          message: \"Invalid difficulty\",\n          code: \"INVALID_DIFFICULTY\",\n          validValues: ['easy', 'medium', 'hard']\n        });\n      }\n      \n      const paragraph = await storage.getRandomBookParagraph({\n        difficulty,\n        topic,\n        durationMode,\n      });\n      \n      if (!paragraph) {\n        return res.status(404).json({ \n          message: \"No paragraphs found matching your filters. Try different settings.\",\n          code: \"NO_PARAGRAPHS\",\n          filters: { difficulty, topic, durationMode }\n        });\n      }\n      \n      res.json(paragraph);\n    } catch (error: any) {\n      console.error(\"Get random book paragraph error:\", error);\n      res.status(500).json({ \n        message: \"Failed to fetch random book paragraph\",\n        code: \"SERVER_ERROR\"\n      });\n    }\n  });\n\n  app.get(\"/api/book-paragraphs/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      \n      if (isNaN(id) || id < 1) {\n        return res.status(400).json({ \n          message: \"Invalid paragraph ID. Must be a positive integer.\",\n          code: \"INVALID_ID\"\n        });\n      }\n      \n      const paragraph = await storage.getBookParagraphById(id);\n      \n      if (!paragraph) {\n        return res.status(404).json({ \n          message: \"Book paragraph not found\",\n          code: \"NOT_FOUND\",\n          id\n        });\n      }\n      \n      res.json({ paragraph });\n    } catch (error: any) {\n      console.error(\"Get book paragraph by ID error:\", error);\n      res.status(500).json({ \n        message: \"Failed to fetch book paragraph\",\n        code: \"SERVER_ERROR\"\n      });\n    }\n  });\n\n  app.get(\"/api/book-paragraphs/next/:bookId/:paragraphIndex\", async (req, res) => {\n    try {\n      const bookId = parseInt(req.params.bookId);\n      const paragraphIndex = parseInt(req.params.paragraphIndex);\n      \n      if (isNaN(bookId) || bookId < 1) {\n        return res.status(400).json({ \n          message: \"Invalid book ID. Must be a positive integer.\",\n          code: \"INVALID_BOOK_ID\"\n        });\n      }\n      \n      if (isNaN(paragraphIndex) || paragraphIndex < 0) {\n        return res.status(400).json({ \n          message: \"Invalid paragraph index. Must be a non-negative integer.\",\n          code: \"INVALID_PARAGRAPH_INDEX\"\n        });\n      }\n      \n      const nextParagraph = await storage.getNextBookParagraph(bookId, paragraphIndex);\n      \n      if (!nextParagraph) {\n        return res.status(404).json({ \n          message: \"No more paragraphs available in this book\",\n          code: \"END_OF_BOOK\",\n          bookId,\n          lastIndex: paragraphIndex\n        });\n      }\n      \n      res.json(nextParagraph);\n    } catch (error: any) {\n      console.error(\"Get next book paragraph error:\", error);\n      res.status(500).json({ \n        message: \"Failed to fetch next book paragraph\",\n        code: \"SERVER_ERROR\"\n      });\n    }\n  });\n\n  app.get(\"/api/book-topics\", async (req, res) => {\n    try {\n      const topics = await storage.getBookTopics();\n      \n      res.set('Cache-Control', 'public, max-age=300');\n      res.json({ topics });\n    } catch (error: any) {\n      console.error(\"Get book topics error:\", error);\n      res.status(500).json({ \n        message: \"Failed to fetch book topics\",\n        code: \"SERVER_ERROR\"\n      });\n    }\n  });\n\n  app.get(\"/api/books\", async (req, res) => {\n    try {\n      const books = await storage.getAllBooks();\n      \n      res.set('Cache-Control', 'public, max-age=60');\n      res.json(books);\n    } catch (error: any) {\n      console.error(\"Get all books error:\", error);\n      res.status(500).json({ \n        message: \"Failed to fetch books\",\n        code: \"SERVER_ERROR\"\n      });\n    }\n  });\n\n  app.get(\"/api/books/:slug\", async (req, res) => {\n    try {\n      const { slug } = req.params;\n      \n      if (!slug || slug.length < 1 || slug.length > 200) {\n        return res.status(400).json({ \n          message: \"Invalid book slug\",\n          code: \"INVALID_SLUG\"\n        });\n      }\n      \n      const book = await storage.getBookBySlug(slug);\n      \n      if (!book) {\n        return res.status(404).json({ \n          message: \"Book not found\",\n          code: \"NOT_FOUND\",\n          slug\n        });\n      }\n      \n      res.set('Cache-Control', 'public, max-age=300');\n      res.json(book);\n    } catch (error: any) {\n      console.error(\"Get book by slug error:\", error);\n      res.status(500).json({ \n        message: \"Failed to fetch book\",\n        code: \"SERVER_ERROR\"\n      });\n    }\n  });\n\n  app.get(\"/api/books/:bookId/chapters\", async (req, res) => {\n    try {\n      const bookId = parseInt(req.params.bookId);\n      \n      if (isNaN(bookId) || bookId < 1) {\n        return res.status(400).json({ \n          message: \"Invalid book ID. Must be a positive integer.\",\n          code: \"INVALID_BOOK_ID\"\n        });\n      }\n      \n      const chapters = await storage.getBookChapters(bookId);\n      \n      if (chapters.length === 0) {\n        const bookExists = await storage.getBookById(bookId);\n        if (!bookExists) {\n          return res.status(404).json({ \n            message: \"Book not found\",\n            code: \"BOOK_NOT_FOUND\",\n            bookId\n          });\n        }\n      }\n      \n      res.set('Cache-Control', 'public, max-age=300');\n      res.json(chapters);\n    } catch (error: any) {\n      console.error(\"Get book chapters error:\", error);\n      res.status(500).json({ \n        message: \"Failed to fetch chapters\",\n        code: \"SERVER_ERROR\"\n      });\n    }\n  });\n\n  app.get(\"/api/books/:bookId/chapters/:chapter\", async (req, res) => {\n    try {\n      const bookId = parseInt(req.params.bookId);\n      const chapter = parseInt(req.params.chapter);\n      \n      if (isNaN(bookId) || bookId < 1) {\n        return res.status(400).json({ \n          message: \"Invalid book ID. Must be a positive integer.\",\n          code: \"INVALID_BOOK_ID\"\n        });\n      }\n      \n      if (isNaN(chapter) || chapter < 1) {\n        return res.status(400).json({ \n          message: \"Invalid chapter number. Must be a positive integer.\",\n          code: \"INVALID_CHAPTER\"\n        });\n      }\n      \n      const paragraphs = await storage.getChapterParagraphs(bookId, chapter);\n      \n      if (paragraphs.length === 0) {\n        const bookExists = await storage.getBookById(bookId);\n        if (!bookExists) {\n          return res.status(404).json({ \n            message: \"Book not found\",\n            code: \"BOOK_NOT_FOUND\",\n            bookId\n          });\n        }\n        return res.status(404).json({ \n          message: \"Chapter not found\",\n          code: \"CHAPTER_NOT_FOUND\",\n          bookId,\n          chapter\n        });\n      }\n      \n      res.set('Cache-Control', 'public, max-age=300');\n      res.json(paragraphs);\n    } catch (error: any) {\n      console.error(\"Get chapter paragraphs error:\", error);\n      res.status(500).json({ \n        message: \"Failed to fetch chapter paragraphs\",\n        code: \"SERVER_ERROR\"\n      });\n    }\n  });\n\n  app.post(\"/api/book-tests\", isAuthenticated, async (req, res) => {\n    try {\n      const parsed = insertBookTypingTestSchema.safeParse({\n        ...req.body,\n        userId: req.user!.id,\n      });\n\n      if (!parsed.success) {\n        return res.status(400).json({\n          message: \"Validation failed\",\n          code: \"VALIDATION_ERROR\",\n          errors: fromError(parsed.error).toString(),\n        });\n      }\n\n      if (parsed.data.wpm < 0 || parsed.data.wpm > 500) {\n        return res.status(400).json({\n          message: \"Invalid WPM value. Must be between 0 and 500.\",\n          code: \"INVALID_WPM\"\n        });\n      }\n      \n      if (parsed.data.accuracy < 0 || parsed.data.accuracy > 100) {\n        return res.status(400).json({\n          message: \"Invalid accuracy value. Must be between 0 and 100.\",\n          code: \"INVALID_ACCURACY\"\n        });\n      }\n\n      const result = await storage.createBookTestResult(parsed.data);\n      res.status(201).json({ \n        message: \"Book test result saved\", \n        result \n      });\n    } catch (error: any) {\n      console.error(\"Save book test result error:\", error);\n      \n      if (error.code === '23503') {\n        return res.status(400).json({ \n          message: \"Invalid paragraph ID\",\n          code: \"INVALID_PARAGRAPH_ID\"\n        });\n      }\n      \n      res.status(500).json({ \n        message: \"Failed to save book test result\",\n        code: \"SERVER_ERROR\"\n      });\n    }\n  });\n\n  app.get(\"/api/book-tests\", isAuthenticated, async (req, res) => {\n    try {\n      const limit = req.query.limit ? parseInt(req.query.limit as string) : 20;\n      \n      if (limit < 1 || limit > 100) {\n        return res.status(400).json({ \n          message: \"Limit must be between 1 and 100\",\n          code: \"INVALID_LIMIT\"\n        });\n      }\n      \n      const results = await storage.getBookTestResults(req.user!.id, limit);\n      res.json({ results });\n    } catch (error: any) {\n      console.error(\"Get book test results error:\", error);\n      res.status(500).json({ \n        message: \"Failed to fetch book test results\",\n        code: \"SERVER_ERROR\"\n      });\n    }\n  });\n\n  app.get(\"/api/dictation/sentence\", async (req, res) => {\n    try {\n      const difficulty = req.query.difficulty as string | undefined;\n      const category = req.query.category as string | undefined;\n      const excludeIdsParam = req.query.excludeIds as string | undefined;\n      \n      let excludeIds: number[] | undefined;\n      if (excludeIdsParam) {\n        excludeIds = excludeIdsParam.split(',').map(id => parseInt(id, 10)).filter(id => !isNaN(id));\n      }\n      \n      const sentence = await storage.getRandomDictationSentence(difficulty, category, excludeIds);\n      \n      if (!sentence) {\n        return res.status(404).json({ message: \"No sentences available\" });\n      }\n      \n      res.json({ sentence });\n    } catch (error: any) {\n      console.error(\"Get dictation sentence error:\", error);\n      res.status(500).json({ message: \"Failed to fetch dictation sentence\" });\n    }\n  });\n\n  app.post(\"/api/dictation/test\", isAuthenticated, async (req, res) => {\n    try {\n      const parsed = insertDictationTestSchema.safeParse({\n        ...req.body,\n        userId: req.user!.id,\n      });\n\n      if (!parsed.success) {\n        return res.status(400).json({\n          message: \"Validation failed\",\n          errors: fromError(parsed.error).toString(),\n        });\n      }\n\n      const result = await storage.createDictationTest(parsed.data);\n      res.status(201).json({ message: \"Dictation test saved\", result });\n    } catch (error: any) {\n      console.error(\"Save dictation test error:\", error);\n      res.status(500).json({ message: \"Failed to save dictation test\" });\n    }\n  });\n\n  app.get(\"/api/dictation/stats\", isAuthenticated, async (req, res) => {\n    try {\n      const stats = await storage.getUserDictationStats(req.user!.id);\n      res.json({ stats });\n    } catch (error: any) {\n      console.error(\"Get dictation stats error:\", error);\n      res.status(500).json({ message: \"Failed to fetch dictation stats\" });\n    }\n  });\n\n  app.get(\"/api/dictation/leaderboard\", leaderboardLimiter, async (req, res) => {\n    try {\n      const limit = Math.min(Math.max(1, parseInt(req.query.limit as string) || 20), 100);\n      const offset = Math.max(0, parseInt(req.query.offset as string) || 0);\n      const cursor = req.query.cursor as string | undefined;\n      \n      const actualOffset = cursor ? leaderboardCache.decodeCursor(cursor) : offset;\n      \n      const result = await leaderboardCache.getDictationLeaderboard({\n        limit,\n        offset: actualOffset,\n      });\n      \n      res.set('Cache-Control', 'public, max-age=30');\n      res.set('X-Cache', result.metadata.cacheHit ? 'HIT' : 'MISS');\n      res.set('X-Total-Count', String(result.pagination.total));\n      \n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Get dictation leaderboard error:\", error);\n      res.status(500).json({ message: \"Failed to fetch dictation leaderboard\" });\n    }\n  });\n\n  app.get(\"/api/dictation/leaderboard/around-me\", isAuthenticated, leaderboardAroundMeLimiter, async (req, res) => {\n    try {\n      const range = Math.min(Math.max(1, parseInt(req.query.range as string) || 5), 20);\n      \n      const result = await leaderboardCache.getAroundMe(\"dictation\", req.user!.id, { range });\n      \n      res.set('Cache-Control', 'private, max-age=10');\n      res.set('X-Cache', result.cacheHit ? 'HIT' : 'MISS');\n      \n      res.json({\n        userRank: result.userRank,\n        entries: result.entries,\n      });\n    } catch (error: any) {\n      console.error(\"Get dictation leaderboard around me error:\", error);\n      res.status(500).json({ message: \"Failed to fetch leaderboard\" });\n    }\n  });\n\n  app.post(\"/api/dictation/tts\", async (req, res) => {\n    try {\n      const { text, voice = \"alloy\", speed = 1.0 } = req.body;\n      \n      if (!text || typeof text !== \"string\" || text.trim().length === 0) {\n        return res.status(400).json({ message: \"Text is required\" });\n      }\n      \n      if (text.length > 1000) {\n        return res.status(400).json({ message: \"Text too long (max 1000 characters)\" });\n      }\n      \n      const apiKey = process.env.OPENAI_TTS_API_KEY;\n      if (!apiKey) {\n        return res.status(503).json({ \n          message: \"TTS not available\", \n          fallback: true \n        });\n      }\n      \n      const validVoices = [\"alloy\", \"echo\", \"fable\", \"onyx\", \"nova\", \"shimmer\"];\n      const selectedVoice = validVoices.includes(voice) ? voice : \"alloy\";\n      const selectedSpeed = Math.max(0.25, Math.min(4.0, speed));\n      \n      const response = await fetch(\"https://api.openai.com/v1/audio/speech\", {\n        method: \"POST\",\n        headers: {\n          \"Authorization\": `Bearer ${apiKey}`,\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          model: \"tts-1\",\n          input: text,\n          voice: selectedVoice,\n          speed: selectedSpeed,\n          response_format: \"mp3\",\n        }),\n      });\n      \n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(\"OpenAI TTS error:\", response.status, errorText);\n        return res.status(503).json({ \n          message: \"TTS generation failed\", \n          fallback: true \n        });\n      }\n      \n      const audioBuffer = await response.arrayBuffer();\n      \n      res.set({\n        \"Content-Type\": \"audio/mpeg\",\n        \"Content-Length\": audioBuffer.byteLength.toString(),\n        \"Cache-Control\": \"public, max-age=3600\",\n      });\n      \n      res.send(Buffer.from(audioBuffer));\n    } catch (error: any) {\n      console.error(\"TTS error:\", error);\n      res.status(503).json({ \n        message: \"TTS service error\", \n        fallback: true \n      });\n    }\n  });\n\n  // Rate limiter for stress test submissions (prevent rapid-fire submissions)\n  const stressTestSubmitLimiter = rateLimit({\n    windowMs: 30 * 1000, // 30 second window\n    max: 5, // Max 5 submissions per 30 seconds per user\n    message: { message: \"Too many stress test submissions. Please wait before submitting again.\" },\n    keyGenerator: (req) => {\n      if (req.user?.id) return req.user.id;\n      return 'anonymous';\n    },\n    standardHeaders: true,\n    legacyHeaders: false,\n    validate: false,\n  });\n\n  // Stress Test Routes with anti-cheat validation\n  app.post(\"/api/stress-test\", isAuthenticated, stressTestSubmitLimiter, async (req, res) => {\n    try {\n      const { insertStressTestSchema } = await import(\"@shared/schema\");\n      const { validateStressTestSubmission, logSuspiciousSubmission } = await import(\"./stress-test-anticheat\");\n      \n      const parsed = insertStressTestSchema.safeParse({\n        ...req.body,\n        userId: req.user!.id,\n      });\n\n      if (!parsed.success) {\n        return res.status(400).json({\n          message: \"Validation failed\",\n          errors: fromError(parsed.error).toString(),\n        });\n      }\n\n      // Anti-cheat validation: Check for impossible scores and suspicious patterns\n      const antiCheatResult = await validateStressTestSubmission({\n        userId: req.user!.id,\n        difficulty: parsed.data.difficulty,\n        wpm: parsed.data.wpm,\n        accuracy: parsed.data.accuracy,\n        stressScore: parsed.data.stressScore,\n        completionRate: parsed.data.completionRate,\n        duration: parsed.data.duration,\n        survivalTime: parsed.data.survivalTime,\n        totalCharacters: parsed.data.totalCharacters,\n        errors: parsed.data.errors,\n        maxCombo: parsed.data.maxCombo,\n      });\n\n      // Log any suspicious submissions for monitoring\n      logSuspiciousSubmission(req.user!.id, parsed.data, antiCheatResult);\n\n      // Reject invalid submissions (impossible scores)\n      if (!antiCheatResult.isValid) {\n        console.warn(`[ANTI-CHEAT] Rejected invalid stress test from user ${req.user!.id}:`, antiCheatResult.errors);\n        return res.status(400).json({\n          message: \"Score validation failed\",\n          errors: antiCheatResult.errors.join(\"; \"),\n        });\n      }\n\n      // Production-ready: Use upsert pattern to update if new score is higher\n      // This prevents duplicate entries while maintaining the best score per difficulty\n      const { result, isNewPersonalBest } = await storage.upsertStressTestBestScore(parsed.data);\n      \n      // Check if this score makes it to the leaderboard (top 50)\n      const leaderboard = await storage.getStressTestLeaderboard(parsed.data.difficulty, 50);\n      const isLeaderboardEntry = leaderboard.length < 50 || \n        parsed.data.stressScore > (leaderboard[leaderboard.length - 1]?.stressScore || 0);\n      \n      res.status(201).json({ \n        message: isNewPersonalBest ? \"New personal best saved!\" : \"Score recorded\", \n        result,\n        isNewPersonalBest,\n        isLeaderboardEntry,\n        // Include anti-cheat flags in response (for admin debugging)\n        ...(antiCheatResult.flags.length > 0 && { _flags: antiCheatResult.flags }),\n      });\n    } catch (error: any) {\n      console.error(\"Save stress test error:\", error);\n      res.status(500).json({ message: \"Failed to save stress test result\" });\n    }\n  });\n\n  app.get(\"/api/stress-test/leaderboard\", leaderboardLimiter, async (req, res) => {\n    try {\n      const rawDifficulty = req.query.difficulty as string | undefined;\n      const validDifficulties = [\"beginner\", \"intermediate\", \"expert\", \"nightmare\", \"impossible\"];\n      const difficulty = rawDifficulty && validDifficulties.includes(rawDifficulty) ? rawDifficulty : undefined;\n      const limit = Math.min(Math.max(1, parseInt(req.query.limit as string) || 50), 100);\n      const offset = Math.max(0, parseInt(req.query.offset as string) || 0);\n      const cursor = req.query.cursor as string | undefined;\n      \n      const actualOffset = cursor ? leaderboardCache.decodeCursor(cursor) : offset;\n      \n      const result = await leaderboardCache.getStressLeaderboard({\n        difficulty,\n        limit,\n        offset: actualOffset,\n      });\n      \n      res.set('Cache-Control', 'public, max-age=5');\n      res.set('X-Cache', result.metadata.cacheHit ? 'HIT' : 'MISS');\n      res.set('X-Total-Count', String(result.pagination.total));\n      \n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Get stress test leaderboard error:\", error);\n      res.status(500).json({ message: \"Failed to fetch leaderboard\" });\n    }\n  });\n\n  app.get(\"/api/stress-test/leaderboard/around-me\", isAuthenticated, leaderboardAroundMeLimiter, async (req, res) => {\n    try {\n      const rawDifficulty = req.query.difficulty as string | undefined;\n      const validDifficulties = [\"beginner\", \"intermediate\", \"expert\", \"nightmare\", \"impossible\"];\n      const difficulty = rawDifficulty && validDifficulties.includes(rawDifficulty) ? rawDifficulty : undefined;\n      const range = Math.min(Math.max(1, parseInt(req.query.range as string) || 5), 20);\n      \n      const result = await leaderboardCache.getAroundMe(\"stress\", req.user!.id, { difficulty, range });\n      \n      res.set('Cache-Control', 'private, max-age=10');\n      res.set('X-Cache', result.cacheHit ? 'HIT' : 'MISS');\n      \n      res.json({\n        userRank: result.userRank,\n        entries: result.entries,\n      });\n    } catch (error: any) {\n      console.error(\"Get stress leaderboard around me error:\", error);\n      res.status(500).json({ message: \"Failed to fetch leaderboard\" });\n    }\n  });\n\n  app.get(\"/api/stress-test/stats\", isAuthenticated, async (req, res) => {\n    try {\n      const stats = await storage.getUserStressStats(req.user!.id);\n      res.json({ stats });\n    } catch (error: any) {\n      console.error(\"Get stress test stats error:\", error);\n      res.status(500).json({ message: \"Failed to fetch stats\" });\n    }\n  });\n\n  // Social Sharing Routes\n  app.post(\"/api/share\", async (req, res) => {\n    try {\n      const { insertSharedResultSchema } = await import(\"@shared/schema\");\n      const { mode, resultId, isAnonymous } = req.body;\n\n      // Validate input\n      if (!mode || !resultId) {\n        return res.status(400).json({ message: \"Mode and resultId are required\" });\n      }\n\n      let statsData;\n      let username = req.user?.username || null;\n\n      // Fetch verified stats from database based on mode\n      switch (mode) {\n        case 'dictation':\n          const dictationTest = await storage.getDictationTestById(resultId);\n          if (!dictationTest) {\n            return res.status(404).json({ message: \"Test result not found\" });\n          }\n          if (!req.user || dictationTest.userId !== req.user.id) {\n            return res.status(403).json({ message: \"Unauthorized\" });\n          }\n          \n          statsData = {\n            wpm: dictationTest.wpm,\n            accuracy: dictationTest.accuracy,\n            errors: dictationTest.errors,\n            duration: dictationTest.duration,\n            characters: dictationTest.actualSentence.length,\n            metadata: {\n              speedLevel: dictationTest.speedLevel,\n              difficulty: 'medium', // Default difficulty\n              replayCount: dictationTest.replayCount,\n              hintUsed: dictationTest.hintUsed,\n            }\n          };\n          break;\n\n        case 'normal':\n        case 'timed':\n        case 'practice':\n        case 'challenge':\n        case 'typing':\n          const testResult = await storage.getTestResultById(resultId);\n          if (!testResult) {\n            return res.status(404).json({ message: \"Test result not found\" });\n          }\n          if (!req.user || testResult.userId !== req.user.id) {\n            return res.status(403).json({ message: \"Unauthorized\" });\n          }\n          \n          // Map integer mode to string (best-effort)\n          const modeMap: Record<number, string> = {\n            0: 'normal',\n            1: 'timed',\n            2: 'practice',\n            3: 'challenge',\n          };\n          \n          const storedMode = modeMap[testResult.mode] || 'typing';\n          \n          statsData = {\n            wpm: testResult.wpm,\n            accuracy: testResult.accuracy,\n            errors: testResult.errors,\n            duration: 60, // Standard test duration fallback\n            characters: testResult.characters,\n            metadata: {\n              mode: storedMode,\n              testType: 'typing'\n            }\n          };\n          break;\n\n        // TODO: Add support for code, book, and multiplayer modes\n        case 'code':\n        case 'book':\n        case 'multiplayer':\n          return res.status(501).json({ \n            message: `Sharing for ${mode} mode is not yet implemented. Currently supported: dictation, normal, timed, practice, challenge` \n          });\n\n        default:\n          return res.status(400).json({ message: `Unsupported mode: ${mode}` });\n      }\n\n      // Validate stats are plausible\n      if (statsData.wpm < 0 || statsData.wpm > 300 ||\n          statsData.accuracy < 0 || statsData.accuracy > 100 ||\n          statsData.errors < 0 ||\n          (statsData.duration && statsData.duration < 0)) {\n        return res.status(400).json({ message: \"Invalid stats detected\" });\n      }\n\n      // Generate unique share token (12 chars)\n      const shareToken = Math.random().toString(36).substring(2, 14);\n      \n      const shareData = {\n        shareToken,\n        userId: req.user?.id || null,\n        username: isAnonymous ? null : username,\n        mode,\n        ...statsData,\n        isAnonymous: isAnonymous || false,\n      };\n\n      const parsed = insertSharedResultSchema.safeParse(shareData);\n      if (!parsed.success) {\n        return res.status(400).json({\n          message: \"Validation failed\",\n          errors: fromError(parsed.error).toString(),\n        });\n      }\n\n      const sharedResult = await storage.createSharedResult(parsed.data);\n      res.status(201).json({ \n        message: \"Result shared successfully\",\n        shareToken: sharedResult.shareToken,\n        shareUrl: `${req.protocol}://${req.get('host')}/result/${sharedResult.shareToken}`\n      });\n    } catch (error: any) {\n      console.error(\"Create shared result error:\", error);\n      res.status(500).json({ message: \"Failed to create shared result\" });\n    }\n  });\n\n  app.get(\"/api/share/:shareToken\", async (req, res) => {\n    try {\n      const { shareToken } = req.params;\n      \n      const sharedResult = await storage.getSharedResult(shareToken);\n      if (!sharedResult) {\n        return res.status(404).json({ message: \"Shared result not found\" });\n      }\n\n      // Increment view count\n      await storage.incrementShareViewCount(shareToken);\n\n      res.json({ result: sharedResult });\n    } catch (error: any) {\n      console.error(\"Get shared result error:\", error);\n      res.status(500).json({ message: \"Failed to fetch shared result\" });\n    }\n  });\n\n  // Keystroke Analytics Routes\n  app.post(\"/api/analytics/save\", async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ message: \"Must be logged in to save analytics\" });\n    }\n\n    try {\n      const { keystrokeEvents, analytics } = req.body;\n\n      // Save keystroke events if provided\n      if (keystrokeEvents && Array.isArray(keystrokeEvents)) {\n        await storage.saveKeystrokeEvents(keystrokeEvents);\n      }\n\n      // Save analytics summary\n      if (analytics) {\n        const analyticsData = {\n          ...analytics,\n          userId: req.user.id,\n        };\n        // Debug log to see what's being saved\n        console.log('[Analytics Save] burstWpm:', analytics.burstWpm, 'adjustedWpm:', analytics.adjustedWpm, 'typingRhythm:', analytics.typingRhythm);\n        const savedAnalytics = await storage.saveTypingAnalytics(analyticsData);\n        console.log('[Analytics Save] Saved ID:', savedAnalytics.id, 'burstWpm in DB:', savedAnalytics.burstWpm);\n        return res.json({ \n          message: \"Analytics saved successfully\",\n          analyticsId: savedAnalytics.id\n        });\n      }\n\n      res.json({ message: \"Data saved successfully\" });\n    } catch (error: any) {\n      console.error(\"Save analytics error:\", error);\n      res.status(500).json({ message: \"Failed to save analytics\" });\n    }\n  });\n\n  app.get(\"/api/analytics/user\", async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ message: \"Must be logged in\" });\n    }\n\n    try {\n      const limit = parseInt(req.query.limit as string) || 20;\n      const analytics = await storage.getUserTypingAnalytics(req.user.id, limit);\n      res.json({ analytics });\n    } catch (error: any) {\n      console.error(\"Get analytics error:\", error);\n      res.status(500).json({ message: \"Failed to fetch analytics\" });\n    }\n  });\n\n  app.get(\"/api/analytics/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const analytics = await storage.getTypingAnalyticsById(id);\n      \n      if (!analytics) {\n        return res.status(404).json({ message: \"Analytics not found\" });\n      }\n\n      res.json({ analytics });\n    } catch (error: any) {\n      console.error(\"Get analytics by ID error:\", error);\n      res.status(500).json({ message: \"Failed to fetch analytics\" });\n    }\n  });\n\n  app.get(\"/api/insights/user\", async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ message: \"Must be logged in\" });\n    }\n\n    try {\n      const insights = await storage.getUserTypingInsights(req.user.id);\n      res.json({ insights });\n    } catch (error: any) {\n      console.error(\"Get insights error:\", error);\n      res.status(500).json({ message: \"Failed to fetch insights\" });\n    }\n  });\n\n  app.post(\"/api/insights/:id/dismiss\", async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ message: \"Must be logged in\" });\n    }\n\n    try {\n      const id = parseInt(req.params.id);\n      await storage.dismissInsight(id);\n      res.json({ message: \"Insight dismissed\" });\n    } catch (error: any) {\n      console.error(\"Dismiss insight error:\", error);\n      res.status(500).json({ message: \"Failed to dismiss insight\" });\n    }\n  });\n\n  app.get(\"/api/practice/recommendations\", async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ message: \"Must be logged in\" });\n    }\n\n    try {\n      const recommendations = await storage.getUserPracticeRecommendations(req.user.id);\n      res.json({ recommendations });\n    } catch (error: any) {\n      console.error(\"Get recommendations error:\", error);\n      res.status(500).json({ message: \"Failed to fetch recommendations\" });\n    }\n  });\n\n  app.post(\"/api/practice/:id/complete\", async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ message: \"Must be logged in\" });\n    }\n\n    try {\n      const id = parseInt(req.params.id);\n      await storage.completePracticeRecommendation(id);\n      res.json({ message: \"Practice recommendation completed\" });\n    } catch (error: any) {\n      console.error(\"Complete recommendation error:\", error);\n      res.status(500).json({ message: \"Failed to complete recommendation\" });\n    }\n  });\n\n  // ============================================================================\n  // ENTERPRISE FEEDBACK SYSTEM ROUTES\n  // ============================================================================\n\n  const feedbackLimiter = rateLimit({\n    windowMs: 15 * 60 * 1000,\n    max: 5,\n    message: { message: \"Too many feedback submissions, please try again later\" },\n    standardHeaders: true,\n    legacyHeaders: false,\n  });\n\n  async function isFeedbackAdmin(req: any, res: any, next: any) {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"Unauthorized\" });\n    }\n    \n    const admin = await storage.getFeedbackAdmin(req.user.id);\n    if (!admin) {\n      return res.status(403).json({ message: \"Access denied. Admin privileges required.\" });\n    }\n    \n    req.feedbackAdmin = admin;\n    next();\n  }\n\n  app.get(\"/api/feedback/categories\", async (_req, res) => {\n    try {\n      const categories = await storage.getFeedbackCategories();\n      res.json({ categories });\n    } catch (error: any) {\n      console.error(\"Get feedback categories error:\", error);\n      res.status(500).json({ message: \"Failed to fetch feedback categories\" });\n    }\n  });\n\n  app.post(\"/api/feedback\", feedbackLimiter, async (req, res) => {\n    try {\n      const parsed = submitFeedbackSchema.safeParse(req.body);\n      \n      if (!parsed.success) {\n        return res.status(400).json({\n          message: \"Validation failed\",\n          errors: fromError(parsed.error).toString(),\n        });\n      }\n\n      const { honeypot, ...feedbackData } = parsed.data;\n      \n      if (honeypot && honeypot.length > 0) {\n        console.log(\"[Feedback] Honeypot triggered, marking as spam\");\n        return res.status(201).json({ \n          message: \"Thank you for your feedback!\",\n          feedbackId: 0,\n        });\n      }\n\n      const ipAddress = (req.headers['x-forwarded-for'] as string)?.split(',')[0].trim() || \n                       req.socket.remoteAddress || \n                       'unknown';\n      \n      const identifier = req.user ? req.user.id : ipAddress;\n      const identifierType = req.user ? 'user' : 'ip';\n      \n      const rateCheck = await storage.checkFeedbackRateLimit(identifier, identifierType);\n      if (!rateCheck.allowed) {\n        if (rateCheck.blockedUntil) {\n          return res.status(429).json({ \n            message: \"You have been temporarily blocked from submitting feedback.\",\n            blockedUntil: rateCheck.blockedUntil,\n          });\n        }\n        return res.status(429).json({ \n          message: \"Too many feedback submissions. Please try again later.\",\n          remaining: rateCheck.remaining,\n          resetAt: rateCheck.resetAt,\n        });\n      }\n\n      const sanitizedSubject = DOMPurify.sanitize(feedbackData.subject.trim());\n      const sanitizedMessage = DOMPurify.sanitize(feedbackData.message.trim());\n\n      const feedbackToCreate = {\n        userId: req.user && !feedbackData.isAnonymous ? req.user.id : null,\n        isAnonymous: feedbackData.isAnonymous,\n        contactEmail: feedbackData.contactEmail || null,\n        categoryId: feedbackData.categoryId || null,\n        subject: sanitizedSubject,\n        message: sanitizedMessage,\n        priority: feedbackData.priority || 'medium',\n        status: 'new' as const,\n        source: 'in_app' as const,\n        pageUrl: feedbackData.pageUrl || null,\n        browserInfo: {\n          userAgent: req.headers['user-agent'],\n          referer: req.headers['referer'],\n        },\n        ipAddress,\n        isSpam: false,\n        isArchived: false,\n        upvotes: 0,\n        userNotified: false,\n      };\n\n      const newFeedback = await storage.createFeedback(feedbackToCreate);\n      \n      await storage.recordFeedbackSubmission(identifier, identifierType);\n      \n      await storage.recordFeedbackStatusHistory({\n        feedbackId: newFeedback.id,\n        previousStatus: null,\n        newStatus: 'new',\n        previousPriority: null,\n        newPriority: feedbackData.priority || 'medium',\n        changedByUserId: req.user ? req.user.id : null,\n        changeReason: 'Initial submission',\n        isAutomated: false,\n      });\n\n      processFeedbackInBackground(\n        newFeedback.id,\n        {\n          id: newFeedback.id,\n          subject: sanitizedSubject,\n          message: sanitizedMessage,\n          priority: feedbackData.priority || 'medium',\n          categoryId: feedbackData.categoryId || null,\n        },\n        storage\n      );\n\n      res.status(201).json({ \n        message: \"Thank you for your feedback!\",\n        feedbackId: newFeedback.id,\n      });\n    } catch (error: any) {\n      console.error(\"Submit feedback error:\", error);\n      res.status(500).json({ message: \"Failed to submit feedback\" });\n    }\n  });\n\n  app.get(\"/api/feedback/:id/upvote\", isAuthenticated, async (req, res) => {\n    try {\n      const feedbackId = parseInt(req.params.id);\n      if (isNaN(feedbackId)) {\n        return res.status(400).json({ message: \"Invalid feedback ID\" });\n      }\n\n      const userUpvotes = await storage.getUserFeedbackUpvotes(req.user!.id);\n      const hasUpvoted = userUpvotes.some(u => u.feedbackId === feedbackId);\n      \n      res.json({ upvoted: hasUpvoted });\n    } catch (error: any) {\n      console.error(\"Get upvote status error:\", error);\n      res.status(500).json({ message: \"Failed to get upvote status\" });\n    }\n  });\n\n  app.post(\"/api/feedback/:id/upvote\", isAuthenticated, async (req, res) => {\n    try {\n      const feedbackId = parseInt(req.params.id);\n      if (isNaN(feedbackId)) {\n        return res.status(400).json({ message: \"Invalid feedback ID\" });\n      }\n\n      const feedback = await storage.getFeedbackById(feedbackId);\n      if (!feedback) {\n        return res.status(404).json({ message: \"Feedback not found\" });\n      }\n\n      const result = await storage.toggleFeedbackUpvote(feedbackId, req.user!.id);\n      \n      res.json(result);\n    } catch (error: any) {\n      console.error(\"Toggle upvote error:\", error);\n      res.status(500).json({ message: \"Failed to toggle upvote\" });\n    }\n  });\n\n  app.get(\"/api/admin/feedback\", isFeedbackAdmin, async (req, res) => {\n    try {\n      const page = Math.max(parseInt(req.query.page as string) || 1, 1);\n      const limit = Math.min(parseInt(req.query.limit as string) || 20, 100);\n      const offset = (page - 1) * limit;\n      const status = req.query.status as string | undefined;\n      const priority = req.query.priority as string | undefined;\n      const categoryId = req.query.categoryId ? parseInt(req.query.categoryId as string) : undefined;\n      const sentimentLabel = req.query.sentimentLabel as string | undefined;\n      const isSpam = req.query.isSpam === 'true' ? true : req.query.isSpam === 'false' ? false : undefined;\n      const isArchived = req.query.isArchived === 'true' ? true : req.query.isArchived === 'false' ? false : undefined;\n      const search = req.query.search as string | undefined;\n      const sortBy = req.query.sortBy as string | undefined;\n      const sortOrder = (req.query.sortOrder as 'asc' | 'desc') || 'desc';\n\n      const result = await storage.getFeedbackPaginated({\n        limit,\n        offset,\n        status,\n        priority,\n        categoryId,\n        sentimentLabel,\n        isSpam,\n        isArchived,\n        search,\n        sortBy,\n        sortOrder,\n      });\n\n      const totalPages = Math.ceil(result.total / limit);\n\n      res.json({\n        feedback: result.feedback,\n        pagination: {\n          page,\n          limit,\n          total: result.total,\n          totalPages,\n        },\n      });\n    } catch (error: any) {\n      console.error(\"Get feedback list error:\", error);\n      res.status(500).json({ message: \"Failed to fetch feedback\" });\n    }\n  });\n\n  app.get(\"/api/admin/feedback/analytics\", isFeedbackAdmin, async (req, res) => {\n    try {\n      const analytics = await storage.getFeedbackAnalyticsSummary();\n      res.json({ analytics });\n    } catch (error: any) {\n      console.error(\"Get feedback analytics error:\", error);\n      res.status(500).json({ message: \"Failed to fetch feedback analytics\" });\n    }\n  });\n\n  app.get(\"/api/admin/feedback/:id\", isFeedbackAdmin, async (req, res) => {\n    try {\n      const feedbackId = parseInt(req.params.id);\n      if (isNaN(feedbackId)) {\n        return res.status(400).json({ message: \"Invalid feedback ID\" });\n      }\n\n      const feedback = await storage.getFeedbackById(feedbackId);\n      if (!feedback) {\n        return res.status(404).json({ message: \"Feedback not found\" });\n      }\n\n      const [responses, statusHistory, attachments, category] = await Promise.all([\n        storage.getFeedbackResponses(feedbackId),\n        storage.getFeedbackStatusHistory(feedbackId),\n        storage.getFeedbackAttachments(feedbackId),\n        feedback.categoryId ? storage.getFeedbackCategoryById(feedback.categoryId) : Promise.resolve(null),\n      ]);\n\n      res.json({\n        feedback,\n        responses,\n        statusHistory,\n        attachments,\n        category,\n      });\n    } catch (error: any) {\n      console.error(\"Get feedback detail error:\", error);\n      res.status(500).json({ message: \"Failed to fetch feedback detail\" });\n    }\n  });\n\n  app.patch(\"/api/admin/feedback/:id/status\", isFeedbackAdmin, async (req, res) => {\n    try {\n      const feedbackId = parseInt(req.params.id);\n      if (isNaN(feedbackId)) {\n        return res.status(400).json({ message: \"Invalid feedback ID\" });\n      }\n\n      const parsed = updateFeedbackStatusSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({\n          message: \"Validation failed\",\n          errors: fromError(parsed.error).toString(),\n        });\n      }\n\n      const feedback = await storage.getFeedbackById(feedbackId);\n      if (!feedback) {\n        return res.status(404).json({ message: \"Feedback not found\" });\n      }\n\n      const admin = (req as any).feedbackAdmin;\n      if (!admin.canChangeStatus) {\n        return res.status(403).json({ message: \"You don't have permission to change status\" });\n      }\n      if (parsed.data.priority && !admin.canChangePriority) {\n        return res.status(403).json({ message: \"You don't have permission to change priority\" });\n      }\n\n      const updates: any = {\n        status: parsed.data.status,\n        updatedAt: new Date(),\n      };\n\n      if (parsed.data.priority) {\n        updates.priority = parsed.data.priority;\n      }\n\n      if (parsed.data.status === 'resolved' || parsed.data.status === 'closed') {\n        updates.resolvedAt = new Date();\n        updates.resolvedByUserId = req.user!.id;\n        if (parsed.data.resolutionNotes) {\n          updates.resolutionNotes = DOMPurify.sanitize(parsed.data.resolutionNotes);\n        }\n      }\n\n      const updatedFeedback = await storage.updateFeedback(feedbackId, updates);\n\n      await storage.recordFeedbackStatusHistory({\n        feedbackId,\n        previousStatus: feedback.status,\n        newStatus: parsed.data.status,\n        previousPriority: feedback.priority,\n        newPriority: parsed.data.priority || feedback.priority,\n        changedByUserId: req.user!.id,\n        changeReason: parsed.data.changeReason || null,\n        isAutomated: false,\n      });\n\n      if (parsed.data.notifyUser && !feedback.userNotified && (parsed.data.status === 'resolved' || parsed.data.status === 'closed')) {\n        (async () => {\n          try {\n            const { emailService } = require(\"./email-service\");\n            \n            let recipientEmail: string | null = null;\n            let username: string | undefined;\n\n            if (feedback.userId) {\n              const user = await storage.getUser(feedback.userId);\n              if (user) {\n                recipientEmail = user.email;\n                username = user.username;\n              }\n            } else if (feedback.contactEmail) {\n              recipientEmail = feedback.contactEmail;\n            }\n\n            if (recipientEmail) {\n              const emailResult = await emailService.sendFeedbackResolutionEmail(recipientEmail, {\n                feedbackId: feedback.id,\n                subject: feedback.subject,\n                resolutionNotes: updates.resolutionNotes || undefined,\n                username,\n                status: parsed.data.status,\n              });\n              \n              if (emailResult.success) {\n                await storage.updateFeedback(feedbackId, { userNotified: true });\n                console.log(`[Feedback] Resolution email sent to ${recipientEmail} for feedback #${feedback.id}`);\n              } else {\n                console.error(`[Feedback] Failed to send resolution email for feedback #${feedback.id}:`, emailResult.error);\n              }\n            } else {\n              console.warn(`[Feedback] Cannot send resolution email for feedback #${feedback.id}: no email available`);\n            }\n          } catch (emailError) {\n            console.error(`[Feedback] Failed to send resolution email for feedback #${feedback.id}:`, emailError);\n          }\n        })();\n      }\n\n      res.json({ \n        message: \"Feedback status updated successfully\",\n        feedback: updatedFeedback,\n      });\n    } catch (error: any) {\n      console.error(\"Update feedback status error:\", error);\n      res.status(500).json({ message: \"Failed to update feedback status\" });\n    }\n  });\n\n  app.post(\"/api/admin/feedback/:id/responses\", isFeedbackAdmin, async (req, res) => {\n    try {\n      const feedbackId = parseInt(req.params.id);\n      if (isNaN(feedbackId)) {\n        return res.status(400).json({ message: \"Invalid feedback ID\" });\n      }\n\n      const parsed = feedbackResponseSchema.safeParse(req.body);\n      if (!parsed.success) {\n        return res.status(400).json({\n          message: \"Validation failed\",\n          errors: fromError(parsed.error).toString(),\n        });\n      }\n\n      const feedback = await storage.getFeedbackById(feedbackId);\n      if (!feedback) {\n        return res.status(404).json({ message: \"Feedback not found\" });\n      }\n\n      const admin = (req as any).feedbackAdmin;\n      if (!admin.canRespond) {\n        return res.status(403).json({ message: \"You don't have permission to respond to feedback\" });\n      }\n\n      const sanitizedMessage = DOMPurify.sanitize(parsed.data.message.trim());\n\n      const response = await storage.createFeedbackResponse({\n        feedbackId,\n        adminUserId: req.user!.id,\n        message: sanitizedMessage,\n        isInternalNote: parsed.data.isInternalNote || false,\n        templateName: parsed.data.templateName || null,\n      });\n\n      if (feedback.status === 'new') {\n        await storage.updateFeedback(feedbackId, { \n          status: 'under_review',\n          updatedAt: new Date(),\n        });\n        await storage.recordFeedbackStatusHistory({\n          feedbackId,\n          previousStatus: 'new',\n          newStatus: 'under_review',\n          previousPriority: feedback.priority,\n          newPriority: feedback.priority,\n          changedByUserId: req.user!.id,\n          changeReason: 'First admin response',\n          isAutomated: true,\n        });\n      }\n\n      res.status(201).json({ \n        message: \"Response added successfully\",\n        response,\n      });\n    } catch (error: any) {\n      console.error(\"Add feedback response error:\", error);\n      res.status(500).json({ message: \"Failed to add response\" });\n    }\n  });\n\n  app.post(\"/api/admin/feedback/:id/archive\", isFeedbackAdmin, async (req, res) => {\n    try {\n      const feedbackId = parseInt(req.params.id);\n      if (isNaN(feedbackId)) {\n        return res.status(400).json({ message: \"Invalid feedback ID\" });\n      }\n\n      const feedback = await storage.getFeedbackById(feedbackId);\n      if (!feedback) {\n        return res.status(404).json({ message: \"Feedback not found\" });\n      }\n\n      await storage.archiveFeedback(feedbackId);\n\n      res.json({ message: \"Feedback archived successfully\" });\n    } catch (error: any) {\n      console.error(\"Archive feedback error:\", error);\n      res.status(500).json({ message: \"Failed to archive feedback\" });\n    }\n  });\n\n  app.post(\"/api/admin/feedback/:id/spam\", isFeedbackAdmin, async (req, res) => {\n    try {\n      const feedbackId = parseInt(req.params.id);\n      if (isNaN(feedbackId)) {\n        return res.status(400).json({ message: \"Invalid feedback ID\" });\n      }\n\n      const feedback = await storage.getFeedbackById(feedbackId);\n      if (!feedback) {\n        return res.status(404).json({ message: \"Feedback not found\" });\n      }\n\n      await storage.markFeedbackAsSpam(feedbackId);\n\n      if (feedback.ipAddress) {\n        await storage.blockFeedbackSubmitter(feedback.ipAddress, 'ip', 'Marked as spam by admin', 60 * 24);\n      }\n\n      res.json({ message: \"Feedback marked as spam\" });\n    } catch (error: any) {\n      console.error(\"Mark spam error:\", error);\n      res.status(500).json({ message: \"Failed to mark as spam\" });\n    }\n  });\n\n  // ============================================================================\n  // CERTIFICATE ROUTES\n  // ============================================================================\n\n  app.post(\"/api/certificates\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const parsed = insertCertificateSchema.safeParse(req.body);\n      \n      if (!parsed.success) {\n        return res.status(400).json({\n          message: \"Invalid certificate data\",\n          errors: fromError(parsed.error).toString(),\n        });\n      }\n\n      const certificateData = parsed.data;\n\n      // Critical: Verify ownership of referenced test result\n      if (certificateData.testResultId) {\n        const isOwner = await storage.verifyTestResultOwnership(certificateData.testResultId, userId);\n        if (!isOwner) {\n          return res.status(403).json({ message: \"Access denied: You don't own this test result\" });\n        }\n      }\n\n      if (certificateData.codeTestId) {\n        const codeTest = await storage.getCodeTypingTestById(certificateData.codeTestId);\n        if (!codeTest || codeTest.userId !== userId) {\n          return res.status(403).json({ message: \"Access denied: You don't own this code test\" });\n        }\n      }\n\n      if (certificateData.bookTestId) {\n        const bookTest = await storage.getBookTypingTestById(certificateData.bookTestId);\n        if (!bookTest || bookTest.userId !== userId) {\n          return res.status(403).json({ message: \"Access denied: You don't own this book test\" });\n        }\n      }\n\n      if (certificateData.raceId) {\n        const participation = await storage.getRaceParticipationByRaceAndUser(certificateData.raceId, userId);\n        if (!participation) {\n          return res.status(403).json({ message: \"Access denied: You didn't participate in this race\" });\n        }\n      }\n\n      if (certificateData.dictationTestId) {\n        const dictationTest = await storage.getDictationTestById(certificateData.dictationTestId);\n        if (!dictationTest || dictationTest.userId !== userId) {\n          return res.status(403).json({ message: \"Access denied: You don't own this dictation test\" });\n        }\n      }\n\n      if (certificateData.stressTestId) {\n        const stressTest = await storage.getStressTestById(certificateData.stressTestId);\n        if (!stressTest || stressTest.userId !== userId) {\n          return res.status(403).json({ message: \"Access denied: You don't own this stress test\" });\n        }\n      }\n\n      const certificate = await storage.createCertificate({\n        ...certificateData,\n        userId,\n      });\n      \n      res.json(certificate);\n    } catch (error: any) {\n      console.error(\"Create certificate error:\", error);\n      res.status(500).json({ message: \"Failed to create certificate\" });\n    }\n  });\n\n  app.get(\"/api/certificates\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const certificateType = req.query.type as string | undefined;\n      const limit = req.query.limit ? parseInt(req.query.limit as string) : undefined;\n      const offset = req.query.offset ? parseInt(req.query.offset as string) : undefined;\n      \n      const certificates = await storage.getUserCertificates(userId, certificateType, limit, offset);\n      res.json(certificates);\n    } catch (error: any) {\n      console.error(\"Get certificates error:\", error);\n      res.status(500).json({ message: \"Failed to fetch certificates\" });\n    }\n  });\n\n  app.get(\"/api/certificates/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const certificateId = parseInt(req.params.id);\n      \n      if (isNaN(certificateId)) {\n        return res.status(400).json({ message: \"Invalid certificate ID\" });\n      }\n\n      const certificate = await storage.getCertificateById(certificateId);\n      \n      if (!certificate) {\n        return res.status(404).json({ message: \"Certificate not found\" });\n      }\n\n      if (certificate.userId !== userId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      res.json(certificate);\n    } catch (error: any) {\n      console.error(\"Get certificate error:\", error);\n      res.status(500).json({ message: \"Failed to fetch certificate\" });\n    }\n  });\n\n  app.get(\"/api/share/certificate/:shareId\", async (req, res) => {\n    try {\n      const shareId = req.params.shareId;\n      \n      const certificate = await storage.getCertificateByShareId(shareId);\n      \n      if (!certificate) {\n        return res.status(404).json({ message: \"Certificate not found\" });\n      }\n\n      await storage.updateCertificateViewCount(certificate.id);\n\n      res.json(certificate);\n    } catch (error: any) {\n      console.error(\"Get shared certificate error:\", error);\n      res.status(500).json({ message: \"Failed to fetch shared certificate\" });\n    }\n  });\n\n  app.delete(\"/api/certificates/:id\", isAuthenticated, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const certificateId = parseInt(req.params.id);\n      \n      if (isNaN(certificateId)) {\n        return res.status(400).json({ message: \"Invalid certificate ID\" });\n      }\n\n      const certificate = await storage.getCertificateById(certificateId);\n      \n      if (!certificate) {\n        return res.status(404).json({ message: \"Certificate not found\" });\n      }\n\n      if (certificate.userId !== userId) {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      await storage.deleteCertificate(certificateId);\n      res.json({ message: \"Certificate deleted successfully\" });\n    } catch (error: any) {\n      console.error(\"Delete certificate error:\", error);\n      res.status(500).json({ message: \"Failed to delete certificate\" });\n    }\n  });\n\n  // Mount notification routes\n  app.use(createNotificationRoutes(storage));\n\n  const httpServer = createServer(app);\n  \n  raceWebSocket.initialize(httpServer);\n\n  // Cleanup on server shutdown\n  process.on('SIGTERM', () => {\n    console.log('SIGTERM received, stopping notification scheduler...');\n    notificationScheduler.stop();\n  });\n\n  return httpServer;\n}\n","path":null,"size_bytes":169624,"size_tokens":null},"replit.md":{"content":"# TypeMasterAI - AI-Powered Typing Test Application\n\n## Overview\nTypeMasterAI is a high-performance, full-stack typing test web application aimed at enhancing typing skills through engaging features. It provides real-time analytics, diverse test durations and languages, user authentication, and an AI chat assistant. Key capabilities include visual progress tracking, AI-powered content generation, real-time multiplayer racing with instant matchmaking and AI Ghost Racers, a production-ready Code Typing Mode with Monkeytype-style strict validation, dedicated leaderboards, advanced keystroke analytics, a smart daily notification system (PWA), and advanced SEO optimization. The project's vision is to become a leading platform for typing mastery, leveraging AI and a competitive environment to drive user engagement and expand market reach.\n\n## User Preferences\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### UI/UX Decisions\nThe frontend utilizes React 18 with TypeScript and Vite, styled with Shadcn UI (New York style), Tailwind CSS v4, and custom design tokens in a dark-first \"Focus Flow\" theme. Typography uses DM Sans and JetBrains Mono, with animations handled by Canvas Confetti and custom Tailwind animations.\n\n### Technical Implementations\n- **Frontend**: React 18, TypeScript, Vite, Shadcn UI, Tailwind CSS, TanStack Query v5 for server state, React Context API for authentication, multi-language input (23+ languages), advanced analytics dashboard with Recharts, interactive keyboard heatmaps, PWA with offline support and push notifications, and dynamic SEO with 8 landing pages. It includes a production-ready strict validation system for Standard Mode with stop-on-error enforcement, space/backspace validation, persistent error highlighting, comprehensive anti-cheat measures (selection blocking, paste prevention, drag-drop blocking, keyboard shortcut blocking), Monkeytype-style character-by-character state tracking where incorrect characters remain red until properly corrected, and industry-standard cursor implementation using content coordinates with synchronous scroll recalculation for perfect alignment during manual scrolling.\n- **Backend**: Express.js on Node.js with TypeScript, WebSocket server for real-time multiplayer, AI Ghost Racer system, Passport.js for authentication, RESTful API for various features, AI code snippet generation and chat assistance, job-based smart notification scheduler, achievement engine, and challenge system.\n- **Scalability Infrastructure**: Designed for massive concurrent user loads with features like Race Cache System, WebSocket Rate Limiter, Room Sharding, and Database Optimization.\n- **Competitive Multiplayer Features**: ELO Rating System with skill-based matchmaking, Anti-Cheat Validation, Race Replays, In-Race Chat, Spectator Mode, Match History, and Rating Leaderboard. The current multiplayer architecture requires a single Node.js instance due to in-memory state management.\n- **Private Room System**: Features Host Failover, Reconnection Support, Countdown Management, and Rate Limiting.\n- **Leaderboard System**: Leaderboard Caching Service, Cursor-Based Pagination, Time-Based Leaderboards, \"Around Me\" Rankings, and Multi-Type Support across various typing modes.\n- **Legal & Compliance Infrastructure**: AI Transparency Notice, Accessibility Statement, Cookie Consent Banner, CCPA Compliance, Privacy Policy, and Terms of Service.\n- **Certificate System**: Expert-level certificates across 7 typing modes with mode-specific visuals and metrics, share functionality, and tiered achievement levels.\n- **AI-Powered Content Generation**: Enhanced difficulty system for AI-generated paragraphs (Easy, Medium, Hard) based on vocabulary, sentence structure, and content depth, with multi-language and cultural adaptation for 95 educational topics.\n\n### System Design Choices\n- **Data Layer**: PostgreSQL database managed with Drizzle ORM, storing users, test results, content, races, analytics, notifications, and gamification data.\n- **Validation**: Zod for runtime validation and Drizzle-Zod for schema conversion.\n- **Build & Deployment**: Client bundled with Vite, server with esbuild for production.\n\n## External Dependencies\n\n### Third-Party Services\n- **Database Hosting**: Neon Serverless PostgreSQL.\n- **Email Service**: Mailgun (domain: mg.typemasterai.com).\n- **AI Services**:\n  - OpenAI GPT-4o (main chat model)\n  - OpenAI gpt-4o-search-preview (native web search)\n  - OpenAI GPT-4o-mini (bot username generation, code snippet generation)\n  - Azure AI Foundry (Bing Grounding fallback for web search)\n- **Web Search**: OpenAI native web search (primary), Azure AI Foundry Bing Grounding (fallback).\n\n### Key NPM Packages\n- **UI & Styling**: `@radix-ui/*`, `tailwindcss`, `lucide-react`, `canvas-confetti`, `recharts`, `prismjs`.\n- **Data & Forms**: `@tanstack/react-query`, `react-hook-form`, `zod`, `drizzle-zod`.\n- **Backend**: `express`, `express-session`, `passport`, `bcryptjs`, `drizzle-orm`, `@neondatabase/serverless`, `ws`, `openai`, `web-push`, `@azure/ai-projects`, `@azure/identity`, `mailgun.js`, `form-data`.\n- **Development Tools**: `vite`, `typescript`, `esbuild`, `drizzle-kit`.","path":null,"size_bytes":5227,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[60px] w-full rounded-md border border-input bg-transparent px-3 py-2 text-base shadow-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":649,"size_tokens":null},"server/chat-service.ts":{"content":"import OpenAI from \"openai\";\nimport * as cheerio from \"cheerio\";\nimport { AIProjectClient } from \"@azure/ai-projects\";\nimport { ClientSecretCredential } from \"@azure/identity\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n\n// Error types for better error handling\nexport enum ChatErrorCode {\n  NETWORK_ERROR = \"NETWORK_ERROR\",\n  API_KEY_INVALID = \"API_KEY_INVALID\",\n  RATE_LIMITED = \"RATE_LIMITED\",\n  CONTEXT_LENGTH_EXCEEDED = \"CONTEXT_LENGTH_EXCEEDED\",\n  CONTENT_FILTERED = \"CONTENT_FILTERED\",\n  SERVICE_UNAVAILABLE = \"SERVICE_UNAVAILABLE\",\n  TIMEOUT = \"TIMEOUT\",\n  SEARCH_FAILED = \"SEARCH_FAILED\",\n  UNKNOWN_ERROR = \"UNKNOWN_ERROR\",\n}\n\nexport interface ChatError {\n  code: ChatErrorCode;\n  message: string;\n  userMessage: string;\n  retryable: boolean;\n  retryAfter?: number;\n}\n\n// Parse OpenAI errors into structured format\nfunction parseOpenAIError(error: any): ChatError {\n  const errorMessage = error?.message || String(error);\n  const statusCode = error?.status || error?.response?.status;\n  \n  // Rate limiting\n  if (statusCode === 429 || errorMessage.includes(\"rate limit\")) {\n    const retryAfter = error?.headers?.[\"retry-after\"] \n      ? parseInt(error.headers[\"retry-after\"]) \n      : 30;\n    return {\n      code: ChatErrorCode.RATE_LIMITED,\n      message: errorMessage,\n      userMessage: \"I'm receiving too many requests right now. Please wait a moment and try again.\",\n      retryable: true,\n      retryAfter,\n    };\n  }\n  \n  // Invalid API key\n  if (statusCode === 401 || errorMessage.includes(\"Incorrect API key\") || errorMessage.includes(\"invalid_api_key\")) {\n    return {\n      code: ChatErrorCode.API_KEY_INVALID,\n      message: errorMessage,\n      userMessage: \"There's a configuration issue with the AI service. Please contact support.\",\n      retryable: false,\n    };\n  }\n  \n  // Context length exceeded\n  if (errorMessage.includes(\"context_length_exceeded\") || errorMessage.includes(\"maximum context length\")) {\n    return {\n      code: ChatErrorCode.CONTEXT_LENGTH_EXCEEDED,\n      message: errorMessage,\n      userMessage: \"This conversation has become too long. Please start a new conversation.\",\n      retryable: false,\n    };\n  }\n  \n  // Content filtered\n  if (errorMessage.includes(\"content_filter\") || errorMessage.includes(\"content_policy_violation\")) {\n    return {\n      code: ChatErrorCode.CONTENT_FILTERED,\n      message: errorMessage,\n      userMessage: \"I can't respond to that type of request. Please try asking something else.\",\n      retryable: false,\n    };\n  }\n  \n  // Service unavailable\n  if (statusCode === 503 || statusCode === 502 || errorMessage.includes(\"overloaded\")) {\n    return {\n      code: ChatErrorCode.SERVICE_UNAVAILABLE,\n      message: errorMessage,\n      userMessage: \"The AI service is temporarily busy. Please try again in a moment.\",\n      retryable: true,\n      retryAfter: 10,\n    };\n  }\n  \n  // Timeout\n  if (errorMessage.includes(\"timeout\") || errorMessage.includes(\"ETIMEDOUT\")) {\n    return {\n      code: ChatErrorCode.TIMEOUT,\n      message: errorMessage,\n      userMessage: \"The request took too long. Please try again.\",\n      retryable: true,\n    };\n  }\n  \n  // Network errors\n  if (errorMessage.includes(\"ECONNREFUSED\") || errorMessage.includes(\"ENOTFOUND\") || errorMessage.includes(\"network\")) {\n    return {\n      code: ChatErrorCode.NETWORK_ERROR,\n      message: errorMessage,\n      userMessage: \"There was a network issue. Please check your connection and try again.\",\n      retryable: true,\n    };\n  }\n  \n  // Default unknown error\n  return {\n    code: ChatErrorCode.UNKNOWN_ERROR,\n    message: errorMessage,\n    userMessage: \"Something went wrong. Please try again.\",\n    retryable: true,\n  };\n}\n\n// Log error with context\nfunction logChatError(context: string, error: any, chatError: ChatError) {\n  console.error(`[Chat Error] ${context}:`, {\n    code: chatError.code,\n    message: chatError.message,\n    retryable: chatError.retryable,\n    originalError: error instanceof Error ? error.message : String(error),\n  });\n}\n\n// OpenAI Web Search using gpt-4o-search-preview model\n// This model performs live web searches when web_search_options is enabled\nasync function searchWithOpenAI(query: string): Promise<SearchResult[]> {\n  try {\n    console.log(`[OpenAI Web Search] Starting search for: \"${query}\"`);\n    const startTime = Date.now();\n\n    // Use the search-preview model with web_search_options enabled\n    // NOTE: This model does NOT support temperature parameter\n    const response = await (openai.chat.completions.create as any)({\n      model: \"gpt-4o-search-preview\",\n      web_search_options: {}, // Required to enable web search\n      messages: [\n        {\n          role: \"system\",\n          content: `You are a web search engine. Your ONLY task is to search the web and return structured results.\n\nCRITICAL: You MUST respond with ONLY a valid JSON array. No explanations, no markdown, no text before or after.\n\nFormat each result exactly like this:\n[\n  {\"title\": \"Example Page Title\", \"url\": \"https://example.com/page\", \"snippet\": \"Brief description of content...\"},\n  {\"title\": \"Another Result\", \"url\": \"https://another.com\", \"snippet\": \"More content...\"}\n]\n\nRules:\n- Return 5-8 results maximum\n- Use REAL URLs from actual websites you find\n- Keep snippets under 200 characters\n- title: exact page title\n- url: full https:// URL\n- snippet: key information from the page\n\nSTART YOUR RESPONSE WITH [ AND END WITH ]`\n        },\n        {\n          role: \"user\",\n          content: query\n        }\n      ],\n      max_tokens: 2000,\n    });\n\n    const responseText = response.choices[0]?.message?.content || \"\";\n    const duration = Date.now() - startTime;\n    console.log(`[OpenAI Web Search] Response received in ${duration}ms (${responseText.length} chars)`);\n\n    // Try to extract JSON from response\n    try {\n      const jsonMatch = responseText.match(/\\[[\\s\\S]*?\\]/);\n      if (jsonMatch) {\n        const results = JSON.parse(jsonMatch[0]);\n        if (Array.isArray(results) && results.length > 0) {\n          const validResults = results.filter((r: any) => r.title && r.url && r.snippet);\n          if (validResults.length > 0) {\n            console.log(`[OpenAI Web Search] âœ… Parsed ${validResults.length} JSON results`);\n            return validResults.slice(0, 10).map((r: any) => ({\n              title: String(r.title || \"\").substring(0, 200),\n              url: String(r.url || \"\"),\n              snippet: String(r.snippet || r.description || \"\").substring(0, 500),\n            }));\n          }\n        }\n      }\n    } catch (parseError) {\n      // JSON parsing failed, try to extract URLs and content from text response\n      console.log(\"[OpenAI Web Search] JSON parse failed, extracting from text response\");\n    }\n\n    // Extract URLs and create results from markdown-style or plain text response\n    const urlPattern = /\\[([^\\]]+)\\]\\(([^)]+)\\)|(?:https?:\\/\\/[^\\s\\])\"]+)/g;\n    const extractedResults: SearchResult[] = [];\n    let match;\n    \n    while ((match = urlPattern.exec(responseText)) !== null && extractedResults.length < 10) {\n      const title = match[1] || match[0].split('/').pop()?.substring(0, 50) || \"Web Result\";\n      const url = match[2] || match[0];\n      \n      // Skip if we already have this URL\n      if (extractedResults.some(r => r.url === url)) continue;\n      \n      // Get surrounding text as snippet\n      const snippetStart = Math.max(0, match.index - 100);\n      const snippetEnd = Math.min(responseText.length, match.index + match[0].length + 200);\n      let snippet = responseText.substring(snippetStart, snippetEnd)\n        .replace(/\\[([^\\]]+)\\]\\([^)]+\\)/g, '$1')\n        .replace(/https?:\\/\\/[^\\s]+/g, '')\n        .replace(/[\\[\\]]/g, '')\n        .trim();\n      \n      if (url.startsWith('http')) {\n        extractedResults.push({\n          title: title.substring(0, 100),\n          url: url,\n          snippet: snippet.substring(0, 300) || \"Web search result\",\n        });\n      }\n    }\n\n    if (extractedResults.length > 0) {\n      console.log(`[OpenAI Web Search] âœ… Extracted ${extractedResults.length} results from text`);\n      return extractedResults;\n    }\n\n    // Final fallback: create synthetic result from the entire response\n    if (responseText.length > 100) {\n      console.log(\"[OpenAI Web Search] Creating synthetic result from response content\");\n      return [{\n        title: `Web Search Results: ${query.substring(0, 40)}`,\n        url: `https://www.google.com/search?q=${encodeURIComponent(query)}`,\n        snippet: responseText.substring(0, 500).replace(/```json/g, \"\").replace(/```/g, \"\").replace(/\\[|\\]/g, \"\").trim(),\n      }];\n    }\n\n    console.log(\"[OpenAI Web Search] No usable results from response\");\n    return [];\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : String(error);\n    console.error(`[OpenAI Web Search] âŒ Error: ${errorMessage}`);\n    \n    // Log more details for debugging\n    if (error instanceof Error && 'response' in error) {\n      console.error(`[OpenAI Web Search] Response status:`, (error as any).response?.status);\n    }\n    \n    return [];\n  }\n}\n\n// Azure AI Foundry Client Setup\nlet azureClient: AIProjectClient | null = null;\nlet cachedBingGroundingAgentId: string | null = null;\n\nfunction getAzureClient(): AIProjectClient {\n  if (!azureClient) {\n    const projectEndpoint = process.env.AZURE_PROJECT_ENDPOINT;\n    const tenantId = process.env.AZURE_TENANT_ID;\n    const clientId = process.env.AZURE_CLIENT_ID;\n    const clientSecret = process.env.AZURE_CLIENT_SECRET;\n\n    if (!projectEndpoint || !tenantId || !clientId || !clientSecret) {\n      throw new Error(\"Azure AI Foundry credentials not configured\");\n    }\n\n    const credential = new ClientSecretCredential(tenantId, clientId, clientSecret);\n    azureClient = new AIProjectClient(projectEndpoint, credential);\n    console.log(\"[Azure AI Foundry] Client initialized successfully\");\n  }\n  return azureClient;\n}\n\n// Get or create Bing Grounding Agent (tries env var first, then creates if permissions allow)\nasync function getOrCreateBingGroundingAgent(): Promise<string> {\n  if (cachedBingGroundingAgentId) {\n    return cachedBingGroundingAgentId;\n  }\n\n  // First, try using pre-provisioned agent ID from environment\n  const preProvisionedAgentId = process.env.AZURE_BING_AGENT_ID;\n  if (preProvisionedAgentId) {\n    cachedBingGroundingAgentId = preProvisionedAgentId;\n    console.log(`[Azure Bing Grounding] âœ… Using pre-provisioned agent: ${preProvisionedAgentId}`);\n    return preProvisionedAgentId;\n  }\n\n  // If not provided, try creating agent (requires write permissions)\n  console.log(\"[Azure Bing Grounding] AZURE_BING_AGENT_ID not found, attempting to create agent...\");\n  \n  try {\n    const client = getAzureClient();\n    const agentsClient = client.agents;\n    const modelDeployment = process.env.AZURE_MODEL_DEPLOYMENT || \"gpt-4o-mini\";\n    const connectionId = process.env.AZURE_BING_CONNECTION_ID;\n\n    if (!connectionId) {\n      throw new Error(\"AZURE_BING_CONNECTION_ID not configured\");\n    }\n\n    const agent = await agentsClient.createAgent(modelDeployment, {\n      name: \"bing-search-agent\",\n      instructions: `You are a web search agent. Your ONLY job is to:\n1. Use Bing search to find relevant, current information\n2. Extract and return search results in a structured format\n3. Include titles, URLs, and snippets from the search\n\nReturn results as a JSON array with this exact structure:\n[{\"title\": \"...\", \"url\": \"...\", \"snippet\": \"...\"}]\n\nBe concise and focus only on factual search results.`,\n      tools: [\n        {\n          type: \"bing_grounding\",\n          bingGrounding: {\n            searchConfigurations: [{ connectionId }],\n          },\n        },\n      ],\n    });\n\n    cachedBingGroundingAgentId = agent.id;\n    console.log(`[Azure Bing Grounding] âœ… Agent created successfully: ${agent.id}`);\n    console.log(`[Azure Bing Grounding] ðŸ’¡ TIP: Set AZURE_BING_AGENT_ID=${agent.id} to reuse this agent and avoid recreating it`);\n    return agent.id;\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : String(error);\n    console.error(`[Azure Bing Grounding] âŒ Failed to create agent: ${errorMessage}`);\n    \n    if (errorMessage.includes(\"write\") || errorMessage.includes(\"permission\") || errorMessage.includes(\"401\")) {\n      console.error(\"[Azure Bing Grounding] ðŸ’¡ SOLUTION: Create an agent in Azure AI Foundry portal and set AZURE_BING_AGENT_ID environment variable\");\n    }\n    \n    throw new Error(`Azure Bing Grounding agent unavailable: ${errorMessage}`);\n  }\n}\n\ninterface SearchResult {\n  title: string;\n  url: string;\n  snippet: string;\n}\n\ninterface ScrapedData {\n  title: string;\n  content: string;\n  url: string;\n}\n\ninterface SearchDecision {\n  shouldSearch: boolean;\n  searchQuery: string;\n  reason: string;\n}\n\nasync function scrapeWebPage(url: string): Promise<ScrapedData | null> {\n  try {\n    const response = await fetch(url, {\n      headers: {\n        \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n        \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8\",\n        \"Accept-Language\": \"en-US,en;q=0.5\",\n      },\n      signal: AbortSignal.timeout(10000),\n    });\n\n    if (!response.ok) return null;\n\n    const html = await response.text();\n    const $ = cheerio.load(html);\n\n    $(\"script, style, nav, footer, iframe, noscript, header, aside, [role='navigation'], [role='banner'], .advertisement, .ads, .sidebar\").remove();\n\n    const title = $(\"title\").text() || $(\"h1\").first().text();\n    \n    const mainContent = $(\"article, main, .content, .post-content, .entry-content, .article-content, .blog-post, [role='main']\").first();\n    const container = mainContent.length ? mainContent : $(\"body\");\n    \n    const headings = container.find(\"h1, h2, h3\")\n      .map((_, el) => `### ${$(el).text().trim()}`)\n      .get()\n      .filter((text) => text.length > 4);\n    \n    const paragraphs = container.find(\"p, li, td, dd, blockquote\")\n      .map((_, el) => $(el).text().trim())\n      .get()\n      .filter((text) => \n        text.length > 20 && \n        !text.toLowerCase().includes(\"cookie\") && \n        !text.toLowerCase().includes(\"privacy policy\") &&\n        !text.toLowerCase().includes(\"terms of service\") &&\n        !text.toLowerCase().includes(\"subscribe\") &&\n        !text.toLowerCase().includes(\"sign up\") &&\n        !text.toLowerCase().includes(\"newsletter\") &&\n        !text.toLowerCase().includes(\"advertisement\")\n      )\n      .slice(0, 30);\n\n    let content = \"\";\n    let charCount = 0;\n    const maxChars = 6000;\n    \n    for (let i = 0; i < paragraphs.length && charCount < maxChars; i++) {\n      const para = paragraphs[i];\n      if (charCount + para.length <= maxChars) {\n        content += para + \"\\n\\n\";\n        charCount += para.length + 2;\n      } else {\n        content += para.substring(0, maxChars - charCount) + \"...\";\n        break;\n      }\n    }\n\n    return {\n      title: title.trim(),\n      content: content.trim(),\n      url,\n    };\n  } catch (error) {\n    return null;\n  }\n}\n\nasync function searchWithBing(query: string): Promise<SearchResult[]> {\n  let threadId: string | null = null;\n  \n  try {\n    console.log(`[Azure Bing Grounding] Starting search for: \"${query}\"`);\n    const startTime = Date.now();\n\n    // Get or create Bing Grounding agent\n    const agentId = await getOrCreateBingGroundingAgent();\n\n    const client = getAzureClient();\n    const agentsClient = client.agents;\n\n    // Create thread\n    const thread = await agentsClient.threads.create();\n    threadId = thread.id;\n    console.log(`[Azure Bing Grounding] Thread created: ${threadId}`);\n\n    // Send search message\n    await agentsClient.messages.create(\n      threadId,\n      \"user\",\n      `Search for: ${query}\\n\\nReturn the top 10 search results as a JSON array with title, url, and snippet for each result.`\n    );\n\n    // Create and poll run\n    const runResponse = await agentsClient.runs.create(threadId, agentId);\n    console.log(`[Azure Bing Grounding] Run created: ${runResponse.id}`);\n\n    // Poll for completion (max 30 seconds)\n    const maxPollTime = 30000;\n    const pollInterval = 1000;\n    let pollCount = 0;\n    let run = runResponse;\n\n    while (\n      run.status === \"queued\" ||\n      run.status === \"in_progress\" ||\n      run.status === \"requires_action\"\n    ) {\n      if (Date.now() - startTime > maxPollTime) {\n        console.error(\"[Azure Bing Grounding] Timeout waiting for run completion\");\n        break;\n      }\n\n      await new Promise((resolve) => setTimeout(resolve, pollInterval));\n      run = await agentsClient.runs.get(threadId, run.id);\n      pollCount++;\n\n      if (pollCount % 5 === 0) {\n        console.log(`[Azure Bing Grounding] Run status: ${run.status} (${pollCount}s)`);\n      }\n    }\n\n    console.log(`[Azure Bing Grounding] Final run status: ${run.status} after ${Date.now() - startTime}ms`);\n\n    if (run.status === \"completed\") {\n      // Retrieve messages\n      const messages = agentsClient.messages.list(threadId);\n      const messagesArray = [];\n      \n      for await (const msg of messages) {\n        messagesArray.push(msg);\n      }\n\n      // Find assistant's response\n      const assistantMessage = messagesArray.find((m) => m.role === \"assistant\");\n\n      if (assistantMessage && assistantMessage.content && assistantMessage.content.length > 0) {\n        const content = assistantMessage.content[0];\n        \n        if (content.type === \"text\") {\n          // Type-safe access to text content\n          const textContent = content.type === \"text\" && \"text\" in content ? content.text : null;\n          const responseText = textContent?.value || \"\";\n          console.log(`[Azure Bing Grounding] Response received: ${responseText.substring(0, 200)}...`);\n\n          // Try to parse JSON from the response\n          try {\n            // Extract JSON array from the response (handle markdown code blocks)\n            const jsonMatch = responseText.match(/\\[[\\s\\S]*\\]/);\n            if (jsonMatch) {\n              const results = JSON.parse(jsonMatch[0]);\n              if (Array.isArray(results)) {\n                console.log(`[Azure Bing Grounding] âœ… Parsed ${results.length} search results`);\n                \n                return results.slice(0, 10).map((r: any) => ({\n                  title: r.title || \"\",\n                  url: r.url || \"\",\n                  snippet: r.snippet || r.description || \"\",\n                }));\n              }\n            }\n          } catch (parseError) {\n            console.error(\"[Azure Bing Grounding] Failed to parse JSON from response\");\n          }\n\n          // Fallback: create synthetic results from the response\n          console.log(\"[Azure Bing Grounding] Using fallback result extraction\");\n          \n          return [{\n            title: \"Search Results\",\n            url: \"https://www.bing.com/search?q=\" + encodeURIComponent(query),\n            snippet: responseText.substring(0, 300),\n          }];\n        }\n      }\n    } else if (run.status === \"failed\") {\n      console.error(`[Azure Bing Grounding] Run failed: ${run.lastError?.message || \"Unknown error\"}`);\n    }\n\n    return [];\n  } catch (error) {\n    console.error(`[Azure Bing Grounding] Search error:`, error instanceof Error ? error.message : String(error));\n    if (error instanceof Error && error.stack) {\n      console.error(`[Azure Bing Grounding] Stack trace:`, error.stack);\n    }\n    return [];\n  } finally {\n    // Always clean up thread, even on errors (agent is cached and reused)\n    if (threadId) {\n      try {\n        const client = getAzureClient();\n        await client.agents.threads.delete(threadId);\n        console.log(`[Azure Bing Grounding] Thread ${threadId} deleted`);\n      } catch (cleanupError) {\n        // Ignore cleanup errors - thread will expire eventually\n        console.warn(`[Azure Bing Grounding] Thread cleanup warning:`, cleanupError instanceof Error ? cleanupError.message : String(cleanupError));\n      }\n    }\n  }\n}\n\nasync function searchWithTavily(query: string): Promise<SearchResult[]> {\n  const apiKey = process.env.TAVILY_API_KEY;\n  if (!apiKey) return [];\n\n  try {\n    const response = await fetch(\"https://api.tavily.com/search\", {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        api_key: apiKey,\n        query,\n        search_depth: \"basic\",\n        include_answer: false,\n        max_results: 5,\n      }),\n      signal: AbortSignal.timeout(10000),\n    });\n\n    if (!response.ok) {\n      console.error(`[Tavily] API error: ${response.status}`);\n      return [];\n    }\n\n    const data = await response.json();\n    return (data.results || []).map((r: any) => ({\n      title: r.title,\n      url: r.url,\n      snippet: r.content?.substring(0, 300) || \"\",\n    }));\n  } catch (error) {\n    console.error(\"[Tavily] Search error:\", error);\n    return [];\n  }\n}\n\nasync function searchWithDuckDuckGo(query: string): Promise<SearchResult[]> {\n  try {\n    const searchUrl = `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`;\n    const response = await fetch(searchUrl, {\n      headers: {\n        \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n        \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\n        \"Accept-Language\": \"en-US,en;q=0.9\",\n      },\n      signal: AbortSignal.timeout(10000),\n    });\n\n    if (!response.ok) return [];\n\n    const html = await response.text();\n    const $ = cheerio.load(html);\n    const results: SearchResult[] = [];\n\n    $(\".result, .web-result\").each((i, elem) => {\n      if (i >= 6) return false;\n\n      const titleElem = $(elem).find(\".result__a, .result-link\");\n      const title = titleElem.text().trim();\n      const href = titleElem.attr(\"href\") || \"\";\n      const snippet = $(elem).find(\".result__snippet, .result-snippet\").text().trim();\n\n      let url = \"\";\n      if (href.includes(\"uddg=\")) {\n        try {\n          const uddg = new URL(href, \"https://duckduckgo.com\").searchParams.get(\"uddg\");\n          url = uddg ? decodeURIComponent(uddg) : \"\";\n        } catch {\n          url = \"\";\n        }\n      } else if (href.startsWith(\"http\")) {\n        url = href;\n      } else {\n        const urlText = $(elem).find(\".result__url\").text().trim();\n        if (urlText) url = urlText.startsWith(\"http\") ? urlText : `https://${urlText}`;\n      }\n\n      if (title && url && url.startsWith(\"http\")) {\n        results.push({ title, url, snippet });\n      }\n    });\n\n    return results;\n  } catch (error) {\n    console.error(\"DuckDuckGo search error:\", error);\n    return [];\n  }\n}\n\nasync function generateSearchQueries(originalQuery: string): Promise<string[]> {\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        {\n          role: \"system\",\n          content: `You are a search query optimization expert. Your job is to generate HIGHLY RELEVANT, FOCUSED search queries that stay EXACTLY on topic.\n\nCRITICAL RULES:\n1. **STAY ON TOPIC**: Every query must be 100% relevant to the user's exact question\n2. **NO TANGENTS**: Don't broaden the scope or add unrelated topics\n3. **EXTRACT CORE INTENT**: Understand what the user really wants to know\n4. **BE SPECIFIC**: Include exact entities, dates, names mentioned by user\n5. **MAINTAIN CONTEXT**: Keep all important qualifiers (e.g., \"top\", \"best\", \"latest\", \"2024\")\n6. **REMOVE FLUFF**: Strip phrases like \"give me info about\", \"tell me about\"\n7. **OPTIMIZE FOR RELEVANCE**: Each query should find highly relevant results only\n\nQuery Generation Strategy:\n- Query 1: Most specific version (exact entities + qualifiers + time)\n- Query 2: Slightly broader but still focused (synonyms, alternative phrasing)\n- Query 3: Different angle but same core topic (e.g., reviews, comparisons, technical details)\n\nWRONG Examples (TOO BROAD):\nUser asks: \"top AI coding tools 2024\"\nâŒ Bad: [\"AI tools\", \"artificial intelligence applications\", \"machine learning software\"]\nâœ… Good: [\"best AI coding assistants 2024\", \"top AI code generation tools comparison 2024\", \"leading AI programming tools reviews 2024\"]\n\nRespond with JSON only:\n{\n  \"queries\": [\"highly specific query 1\", \"focused query 2\", \"relevant query 3\"]\n}`,\n        },\n        {\n          role: \"user\",\n          content: `Generate optimized search queries for: ${originalQuery}`,\n        },\n      ],\n      temperature: 0.3,\n      max_tokens: 250,\n      response_format: { type: \"json_object\" },\n    });\n\n    const result = JSON.parse(response.choices[0]?.message?.content || \"{}\");\n    const queries = result.queries && Array.isArray(result.queries) && result.queries.length > 0 \n      ? result.queries \n      : [originalQuery];\n    console.log(`[DeepSearch] Generated ${queries.length} search queries:`, queries);\n    return queries.slice(0, 3);\n  } catch (error) {\n    console.error(\"Query generation error:\", error);\n    return [originalQuery];\n  }\n}\n\nexport async function performWebSearch(query: string): Promise<{ results: SearchResult[]; content: string }> {\n  console.log(`[WebSearch] Searching for: \"${query}\"`);\n  \n  // Only use Bing Grounding\n  const results = await searchWithBing(query);\n  \n  if (results.length === 0) {\n    console.warn(\"[WebSearch] No results found from Bing Grounding\");\n    return { results: [], content: \"\" };\n  }\n  \n  console.log(`[WebSearch] Found ${results.length} results via Bing Grounding`);\n\n  let extractedContent = \"\";\n  const scrapedUrls: string[] = [];\n\n  for (let i = 0; i < Math.min(results.length, 8); i++) {\n    const result = results[i];\n    try {\n      const scraped = await scrapeWebPage(result.url);\n      if (scraped && scraped.content && scraped.content.length > 100) {\n        extractedContent += `\\n\\n---\\n**Source ${i + 1}: ${scraped.title}**\\nURL: ${result.url}\\n\\n${scraped.content}\\n`;\n        scrapedUrls.push(result.url);\n        console.log(`[WebSearch] Scraped ${scraped.content.length} chars from ${result.url}`);\n        if (extractedContent.length > 30000) break;\n      }\n    } catch (error) {\n      console.log(`[WebSearch] Failed to scrape ${result.url}`);\n    }\n  }\n\n  console.log(`[WebSearch] Scraped ${scrapedUrls.length} pages successfully. Total content: ${extractedContent.length} chars`);\n\n  if (extractedContent.length === 0 && results.length > 0) {\n    for (let i = 0; i < Math.min(results.length, 6); i++) {\n      const result = results[i];\n      extractedContent += `\\n\\n---\\n**Source ${i + 1}: ${result.title}**\\nURL: ${result.url}\\n\\n${result.snippet}\\n`;\n    }\n    console.log(`[WebSearch] Using snippets as fallback. Total content: ${extractedContent.length} chars`);\n  }\n\n  return { results, content: extractedContent };\n}\n\nexport async function performDeepWebSearch(query: string): Promise<{ results: SearchResult[]; content: string }> {\n  console.log(`[DeepSearch] Starting deep search for: \"${query}\"`);\n  \n  const startTime = Date.now();\n  const MAX_TOTAL_TIME = 60000;\n  \n  const queries = await generateSearchQueries(query);\n  \n  const allResults: SearchResult[] = [];\n  const seenUrls = new Set<string>();\n  \n  for (const searchQuery of queries) {\n    if (Date.now() - startTime > MAX_TOTAL_TIME) {\n      console.log(`[DeepSearch] Reached time limit, stopping query execution`);\n      break;\n    }\n    \n    console.log(`[DeepSearch] Executing query: \"${searchQuery}\"`);\n    \n    // Try OpenAI Web Search first (primary), then Azure Bing Grounding (fallback)\n    let queryResults = await searchWithOpenAI(searchQuery);\n    \n    if (queryResults.length > 0) {\n      console.log(`[DeepSearch] âœ… Found ${queryResults.length} results via OpenAI Web Search for \"${searchQuery}\"`);\n    } else {\n      // Fallback to Azure Bing Grounding\n      console.log(`[DeepSearch] OpenAI returned no results, trying Azure Bing Grounding...`);\n      queryResults = await searchWithBing(searchQuery);\n      \n      if (queryResults.length > 0) {\n        console.log(`[DeepSearch] âœ… Found ${queryResults.length} results via Azure Bing Grounding for \"${searchQuery}\"`);\n      } else {\n        console.log(`[DeepSearch] Both search providers returned no results for \"${searchQuery}\"`);\n      }\n    }\n    \n    for (const result of queryResults) {\n      if (!seenUrls.has(result.url)) {\n        seenUrls.add(result.url);\n        allResults.push(result);\n      }\n    }\n    \n    if (allResults.length >= 15) break;\n  }\n  \n  console.log(`[DeepSearch] Total unique results: ${allResults.length}`);\n  \n  if (allResults.length === 0) {\n    console.log(\"[DeepSearch] No results found\");\n    return { results: [], content: \"\" };\n  }\n  \n  let extractedContent = \"\";\n  const scrapedUrls: string[] = [];\n  const maxPages = Math.min(allResults.length, 10);\n  \n  for (let i = 0; i < maxPages; i++) {\n    if (Date.now() - startTime > MAX_TOTAL_TIME) {\n      console.log(`[DeepSearch] Reached time limit, stopping scrape`);\n      break;\n    }\n    \n    const result = allResults[i];\n    try {\n      const scraped = await scrapeWebPage(result.url);\n      if (scraped && scraped.content && scraped.content.length > 100) {\n        extractedContent += `\\n\\n---\\n**Source ${scrapedUrls.length + 1}: ${scraped.title}**\\nURL: ${result.url}\\n\\n${scraped.content}\\n`;\n        scrapedUrls.push(result.url);\n        console.log(`[DeepSearch] Scraped ${scraped.content.length} chars from ${result.url}`);\n        \n        if (extractedContent.length > 40000) {\n          console.log(`[DeepSearch] Reached content limit (40k chars), stopping scrape`);\n          break;\n        }\n      }\n    } catch (error) {\n      console.log(`[DeepSearch] Failed to scrape ${result.url}`);\n    }\n  }\n  \n  console.log(`[DeepSearch] Scraped ${scrapedUrls.length} pages successfully. Total content: ${extractedContent.length} chars. Total time: ${Date.now() - startTime}ms`);\n  \n  if (extractedContent.length === 0 && allResults.length > 0) {\n    for (let i = 0; i < Math.min(allResults.length, 10); i++) {\n      const result = allResults[i];\n      extractedContent += `\\n\\n---\\n**Source ${i + 1}: ${result.title}**\\nURL: ${result.url}\\n\\n${result.snippet}\\n`;\n    }\n    console.log(`[DeepSearch] Using snippets as fallback. Total content: ${extractedContent.length} chars`);\n  }\n  \n  return { results: allResults.slice(0, 10), content: extractedContent };\n}\n\nexport async function decideIfSearchNeeded(message: string): Promise<SearchDecision> {\n  const lowerMessage = message.toLowerCase();\n\n  const hasFileAnalysis = message.includes(\"[Attached file:\") || message.includes(\"# File Analysis:\");\n  \n  if (hasFileAnalysis) {\n    const explicitSearchTriggers = [\n      \"search this\", \"search the document\", \"search about this\", \n      \"web search\", \"look this up\", \"search online\", \"google this\",\n      \"research this\", \"find more online\"\n    ];\n    const wantsSearch = explicitSearchTriggers.some(t => lowerMessage.includes(t));\n    \n    if (wantsSearch) {\n      const topicMatch = message.match(/## (?:Document Overview|Content Summary|Key Content)[\\s\\S]*?(?:topic|subject|about)[:\\s]*([^\\n]+)/i);\n      const searchQuery = topicMatch ? topicMatch[1].trim() : message.substring(0, 200);\n      console.log(`[AI Search] Explicit search request for document detected`);\n      return {\n        shouldSearch: true,\n        searchQuery: `${searchQuery} latest information`,\n        reason: \"Explicit search request for document\",\n      };\n    }\n    \n    console.log(`[AI Search] Document analysis without search request - skipping web search`);\n    return {\n      shouldSearch: false,\n      searchQuery: \"\",\n      reason: \"Document analysis - no explicit search requested\",\n    };\n  }\n\n  const urlPattern = /\\b(?:https?:\\/\\/)?(?:www\\.)?[\\w-]+\\.(?:com|org|net|io|co|ai|dev|app|info|edu|gov)\\b/i;\n  if (urlPattern.test(message)) {\n    const urlMatch = message.match(urlPattern);\n    return {\n      shouldSearch: true,\n      searchQuery: urlMatch ? urlMatch[0] : message,\n      reason: \"URL detected - fetching content\",\n    };\n  }\n\n  const quickTriggers = [\n    \"search\", \"websearch\", \"web search\", \"look up\", \"lookup\", \"find\", \"google\",\n    \"latest\", \"current\", \"recent\", \"news\", \"today\", \"now\", \"update\",\n    \"2024\", \"2025\", \"this week\", \"this month\", \"this year\",\n    \"price\", \"cost\", \"stock\", \"weather\", \"score\",\n    \"what is\", \"what are\", \"who is\", \"who are\", \"which are\", \"which is\",\n    \"top\", \"best\", \"ranking\", \"list\", \"comparison\", \"compare\",\n    \"new\", \"breaking\", \"trending\", \"popular\", \"hot\",\n  ];\n  \n  const hasQuickTrigger = quickTriggers.some(t => lowerMessage.includes(t));\n  if (hasQuickTrigger) {\n    console.log(`[AI Search] Quick trigger detected: searching for \"${message}\"`);\n    return {\n      shouldSearch: true,\n      searchQuery: message.replace(/perform\\s+a?\\s*web\\s*search\\s+(and\\s+)?/gi, \"\").replace(/search\\s+for\\s+/gi, \"\").trim(),\n      reason: \"Quick trigger keyword detected\",\n    };\n  }\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        {\n          role: \"system\",\n          content: `You are a search decision agent. You should be VERY AGGRESSIVE about triggering searches - when in doubt, SEARCH.\n\nALWAYS SEARCH for (be generous):\n- ANY question asking \"what is\", \"what are\", \"who is\", \"which are\", \"top X\", \"best X\", \"list of\"\n- Current events, news, or information that could be recent (after 2023)\n- Real-time data: stock prices, weather, sports scores, crypto prices, market data\n- Specific products, companies, tools, libraries, frameworks, or services\n- Technical documentation, APIs, or specific implementations\n- Factual claims, statistics, or data that could be verified\n- Questions about specific websites, apps, or online platforms\n- Pricing, reviews, or comparisons\n- Information about people, organizations, or events\n- Technology topics, AI models, coding tools, programming languages\n- Anything with years 2024, 2025 or later\n- Questions that benefit from fresh/current information\n\nONLY SKIP SEARCH for:\n- Pure creative writing requests (poems, stories with no factual basis)\n- Basic math calculations\n- Simple logical reasoning with no external facts needed\n- Personal advice based on subjective opinion only\n\nWhen in doubt â†’ SEARCH. Prioritize recency and accuracy.\n\nRespond with JSON only:\n{\n  \"search\": true/false,\n  \"query\": \"optimized search query (remove phrases like 'perform a web search', 'search for')\",\n  \"reason\": \"brief reason\"\n}`,\n        },\n        {\n          role: \"user\",\n          content: message,\n        },\n      ],\n      temperature: 0,\n      max_tokens: 150,\n      response_format: { type: \"json_object\" },\n    });\n\n    const result = JSON.parse(response.choices[0]?.message?.content || \"{}\");\n    \n    return {\n      shouldSearch: result.search === true,\n      searchQuery: result.query || message,\n      reason: result.reason || \"\",\n    };\n  } catch (error) {\n    console.error(\"Search decision error:\", error);\n    \n    return {\n      shouldSearch: true,\n      searchQuery: message,\n      reason: \"Fallback - default to search on error\",\n    };\n  }\n}\n\nexport function shouldPerformWebSearch(message: string): boolean {\n  const lowerMessage = message.toLowerCase();\n\n  const urlPattern = /\\b(?:https?:\\/\\/)?(?:www\\.)?[\\w-]+\\.(?:com|org|net|io|co|ai|dev|app|info|edu|gov)\\b/i;\n  if (urlPattern.test(message)) {\n    return true;\n  }\n\n  const explicitSearchTriggers = [\n    \"search for\", \"search about\", \"google\", \"look up\", \"lookup\",\n    \"find online\", \"find on the web\", \"web search\", \"search the web\",\n    \"search the internet\", \"what is the latest\", \"current news\",\n  ];\n\n  const freshnessTriggers = [\n    \"current\", \"latest\", \"recent\", \"news\", \"today\", \"this week\",\n    \"this month\", \"this year\", \"2024\", \"2025\", \"update on\",\n    \"updates on\", \"what's new\", \"breaking\", \"price of\", \"stock price\",\n    \"weather in\", \"who won\", \"score of\",\n  ];\n\n  const hasExplicitSearch = explicitSearchTriggers.some((trigger) => lowerMessage.includes(trigger));\n  const hasFreshnessTrigger = freshnessTriggers.some((trigger) => lowerMessage.includes(trigger));\n\n  return hasExplicitSearch || hasFreshnessTrigger;\n}\n\nexport interface ChatMessage {\n  role: \"system\" | \"user\" | \"assistant\";\n  content: string;\n}\n\nexport interface StreamEvent {\n  type: \"searching\" | \"search_complete\" | \"content\" | \"sources\" | \"done\" | \"error\";\n  data?: any;\n}\n\nexport async function* streamChatCompletionWithSearch(\n  messages: ChatMessage[],\n  useAISearch: boolean = true\n): AsyncGenerator<StreamEvent, void, unknown> {\n  let searchData: { results: SearchResult[]; content: string } = { results: [], content: \"\" };\n  let searchQuery = \"\";\n\n  if (messages.length > 0) {\n    const lastMessage = messages[messages.length - 1];\n    if (lastMessage.role === \"user\") {\n      if (useAISearch) {\n        yield { type: \"searching\", data: { status: \"deciding\" } };\n        \n        const decision = await decideIfSearchNeeded(lastMessage.content);\n        console.log(`[AI Search] Decision: ${decision.shouldSearch ? \"SEARCH\" : \"NO SEARCH\"} - ${decision.reason}`);\n        \n        if (decision.shouldSearch) {\n          searchQuery = decision.searchQuery;\n          yield { type: \"searching\", data: { status: \"searching\", query: searchQuery } };\n          \n          searchData = await performDeepWebSearch(searchQuery);\n          \n          if (searchData.results.length > 0) {\n            yield { \n              type: \"search_complete\", \n              data: { \n                results: searchData.results.slice(0, 10),\n                query: searchQuery \n              } \n            };\n          }\n        }\n      } else {\n        const quickCheck = shouldPerformWebSearch(lastMessage.content);\n        if (quickCheck) {\n          yield { type: \"searching\", data: { status: \"searching\", query: lastMessage.content } };\n          searchData = await performDeepWebSearch(lastMessage.content);\n          \n          if (searchData.results.length > 0) {\n            yield { \n              type: \"search_complete\", \n              data: { \n                results: searchData.results.slice(0, 10),\n                query: lastMessage.content \n              } \n            };\n          }\n        }\n      }\n    }\n  }\n\n  const hasSearchResults = searchData.content.length > 0;\n  \n  const systemMessage: ChatMessage = {\n    role: \"system\",\n    content: `You are **TypeMasterAI**, an advanced AI typing coach and general-purpose assistant. You combine deep expertise in typing, keyboard mastery, and productivity with the ability to help users with any topic.\n\n## Your Specialties\n\n### Typing & Keyboard Mastery\n- **Speed Improvement**: Techniques to increase WPM (words per minute) from beginner (20-40 WPM) to expert (100+ WPM)\n- **Touch Typing**: Proper finger placement, home row technique, and muscle memory development\n- **Accuracy Training**: Reducing errors, building consistency, and achieving 98%+ accuracy\n- **Keyboard Layouts**: QWERTY, Dvorak, Colemak comparisons and switching strategies\n- **Ergonomics**: Preventing RSI, proper posture, keyboard height, and break schedules\n- **Practice Strategies**: Deliberate practice, identifying weak keys, and tracking progress\n\n### Document & File Analysis\n- **Image Analysis**: Detailed visual analysis using GPT-4o Vision - extracting text, describing content, analyzing charts/graphs\n- **PDF Analysis**: Deep content extraction and summarization of PDF documents\n- **Document Understanding**: Comprehensive analysis of Word docs, text files, and code files\n- **Research Integration**: Combine file analysis with web research for comprehensive insights\n\n**IMPORTANT for File Analysis:**\n- When a user attaches a file, the analysis is already included in their message\n- DO NOT repeat or re-state the entire analysis - the user has already seen it\n- Instead, provide ACTIONABLE INSIGHTS: key takeaways, what the document means, recommendations, or answers to their specific question\n- Be conversational and helpful - focus on value-add, not restating content\n\n### General Assistance\n- Answer questions on any topic with accuracy and depth\n- Help with coding, writing, math, research, and problem-solving\n- Provide creative ideas and thoughtful analysis\n- When web search results are provided, synthesize current information\n- When file analysis is provided, provide actionable insights and answer the user's specific question (don't repeat the analysis)\n\n## Personality\n- Encouraging and supportive, celebrating user progress\n- Direct and actionable - give specific, implementable advice\n- Enthusiastic about helping users improve their typing skills\n- Balance being informative with being engaging\n\n## Response Guidelines\nFORMATTING RULES - Keep responses clean and readable:\n\n1. Headings: Use ## for main sections, ### for subsections\n2. Lists: Use bullet points or numbered lists for clarity\n3. DO NOT use asterisks for bold (**text**) - write plain text instead\n4. Code: Use \\`inline code\\` for technical terms or \\`\\`\\`language for code blocks\n5. Tables: Use markdown tables for comparing data\n6. Callouts: Use blockquotes for special content:\n   - \\`> Note: Important information\\`\n   - \\`> Warning: Be careful about this\\`\n   - \\`> Tip: Pro suggestion here\\`\n\nResponse Structure:\n- Start with a brief, direct answer\n- Break long content into sections with headings\n- Use lists for multiple points\n- Include examples in code blocks when relevant\n- End with actionable takeaways\n- Keep text clean without excessive formatting\n${hasSearchResults ? `\n\nCRITICAL: WEB SEARCH RESULTS PROVIDED - USE THIS INFORMATION\n\nThe user has requested current/fresh information that requires web search. Below are the MOST RECENT web search results scraped from live websites. Base your answer on this data, NOT on your training data.\n\nFRESH SEARCH RESULTS (Just Retrieved):\n${searchData.content}\n\nMANDATORY INSTRUCTIONS:\n1. USE ONLY the information from the search results above\n2. DO NOT rely on your training data (it's outdated for this query)\n3. Include specific facts, numbers, dates, and details from the sources\n4. Cite or reference the sources naturally when mentioning key information\n5. If the search results don't fully answer the question, acknowledge what's missing\n6. Present the information as current and up-to-date (because it is!)\n7. DO NOT say \"based on the search results\" - just answer confidently\n8. DO NOT use outdated information from your training cutoff\n\nThe user expects FRESH, CURRENT information from these search results. Deliver it accurately.` : \"\"}`,\n  };\n\n  const allMessages = [systemMessage, ...messages];\n\n  try {\n    const stream = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: allMessages,\n      stream: true,\n      temperature: hasSearchResults ? 0.3 : 0.7,\n      max_tokens: 4000,\n    });\n\n    for await (const chunk of stream) {\n      const content = chunk.choices[0]?.delta?.content;\n      if (content) {\n        yield { type: \"content\", data: content };\n      }\n    }\n\n    if (searchData.results.length > 0) {\n      yield { \n        type: \"sources\", \n        data: searchData.results.slice(0, 10).map(r => ({\n          title: r.title,\n          url: r.url,\n          snippet: r.snippet?.substring(0, 150) || \"\",\n        }))\n      };\n    }\n\n    yield { type: \"done\" };\n  } catch (error: any) {\n    const chatError = parseOpenAIError(error);\n    logChatError(\"streamChatCompletionWithSearch\", error, chatError);\n    \n    yield { \n      type: \"error\", \n      data: {\n        code: chatError.code,\n        message: chatError.userMessage,\n        retryable: chatError.retryable,\n        retryAfter: chatError.retryAfter,\n      }\n    };\n  }\n}\n\nexport async function* streamChatCompletion(\n  messages: ChatMessage[],\n  performSearch: boolean = false\n): AsyncGenerator<string, void, unknown> {\n  const generator = streamChatCompletionWithSearch(messages, performSearch);\n  \n  for await (const event of generator) {\n    if (event.type === \"content\") {\n      yield event.data;\n    }\n  }\n}\n\n/**\n * Generate a concise, meaningful title for a conversation based on the first user message.\n * This mimics ChatGPT's auto-naming behavior.\n */\nexport async function generateConversationTitle(userMessage: string): Promise<string> {\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        {\n          role: \"system\",\n          content: `You are a conversation title generator. Generate a short, concise title (3-6 words max) that captures the essence of the user's message.\n\nRules:\n- Title should be 3-6 words maximum\n- Be descriptive and specific to the topic\n- Use title case (capitalize first letter of major words)\n- No punctuation at the end\n- No quotes around the title\n- If it's a question, summarize the topic rather than using the question format\n- If it's about coding, include the language/technology if mentioned\n- Be creative but accurate\n\nExamples:\n- \"How do I center a div in CSS?\" â†’ \"CSS Div Centering Guide\"\n- \"What's the best way to learn Python?\" â†’ \"Python Learning Path\"\n- \"Can you help me write a poem about rain?\" â†’ \"Rain Poetry Creation\"\n- \"I need to improve my typing speed\" â†’ \"Typing Speed Improvement\"\n- \"Explain quantum computing to me\" â†’ \"Quantum Computing Basics\"`,\n        },\n        {\n          role: \"user\",\n          content: userMessage,\n        },\n      ],\n      temperature: 0.7,\n      max_tokens: 20,\n    });\n\n    const title = response.choices[0]?.message?.content?.trim();\n    \n    // Fallback if empty or too long\n    if (!title || title.length > 50) {\n      return generateFallbackTitle(userMessage);\n    }\n    \n    // Remove any quotes that might be in the response\n    return title.replace(/^[\"']|[\"']$/g, '').trim();\n  } catch (error) {\n    console.error(\"Title generation error:\", error);\n    return generateFallbackTitle(userMessage);\n  }\n}\n\n/**\n * Generate a simple fallback title from the message content\n */\nfunction generateFallbackTitle(message: string): string {\n  // Remove special characters and extra whitespace\n  const cleaned = message\n    .replace(/[^\\w\\s]/g, ' ')\n    .replace(/\\s+/g, ' ')\n    .trim();\n  \n  // Take first few words\n  const words = cleaned.split(' ').slice(0, 5);\n  \n  // Capitalize first letter of each word\n  const title = words\n    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())\n    .join(' ');\n  \n  return title.length > 40 ? title.substring(0, 40) + '...' : title;\n}\n","path":null,"size_bytes":46554,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverAnchor = PopoverPrimitive.Anchor\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent, PopoverAnchor }\n","path":null,"size_bytes":1342,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  // @replit\n  // Whitespace-nowrap: Badges should never wrap.\n  \"whitespace-nowrap inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\" +\n  \" hover-elevate \",\n  {\n    variants: {\n      variant: {\n        default:\n          // @replit shadow-xs instead of shadow, no hover because we use hover-elevate\n          \"border-transparent bg-primary text-primary-foreground shadow-xs\",\n        secondary:\n          // @replit no hover because we use hover-elevate\n          \"border-transparent bg-secondary text-secondary-foreground\",\n        destructive:\n          // @replit shadow-xs instead of shadow, no hover because we use hover-elevate\n          \"border-transparent bg-destructive text-destructive-foreground shadow-xs\",\n          // @replit shadow-xs\" - use badge outline variable\n        outline: \"text-foreground border [border-color:var(--badge-outline)]\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1522,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4887,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"import * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1237,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-9 px-2 min-w-9\",\n        sm: \"h-8 px-1.5 min-w-8\",\n        lg: \"h-10 px-2.5 min-w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1486,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-3.5 w-3.5 fill-primary\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1410,"size_tokens":null},"client/src/pages/register.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useLocation, useSearch } from \"wouter\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { AlertCircle, Mail, Lock, User } from \"lucide-react\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport confetti from \"canvas-confetti\";\nimport {\n  AuthLayout,\n  AuthPanel,\n  AuthPanelHeader,\n  AuthPanelContent,\n  AuthPanelFooter,\n  AuthInput,\n  CapsLockWarning,\n  SocialButton,\n  SubmitButton,\n  AuthDivider,\n  AuthLink,\n} from \"@/components/auth\";\n\ninterface ProviderAvailability {\n  google: boolean;\n  github: boolean;\n  facebook: boolean;\n}\n\nexport default function Register() {\n  const [, setLocation] = useLocation();\n  const searchString = useSearch();\n  const { register } = useAuth();\n  const [username, setUsername] = useState(\"\");\n  const [email, setEmail] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [error, setError] = useState(\"\");\n  const [isLoading, setIsLoading] = useState(false);\n  const [isSuccess, setIsSuccess] = useState(false);\n  const [capsLockOn, setCapsLockOn] = useState(false);\n\n  const { data: providers } = useQuery<ProviderAvailability>({\n    queryKey: [\"provider-availability\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/auth/providers/availability\");\n      if (!response.ok) {\n        return { google: false, github: false, facebook: false };\n      }\n      return response.json();\n    },\n    staleTime: 5 * 60 * 1000,\n  });\n\n  const isProviderAvailable = (provider: keyof ProviderAvailability) => {\n    return providers?.[provider] ?? false;\n  };\n\n  const anyProviderAvailable = providers && (providers.google || providers.github || providers.facebook);\n\n  useEffect(() => {\n    const params = new URLSearchParams(searchString);\n    const errorParam = params.get(\"error\");\n    if (errorParam) {\n      const errorMessages: Record<string, string> = {\n        google_failed: \"Google sign-up failed. Please try again.\",\n        github_failed: \"GitHub sign-up failed. Please try again.\",\n        facebook_failed: \"Facebook sign-up failed. Please try again.\",\n        oauth_error: \"An error occurred during sign-up. Please try again.\",\n        invalid_state: \"Session expired. Please try again.\",\n        provider_not_configured: \"This sign-up method is not available.\",\n      };\n      setError(errorMessages[errorParam] || \"Sign-up failed. Please try again.\");\n    }\n  }, [searchString]);\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    setCapsLockOn(e.getModifierState(\"CapsLock\"));\n  };\n\n  const triggerSuccessConfetti = () => {\n    const duration = 3 * 1000;\n    const end = Date.now() + duration;\n\n    const frame = () => {\n      confetti({\n        particleCount: 3,\n        angle: 60,\n        spread: 55,\n        origin: { x: 0 },\n        colors: ['#6366f1', '#8b5cf6', '#a855f7'],\n      });\n      confetti({\n        particleCount: 3,\n        angle: 120,\n        spread: 55,\n        origin: { x: 1 },\n        colors: ['#6366f1', '#8b5cf6', '#a855f7'],\n      });\n\n      if (Date.now() < end) {\n        requestAnimationFrame(frame);\n      }\n    };\n    frame();\n  };\n\n  const handleSocialLogin = (provider: \"google\" | \"github\" | \"facebook\") => {\n    if (!isProviderAvailable(provider)) {\n      setError(\"This sign-up method is not currently available.\");\n      return;\n    }\n    window.location.href = `/api/auth/${provider}`;\n  };\n\n  const validateForm = (): string | null => {\n    if (username.length < 3) {\n      return \"Username must be at least 3 characters\";\n    }\n    if (!/^[a-zA-Z]/.test(username)) {\n      return \"Username must start with a letter\";\n    }\n    if (!/^[a-zA-Z0-9_]+$/.test(username)) {\n      return \"Username can only contain letters, numbers, and underscores\";\n    }\n    if (password !== confirmPassword) {\n      return \"Passwords do not match\";\n    }\n    if (password.length < 8) {\n      return \"Password must be at least 8 characters\";\n    }\n    if (!/[A-Z]/.test(password)) {\n      return \"Password must contain at least one uppercase letter\";\n    }\n    if (!/[a-z]/.test(password)) {\n      return \"Password must contain at least one lowercase letter\";\n    }\n    if (!/[0-9]/.test(password)) {\n      return \"Password must contain at least one number\";\n    }\n    if (!/[^A-Za-z0-9]/.test(password)) {\n      return \"Password must contain at least one special character\";\n    }\n    return null;\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(\"\");\n\n    const validationError = validateForm();\n    if (validationError) {\n      setError(validationError);\n      return;\n    }\n\n    setIsLoading(true);\n\n    try {\n      await register(username, email, password);\n      setIsSuccess(true);\n      triggerSuccessConfetti();\n      setTimeout(() => setLocation(\"/\"), 1500);\n    } catch (err: any) {\n      setError(err.message || \"Registration failed. Please try again.\");\n      setIsLoading(false);\n    }\n  };\n\n  const passwordsMatch = password && confirmPassword && password === confirmPassword;\n  const passwordsDontMatch = password && confirmPassword && password !== confirmPassword;\n\n  return (\n    <AuthLayout\n      title=\"Join TypeMasterAI\"\n      subtitle=\"Create an account to track your progress, compete on global leaderboards, and unlock AI-powered typing practice with personalized feedback.\"\n    >\n      <AuthPanel>\n        <form onSubmit={handleSubmit}>\n          <AuthPanelHeader\n            title=\"Create Account\"\n            description=\"Sign up to start improving your typing skills\"\n          />\n          \n          <AuthPanelContent>\n            <AnimatePresence mode=\"wait\">\n              {error && (\n                <motion.div\n                  initial={{ opacity: 0, y: -10, scale: 0.95 }}\n                  animate={{ opacity: 1, y: 0, scale: 1 }}\n                  exit={{ opacity: 0, y: -10, scale: 0.95 }}\n                  transition={{ duration: 0.2 }}\n                >\n                  <Alert variant=\"destructive\" className=\"bg-red-500/10 border-red-500/30\">\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <AlertDescription>{error}</AlertDescription>\n                  </Alert>\n                </motion.div>\n              )}\n            </AnimatePresence>\n\n            {anyProviderAvailable && (\n              <motion.div \n                className=\"grid gap-3\"\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                transition={{ delay: 0.1 }}\n              >\n                {isProviderAvailable(\"google\") && (\n                  <SocialButton\n                    provider=\"google\"\n                    onClick={() => handleSocialLogin(\"google\")}\n                    isRegister\n                    delay={1}\n                    disabled={isLoading}\n                  />\n                )}\n                {isProviderAvailable(\"github\") && (\n                  <SocialButton\n                    provider=\"github\"\n                    onClick={() => handleSocialLogin(\"github\")}\n                    isRegister\n                    delay={2}\n                    disabled={isLoading}\n                  />\n                )}\n                {isProviderAvailable(\"facebook\") && (\n                  <SocialButton\n                    provider=\"facebook\"\n                    onClick={() => handleSocialLogin(\"facebook\")}\n                    isRegister\n                    delay={3}\n                    disabled={isLoading}\n                  />\n                )}\n              </motion.div>\n            )}\n\n            {anyProviderAvailable && <AuthDivider />}\n\n            <AuthInput\n              label=\"Username\"\n              type=\"text\"\n              placeholder=\"johndoe\"\n              value={username}\n              onChange={(e) => setUsername(e.target.value)}\n              required\n              data-testid=\"input-username\"\n              tooltip=\"3-30 characters. Letters, numbers, and underscores only. Must start with a letter.\"\n              icon={<User className=\"h-4 w-4\" />}\n              delay={4}\n              success={username.length >= 3 && /^[a-zA-Z][a-zA-Z0-9_]*$/.test(username)}\n            />\n\n            <AuthInput\n              label=\"Email\"\n              type=\"email\"\n              placeholder=\"you@example.com\"\n              value={email}\n              onChange={(e) => setEmail(e.target.value)}\n              required\n              data-testid=\"input-email\"\n              tooltip=\"We'll use this for account verification and password recovery\"\n              icon={<Mail className=\"h-4 w-4\" />}\n              delay={5}\n            />\n\n            <div className=\"space-y-2\">\n              <AuthInput\n                label=\"Password\"\n                type=\"password\"\n                placeholder=\"Create a strong password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                onKeyDown={handleKeyDown}\n                required\n                data-testid=\"input-password\"\n                icon={<Lock className=\"h-4 w-4\" />}\n                delay={6}\n              />\n              \n              <AnimatePresence>\n                <CapsLockWarning show={capsLockOn} />\n              </AnimatePresence>\n            </div>\n\n            <AuthInput\n              label=\"Confirm Password\"\n              type=\"password\"\n              placeholder=\"Re-enter your password\"\n              value={confirmPassword}\n              onChange={(e) => setConfirmPassword(e.target.value)}\n              onKeyDown={handleKeyDown}\n              required\n              data-testid=\"input-confirm-password\"\n              tooltip=\"Re-enter your password to make sure it matches\"\n              icon={<Lock className=\"h-4 w-4\" />}\n              delay={7}\n              success={!!passwordsMatch}\n              error={passwordsDontMatch ? \"Passwords don't match\" : undefined}\n            />\n          </AuthPanelContent>\n          \n          <AuthPanelFooter>\n            <div className=\"space-y-4\">\n              <SubmitButton\n                isLoading={isLoading}\n                isSuccess={isSuccess}\n                disabled={isLoading || isSuccess}\n              >\n                Create Account\n              </SubmitButton>\n\n              <AuthLink\n                text=\"Already have an account?\"\n                linkText=\"Sign in\"\n                onClick={() => setLocation(\"/login\")}\n                testId=\"link-login\"\n              />\n\n              <motion.p \n                className=\"text-xs text-center text-muted-foreground\"\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n                transition={{ delay: 0.6 }}\n              >\n                By signing up, you agree to our{\" \"}\n                <button type=\"button\" className=\"text-primary hover:underline\">Terms of Service</button>\n                {\" \"}and{\" \"}\n                <button type=\"button\" className=\"text-primary hover:underline\">Privacy Policy</button>\n              </motion.p>\n            </div>\n          </AuthPanelFooter>\n        </form>\n      </AuthPanel>\n    </AuthLayout>\n  );\n}\n","path":null,"size_bytes":11263,"size_tokens":null},"server/index-dev.ts":{"content":"import fs from \"node:fs\";\nimport { type Server } from \"node:http\";\nimport path from \"node:path\";\n\nimport type { Express } from \"express\";\nimport { nanoid } from \"nanoid\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\n\nimport runApp from \"./app\";\n\nimport viteConfig from \"../vite.config\";\n\nconst viteLogger = createLogger();\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\n(async () => {\n  await runApp(setupVite);\n})();\n","path":null,"size_bytes":1609,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationLink,\n  PaginationItem,\n  PaginationPrevious,\n  PaginationNext,\n  PaginationEllipsis,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"grid place-content-center peer h-4 w-4 shrink-0 rounded-sm border border-primary shadow focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"grid place-content-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1031,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4419,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-10 px-2 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\n      \"p-2 align-middle [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]\",\n      className\n    )}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2859,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue | null>(null)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  if (!itemContext) {\n    throw new Error(\"useFormField should be used within <FormItem>\")\n  }\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue | null>(null)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-[0.8rem] text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-[0.8rem] font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4175,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport tailwindcss from \"@tailwindcss/vite\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\nimport { metaImagesPlugin } from \"./vite-plugin-meta-images\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    tailwindcss(),\n    metaImagesPlugin(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  css: {\n    postcss: {\n      plugins: [],\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    host: \"0.0.0.0\",\n    allowedHosts: true,\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":1330,"size_tokens":null},"server/storage.ts":{"content":"import { drizzle } from \"drizzle-orm/neon-serverless\";\nimport { Pool, neonConfig } from \"@neondatabase/serverless\";\nimport ws from \"ws\";\nimport crypto from \"node:crypto\";\nimport {\n  users,\n  testResults,\n  conversations,\n  messages,\n  typingParagraphs,\n  keystrokeAnalytics,\n  races,\n  raceParticipants,\n  codeSnippets,\n  codeTypingTests,\n  sharedCodeResults,\n  sharedResults,\n  books,\n  bookParagraphs,\n  bookTypingTests,\n  dictationSentences,\n  dictationTests,\n  stressTests,\n  keystrokeEvents,\n  typingAnalytics,\n  typingInsights,\n  practiceRecommendations,\n  type User,\n  type InsertUser,\n  type TestResult,\n  type InsertTestResult,\n  type Conversation,\n  type InsertConversation,\n  type Message,\n  type InsertMessage,\n  type TypingParagraph,\n  type InsertTypingParagraph,\n  type KeystrokeAnalytics,\n  type InsertKeystrokeAnalytics,\n  type Race,\n  type InsertRace,\n  type RaceParticipant,\n  type InsertRaceParticipant,\n  type CodeSnippet,\n  type InsertCodeSnippet,\n  type CodeTypingTest,\n  type InsertCodeTypingTest,\n  type SharedCodeResult,\n  type InsertSharedCodeResult,\n  type SharedResult,\n  type InsertSharedResult,\n  type Book,\n  type InsertBook,\n  type BookParagraph,\n  type InsertBookParagraph,\n  type BookTypingTest,\n  type InsertBookTypingTest,\n  type DictationSentence,\n  type InsertDictationSentence,\n  type DictationTest,\n  type InsertDictationTest,\n  type StressTest,\n  type InsertStressTest,\n  type KeystrokeEvent,\n  type InsertKeystrokeEvent,\n  type TypingAnalytics,\n  type InsertTypingAnalytics,\n  type TypingInsight,\n  type InsertTypingInsight,\n  type PracticeRecommendation,\n  type InsertPracticeRecommendation,\n  pushSubscriptions,\n  notificationPreferences,\n  notificationHistory,\n  notificationJobs,\n  achievements,\n  userAchievements,\n  challenges,\n  userChallenges,\n  userGamification,\n  type PushSubscription,\n  type InsertPushSubscription,\n  type NotificationPreferences,\n  type InsertNotificationPreferences,\n  type NotificationHistory,\n  type InsertNotificationHistory,\n  type NotificationJob,\n  type InsertNotificationJob,\n  type Achievement,\n  type InsertAchievement,\n  type UserAchievement,\n  type InsertUserAchievement,\n  type Challenge,\n  type InsertChallenge,\n  type UserChallenge,\n  type InsertUserChallenge,\n  type UserGamification,\n  type InsertUserGamification,\n  loginHistory,\n  accountLockouts,\n  emailVerificationTokens,\n  passwordResetTokens,\n  userSessions,\n  securitySettings,\n  oauthAccounts,\n  persistentLogins,\n  oauthStates,\n  auditLogs,\n  type LoginHistory,\n  type InsertLoginHistory,\n  type AccountLockout,\n  type InsertAccountLockout,\n  type EmailVerificationToken,\n  type InsertEmailVerificationToken,\n  type PasswordResetToken,\n  type InsertPasswordResetToken,\n  type UserSession,\n  type InsertUserSession,\n  type SecuritySettings,\n  type InsertSecuritySettings,\n  type OAuthAccount,\n  type InsertOAuthAccount,\n  type OAuthProvider,\n  type PersistentLogin,\n  type InsertPersistentLogin,\n  type OAuthState,\n  type InsertOAuthState,\n  type AuditLog,\n  type InsertAuditLog,\n  userRatings,\n  raceMatchHistory,\n  raceKeystrokes,\n  raceChatMessages,\n  raceSpectators,\n  raceReplays,\n  antiCheatChallenges,\n  type UserRating,\n  type InsertUserRating,\n  type RaceMatchHistory,\n  type InsertRaceMatchHistory,\n  type RaceKeystrokes,\n  type InsertRaceKeystrokes,\n  type RaceChatMessage,\n  type InsertRaceChatMessage,\n  type RaceSpectator,\n  type InsertRaceSpectator,\n  type RaceReplay,\n  type InsertRaceReplay,\n  type AntiCheatChallenge,\n  type InsertAntiCheatChallenge,\n  feedbackCategories,\n  feedback,\n  feedbackAttachments,\n  feedbackResponses,\n  feedbackStatusHistory,\n  feedbackAnalytics,\n  feedbackUpvotes,\n  feedbackRateLimits,\n  feedbackAdmins,\n  type FeedbackCategory,\n  type InsertFeedbackCategory,\n  type Feedback,\n  type InsertFeedback,\n  type FeedbackAttachment,\n  type InsertFeedbackAttachment,\n  type FeedbackResponse,\n  type InsertFeedbackResponse,\n  type FeedbackStatusHistory,\n  type InsertFeedbackStatusHistory,\n  type FeedbackAnalytics,\n  type InsertFeedbackAnalytics,\n  type FeedbackUpvote,\n  type InsertFeedbackUpvote,\n  type FeedbackAdmin,\n  type InsertFeedbackAdmin,\n  certificates,\n  type Certificate,\n  type InsertCertificate,\n} from \"@shared/schema\";\nimport { eq, desc, sql, and, notInArray, or, isNull } from \"drizzle-orm\";\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nconst pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle({ client: pool });\n\nexport interface IStorage {\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUserProfile(userId: string, profile: Partial<User>): Promise<User>;\n  updateUserPassword(userId: string, hashedPassword: string): Promise<void>;\n  deleteUser(userId: string): Promise<void>;\n  verifyUserEmail(userId: string): Promise<void>;\n  \n  // Login History & Security\n  createLoginHistory(history: InsertLoginHistory): Promise<LoginHistory>;\n  getUserLoginHistory(userId: string, limit?: number): Promise<LoginHistory[]>;\n  getRecentFailedLogins(userId: string, minutes: number): Promise<LoginHistory[]>;\n  handleFailedLoginTransaction(\n    userId: string,\n    email: string,\n    req: any,\n    reason: string,\n    windowMinutes: number,\n    maxAttempts: number,\n    lockoutMinutes: number\n  ): Promise<void>;\n  \n  // Account Lockout\n  getAccountLockout(userId: string): Promise<AccountLockout | undefined>;\n  createOrUpdateAccountLockout(userId: string, failedAttempts: number, lockedUntil?: Date): Promise<AccountLockout>;\n  clearAccountLockout(userId: string): Promise<void>;\n  isAccountLocked(userId: string): Promise<boolean>;\n  \n  // Email Verification\n  createEmailVerificationToken(userId: string, token: string, expiresAt: Date): Promise<EmailVerificationToken>;\n  getEmailVerificationToken(token: string): Promise<EmailVerificationToken | undefined>;\n  markEmailVerified(userId: string, token: string): Promise<void>;\n  deleteEmailVerificationToken(userId: string): Promise<void>;\n  \n  // Password Reset (with secure token hashing)\n  createPasswordResetToken(userId: string, token: string, expiresAt: Date, ipAddress?: string): Promise<PasswordResetToken>;\n  getPasswordResetTokenByHash(tokenHash: string): Promise<PasswordResetToken | undefined>;\n  getPasswordResetToken(token: string): Promise<PasswordResetToken | undefined>;\n  markPasswordResetTokenUsed(tokenHash: string): Promise<void>;\n  incrementTokenFailedAttempts(tokenHash: string): Promise<{ failedAttempts: number; locked: boolean }>;\n  deletePasswordResetTokens(userId: string): Promise<void>;\n  atomicPasswordReset(tokenHash: string, userId: string, hashedPassword: string): Promise<{ success: boolean; alreadyUsed: boolean }>;\n  cleanupUsedPasswordResetTokens(userId: string): Promise<void>;\n  getRecentPasswordResetRequests(userId: string, minutes: number): Promise<number>;\n  \n  // User Sessions\n  createUserSession(session: InsertUserSession): Promise<UserSession>;\n  getUserSessions(userId: string): Promise<UserSession[]>;\n  updateSessionActivity(sessionId: string): Promise<void>;\n  revokeSession(sessionId: string): Promise<void>;\n  revokeAllUserSessions(userId: string, exceptSessionId?: string): Promise<void>;\n  \n  // Security Settings\n  getSecuritySettings(userId: string): Promise<SecuritySettings | undefined>;\n  createSecuritySettings(userId: string): Promise<SecuritySettings>;\n  updateSecuritySettings(userId: string, settings: Partial<SecuritySettings>): Promise<SecuritySettings>;\n  enable2FA(userId: string, secret: string, backupCodes: string[]): Promise<void>;\n  disable2FA(userId: string): Promise<void>;\n  verify2FABackupCode(userId: string, code: string): Promise<boolean>;\n  use2FABackupCode(userId: string, code: string): Promise<void>;\n  \n  createTestResult(result: InsertTestResult): Promise<TestResult>;\n  getUserTestResults(userId: string, limit?: number): Promise<TestResult[]>;\n  getTestResultById(testResultId: number): Promise<TestResult | undefined>;\n  verifyTestResultOwnership(testResultId: number, userId: string): Promise<boolean>;\n  getUserStats(userId: string): Promise<{\n    totalTests: number;\n    bestWpm: number;\n    avgWpm: number;\n    avgAccuracy: number;\n  } | null>;\n  getLeaderboard(limit?: number, language?: string): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    createdAt: Date;\n    mode: number;\n    avatarColor: string | null;\n    totalTests: number;\n  }>>;\n\n  getLeaderboardPaginated(limit: number, offset: number, timeframe?: string, language?: string): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    createdAt: Date;\n    mode: number;\n    avatarColor: string | null;\n    totalTests: number;\n    rank: number;\n    isVerified: boolean;\n  }>>;\n  getLeaderboardCount(timeframe?: string, language?: string): Promise<number>;\n  getLeaderboardAroundUser(userId: string, range?: number, timeframe?: string, language?: string): Promise<{ userRank: number; entries: any[] }>;\n\n  getStressTestLeaderboardPaginated(difficulty: string | undefined, limit: number, offset: number): Promise<Array<{\n    userId: string;\n    username: string;\n    difficulty: string;\n    stressScore: number;\n    wpm: number;\n    accuracy: number;\n    completionRate: number;\n    avatarColor: string | null;\n    createdAt: Date;\n    rank: number;\n    isVerified: boolean;\n  }>>;\n  getStressTestLeaderboardCount(difficulty?: string): Promise<number>;\n  getStressLeaderboardAroundUser(userId: string, difficulty: string | undefined, range?: number): Promise<{ userRank: number; entries: any[] }>;\n\n  getCodeLeaderboardPaginated(language: string | undefined, limit: number, offset: number): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    programmingLanguage: string;\n    framework: string | null;\n    createdAt: Date;\n    avatarColor: string | null;\n    totalTests: number;\n    rank: number;\n    isVerified: boolean;\n  }>>;\n  getCodeLeaderboardCount(language?: string): Promise<number>;\n  getCodeLeaderboardAroundUser(userId: string, language: string | undefined, range?: number): Promise<{ userRank: number; entries: any[] }>;\n\n  getRatingLeaderboardPaginated(tier: string | undefined, limit: number, offset: number): Promise<any[]>;\n  getRatingLeaderboardCount(tier?: string): Promise<number>;\n  getRatingLeaderboardAroundUser(userId: string, tier: string | undefined, range?: number): Promise<{ userRank: number; entries: any[] }>;\n\n  getDictationLeaderboardPaginated(limit: number, offset: number): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    speedLevel: string;\n    createdAt: Date;\n    avatarColor: string | null;\n    totalTests: number;\n    rank: number;\n  }>>;\n  getDictationLeaderboardCount(): Promise<number>;\n  getDictationLeaderboardAroundUser(userId: string, range?: number): Promise<{ userRank: number; entries: any[] }>;\n\n  getTimeBasedLeaderboard(timeframe: \"daily\" | \"weekly\" | \"monthly\", limit: number, offset: number): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    createdAt: Date;\n    avatarColor: string | null;\n    testsInPeriod: number;\n    rank: number;\n  }>>;\n  getTimeBasedLeaderboardCount(timeframe: \"daily\" | \"weekly\" | \"monthly\"): Promise<number>;\n  \n  getPlatformStats(): Promise<{\n    totalUsers: number;\n    totalTests: number;\n    totalLanguages: number;\n  }>;\n  \n  createConversation(conversation: InsertConversation): Promise<Conversation>;\n  getUserConversations(userId: string): Promise<Conversation[]>;\n  getConversation(id: number, userId: string): Promise<Conversation | undefined>;\n  updateConversation(id: number, userId: string, data: Partial<Conversation>): Promise<Conversation | undefined>;\n  deleteConversation(id: number, userId: string): Promise<void>;\n  \n  createMessage(message: InsertMessage): Promise<Message>;\n  getConversationMessages(conversationId: number): Promise<Message[]>;\n  \n  getRandomParagraph(language: string, mode?: string, difficulty?: string): Promise<TypingParagraph | undefined>;\n  getRandomParagraphs(language: string, count: number, mode?: string, difficulty?: string): Promise<TypingParagraph[]>;\n  getExactParagraph(language: string, mode: string, difficulty?: string): Promise<TypingParagraph | undefined>;\n  getAvailableLanguages(): Promise<string[]>;\n  getAvailableModes(): Promise<string[]>;\n  createTypingParagraph(paragraph: InsertTypingParagraph): Promise<TypingParagraph>;\n  \n  saveKeystrokeAnalytics(keystroke: InsertKeystrokeAnalytics): Promise<KeystrokeAnalytics>;\n  saveBulkKeystrokeAnalytics(keystrokes: InsertKeystrokeAnalytics[]): Promise<void>;\n  getUserAnalytics(userId: string, days?: number): Promise<{\n    wpmOverTime: Array<{ date: string; wpm: number; accuracy: number; testCount: number }>;\n    mistakesHeatmap: Array<{ key: string; errorCount: number; totalCount: number; errorRate: number }>;\n    consistency: {\n      avgWpm: number;\n      stdDeviation: number;\n      minWpm: number;\n      maxWpm: number;\n    };\n    commonMistakes: Array<{ expectedKey: string; typedKey: string; count: number }>;\n  }>;\n  \n  getHistoricalTrends(userId: string): Promise<{\n    weeklyAggregates: Array<{\n      weekStart: string;\n      weekEnd: string;\n      avgWpm: number;\n      avgAccuracy: number;\n      testCount: number;\n      bestWpm: number;\n    }>;\n    monthlyAggregates: Array<{\n      month: string;\n      avgWpm: number;\n      avgAccuracy: number;\n      testCount: number;\n      bestWpm: number;\n    }>;\n    improvement: {\n      weekOverWeek: { wpm: number; accuracy: number };\n      monthOverMonth: { wpm: number; accuracy: number };\n      allTime: { firstWpm: number; currentWpm: number; improvementPercent: number };\n    };\n    milestones: Array<{\n      type: string;\n      value: number;\n      achievedAt: string;\n    }>;\n  }>;\n  \n  getUserBadgeData(userId: string): Promise<{\n    bestWpm: number;\n    bestAccuracy: number;\n    totalTests: number;\n    currentStreak: number;\n    bestStreak: number;\n  }>;\n  updateUserStreak(userId: string): Promise<void>;\n  \n  // Multiplayer Racing\n  createRace(race: InsertRace): Promise<Race>;\n  getRace(id: number): Promise<Race | undefined>;\n  getRaceByCode(roomCode: string): Promise<Race | undefined>;\n  updateRaceStatus(id: number, status: string, startedAt?: Date, finishedAt?: Date): Promise<void>;\n  updateRaceTimeLimitSeconds(id: number, timeLimitSeconds: number): Promise<void>;\n  extendRaceParagraph(id: number, additionalContent: string): Promise<Race | undefined>;\n  getActiveRaces(): Promise<Race[]>;\n  \n  createRaceParticipant(participant: InsertRaceParticipant): Promise<RaceParticipant>;\n  getRaceParticipants(raceId: number): Promise<RaceParticipant[]>;\n  updateParticipantProgress(id: number, progress: number, wpm: number, accuracy: number, errors: number): Promise<void>;\n  updateParticipantFinishPosition(id: number, position: number): Promise<void>;\n  finishParticipant(id: number): Promise<{ position: number; isNewFinish: boolean }>;\n  deleteRaceParticipant(id: number): Promise<void>;\n  reactivateRaceParticipant(id: number): Promise<RaceParticipant>;\n  findInactiveParticipant(raceId: number, userId?: string, guestName?: string): Promise<RaceParticipant | undefined>;\n  getRaceWithParticipants(raceId: number): Promise<{ race: Race; participants: RaceParticipant[] } | undefined>;\n  \n  // Scalability methods for race cache\n  getStaleRaces(waitingTimeout: number, countdownTimeout: number, racingTimeout: number): Promise<Race[]>;\n  cleanupOldFinishedRaces(retentionMs: number): Promise<number>;\n  bulkUpdateParticipantProgress(updates: Map<number, { progress: number; wpm: number; accuracy: number; errors: number }>): Promise<void>;\n  \n  createCodeSnippet(snippet: InsertCodeSnippet): Promise<CodeSnippet>;\n  getCodeSnippet(id: number): Promise<CodeSnippet | undefined>;\n  getRandomCodeSnippet(language: string, difficulty?: string, framework?: string): Promise<CodeSnippet | undefined>;\n  getAvailableProgrammingLanguages(): Promise<string[]>;\n  getAvailableFrameworks(language?: string): Promise<string[]>;\n  \n  createCodeTypingTest(test: InsertCodeTypingTest): Promise<CodeTypingTest>;\n  getUserCodeTypingTests(userId: string, limit?: number): Promise<CodeTypingTest[]>;\n  getUserCodeStats(userId: string, language?: string): Promise<{\n    totalTests: number;\n    bestWpm: number;\n    avgWpm: number;\n    avgAccuracy: number;\n    totalSyntaxErrors: number;\n  } | null>;\n  getCodeLeaderboard(language?: string, limit?: number): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    programmingLanguage: string;\n    framework: string | null;\n    createdAt: Date;\n    avatarColor: string | null;\n    totalTests: number;\n  }>>;\n  createSharedCodeResult(result: InsertSharedCodeResult): Promise<SharedCodeResult>;\n  getSharedCodeResult(shareId: string): Promise<SharedCodeResult | undefined>;\n  \n  getBookParagraphs(filters: { difficulty?: string; topic?: string; durationMode?: number; limit?: number }): Promise<BookParagraph[]>;\n  getRandomBookParagraph(filters?: { difficulty?: string; topic?: string; durationMode?: number }): Promise<BookParagraph | null>;\n  getBookTopics(): Promise<string[]>;\n  getBookParagraphById(id: number): Promise<BookParagraph | null>;\n  getNextBookParagraph(bookId: number, currentParagraphIndex: number): Promise<BookParagraph | null>;\n  insertBook(book: InsertBook): Promise<void>;\n  insertBookParagraphs(paragraphs: InsertBookParagraph[]): Promise<void>;\n  getAllBooks(): Promise<Book[]>;\n  getBookById(id: number): Promise<Book | null>;\n  getBookBySlug(slug: string): Promise<Book | null>;\n  getBookChapters(bookId: number): Promise<Array<{ chapter: number; title: string | null; paragraphCount: number }>>;\n  getChapterParagraphs(bookId: number, chapter: number): Promise<BookParagraph[]>;\n  createBookTestResult(result: InsertBookTypingTest): Promise<BookTypingTest>;\n  getBookTestResults(userId: string, limit?: number): Promise<BookTypingTest[]>;\n  \n  getRandomDictationSentence(difficulty?: string, category?: string, excludeIds?: number[]): Promise<DictationSentence | undefined>;\n  createDictationTest(test: InsertDictationTest): Promise<DictationTest>;\n  getDictationTestById(testId: number): Promise<DictationTest | undefined>;\n  getUserDictationStats(userId: string): Promise<{\n    totalTests: number;\n    bestWpm: number;\n    avgWpm: number;\n    avgAccuracy: number;\n    totalReplays: number;\n  } | null>;\n  getDictationLeaderboard(limit?: number): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    speedLevel: string;\n    createdAt: Date;\n    avatarColor: string | null;\n    totalTests: number;\n  }>>;\n  \n  createStressTest(test: InsertStressTest): Promise<StressTest>;\n  upsertStressTestBestScore(test: InsertStressTest): Promise<{ result: StressTest; isNewPersonalBest: boolean }>;\n  getUserStressTests(userId: string, limit?: number): Promise<StressTest[]>;\n  getStressTestLeaderboard(difficulty?: string, limit?: number): Promise<Array<{\n    userId: string;\n    username: string;\n    difficulty: string;\n    stressScore: number;\n    wpm: number;\n    accuracy: number;\n    completionRate: number;\n    avatarColor: string | null;\n    createdAt: Date;\n    rank: number;\n  }>>;\n  getUserStressStats(userId: string): Promise<{\n    totalTests: number;\n    bestScore: number;\n    avgScore: number;\n    completedTests: number;\n    difficultiesCompleted: string[];\n  } | null>;\n  \n  createSharedResult(result: InsertSharedResult): Promise<SharedResult>;\n  getSharedResult(shareToken: string): Promise<SharedResult | undefined>;\n  incrementShareViewCount(shareToken: string): Promise<void>;\n  \n  saveKeystrokeEvents(events: InsertKeystrokeEvent[]): Promise<void>;\n  saveTypingAnalytics(analytics: InsertTypingAnalytics): Promise<TypingAnalytics>;\n  getUserTypingAnalytics(userId: string, limit?: number): Promise<TypingAnalytics[]>;\n  getTypingAnalyticsById(id: number): Promise<TypingAnalytics | undefined>;\n  saveTypingInsight(insight: InsertTypingInsight): Promise<TypingInsight>;\n  getUserTypingInsights(userId: string): Promise<TypingInsight[]>;\n  dismissInsight(insightId: number): Promise<void>;\n  savePracticeRecommendation(recommendation: InsertPracticeRecommendation): Promise<PracticeRecommendation>;\n  getUserPracticeRecommendations(userId: string): Promise<PracticeRecommendation[]>;\n  completePracticeRecommendation(recommendationId: number): Promise<void>;\n  \n  createPushSubscription(subscription: InsertPushSubscription): Promise<PushSubscription>;\n  getUserPushSubscriptions(userId: string): Promise<PushSubscription[]>;\n  deletePushSubscription(id: number): Promise<void>;\n  findExistingSubscription(userId: string, endpoint: string): Promise<PushSubscription | undefined>;\n  \n  getNotificationPreferences(userId: string): Promise<NotificationPreferences | undefined>;\n  createNotificationPreferences(prefs: InsertNotificationPreferences): Promise<NotificationPreferences>;\n  updateNotificationPreferences(userId: string, prefs: Partial<NotificationPreferences>): Promise<NotificationPreferences>;\n  \n  createNotificationHistory(history: InsertNotificationHistory): Promise<NotificationHistory>;\n  getUserNotificationHistory(userId: string, limit?: number): Promise<NotificationHistory[]>;\n  markNotificationDelivered(id: number): Promise<void>;\n  markNotificationClicked(id: number): Promise<void>;\n  \n  createNotificationJobs(jobs: InsertNotificationJob[]): Promise<NotificationJob[]>;\n  claimDueNotificationJobs(beforeUtc: Date, limit: number): Promise<NotificationJob[]>;\n  markJobCompleted(jobId: number): Promise<void>;\n  markJobFailed(jobId: number, errorMessage: string): Promise<void>;\n  rescheduleJob(jobId: number, newSendAtUtc: Date): Promise<void>;\n  deleteCompletedJobsOlderThan(daysAgo: number): Promise<number>;\n  \n  getUsersWithNotificationPreferences(notificationType: string, offset: number, limit: number): Promise<Array<{\n    user: User;\n    preferences: NotificationPreferences;\n  }>>;\n  getUsersForDailyReminders(currentHour: number): Promise<Array<{ id: string; username: string; currentStreak: number }>>;\n  getUsersWithStreakAtRisk(): Promise<Array<{ id: string; username: string; currentStreak: number }>>;\n  getUsersForWeeklySummary(): Promise<Array<{ id: string; username: string }>>;\n  \n  getUserAverageWpm(userId: string): Promise<number>;\n  getWeeklySummaryStats(userId: string): Promise<{\n    testsCompleted: number;\n    avgWpm: number;\n    avgAccuracy: number;\n    improvement: number;\n    rank: number;\n  }>;\n  \n  createAchievement(achievement: InsertAchievement): Promise<Achievement>;\n  getAllAchievements(): Promise<Achievement[]>;\n  getAchievementByKey(key: string): Promise<Achievement | undefined>;\n  unlockAchievement(userId: string, achievementId: number, testResultId?: number): Promise<UserAchievement>;\n  getUserAchievements(userId: string): Promise<Array<UserAchievement & { achievement: Achievement }>>;\n  \n  createChallenge(challenge: InsertChallenge): Promise<Challenge>;\n  getActiveChallenge(type: 'daily' | 'weekly'): Promise<Challenge | undefined>;\n  getUserChallengeProgress(userId: string, challengeId: number): Promise<UserChallenge | undefined>;\n  updateChallengeProgress(userId: string, challengeId: number, progress: number): Promise<UserChallenge>;\n  completeChallenge(userId: string, challengeId: number): Promise<UserChallenge>;\n  \n  getUserGamification(userId: string): Promise<UserGamification | undefined>;\n  createUserGamification(gamification: InsertUserGamification): Promise<UserGamification>;\n  updateUserGamification(userId: string, updates: Partial<UserGamification>): Promise<UserGamification>;\n  \n  // OAuth Accounts\n  createOAuthAccount(account: InsertOAuthAccount): Promise<OAuthAccount>;\n  getOAuthAccount(provider: OAuthProvider, providerUserId: string): Promise<OAuthAccount | undefined>;\n  getUserOAuthAccounts(userId: string): Promise<OAuthAccount[]>;\n  linkOAuthAccount(userId: string, account: Omit<InsertOAuthAccount, 'userId'>): Promise<OAuthAccount>;\n  unlinkOAuthAccount(userId: string, provider: OAuthProvider): Promise<void>;\n  findUserByOAuthProvider(provider: OAuthProvider, providerUserId: string): Promise<User | undefined>;\n  \n  // Persistent Login (Remember Me)\n  createPersistentLogin(login: InsertPersistentLogin): Promise<PersistentLogin>;\n  getPersistentLogin(series: string): Promise<PersistentLogin | undefined>;\n  updatePersistentLoginToken(series: string, newTokenHash: string, lastUsed: Date): Promise<void>;\n  deletePersistentLogin(series: string): Promise<void>;\n  deleteAllUserPersistentLogins(userId: string): Promise<void>;\n  deleteExpiredPersistentLogins(): Promise<number>;\n  getUserPersistentLogins(userId: string): Promise<PersistentLogin[]>;\n  \n  // OAuth States (CSRF protection - database persisted for multi-instance support)\n  createOAuthState(state: InsertOAuthState): Promise<OAuthState>;\n  getOAuthState(state: string): Promise<OAuthState | undefined>;\n  deleteOAuthState(state: string): Promise<void>;\n  deleteExpiredOAuthStates(): Promise<number>;\n  \n  // Audit Logs (Security event tracking - database persisted for compliance)\n  createAuditLog(log: InsertAuditLog): Promise<AuditLog>;\n  getAuditLogs(filters?: { userId?: string; eventType?: string; limit?: number }): Promise<AuditLog[]>;\n  getUserAuditLogs(userId: string, limit?: number): Promise<AuditLog[]>;\n\n  // ============================================================================\n  // MULTIPLAYER RACING ENHANCED FEATURES\n  // ============================================================================\n\n  // User Rating (ELO System)\n  getUserRating(userId: string): Promise<UserRating | undefined>;\n  createUserRating(userId: string): Promise<UserRating>;\n  updateUserRating(userId: string, updates: Partial<UserRating>): Promise<UserRating>;\n  getOrCreateUserRating(userId: string): Promise<UserRating>;\n  getRatingLeaderboard(tier?: string, limit?: number): Promise<UserRating[]>;\n  getUsersForMatchmaking(targetRating: number, tolerance: number, excludeUserIds: string[]): Promise<UserRating[]>;\n\n  // Race Match History\n  createRaceMatchHistory(history: InsertRaceMatchHistory): Promise<RaceMatchHistory>;\n  getRaceMatchHistory(raceId: number): Promise<RaceMatchHistory[]>;\n  getUserMatchHistory(userId: string, limit?: number): Promise<RaceMatchHistory[]>;\n\n  // Race Keystrokes (Anti-cheat & Replays)\n  saveRaceKeystrokes(keystrokes: InsertRaceKeystrokes): Promise<RaceKeystrokes>;\n  getRaceKeystrokes(raceId: number): Promise<RaceKeystrokes[]>;\n  getParticipantKeystrokes(participantId: number): Promise<RaceKeystrokes | undefined>;\n  getFlaggedKeystrokes(limit?: number): Promise<RaceKeystrokes[]>;\n\n  // Race Chat Messages\n  createRaceChatMessage(message: InsertRaceChatMessage): Promise<RaceChatMessage>;\n  getRaceChatMessages(raceId: number, limit?: number): Promise<RaceChatMessage[]>;\n\n  // Race Spectators\n  addRaceSpectator(spectator: InsertRaceSpectator): Promise<RaceSpectator>;\n  removeRaceSpectator(raceId: number, sessionId: string): Promise<void>;\n  getRaceSpectators(raceId: number): Promise<RaceSpectator[]>;\n  getActiveSpectatorCount(raceId: number): Promise<number>;\n\n  // Race Replays\n  createRaceReplay(replay: InsertRaceReplay): Promise<RaceReplay>;\n  getRaceReplay(raceId: number): Promise<RaceReplay | undefined>;\n  getPublicReplays(limit?: number): Promise<RaceReplay[]>;\n  incrementReplayViewCount(raceId: number): Promise<void>;\n\n  // Anti-Cheat Challenges\n  createAntiCheatChallenge(challenge: InsertAntiCheatChallenge): Promise<AntiCheatChallenge>;\n  getUserCertification(userId: string): Promise<AntiCheatChallenge | undefined>;\n  updateChallengePassed(challengeId: number, passed: boolean, wpm: number, certifiedWpm: number): Promise<void>;\n\n  // ============================================================================\n  // ENTERPRISE FEEDBACK SYSTEM\n  // ============================================================================\n\n  // Feedback Categories\n  getFeedbackCategories(): Promise<FeedbackCategory[]>;\n  getFeedbackCategoryById(id: number): Promise<FeedbackCategory | undefined>;\n  getFeedbackCategoryBySlug(slug: string): Promise<FeedbackCategory | undefined>;\n\n  // Feedback CRUD\n  createFeedback(feedbackData: InsertFeedback): Promise<Feedback>;\n  getFeedbackById(id: number): Promise<Feedback | undefined>;\n  getFeedbackPaginated(options: {\n    limit: number;\n    offset: number;\n    status?: string;\n    priority?: string;\n    categoryId?: number;\n    sentimentLabel?: string;\n    isSpam?: boolean;\n    isArchived?: boolean;\n    search?: string;\n    sortBy?: string;\n    sortOrder?: 'asc' | 'desc';\n  }): Promise<{ feedback: Feedback[]; total: number }>;\n  updateFeedback(id: number, updates: Partial<Feedback>): Promise<Feedback>;\n  updateFeedbackAiAnalysis(id: number, analysis: {\n    sentimentScore: number;\n    sentimentLabel: string;\n    aiCategoryId?: number;\n    aiSummary?: string;\n    aiPriorityScore?: number;\n    aiTags?: string[];\n  }): Promise<Feedback>;\n  markFeedbackResolved(id: number, resolvedByUserId: string, resolutionNotes?: string): Promise<Feedback>;\n  archiveFeedback(id: number): Promise<void>;\n  markFeedbackAsSpam(id: number): Promise<void>;\n\n  // Feedback Attachments\n  createFeedbackAttachment(attachment: InsertFeedbackAttachment): Promise<FeedbackAttachment>;\n  getFeedbackAttachments(feedbackId: number): Promise<FeedbackAttachment[]>;\n  deleteFeedbackAttachment(id: number): Promise<void>;\n\n  // Feedback Responses\n  createFeedbackResponse(response: InsertFeedbackResponse): Promise<FeedbackResponse>;\n  getFeedbackResponses(feedbackId: number): Promise<FeedbackResponse[]>;\n  updateFeedbackResponse(id: number, updates: Partial<FeedbackResponse>): Promise<FeedbackResponse>;\n\n  // Status History (Audit Trail)\n  recordFeedbackStatusHistory(history: InsertFeedbackStatusHistory): Promise<FeedbackStatusHistory>;\n  getFeedbackStatusHistory(feedbackId: number): Promise<FeedbackStatusHistory[]>;\n\n  // Upvotes\n  toggleFeedbackUpvote(feedbackId: number, userId: string): Promise<{ upvoted: boolean; newCount: number }>;\n  getUserFeedbackUpvotes(userId: string): Promise<FeedbackUpvote[]>;\n\n  // Rate Limiting\n  checkFeedbackRateLimit(identifier: string, identifierType: 'ip' | 'user'): Promise<{\n    allowed: boolean;\n    remaining: number;\n    resetAt: Date | null;\n    blockedUntil: Date | null;\n  }>;\n  recordFeedbackSubmission(identifier: string, identifierType: 'ip' | 'user'): Promise<void>;\n  blockFeedbackSubmitter(identifier: string, identifierType: 'ip' | 'user', reason: string, durationMinutes: number): Promise<void>;\n\n  // Admin Management\n  getFeedbackAdmin(userId: string): Promise<FeedbackAdmin | undefined>;\n  createFeedbackAdmin(admin: InsertFeedbackAdmin): Promise<FeedbackAdmin>;\n  updateFeedbackAdmin(userId: string, updates: Partial<FeedbackAdmin>): Promise<FeedbackAdmin>;\n  deleteFeedbackAdmin(userId: string): Promise<void>;\n  getAllFeedbackAdmins(): Promise<FeedbackAdmin[]>;\n\n  // Analytics\n  getFeedbackAnalyticsSummary(): Promise<{\n    totalFeedback: number;\n    newFeedback: number;\n    resolvedFeedback: number;\n    avgResolutionTimeHours: number | null;\n    sentimentBreakdown: { negative: number; neutral: number; positive: number };\n    priorityBreakdown: Record<string, number>;\n    categoryBreakdown: Record<string, number>;\n    statusBreakdown: Record<string, number>;\n  }>;\n  saveFeedbackAnalytics(analytics: InsertFeedbackAnalytics): Promise<FeedbackAnalytics>;\n\n  // ============================================================================\n  // CERTIFICATES\n  // ============================================================================\n  createCertificate(certificate: InsertCertificate): Promise<Certificate>;\n  getUserCertificates(userId: string, certificateType?: string, limit?: number, offset?: number): Promise<Certificate[]>;\n  getCertificateById(id: number): Promise<Certificate | undefined>;\n  getCertificateByShareId(shareId: string): Promise<Certificate | undefined>;\n  getCertificateByCodeTestId(codeTestId: number): Promise<Certificate | undefined>;\n  updateCertificateViewCount(id: number): Promise<void>;\n  deleteCertificate(id: number): Promise<void>;\n  getCodeTypingTestById(id: number): Promise<CodeTypingTest | undefined>;\n  getBookTypingTestById(id: number): Promise<BookTypingTest | undefined>;\n  getRaceParticipationByRaceAndUser(raceId: number, userId: string): Promise<RaceParticipant | undefined>;\n  getDictationTestById(id: number): Promise<DictationTest | undefined>;\n  getStressTestById(id: number): Promise<StressTest | undefined>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  async getUser(id: string): Promise<User | undefined> {\n    const result = await db.select().from(users).where(eq(users.id, id)).limit(1);\n    return result[0];\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const result = await db.select().from(users).where(eq(users.username, username)).limit(1);\n    return result[0];\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const result = await db.select().from(users).where(eq(users.email, email)).limit(1);\n    return result[0];\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    // Use transaction to create user and initialize account_lockouts row\n    return await db.transaction(async (tx) => {\n      const result = await tx.insert(users).values(insertUser).returning();\n      const newUser = result[0];\n      \n      // Pre-create account_lockouts row to enable row-level locking for concurrent failed logins\n      await tx.insert(accountLockouts).values({\n        userId: newUser.id,\n        failedAttempts: 0,\n        lockedUntil: null,\n        lastFailedAt: null,\n      });\n      \n      return newUser;\n    });\n  }\n\n  async updateUserProfile(userId: string, profile: Partial<User>): Promise<User> {\n    const result = await db\n      .update(users)\n      .set(profile)\n      .where(eq(users.id, userId))\n      .returning();\n    return result[0];\n  }\n\n  async updateUserPassword(userId: string, hashedPassword: string): Promise<void> {\n    await db\n      .update(users)\n      .set({ password: hashedPassword })\n      .where(eq(users.id, userId));\n  }\n\n  async deleteUser(userId: string): Promise<void> {\n    await db.delete(users).where(eq(users.id, userId));\n  }\n\n  async verifyUserEmail(userId: string): Promise<void> {\n    await db\n      .update(users)\n      .set({ emailVerified: true })\n      .where(eq(users.id, userId));\n  }\n\n  // Login History & Security\n  async createLoginHistory(history: InsertLoginHistory): Promise<LoginHistory> {\n    const inserted = await db.insert(loginHistory).values(history).returning();\n    return inserted[0];\n  }\n\n  async getUserLoginHistory(userId: string, limit: number = 20): Promise<LoginHistory[]> {\n    return await db\n      .select()\n      .from(loginHistory)\n      .where(eq(loginHistory.userId, userId))\n      .orderBy(desc(loginHistory.createdAt))\n      .limit(limit);\n  }\n\n  async getRecentFailedLogins(userId: string, minutes: number): Promise<LoginHistory[]> {\n    const cutoffTime = new Date(Date.now() - minutes * 60 * 1000);\n    return await db\n      .select()\n      .from(loginHistory)\n      .where(\n        and(\n          eq(loginHistory.userId, userId),\n          eq(loginHistory.success, false),\n          sql`${loginHistory.createdAt} > ${cutoffTime}`\n        )\n      )\n      .orderBy(desc(loginHistory.createdAt));\n  }\n\n  async handleFailedLoginTransaction(\n    userId: string,\n    email: string,\n    req: any,\n    reason: string,\n    windowMinutes: number,\n    maxAttempts: number,\n    lockoutMinutes: number\n  ): Promise<void> {\n    await db.transaction(async (tx) => {\n      // 1. Ensure account_lockouts row exists for this user (handles legacy users)\n      //    Try to lock the row; if it doesn't exist, create it\n      let lockoutRow = await tx\n        .select()\n        .from(accountLockouts)\n        .where(eq(accountLockouts.userId, userId))\n        .for('update')\n        .limit(1);\n\n      if (lockoutRow.length === 0) {\n        // Row doesn't exist (legacy user) - create it with conflict handling\n        // If a concurrent transaction already created it, DO NOTHING and proceed to lock\n        await tx\n          .insert(accountLockouts)\n          .values({\n            userId,\n            failedAttempts: 0,\n            lockedUntil: null,\n            lastFailedAt: null,\n          })\n          .onConflictDoNothing({ target: accountLockouts.userId });\n        \n        // Now lock the row (exists either from our insert or a concurrent one)\n        lockoutRow = await tx\n          .select()\n          .from(accountLockouts)\n          .where(eq(accountLockouts.userId, userId))\n          .for('update')\n          .limit(1);\n      }\n\n      // 2. Record the failed login attempt\n      await tx.insert(loginHistory).values({\n        userId,\n        email,\n        success: false,\n        ipAddress: (req.ip || req.headers['x-forwarded-for'] || 'unknown') as string,\n        userAgent: req.headers['user-agent'] || 'unknown',\n        deviceFingerprint: req.headers['x-device-fingerprint'] as string || null,\n        failureReason: reason,\n      });\n\n      // 3. Count recent failed attempts (now includes the one we just inserted)\n      const cutoffTime = new Date(Date.now() - windowMinutes * 60 * 1000);\n      const countResult = await tx\n        .select({ count: sql<number>`cast(count(*) as integer)` })\n        .from(loginHistory)\n        .where(\n          and(\n            eq(loginHistory.userId, userId),\n            eq(loginHistory.success, false),\n            sql`${loginHistory.createdAt} > ${cutoffTime}`\n          )\n        );\n\n      const failedAttempts = countResult[0]?.count || 0;\n\n      // 4. Update the locked row with accurate count and lockout status\n      const lockedUntil = failedAttempts >= maxAttempts\n        ? new Date(Date.now() + lockoutMinutes * 60 * 1000)\n        : null;\n\n      const now = new Date();\n      \n      await tx\n        .update(accountLockouts)\n        .set({\n          failedAttempts,\n          lockedUntil,\n          lastFailedAt: now,\n          updatedAt: now,\n        })\n        .where(eq(accountLockouts.userId, userId));\n    });\n  }\n\n  // Account Lockout\n  async getAccountLockout(userId: string): Promise<AccountLockout | undefined> {\n    const result = await db\n      .select()\n      .from(accountLockouts)\n      .where(eq(accountLockouts.userId, userId))\n      .limit(1);\n    return result[0];\n  }\n\n  async createOrUpdateAccountLockout(\n    userId: string,\n    failedAttempts: number,\n    lockedUntil?: Date\n  ): Promise<AccountLockout> {\n    const existing = await this.getAccountLockout(userId);\n    \n    if (existing) {\n      const updated = await db\n        .update(accountLockouts)\n        .set({\n          failedAttempts,\n          lockedUntil,\n          lastFailedAt: new Date(),\n          updatedAt: new Date(),\n        })\n        .where(eq(accountLockouts.userId, userId))\n        .returning();\n      return updated[0];\n    } else {\n      const inserted = await db\n        .insert(accountLockouts)\n        .values({\n          userId,\n          failedAttempts,\n          lockedUntil,\n          lastFailedAt: new Date(),\n        })\n        .returning();\n      return inserted[0];\n    }\n  }\n\n  async clearAccountLockout(userId: string): Promise<void> {\n    await db\n      .update(accountLockouts)\n      .set({\n        failedAttempts: 0,\n        lockedUntil: null,\n        lastFailedAt: null,\n        updatedAt: new Date(),\n      })\n      .where(eq(accountLockouts.userId, userId));\n  }\n\n  async isAccountLocked(userId: string): Promise<boolean> {\n    const lockout = await this.getAccountLockout(userId);\n    if (!lockout || !lockout.lockedUntil) {\n      return false;\n    }\n    return lockout.lockedUntil > new Date();\n  }\n\n  // Email Verification\n  async createEmailVerificationToken(\n    userId: string,\n    token: string,\n    expiresAt: Date\n  ): Promise<EmailVerificationToken> {\n    await db.delete(emailVerificationTokens).where(eq(emailVerificationTokens.userId, userId));\n    const inserted = await db\n      .insert(emailVerificationTokens)\n      .values({ userId, token, expiresAt })\n      .returning();\n    return inserted[0];\n  }\n\n  async getEmailVerificationToken(token: string): Promise<EmailVerificationToken | undefined> {\n    const result = await db\n      .select()\n      .from(emailVerificationTokens)\n      .where(eq(emailVerificationTokens.token, token))\n      .limit(1);\n    return result[0];\n  }\n\n  async markEmailVerified(userId: string, token: string): Promise<void> {\n    await db\n      .update(emailVerificationTokens)\n      .set({ verified: true, verifiedAt: new Date() })\n      .where(\n        and(\n          eq(emailVerificationTokens.userId, userId),\n          eq(emailVerificationTokens.token, token)\n        )\n      );\n    await this.verifyUserEmail(userId);\n  }\n\n  async deleteEmailVerificationToken(userId: string): Promise<void> {\n    await db\n      .delete(emailVerificationTokens)\n      .where(eq(emailVerificationTokens.userId, userId));\n  }\n\n  // Password Reset (with secure token hashing)\n  private hashToken(token: string): string {\n    return crypto.createHash(\"sha256\").update(token).digest(\"hex\");\n  }\n\n  async createPasswordResetToken(\n    userId: string,\n    token: string,\n    expiresAt: Date,\n    ipAddress?: string\n  ): Promise<PasswordResetToken> {\n    const tokenHash = this.hashToken(token);\n    const inserted = await db\n      .insert(passwordResetTokens)\n      .values({ userId, token: null, tokenHash, expiresAt, ipAddress, failedAttempts: 0 })\n      .returning();\n    return inserted[0];\n  }\n\n  async getPasswordResetTokenByHash(tokenHash: string): Promise<PasswordResetToken | undefined> {\n    const result = await db\n      .select()\n      .from(passwordResetTokens)\n      .where(eq(passwordResetTokens.tokenHash, tokenHash))\n      .limit(1);\n    return result[0];\n  }\n\n  async getPasswordResetToken(token: string): Promise<PasswordResetToken | undefined> {\n    const tokenHash = this.hashToken(token);\n    return this.getPasswordResetTokenByHash(tokenHash);\n  }\n\n  async markPasswordResetTokenUsed(tokenHash: string): Promise<void> {\n    await db\n      .update(passwordResetTokens)\n      .set({ used: true, usedAt: new Date() })\n      .where(eq(passwordResetTokens.tokenHash, tokenHash));\n  }\n\n  async incrementTokenFailedAttempts(tokenHash: string): Promise<{ failedAttempts: number; locked: boolean }> {\n    const MAX_FAILED_ATTEMPTS = 5;\n    const result = await db\n      .update(passwordResetTokens)\n      .set({ \n        failedAttempts: sql`${passwordResetTokens.failedAttempts} + 1`,\n        lockedAt: sql`CASE WHEN ${passwordResetTokens.failedAttempts} + 1 >= ${MAX_FAILED_ATTEMPTS} THEN NOW() ELSE ${passwordResetTokens.lockedAt} END`\n      })\n      .where(eq(passwordResetTokens.tokenHash, tokenHash))\n      .returning({ failedAttempts: passwordResetTokens.failedAttempts, lockedAt: passwordResetTokens.lockedAt });\n    \n    if (result.length === 0) {\n      return { failedAttempts: 0, locked: false };\n    }\n    return { \n      failedAttempts: result[0].failedAttempts, \n      locked: result[0].lockedAt !== null \n    };\n  }\n\n  async deletePasswordResetTokens(userId: string): Promise<void> {\n    await db\n      .delete(passwordResetTokens)\n      .where(eq(passwordResetTokens.userId, userId));\n  }\n\n  async atomicPasswordReset(\n    tokenHash: string, \n    userId: string, \n    hashedPassword: string\n  ): Promise<{ success: boolean; alreadyUsed: boolean }> {\n    return await db.transaction(async (tx) => {\n      const token = await tx\n        .select()\n        .from(passwordResetTokens)\n        .where(eq(passwordResetTokens.tokenHash, tokenHash))\n        .for(\"update\")\n        .limit(1);\n\n      if (!token || token.length === 0) {\n        return { success: false, alreadyUsed: false };\n      }\n\n      if (token[0].used) {\n        return { success: false, alreadyUsed: true };\n      }\n\n      await tx\n        .update(passwordResetTokens)\n        .set({ used: true, usedAt: new Date() })\n        .where(eq(passwordResetTokens.tokenHash, tokenHash));\n\n      await tx\n        .update(users)\n        .set({ password: hashedPassword })\n        .where(eq(users.id, userId));\n\n      await tx\n        .update(userSessions)\n        .set({ isActive: false })\n        .where(eq(userSessions.userId, userId));\n\n      return { success: true, alreadyUsed: false };\n    });\n  }\n\n  async cleanupUsedPasswordResetTokens(userId: string): Promise<void> {\n    await db\n      .delete(passwordResetTokens)\n      .where(\n        and(\n          eq(passwordResetTokens.userId, userId),\n          eq(passwordResetTokens.used, true)\n        )\n      );\n  }\n\n  async getRecentPasswordResetRequests(userId: string, minutes: number): Promise<number> {\n    const cutoffTime = new Date(Date.now() - minutes * 60 * 1000);\n    const result = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(passwordResetTokens)\n      .where(\n        and(\n          eq(passwordResetTokens.userId, userId),\n          sql`${passwordResetTokens.createdAt} >= ${cutoffTime}`\n        )\n      );\n    return Number(result[0]?.count || 0);\n  }\n\n  // User Sessions\n  async createUserSession(session: InsertUserSession): Promise<UserSession> {\n    const inserted = await db.insert(userSessions).values(session).returning();\n    return inserted[0];\n  }\n\n  async getUserSessions(userId: string): Promise<UserSession[]> {\n    return await db\n      .select()\n      .from(userSessions)\n      .where(\n        and(\n          eq(userSessions.userId, userId),\n          eq(userSessions.isActive, true)\n        )\n      )\n      .orderBy(desc(userSessions.lastActivity));\n  }\n\n  async updateSessionActivity(sessionId: string): Promise<void> {\n    await db\n      .update(userSessions)\n      .set({ lastActivity: new Date() })\n      .where(eq(userSessions.sessionId, sessionId));\n  }\n\n  async revokeSession(sessionId: string): Promise<void> {\n    await db\n      .update(userSessions)\n      .set({ isActive: false })\n      .where(eq(userSessions.sessionId, sessionId));\n  }\n\n  async revokeAllUserSessions(userId: string, exceptSessionId?: string): Promise<void> {\n    if (exceptSessionId) {\n      await db\n        .update(userSessions)\n        .set({ isActive: false })\n        .where(\n          and(\n            eq(userSessions.userId, userId),\n            sql`${userSessions.sessionId} != ${exceptSessionId}`\n          )\n        );\n    } else {\n      await db\n        .update(userSessions)\n        .set({ isActive: false })\n        .where(eq(userSessions.userId, userId));\n    }\n  }\n\n  // Security Settings\n  async getSecuritySettings(userId: string): Promise<SecuritySettings | undefined> {\n    const result = await db\n      .select()\n      .from(securitySettings)\n      .where(eq(securitySettings.userId, userId))\n      .limit(1);\n    return result[0];\n  }\n\n  async createSecuritySettings(userId: string): Promise<SecuritySettings> {\n    const inserted = await db\n      .insert(securitySettings)\n      .values({ userId })\n      .returning();\n    return inserted[0];\n  }\n\n  async updateSecuritySettings(\n    userId: string,\n    settings: Partial<SecuritySettings>\n  ): Promise<SecuritySettings> {\n    const updated = await db\n      .update(securitySettings)\n      .set({ ...settings, updatedAt: new Date() })\n      .where(eq(securitySettings.userId, userId))\n      .returning();\n    return updated[0];\n  }\n\n  async enable2FA(userId: string, secret: string, backupCodes: string[]): Promise<void> {\n    await db\n      .update(securitySettings)\n      .set({\n        twoFactorEnabled: true,\n        twoFactorSecret: secret,\n        backupCodes,\n        updatedAt: new Date(),\n      })\n      .where(eq(securitySettings.userId, userId));\n  }\n\n  async disable2FA(userId: string): Promise<void> {\n    await db\n      .update(securitySettings)\n      .set({\n        twoFactorEnabled: false,\n        twoFactorSecret: null,\n        backupCodes: null,\n        updatedAt: new Date(),\n      })\n      .where(eq(securitySettings.userId, userId));\n  }\n\n  async verify2FABackupCode(userId: string, code: string): Promise<boolean> {\n    const settings = await this.getSecuritySettings(userId);\n    if (!settings || !settings.backupCodes) {\n      return false;\n    }\n    return settings.backupCodes.includes(code);\n  }\n\n  async use2FABackupCode(userId: string, code: string): Promise<void> {\n    const settings = await this.getSecuritySettings(userId);\n    if (!settings || !settings.backupCodes) {\n      return;\n    }\n    const updatedCodes = settings.backupCodes.filter((c) => c !== code);\n    await db\n      .update(securitySettings)\n      .set({\n        backupCodes: updatedCodes,\n        updatedAt: new Date(),\n      })\n      .where(eq(securitySettings.userId, userId));\n  }\n\n  async createTestResult(result: InsertTestResult): Promise<TestResult> {\n    const inserted = await db.insert(testResults).values(result).returning();\n    return inserted[0];\n  }\n\n  async getUserTestResults(userId: string, limit: number = 10): Promise<TestResult[]> {\n    return await db\n      .select()\n      .from(testResults)\n      .where(eq(testResults.userId, userId))\n      .orderBy(desc(testResults.createdAt))\n      .limit(limit);\n  }\n\n  async getTestResultById(testResultId: number): Promise<TestResult | undefined> {\n    const result = await db\n      .select()\n      .from(testResults)\n      .where(eq(testResults.id, testResultId))\n      .limit(1);\n    return result[0];\n  }\n\n  async verifyTestResultOwnership(testResultId: number, userId: string): Promise<boolean> {\n    const result = await db\n      .select({ id: testResults.id })\n      .from(testResults)\n      .where(and(eq(testResults.id, testResultId), eq(testResults.userId, userId)))\n      .limit(1);\n    \n    return result.length > 0;\n  }\n\n  async getUserStats(userId: string): Promise<{\n    totalTests: number;\n    bestWpm: number;\n    avgWpm: number;\n    avgAccuracy: number;\n  } | null> {\n    const result = await db\n      .select({\n        totalTests: sql<number>`count(*)::int`,\n        bestWpm: sql<number>`max(${testResults.wpm})::int`,\n        avgWpm: sql<number>`ROUND(avg(${testResults.wpm}))::int`,\n        avgAccuracy: sql<number>`ROUND(avg(${testResults.accuracy})::numeric, 1)::float`,\n      })\n      .from(testResults)\n      .where(and(\n        eq(testResults.userId, userId),\n        or(\n          eq(testResults.freestyle, false),\n          isNull(testResults.freestyle)\n        )\n      ));\n\n    if (!result[0] || result[0].totalTests === 0) {\n      return null;\n    }\n\n    return result[0];\n  }\n\n  async getLeaderboard(limit: number = 20, language: string = \"en\"): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    createdAt: Date;\n    mode: number;\n    avatarColor: string | null;\n    totalTests: number;\n  }>> {\n    // Use a CTE (Common Table Expression) with window function to get best score per user efficiently\n    // This is a single query that:\n    // 1. Ranks each user's tests by WPM (descending) and date (descending for ties)\n    // 2. Selects only the best test per user (rank = 1)\n    // 3. Joins with test counts\n    // 4. Orders by WPM and limits results\n    const leaderboard = await db.execute(sql`\n      WITH ranked_results AS (\n        SELECT \n          tr.user_id,\n          tr.wpm,\n          tr.accuracy,\n          tr.created_at,\n          tr.mode,\n          ROW_NUMBER() OVER (\n            PARTITION BY tr.user_id \n            ORDER BY tr.wpm DESC, tr.created_at DESC\n          ) as rank\n        FROM test_results tr\n        WHERE (tr.freestyle = false OR tr.freestyle IS NULL)\n          AND tr.language = ${language}\n      ),\n      test_counts AS (\n        SELECT \n          user_id,\n          COUNT(*)::int as total_tests\n        FROM test_results\n        WHERE (freestyle = false OR freestyle IS NULL)\n          AND language = ${language}\n        GROUP BY user_id\n      )\n      SELECT \n        rr.user_id as \"userId\",\n        u.username,\n        rr.wpm,\n        rr.accuracy,\n        rr.created_at as \"createdAt\",\n        rr.mode,\n        u.avatar_color as \"avatarColor\",\n        COALESCE(tc.total_tests, 1) as \"totalTests\"\n      FROM ranked_results rr\n      INNER JOIN users u ON rr.user_id = u.id\n      LEFT JOIN test_counts tc ON rr.user_id = tc.user_id\n      WHERE rr.rank = 1\n      ORDER BY rr.wpm DESC, rr.created_at DESC\n      LIMIT ${limit}\n    `);\n\n    return leaderboard.rows as any[];\n  }\n\n  async getLeaderboardPaginated(limit: number, offset: number, timeframe?: string, language: string = \"en\"): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    createdAt: Date;\n    mode: number;\n    avatarColor: string | null;\n    totalTests: number;\n    rank: number;\n    isVerified: boolean;\n  }>> {\n    const dateFilter = this.getTimeframeDateFilter(timeframe);\n    \n    const leaderboard = await db.execute(sql`\n      WITH ranked_results AS (\n        SELECT \n          tr.user_id,\n          tr.wpm,\n          tr.accuracy,\n          tr.created_at,\n          tr.mode,\n          ROW_NUMBER() OVER (\n            PARTITION BY tr.user_id \n            ORDER BY tr.wpm DESC, tr.created_at DESC\n          ) as user_rank\n        FROM test_results tr\n        WHERE tr.created_at >= ${dateFilter}\n          AND (tr.freestyle = false OR tr.freestyle IS NULL)\n          AND tr.language = ${language}\n      ),\n      test_counts AS (\n        SELECT \n          user_id,\n          COUNT(*)::int as total_tests\n        FROM test_results\n        WHERE created_at >= ${dateFilter}\n          AND (freestyle = false OR freestyle IS NULL)\n          AND language = ${language}\n        GROUP BY user_id\n      ),\n      final_ranking AS (\n        SELECT \n          rr.user_id,\n          rr.wpm,\n          rr.accuracy,\n          rr.created_at,\n          rr.mode,\n          tc.total_tests,\n          DENSE_RANK() OVER (ORDER BY rr.wpm DESC, rr.created_at ASC) as rank\n        FROM ranked_results rr\n        LEFT JOIN test_counts tc ON rr.user_id = tc.user_id\n        WHERE rr.user_rank = 1\n      )\n      SELECT \n        fr.user_id as \"userId\",\n        u.username,\n        fr.wpm,\n        fr.accuracy,\n        fr.created_at as \"createdAt\",\n        fr.mode,\n        u.avatar_color as \"avatarColor\",\n        COALESCE(fr.total_tests, 1) as \"totalTests\",\n        fr.rank,\n        COALESCE(acc.certified_wpm IS NOT NULL, false) as \"isVerified\"\n      FROM final_ranking fr\n      INNER JOIN users u ON fr.user_id = u.id\n      LEFT JOIN anti_cheat_challenges acc ON fr.user_id = acc.user_id AND acc.passed = true\n      ORDER BY fr.rank ASC, fr.wpm DESC\n      LIMIT ${limit}\n      OFFSET ${offset}\n    `);\n\n    return leaderboard.rows as any[];\n  }\n\n  async getLeaderboardCount(timeframe?: string, language: string = \"en\"): Promise<number> {\n    const dateFilter = this.getTimeframeDateFilter(timeframe);\n    \n    const result = await db.execute(sql`\n      SELECT COUNT(DISTINCT user_id)::int as count\n      FROM test_results\n      WHERE created_at >= ${dateFilter}\n        AND (freestyle = false OR freestyle IS NULL)\n        AND language = ${language}\n    `);\n    \n    return (result.rows[0] as any)?.count || 0;\n  }\n\n  async getLeaderboardAroundUser(userId: string, range: number = 5, timeframe?: string, language: string = \"en\"): Promise<{ userRank: number; entries: any[] }> {\n    const dateFilter = this.getTimeframeDateFilter(timeframe);\n    \n    const rankResult = await db.execute(sql`\n      WITH ranked_results AS (\n        SELECT \n          tr.user_id,\n          tr.wpm,\n          ROW_NUMBER() OVER (\n            PARTITION BY tr.user_id \n            ORDER BY tr.wpm DESC\n          ) as user_rank\n        FROM test_results tr\n        WHERE tr.created_at >= ${dateFilter}\n          AND (tr.freestyle = false OR tr.freestyle IS NULL)\n          AND tr.language = ${language}\n      ),\n      user_best AS (\n        SELECT user_id, wpm FROM ranked_results WHERE user_rank = 1\n      ),\n      final_ranking AS (\n        SELECT \n          user_id,\n          wpm,\n          DENSE_RANK() OVER (ORDER BY wpm DESC) as rank\n        FROM user_best\n      )\n      SELECT rank FROM final_ranking WHERE user_id = ${userId}\n    `);\n\n    const userRank = (rankResult.rows[0] as any)?.rank || -1;\n    \n    if (userRank === -1) {\n      return { userRank: -1, entries: [] };\n    }\n\n    const startRank = Math.max(1, userRank - range);\n    const endRank = userRank + range;\n\n    const entries = await db.execute(sql`\n      WITH ranked_results AS (\n        SELECT \n          tr.user_id,\n          tr.wpm,\n          tr.accuracy,\n          tr.created_at,\n          tr.mode,\n          ROW_NUMBER() OVER (\n            PARTITION BY tr.user_id \n            ORDER BY tr.wpm DESC, tr.created_at DESC\n          ) as user_rank\n        FROM test_results tr\n        WHERE tr.created_at >= ${dateFilter}\n          AND (tr.freestyle = false OR tr.freestyle IS NULL)\n          AND tr.language = ${language}\n      ),\n      test_counts AS (\n        SELECT user_id, COUNT(*)::int as total_tests \n        FROM test_results \n        WHERE created_at >= ${dateFilter}\n          AND (freestyle = false OR freestyle IS NULL)\n          AND language = ${language}\n        GROUP BY user_id\n      ),\n      final_ranking AS (\n        SELECT \n          rr.user_id,\n          rr.wpm,\n          rr.accuracy,\n          rr.created_at,\n          rr.mode,\n          tc.total_tests,\n          DENSE_RANK() OVER (ORDER BY rr.wpm DESC) as rank\n        FROM ranked_results rr\n        LEFT JOIN test_counts tc ON rr.user_id = tc.user_id\n        WHERE rr.user_rank = 1\n      )\n      SELECT \n        fr.user_id as \"userId\",\n        u.username,\n        fr.wpm,\n        fr.accuracy,\n        fr.created_at as \"createdAt\",\n        fr.mode,\n        u.avatar_color as \"avatarColor\",\n        COALESCE(fr.total_tests, 1) as \"totalTests\",\n        fr.rank\n      FROM final_ranking fr\n      INNER JOIN users u ON fr.user_id = u.id\n      WHERE fr.rank >= ${startRank} AND fr.rank <= ${endRank}\n      ORDER BY fr.rank ASC\n    `);\n\n    return { userRank, entries: entries.rows as any[] };\n  }\n\n  async getStressTestLeaderboardPaginated(difficulty: string | undefined, limit: number, offset: number): Promise<Array<{\n    userId: string;\n    username: string;\n    difficulty: string;\n    stressScore: number;\n    wpm: number;\n    accuracy: number;\n    completionRate: number;\n    avatarColor: string | null;\n    createdAt: Date;\n    rank: number;\n    isVerified: boolean;\n  }>> {\n    const difficultyFilter = difficulty ? sql`AND st.difficulty = ${difficulty}` : sql``;\n    \n    const leaderboard = await db.execute(sql`\n      WITH ranked_scores AS (\n        SELECT \n          st.user_id,\n          st.difficulty,\n          st.stress_score,\n          st.wpm,\n          st.accuracy,\n          st.completion_rate,\n          st.created_at,\n          ROW_NUMBER() OVER (\n            PARTITION BY st.user_id, st.difficulty\n            ORDER BY st.stress_score DESC, st.wpm DESC, st.created_at DESC\n          ) as user_rank\n        FROM stress_tests st\n        WHERE 1=1 ${difficultyFilter}\n      ),\n      best_scores AS (\n        SELECT * FROM ranked_scores WHERE user_rank = 1\n      ),\n      final_ranking AS (\n        SELECT \n          bs.*,\n          DENSE_RANK() OVER (\n            ORDER BY bs.stress_score DESC, bs.wpm DESC, bs.created_at ASC\n          ) as rank\n        FROM best_scores bs\n      )\n      SELECT \n        fr.user_id as \"userId\",\n        u.username,\n        fr.difficulty,\n        fr.stress_score as \"stressScore\",\n        fr.wpm,\n        fr.accuracy,\n        fr.completion_rate as \"completionRate\",\n        u.avatar_color as \"avatarColor\",\n        fr.created_at as \"createdAt\",\n        fr.rank,\n        COALESCE(acc.certified_wpm IS NOT NULL, false) as \"isVerified\"\n      FROM final_ranking fr\n      INNER JOIN users u ON fr.user_id = u.id\n      LEFT JOIN anti_cheat_challenges acc ON fr.user_id = acc.user_id AND acc.passed = true\n      ORDER BY fr.rank ASC\n      LIMIT ${limit}\n      OFFSET ${offset}\n    `);\n\n    return leaderboard.rows as any[];\n  }\n\n  async getStressTestLeaderboardCount(difficulty?: string): Promise<number> {\n    const difficultyFilter = difficulty ? sql`AND difficulty = ${difficulty}` : sql``;\n    \n    const result = await db.execute(sql`\n      SELECT COUNT(DISTINCT user_id)::int as count\n      FROM stress_tests\n      WHERE 1=1 ${difficultyFilter}\n    `);\n    \n    return (result.rows[0] as any)?.count || 0;\n  }\n\n  async getStressLeaderboardAroundUser(userId: string, difficulty: string | undefined, range: number = 5): Promise<{ userRank: number; entries: any[] }> {\n    const difficultyFilter = difficulty ? sql`AND st.difficulty = ${difficulty}` : sql``;\n    \n    const rankResult = await db.execute(sql`\n      WITH ranked_scores AS (\n        SELECT \n          st.user_id,\n          st.stress_score,\n          ROW_NUMBER() OVER (\n            PARTITION BY st.user_id\n            ORDER BY st.stress_score DESC\n          ) as user_rank\n        FROM stress_tests st\n        WHERE 1=1 ${difficultyFilter}\n      ),\n      user_best AS (\n        SELECT user_id, stress_score FROM ranked_scores WHERE user_rank = 1\n      ),\n      final_ranking AS (\n        SELECT \n          user_id,\n          stress_score,\n          DENSE_RANK() OVER (ORDER BY stress_score DESC) as rank\n        FROM user_best\n      )\n      SELECT rank FROM final_ranking WHERE user_id = ${userId}\n    `);\n\n    const userRank = (rankResult.rows[0] as any)?.rank || -1;\n    \n    if (userRank === -1) {\n      return { userRank: -1, entries: [] };\n    }\n\n    const startRank = Math.max(1, userRank - range);\n    const endRank = userRank + range;\n\n    const entries = await db.execute(sql`\n      WITH ranked_scores AS (\n        SELECT \n          st.user_id,\n          st.difficulty,\n          st.stress_score,\n          st.wpm,\n          st.accuracy,\n          st.completion_rate,\n          st.created_at,\n          ROW_NUMBER() OVER (\n            PARTITION BY st.user_id\n            ORDER BY st.stress_score DESC\n          ) as user_rank\n        FROM stress_tests st\n        WHERE 1=1 ${difficultyFilter}\n      ),\n      best_scores AS (\n        SELECT * FROM ranked_scores WHERE user_rank = 1\n      ),\n      final_ranking AS (\n        SELECT \n          bs.*,\n          DENSE_RANK() OVER (ORDER BY bs.stress_score DESC) as rank\n        FROM best_scores bs\n      )\n      SELECT \n        fr.user_id as \"userId\",\n        u.username,\n        fr.difficulty,\n        fr.stress_score as \"stressScore\",\n        fr.wpm,\n        fr.accuracy,\n        fr.completion_rate as \"completionRate\",\n        u.avatar_color as \"avatarColor\",\n        fr.created_at as \"createdAt\",\n        fr.rank\n      FROM final_ranking fr\n      INNER JOIN users u ON fr.user_id = u.id\n      WHERE fr.rank >= ${startRank} AND fr.rank <= ${endRank}\n      ORDER BY fr.rank ASC\n    `);\n\n    return { userRank, entries: entries.rows as any[] };\n  }\n\n  async getCodeLeaderboardPaginated(language: string | undefined, limit: number, offset: number): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    programmingLanguage: string;\n    framework: string | null;\n    createdAt: Date;\n    avatarColor: string | null;\n    totalTests: number;\n    rank: number;\n    isVerified: boolean;\n  }>> {\n    const languageFilter = language ? sql`AND ct.programming_language = ${language}` : sql``;\n\n    const leaderboard = await db.execute(sql`\n      WITH ranked_results AS (\n        SELECT \n          ct.user_id,\n          ct.wpm,\n          ct.accuracy,\n          ct.programming_language,\n          ct.framework,\n          ct.created_at,\n          ROW_NUMBER() OVER (\n            PARTITION BY ct.user_id ${language ? sql`, ct.programming_language` : sql``}\n            ORDER BY ct.wpm DESC, ct.created_at DESC\n          ) as user_rank\n        FROM code_typing_tests ct\n        WHERE 1=1 ${languageFilter}\n      ),\n      test_counts AS (\n        SELECT \n          user_id,\n          COUNT(*)::int as total_tests\n        FROM code_typing_tests\n        WHERE 1=1 ${languageFilter}\n        GROUP BY user_id\n      ),\n      final_ranking AS (\n        SELECT \n          rr.user_id,\n          rr.wpm,\n          rr.accuracy,\n          rr.programming_language,\n          rr.framework,\n          rr.created_at,\n          tc.total_tests,\n          DENSE_RANK() OVER (ORDER BY rr.wpm DESC, rr.created_at ASC) as rank\n        FROM ranked_results rr\n        LEFT JOIN test_counts tc ON rr.user_id = tc.user_id\n        WHERE rr.user_rank = 1\n      )\n      SELECT \n        fr.user_id as \"userId\",\n        u.username,\n        fr.wpm,\n        fr.accuracy,\n        fr.programming_language as \"programmingLanguage\",\n        fr.framework,\n        fr.created_at as \"createdAt\",\n        u.avatar_color as \"avatarColor\",\n        COALESCE(fr.total_tests, 1) as \"totalTests\",\n        fr.rank,\n        COALESCE(acc.certified_wpm IS NOT NULL, false) as \"isVerified\"\n      FROM final_ranking fr\n      INNER JOIN users u ON fr.user_id = u.id\n      LEFT JOIN anti_cheat_challenges acc ON fr.user_id = acc.user_id AND acc.passed = true\n      ORDER BY fr.rank ASC\n      LIMIT ${limit}\n      OFFSET ${offset}\n    `);\n\n    return leaderboard.rows as any[];\n  }\n\n  async getCodeLeaderboardCount(language?: string): Promise<number> {\n    const languageFilter = language ? sql`AND programming_language = ${language}` : sql``;\n    \n    const result = await db.execute(sql`\n      SELECT COUNT(DISTINCT user_id)::int as count\n      FROM code_typing_tests\n      WHERE 1=1 ${languageFilter}\n    `);\n    \n    return (result.rows[0] as any)?.count || 0;\n  }\n\n  async getCodeLeaderboardAroundUser(userId: string, language: string | undefined, range: number = 5): Promise<{ userRank: number; entries: any[] }> {\n    const languageFilter = language ? sql`AND ct.programming_language = ${language}` : sql``;\n    \n    const rankResult = await db.execute(sql`\n      WITH ranked_results AS (\n        SELECT \n          ct.user_id,\n          ct.wpm,\n          ROW_NUMBER() OVER (\n            PARTITION BY ct.user_id\n            ORDER BY ct.wpm DESC\n          ) as user_rank\n        FROM code_typing_tests ct\n        WHERE 1=1 ${languageFilter}\n      ),\n      user_best AS (\n        SELECT user_id, wpm FROM ranked_results WHERE user_rank = 1\n      ),\n      final_ranking AS (\n        SELECT \n          user_id,\n          wpm,\n          DENSE_RANK() OVER (ORDER BY wpm DESC) as rank\n        FROM user_best\n      )\n      SELECT rank FROM final_ranking WHERE user_id = ${userId}\n    `);\n\n    const userRank = (rankResult.rows[0] as any)?.rank || -1;\n    \n    if (userRank === -1) {\n      return { userRank: -1, entries: [] };\n    }\n\n    const startRank = Math.max(1, userRank - range);\n    const endRank = userRank + range;\n\n    const entries = await db.execute(sql`\n      WITH ranked_results AS (\n        SELECT \n          ct.user_id,\n          ct.wpm,\n          ct.accuracy,\n          ct.programming_language,\n          ct.framework,\n          ct.created_at,\n          ROW_NUMBER() OVER (\n            PARTITION BY ct.user_id\n            ORDER BY ct.wpm DESC\n          ) as user_rank\n        FROM code_typing_tests ct\n        WHERE 1=1 ${languageFilter}\n      ),\n      test_counts AS (\n        SELECT user_id, COUNT(*)::int as total_tests FROM code_typing_tests GROUP BY user_id\n      ),\n      final_ranking AS (\n        SELECT \n          rr.user_id,\n          rr.wpm,\n          rr.accuracy,\n          rr.programming_language,\n          rr.framework,\n          rr.created_at,\n          tc.total_tests,\n          DENSE_RANK() OVER (ORDER BY rr.wpm DESC) as rank\n        FROM ranked_results rr\n        LEFT JOIN test_counts tc ON rr.user_id = tc.user_id\n        WHERE rr.user_rank = 1\n      )\n      SELECT \n        fr.user_id as \"userId\",\n        u.username,\n        fr.wpm,\n        fr.accuracy,\n        fr.programming_language as \"programmingLanguage\",\n        fr.framework,\n        fr.created_at as \"createdAt\",\n        u.avatar_color as \"avatarColor\",\n        COALESCE(fr.total_tests, 1) as \"totalTests\",\n        fr.rank\n      FROM final_ranking fr\n      INNER JOIN users u ON fr.user_id = u.id\n      WHERE fr.rank >= ${startRank} AND fr.rank <= ${endRank}\n      ORDER BY fr.rank ASC\n    `);\n\n    return { userRank, entries: entries.rows as any[] };\n  }\n\n  async getRatingLeaderboardPaginated(tier: string | undefined, limit: number, offset: number): Promise<any[]> {\n    let query = db.select().from(userRatings);\n    \n    if (tier) {\n      query = query.where(eq(userRatings.tier, tier)) as typeof query;\n    }\n    \n    const ratings = await query\n      .orderBy(desc(userRatings.rating))\n      .limit(limit)\n      .offset(offset);\n    \n    const enrichedRatings = await Promise.all(\n      ratings.map(async (rating, index) => {\n        const user = await this.getUser(rating.userId);\n        return {\n          ...rating,\n          username: user?.username || \"Unknown\",\n          avatarColor: user?.avatarColor,\n          rank: offset + index + 1,\n        };\n      })\n    );\n\n    return enrichedRatings;\n  }\n\n  async getRatingLeaderboardCount(tier?: string): Promise<number> {\n    let query = db.select({ count: sql<number>`count(*)::int` }).from(userRatings);\n    \n    if (tier) {\n      query = query.where(eq(userRatings.tier, tier)) as typeof query;\n    }\n    \n    const result = await query;\n    return result[0]?.count || 0;\n  }\n\n  async getRatingLeaderboardAroundUser(userId: string, tier: string | undefined, range: number = 5): Promise<{ userRank: number; entries: any[] }> {\n    const tierFilter = tier ? sql`WHERE tier = ${tier}` : sql``;\n    \n    const rankResult = await db.execute(sql`\n      WITH ranked_ratings AS (\n        SELECT \n          user_id,\n          rating,\n          DENSE_RANK() OVER (ORDER BY rating DESC) as rank\n        FROM user_ratings\n        ${tierFilter}\n      )\n      SELECT rank FROM ranked_ratings WHERE user_id = ${userId}\n    `);\n\n    const userRank = (rankResult.rows[0] as any)?.rank || -1;\n    \n    if (userRank === -1) {\n      return { userRank: -1, entries: [] };\n    }\n\n    const startRank = Math.max(1, userRank - range);\n    const endRank = userRank + range;\n\n    const entries = await db.execute(sql`\n      WITH ranked_ratings AS (\n        SELECT \n          ur.user_id,\n          ur.rating,\n          ur.tier,\n          ur.total_races,\n          ur.wins,\n          ur.losses,\n          DENSE_RANK() OVER (ORDER BY ur.rating DESC) as rank\n        FROM user_ratings ur\n        ${tierFilter}\n      )\n      SELECT \n        rr.user_id as \"userId\",\n        u.username,\n        rr.rating,\n        rr.tier,\n        rr.total_races as \"totalRaces\",\n        rr.wins,\n        rr.losses,\n        u.avatar_color as \"avatarColor\",\n        rr.rank\n      FROM ranked_ratings rr\n      INNER JOIN users u ON rr.user_id = u.id\n      WHERE rr.rank >= ${startRank} AND rr.rank <= ${endRank}\n      ORDER BY rr.rank ASC\n    `);\n\n    return { userRank, entries: entries.rows as any[] };\n  }\n\n  async getDictationLeaderboardPaginated(limit: number, offset: number): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    speedLevel: string;\n    createdAt: Date;\n    avatarColor: string | null;\n    totalTests: number;\n    rank: number;\n  }>> {\n    const leaderboard = await db.execute(sql`\n      WITH ranked_results AS (\n        SELECT \n          dt.user_id,\n          dt.wpm,\n          dt.accuracy,\n          dt.speed_level,\n          dt.created_at,\n          ROW_NUMBER() OVER (\n            PARTITION BY dt.user_id \n            ORDER BY dt.wpm DESC, dt.created_at DESC\n          ) as user_rank\n        FROM dictation_tests dt\n      ),\n      test_counts AS (\n        SELECT user_id, COUNT(*)::int as total_tests FROM dictation_tests GROUP BY user_id\n      ),\n      final_ranking AS (\n        SELECT \n          rr.user_id,\n          rr.wpm,\n          rr.accuracy,\n          rr.speed_level,\n          rr.created_at,\n          tc.total_tests,\n          DENSE_RANK() OVER (ORDER BY rr.wpm DESC, rr.created_at ASC) as rank\n        FROM ranked_results rr\n        LEFT JOIN test_counts tc ON rr.user_id = tc.user_id\n        WHERE rr.user_rank = 1\n      )\n      SELECT \n        fr.user_id as \"userId\",\n        u.username,\n        fr.wpm,\n        fr.accuracy,\n        fr.speed_level as \"speedLevel\",\n        fr.created_at as \"createdAt\",\n        u.avatar_color as \"avatarColor\",\n        COALESCE(fr.total_tests, 1) as \"totalTests\",\n        fr.rank\n      FROM final_ranking fr\n      INNER JOIN users u ON fr.user_id = u.id\n      ORDER BY fr.rank ASC\n      LIMIT ${limit}\n      OFFSET ${offset}\n    `);\n\n    return leaderboard.rows as any[];\n  }\n\n  async getDictationLeaderboardCount(): Promise<number> {\n    const result = await db.execute(sql`\n      SELECT COUNT(DISTINCT user_id)::int as count FROM dictation_tests\n    `);\n    \n    return (result.rows[0] as any)?.count || 0;\n  }\n\n  async getDictationLeaderboardAroundUser(userId: string, range: number = 5): Promise<{ userRank: number; entries: any[] }> {\n    const rankResult = await db.execute(sql`\n      WITH ranked_results AS (\n        SELECT \n          dt.user_id,\n          dt.wpm,\n          ROW_NUMBER() OVER (\n            PARTITION BY dt.user_id\n            ORDER BY dt.wpm DESC\n          ) as user_rank\n        FROM dictation_tests dt\n      ),\n      user_best AS (\n        SELECT user_id, wpm FROM ranked_results WHERE user_rank = 1\n      ),\n      final_ranking AS (\n        SELECT \n          user_id,\n          wpm,\n          DENSE_RANK() OVER (ORDER BY wpm DESC) as rank\n        FROM user_best\n      )\n      SELECT rank FROM final_ranking WHERE user_id = ${userId}\n    `);\n\n    const userRank = (rankResult.rows[0] as any)?.rank || -1;\n    \n    if (userRank === -1) {\n      return { userRank: -1, entries: [] };\n    }\n\n    const startRank = Math.max(1, userRank - range);\n    const endRank = userRank + range;\n\n    const entries = await db.execute(sql`\n      WITH ranked_results AS (\n        SELECT \n          dt.user_id,\n          dt.wpm,\n          dt.accuracy,\n          dt.speed_level,\n          dt.created_at,\n          ROW_NUMBER() OVER (\n            PARTITION BY dt.user_id\n            ORDER BY dt.wpm DESC\n          ) as user_rank\n        FROM dictation_tests dt\n      ),\n      test_counts AS (\n        SELECT user_id, COUNT(*)::int as total_tests FROM dictation_tests GROUP BY user_id\n      ),\n      final_ranking AS (\n        SELECT \n          rr.user_id,\n          rr.wpm,\n          rr.accuracy,\n          rr.speed_level,\n          rr.created_at,\n          tc.total_tests,\n          DENSE_RANK() OVER (ORDER BY rr.wpm DESC) as rank\n        FROM ranked_results rr\n        LEFT JOIN test_counts tc ON rr.user_id = tc.user_id\n        WHERE rr.user_rank = 1\n      )\n      SELECT \n        fr.user_id as \"userId\",\n        u.username,\n        fr.wpm,\n        fr.accuracy,\n        fr.speed_level as \"speedLevel\",\n        fr.created_at as \"createdAt\",\n        u.avatar_color as \"avatarColor\",\n        COALESCE(fr.total_tests, 1) as \"totalTests\",\n        fr.rank\n      FROM final_ranking fr\n      INNER JOIN users u ON fr.user_id = u.id\n      WHERE fr.rank >= ${startRank} AND fr.rank <= ${endRank}\n      ORDER BY fr.rank ASC\n    `);\n\n    return { userRank, entries: entries.rows as any[] };\n  }\n\n  async getTimeBasedLeaderboard(timeframe: \"daily\" | \"weekly\" | \"monthly\", limit: number, offset: number): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    createdAt: Date;\n    avatarColor: string | null;\n    testsInPeriod: number;\n    rank: number;\n  }>> {\n    const dateFilter = this.getTimeframeDateFilter(timeframe);\n    \n    const leaderboard = await db.execute(sql`\n      WITH period_results AS (\n        SELECT \n          tr.user_id,\n          tr.wpm,\n          tr.accuracy,\n          tr.created_at,\n          ROW_NUMBER() OVER (\n            PARTITION BY tr.user_id \n            ORDER BY tr.wpm DESC, tr.created_at DESC\n          ) as user_rank\n        FROM test_results tr\n        WHERE tr.created_at >= ${dateFilter}\n      ),\n      test_counts AS (\n        SELECT \n          user_id,\n          COUNT(*)::int as tests_in_period\n        FROM test_results\n        WHERE created_at >= ${dateFilter}\n        GROUP BY user_id\n      ),\n      final_ranking AS (\n        SELECT \n          pr.user_id,\n          pr.wpm,\n          pr.accuracy,\n          pr.created_at,\n          tc.tests_in_period,\n          DENSE_RANK() OVER (ORDER BY pr.wpm DESC, pr.created_at ASC) as rank\n        FROM period_results pr\n        LEFT JOIN test_counts tc ON pr.user_id = tc.user_id\n        WHERE pr.user_rank = 1\n      )\n      SELECT \n        fr.user_id as \"userId\",\n        u.username,\n        fr.wpm,\n        fr.accuracy,\n        fr.created_at as \"createdAt\",\n        u.avatar_color as \"avatarColor\",\n        COALESCE(fr.tests_in_period, 1) as \"testsInPeriod\",\n        fr.rank\n      FROM final_ranking fr\n      INNER JOIN users u ON fr.user_id = u.id\n      ORDER BY fr.rank ASC\n      LIMIT ${limit}\n      OFFSET ${offset}\n    `);\n\n    return leaderboard.rows as any[];\n  }\n\n  async getTimeBasedLeaderboardCount(timeframe: \"daily\" | \"weekly\" | \"monthly\"): Promise<number> {\n    const dateFilter = this.getTimeframeDateFilter(timeframe);\n    \n    const result = await db.execute(sql`\n      SELECT COUNT(DISTINCT user_id)::int as count\n      FROM test_results\n      WHERE created_at >= ${dateFilter}\n    `);\n    \n    return (result.rows[0] as any)?.count || 0;\n  }\n\n  private getTimeframeDateFilter(timeframe?: string): Date {\n    const now = new Date();\n    \n    switch (timeframe) {\n      case \"daily\":\n        const today = new Date(now);\n        today.setHours(0, 0, 0, 0);\n        return today;\n      case \"weekly\":\n        const weekStart = new Date(now);\n        weekStart.setDate(now.getDate() - now.getDay());\n        weekStart.setHours(0, 0, 0, 0);\n        return weekStart;\n      case \"monthly\":\n        return new Date(now.getFullYear(), now.getMonth(), 1);\n      default:\n        return new Date(0);\n    }\n  }\n\n  async getPlatformStats(): Promise<{\n    totalUsers: number;\n    totalTests: number;\n    totalLanguages: number;\n  }> {\n    const usersResult = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(users);\n    \n    const testsResult = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(testResults);\n    \n    const languagesResult = await db\n      .select({ count: sql<number>`count(distinct language)::int` })\n      .from(typingParagraphs);\n\n    return {\n      totalUsers: usersResult[0]?.count || 0,\n      totalTests: testsResult[0]?.count || 0,\n      totalLanguages: languagesResult[0]?.count || 23, // Default to 23 if no paragraphs\n    };\n  }\n\n  async createConversation(conversation: InsertConversation): Promise<Conversation> {\n    const result = await db.insert(conversations).values(conversation).returning();\n    return result[0];\n  }\n\n  async getUserConversations(userId: string): Promise<Conversation[]> {\n    return await db\n      .select()\n      .from(conversations)\n      .where(eq(conversations.userId, userId))\n      .orderBy(desc(conversations.updatedAt));\n  }\n\n  async getConversation(id: number, userId: string): Promise<Conversation | undefined> {\n    const result = await db\n      .select()\n      .from(conversations)\n      .where(and(eq(conversations.id, id), eq(conversations.userId, userId)))\n      .limit(1);\n    return result[0];\n  }\n\n  async updateConversation(id: number, userId: string, data: Partial<Conversation>): Promise<Conversation | undefined> {\n    const result = await db\n      .update(conversations)\n      .set({ ...data, updatedAt: new Date() })\n      .where(and(eq(conversations.id, id), eq(conversations.userId, userId)))\n      .returning();\n    return result[0];\n  }\n\n  async deleteConversation(id: number, userId: string): Promise<void> {\n    await db.delete(conversations).where(and(eq(conversations.id, id), eq(conversations.userId, userId)));\n  }\n\n  async createMessage(message: InsertMessage): Promise<Message> {\n    const result = await db.insert(messages).values(message).returning();\n    return result[0];\n  }\n\n  async getConversationMessages(conversationId: number): Promise<Message[]> {\n    return await db\n      .select()\n      .from(messages)\n      .where(eq(messages.conversationId, conversationId))\n      .orderBy(messages.createdAt);\n  }\n\n  async getExactParagraph(language: string, mode: string, difficulty?: string): Promise<TypingParagraph | undefined> {\n    // Get ONLY exact language + mode + difficulty match using SQL RANDOM() for better distribution\n    // Exclude typing-related paragraphs\n    const conditions = [\n      eq(typingParagraphs.language, language),\n      eq(typingParagraphs.mode, mode),\n      eq(typingParagraphs.isTypingRelated, false)\n    ];\n    \n    if (difficulty) {\n      conditions.push(eq(typingParagraphs.difficulty, difficulty));\n    }\n    \n    const [paragraph] = await db\n      .select()\n      .from(typingParagraphs)\n      .where(and(...conditions))\n      .orderBy(sql`RANDOM()`)\n      .limit(1);\n    \n    return paragraph;\n  }\n\n  async getRandomParagraph(language: string, mode?: string, difficulty?: string): Promise<TypingParagraph | undefined> {\n    // Try with language, mode, and difficulty using SQL RANDOM() for better distribution\n    // Always exclude typing-related paragraphs\n    if (mode) {\n      const conditions = [\n        eq(typingParagraphs.language, language),\n        eq(typingParagraphs.mode, mode),\n        eq(typingParagraphs.isTypingRelated, false)\n      ];\n      \n      if (difficulty) {\n        conditions.push(eq(typingParagraphs.difficulty, difficulty));\n      }\n      \n      const [paragraph] = await db\n        .select()\n        .from(typingParagraphs)\n        .where(and(...conditions))\n        .orderBy(sql`RANDOM()`)\n        .limit(1);\n      \n      if (paragraph) {\n        return paragraph;\n      }\n    }\n    \n    // Fallback to any paragraph in the requested language using SQL RANDOM() for better distribution\n    const [languageParagraph] = await db\n      .select()\n      .from(typingParagraphs)\n      .where(and(\n        eq(typingParagraphs.language, language),\n        eq(typingParagraphs.isTypingRelated, false)\n      ))\n      .orderBy(sql`RANDOM()`)\n      .limit(1);\n    \n    if (languageParagraph) {\n      return languageParagraph;\n    }\n    \n    // Final fallback to any English paragraph\n    const [englishParagraph] = await db\n      .select()\n      .from(typingParagraphs)\n      .where(and(\n        eq(typingParagraphs.language, 'en'),\n        eq(typingParagraphs.isTypingRelated, false)\n      ))\n      .orderBy(sql`RANDOM()`)\n      .limit(1);\n    \n    return englishParagraph;\n  }\n\n  async getRandomParagraphs(language: string, count: number, mode?: string, difficulty?: string): Promise<TypingParagraph[]> {\n    // Build conditions for the query - always exclude typing-related paragraphs\n    const conditions = [\n      eq(typingParagraphs.language, language),\n      eq(typingParagraphs.isTypingRelated, false)\n    ];\n    \n    if (mode) {\n      conditions.push(eq(typingParagraphs.mode, mode));\n    }\n    \n    if (difficulty) {\n      conditions.push(eq(typingParagraphs.difficulty, difficulty));\n    }\n    \n    // Use SQL RANDOM() for efficient random selection without loading all rows\n    const paragraphs = await db\n      .select()\n      .from(typingParagraphs)\n      .where(and(...conditions))\n      .orderBy(sql`RANDOM()`)\n      .limit(count);\n    \n    if (paragraphs.length > 0) {\n      return paragraphs;\n    }\n    \n    // Fallback to any paragraph in the requested language (exclude typing-related)\n    const languageParagraphs = await db\n      .select()\n      .from(typingParagraphs)\n      .where(and(\n        eq(typingParagraphs.language, language),\n        eq(typingParagraphs.isTypingRelated, false)\n      ))\n      .orderBy(sql`RANDOM()`)\n      .limit(count);\n    \n    if (languageParagraphs.length > 0) {\n      return languageParagraphs;\n    }\n    \n    // Final fallback to English paragraphs (exclude typing-related)\n    const englishParagraphs = await db\n      .select()\n      .from(typingParagraphs)\n      .where(and(\n        eq(typingParagraphs.language, 'en'),\n        eq(typingParagraphs.isTypingRelated, false)\n      ))\n      .orderBy(sql`RANDOM()`)\n      .limit(count);\n    \n    return englishParagraphs;\n  }\n\n  async getAvailableLanguages(): Promise<string[]> {\n    const result = await db\n      .selectDistinct({ language: typingParagraphs.language })\n      .from(typingParagraphs);\n    \n    const languages = result.map(r => r.language);\n    \n    // Sort languages: English first, Hindi second, Marathi third, then all others alphabetically\n    const priorityOrder = ['en', 'hi', 'mr'];\n    const priorityLanguages: string[] = [];\n    const otherLanguages: string[] = [];\n    \n    languages.forEach(lang => {\n      if (priorityOrder.includes(lang)) {\n        priorityLanguages.push(lang);\n      } else {\n        otherLanguages.push(lang);\n      }\n    });\n    \n    // Sort priority languages by their order in priorityOrder array\n    priorityLanguages.sort((a, b) => priorityOrder.indexOf(a) - priorityOrder.indexOf(b));\n    \n    // Sort other languages alphabetically\n    otherLanguages.sort();\n    \n    return [...priorityLanguages, ...otherLanguages];\n  }\n\n  async getAvailableModes(): Promise<string[]> {\n    const result = await db\n      .selectDistinct({ mode: typingParagraphs.mode })\n      .from(typingParagraphs);\n    // Filter out custom modes (generated with timestamps) to keep the dropdown clean\n    return result\n      .map(r => r.mode)\n      .filter(mode => !mode.startsWith('custom_'));\n  }\n\n  async createTypingParagraph(paragraph: InsertTypingParagraph): Promise<TypingParagraph> {\n    const result = await db.insert(typingParagraphs).values(paragraph).returning();\n    return result[0];\n  }\n\n  async saveKeystrokeAnalytics(keystroke: InsertKeystrokeAnalytics): Promise<KeystrokeAnalytics> {\n    const result = await db.insert(keystrokeAnalytics).values(keystroke).returning();\n    return result[0];\n  }\n\n  async saveBulkKeystrokeAnalytics(keystrokes: InsertKeystrokeAnalytics[]): Promise<void> {\n    if (keystrokes.length === 0) return;\n    await db.insert(keystrokeAnalytics).values(keystrokes);\n  }\n\n  async getUserAnalytics(userId: string, days: number = 30): Promise<{\n    wpmOverTime: Array<{ date: string; wpm: number; accuracy: number; testCount: number }>;\n    mistakesHeatmap: Array<{ key: string; errorCount: number; totalCount: number; errorRate: number }>;\n    consistency: {\n      avgWpm: number;\n      stdDeviation: number;\n      minWpm: number;\n      maxWpm: number;\n    };\n    commonMistakes: Array<{ expectedKey: string; typedKey: string; count: number }>;\n  }> {\n    // Validate and clamp days to safe range to prevent SQL injection\n    const safeDays = Math.max(1, Math.min(365, Math.floor(days)));\n    \n    // Calculate the cutoff date server-side (safer than using INTERVAL with sql.raw)\n    const cutoffDate = new Date();\n    cutoffDate.setDate(cutoffDate.getDate() - safeDays);\n    \n    // Get WPM over time (grouped by date)\n    const wpmDataQuery = await db.execute(sql`\n      SELECT \n        TO_CHAR(DATE(created_at), 'YYYY-MM-DD') as date,\n        ROUND(AVG(wpm))::int as wpm,\n        ROUND(AVG(accuracy)::numeric, 1) as accuracy,\n        COUNT(*)::int as test_count\n      FROM test_results\n      WHERE user_id = ${userId}\n        AND created_at >= ${cutoffDate}\n      GROUP BY DATE(created_at)\n      ORDER BY date ASC\n    `);\n    \n    const wpmOverTime = wpmDataQuery.rows.map((row: any) => ({\n      date: row.date,\n      wpm: Number(row.wpm) || 0,\n      accuracy: Number(row.accuracy) || 0,\n      testCount: Number(row.test_count) || 0,\n    }));\n\n    // Get mistakes heatmap by combining key_heatmap (total) and error_keys (errors)\n    // This gives accurate error rates per key\n    const heatmapQuery = await db.execute(sql`\n      WITH error_counts AS (\n        SELECT \n          UPPER(key_value) as key,\n          COUNT(*)::int as error_count\n        FROM typing_analytics,\n          jsonb_array_elements_text(error_keys) as key_value\n        WHERE user_id = ${userId}\n          AND created_at >= ${cutoffDate}\n          AND error_keys IS NOT NULL\n        GROUP BY UPPER(key_value)\n      ),\n      total_counts AS (\n        SELECT \n          key_name as key,\n          SUM((key_count)::int)::int as total_count\n        FROM typing_analytics,\n          jsonb_each_text(key_heatmap) as kv(key_name, key_count)\n        WHERE user_id = ${userId}\n          AND created_at >= ${cutoffDate}\n          AND key_heatmap IS NOT NULL\n          AND key_name != 'BACKSPACE'\n        GROUP BY key_name\n      )\n      SELECT \n        e.key,\n        e.error_count,\n        COALESCE(t.total_count, e.error_count) as total_count,\n        ROUND((e.error_count::float / NULLIF(COALESCE(t.total_count, e.error_count), 0) * 100)::numeric, 2) as error_rate\n      FROM error_counts e\n      LEFT JOIN total_counts t ON UPPER(e.key) = UPPER(t.key)\n      ORDER BY e.error_count DESC\n      LIMIT 50\n    `);\n\n    const mistakesHeatmap = heatmapQuery.rows.map((row: any) => ({\n      key: row.key || '',\n      errorCount: Number(row.error_count) || 0,\n      totalCount: Number(row.total_count) || 0,\n      errorRate: Number(row.error_rate) || 0,\n    }));\n\n    // Get consistency metrics\n    const consistencyQuery = await db.execute(sql`\n      SELECT \n        COALESCE(AVG(wpm), 0)::numeric(10,2) as avg_wpm,\n        COALESCE(STDDEV(wpm), 0)::numeric(10,2) as std_deviation,\n        COALESCE(MIN(wpm), 0)::int as min_wpm,\n        COALESCE(MAX(wpm), 0)::int as max_wpm\n      FROM test_results\n      WHERE user_id = ${userId}\n        AND created_at >= ${cutoffDate}\n    `);\n\n    const consistencyData = consistencyQuery.rows[0] as any;\n    const consistency = {\n      avgWpm: Number(consistencyData?.avg_wpm) || 0,\n      stdDeviation: Number(consistencyData?.std_deviation) || 0,\n      minWpm: Number(consistencyData?.min_wpm) || 0,\n      maxWpm: Number(consistencyData?.max_wpm) || 0,\n    };\n\n    // Get common mistakes from typing_analytics error_keys JSONB field\n    // Show which keys the user frequently makes errors on\n    const mistakesQuery = await db.execute(sql`\n      SELECT \n        key_value as expected_key,\n        '?' as typed_key,\n        COUNT(*)::int as count\n      FROM typing_analytics,\n        jsonb_array_elements_text(error_keys) as key_value\n      WHERE user_id = ${userId}\n        AND created_at >= ${cutoffDate}\n        AND error_keys IS NOT NULL\n        AND jsonb_array_length(error_keys) > 0\n      GROUP BY key_value\n      ORDER BY count DESC\n      LIMIT 20\n    `);\n\n    const commonMistakes = mistakesQuery.rows.map((row: any) => ({\n      expectedKey: row.expected_key || '',\n      typedKey: row.typed_key || '?',\n      count: Number(row.count) || 0,\n    }));\n\n    return {\n      wpmOverTime,\n      mistakesHeatmap,\n      consistency,\n      commonMistakes,\n    };\n  }\n\n  async getHistoricalTrends(userId: string): Promise<{\n    weeklyAggregates: Array<{\n      weekStart: string;\n      weekEnd: string;\n      avgWpm: number;\n      avgAccuracy: number;\n      testCount: number;\n      bestWpm: number;\n    }>;\n    monthlyAggregates: Array<{\n      month: string;\n      avgWpm: number;\n      avgAccuracy: number;\n      testCount: number;\n      bestWpm: number;\n    }>;\n    improvement: {\n      weekOverWeek: { wpm: number; accuracy: number };\n      monthOverMonth: { wpm: number; accuracy: number };\n      allTime: { firstWpm: number; currentWpm: number; improvementPercent: number };\n    };\n    milestones: Array<{\n      type: string;\n      value: number;\n      achievedAt: string;\n    }>;\n  }> {\n    const weeklyQuery = await db.execute(sql`\n      SELECT \n        DATE_TRUNC('week', created_at)::date as week_start,\n        (DATE_TRUNC('week', created_at) + INTERVAL '6 days')::date as week_end,\n        ROUND(AVG(wpm))::int as avg_wpm,\n        ROUND(AVG(accuracy)::numeric, 1) as avg_accuracy,\n        COUNT(*)::int as test_count,\n        MAX(wpm)::int as best_wpm\n      FROM test_results\n      WHERE user_id = ${userId}\n        AND created_at >= NOW() - INTERVAL '12 weeks'\n      GROUP BY DATE_TRUNC('week', created_at)\n      ORDER BY week_start ASC\n    `);\n\n    const weeklyAggregates = weeklyQuery.rows.map((row: any) => ({\n      weekStart: row.week_start?.toISOString?.()?.split('T')[0] || String(row.week_start),\n      weekEnd: row.week_end?.toISOString?.()?.split('T')[0] || String(row.week_end),\n      avgWpm: Number(row.avg_wpm) || 0,\n      avgAccuracy: Number(row.avg_accuracy) || 0,\n      testCount: Number(row.test_count) || 0,\n      bestWpm: Number(row.best_wpm) || 0,\n    }));\n\n    const monthlyQuery = await db.execute(sql`\n      SELECT \n        TO_CHAR(DATE_TRUNC('month', created_at), 'YYYY-MM') as month,\n        ROUND(AVG(wpm))::int as avg_wpm,\n        ROUND(AVG(accuracy)::numeric, 1) as avg_accuracy,\n        COUNT(*)::int as test_count,\n        MAX(wpm)::int as best_wpm\n      FROM test_results\n      WHERE user_id = ${userId}\n        AND created_at >= NOW() - INTERVAL '12 months'\n      GROUP BY DATE_TRUNC('month', created_at)\n      ORDER BY month ASC\n    `);\n\n    const monthlyAggregates = monthlyQuery.rows.map((row: any) => ({\n      month: row.month || '',\n      avgWpm: Number(row.avg_wpm) || 0,\n      avgAccuracy: Number(row.avg_accuracy) || 0,\n      testCount: Number(row.test_count) || 0,\n      bestWpm: Number(row.best_wpm) || 0,\n    }));\n\n    let weekOverWeek = { wpm: 0, accuracy: 0 };\n    if (weeklyAggregates.length >= 2) {\n      const current = weeklyAggregates[weeklyAggregates.length - 1];\n      const previous = weeklyAggregates[weeklyAggregates.length - 2];\n      weekOverWeek = {\n        wpm: current.avgWpm - previous.avgWpm,\n        accuracy: Math.round((current.avgAccuracy - previous.avgAccuracy) * 10) / 10,\n      };\n    }\n\n    let monthOverMonth = { wpm: 0, accuracy: 0 };\n    if (monthlyAggregates.length >= 2) {\n      const current = monthlyAggregates[monthlyAggregates.length - 1];\n      const previous = monthlyAggregates[monthlyAggregates.length - 2];\n      monthOverMonth = {\n        wpm: current.avgWpm - previous.avgWpm,\n        accuracy: Math.round((current.avgAccuracy - previous.avgAccuracy) * 10) / 10,\n      };\n    }\n\n    const allTimeQuery = await db.execute(sql`\n      WITH first_last AS (\n        SELECT \n          (SELECT wpm FROM test_results WHERE user_id = ${userId} ORDER BY created_at ASC LIMIT 1) as first_wpm,\n          (SELECT ROUND(AVG(wpm))::int FROM test_results WHERE user_id = ${userId} AND created_at >= NOW() - INTERVAL '7 days') as current_wpm\n      )\n      SELECT first_wpm, current_wpm FROM first_last\n    `);\n\n    const allTimeRow = allTimeQuery.rows[0] as any;\n    const firstWpm = Number(allTimeRow?.first_wpm) || 0;\n    const currentWpm = Number(allTimeRow?.current_wpm) || 0;\n    const improvementPercent = firstWpm > 0 ? Math.round(((currentWpm - firstWpm) / firstWpm) * 100) : 0;\n\n    const milestonesQuery = await db.execute(sql`\n      SELECT \n        'wpm_record' as type,\n        wpm as value,\n        TO_CHAR(created_at, 'YYYY-MM-DD') as achieved_at\n      FROM test_results\n      WHERE user_id = ${userId}\n        AND wpm = (SELECT MAX(wpm) FROM test_results WHERE user_id = ${userId})\n      ORDER BY created_at ASC\n      LIMIT 1\n    `);\n\n    const milestones = milestonesQuery.rows.map((row: any) => ({\n      type: row.type || 'wpm_record',\n      value: Number(row.value) || 0,\n      achievedAt: row.achieved_at || '',\n    }));\n\n    return {\n      weeklyAggregates,\n      monthlyAggregates,\n      improvement: {\n        weekOverWeek,\n        monthOverMonth,\n        allTime: { firstWpm, currentWpm, improvementPercent },\n      },\n      milestones,\n    };\n  }\n\n  async getUserBadgeData(userId: string): Promise<{\n    bestWpm: number;\n    bestAccuracy: number;\n    totalTests: number;\n    currentStreak: number;\n    bestStreak: number;\n  }> {\n    // Get user stats for badges\n    const statsResult = await db\n      .select({\n        totalTests: sql<number>`count(*)::int`,\n        bestWpm: sql<number>`max(${testResults.wpm})::int`,\n        bestAccuracy: sql<number>`max(${testResults.accuracy})::float`,\n      })\n      .from(testResults)\n      .where(eq(testResults.userId, userId));\n\n    const stats = statsResult[0];\n\n    // Get streak data from user table\n    const user = await this.getUser(userId);\n\n    return {\n      bestWpm: stats?.bestWpm || 0,\n      bestAccuracy: stats?.bestAccuracy || 0,\n      totalTests: stats?.totalTests || 0,\n      currentStreak: user?.currentStreak || 0,\n      bestStreak: user?.bestStreak || 0,\n    };\n  }\n\n  async updateUserStreak(userId: string): Promise<void> {\n    const user = await this.getUser(userId);\n    if (!user) return;\n\n    const now = new Date();\n    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());\n    \n    let newStreak = 1;\n    let newBestStreak = user.bestStreak;\n\n    if (user.lastTestDate) {\n      const lastTestDate = new Date(user.lastTestDate);\n      const lastTest = new Date(lastTestDate.getFullYear(), lastTestDate.getMonth(), lastTestDate.getDate());\n      const daysDiff = Math.floor((today.getTime() - lastTest.getTime()) / (1000 * 60 * 60 * 24));\n\n      if (daysDiff === 0) {\n        // Same day, don't update streak\n        return;\n      } else if (daysDiff === 1) {\n        // Consecutive day, increment streak\n        newStreak = user.currentStreak + 1;\n      }\n      // If daysDiff > 1, streak is broken, reset to 1\n    }\n\n    // Update best streak if current is higher\n    if (newStreak > newBestStreak) {\n      newBestStreak = newStreak;\n    }\n\n    await db\n      .update(users)\n      .set({\n        currentStreak: newStreak,\n        bestStreak: newBestStreak,\n        lastTestDate: now,\n      })\n      .where(eq(users.id, userId));\n  }\n\n  // Multiplayer Racing Methods\n  async createRace(race: InsertRace): Promise<Race> {\n    const result = await db.insert(races).values(race).returning();\n    return result[0];\n  }\n\n  async getRace(id: number): Promise<Race | undefined> {\n    const result = await db.select().from(races).where(eq(races.id, id)).limit(1);\n    return result[0];\n  }\n\n  async getRaceByCode(roomCode: string): Promise<Race | undefined> {\n    const result = await db.select().from(races).where(eq(races.roomCode, roomCode)).limit(1);\n    return result[0];\n  }\n\n  async updateRaceStatus(id: number, status: string, startedAt?: Date, finishedAt?: Date): Promise<void> {\n    const updateData: any = { status };\n    if (startedAt) updateData.startedAt = startedAt;\n    if (finishedAt) updateData.finishedAt = finishedAt;\n    await db.update(races).set(updateData).where(eq(races.id, id));\n  }\n\n  async updateRaceTimeLimitSeconds(id: number, timeLimitSeconds: number): Promise<void> {\n    await db.update(races).set({ timeLimitSeconds }).where(eq(races.id, id));\n  }\n\n  async extendRaceParagraph(id: number, additionalContent: string): Promise<Race | undefined> {\n    const race = await this.getRace(id);\n    if (!race) return undefined;\n    \n    const newContent = race.paragraphContent + \" \" + additionalContent;\n    await db.update(races).set({ paragraphContent: newContent }).where(eq(races.id, id));\n    \n    return { ...race, paragraphContent: newContent };\n  }\n\n  async getActiveRaces(): Promise<Race[]> {\n    return await db\n      .select()\n      .from(races)\n      .where(sql`${races.status} IN ('waiting', 'countdown', 'racing')`)\n      .orderBy(desc(races.createdAt));\n  }\n\n  async createRaceParticipant(participant: InsertRaceParticipant): Promise<RaceParticipant> {\n    const result = await db.insert(raceParticipants).values(participant).returning();\n    return result[0];\n  }\n\n  async getRaceParticipants(raceId: number): Promise<RaceParticipant[]> {\n    return await db\n      .select()\n      .from(raceParticipants)\n      .where(and(\n        eq(raceParticipants.raceId, raceId),\n        eq(raceParticipants.isActive, 1)\n      ))\n      .orderBy(raceParticipants.joinedAt);\n  }\n\n  async updateParticipantProgress(id: number, progress: number, wpm: number, accuracy: number, errors: number): Promise<void> {\n    await db\n      .update(raceParticipants)\n      .set({ progress, wpm, accuracy, errors })\n      .where(eq(raceParticipants.id, id));\n  }\n\n  async updateParticipantFinishPosition(id: number, position: number): Promise<void> {\n    await db\n      .update(raceParticipants)\n      .set({ finishPosition: position })\n      .where(eq(raceParticipants.id, id));\n  }\n\n  async finishParticipant(id: number): Promise<{ position: number; isNewFinish: boolean }> {\n    return await db.transaction(async (tx) => {\n      const participant = await tx\n        .select()\n        .from(raceParticipants)\n        .where(eq(raceParticipants.id, id))\n        .for(\"update\")\n        .limit(1);\n\n      if (!participant || participant.length === 0) {\n        throw new Error(\"Participant not found\");\n      }\n\n      if (participant[0].isFinished === 1 && participant[0].finishPosition !== null) {\n        return { position: participant[0].finishPosition, isNewFinish: false };\n      }\n\n      const result = await tx.execute(sql`\n        UPDATE races\n        SET finish_counter = finish_counter + 1\n        WHERE id = ${participant[0].raceId}\n        RETURNING finish_counter as position\n      `);\n\n      const rows = result.rows as Array<{ position: number }>;\n      const position = rows[0].position;\n\n      await tx\n        .update(raceParticipants)\n        .set({ \n          isFinished: 1, \n          finishPosition: position,\n          finishedAt: new Date()\n        })\n        .where(eq(raceParticipants.id, id));\n\n      return { position, isNewFinish: true };\n    });\n  }\n\n  async deleteRaceParticipant(id: number): Promise<void> {\n    await db\n      .update(raceParticipants)\n      .set({ isActive: 0 })\n      .where(eq(raceParticipants.id, id));\n  }\n\n  async reactivateRaceParticipant(id: number): Promise<RaceParticipant> {\n    const result = await db\n      .update(raceParticipants)\n      .set({ \n        isActive: 1,\n        progress: 0,\n        wpm: 0,\n        accuracy: 0,\n        errors: 0,\n        isFinished: 0,\n        finishPosition: null,\n        finishedAt: null,\n        joinedAt: new Date()\n      })\n      .where(eq(raceParticipants.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async findInactiveParticipant(raceId: number, userId?: string, guestName?: string): Promise<RaceParticipant | undefined> {\n    const conditions = [\n      eq(raceParticipants.raceId, raceId),\n      eq(raceParticipants.isActive, 0)\n    ];\n    \n    if (userId) {\n      conditions.push(eq(raceParticipants.userId, userId));\n    } else if (guestName) {\n      conditions.push(eq(raceParticipants.guestName, guestName));\n    }\n    \n    const result = await db\n      .select()\n      .from(raceParticipants)\n      .where(and(...conditions))\n      .limit(1);\n    \n    return result[0];\n  }\n\n  async getRaceWithParticipants(raceId: number): Promise<{ race: Race; participants: RaceParticipant[] } | undefined> {\n    const race = await this.getRace(raceId);\n    if (!race) return undefined;\n\n    const participants = await this.getRaceParticipants(raceId);\n    return { race, participants };\n  }\n\n  async getStaleRaces(waitingTimeout: number, countdownTimeout: number, racingTimeout: number): Promise<Race[]> {\n    const now = new Date();\n    const waitingCutoff = new Date(now.getTime() - waitingTimeout);\n    const countdownCutoff = new Date(now.getTime() - countdownTimeout);\n    const racingCutoff = new Date(now.getTime() - racingTimeout);\n\n    return await db\n      .select()\n      .from(races)\n      .where(\n        or(\n          and(eq(races.status, \"waiting\"), sql`${races.createdAt} < ${waitingCutoff}`),\n          and(eq(races.status, \"countdown\"), sql`${races.createdAt} < ${countdownCutoff}`),\n          and(eq(races.status, \"racing\"), sql`${races.startedAt} < ${racingCutoff}`)\n        )\n      )\n      .limit(100);\n  }\n\n  async cleanupOldFinishedRaces(retentionMs: number): Promise<number> {\n    const cutoff = new Date(Date.now() - retentionMs);\n    \n    const result = await db\n      .delete(races)\n      .where(\n        and(\n          eq(races.status, \"finished\"),\n          sql`${races.finishedAt} < ${cutoff}`\n        )\n      )\n      .returning({ id: races.id });\n    \n    return result.length;\n  }\n\n  async bulkUpdateParticipantProgress(updates: Map<number, { progress: number; wpm: number; accuracy: number; errors: number }>): Promise<void> {\n    if (updates.size === 0) return;\n\n    const entries = Array.from(updates.entries());\n    \n    if (entries.length === 1) {\n      const [id, data] = entries[0];\n      await db\n        .update(raceParticipants)\n        .set({\n          progress: data.progress,\n          wpm: data.wpm,\n          accuracy: data.accuracy,\n          errors: data.errors,\n        })\n        .where(eq(raceParticipants.id, id));\n      return;\n    }\n\n    const BATCH_SIZE = 10;\n    const MAX_CONCURRENT = 3;\n\n    const batches: typeof entries[] = [];\n    for (let i = 0; i < entries.length; i += BATCH_SIZE) {\n      batches.push(entries.slice(i, i + BATCH_SIZE));\n    }\n\n    for (let i = 0; i < batches.length; i += MAX_CONCURRENT) {\n      const concurrentBatches = batches.slice(i, i + MAX_CONCURRENT);\n      \n      await Promise.all(concurrentBatches.map(async (batch) => {\n        for (const [id, data] of batch) {\n          await db\n            .update(raceParticipants)\n            .set({\n              progress: data.progress,\n              wpm: data.wpm,\n              accuracy: data.accuracy,\n              errors: data.errors,\n            })\n            .where(eq(raceParticipants.id, id));\n        }\n      }));\n    }\n  }\n\n  async createCodeSnippet(snippet: InsertCodeSnippet): Promise<CodeSnippet> {\n    const result = await db.insert(codeSnippets).values(snippet).returning();\n    return result[0];\n  }\n\n  async getCodeSnippet(id: number): Promise<CodeSnippet | undefined> {\n    const result = await db.select().from(codeSnippets).where(eq(codeSnippets.id, id)).limit(1);\n    return result[0];\n  }\n\n  async getRandomCodeSnippet(language: string, difficulty?: string, framework?: string): Promise<CodeSnippet | undefined> {\n    const conditions = [eq(codeSnippets.programmingLanguage, language)];\n    \n    if (difficulty) {\n      conditions.push(eq(codeSnippets.difficulty, difficulty));\n    }\n    \n    if (framework) {\n      conditions.push(eq(codeSnippets.framework, framework));\n    }\n    \n    const snippets = await db\n      .select()\n      .from(codeSnippets)\n      .where(and(...conditions));\n    \n    if (snippets.length > 0) {\n      const randomIndex = Math.floor(Math.random() * snippets.length);\n      return snippets[randomIndex];\n    }\n    \n    return undefined;\n  }\n\n  async getAvailableProgrammingLanguages(): Promise<string[]> {\n    const result = await db\n      .selectDistinct({ language: codeSnippets.programmingLanguage })\n      .from(codeSnippets);\n    return result.map(r => r.language);\n  }\n\n  async getAvailableFrameworks(language?: string): Promise<string[]> {\n    let query = db.selectDistinct({ framework: codeSnippets.framework }).from(codeSnippets);\n    \n    if (language) {\n      query = query.where(and(\n        eq(codeSnippets.programmingLanguage, language),\n        sql`${codeSnippets.framework} IS NOT NULL`\n      )) as any;\n    } else {\n      query = query.where(sql`${codeSnippets.framework} IS NOT NULL`) as any;\n    }\n    \n    const result = await query;\n    return result.map(r => r.framework).filter(f => f !== null) as string[];\n  }\n\n  async createCodeTypingTest(test: InsertCodeTypingTest): Promise<CodeTypingTest> {\n    const result = await db.insert(codeTypingTests).values(test).returning();\n    return result[0];\n  }\n\n  async getUserCodeTypingTests(userId: string, limit: number = 10): Promise<CodeTypingTest[]> {\n    return await db\n      .select()\n      .from(codeTypingTests)\n      .where(eq(codeTypingTests.userId, userId))\n      .orderBy(desc(codeTypingTests.createdAt))\n      .limit(limit);\n  }\n\n  async getUserCodeStats(userId: string, language?: string): Promise<{\n    totalTests: number;\n    bestWpm: number;\n    avgWpm: number;\n    avgAccuracy: number;\n    totalSyntaxErrors: number;\n  } | null> {\n    const conditions = [eq(codeTypingTests.userId, userId)];\n    if (language) {\n      conditions.push(eq(codeTypingTests.programmingLanguage, language));\n    }\n\n    const result = await db\n      .select({\n        totalTests: sql<number>`count(*)::int`,\n        bestWpm: sql<number>`COALESCE(max(${codeTypingTests.wpm}), 0)::int`,\n        avgWpm: sql<number>`COALESCE(ROUND(avg(${codeTypingTests.wpm})), 0)::int`,\n        avgAccuracy: sql<number>`COALESCE(ROUND(avg(${codeTypingTests.accuracy})::numeric, 1), 0)::float`,\n        totalSyntaxErrors: sql<number>`COALESCE(sum(${codeTypingTests.syntaxErrors}), 0)::int`,\n      })\n      .from(codeTypingTests)\n      .where(and(...conditions));\n\n    if (!result[0] || result[0].totalTests === 0) {\n      return null;\n    }\n\n    return result[0];\n  }\n\n  async getCodeLeaderboard(language?: string, limit: number = 20): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    programmingLanguage: string;\n    framework: string | null;\n    createdAt: Date;\n    avatarColor: string | null;\n    totalTests: number;\n  }>> {\n    const languageFilter = language ? sql`AND ct.programming_language = ${language}` : sql``;\n\n    const leaderboard = await db.execute(sql`\n      WITH ranked_results AS (\n        SELECT \n          ct.user_id,\n          ct.wpm,\n          ct.accuracy,\n          ct.programming_language,\n          ct.framework,\n          ct.created_at,\n          ROW_NUMBER() OVER (\n            PARTITION BY ct.user_id ${language ? sql`, ct.programming_language` : sql``}\n            ORDER BY ct.wpm DESC, ct.created_at DESC\n          ) as rank\n        FROM code_typing_tests ct\n        WHERE 1=1 ${languageFilter}\n      ),\n      test_counts AS (\n        SELECT \n          user_id,\n          ${language ? sql`programming_language,` : sql``}\n          COUNT(*)::int as total_tests\n        FROM code_typing_tests\n        WHERE 1=1 ${languageFilter}\n        GROUP BY user_id ${language ? sql`, programming_language` : sql``}\n      )\n      SELECT \n        rr.user_id as \"userId\",\n        u.username,\n        rr.wpm,\n        rr.accuracy,\n        rr.programming_language as \"programmingLanguage\",\n        rr.framework,\n        rr.created_at as \"createdAt\",\n        u.avatar_color as \"avatarColor\",\n        COALESCE(tc.total_tests, 1) as \"totalTests\"\n      FROM ranked_results rr\n      INNER JOIN users u ON rr.user_id = u.id\n      LEFT JOIN test_counts tc ON rr.user_id = tc.user_id ${language ? sql`AND rr.programming_language = tc.programming_language` : sql``}\n      WHERE rr.rank = 1\n      ORDER BY rr.wpm DESC, rr.created_at DESC\n      LIMIT ${limit}\n    `);\n\n    return leaderboard.rows as any[];\n  }\n\n  async createSharedCodeResult(result: InsertSharedCodeResult): Promise<SharedCodeResult> {\n    const inserted = await db.insert(sharedCodeResults).values(result).returning();\n    return inserted[0];\n  }\n\n  async getSharedCodeResult(shareId: string): Promise<SharedCodeResult | undefined> {\n    const result = await db\n      .select()\n      .from(sharedCodeResults)\n      .where(eq(sharedCodeResults.shareId, shareId))\n      .limit(1);\n    return result[0];\n  }\n\n  async getBookParagraphs(filters: { difficulty?: string; topic?: string; durationMode?: number; limit?: number }): Promise<BookParagraph[]> {\n    const conditions = [];\n    \n    if (filters.difficulty) {\n      conditions.push(eq(bookParagraphs.difficulty, filters.difficulty));\n    }\n    \n    if (filters.topic) {\n      conditions.push(eq(bookParagraphs.topic, filters.topic));\n    }\n    \n    if (filters.durationMode) {\n      conditions.push(eq(bookParagraphs.durationMode, filters.durationMode));\n    }\n    \n    const limit = filters.limit || 10;\n    \n    let query = db.select().from(bookParagraphs);\n    \n    if (conditions.length > 0) {\n      query = query.where(and(...conditions)) as any;\n    }\n    \n    const result = await query.orderBy(sql`RANDOM()`).limit(limit);\n    return result;\n  }\n\n  async getRandomBookParagraph(filters?: { difficulty?: string; topic?: string; durationMode?: number }): Promise<BookParagraph | null> {\n    const conditions = [];\n    \n    if (filters?.difficulty) {\n      conditions.push(eq(bookParagraphs.difficulty, filters.difficulty));\n    }\n    \n    if (filters?.topic) {\n      conditions.push(eq(bookParagraphs.topic, filters.topic));\n    }\n    \n    if (filters?.durationMode) {\n      conditions.push(eq(bookParagraphs.durationMode, filters.durationMode));\n    }\n    \n    let query = db.select().from(bookParagraphs);\n    \n    if (conditions.length > 0) {\n      query = query.where(and(...conditions)) as any;\n    }\n    \n    const result = await query.orderBy(sql`RANDOM()`).limit(1);\n    return result[0] || null;\n  }\n\n  async getBookTopics(): Promise<string[]> {\n    const result = await db\n      .selectDistinct({ topic: bookParagraphs.topic })\n      .from(bookParagraphs)\n      .orderBy(bookParagraphs.topic);\n    return result.map(r => r.topic);\n  }\n\n  async getBookParagraphById(id: number): Promise<BookParagraph | null> {\n    const result = await db\n      .select()\n      .from(bookParagraphs)\n      .where(eq(bookParagraphs.id, id))\n      .limit(1);\n    return result[0] || null;\n  }\n\n  async getNextBookParagraph(bookId: number, currentParagraphIndex: number): Promise<BookParagraph | null> {\n    const result = await db\n      .select()\n      .from(bookParagraphs)\n      .where(and(\n        eq(bookParagraphs.bookId, bookId),\n        eq(bookParagraphs.paragraphIndex, currentParagraphIndex + 1)\n      ))\n      .limit(1);\n    return result[0] || null;\n  }\n\n  async insertBook(book: InsertBook): Promise<void> {\n    try {\n      await db.insert(books).values(book).onConflictDoNothing();\n    } catch (error) {\n      console.error(\"Error inserting book:\", error);\n      throw new Error(\"Failed to insert book\");\n    }\n  }\n\n  async insertBookParagraphs(paragraphs: InsertBookParagraph[]): Promise<void> {\n    if (paragraphs.length === 0) return;\n    \n    try {\n      await db.insert(bookParagraphs).values(paragraphs);\n    } catch (error) {\n      console.error(\"Error inserting book paragraphs:\", error);\n      throw new Error(\"Failed to insert book paragraphs\");\n    }\n  }\n\n  async getAllBooks(): Promise<Book[]> {\n    return await db.select().from(books).orderBy(books.title);\n  }\n\n  async getBookById(id: number): Promise<Book | null> {\n    const result = await db.select().from(books).where(eq(books.id, id)).limit(1);\n    return result[0] || null;\n  }\n\n  async getBookBySlug(slug: string): Promise<Book | null> {\n    const result = await db.select().from(books).where(eq(books.slug, slug)).limit(1);\n    return result[0] || null;\n  }\n\n  async getBookChapters(bookId: number): Promise<Array<{ chapter: number; title: string | null; paragraphCount: number }>> {\n    // Group only by chapter number, and get the first non-null title using MIN\n    // This prevents duplicates when different paragraphs have different titles\n    const result = await db\n      .select({\n        chapter: bookParagraphs.chapter,\n        title: sql<string | null>`MIN(${bookParagraphs.chapterTitle})`,\n        paragraphCount: sql<number>`count(*)::int`,\n      })\n      .from(bookParagraphs)\n      .where(eq(bookParagraphs.bookId, bookId))\n      .groupBy(bookParagraphs.chapter)\n      .orderBy(bookParagraphs.chapter);\n    \n    // Clean up noisy titles that look like content snippets instead of real chapter titles\n    const isValidTitle = (title: string | null): boolean => {\n      if (!title) return false;\n      // Reject titles that look like dialogue or content (start with lowercase, contain quotes, etc.)\n      if (/^[a-z]/.test(title)) return false; // Starts with lowercase\n      if (/^[\"']/.test(title)) return false; // Starts with quote\n      if (title.length > 80) return false; // Too long to be a chapter title\n      return true;\n    };\n    \n    return result.map(r => ({\n      chapter: r.chapter || 1,\n      title: isValidTitle(r.title) ? r.title : null,\n      paragraphCount: r.paragraphCount,\n    }));\n  }\n\n  async getChapterParagraphs(bookId: number, chapter: number): Promise<BookParagraph[]> {\n    return await db\n      .select()\n      .from(bookParagraphs)\n      .where(and(\n        eq(bookParagraphs.bookId, bookId),\n        eq(bookParagraphs.chapter, chapter)\n      ))\n      .orderBy(bookParagraphs.paragraphIndex);\n  }\n\n  async createBookTestResult(result: InsertBookTypingTest): Promise<BookTypingTest> {\n    const inserted = await db.insert(bookTypingTests).values(result).returning();\n    return inserted[0];\n  }\n\n  async getBookTestResults(userId: string, limit: number = 20): Promise<BookTypingTest[]> {\n    return await db\n      .select()\n      .from(bookTypingTests)\n      .where(eq(bookTypingTests.userId, userId))\n      .orderBy(desc(bookTypingTests.createdAt))\n      .limit(limit);\n  }\n\n  async getRandomDictationSentence(difficulty?: string, category?: string, excludeIds?: number[]): Promise<DictationSentence | undefined> {\n    const conditions = [];\n    \n    if (difficulty) {\n      conditions.push(eq(dictationSentences.difficulty, difficulty));\n    }\n    \n    if (category) {\n      conditions.push(eq(dictationSentences.category, category));\n    }\n    \n    if (excludeIds && excludeIds.length > 0) {\n      conditions.push(notInArray(dictationSentences.id, excludeIds));\n    }\n    \n    let query = db.select().from(dictationSentences);\n    \n    if (conditions.length > 0) {\n      query = query.where(and(...conditions)) as any;\n    }\n    \n    const result = await query.orderBy(sql`RANDOM()`).limit(1);\n    return result[0];\n  }\n\n  async createDictationTest(test: InsertDictationTest): Promise<DictationTest> {\n    const inserted = await db.insert(dictationTests).values(test).returning();\n    return inserted[0];\n  }\n\n  async getDictationTestById(id: number): Promise<DictationTest | undefined> {\n    const result = await db\n      .select()\n      .from(dictationTests)\n      .where(eq(dictationTests.id, id))\n      .limit(1);\n    return result[0];\n  }\n\n  async getUserDictationStats(userId: string): Promise<{\n    totalTests: number;\n    bestWpm: number;\n    avgWpm: number;\n    avgAccuracy: number;\n    totalReplays: number;\n  } | null> {\n    const result = await db\n      .select({\n        totalTests: sql<number>`count(*)::int`,\n        bestWpm: sql<number>`max(${dictationTests.wpm})::int`,\n        avgWpm: sql<number>`round(avg(${dictationTests.wpm}))::int`,\n        avgAccuracy: sql<number>`round(avg(${dictationTests.accuracy}))`,\n        totalReplays: sql<number>`sum(${dictationTests.replayCount})::int`,\n      })\n      .from(dictationTests)\n      .where(eq(dictationTests.userId, userId));\n\n    if (!result[0] || result[0].totalTests === 0) {\n      return null;\n    }\n\n    return {\n      totalTests: result[0].totalTests,\n      bestWpm: result[0].bestWpm || 0,\n      avgWpm: result[0].avgWpm || 0,\n      avgAccuracy: result[0].avgAccuracy || 0,\n      totalReplays: result[0].totalReplays || 0,\n    };\n  }\n\n  async getDictationLeaderboard(limit: number = 10): Promise<Array<{\n    userId: string;\n    username: string;\n    wpm: number;\n    accuracy: number;\n    speedLevel: string;\n    createdAt: Date;\n    avatarColor: string | null;\n    totalTests: number;\n  }>> {\n    const topScores = await db\n      .select({\n        userId: dictationTests.userId,\n        username: users.username,\n        wpm: dictationTests.wpm,\n        accuracy: dictationTests.accuracy,\n        speedLevel: dictationTests.speedLevel,\n        createdAt: dictationTests.createdAt,\n        avatarColor: users.avatarColor,\n        totalTests: sql<number>`count(*) OVER (PARTITION BY ${dictationTests.userId})::int`,\n      })\n      .from(dictationTests)\n      .innerJoin(users, eq(dictationTests.userId, users.id))\n      .orderBy(desc(dictationTests.wpm), desc(dictationTests.accuracy))\n      .limit(limit);\n\n    return topScores.map(score => ({\n      userId: score.userId,\n      username: score.username,\n      wpm: score.wpm,\n      accuracy: score.accuracy,\n      speedLevel: score.speedLevel,\n      createdAt: score.createdAt,\n      avatarColor: score.avatarColor,\n      totalTests: score.totalTests,\n    }));\n  }\n\n  async createStressTest(test: InsertStressTest): Promise<StressTest> {\n    // Production-ready upsert: Keep all test history for stats but use\n    // INSERT ON CONFLICT to optimize storage for leaderboard entries\n    // For leaderboard: only keep best score per user per difficulty\n    // For stats: we keep all records to track total tests, averages, etc.\n    \n    // First, check if user already has an entry for this difficulty with a LOWER score\n    // If so, and the new score is higher, we can optionally update or just insert\n    // For now, we insert all records for accurate stats (total tests, avg score)\n    // The leaderboard query already handles showing only the best score\n    const inserted = await db.insert(stressTests).values(test).returning();\n    return inserted[0];\n  }\n  \n  async upsertStressTestBestScore(test: InsertStressTest): Promise<{ result: StressTest; isNewPersonalBest: boolean }> {\n    // Production-ready atomic upsert using PostgreSQL's INSERT ON CONFLICT\n    // Uses WHERE clause to compare EXCLUDED vs existing row at conflict time (not pre-insert)\n    // This ensures race-safe atomic updates - only updates when new score beats existing\n    \n    const result = await db.execute(sql`\n      INSERT INTO stress_tests (\n        user_id, difficulty, enabled_effects, wpm, accuracy, errors,\n        max_combo, total_characters, duration, survival_time,\n        completion_rate, stress_score, created_at\n      )\n      VALUES (\n        ${test.userId}, ${test.difficulty}, ${JSON.stringify(test.enabledEffects)}::jsonb,\n        ${test.wpm}, ${test.accuracy}, ${test.errors}, ${test.maxCombo},\n        ${test.totalCharacters}, ${test.duration}, ${test.survivalTime},\n        ${test.completionRate}, ${test.stressScore}, NOW()\n      )\n      ON CONFLICT (user_id, difficulty) \n      DO UPDATE SET\n        enabled_effects = EXCLUDED.enabled_effects,\n        wpm = EXCLUDED.wpm,\n        accuracy = EXCLUDED.accuracy,\n        errors = EXCLUDED.errors,\n        max_combo = EXCLUDED.max_combo,\n        total_characters = EXCLUDED.total_characters,\n        duration = EXCLUDED.duration,\n        survival_time = EXCLUDED.survival_time,\n        completion_rate = EXCLUDED.completion_rate,\n        stress_score = EXCLUDED.stress_score,\n        created_at = EXCLUDED.created_at\n      WHERE \n        EXCLUDED.stress_score > stress_tests.stress_score \n        OR (EXCLUDED.stress_score = stress_tests.stress_score AND EXCLUDED.wpm > stress_tests.wpm)\n      RETURNING *, (xmax = 0) as is_insert\n    `);\n    \n    // If no rows returned, the WHERE condition failed (existing score is better)\n    // Need to fetch the existing record\n    if (result.rows.length === 0) {\n      const existing = await db\n        .select()\n        .from(stressTests)\n        .where(\n          and(\n            eq(stressTests.userId, test.userId),\n            eq(stressTests.difficulty, test.difficulty)\n          )\n        )\n        .limit(1);\n      \n      return {\n        result: existing[0],\n        isNewPersonalBest: false,\n      };\n    }\n    \n    const row = result.rows[0] as any;\n    // If row was returned, it means either:\n    // 1. New insert (is_insert = true, xmax = 0)\n    // 2. Update occurred because WHERE condition passed (xmax != 0)\n    // Either way, this is a new personal best\n    const isNewPersonalBest = true;\n    \n    return {\n      result: {\n        id: row.id,\n        userId: row.user_id,\n        difficulty: row.difficulty,\n        enabledEffects: row.enabled_effects,\n        wpm: row.wpm,\n        accuracy: row.accuracy,\n        errors: row.errors,\n        maxCombo: row.max_combo,\n        totalCharacters: row.total_characters,\n        duration: row.duration,\n        survivalTime: row.survival_time,\n        completionRate: row.completion_rate,\n        stressScore: row.stress_score,\n        createdAt: row.created_at,\n      },\n      isNewPersonalBest,\n    };\n  }\n\n  async getUserStressTests(userId: string, limit: number = 10): Promise<StressTest[]> {\n    return await db\n      .select()\n      .from(stressTests)\n      .where(eq(stressTests.userId, userId))\n      .orderBy(desc(stressTests.createdAt))\n      .limit(limit);\n  }\n\n  async getStressTestLeaderboard(difficulty?: string, limit: number = 50): Promise<Array<{\n    userId: string;\n    username: string;\n    difficulty: string;\n    stressScore: number;\n    wpm: number;\n    accuracy: number;\n    completionRate: number;\n    avatarColor: string | null;\n    createdAt: Date;\n    rank: number;\n  }>> {\n    // Production-ready leaderboard query using ROW_NUMBER() to guarantee exactly\n    // one entry per user per difficulty, with proper tiebreaking by WPM and date\n    const difficultyFilter = difficulty ? sql`AND st.difficulty = ${difficulty}` : sql``;\n    \n    const leaderboard = await db.execute(sql`\n      WITH ranked_scores AS (\n        SELECT \n          st.user_id,\n          st.difficulty,\n          st.stress_score,\n          st.wpm,\n          st.accuracy,\n          st.completion_rate,\n          st.created_at,\n          ROW_NUMBER() OVER (\n            PARTITION BY st.user_id, st.difficulty\n            ORDER BY st.stress_score DESC, st.wpm DESC, st.created_at DESC\n          ) as user_rank\n        FROM stress_tests st\n        WHERE 1=1 ${difficultyFilter}\n      ),\n      best_scores AS (\n        SELECT * FROM ranked_scores WHERE user_rank = 1\n      ),\n      final_ranking AS (\n        SELECT \n          bs.user_id as \"userId\",\n          u.username,\n          bs.difficulty,\n          bs.stress_score as \"stressScore\",\n          bs.wpm,\n          bs.accuracy,\n          bs.completion_rate as \"completionRate\",\n          u.avatar_color as \"avatarColor\",\n          bs.created_at as \"createdAt\",\n          DENSE_RANK() OVER (\n            ORDER BY bs.stress_score DESC, bs.wpm DESC, bs.created_at ASC\n          ) as rank\n        FROM best_scores bs\n        INNER JOIN users u ON bs.user_id = u.id\n      )\n      SELECT * FROM final_ranking\n      ORDER BY rank ASC, \"stressScore\" DESC, wpm DESC\n      LIMIT ${limit}\n    `);\n\n    return leaderboard.rows as any[];\n  }\n\n  async getUserStressStats(userId: string): Promise<{\n    totalTests: number;\n    bestScore: number;\n    avgScore: number;\n    completedTests: number;\n    difficultiesCompleted: string[];\n  } | null> {\n    const tests = await db\n      .select()\n      .from(stressTests)\n      .where(eq(stressTests.userId, userId));\n\n    if (tests.length === 0) return null;\n\n    const completedTests = tests.filter(t => t.completionRate >= 100).length;\n    const difficultiesSet = new Set(\n      tests.filter(t => t.completionRate >= 100).map(t => t.difficulty)\n    );\n    const difficultiesCompleted = Array.from(difficultiesSet);\n\n    return {\n      totalTests: tests.length,\n      bestScore: Math.max(...tests.map(t => t.stressScore)),\n      avgScore: Math.round(tests.reduce((sum, t) => sum + t.stressScore, 0) / tests.length),\n      completedTests,\n      difficultiesCompleted,\n    };\n  }\n\n  async createSharedResult(result: InsertSharedResult): Promise<SharedResult> {\n    const inserted = await db.insert(sharedResults).values(result).returning();\n    return inserted[0];\n  }\n\n  async getSharedResult(shareToken: string): Promise<SharedResult | undefined> {\n    const result = await db\n      .select()\n      .from(sharedResults)\n      .where(eq(sharedResults.shareToken, shareToken))\n      .limit(1);\n    return result[0];\n  }\n\n  async incrementShareViewCount(shareToken: string): Promise<void> {\n    await db\n      .update(sharedResults)\n      .set({ viewCount: sql`${sharedResults.viewCount} + 1` })\n      .where(eq(sharedResults.shareToken, shareToken));\n  }\n\n  async saveKeystrokeEvents(events: InsertKeystrokeEvent[]): Promise<void> {\n    if (events.length === 0) return;\n    await db.insert(keystrokeEvents).values(events);\n  }\n\n  async saveTypingAnalytics(analytics: InsertTypingAnalytics): Promise<TypingAnalytics> {\n    const inserted = await db.insert(typingAnalytics).values(analytics).returning();\n    return inserted[0];\n  }\n\n  async getUserTypingAnalytics(userId: string, limit: number = 20): Promise<TypingAnalytics[]> {\n    const results = await db\n      .select()\n      .from(typingAnalytics)\n      .where(eq(typingAnalytics.userId, userId))\n      .orderBy(desc(typingAnalytics.createdAt))\n      .limit(limit);\n    return results;\n  }\n\n  async getTypingAnalyticsById(id: number): Promise<TypingAnalytics | undefined> {\n    const result = await db\n      .select()\n      .from(typingAnalytics)\n      .where(eq(typingAnalytics.id, id))\n      .limit(1);\n    return result[0];\n  }\n\n  async saveTypingInsight(insight: InsertTypingInsight): Promise<TypingInsight> {\n    const inserted = await db.insert(typingInsights).values(insight).returning();\n    return inserted[0];\n  }\n\n  async getUserTypingInsights(userId: string): Promise<TypingInsight[]> {\n    const results = await db\n      .select()\n      .from(typingInsights)\n      .where(and(\n        eq(typingInsights.userId, userId),\n        eq(typingInsights.dismissed, false)\n      ))\n      .orderBy(desc(typingInsights.createdAt));\n    return results;\n  }\n\n  async dismissInsight(insightId: number): Promise<void> {\n    await db\n      .update(typingInsights)\n      .set({ dismissed: true, updatedAt: new Date() })\n      .where(eq(typingInsights.id, insightId));\n  }\n\n  async savePracticeRecommendation(recommendation: InsertPracticeRecommendation): Promise<PracticeRecommendation> {\n    const inserted = await db.insert(practiceRecommendations).values(recommendation).returning();\n    return inserted[0];\n  }\n\n  async getUserPracticeRecommendations(userId: string): Promise<PracticeRecommendation[]> {\n    const results = await db\n      .select()\n      .from(practiceRecommendations)\n      .where(and(\n        eq(practiceRecommendations.userId, userId),\n        eq(practiceRecommendations.completed, false)\n      ))\n      .orderBy(desc(practiceRecommendations.createdAt));\n    return results;\n  }\n\n  async completePracticeRecommendation(recommendationId: number): Promise<void> {\n    await db\n      .update(practiceRecommendations)\n      .set({ completed: true, completedAt: new Date() })\n      .where(eq(practiceRecommendations.id, recommendationId));\n  }\n\n  async createPushSubscription(subscription: InsertPushSubscription): Promise<PushSubscription> {\n    const inserted = await db.insert(pushSubscriptions).values(subscription).returning();\n    return inserted[0];\n  }\n\n  async getUserPushSubscriptions(userId: string): Promise<PushSubscription[]> {\n    const results = await db\n      .select()\n      .from(pushSubscriptions)\n      .where(eq(pushSubscriptions.userId, userId));\n    return results;\n  }\n\n  async deletePushSubscription(id: number): Promise<void> {\n    await db.delete(pushSubscriptions).where(eq(pushSubscriptions.id, id));\n  }\n\n  async findExistingSubscription(userId: string, endpoint: string): Promise<PushSubscription | undefined> {\n    const result = await db\n      .select()\n      .from(pushSubscriptions)\n      .where(and(\n        eq(pushSubscriptions.userId, userId),\n        eq(pushSubscriptions.endpoint, endpoint)\n      ))\n      .limit(1);\n    return result[0];\n  }\n\n  async getNotificationPreferences(userId: string): Promise<NotificationPreferences | undefined> {\n    const result = await db\n      .select()\n      .from(notificationPreferences)\n      .where(eq(notificationPreferences.userId, userId))\n      .limit(1);\n    return result[0];\n  }\n\n  async createNotificationPreferences(prefs: InsertNotificationPreferences): Promise<NotificationPreferences> {\n    const inserted = await db.insert(notificationPreferences).values(prefs).returning();\n    return inserted[0];\n  }\n\n  async updateNotificationPreferences(userId: string, prefs: Partial<NotificationPreferences>): Promise<NotificationPreferences> {\n    const { id, userId: _, createdAt, updatedAt: __, ...updateFields } = prefs;\n    const updated = await db\n      .update(notificationPreferences)\n      .set({ ...updateFields, updatedAt: new Date() })\n      .where(eq(notificationPreferences.userId, userId))\n      .returning();\n    return updated[0];\n  }\n\n  async createNotificationHistory(history: InsertNotificationHistory): Promise<NotificationHistory> {\n    const inserted = await db.insert(notificationHistory).values(history).returning();\n    return inserted[0];\n  }\n\n  async getUserNotificationHistory(userId: string, limit: number = 50): Promise<NotificationHistory[]> {\n    const results = await db\n      .select()\n      .from(notificationHistory)\n      .where(eq(notificationHistory.userId, userId))\n      .orderBy(desc(notificationHistory.createdAt))\n      .limit(limit);\n    return results;\n  }\n\n  async markNotificationDelivered(id: number): Promise<void> {\n    await db\n      .update(notificationHistory)\n      .set({ status: 'delivered', deliveredAt: new Date() })\n      .where(eq(notificationHistory.id, id));\n  }\n\n  async markNotificationClicked(id: number): Promise<void> {\n    await db\n      .update(notificationHistory)\n      .set({ status: 'clicked', clickedAt: new Date() })\n      .where(eq(notificationHistory.id, id));\n  }\n\n  async createNotificationJobs(jobs: InsertNotificationJob[]): Promise<NotificationJob[]> {\n    if (jobs.length === 0) return [];\n    const inserted = await db.insert(notificationJobs).values(jobs).returning();\n    return inserted;\n  }\n\n  async claimDueNotificationJobs(beforeUtc: Date, limit: number): Promise<NotificationJob[]> {\n    const claimed = await db.transaction(async (tx) => {\n      const dueJobs = await tx\n        .select()\n        .from(notificationJobs)\n        .where(\n          and(\n            sql`${notificationJobs.sendAtUtc} <= ${beforeUtc}`,\n            eq(notificationJobs.status, 'pending')\n          )\n        )\n        .orderBy(notificationJobs.sendAtUtc)\n        .limit(limit)\n        .for('update', { skipLocked: true });\n      \n      if (dueJobs.length === 0) return [];\n      \n      const jobIds = dueJobs.map(j => j.id);\n      const updated = await tx\n        .update(notificationJobs)\n        .set({ \n          status: 'claimed', \n          claimedAt: new Date(),\n          attemptCount: sql`${notificationJobs.attemptCount} + 1`,\n          lastAttemptAt: new Date()\n        })\n        .where(sql`${notificationJobs.id} = ANY(${jobIds})`)\n        .returning();\n      \n      return updated;\n    });\n    \n    return claimed;\n  }\n\n  async markJobCompleted(jobId: number): Promise<void> {\n    await db\n      .update(notificationJobs)\n      .set({ status: 'completed', completedAt: new Date() })\n      .where(eq(notificationJobs.id, jobId));\n  }\n\n  async markJobFailed(jobId: number, errorMessage: string): Promise<void> {\n    await db\n      .update(notificationJobs)\n      .set({ \n        status: 'failed', \n        errorMessage,\n        lastAttemptAt: new Date()\n      })\n      .where(eq(notificationJobs.id, jobId));\n  }\n\n  async rescheduleJob(jobId: number, newSendAtUtc: Date): Promise<void> {\n    await db\n      .update(notificationJobs)\n      .set({ \n        status: 'pending', \n        sendAtUtc: newSendAtUtc,\n        claimedAt: null,\n        errorMessage: null\n      })\n      .where(eq(notificationJobs.id, jobId));\n  }\n\n  async deleteCompletedJobsOlderThan(daysAgo: number): Promise<number> {\n    const cutoffDate = new Date();\n    cutoffDate.setDate(cutoffDate.getDate() - daysAgo);\n    \n    const deleted = await db\n      .delete(notificationJobs)\n      .where(\n        and(\n          eq(notificationJobs.status, 'completed'),\n          sql`${notificationJobs.completedAt} < ${cutoffDate}`\n        )\n      )\n      .returning({ id: notificationJobs.id });\n    \n    return deleted.length;\n  }\n\n  async getUsersWithNotificationPreferences(notificationType: string, offset: number, limit: number): Promise<Array<{\n    user: User;\n    preferences: NotificationPreferences;\n  }>> {\n    const preferenceColumn = notificationType === 'daily_reminder' ? 'daily_reminder'\n      : notificationType === 'streak_warning' ? 'streak_warning'\n      : notificationType === 'weekly_summary' ? 'weekly_summary'\n      : null;\n    \n    if (!preferenceColumn) return [];\n    \n    const results = await db.execute<{\n      u_id: string;\n      u_username: string;\n      u_email: string;\n      u_password: string;\n      u_email_verified: boolean;\n      u_is_active: boolean;\n      u_avatar_color: string | null;\n      u_bio: string | null;\n      u_country: string | null;\n      u_keyboard_layout: string | null;\n      u_timezone: string;\n      u_current_streak: number;\n      u_best_streak: number;\n      u_last_test_date: Date | null;\n      u_created_at: Date;\n      p_id: number;\n      p_user_id: string;\n      p_daily_reminder: boolean;\n      p_daily_reminder_time: string | null;\n      p_streak_warning: boolean;\n      p_weekly_summary: boolean;\n      p_created_at: Date;\n      p_updated_at: Date;\n    }>(sql`\n      SELECT DISTINCT ON (u.id)\n        u.id as u_id, u.username as u_username, u.email as u_email, \n        u.password as u_password, u.email_verified as u_email_verified, \n        u.is_active as u_is_active, u.avatar_color as u_avatar_color,\n        u.bio as u_bio, u.country as u_country, u.keyboard_layout as u_keyboard_layout,\n        u.timezone as u_timezone, u.current_streak as u_current_streak,\n        u.best_streak as u_best_streak, u.last_test_date as u_last_test_date,\n        u.created_at as u_created_at,\n        np.id as p_id, np.user_id as p_user_id, np.daily_reminder as p_daily_reminder,\n        np.daily_reminder_time as p_daily_reminder_time, np.streak_warning as p_streak_warning,\n        np.weekly_summary as p_weekly_summary,\n        np.created_at as p_created_at, np.updated_at as p_updated_at\n      FROM users u\n      INNER JOIN notification_preferences np ON np.user_id = u.id\n      INNER JOIN push_subscriptions ps ON ps.user_id = u.id\n      WHERE np.${sql.identifier(preferenceColumn)} = true\n        AND ps.is_active = true\n        AND u.is_active = true\n      OFFSET ${offset}\n      LIMIT ${limit}\n    `);\n    \n    return results.rows.map(r => ({\n      user: {\n        id: r.u_id,\n        username: r.u_username,\n        email: r.u_email,\n        password: r.u_password,\n        emailVerified: r.u_email_verified,\n        isActive: r.u_is_active,\n        avatarColor: r.u_avatar_color,\n        bio: r.u_bio,\n        country: r.u_country,\n        keyboardLayout: r.u_keyboard_layout,\n        timezone: r.u_timezone,\n        currentStreak: r.u_current_streak,\n        bestStreak: r.u_best_streak,\n        lastTestDate: r.u_last_test_date,\n        createdAt: r.u_created_at,\n      },\n      preferences: {\n        id: r.p_id,\n        userId: r.p_user_id,\n        dailyReminder: r.p_daily_reminder,\n        dailyReminderTime: r.p_daily_reminder_time,\n        streakWarning: r.p_streak_warning,\n        streakMilestone: false,\n        weeklySummary: r.p_weekly_summary,\n        weeklySummaryDay: 'sunday',\n        achievementUnlocked: false,\n        challengeInvite: false,\n        challengeComplete: false,\n        leaderboardChange: false,\n        newPersonalRecord: false,\n        raceInvite: false,\n        raceStarting: false,\n        socialUpdates: false,\n        tipOfTheDay: false,\n        timezone: null,\n        quietHoursStart: null,\n        quietHoursEnd: null,\n        createdAt: r.p_created_at,\n        updatedAt: r.p_updated_at,\n      },\n    }));\n  }\n\n  async getUsersForDailyReminders(currentHour: number): Promise<Array<{ id: string; username: string; currentStreak: number }>> {\n    const currentHourStr = `${String(currentHour).padStart(2, '0')}:%`;\n    \n    const results = await db\n      .select({\n        id: users.id,\n        username: users.username,\n        currentStreak: users.currentStreak,\n      })\n      .from(users)\n      .innerJoin(notificationPreferences, eq(notificationPreferences.userId, users.id))\n      .innerJoin(pushSubscriptions, eq(pushSubscriptions.userId, users.id))\n      .where(\n        and(\n          eq(notificationPreferences.dailyReminder, true),\n          sql`${notificationPreferences.dailyReminderTime} LIKE ${currentHourStr}`,\n          eq(pushSubscriptions.isActive, true)\n        )\n      )\n      .groupBy(users.id, users.username, users.currentStreak);\n    \n    return results.map(r => ({\n      id: r.id,\n      username: r.username,\n      currentStreak: r.currentStreak || 0,\n    }));\n  }\n\n  async getUsersWithStreakAtRisk(): Promise<Array<{ id: string; username: string; currentStreak: number }>> {\n    const todayStart = new Date();\n    todayStart.setHours(0, 0, 0, 0);\n    const todayEnd = new Date();\n    todayEnd.setHours(23, 59, 59, 999);\n    \n    const results = await db\n      .select({\n        id: users.id,\n        username: users.username,\n        currentStreak: users.currentStreak,\n      })\n      .from(users)\n      .innerJoin(notificationPreferences, eq(notificationPreferences.userId, users.id))\n      .innerJoin(pushSubscriptions, eq(pushSubscriptions.userId, users.id))\n      .where(\n        and(\n          sql`${users.currentStreak} > 0`,\n          eq(notificationPreferences.streakWarning, true),\n          eq(pushSubscriptions.isActive, true),\n          sql`NOT EXISTS (\n            SELECT 1 FROM ${testResults} \n            WHERE ${testResults.userId} = ${users.id} \n            AND ${testResults.createdAt} BETWEEN ${todayStart} AND ${todayEnd}\n          )`\n        )\n      )\n      .groupBy(users.id, users.username, users.currentStreak);\n    \n    return results.map(r => ({\n      id: r.id,\n      username: r.username,\n      currentStreak: r.currentStreak || 0,\n    }));\n  }\n\n  async getUsersForWeeklySummary(): Promise<Array<{ id: string; username: string }>> {\n    const results = await db\n      .select({\n        id: users.id,\n        username: users.username,\n      })\n      .from(users)\n      .innerJoin(notificationPreferences, eq(notificationPreferences.userId, users.id))\n      .innerJoin(pushSubscriptions, eq(pushSubscriptions.userId, users.id))\n      .where(\n        and(\n          eq(notificationPreferences.weeklySummary, true),\n          eq(pushSubscriptions.isActive, true)\n        )\n      )\n      .groupBy(users.id, users.username);\n    \n    return results;\n  }\n\n  async getUserAverageWpm(userId: string): Promise<number> {\n    const results = await db\n      .select({\n        avgWpm: sql<number>`ROUND(AVG(${testResults.wpm}))`,\n      })\n      .from(testResults)\n      .where(eq(testResults.userId, userId));\n    \n    return results[0]?.avgWpm || 0;\n  }\n\n  async getWeeklySummaryStats(userId: string): Promise<{\n    testsCompleted: number;\n    avgWpm: number;\n    avgAccuracy: number;\n    improvement: number;\n    rank: number;\n  }> {\n    const now = new Date();\n    const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n    const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);\n    \n    const currentWeekResults = await db\n      .select({\n        count: sql<number>`CAST(COUNT(*) AS INTEGER)`,\n        avgWpm: sql<number>`COALESCE(ROUND(AVG(${testResults.wpm})), 0)`,\n        avgAccuracy: sql<number>`COALESCE(ROUND(AVG(${testResults.accuracy}), 1), 0)`,\n      })\n      .from(testResults)\n      .where(\n        and(\n          eq(testResults.userId, userId),\n          sql`${testResults.createdAt} >= ${oneWeekAgo}`\n        )\n      );\n    \n    const testsCompleted = currentWeekResults[0]?.count || 0;\n    const avgWpm = currentWeekResults[0]?.avgWpm || 0;\n    const avgAccuracy = currentWeekResults[0]?.avgAccuracy || 0;\n    \n    if (testsCompleted === 0) {\n      return {\n        testsCompleted: 0,\n        avgWpm: 0,\n        avgAccuracy: 0,\n        improvement: 0,\n        rank: 0,\n      };\n    }\n    \n    const previousWeekResults = await db\n      .select({\n        avgWpm: sql<number>`COALESCE(ROUND(AVG(${testResults.wpm})), 0)`,\n      })\n      .from(testResults)\n      .where(\n        and(\n          eq(testResults.userId, userId),\n          sql`${testResults.createdAt} >= ${twoWeeksAgo}`,\n          sql`${testResults.createdAt} < ${oneWeekAgo}`\n        )\n      );\n    \n    const weeklyRankResults = await db\n      .select({\n        rank: sql<number>`CAST(COUNT(DISTINCT ${users.id}) + 1 AS INTEGER)`,\n      })\n      .from(users)\n      .innerJoin(testResults, eq(testResults.userId, users.id))\n      .innerJoin(pushSubscriptions, eq(pushSubscriptions.userId, users.id))\n      .where(\n        and(\n          sql`${testResults.createdAt} >= ${oneWeekAgo}`,\n          eq(pushSubscriptions.isActive, true),\n          sql`${users.id} != ${userId}`\n        )\n      )\n      .groupBy(users.id)\n      .having(sql`AVG(${testResults.wpm}) > ${avgWpm}`);\n    \n    const previousWpm = previousWeekResults[0]?.avgWpm || avgWpm;\n    const improvement = avgWpm - previousWpm;\n    const rank = weeklyRankResults[0]?.rank || 1;\n    \n    return {\n      testsCompleted,\n      avgWpm,\n      avgAccuracy,\n      improvement,\n      rank,\n    };\n  }\n\n  async createAchievement(achievement: InsertAchievement): Promise<Achievement> {\n    const inserted = await db.insert(achievements).values(achievement).returning();\n    return inserted[0];\n  }\n\n  async getAllAchievements(): Promise<Achievement[]> {\n    const results = await db\n      .select()\n      .from(achievements)\n      .where(eq(achievements.isActive, true))\n      .orderBy(achievements.tier, achievements.points);\n    return results;\n  }\n\n  async getAchievementByKey(key: string): Promise<Achievement | undefined> {\n    const result = await db\n      .select()\n      .from(achievements)\n      .where(eq(achievements.key, key))\n      .limit(1);\n    return result[0];\n  }\n\n  async unlockAchievement(userId: string, achievementId: number, testResultId?: number): Promise<UserAchievement> {\n    const inserted = await db\n      .insert(userAchievements)\n      .values({\n        userId,\n        achievementId,\n        testResultId: testResultId || null,\n        notified: false,\n      })\n      .returning();\n    return inserted[0];\n  }\n\n  async getUserAchievements(userId: string): Promise<Array<UserAchievement & { achievement: Achievement }>> {\n    const results = await db\n      .select()\n      .from(userAchievements)\n      .leftJoin(achievements, eq(userAchievements.achievementId, achievements.id))\n      .where(eq(userAchievements.userId, userId))\n      .orderBy(desc(userAchievements.unlockedAt));\n    \n    return results.map(row => ({\n      ...row.user_achievements,\n      achievement: row.achievements!,\n    }));\n  }\n\n  async createChallenge(challenge: InsertChallenge): Promise<Challenge> {\n    const inserted = await db.insert(challenges).values(challenge).returning();\n    return inserted[0];\n  }\n\n  async getActiveChallenge(type: 'daily' | 'weekly'): Promise<Challenge | undefined> {\n    const now = new Date();\n    const result = await db\n      .select()\n      .from(challenges)\n      .where(and(\n        eq(challenges.type, type),\n        eq(challenges.isActive, true),\n        sql`${challenges.startDate} <= ${now}`,\n        sql`${challenges.endDate} >= ${now}`\n      ))\n      .orderBy(desc(challenges.startDate))\n      .limit(1);\n    return result[0];\n  }\n\n  async getUserChallengeProgress(userId: string, challengeId: number): Promise<UserChallenge | undefined> {\n    const result = await db\n      .select()\n      .from(userChallenges)\n      .where(and(\n        eq(userChallenges.userId, userId),\n        eq(userChallenges.challengeId, challengeId)\n      ))\n      .limit(1);\n    return result[0];\n  }\n\n  async updateChallengeProgress(userId: string, challengeId: number, progress: number): Promise<UserChallenge> {\n    const existing = await this.getUserChallengeProgress(userId, challengeId);\n    \n    if (existing) {\n      const updated = await db\n        .update(userChallenges)\n        .set({ progress, updatedAt: new Date() })\n        .where(and(\n          eq(userChallenges.userId, userId),\n          eq(userChallenges.challengeId, challengeId)\n        ))\n        .returning();\n      return updated[0];\n    } else {\n      const inserted = await db\n        .insert(userChallenges)\n        .values({\n          userId,\n          challengeId,\n          progress,\n          isCompleted: false,\n        })\n        .returning();\n      return inserted[0];\n    }\n  }\n\n  async completeChallenge(userId: string, challengeId: number): Promise<UserChallenge> {\n    const updated = await db\n      .update(userChallenges)\n      .set({\n        isCompleted: true,\n        completedAt: new Date(),\n        updatedAt: new Date(),\n      })\n      .where(and(\n        eq(userChallenges.userId, userId),\n        eq(userChallenges.challengeId, challengeId)\n      ))\n      .returning();\n    return updated[0];\n  }\n\n  async getUserGamification(userId: string): Promise<UserGamification | undefined> {\n    const result = await db\n      .select()\n      .from(userGamification)\n      .where(eq(userGamification.userId, userId))\n      .limit(1);\n    return result[0];\n  }\n\n  async createUserGamification(gamification: InsertUserGamification): Promise<UserGamification> {\n    const inserted = await db.insert(userGamification).values(gamification).returning();\n    return inserted[0];\n  }\n\n  async updateUserGamification(userId: string, updates: Partial<UserGamification>): Promise<UserGamification> {\n    const updated = await db\n      .update(userGamification)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(userGamification.userId, userId))\n      .returning();\n    return updated[0];\n  }\n\n  // OAuth Accounts\n  async createOAuthAccount(account: InsertOAuthAccount): Promise<OAuthAccount> {\n    const inserted = await db.insert(oauthAccounts).values(account).returning();\n    return inserted[0];\n  }\n\n  async getOAuthAccount(provider: OAuthProvider, providerUserId: string): Promise<OAuthAccount | undefined> {\n    const result = await db\n      .select()\n      .from(oauthAccounts)\n      .where(and(\n        eq(oauthAccounts.provider, provider),\n        eq(oauthAccounts.providerUserId, providerUserId)\n      ))\n      .limit(1);\n    return result[0];\n  }\n\n  async getUserOAuthAccounts(userId: string): Promise<OAuthAccount[]> {\n    return await db\n      .select()\n      .from(oauthAccounts)\n      .where(eq(oauthAccounts.userId, userId))\n      .orderBy(desc(oauthAccounts.linkedAt));\n  }\n\n  async linkOAuthAccount(userId: string, account: Omit<InsertOAuthAccount, 'userId'>): Promise<OAuthAccount> {\n    const inserted = await db\n      .insert(oauthAccounts)\n      .values({ ...account, userId })\n      .returning();\n    return inserted[0];\n  }\n\n  async unlinkOAuthAccount(userId: string, provider: OAuthProvider): Promise<void> {\n    await db\n      .delete(oauthAccounts)\n      .where(and(\n        eq(oauthAccounts.userId, userId),\n        eq(oauthAccounts.provider, provider)\n      ));\n  }\n\n  async findUserByOAuthProvider(provider: OAuthProvider, providerUserId: string): Promise<User | undefined> {\n    const result = await db\n      .select({ user: users })\n      .from(oauthAccounts)\n      .innerJoin(users, eq(oauthAccounts.userId, users.id))\n      .where(and(\n        eq(oauthAccounts.provider, provider),\n        eq(oauthAccounts.providerUserId, providerUserId)\n      ))\n      .limit(1);\n    return result[0]?.user;\n  }\n\n  // Persistent Login (Remember Me)\n  async createPersistentLogin(login: InsertPersistentLogin): Promise<PersistentLogin> {\n    const inserted = await db.insert(persistentLogins).values(login).returning();\n    return inserted[0];\n  }\n\n  async getPersistentLogin(series: string): Promise<PersistentLogin | undefined> {\n    const result = await db\n      .select()\n      .from(persistentLogins)\n      .where(eq(persistentLogins.series, series))\n      .limit(1);\n    return result[0];\n  }\n\n  async updatePersistentLoginToken(series: string, newTokenHash: string, lastUsed: Date): Promise<void> {\n    await db\n      .update(persistentLogins)\n      .set({ tokenHash: newTokenHash, lastUsed })\n      .where(eq(persistentLogins.series, series));\n  }\n\n  async deletePersistentLogin(series: string): Promise<void> {\n    await db.delete(persistentLogins).where(eq(persistentLogins.series, series));\n  }\n\n  async deleteAllUserPersistentLogins(userId: string): Promise<void> {\n    await db.delete(persistentLogins).where(eq(persistentLogins.userId, userId));\n  }\n\n  async deleteExpiredPersistentLogins(): Promise<number> {\n    const now = new Date();\n    const result = await db\n      .delete(persistentLogins)\n      .where(sql`${persistentLogins.expiresAt} < ${now}`)\n      .returning();\n    return result.length;\n  }\n\n  async getUserPersistentLogins(userId: string): Promise<PersistentLogin[]> {\n    return await db\n      .select()\n      .from(persistentLogins)\n      .where(eq(persistentLogins.userId, userId))\n      .orderBy(desc(persistentLogins.lastUsed));\n  }\n  \n  // OAuth States (CSRF protection - database persisted for multi-instance support)\n  async createOAuthState(state: InsertOAuthState): Promise<OAuthState> {\n    const inserted = await db.insert(oauthStates).values(state).returning();\n    return inserted[0];\n  }\n  \n  async getOAuthState(state: string): Promise<OAuthState | undefined> {\n    const result = await db\n      .select()\n      .from(oauthStates)\n      .where(eq(oauthStates.state, state))\n      .limit(1);\n    return result[0];\n  }\n  \n  async deleteOAuthState(state: string): Promise<void> {\n    await db.delete(oauthStates).where(eq(oauthStates.state, state));\n  }\n  \n  async deleteExpiredOAuthStates(): Promise<number> {\n    const now = new Date();\n    const result = await db\n      .delete(oauthStates)\n      .where(sql`${oauthStates.expiresAt} < ${now}`)\n      .returning();\n    return result.length;\n  }\n  \n  // Audit Logs (Security event tracking - database persisted for compliance)\n  async createAuditLog(log: InsertAuditLog): Promise<AuditLog> {\n    const inserted = await db.insert(auditLogs).values(log).returning();\n    return inserted[0];\n  }\n  \n  async getAuditLogs(filters?: { userId?: string; eventType?: string; limit?: number }): Promise<AuditLog[]> {\n    let query = db.select().from(auditLogs);\n    \n    const conditions = [];\n    if (filters?.userId) {\n      conditions.push(eq(auditLogs.userId, filters.userId));\n    }\n    if (filters?.eventType) {\n      conditions.push(eq(auditLogs.eventType, filters.eventType));\n    }\n    \n    if (conditions.length > 0) {\n      query = query.where(and(...conditions)) as typeof query;\n    }\n    \n    return await query\n      .orderBy(desc(auditLogs.createdAt))\n      .limit(filters?.limit || 100);\n  }\n  \n  async getUserAuditLogs(userId: string, limit: number = 50): Promise<AuditLog[]> {\n    return await db\n      .select()\n      .from(auditLogs)\n      .where(eq(auditLogs.userId, userId))\n      .orderBy(desc(auditLogs.createdAt))\n      .limit(limit);\n  }\n\n  // ============================================================================\n  // MULTIPLAYER RACING ENHANCED FEATURES IMPLEMENTATIONS\n  // ============================================================================\n\n  // User Rating (ELO System)\n  async getUserRating(userId: string): Promise<UserRating | undefined> {\n    const result = await db\n      .select()\n      .from(userRatings)\n      .where(eq(userRatings.userId, userId))\n      .limit(1);\n    return result[0];\n  }\n\n  async createUserRating(userId: string): Promise<UserRating> {\n    const inserted = await db\n      .insert(userRatings)\n      .values({ userId })\n      .returning();\n    return inserted[0];\n  }\n\n  async updateUserRating(userId: string, updates: Partial<UserRating>): Promise<UserRating> {\n    const updated = await db\n      .update(userRatings)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(userRatings.userId, userId))\n      .returning();\n    return updated[0];\n  }\n\n  async getOrCreateUserRating(userId: string): Promise<UserRating> {\n    const existing = await this.getUserRating(userId);\n    if (existing) return existing;\n    return await this.createUserRating(userId);\n  }\n\n  async getRatingLeaderboard(tier?: string, limit: number = 100): Promise<UserRating[]> {\n    let query = db.select().from(userRatings);\n    \n    if (tier) {\n      query = query.where(eq(userRatings.tier, tier)) as typeof query;\n    }\n    \n    return await query\n      .orderBy(desc(userRatings.rating))\n      .limit(limit);\n  }\n\n  async getUsersForMatchmaking(targetRating: number, tolerance: number, excludeUserIds: string[]): Promise<UserRating[]> {\n    const minRating = targetRating - tolerance;\n    const maxRating = targetRating + tolerance;\n    \n    const baseCondition = and(\n      sql`${userRatings.rating} >= ${minRating}`,\n      sql`${userRatings.rating} <= ${maxRating}`\n    );\n    \n    const whereCondition = excludeUserIds.length > 0\n      ? and(baseCondition, notInArray(userRatings.userId, excludeUserIds))\n      : baseCondition;\n    \n    return await db\n      .select()\n      .from(userRatings)\n      .where(whereCondition)\n      .orderBy(sql`ABS(${userRatings.rating} - ${targetRating})`)\n      .limit(10);\n  }\n\n  // Race Match History\n  async createRaceMatchHistory(history: InsertRaceMatchHistory): Promise<RaceMatchHistory> {\n    const inserted = await db\n      .insert(raceMatchHistory)\n      .values(history)\n      .returning();\n    return inserted[0];\n  }\n\n  async getRaceMatchHistory(raceId: number): Promise<RaceMatchHistory[]> {\n    return await db\n      .select()\n      .from(raceMatchHistory)\n      .where(eq(raceMatchHistory.raceId, raceId))\n      .orderBy(raceMatchHistory.finishPosition);\n  }\n\n  async getUserMatchHistory(userId: string, limit: number = 50): Promise<RaceMatchHistory[]> {\n    return await db\n      .select()\n      .from(raceMatchHistory)\n      .where(eq(raceMatchHistory.userId, userId))\n      .orderBy(desc(raceMatchHistory.createdAt))\n      .limit(limit);\n  }\n\n  // Race Keystrokes (Anti-cheat & Replays)\n  async saveRaceKeystrokes(keystrokes: InsertRaceKeystrokes): Promise<RaceKeystrokes> {\n    const inserted = await db\n      .insert(raceKeystrokes)\n      .values(keystrokes)\n      .returning();\n    return inserted[0];\n  }\n\n  async getRaceKeystrokes(raceId: number): Promise<RaceKeystrokes[]> {\n    return await db\n      .select()\n      .from(raceKeystrokes)\n      .where(eq(raceKeystrokes.raceId, raceId));\n  }\n\n  async getParticipantKeystrokes(participantId: number): Promise<RaceKeystrokes | undefined> {\n    const result = await db\n      .select()\n      .from(raceKeystrokes)\n      .where(eq(raceKeystrokes.participantId, participantId))\n      .limit(1);\n    return result[0];\n  }\n\n  async getFlaggedKeystrokes(limit: number = 50): Promise<RaceKeystrokes[]> {\n    return await db\n      .select()\n      .from(raceKeystrokes)\n      .where(eq(raceKeystrokes.isFlagged, true))\n      .orderBy(desc(raceKeystrokes.createdAt))\n      .limit(limit);\n  }\n\n  // Race Chat Messages\n  async createRaceChatMessage(message: InsertRaceChatMessage): Promise<RaceChatMessage> {\n    const inserted = await db\n      .insert(raceChatMessages)\n      .values(message)\n      .returning();\n    return inserted[0];\n  }\n\n  async getRaceChatMessages(raceId: number, limit: number = 100): Promise<RaceChatMessage[]> {\n    return await db\n      .select()\n      .from(raceChatMessages)\n      .where(eq(raceChatMessages.raceId, raceId))\n      .orderBy(raceChatMessages.createdAt)\n      .limit(limit);\n  }\n\n  // Race Spectators\n  async addRaceSpectator(spectator: InsertRaceSpectator): Promise<RaceSpectator> {\n    const inserted = await db\n      .insert(raceSpectators)\n      .values(spectator)\n      .returning();\n    return inserted[0];\n  }\n\n  async removeRaceSpectator(raceId: number, sessionId: string): Promise<void> {\n    await db\n      .update(raceSpectators)\n      .set({ isActive: false, leftAt: new Date() })\n      .where(\n        and(\n          eq(raceSpectators.raceId, raceId),\n          eq(raceSpectators.sessionId, sessionId)\n        )\n      );\n  }\n\n  async getRaceSpectators(raceId: number): Promise<RaceSpectator[]> {\n    return await db\n      .select()\n      .from(raceSpectators)\n      .where(\n        and(\n          eq(raceSpectators.raceId, raceId),\n          eq(raceSpectators.isActive, true)\n        )\n      );\n  }\n\n  async getActiveSpectatorCount(raceId: number): Promise<number> {\n    const result = await db\n      .select({ count: sql<number>`count(*)` })\n      .from(raceSpectators)\n      .where(\n        and(\n          eq(raceSpectators.raceId, raceId),\n          eq(raceSpectators.isActive, true)\n        )\n      );\n    return result[0]?.count || 0;\n  }\n\n  // Race Replays\n  async createRaceReplay(replay: InsertRaceReplay): Promise<RaceReplay> {\n    const inserted = await db\n      .insert(raceReplays)\n      .values(replay)\n      .returning();\n    return inserted[0];\n  }\n\n  async getRaceReplay(raceId: number): Promise<RaceReplay | undefined> {\n    const result = await db\n      .select()\n      .from(raceReplays)\n      .where(eq(raceReplays.raceId, raceId))\n      .limit(1);\n    return result[0];\n  }\n\n  async getPublicReplays(limit: number = 20): Promise<RaceReplay[]> {\n    return await db\n      .select()\n      .from(raceReplays)\n      .where(eq(raceReplays.isPublic, true))\n      .orderBy(desc(raceReplays.createdAt))\n      .limit(limit);\n  }\n\n  async incrementReplayViewCount(raceId: number): Promise<void> {\n    await db\n      .update(raceReplays)\n      .set({ viewCount: sql`${raceReplays.viewCount} + 1` })\n      .where(eq(raceReplays.raceId, raceId));\n  }\n\n  // Anti-Cheat Challenges\n  async createAntiCheatChallenge(challenge: InsertAntiCheatChallenge): Promise<AntiCheatChallenge> {\n    const inserted = await db\n      .insert(antiCheatChallenges)\n      .values(challenge)\n      .returning();\n    return inserted[0];\n  }\n\n  async getUserCertification(userId: string): Promise<AntiCheatChallenge | undefined> {\n    const now = new Date();\n    const result = await db\n      .select()\n      .from(antiCheatChallenges)\n      .where(\n        and(\n          eq(antiCheatChallenges.userId, userId),\n          eq(antiCheatChallenges.passed, true),\n          sql`${antiCheatChallenges.certifiedUntil} > ${now}`\n        )\n      )\n      .orderBy(desc(antiCheatChallenges.certifiedWpm))\n      .limit(1);\n    return result[0];\n  }\n\n  async updateChallengePassed(challengeId: number, passed: boolean, wpm: number, certifiedWpm: number): Promise<void> {\n    const certifiedUntil = new Date();\n    certifiedUntil.setDate(certifiedUntil.getDate() + 7); // Certification valid for 7 days\n    \n    await db\n      .update(antiCheatChallenges)\n      .set({\n        passed,\n        challengeWpm: wpm,\n        certifiedWpm: passed ? certifiedWpm : null,\n        certifiedUntil: passed ? certifiedUntil : null,\n        completedAt: new Date(),\n      })\n      .where(eq(antiCheatChallenges.id, challengeId));\n  }\n\n  // ============================================================================\n  // ENTERPRISE FEEDBACK SYSTEM IMPLEMENTATION\n  // ============================================================================\n\n  // Feedback Categories\n  async getFeedbackCategories(): Promise<FeedbackCategory[]> {\n    return await db\n      .select()\n      .from(feedbackCategories)\n      .where(eq(feedbackCategories.isActive, true))\n      .orderBy(feedbackCategories.sortOrder, feedbackCategories.name);\n  }\n\n  async getFeedbackCategoryById(id: number): Promise<FeedbackCategory | undefined> {\n    const result = await db\n      .select()\n      .from(feedbackCategories)\n      .where(eq(feedbackCategories.id, id))\n      .limit(1);\n    return result[0];\n  }\n\n  async getFeedbackCategoryBySlug(slug: string): Promise<FeedbackCategory | undefined> {\n    const result = await db\n      .select()\n      .from(feedbackCategories)\n      .where(eq(feedbackCategories.slug, slug))\n      .limit(1);\n    return result[0];\n  }\n\n  // Feedback CRUD\n  async createFeedback(feedbackData: InsertFeedback): Promise<Feedback> {\n    const inserted = await db\n      .insert(feedback)\n      .values([feedbackData])\n      .returning();\n    return inserted[0];\n  }\n\n  async getFeedbackById(id: number): Promise<Feedback | undefined> {\n    const result = await db\n      .select()\n      .from(feedback)\n      .where(eq(feedback.id, id))\n      .limit(1);\n    return result[0];\n  }\n\n  async getFeedbackPaginated(options: {\n    limit: number;\n    offset: number;\n    status?: string;\n    priority?: string;\n    categoryId?: number;\n    sentimentLabel?: string;\n    isSpam?: boolean;\n    isArchived?: boolean;\n    search?: string;\n    sortBy?: string;\n    sortOrder?: 'asc' | 'desc';\n  }): Promise<{ feedback: Feedback[]; total: number }> {\n    const conditions = [];\n\n    if (options.status) {\n      conditions.push(eq(feedback.status, options.status));\n    }\n    if (options.priority) {\n      conditions.push(eq(feedback.priority, options.priority));\n    }\n    if (options.categoryId !== undefined) {\n      conditions.push(eq(feedback.categoryId, options.categoryId));\n    }\n    if (options.sentimentLabel) {\n      conditions.push(eq(feedback.sentimentLabel, options.sentimentLabel));\n    }\n    if (options.isSpam !== undefined) {\n      conditions.push(eq(feedback.isSpam, options.isSpam));\n    }\n    if (options.isArchived !== undefined) {\n      conditions.push(eq(feedback.isArchived, options.isArchived));\n    }\n    if (options.search) {\n      const searchTerm = `%${options.search}%`;\n      conditions.push(\n        or(\n          sql`${feedback.subject} ILIKE ${searchTerm}`,\n          sql`${feedback.message} ILIKE ${searchTerm}`\n        )\n      );\n    }\n\n    const whereClause = conditions.length > 0 ? and(...conditions) : undefined;\n\n    // Get total count\n    const countResult = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(feedback)\n      .where(whereClause);\n    const total = countResult[0]?.count || 0;\n\n    // Determine sort order\n    const sortColumn = options.sortBy === 'priority' ? feedback.priority :\n                       options.sortBy === 'status' ? feedback.status :\n                       options.sortBy === 'sentimentScore' ? feedback.sentimentScore :\n                       options.sortBy === 'upvotes' ? feedback.upvotes :\n                       feedback.createdAt;\n    const order = options.sortOrder === 'asc' ? sql`ASC` : sql`DESC`;\n\n    // Get paginated results\n    const results = await db\n      .select()\n      .from(feedback)\n      .where(whereClause)\n      .orderBy(options.sortOrder === 'asc' ? sortColumn : desc(sortColumn))\n      .limit(options.limit)\n      .offset(options.offset);\n\n    return { feedback: results, total };\n  }\n\n  async updateFeedback(id: number, updates: Partial<Feedback>): Promise<Feedback> {\n    const result = await db\n      .update(feedback)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(feedback.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async updateFeedbackAiAnalysis(id: number, analysis: {\n    sentimentScore: number;\n    sentimentLabel: string;\n    aiCategoryId?: number;\n    aiSummary?: string;\n    aiPriorityScore?: number;\n    aiTags?: string[];\n  }): Promise<Feedback> {\n    const result = await db\n      .update(feedback)\n      .set({\n        sentimentScore: analysis.sentimentScore,\n        sentimentLabel: analysis.sentimentLabel,\n        aiCategoryId: analysis.aiCategoryId,\n        aiSummary: analysis.aiSummary,\n        aiPriorityScore: analysis.aiPriorityScore,\n        aiTags: analysis.aiTags,\n        aiProcessedAt: new Date(),\n        updatedAt: new Date(),\n      })\n      .where(eq(feedback.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async markFeedbackResolved(id: number, resolvedByUserId: string, resolutionNotes?: string): Promise<Feedback> {\n    const result = await db\n      .update(feedback)\n      .set({\n        status: 'resolved',\n        resolvedAt: new Date(),\n        resolvedByUserId,\n        resolutionNotes,\n        updatedAt: new Date(),\n      })\n      .where(eq(feedback.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async archiveFeedback(id: number): Promise<void> {\n    await db\n      .update(feedback)\n      .set({ isArchived: true, updatedAt: new Date() })\n      .where(eq(feedback.id, id));\n  }\n\n  async markFeedbackAsSpam(id: number): Promise<void> {\n    await db\n      .update(feedback)\n      .set({ isSpam: true, updatedAt: new Date() })\n      .where(eq(feedback.id, id));\n  }\n\n  // Feedback Attachments\n  async createFeedbackAttachment(attachment: InsertFeedbackAttachment): Promise<FeedbackAttachment> {\n    const inserted = await db\n      .insert(feedbackAttachments)\n      .values(attachment)\n      .returning();\n    return inserted[0];\n  }\n\n  async getFeedbackAttachments(feedbackId: number): Promise<FeedbackAttachment[]> {\n    return await db\n      .select()\n      .from(feedbackAttachments)\n      .where(eq(feedbackAttachments.feedbackId, feedbackId))\n      .orderBy(feedbackAttachments.createdAt);\n  }\n\n  async deleteFeedbackAttachment(id: number): Promise<void> {\n    await db.delete(feedbackAttachments).where(eq(feedbackAttachments.id, id));\n  }\n\n  // Feedback Responses\n  async createFeedbackResponse(response: InsertFeedbackResponse): Promise<FeedbackResponse> {\n    const inserted = await db\n      .insert(feedbackResponses)\n      .values(response)\n      .returning();\n    return inserted[0];\n  }\n\n  async getFeedbackResponses(feedbackId: number): Promise<FeedbackResponse[]> {\n    return await db\n      .select()\n      .from(feedbackResponses)\n      .where(eq(feedbackResponses.feedbackId, feedbackId))\n      .orderBy(feedbackResponses.createdAt);\n  }\n\n  async updateFeedbackResponse(id: number, updates: Partial<FeedbackResponse>): Promise<FeedbackResponse> {\n    const result = await db\n      .update(feedbackResponses)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(feedbackResponses.id, id))\n      .returning();\n    return result[0];\n  }\n\n  // Status History (Audit Trail)\n  async recordFeedbackStatusHistory(history: InsertFeedbackStatusHistory): Promise<FeedbackStatusHistory> {\n    const inserted = await db\n      .insert(feedbackStatusHistory)\n      .values(history)\n      .returning();\n    return inserted[0];\n  }\n\n  async getFeedbackStatusHistory(feedbackId: number): Promise<FeedbackStatusHistory[]> {\n    return await db\n      .select()\n      .from(feedbackStatusHistory)\n      .where(eq(feedbackStatusHistory.feedbackId, feedbackId))\n      .orderBy(desc(feedbackStatusHistory.createdAt));\n  }\n\n  // Upvotes\n  async toggleFeedbackUpvote(feedbackId: number, userId: string): Promise<{ upvoted: boolean; newCount: number }> {\n    return await db.transaction(async (tx) => {\n      // Check if user already upvoted\n      const existing = await tx\n        .select()\n        .from(feedbackUpvotes)\n        .where(\n          and(\n            eq(feedbackUpvotes.feedbackId, feedbackId),\n            eq(feedbackUpvotes.userId, userId)\n          )\n        )\n        .limit(1);\n\n      if (existing.length > 0) {\n        // Remove upvote\n        await tx\n          .delete(feedbackUpvotes)\n          .where(eq(feedbackUpvotes.id, existing[0].id));\n        \n        // Decrement count\n        const updated = await tx\n          .update(feedback)\n          .set({ upvotes: sql`${feedback.upvotes} - 1` })\n          .where(eq(feedback.id, feedbackId))\n          .returning();\n        \n        return { upvoted: false, newCount: updated[0]?.upvotes || 0 };\n      } else {\n        // Add upvote\n        await tx\n          .insert(feedbackUpvotes)\n          .values({ feedbackId, userId });\n        \n        // Increment count\n        const updated = await tx\n          .update(feedback)\n          .set({ upvotes: sql`${feedback.upvotes} + 1` })\n          .where(eq(feedback.id, feedbackId))\n          .returning();\n        \n        return { upvoted: true, newCount: updated[0]?.upvotes || 1 };\n      }\n    });\n  }\n\n  async getUserFeedbackUpvotes(userId: string): Promise<FeedbackUpvote[]> {\n    return await db\n      .select()\n      .from(feedbackUpvotes)\n      .where(eq(feedbackUpvotes.userId, userId));\n  }\n\n  // Rate Limiting\n  async checkFeedbackRateLimit(identifier: string, identifierType: 'ip' | 'user'): Promise<{\n    allowed: boolean;\n    remaining: number;\n    resetAt: Date | null;\n    blockedUntil: Date | null;\n  }> {\n    const WINDOW_MINUTES = 60; // 1 hour window\n    const MAX_SUBMISSIONS = identifierType === 'user' ? 10 : 5; // Higher limit for logged-in users\n    const windowStart = new Date(Date.now() - WINDOW_MINUTES * 60 * 1000);\n\n    const existing = await db\n      .select()\n      .from(feedbackRateLimits)\n      .where(\n        and(\n          eq(feedbackRateLimits.identifier, identifier),\n          eq(feedbackRateLimits.identifierType, identifierType)\n        )\n      )\n      .limit(1);\n\n    if (existing.length === 0) {\n      return {\n        allowed: true,\n        remaining: MAX_SUBMISSIONS,\n        resetAt: null,\n        blockedUntil: null,\n      };\n    }\n\n    const record = existing[0];\n\n    // Check if blocked\n    if (record.isBlocked && record.blockedUntil && record.blockedUntil > new Date()) {\n      return {\n        allowed: false,\n        remaining: 0,\n        resetAt: null,\n        blockedUntil: record.blockedUntil,\n      };\n    }\n\n    // Check if window has reset\n    if (record.windowStart < windowStart) {\n      return {\n        allowed: true,\n        remaining: MAX_SUBMISSIONS,\n        resetAt: null,\n        blockedUntil: null,\n      };\n    }\n\n    const remaining = Math.max(0, MAX_SUBMISSIONS - record.submissionCount);\n    const resetAt = new Date(record.windowStart.getTime() + WINDOW_MINUTES * 60 * 1000);\n\n    return {\n      allowed: remaining > 0,\n      remaining,\n      resetAt,\n      blockedUntil: null,\n    };\n  }\n\n  async recordFeedbackSubmission(identifier: string, identifierType: 'ip' | 'user'): Promise<void> {\n    const WINDOW_MINUTES = 60;\n    const windowStart = new Date(Date.now() - WINDOW_MINUTES * 60 * 1000);\n    const now = new Date();\n\n    const existing = await db\n      .select()\n      .from(feedbackRateLimits)\n      .where(\n        and(\n          eq(feedbackRateLimits.identifier, identifier),\n          eq(feedbackRateLimits.identifierType, identifierType)\n        )\n      )\n      .limit(1);\n\n    if (existing.length === 0) {\n      // Create new rate limit record\n      await db.insert(feedbackRateLimits).values({\n        identifier,\n        identifierType,\n        submissionCount: 1,\n        windowStart: now,\n        lastSubmission: now,\n      });\n    } else {\n      const record = existing[0];\n      \n      if (record.windowStart < windowStart) {\n        // Reset window\n        await db\n          .update(feedbackRateLimits)\n          .set({\n            submissionCount: 1,\n            windowStart: now,\n            lastSubmission: now,\n            isBlocked: false,\n            blockedUntil: null,\n            blockedReason: null,\n          })\n          .where(eq(feedbackRateLimits.id, record.id));\n      } else {\n        // Increment count\n        await db\n          .update(feedbackRateLimits)\n          .set({\n            submissionCount: sql`${feedbackRateLimits.submissionCount} + 1`,\n            lastSubmission: now,\n          })\n          .where(eq(feedbackRateLimits.id, record.id));\n      }\n    }\n  }\n\n  async blockFeedbackSubmitter(identifier: string, identifierType: 'ip' | 'user', reason: string, durationMinutes: number): Promise<void> {\n    const blockedUntil = new Date(Date.now() + durationMinutes * 60 * 1000);\n\n    const existing = await db\n      .select()\n      .from(feedbackRateLimits)\n      .where(\n        and(\n          eq(feedbackRateLimits.identifier, identifier),\n          eq(feedbackRateLimits.identifierType, identifierType)\n        )\n      )\n      .limit(1);\n\n    if (existing.length === 0) {\n      await db.insert(feedbackRateLimits).values({\n        identifier,\n        identifierType,\n        submissionCount: 0,\n        windowStart: new Date(),\n        isBlocked: true,\n        blockedUntil,\n        blockedReason: reason,\n      });\n    } else {\n      await db\n        .update(feedbackRateLimits)\n        .set({\n          isBlocked: true,\n          blockedUntil,\n          blockedReason: reason,\n        })\n        .where(eq(feedbackRateLimits.id, existing[0].id));\n    }\n  }\n\n  // Admin Management\n  async getFeedbackAdmin(userId: string): Promise<FeedbackAdmin | undefined> {\n    const result = await db\n      .select()\n      .from(feedbackAdmins)\n      .where(eq(feedbackAdmins.userId, userId))\n      .limit(1);\n    return result[0];\n  }\n\n  async createFeedbackAdmin(admin: InsertFeedbackAdmin): Promise<FeedbackAdmin> {\n    const inserted = await db\n      .insert(feedbackAdmins)\n      .values(admin)\n      .returning();\n    return inserted[0];\n  }\n\n  async updateFeedbackAdmin(userId: string, updates: Partial<FeedbackAdmin>): Promise<FeedbackAdmin> {\n    const result = await db\n      .update(feedbackAdmins)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(feedbackAdmins.userId, userId))\n      .returning();\n    return result[0];\n  }\n\n  async deleteFeedbackAdmin(userId: string): Promise<void> {\n    await db.delete(feedbackAdmins).where(eq(feedbackAdmins.userId, userId));\n  }\n\n  async getAllFeedbackAdmins(): Promise<FeedbackAdmin[]> {\n    return await db.select().from(feedbackAdmins).orderBy(feedbackAdmins.createdAt);\n  }\n\n  // Analytics\n  async getFeedbackAnalyticsSummary(): Promise<{\n    totalFeedback: number;\n    newFeedback: number;\n    resolvedFeedback: number;\n    avgResolutionTimeHours: number | null;\n    sentimentBreakdown: { negative: number; neutral: number; positive: number };\n    priorityBreakdown: Record<string, number>;\n    categoryBreakdown: Record<string, number>;\n    statusBreakdown: Record<string, number>;\n  }> {\n    // Total feedback count\n    const totalResult = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(feedback)\n      .where(eq(feedback.isSpam, false));\n    const totalFeedback = totalResult[0]?.count || 0;\n\n    // New feedback count\n    const newResult = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(feedback)\n      .where(and(eq(feedback.status, 'new'), eq(feedback.isSpam, false)));\n    const newFeedback = newResult[0]?.count || 0;\n\n    // Resolved feedback count\n    const resolvedResult = await db\n      .select({ count: sql<number>`count(*)::int` })\n      .from(feedback)\n      .where(and(eq(feedback.status, 'resolved'), eq(feedback.isSpam, false)));\n    const resolvedFeedback = resolvedResult[0]?.count || 0;\n\n    // Average resolution time\n    const avgTimeResult = await db\n      .select({\n        avgHours: sql<number>`AVG(EXTRACT(EPOCH FROM (${feedback.resolvedAt} - ${feedback.createdAt})) / 3600)::float`,\n      })\n      .from(feedback)\n      .where(\n        and(\n          eq(feedback.isSpam, false),\n          sql`${feedback.resolvedAt} IS NOT NULL`\n        )\n      );\n    const avgResolutionTimeHours = avgTimeResult[0]?.avgHours || null;\n\n    // Sentiment breakdown\n    const sentimentBreakdownResult = await db\n      .select({\n        label: feedback.sentimentLabel,\n        count: sql<number>`count(*)::int`,\n      })\n      .from(feedback)\n      .where(and(eq(feedback.isSpam, false), sql`${feedback.sentimentLabel} IS NOT NULL`))\n      .groupBy(feedback.sentimentLabel);\n\n    const sentimentBreakdown = { negative: 0, neutral: 0, positive: 0 };\n    for (const row of sentimentBreakdownResult) {\n      if (row.label === 'negative') sentimentBreakdown.negative = row.count;\n      else if (row.label === 'neutral') sentimentBreakdown.neutral = row.count;\n      else if (row.label === 'positive') sentimentBreakdown.positive = row.count;\n    }\n\n    // Priority breakdown\n    const priorityBreakdownResult = await db\n      .select({\n        priority: feedback.priority,\n        count: sql<number>`count(*)::int`,\n      })\n      .from(feedback)\n      .where(eq(feedback.isSpam, false))\n      .groupBy(feedback.priority);\n\n    const priorityBreakdown: Record<string, number> = {};\n    for (const row of priorityBreakdownResult) {\n      priorityBreakdown[row.priority] = row.count;\n    }\n\n    // Category breakdown\n    const categoryBreakdownResult = await db\n      .select({\n        categoryId: feedback.categoryId,\n        count: sql<number>`count(*)::int`,\n      })\n      .from(feedback)\n      .where(and(eq(feedback.isSpam, false), sql`${feedback.categoryId} IS NOT NULL`))\n      .groupBy(feedback.categoryId);\n\n    const categoryBreakdown: Record<string, number> = {};\n    for (const row of categoryBreakdownResult) {\n      if (row.categoryId !== null) {\n        categoryBreakdown[row.categoryId.toString()] = row.count;\n      }\n    }\n\n    // Status breakdown\n    const statusBreakdownResult = await db\n      .select({\n        status: feedback.status,\n        count: sql<number>`count(*)::int`,\n      })\n      .from(feedback)\n      .where(eq(feedback.isSpam, false))\n      .groupBy(feedback.status);\n\n    const statusBreakdown: Record<string, number> = {};\n    for (const row of statusBreakdownResult) {\n      statusBreakdown[row.status] = row.count;\n    }\n\n    return {\n      totalFeedback,\n      newFeedback,\n      resolvedFeedback,\n      avgResolutionTimeHours,\n      sentimentBreakdown,\n      priorityBreakdown,\n      categoryBreakdown,\n      statusBreakdown,\n    };\n  }\n\n  async saveFeedbackAnalytics(analytics: InsertFeedbackAnalytics): Promise<FeedbackAnalytics> {\n    const inserted = await db\n      .insert(feedbackAnalytics)\n      .values(analytics)\n      .returning();\n    return inserted[0];\n  }\n\n  // ============================================================================\n  // CERTIFICATES\n  // ============================================================================\n\n  async createCertificate(certificate: InsertCertificate): Promise<Certificate> {\n    const result = await db\n      .insert(certificates)\n      .values(certificate)\n      .returning();\n    return result[0];\n  }\n\n  async getUserCertificates(userId: string, certificateType?: string, limit?: number, offset?: number): Promise<Certificate[]> {\n    const conditions = [eq(certificates.userId, userId)];\n    if (certificateType) {\n      conditions.push(eq(certificates.certificateType, certificateType));\n    }\n\n    let baseQuery = db\n      .select()\n      .from(certificates)\n      .where(and(...conditions))\n      .orderBy(desc(certificates.createdAt));\n\n    if (limit !== undefined && offset !== undefined) {\n      return await baseQuery.limit(limit).offset(offset);\n    } else if (limit !== undefined) {\n      return await baseQuery.limit(limit);\n    } else if (offset !== undefined) {\n      return await baseQuery.offset(offset);\n    }\n\n    return await baseQuery;\n  }\n\n  async getCodeTypingTestById(id: number): Promise<CodeTypingTest | undefined> {\n    const result = await db\n      .select()\n      .from(codeTypingTests)\n      .where(eq(codeTypingTests.id, id))\n      .limit(1);\n    return result[0];\n  }\n\n  async getBookTypingTestById(id: number): Promise<BookTypingTest | undefined> {\n    const result = await db\n      .select()\n      .from(bookTypingTests)\n      .where(eq(bookTypingTests.id, id))\n      .limit(1);\n    return result[0];\n  }\n\n  async getRaceParticipationByRaceAndUser(raceId: number, userId: string): Promise<RaceParticipant | undefined> {\n    const result = await db\n      .select()\n      .from(raceParticipants)\n      .where(and(\n        eq(raceParticipants.raceId, raceId),\n        eq(raceParticipants.userId, userId)\n      ))\n      .limit(1);\n    return result[0];\n  }\n\n  async getStressTestById(id: number): Promise<StressTest | undefined> {\n    const result = await db\n      .select()\n      .from(stressTests)\n      .where(eq(stressTests.id, id))\n      .limit(1);\n    return result[0];\n  }\n\n  async getCertificateById(id: number): Promise<Certificate | undefined> {\n    const result = await db\n      .select()\n      .from(certificates)\n      .where(eq(certificates.id, id))\n      .limit(1);\n    return result[0];\n  }\n\n  async getCertificateByShareId(shareId: string): Promise<Certificate | undefined> {\n    const result = await db\n      .select()\n      .from(certificates)\n      .where(and(\n        eq(certificates.shareId, shareId),\n        eq(certificates.isPublic, true)\n      ))\n      .limit(1);\n    return result[0];\n  }\n\n  async getCertificateByCodeTestId(codeTestId: number): Promise<Certificate | undefined> {\n    const result = await db\n      .select()\n      .from(certificates)\n      .where(and(\n        eq(certificates.codeTestId, codeTestId),\n        eq(certificates.isPublic, true)\n      ))\n      .orderBy(desc(certificates.createdAt))\n      .limit(1);\n    return result[0];\n  }\n\n  async updateCertificateViewCount(id: number): Promise<void> {\n    await db\n      .update(certificates)\n      .set({ viewCount: sql`${certificates.viewCount} + 1` })\n      .where(eq(certificates.id, id));\n  }\n\n  async deleteCertificate(id: number): Promise<void> {\n    await db\n      .delete(certificates)\n      .where(eq(certificates.id, id));\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":185305,"size_tokens":null},"client/src/pages/about.tsx":{"content":"import { PLATFORM_STATS, formatNumber } from \"@shared/platform-stats\";\n\nexport default function About() {\n  const stats = {\n    totalUsers: PLATFORM_STATS.TOTAL_USERS,\n    totalTests: PLATFORM_STATS.TOTAL_TESTS,\n    totalLanguages: PLATFORM_STATS.TOTAL_LANGUAGES,\n  };\n\n  return (\n    <div className=\"max-w-4xl mx-auto\" data-testid=\"page-about\">\n      <div className=\"mb-16 text-center\">\n        <h1 className=\"text-5xl font-bold mb-4\" data-testid=\"heading-about\">About TypeMasterAI</h1>\n        <p className=\"text-xl text-muted-foreground max-w-2xl mx-auto leading-relaxed\">\n          Empowering millions of users worldwide to master their typing skills through AI-powered technology and intelligent practice.\n        </p>\n      </div>\n\n      <div className=\"space-y-16\">\n        <section>\n          <h2 className=\"text-3xl font-bold mb-6 pb-3 border-b-2 border-primary/20\">\n            Our Mission\n          </h2>\n          <p className=\"text-muted-foreground text-lg leading-relaxed\">\n            At TypeMasterAI, we believe that typing is more than just a skillâ€”it's a gateway to productivity, creativity, and digital fluency. Our mission is to help people of all ages and backgrounds improve their typing speed and accuracy through cutting-edge AI technology, personalized training, and engaging practice sessions.\n          </p>\n        </section>\n\n        <section className=\"bg-card/30 p-10 rounded-2xl border border-border\">\n          <h2 className=\"text-3xl font-bold mb-8\">\n            What Makes Us Different\n          </h2>\n          <div className=\"grid md:grid-cols-2 gap-8\">\n            <div className=\"space-y-3\">\n              <h3 className=\"font-semibold text-xl mb-2 text-primary\">AI-Powered Content</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                Our platform uses GPT-4 to generate unlimited, contextually relevant typing paragraphs across {stats.totalLanguages}+ languages, ensuring fresh and engaging practice every time.\n              </p>\n            </div>\n\n            <div className=\"space-y-3\">\n              <h3 className=\"font-semibold text-xl mb-2 text-primary\">Real-Time Analytics</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                Track your progress with detailed statistics, visualized charts, and performance insights that help you identify strengths and areas for improvement.\n              </p>\n            </div>\n\n            <div className=\"space-y-3\">\n              <h3 className=\"font-semibold text-xl mb-2 text-primary\">Global Accessibility</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                Support for {stats.totalLanguages}+ languages including English, Spanish, French, Japanese, Chinese, Hindi, Arabic, and many moreâ€”making typing practice accessible worldwide.\n              </p>\n            </div>\n\n            <div className=\"space-y-3\">\n              <h3 className=\"font-semibold text-xl mb-2 text-primary\">Achievements & Certificates</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                Earn downloadable certificates for your accomplishments and compete on global leaderboards to showcase your typing prowess.\n              </p>\n            </div>\n          </div>\n        </section>\n\n        <section>\n          <h2 className=\"text-3xl font-bold mb-6 pb-3 border-b-2 border-primary/20\">\n            Our Story\n          </h2>\n          <div className=\"space-y-4 text-muted-foreground text-lg leading-relaxed\">\n            <p>\n              TypeMasterAI was born from a simple observation: traditional typing tests were boring, repetitive, and failed to engage users beyond basic practice. We envisioned a platform that would transform typing practice into an intelligent, adaptive, and enjoyable experience.\n            </p>\n            <p>\n              By harnessing the power of artificial intelligence, we created a typing platform that generates unlimited fresh content, provides personalized coaching through an AI assistant, and adapts to each user's skill level and interests. Whether you're a student looking to improve productivity, a professional aiming to boost efficiency, or a coding enthusiast practicing on technical content, TypeMasterAI has something for everyone.\n            </p>\n            <p>\n              Today, we're proud to serve thousands of users across the globe, helping them achieve their typing goals and unlock their full potential in the digital world.\n            </p>\n          </div>\n        </section>\n\n        <section className=\"grid md:grid-cols-3 gap-6\">\n          <div className=\"text-center p-8 bg-card/30 rounded-xl border border-border\">\n            <div className=\"text-5xl font-bold text-primary font-mono mb-3\" data-testid=\"stat-languages\">\n              {stats.totalLanguages}+\n            </div>\n            <div className=\"text-sm text-muted-foreground font-medium uppercase tracking-wide\">Languages Supported</div>\n          </div>\n          <div className=\"text-center p-8 bg-card/30 rounded-xl border border-border\">\n            <div className=\"text-5xl font-bold text-primary font-mono mb-3\" data-testid=\"stat-users\">\n              {formatNumber(stats.totalUsers)}\n            </div>\n            <div className=\"text-sm text-muted-foreground font-medium uppercase tracking-wide\">Active Users</div>\n          </div>\n          <div className=\"text-center p-8 bg-card/30 rounded-xl border border-border\">\n            <div className=\"text-5xl font-bold text-primary font-mono mb-3\" data-testid=\"stat-tests\">\n              {formatNumber(stats.totalTests)}\n            </div>\n            <div className=\"text-sm text-muted-foreground font-medium uppercase tracking-wide\">Tests Completed</div>\n          </div>\n        </section>\n\n        <section>\n          <h2 className=\"text-3xl font-bold mb-6 pb-3 border-b-2 border-primary/20\">\n            Who We Serve\n          </h2>\n          <div className=\"grid md:grid-cols-2 gap-6\">\n            <div className=\"p-6 bg-card/20 rounded-xl border border-border/50\">\n              <h3 className=\"font-semibold text-xl mb-3 text-primary\">Students & Learners</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                Improve typing speed for essays, research papers, and online coursework. Build essential digital literacy skills for academic success.\n              </p>\n            </div>\n            <div className=\"p-6 bg-card/20 rounded-xl border border-border/50\">\n              <h3 className=\"font-semibold text-xl mb-3 text-primary\">Professionals</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                Boost workplace productivity by typing faster and more accurately. Save hours every week with improved keyboard efficiency.\n              </p>\n            </div>\n            <div className=\"p-6 bg-card/20 rounded-xl border border-border/50\">\n              <h3 className=\"font-semibold text-xl mb-3 text-primary\">Developers & Coders</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                Practice on programming-specific content and technical vocabulary. Master keyboard shortcuts and coding efficiency.\n              </p>\n            </div>\n            <div className=\"p-6 bg-card/20 rounded-xl border border-border/50\">\n              <h3 className=\"font-semibold text-xl mb-3 text-primary\">Language Enthusiasts</h3>\n              <p className=\"text-muted-foreground leading-relaxed\">\n                Learn to type in new languages with our {stats.totalLanguages}+ language support. Perfect for multilingual individuals and language students.\n              </p>\n            </div>\n          </div>\n        </section>\n\n        <section className=\"bg-gradient-to-r from-primary/10 via-purple-500/10 to-primary/10 p-10 rounded-2xl border border-primary/20\">\n          <h2 className=\"text-3xl font-bold mb-4 text-center\">Our Commitment</h2>\n          <p className=\"text-muted-foreground text-center text-lg max-w-2xl mx-auto leading-relaxed\">\n            We're committed to continuous improvement, user privacy, and providing a free, accessible platform for anyone who wants to improve their typing skills. TypeMasterAI will always prioritize user experience, data security, and innovation in typing education.\n          </p>\n        </section>\n\n        <section className=\"text-center pt-8 pb-4\">\n          <h2 className=\"text-3xl font-bold mb-4\">Ready to Master Your Typing?</h2>\n          <p className=\"text-muted-foreground text-lg mb-8\">\n            Join thousands of users improving their typing speed and accuracy every day.\n          </p>\n          <a\n            href=\"/\"\n            className=\"inline-flex items-center gap-2 px-10 py-4 bg-primary text-primary-foreground font-semibold rounded-lg hover:opacity-90 transition-opacity text-lg\"\n            data-testid=\"button-start-typing\"\n          >\n            Start Typing Now\n          </a>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":9011,"size_tokens":null},"client/src/components/searchable-select.tsx":{"content":"import { useState } from \"react\";\nimport { Check, ChevronsUpDown } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"@/components/ui/command\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"@/components/ui/popover\";\n\ninterface SearchableSelectProps {\n  value: string;\n  onValueChange: (value: string) => void;\n  options: Array<{ value: string; label: string }>;\n  placeholder?: string;\n  searchPlaceholder?: string;\n  emptyText?: string;\n  icon?: React.ReactNode;\n  className?: string;\n  triggerClassName?: string;\n  contentClassName?: string;\n  \"data-testid\"?: string;\n}\n\nexport function SearchableSelect({\n  value,\n  onValueChange,\n  options,\n  placeholder = \"Select...\",\n  searchPlaceholder = \"Search...\",\n  emptyText = \"No results found.\",\n  icon,\n  className,\n  triggerClassName,\n  contentClassName,\n  \"data-testid\": dataTestId,\n}: SearchableSelectProps) {\n  const [open, setOpen] = useState(false);\n\n  const selectedOption = options.find((option) => option.value === value);\n\n  return (\n    <Popover open={open} onOpenChange={setOpen}>\n      <PopoverTrigger asChild>\n        <Button\n          variant=\"outline\"\n          role=\"combobox\"\n          aria-expanded={open}\n          className={cn(\"w-full justify-between bg-secondary hover:bg-secondary/80\", triggerClassName)}\n          data-testid={dataTestId || `searchable-select-${placeholder.toLowerCase().replace(/\\s+/g, '-')}`}\n        >\n          <div className=\"flex items-center gap-2\">\n            {icon}\n            <span className=\"truncate\">\n              {selectedOption ? selectedOption.label : placeholder}\n            </span>\n          </div>\n          <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n        </Button>\n      </PopoverTrigger>\n      <PopoverContent className={cn(\"w-full min-w-[200px] p-0\", contentClassName)} align=\"start\">\n        <Command>\n          <CommandInput placeholder={searchPlaceholder} />\n          <CommandList>\n            <CommandEmpty>{emptyText}</CommandEmpty>\n            <CommandGroup>\n              {options.map((option) => (\n                <CommandItem\n                  key={option.value}\n                  value={option.value}\n                  onSelect={(currentValue) => {\n                    onValueChange(currentValue);\n                    setOpen(false);\n                  }}\n                  data-testid={`option-${option.value}`}\n                >\n                  <Check\n                    className={cn(\n                      \"mr-2 h-4 w-4\",\n                      value === option.value ? \"opacity-100\" : \"opacity-0\"\n                    )}\n                  />\n                  {option.label}\n                </CommandItem>\n              ))}\n            </CommandGroup>\n          </CommandList>\n        </Command>\n      </PopoverContent>\n    </Popover>\n  );\n}\n","path":null,"size_bytes":2976,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md\",\n        \"data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7606,"size_tokens":null},"client/src/pages/privacy-policy.tsx":{"content":"import { Link } from \"wouter\";\n\nexport default function PrivacyPolicy() {\n  return (\n    <div className=\"max-w-4xl mx-auto\" data-testid=\"page-privacy-policy\">\n      <div className=\"mb-12\">\n        <h1 className=\"text-4xl font-bold mb-2\" data-testid=\"heading-privacy-policy\">Privacy Policy</h1>\n        <p className=\"text-muted-foreground text-sm mb-6\">Last Updated: December 9, 2025</p>\n        <p className=\"text-muted-foreground text-lg leading-relaxed\">\n          At TypeMasterAI, we take your privacy seriously. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our typing test platform.\n        </p>\n      </div>\n\n      <div className=\"space-y-10 prose prose-invert max-w-none\">\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">1. Information We Collect</h2>\n          \n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">1.1 Personal Information</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            When you create an account, we collect:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Username and email address</li>\n            <li>Password (encrypted and securely stored)</li>\n            <li>Profile information (avatar color, bio, country, keyboard layout - optional)</li>\n          </ul>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">1.2 Usage Data</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            We automatically collect information about your typing tests:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Typing speed (WPM), accuracy, and error rates</li>\n            <li>Test modes, languages, and paragraph categories you use</li>\n            <li>Timestamp and duration of each test</li>\n            <li>Progress analytics and performance trends</li>\n          </ul>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">1.3 Technical Information</h3>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Browser type and version</li>\n            <li>Device information and screen resolution</li>\n            <li>IP address and approximate location</li>\n            <li>Session data and cookies</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">2. How We Use Your Information</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            We use the collected information for:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Account Management:</strong> Creating and maintaining your account, authentication, and password recovery</li>\n            <li><strong className=\"text-foreground\">Service Delivery:</strong> Providing typing tests, tracking progress, generating statistics and leaderboards</li>\n            <li><strong className=\"text-foreground\">AI Features:</strong> Powering our AI assistant and generating personalized typing content</li>\n            <li><strong className=\"text-foreground\">Improvement:</strong> Analyzing usage patterns to enhance our platform and user experience</li>\n            <li><strong className=\"text-foreground\">Communication:</strong> Sending important updates, security alerts, and feature announcements</li>\n            <li><strong className=\"text-foreground\">Security:</strong> Detecting and preventing fraud, abuse, and technical issues</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">3. Third-Party AI Services</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            TypeMasterAI uses third-party artificial intelligence services to provide enhanced features:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>AI chat assistant for typing tips and guidance</li>\n            <li>Automatic content generation for typing practice</li>\n            <li>Code snippet generation for programming exercises</li>\n            <li>Intelligent features in multiplayer mode</li>\n          </ul>\n          \n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">3.1 Data Processing</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            When you use AI-powered features, certain data may be processed by our third-party AI service providers:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Your chat messages and conversation context</li>\n            <li>Selected language and content preferences</li>\n            <li>Feature-specific inputs and selections</li>\n          </ul>\n          <p className=\"text-muted-foreground mt-4\">\n            <strong className=\"text-foreground\">Important:</strong> We do not send your personal account information, typing test results, or analytics data to third-party AI providers unless you explicitly include it in your inputs.\n          </p>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">3.2 Third-Party Data Practices</h3>\n          <p className=\"text-muted-foreground\">\n            Our AI service providers process data in accordance with their own privacy policies and industry-standard data protection practices. Data is typically retained for limited periods for security and abuse monitoring purposes. For additional details on our AI practices, see our <Link href=\"/ai-transparency\" className=\"text-primary hover:underline\">AI Transparency Notice</Link>.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">4. Data Storage and Security</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            We implement industry-standard security measures to protect your data:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Passwords are encrypted using strong cryptographic hashing</li>\n            <li>Secure HTTPS encryption for all data transmission</li>\n            <li>Database access controls and regular backups</li>\n            <li>Session-based authentication with secure cookies</li>\n            <li>Regular security audits and updates</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">5. Data Sharing and Disclosure</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            We do not sell your personal information. We may share data only in these circumstances:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Public Leaderboards:</strong> Your username and typing scores are publicly visible on leaderboards</li>\n            <li><strong className=\"text-foreground\">Service Providers:</strong> Third-party providers for AI features, hosting, and infrastructure services</li>\n            <li><strong className=\"text-foreground\">Legal Requirements:</strong> When required by law, court order, or government request</li>\n            <li><strong className=\"text-foreground\">Business Transfers:</strong> In case of merger, acquisition, or sale of assets</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">6. Cookies and Tracking</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            We use cookies and similar technologies for:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Authentication and session management</li>\n            <li>Remembering your preferences (theme, language, test settings)</li>\n            <li>Analytics to understand how you use our platform</li>\n          </ul>\n          <p className=\"text-muted-foreground mt-4\">\n            You can control cookies through your browser settings. See our <Link href=\"/cookie-policy\" className=\"text-primary hover:underline\">Cookie Policy</Link> for more details.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">7. Your Rights and Choices</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            You have the right to:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Access:</strong> Request a copy of your personal data</li>\n            <li><strong className=\"text-foreground\">Correction:</strong> Update or correct your account information</li>\n            <li><strong className=\"text-foreground\">Deletion:</strong> Request deletion of your account and associated data</li>\n            <li><strong className=\"text-foreground\">Export:</strong> Download your typing test history and statistics</li>\n            <li><strong className=\"text-foreground\">Opt-out:</strong> Unsubscribe from promotional emails</li>\n          </ul>\n          <p className=\"text-muted-foreground mt-4\">\n            To exercise these rights, contact us at <a href=\"mailto:support@typemasterai.com\" className=\"text-primary hover:underline\">support@typemasterai.com</a>\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">8. Children's Privacy</h2>\n          <p className=\"text-muted-foreground\">\n            TypeMasterAI is intended for users aged 13 and above. We do not knowingly collect personal information from children under 13. If you believe we have collected information from a child under 13, please contact us immediately.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">9. Data Retention</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            We retain your personal data only for as long as necessary to fulfill the purposes outlined in this policy:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Account Data:</strong> Retained while your account is active and for 30 days after deletion request</li>\n            <li><strong className=\"text-foreground\">Typing Test History:</strong> Retained for 2 years from test completion, or until account deletion</li>\n            <li><strong className=\"text-foreground\">Analytics Data:</strong> Aggregated and anonymized after 90 days</li>\n            <li><strong className=\"text-foreground\">AI Conversation Logs:</strong> Automatically purged after 30 days</li>\n            <li><strong className=\"text-foreground\">Session Logs:</strong> Deleted after 7 days</li>\n            <li><strong className=\"text-foreground\">Backup Data:</strong> Retained for up to 90 days for disaster recovery</li>\n          </ul>\n          <p className=\"text-muted-foreground mt-4\">\n            After the retention period, data is securely deleted or anonymized in accordance with industry best practices.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">10. European Union Users (GDPR)</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            If you are located in the European Economic Area (EEA), United Kingdom, or Switzerland, you have additional rights under the General Data Protection Regulation (GDPR):\n          </p>\n          \n          <h3 className=\"text-xl font-semibold text-foreground mb-3\">10.1 Legal Basis for Processing</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            We process your personal data based on:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Contract Performance:</strong> To provide typing tests, analytics, and account services you've requested</li>\n            <li><strong className=\"text-foreground\">Legitimate Interests:</strong> To improve our platform, prevent fraud, and ensure security</li>\n            <li><strong className=\"text-foreground\">Consent:</strong> For optional features like marketing communications and analytics cookies</li>\n            <li><strong className=\"text-foreground\">Legal Obligations:</strong> To comply with applicable laws and regulations</li>\n          </ul>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">10.2 Your GDPR Rights</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            Under GDPR, you have the right to:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Access:</strong> Request a copy of your personal data in a portable format</li>\n            <li><strong className=\"text-foreground\">Rectification:</strong> Correct inaccurate or incomplete personal data</li>\n            <li><strong className=\"text-foreground\">Erasure:</strong> Request deletion of your personal data (\"Right to be Forgotten\")</li>\n            <li><strong className=\"text-foreground\">Restrict Processing:</strong> Limit how we use your data in certain circumstances</li>\n            <li><strong className=\"text-foreground\">Data Portability:</strong> Receive your data in a structured, machine-readable format</li>\n            <li><strong className=\"text-foreground\">Object:</strong> Opt out of processing based on legitimate interests</li>\n            <li><strong className=\"text-foreground\">Withdraw Consent:</strong> Withdraw previously given consent at any time</li>\n            <li><strong className=\"text-foreground\">Lodge Complaint:</strong> File a complaint with your local data protection authority</li>\n          </ul>\n          <p className=\"text-muted-foreground mt-4\">\n            To exercise these rights, contact us at <a href=\"mailto:support@typemasterai.com\" className=\"text-primary hover:underline\">support@typemasterai.com</a>. We will respond within 30 days.\n          </p>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">10.3 International Data Transfers</h3>\n          <p className=\"text-muted-foreground\">\n            Your data may be transferred internationally to countries where our service providers operate. We ensure appropriate safeguards through Standard Contractual Clauses (SCCs) and other legally recognized transfer mechanisms to protect your data during international transfers.\n          </p>\n        </section>\n\n        <section id=\"california-residents\">\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">11. California Residents (CCPA/CPRA)</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            If you are a California resident, the California Consumer Privacy Act (CCPA) and California Privacy Rights Act (CPRA) provide you with additional rights:\n          </p>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3\">11.1 Your California Privacy Rights</h3>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Right to Know:</strong> Request disclosure of personal information we collect, use, disclose, and sell</li>\n            <li><strong className=\"text-foreground\">Right to Delete:</strong> Request deletion of your personal information</li>\n            <li><strong className=\"text-foreground\">Right to Correct:</strong> Request correction of inaccurate personal information</li>\n            <li><strong className=\"text-foreground\">Right to Opt-Out:</strong> Opt out of the sale or sharing of personal information</li>\n            <li><strong className=\"text-foreground\">Right to Limit:</strong> Limit use of sensitive personal information</li>\n            <li><strong className=\"text-foreground\">Non-Discrimination:</strong> Receive equal service and pricing regardless of exercising privacy rights</li>\n          </ul>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">11.2 Categories of Personal Information</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            In the past 12 months, we have collected the following categories of personal information:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Identifiers (username, email address, IP address)</li>\n            <li>Internet activity (typing test results, browsing history on our platform)</li>\n            <li>Geolocation data (approximate location from IP address)</li>\n            <li>Inferences (typing skill level, improvement patterns)</li>\n          </ul>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">11.3 Do Not Sell or Share</h3>\n          <p className=\"text-muted-foreground\">\n            <strong className=\"text-foreground\">TypeMasterAI does not sell your personal information.</strong> We do not share your personal information for cross-context behavioral advertising. To exercise any California privacy rights, contact us at <a href=\"mailto:support@typemasterai.com\" className=\"text-primary hover:underline\">support@typemasterai.com</a>. We will verify your identity and respond within 45 days.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">12. International Users</h2>\n          <p className=\"text-muted-foreground\">\n            TypeMasterAI operates globally and serves users worldwide. Your information may be transferred to, stored, and processed in multiple countries where we or our service providers operate. By using our service, you consent to international data transfers. We implement appropriate safeguards to protect your data during such transfers, including Standard Contractual Clauses where required by law.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">13. Changes to This Policy</h2>\n          <p className=\"text-muted-foreground\">\n            We may update this Privacy Policy periodically. We will notify you of significant changes by email or through a prominent notice on our platform. Your continued use of TypeMasterAI after changes indicates acceptance of the updated policy.\n          </p>\n        </section>\n\n        <section className=\"bg-card/30 p-8 rounded-xl border border-border\">\n          <h2 className=\"text-2xl font-bold text-foreground mb-6\">Contact Us</h2>\n          <p className=\"text-muted-foreground mb-6\">\n            If you have questions or concerns about this Privacy Policy, please contact us:\n          </p>\n          <div className=\"space-y-4\">\n            <div>\n              <p className=\"text-sm font-semibold text-foreground mb-1\">Email</p>\n              <a href=\"mailto:support@typemasterai.com\" className=\"text-primary hover:underline text-lg\">\n                support@typemasterai.com\n              </a>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-foreground mb-1\">Mailing Address</p>\n              <p className=\"text-muted-foreground\">\n                TypeMasterAI<br />\n                Solapur, Maharashtra 413224<br />\n                India\n              </p>\n            </div>\n          </div>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":19929,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-5 w-9 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-4 w-4 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-4 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1148,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"import * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload\n            .filter((item) => item.type !== \"none\")\n            .map((item, index) => {\n              const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n              const itemConfig = getPayloadConfigFromPayload(config, item, key)\n              const indicatorColor = color || item.payload.fill || item.color\n\n              return (\n                <div\n                  key={item.dataKey}\n                  className={cn(\n                    \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                    indicator === \"dot\" && \"items-center\"\n                  )}\n                >\n                  {formatter && item?.value !== undefined && item.name ? (\n                    formatter(item.value, item.name, item, index, item.payload)\n                  ) : (\n                    <>\n                      {itemConfig?.icon ? (\n                        <itemConfig.icon />\n                      ) : (\n                        !hideIndicator && (\n                          <div\n                            className={cn(\n                              \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                              {\n                                \"h-2.5 w-2.5\": indicator === \"dot\",\n                                \"w-1\": indicator === \"line\",\n                                \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                  indicator === \"dashed\",\n                                \"my-0.5\": nestLabel && indicator === \"dashed\",\n                              }\n                            )}\n                            style={\n                              {\n                                \"--color-bg\": indicatorColor,\n                                \"--color-border\": indicatorColor,\n                              } as React.CSSProperties\n                            }\n                          />\n                        )\n                      )}\n                      <div\n                        className={cn(\n                          \"flex flex-1 justify-between leading-none\",\n                          nestLabel ? \"items-end\" : \"items-center\"\n                        )}\n                      >\n                        <div className=\"grid gap-1.5\">\n                          {nestLabel ? tooltipLabel : null}\n                          <span className=\"text-muted-foreground\">\n                            {itemConfig?.label || item.name}\n                          </span>\n                        </div>\n                        {item.value && (\n                          <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                            {item.value.toLocaleString()}\n                          </span>\n                        )}\n                      </div>\n                    </>\n                  )}\n                </div>\n              )\n            })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload\n          .filter((item) => item.type !== \"none\")\n          .map((item) => {\n            const key = `${nameKey || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n            return (\n              <div\n                key={item.value}\n                className={cn(\n                  \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n                )}\n              >\n                {itemConfig?.icon && !hideIcon ? (\n                  <itemConfig.icon />\n                ) : (\n                  <div\n                    className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                    style={{\n                      backgroundColor: item.color,\n                    }}\n                  />\n                )}\n                {itemConfig?.label}\n              </div>\n            )\n          })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10763,"size_tokens":null},"server/index-prod.ts":{"content":"import fs from \"node:fs\";\nimport { type Server } from \"node:http\";\nimport path from \"node:path\";\n\nimport express, { type Express, type Request } from \"express\";\n\nimport runApp from \"./app\";\n\nexport async function serveStatic(app: Express, server: Server) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n\n(async () => {\n  await runApp(serveStatic);\n})();\n","path":null,"size_bytes":726,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-1.5 w-full grow overflow-hidden rounded-full bg-primary/20\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-4 w-4 rounded-full border border-primary/50 bg-background shadow transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1037,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport {\n  ChevronDownIcon,\n  ChevronLeftIcon,\n  ChevronRightIcon,\n} from \"lucide-react\"\nimport { DayButton, DayPicker, getDefaultClassNames } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button, buttonVariants } from \"@/components/ui/button\"\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  captionLayout = \"label\",\n  buttonVariant = \"ghost\",\n  formatters,\n  components,\n  ...props\n}: React.ComponentProps<typeof DayPicker> & {\n  buttonVariant?: React.ComponentProps<typeof Button>[\"variant\"]\n}) {\n  const defaultClassNames = getDefaultClassNames()\n\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\n        \"bg-background group/calendar p-3 [--cell-size:2rem] [[data-slot=card-content]_&]:bg-transparent [[data-slot=popover-content]_&]:bg-transparent\",\n        String.raw`rtl:**:[.rdp-button\\_next>svg]:rotate-180`,\n        String.raw`rtl:**:[.rdp-button\\_previous>svg]:rotate-180`,\n        className\n      )}\n      captionLayout={captionLayout}\n      formatters={{\n        formatMonthDropdown: (date) =>\n          date.toLocaleString(\"default\", { month: \"short\" }),\n        ...formatters,\n      }}\n      classNames={{\n        root: cn(\"w-fit\", defaultClassNames.root),\n        months: cn(\n          \"relative flex flex-col gap-4 md:flex-row\",\n          defaultClassNames.months\n        ),\n        month: cn(\"flex w-full flex-col gap-4\", defaultClassNames.month),\n        nav: cn(\n          \"absolute inset-x-0 top-0 flex w-full items-center justify-between gap-1\",\n          defaultClassNames.nav\n        ),\n        button_previous: cn(\n          buttonVariants({ variant: buttonVariant }),\n          \"h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50\",\n          defaultClassNames.button_previous\n        ),\n        button_next: cn(\n          buttonVariants({ variant: buttonVariant }),\n          \"h-[--cell-size] w-[--cell-size] select-none p-0 aria-disabled:opacity-50\",\n          defaultClassNames.button_next\n        ),\n        month_caption: cn(\n          \"flex h-[--cell-size] w-full items-center justify-center px-[--cell-size]\",\n          defaultClassNames.month_caption\n        ),\n        dropdowns: cn(\n          \"flex h-[--cell-size] w-full items-center justify-center gap-1.5 text-sm font-medium\",\n          defaultClassNames.dropdowns\n        ),\n        dropdown_root: cn(\n          \"has-focus:border-ring border-input shadow-xs has-focus:ring-ring/50 has-focus:ring-[3px] relative rounded-md border\",\n          defaultClassNames.dropdown_root\n        ),\n        dropdown: cn(\n          \"bg-popover absolute inset-0 opacity-0\",\n          defaultClassNames.dropdown\n        ),\n        caption_label: cn(\n          \"select-none font-medium\",\n          captionLayout === \"label\"\n            ? \"text-sm\"\n            : \"[&>svg]:text-muted-foreground flex h-8 items-center gap-1 rounded-md pl-2 pr-1 text-sm [&>svg]:size-3.5\",\n          defaultClassNames.caption_label\n        ),\n        table: \"w-full border-collapse\",\n        weekdays: cn(\"flex\", defaultClassNames.weekdays),\n        weekday: cn(\n          \"text-muted-foreground flex-1 select-none rounded-md text-[0.8rem] font-normal\",\n          defaultClassNames.weekday\n        ),\n        week: cn(\"mt-2 flex w-full\", defaultClassNames.week),\n        week_number_header: cn(\n          \"w-[--cell-size] select-none\",\n          defaultClassNames.week_number_header\n        ),\n        week_number: cn(\n          \"text-muted-foreground select-none text-[0.8rem]\",\n          defaultClassNames.week_number\n        ),\n        day: cn(\n          \"group/day relative aspect-square h-full w-full select-none p-0 text-center [&:first-child[data-selected=true]_button]:rounded-l-md [&:last-child[data-selected=true]_button]:rounded-r-md\",\n          defaultClassNames.day\n        ),\n        range_start: cn(\n          \"bg-accent rounded-l-md\",\n          defaultClassNames.range_start\n        ),\n        range_middle: cn(\"rounded-none\", defaultClassNames.range_middle),\n        range_end: cn(\"bg-accent rounded-r-md\", defaultClassNames.range_end),\n        today: cn(\n          \"bg-accent text-accent-foreground rounded-md data-[selected=true]:rounded-none\",\n          defaultClassNames.today\n        ),\n        outside: cn(\n          \"text-muted-foreground aria-selected:text-muted-foreground\",\n          defaultClassNames.outside\n        ),\n        disabled: cn(\n          \"text-muted-foreground opacity-50\",\n          defaultClassNames.disabled\n        ),\n        hidden: cn(\"invisible\", defaultClassNames.hidden),\n        ...classNames,\n      }}\n      components={{\n        Root: ({ className, rootRef, ...props }) => {\n          return (\n            <div\n              data-slot=\"calendar\"\n              ref={rootRef}\n              className={cn(className)}\n              {...props}\n            />\n          )\n        },\n        Chevron: ({ className, orientation, ...props }) => {\n          if (orientation === \"left\") {\n            return (\n              <ChevronLeftIcon className={cn(\"size-4\", className)} {...props} />\n            )\n          }\n\n          if (orientation === \"right\") {\n            return (\n              <ChevronRightIcon\n                className={cn(\"size-4\", className)}\n                {...props}\n              />\n            )\n          }\n\n          return (\n            <ChevronDownIcon className={cn(\"size-4\", className)} {...props} />\n          )\n        },\n        DayButton: CalendarDayButton,\n        WeekNumber: ({ children, ...props }) => {\n          return (\n            <td {...props}>\n              <div className=\"flex size-[--cell-size] items-center justify-center text-center\">\n                {children}\n              </div>\n            </td>\n          )\n        },\n        ...components,\n      }}\n      {...props}\n    />\n  )\n}\n\nfunction CalendarDayButton({\n  className,\n  day,\n  modifiers,\n  ...props\n}: React.ComponentProps<typeof DayButton>) {\n  const defaultClassNames = getDefaultClassNames()\n\n  const ref = React.useRef<HTMLButtonElement>(null)\n  React.useEffect(() => {\n    if (modifiers.focused) ref.current?.focus()\n  }, [modifiers.focused])\n\n  return (\n    <Button\n      ref={ref}\n      variant=\"ghost\"\n      size=\"icon\"\n      data-day={day.date.toLocaleDateString()}\n      data-selected-single={\n        modifiers.selected &&\n        !modifiers.range_start &&\n        !modifiers.range_end &&\n        !modifiers.range_middle\n      }\n      data-range-start={modifiers.range_start}\n      data-range-end={modifiers.range_end}\n      data-range-middle={modifiers.range_middle}\n      className={cn(\n        \"data-[selected-single=true]:bg-primary data-[selected-single=true]:text-primary-foreground data-[range-middle=true]:bg-accent data-[range-middle=true]:text-accent-foreground data-[range-start=true]:bg-primary data-[range-start=true]:text-primary-foreground data-[range-end=true]:bg-primary data-[range-end=true]:text-primary-foreground group-data-[focused=true]/day:border-ring group-data-[focused=true]/day:ring-ring/50 flex aspect-square h-auto w-full min-w-[--cell-size] flex-col gap-1 font-normal leading-none data-[range-end=true]:rounded-md data-[range-middle=true]:rounded-none data-[range-start=true]:rounded-md group-data-[focused=true]/day:relative group-data-[focused=true]/day:z-10 group-data-[focused=true]/day:ring-[3px] [&>span]:text-xs [&>span]:opacity-70\",\n        defaultClassNames.day,\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport { Calendar, CalendarDayButton }\n","path":null,"size_bytes":7569,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border px-4 py-3 text-sm [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground [&>svg~*]:pl-7\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1598,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1419,"size_tokens":null},"client/src/components/ui/sonner.tsx":{"content":"\"use client\"\n\nimport { useTheme } from \"next-themes\"\nimport { Toaster as Sonner } from \"sonner\"\n\ntype ToasterProps = React.ComponentProps<typeof Sonner>\n\nconst Toaster = ({ ...props }: ToasterProps) => {\n  const { theme = \"system\" } = useTheme()\n\n  return (\n    <Sonner\n      theme={theme as ToasterProps[\"theme\"]}\n      className=\"toaster group\"\n      toastOptions={{\n        classNames: {\n          toast:\n            \"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg\",\n          description: \"group-[.toast]:text-muted-foreground\",\n          actionButton:\n            \"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground\",\n          cancelButton:\n            \"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground\",\n        },\n      }}\n      {...props}\n    />\n  )\n}\n\nexport { Toaster }\n","path":null,"size_bytes":894,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/pages/chat.tsx":{"content":"import { useState, useRef, useEffect, useCallback } from \"react\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Input } from \"@/components/ui/input\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport {\n  Loader2,\n  Send,\n  User,\n  Plus,\n  ChevronRight,\n  Search,\n  MoreVertical,\n  Trash2,\n  Sparkles,\n  Paperclip,\n  PanelLeft,\n  SquarePen,\n  Copy,\n  Check,\n  RefreshCw,\n  Square,\n  ThumbsUp,\n  ThumbsDown,\n  Pencil,\n  Clock,\n  Zap,\n  BookOpen,\n  Code,\n  MessageSquare,\n  Globe,\n  ExternalLink,\n  ChevronDown,\n  FileText,\n} from \"lucide-react\";\nimport ReactMarkdown from \"react-markdown\";\nimport remarkGfm from \"remark-gfm\";\nimport { cn } from \"@/lib/utils\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\n\ninterface Message {\n  role: \"user\" | \"assistant\";\n  content: string;\n  displayContent?: string;\n  attachedFile?: { name: string; type: string };\n  timestamp?: Date;\n  feedback?: \"up\" | \"down\" | null;\n  sources?: Array<{ title: string; url: string; snippet: string }>;\n}\n\ninterface SearchState {\n  isSearching: boolean;\n  status: \"deciding\" | \"searching\" | \"complete\" | null;\n  query: string;\n  results: Array<{ title: string; url: string; snippet: string }>;\n}\n\ninterface ChatErrorInfo {\n  code: string;\n  message: string;\n  retryable: boolean;\n  retryAfter?: number;\n}\n\n// Error display component with retry functionality\nfunction ChatErrorDisplay({ \n  error, \n  onRetry, \n  isRetrying \n}: { \n  error: ChatErrorInfo; \n  onRetry: () => void; \n  isRetrying: boolean;\n}) {\n  const [countdown, setCountdown] = useState(error.retryAfter || 0);\n  \n  useEffect(() => {\n    if (countdown > 0) {\n      const timer = setTimeout(() => setCountdown(c => c - 1), 1000);\n      return () => clearTimeout(timer);\n    }\n  }, [countdown]);\n\n  const getErrorIcon = () => {\n    switch (error.code) {\n      case \"RATE_LIMITED\":\n        return <Clock className=\"w-5 h-5 text-amber-500\" />;\n      case \"NETWORK_ERROR\":\n        return <Globe className=\"w-5 h-5 text-red-500\" />;\n      case \"SERVICE_UNAVAILABLE\":\n        return <Loader2 className=\"w-5 h-5 text-amber-500\" />;\n      case \"CONTEXT_LENGTH_EXCEEDED\":\n        return <MessageSquare className=\"w-5 h-5 text-blue-500\" />;\n      case \"CONTENT_FILTERED\":\n        return <Square className=\"w-5 h-5 text-red-500\" />;\n      default:\n        return <Zap className=\"w-5 h-5 text-red-500\" />;\n    }\n  };\n\n  const getErrorColor = () => {\n    switch (error.code) {\n      case \"RATE_LIMITED\":\n      case \"SERVICE_UNAVAILABLE\":\n        return \"border-amber-500/30 bg-amber-500/10\";\n      case \"CONTEXT_LENGTH_EXCEEDED\":\n        return \"border-blue-500/30 bg-blue-500/10\";\n      default:\n        return \"border-red-500/30 bg-red-500/10\";\n    }\n  };\n\n  return (\n    <div className={cn(\n      \"flex flex-col gap-3 p-4 rounded-lg border animate-in fade-in duration-300\",\n      getErrorColor()\n    )}>\n      <div className=\"flex items-start gap-3\">\n        <div className=\"flex-shrink-0 mt-0.5\">\n          {getErrorIcon()}\n        </div>\n        <div className=\"flex-1\">\n          <p className=\"text-sm font-medium text-foreground\">{error.message}</p>\n          {error.code === \"CONTEXT_LENGTH_EXCEEDED\" && (\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Try starting a new conversation or removing some messages.\n            </p>\n          )}\n          {error.code === \"RATE_LIMITED\" && countdown > 0 && (\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Please wait {countdown} seconds before retrying.\n            </p>\n          )}\n        </div>\n      </div>\n      \n      {error.retryable && (\n        <div className=\"flex justify-end\">\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={onRetry}\n            disabled={isRetrying || countdown > 0}\n            className=\"gap-2\"\n            data-testid=\"button-retry\"\n          >\n            {isRetrying ? (\n              <>\n                <Loader2 className=\"w-3.5 h-3.5 animate-spin\" />\n                Retrying...\n              </>\n            ) : countdown > 0 ? (\n              <>\n                <Clock className=\"w-3.5 h-3.5\" />\n                Wait {countdown}s\n              </>\n            ) : (\n              <>\n                <RefreshCw className=\"w-3.5 h-3.5\" />\n                Try Again\n              </>\n            )}\n          </Button>\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction CopyButton({ text, className }: { text: string; className?: string }) {\n  const [copied, setCopied] = useState(false);\n  \n  const handleCopy = async (e: React.MouseEvent) => {\n    e.stopPropagation();\n    await navigator.clipboard.writeText(text);\n    setCopied(true);\n    setTimeout(() => setCopied(false), 2000);\n  };\n  \n  return (\n    <Button\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7 rounded-md hover:bg-muted\", className)}\n      onClick={handleCopy}\n      data-testid=\"button-copy\"\n    >\n      {copied ? (\n        <Check className=\"w-3.5 h-3.5 text-green-500\" />\n      ) : (\n        <Copy className=\"w-3.5 h-3.5 text-muted-foreground\" />\n      )}\n    </Button>\n  );\n}\n\nfunction CodeBlock({ language, children }: { language?: string; children: string }) {\n  const [copied, setCopied] = useState(false);\n  \n  const handleCopy = async () => {\n    await navigator.clipboard.writeText(children);\n    setCopied(true);\n    setTimeout(() => setCopied(false), 2000);\n  };\n  \n  const displayLanguage = language?.replace(/^language-/, '') || 'code';\n  \n  return (\n    <div className=\"relative group my-4\">\n      <div className=\"flex items-center justify-between px-4 py-2 bg-zinc-800 dark:bg-zinc-900 border-b border-zinc-700 rounded-t-lg\">\n        <span className=\"text-xs text-zinc-400 font-mono\">{displayLanguage}</span>\n        <Button\n          variant=\"ghost\"\n          size=\"sm\"\n          className=\"h-7 px-2 text-xs text-zinc-400 hover:text-zinc-100 hover:bg-zinc-700\"\n          onClick={handleCopy}\n          data-testid=\"button-copy-code\"\n        >\n          {copied ? (\n            <>\n              <Check className=\"w-3.5 h-3.5 mr-1.5 text-green-500\" />\n              Copied!\n            </>\n          ) : (\n            <>\n              <Copy className=\"w-3.5 h-3.5 mr-1.5\" />\n              Copy\n            </>\n          )}\n        </Button>\n      </div>\n      <pre className=\"bg-zinc-800 dark:bg-zinc-900 p-4 rounded-b-lg overflow-x-auto\">\n        <code className=\"text-sm font-mono text-zinc-100\">{children}</code>\n      </pre>\n    </div>\n  );\n}\n\nfunction SearchIndicator({ searchState }: { searchState: SearchState }) {\n  if (!searchState.isSearching && searchState.status !== \"complete\") return null;\n  \n  return (\n    <div className=\"flex flex-col gap-3 py-4 animate-in fade-in slide-in-from-bottom-2 duration-300\">\n      {/* Deciding Phase */}\n      {searchState.status === \"deciding\" && (\n        <div className=\"flex items-center gap-3 p-3 bg-gradient-to-r from-primary/10 to-transparent rounded-lg border border-primary/20\">\n          <div className=\"relative flex items-center justify-center w-8 h-8\">\n            <div className=\"absolute w-8 h-8 border-2 border-primary/30 border-t-primary rounded-full animate-spin\" />\n            <Sparkles className=\"w-4 h-4 text-primary animate-pulse\" />\n          </div>\n          <div className=\"flex flex-col\">\n            <span className=\"text-sm font-medium text-foreground\">Analyzing your question</span>\n            <span className=\"text-xs text-muted-foreground\">Determining if web search is needed...</span>\n          </div>\n        </div>\n      )}\n      \n      {/* Searching Phase */}\n      {searchState.status === \"searching\" && (\n        <div className=\"flex flex-col gap-3 p-4 bg-gradient-to-r from-blue-500/10 via-purple-500/10 to-pink-500/10 rounded-lg border border-primary/20 overflow-hidden relative\">\n          {/* Animated background effect */}\n          <div className=\"absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent animate-shimmer\" style={{ backgroundSize: '200% 100%' }} />\n          \n          <div className=\"flex items-center gap-3 relative z-10\">\n            <div className=\"relative flex items-center justify-center w-10 h-10 bg-primary/20 rounded-full\">\n              <Globe className=\"w-5 h-5 text-primary animate-spin\" style={{ animationDuration: '3s' }} />\n              <div className=\"absolute inset-0 rounded-full border-2 border-primary/50 animate-ping\" style={{ animationDuration: '1.5s' }} />\n            </div>\n            <div className=\"flex flex-col flex-1\">\n              <div className=\"flex items-center gap-2\">\n                <span className=\"text-sm font-semibold text-foreground\">Searching the web</span>\n                <div className=\"flex gap-1\">\n                  <span className=\"w-1.5 h-1.5 bg-primary rounded-full animate-bounce\" style={{ animationDelay: '0ms' }} />\n                  <span className=\"w-1.5 h-1.5 bg-primary rounded-full animate-bounce\" style={{ animationDelay: '150ms' }} />\n                  <span className=\"w-1.5 h-1.5 bg-primary rounded-full animate-bounce\" style={{ animationDelay: '300ms' }} />\n                </div>\n              </div>\n              {searchState.query && (\n                <span className=\"text-xs text-muted-foreground mt-0.5\">\n                  \"{searchState.query.substring(0, 50)}{searchState.query.length > 50 ? '...' : ''}\"\n                </span>\n              )}\n            </div>\n          </div>\n          \n          {/* Progress bar animation */}\n          <div className=\"relative h-1 bg-primary/20 rounded-full overflow-hidden\">\n            <div className=\"absolute inset-y-0 left-0 bg-gradient-to-r from-primary via-purple-500 to-pink-500 rounded-full animate-pulse\" style={{ width: '60%', animationDuration: '1s' }} />\n            <div className=\"absolute inset-y-0 left-0 bg-gradient-to-r from-primary to-purple-500 rounded-full\" style={{ width: '100%', animation: 'progress-indeterminate 1.5s ease-in-out infinite' }} />\n          </div>\n        </div>\n      )}\n      \n      {/* Complete Phase */}\n      {searchState.status === \"complete\" && searchState.results.length > 0 && (\n        <div className=\"flex flex-col gap-3 p-3 bg-gradient-to-r from-green-500/10 to-transparent rounded-lg border border-green-500/30 animate-in fade-in duration-300\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"flex items-center justify-center w-8 h-8 bg-green-500/20 rounded-full\">\n              <Check className=\"w-4 h-4 text-green-500\" />\n            </div>\n            <div className=\"flex flex-col\">\n              <span className=\"text-sm font-medium text-foreground\">\n                Found {searchState.results.length} source{searchState.results.length !== 1 ? 's' : ''}\n              </span>\n              <span className=\"text-xs text-muted-foreground\">Generating response with live data...</span>\n            </div>\n          </div>\n          \n          <div className=\"flex flex-wrap gap-2 ml-11\">\n            {searchState.results.slice(0, 5).map((result, idx) => {\n              let domain = \"\";\n              try {\n                domain = new URL(result.url).hostname.replace(\"www.\", \"\");\n              } catch {\n                domain = result.url;\n              }\n              return (\n                <a\n                  key={idx}\n                  href={result.url}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"flex items-center gap-1.5 px-2.5 py-1.5 text-xs bg-muted/50 hover:bg-muted rounded-md text-muted-foreground hover:text-foreground transition-all hover:scale-105 border border-transparent hover:border-primary/30\"\n                  data-testid={`link-source-${idx}`}\n                >\n                  <Globe className=\"w-3 h-3 flex-shrink-0\" />\n                  <span className=\"truncate max-w-[140px]\">{domain}</span>\n                  <ExternalLink className=\"w-2.5 h-2.5 opacity-50\" />\n                </a>\n              );\n            })}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction TypingIndicator({ searchState }: { searchState?: SearchState }) {\n  if (searchState?.isSearching) {\n    return <SearchIndicator searchState={searchState} />;\n  }\n  \n  // Easily customize the loading indicator variant here:\n  // Available variants: \"breathing-cursor\" (default), \"bouncing-dots\", \"pulse-wave\", \"typing-cursor\"\n  // Example: <DynamicAILoadingIndicator variant=\"pulse-wave\" />\n  return <DynamicAILoadingIndicator variant=\"breathing-cursor\" />;\n}\n\n/**\n * DynamicAILoadingIndicator - Modern AI response loading animations\n * \n * Inspired by ChatGPT, Claude, and Gemini loading experiences.\n * Features 4 distinct animation variants with rotating status messages.\n * \n * @param variant - Animation style to display\n *   - \"breathing-cursor\": ChatGPT-inspired pulsing cursor (default)\n *   - \"bouncing-dots\": Classic animated bouncing dots\n *   - \"pulse-wave\": Sound wave-style pulsing bars\n *   - \"typing-cursor\": Simulated typing with blinking cursor\n * \n * @param message - Optional custom initial message (defaults to \"Thinking...\")\n * \n * Messages automatically rotate every 2 seconds between:\n * \"Thinking...\", \"Analyzing...\", \"Generating response...\", \"Processing...\"\n * \n * Easy to extend: Add new variants by adding another if block with your animation\n */\nfunction DynamicAILoadingIndicator({ \n  variant = \"breathing-cursor\",\n  message = \"Thinking...\"\n}: { \n  variant?: \"breathing-cursor\" | \"bouncing-dots\" | \"pulse-wave\" | \"typing-cursor\";\n  message?: string;\n}) {\n  const [currentMessage, setCurrentMessage] = useState(message);\n  const [dots, setDots] = useState(\"\");\n  \n  useEffect(() => {\n    const messages = [\n      \"Thinking...\",\n      \"Analyzing...\",\n      \"Generating response...\",\n      \"Processing...\",\n    ];\n    \n    let messageIndex = 0;\n    const messageInterval = setInterval(() => {\n      messageIndex = (messageIndex + 1) % messages.length;\n      setCurrentMessage(messages[messageIndex]);\n    }, 2000);\n    \n    const dotInterval = setInterval(() => {\n      setDots(prev => prev.length >= 3 ? \"\" : prev + \".\");\n    }, 500);\n    \n    return () => {\n      clearInterval(messageInterval);\n      clearInterval(dotInterval);\n    };\n  }, []);\n  \n  if (variant === \"breathing-cursor\") {\n    return (\n      <div className=\"flex items-center gap-3 py-2 animate-in fade-in slide-in-from-bottom-2 duration-300\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"flex items-center\">\n            <div className=\"w-1 h-4 bg-gradient-to-b from-primary via-purple-500 to-primary rounded-full animate-pulse\" \n                 style={{ animationDuration: \"1.5s\" }} \n            />\n            <div className=\"w-0.5 h-3 bg-primary/20 ml-0.5 rounded-full opacity-60 animate-pulse\" \n                 style={{ animationDuration: \"1.5s\", animationDelay: \"0.1s\" }} \n            />\n          </div>\n          <span className=\"text-sm font-medium bg-gradient-to-r from-foreground to-foreground/70 bg-clip-text text-transparent\">\n            {currentMessage}\n          </span>\n        </div>\n      </div>\n    );\n  }\n  \n  if (variant === \"bouncing-dots\") {\n    return (\n      <div className=\"flex items-center gap-3 py-2 animate-in fade-in slide-in-from-bottom-2 duration-300\">\n        <div className=\"flex items-center gap-1.5\">\n          {[0, 1, 2].map((i) => (\n            <span\n              key={i}\n              className=\"w-2 h-2 rounded-full bg-gradient-to-br from-primary to-purple-600\"\n              style={{\n                animation: \"bounce 1.4s ease-in-out infinite\",\n                animationDelay: `${i * 0.16}s`,\n              }}\n            />\n          ))}\n        </div>\n        <span className=\"text-sm text-muted-foreground font-medium\">\n          {currentMessage}\n        </span>\n        <style>{`\n          @keyframes bounce {\n            0%, 80%, 100% { transform: translateY(0); opacity: 0.6; }\n            40% { transform: translateY(-8px); opacity: 1; }\n          }\n        `}</style>\n      </div>\n    );\n  }\n  \n  if (variant === \"pulse-wave\") {\n    return (\n      <div className=\"flex items-center gap-3 py-2 animate-in fade-in slide-in-from-bottom-2 duration-300\">\n        <div className=\"flex items-center gap-1\">\n          {[0, 1, 2, 3, 4].map((i) => (\n            <div\n              key={i}\n              className=\"w-1 bg-gradient-to-t from-primary to-purple-500 rounded-full\"\n              style={{\n                height: \"12px\",\n                animation: \"wave 1.2s ease-in-out infinite\",\n                animationDelay: `${i * 0.1}s`,\n              }}\n            />\n          ))}\n        </div>\n        <span className=\"text-sm text-muted-foreground font-medium\">\n          {currentMessage}\n        </span>\n        <style>{`\n          @keyframes wave {\n            0%, 100% { height: 12px; opacity: 0.4; }\n            50% { height: 20px; opacity: 1; }\n          }\n        `}</style>\n      </div>\n    );\n  }\n  \n  if (variant === \"typing-cursor\") {\n    return (\n      <div className=\"flex items-center gap-3 py-2 animate-in fade-in slide-in-from-bottom-2 duration-300\">\n        <div className=\"flex items-center gap-0.5\">\n          <span className=\"text-sm font-medium text-muted-foreground\">\n            {currentMessage.split(\"\").map((char, i) => (\n              <span\n                key={i}\n                className=\"inline-block\"\n                style={{\n                  animation: \"typeIn 0.05s ease-in\",\n                  animationDelay: `${i * 0.05}s`,\n                  animationFillMode: \"backwards\",\n                }}\n              >\n                {char}\n              </span>\n            ))}\n          </span>\n          <span className=\"inline-block w-0.5 h-4 bg-primary ml-0.5 animate-pulse\" \n                style={{ animationDuration: \"1s\" }} \n          />\n        </div>\n        <span className=\"text-xs text-muted-foreground/60 font-mono\">{dots}</span>\n        <style>{`\n          @keyframes typeIn {\n            from { opacity: 0; transform: translateY(2px); }\n            to { opacity: 1; transform: translateY(0); }\n          }\n        `}</style>\n      </div>\n    );\n  }\n  \n  return null;\n}\n\nfunction AIIcon({ className, animated = false }: { className?: string; animated?: boolean }) {\n  return (\n    <div className={cn(\"relative\", animated && \"animate-pulse\")}>\n      <Sparkles className={cn(\"text-white\", className)} />\n      {animated && (\n        <div className=\"absolute inset-0 bg-gradient-to-r from-primary/50 to-purple-500/50 rounded-full blur-sm animate-ping\" style={{ animationDuration: \"2s\" }} />\n      )}\n    </div>\n  );\n}\n\nfunction SourcesPanel({ sources }: { sources: Array<{ title: string; url: string; snippet: string }> }) {\n  const [isExpanded, setIsExpanded] = useState(false);\n  \n  if (!sources || sources.length === 0) return null;\n  \n  return (\n    <div className=\"mt-4 pt-4 border-t border-border/50\">\n      <button\n        onClick={() => setIsExpanded(!isExpanded)}\n        className=\"flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors\"\n        data-testid=\"button-toggle-sources\"\n      >\n        <Globe className=\"w-4 h-4\" />\n        <span className=\"font-medium\">{sources.length} source{sources.length !== 1 ? 's' : ''}</span>\n        <ChevronDown className={cn(\"w-4 h-4 transition-transform\", isExpanded && \"rotate-180\")} />\n      </button>\n      \n      {isExpanded && (\n        <div className=\"mt-3 space-y-2 animate-in fade-in slide-in-from-top-2 duration-200\">\n          {sources.map((source, idx) => {\n            let domain = \"\";\n            try {\n              domain = new URL(source.url).hostname.replace(\"www.\", \"\");\n            } catch {\n              domain = source.url;\n            }\n            return (\n              <a\n                key={idx}\n                href={source.url}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"block p-3 rounded-lg bg-muted/30 hover:bg-muted/50 border border-border/50 transition-colors group\"\n                data-testid={`link-source-${idx}`}\n              >\n                <div className=\"flex items-start gap-3\">\n                  <div className=\"w-8 h-8 rounded-full bg-muted flex items-center justify-center flex-shrink-0\">\n                    <Globe className=\"w-4 h-4 text-muted-foreground\" />\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-xs text-muted-foreground\">{domain}</span>\n                      <ExternalLink className=\"w-3 h-3 text-muted-foreground opacity-0 group-hover:opacity-100 transition-opacity\" />\n                    </div>\n                    <p className=\"text-sm font-medium text-foreground truncate mt-0.5\">{source.title}</p>\n                    {source.snippet && (\n                      <p className=\"text-xs text-muted-foreground line-clamp-2 mt-1\">{source.snippet}</p>\n                    )}\n                  </div>\n                </div>\n              </a>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction formatTimestamp(date?: Date): string {\n  if (!date) return \"\";\n  const now = new Date();\n  const diff = now.getTime() - date.getTime();\n  const minutes = Math.floor(diff / 60000);\n  \n  if (minutes < 1) return \"Just now\";\n  if (minutes < 60) return `${minutes}m ago`;\n  \n  const hours = Math.floor(minutes / 60);\n  if (hours < 24) return `${hours}h ago`;\n  \n  return date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });\n}\n\ninterface Conversation {\n  id: number;\n  title: string;\n  isPinned: number;\n  createdAt: string;\n  updatedAt: string;\n}\n\nexport default function Chat() {\n  const { user } = useAuth();\n  const queryClient = useQueryClient();\n  const { toast } = useToast();\n  const [sidebarOpen, setSidebarOpen] = useState(true);\n  const [input, setInput] = useState(\"\");\n  const [messages, setMessages] = useState<Message[]>([]);\n  const [isLoading, setIsLoading] = useState(false);\n  const [isStreaming, setIsStreaming] = useState(false);\n  const [currentConversationId, setCurrentConversationId] = useState<number | null>(null);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [uploadedFile, setUploadedFile] = useState<File | null>(null);\n  const [isAnalyzingFile, setIsAnalyzingFile] = useState(false);\n  const [fileAnalysisProgress, setFileAnalysisProgress] = useState(\"\");\n  const [searchState, setSearchState] = useState<SearchState>({\n    isSearching: false,\n    status: null,\n    query: \"\",\n    results: [],\n  });\n  const [chatError, setChatError] = useState<ChatErrorInfo | null>(null);\n  const [isRetrying, setIsRetrying] = useState(false);\n  const [lastUserMessageForRetry, setLastUserMessageForRetry] = useState<string>(\"\");\n  const messagesEndRef = useRef<HTMLDivElement>(null);\n  const messagesContainerRef = useRef<HTMLDivElement>(null);\n  const lastAssistantMessageRef = useRef<HTMLDivElement>(null);\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const abortControllerRef = useRef<AbortController | null>(null);\n\n  const { data: conversationsData } = useQuery({\n    queryKey: [\"conversations\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/conversations\", { credentials: \"include\" });\n      if (!response.ok) throw new Error(\"Failed to fetch conversations\");\n      return response.json();\n    },\n    enabled: !!user,\n  });\n\n  const conversations = conversationsData?.conversations || [];\n\n  const loadConversation = async (id: number) => {\n    try {\n      const response = await fetch(`/api/conversations/${id}/messages`, {\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        console.error(\"Failed to load conversation\");\n        return;\n      }\n      const data = await response.json();\n      setMessages(data.messages?.map((m: any) => ({ \n        role: m.role, \n        content: m.content,\n        timestamp: m.createdAt ? new Date(m.createdAt) : undefined,\n      })) || []);\n      setCurrentConversationId(id);\n    } catch (error) {\n      console.error(\"Error loading conversation:\", error);\n      setMessages([]);\n    }\n  };\n\n  const createConversationMutation = useMutation({\n    mutationFn: async () => {\n      const response = await fetch(\"/api/conversations\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ title: \"New Chat\" }),\n      });\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"conversations\"] });\n      setCurrentConversationId(data.conversation.id);\n      setMessages([]);\n    },\n  });\n\n  const deleteConversationMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await fetch(`/api/conversations/${id}`, {\n        method: \"DELETE\",\n        credentials: \"include\",\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"conversations\"] });\n      setCurrentConversationId(null);\n      setMessages([]);\n      toast({\n        title: \"Chat deleted\",\n        description: \"The conversation has been removed.\",\n      });\n    },\n  });\n\n  const renameConversationMutation = useMutation({\n    mutationFn: async ({ id, title }: { id: number; title: string }) => {\n      const response = await fetch(`/api/conversations/${id}`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ title }),\n      });\n      if (!response.ok) throw new Error(\"Failed to rename conversation\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"conversations\"] });\n      toast({\n        title: \"Renamed\",\n        description: \"Conversation renamed successfully.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Rename Failed\",\n        description: \"Could not rename conversation. Please try again.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleRename = (id: number, newTitle: string) => {\n    renameConversationMutation.mutate({ id, title: newTitle });\n  };\n\n  // Disable body scroll when chat is active to prevent double scrollbars\n  useEffect(() => {\n    document.body.style.overflow = 'hidden';\n    return () => {\n      document.body.style.overflow = '';\n    };\n  }, []);\n\n  // Auto-resize textarea as user types\n  useEffect(() => {\n    const textarea = textareaRef.current;\n    if (textarea) {\n      textarea.style.height = 'auto';\n      textarea.style.height = `${Math.min(textarea.scrollHeight, 150)}px`;\n    }\n  }, [input]);\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    // Validate file type\n    const validTypes = [\n      'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp',\n      'application/pdf',\n      'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n      'text/plain'\n    ];\n\n    if (!validTypes.includes(file.type)) {\n      alert('Unsupported file type. Please upload an image (JPG, PNG, GIF, WebP), PDF, Word document, or text file.');\n      return;\n    }\n\n    // Validate file size (10MB limit)\n    if (file.size > 10 * 1024 * 1024) {\n      alert('File size must be less than 10MB');\n      return;\n    }\n\n    setUploadedFile(file);\n  };\n\n  const analyzeFile = async (file: File): Promise<string> => {\n    setIsAnalyzingFile(true);\n    \n    const isImage = file.type.startsWith('image/');\n    const isPdf = file.type === 'application/pdf';\n    \n    if (isImage) {\n      setFileAnalysisProgress(\"Analyzing image with AI vision...\");\n    } else if (isPdf) {\n      setFileAnalysisProgress(\"Extracting and analyzing PDF content...\");\n    } else {\n      setFileAnalysisProgress(\"Processing document...\");\n    }\n    \n    try {\n      const formData = new FormData();\n      formData.append('file', file);\n\n      const response = await fetch('/api/analyze-file', {\n        method: 'POST',\n        credentials: 'include',\n        body: formData,\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Failed to analyze file');\n      }\n\n      setFileAnalysisProgress(\"Finalizing analysis...\");\n      const data = await response.json();\n      return data.analysis;\n    } catch (error) {\n      console.error('File analysis error:', error);\n      throw error;\n    } finally {\n      setIsAnalyzingFile(false);\n      setFileAnalysisProgress(\"\");\n    }\n  };\n\n  const stopGeneration = useCallback(() => {\n    if (abortControllerRef.current) {\n      abortControllerRef.current.abort();\n      abortControllerRef.current = null;\n      setIsStreaming(false);\n      setIsLoading(false);\n    }\n  }, []);\n\n  const sendMessage = async (regenerateFromIndex?: number) => {\n    const isRegenerating = regenerateFromIndex !== undefined;\n    \n    if (!isRegenerating && (!input.trim() && !uploadedFile) || isLoading) return;\n\n    let messageContent = isRegenerating ? \"\" : input;\n    let fileAnalysis = \"\";\n    let messagesToSend = [...messages];\n\n    if (isRegenerating) {\n      messagesToSend = messages.slice(0, regenerateFromIndex);\n      const lastUserMessage = messagesToSend.filter(m => m.role === \"user\").pop();\n      if (lastUserMessage) {\n        messageContent = lastUserMessage.content;\n      }\n      setMessages(messagesToSend);\n    } else if (uploadedFile) {\n      try {\n        fileAnalysis = await analyzeFile(uploadedFile);\n        messageContent = `${input}\\n\\n[Attached file: ${uploadedFile.name}]\\n\\n${fileAnalysis}`;\n      } catch (error) {\n        setMessages((prev) => [\n          ...prev,\n          { role: \"assistant\", content: `Error analyzing file: ${error instanceof Error ? error.message : 'Unknown error'}. Please try again.`, timestamp: new Date() },\n        ]);\n        setUploadedFile(null);\n        setIsAnalyzingFile(false);\n        return;\n      }\n    }\n\n    const userMessage: Message = { \n      role: \"user\", \n      content: messageContent, \n      displayContent: uploadedFile ? input : undefined,\n      attachedFile: uploadedFile ? { name: uploadedFile.name, type: uploadedFile.type } : undefined,\n      timestamp: new Date() \n    };\n    \n    if (!isRegenerating) {\n      setMessages((prev) => [...prev, userMessage]);\n      messagesToSend = [...messages, userMessage];\n    }\n    \n    setInput(\"\");\n    setUploadedFile(null);\n    setIsLoading(true);\n    setIsStreaming(false);\n    setChatError(null);\n    setSearchState({ isSearching: false, status: null, query: \"\", results: [] });\n\n    abortControllerRef.current = new AbortController();\n\n    try {\n      const response = await fetch(\"/api/chat\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({\n          messages: messagesToSend,\n          conversationId: currentConversationId,\n        }),\n        signal: abortControllerRef.current.signal,\n      });\n\n      if (!response.ok) throw new Error(\"Failed to get response\");\n\n      const reader = response.body?.getReader();\n      const decoder = new TextDecoder();\n      if (!reader) throw new Error(\"No response stream\");\n\n      let assistantMessage = \"\";\n      let newConvId = currentConversationId;\n      let pendingSources: Array<{ title: string; url: string; snippet: string }> = [];\n      let assistantMessageAdded = false;\n\n      while (true) {\n        const { done, value } = await reader.read();\n        if (done) break;\n\n        const chunk = decoder.decode(value);\n        const lines = chunk.split(\"\\n\");\n\n        for (const line of lines) {\n          if (line.startsWith(\"data: \")) {\n            const data = line.slice(6);\n            if (data === \"[DONE]\") {\n              setSearchState({ isSearching: false, status: null, query: \"\", results: [] });\n              if (newConvId) {\n                queryClient.invalidateQueries({ queryKey: [\"conversations\"] });\n                if (!currentConversationId) {\n                  setCurrentConversationId(newConvId);\n                }\n                setTimeout(() => {\n                  queryClient.invalidateQueries({ queryKey: [\"conversations\"] });\n                }, 2000);\n              }\n              continue;\n            }\n\n            try {\n              const parsed = JSON.parse(data);\n              if (parsed.conversationId && !currentConversationId) {\n                newConvId = parsed.conversationId;\n              }\n              \n              if (parsed.type === \"searching\") {\n                setSearchState({\n                  isSearching: true,\n                  status: parsed.status,\n                  query: parsed.query || \"\",\n                  results: [],\n                });\n              } else if (parsed.type === \"search_complete\") {\n                setSearchState({\n                  isSearching: false,\n                  status: \"complete\",\n                  query: parsed.query || \"\",\n                  results: parsed.results || [],\n                });\n                pendingSources = parsed.results || [];\n              } else if (parsed.type === \"sources\") {\n                pendingSources = parsed.sources || [];\n                if (assistantMessageAdded) {\n                  setMessages((prev) => {\n                    const newMessages = [...prev];\n                    newMessages[newMessages.length - 1] = {\n                      ...newMessages[newMessages.length - 1],\n                      sources: pendingSources,\n                    };\n                    return newMessages;\n                  });\n                }\n              } else if (parsed.content) {\n                if (!assistantMessageAdded) {\n                  setMessages((prev) => [...prev, { role: \"assistant\", content: \"\", timestamp: new Date(), sources: pendingSources.length > 0 ? pendingSources : undefined }]);\n                  assistantMessageAdded = true;\n                  setIsStreaming(true);\n                }\n                assistantMessage += parsed.content;\n                setMessages((prev) => {\n                  const newMessages = [...prev];\n                  newMessages[newMessages.length - 1] = {\n                    role: \"assistant\",\n                    content: assistantMessage,\n                    timestamp: new Date(),\n                    sources: pendingSources.length > 0 ? pendingSources : undefined,\n                  };\n                  return newMessages;\n                });\n              }\n              // Handle structured errors from backend\n              if (parsed.error) {\n                if (typeof parsed.error === 'object') {\n                  setChatError({\n                    code: parsed.error.code || \"UNKNOWN_ERROR\",\n                    message: parsed.error.message || \"Something went wrong.\",\n                    retryable: parsed.error.retryable !== false,\n                    retryAfter: parsed.error.retryAfter,\n                  });\n                  setLastUserMessageForRetry(messageContent);\n                } else {\n                  throw new Error(parsed.error);\n                }\n              }\n            } catch (e) {}\n          }\n        }\n      }\n    } catch (error: any) {\n      if (error.name === 'AbortError') {\n        setSearchState({ isSearching: false, status: null, query: \"\", results: [] });\n        setChatError(null);\n        return;\n      }\n      \n      // Handle network errors\n      if (!navigator.onLine) {\n        setChatError({\n          code: \"NETWORK_ERROR\",\n          message: \"You appear to be offline. Please check your internet connection and try again.\",\n          retryable: true,\n        });\n      } else if (error.message?.includes(\"Failed to fetch\")) {\n        setChatError({\n          code: \"NETWORK_ERROR\", \n          message: \"Unable to connect to the server. Please check your connection and try again.\",\n          retryable: true,\n        });\n      } else {\n        setChatError({\n          code: \"UNKNOWN_ERROR\",\n          message: \"Something went wrong. Please try again.\",\n          retryable: true,\n        });\n      }\n      \n      // Store last message for retry\n      setLastUserMessageForRetry(messageContent);\n    } finally {\n      setIsLoading(false);\n      setIsStreaming(false);\n      setIsRetrying(false);\n      setSearchState({ isSearching: false, status: null, query: \"\", results: [] });\n      abortControllerRef.current = null;\n    }\n  };\n  \n  // Retry the last failed message\n  const handleRetry = useCallback(() => {\n    if (!lastUserMessageForRetry) return;\n    \n    setChatError(null);\n    setIsRetrying(true);\n    \n    // Remove the last user message if it exists (we'll re-add it)\n    setMessages((prev) => {\n      const lastUserIdx = [...prev].reverse().findIndex(m => m.role === \"user\");\n      if (lastUserIdx !== -1) {\n        const actualIdx = prev.length - 1 - lastUserIdx;\n        return prev.slice(0, actualIdx);\n      }\n      return prev;\n    });\n    \n    // Re-send the message\n    setInput(lastUserMessageForRetry);\n    setTimeout(() => {\n      sendMessage();\n    }, 100);\n  }, [lastUserMessageForRetry]);\n\n  const handleFeedback = (index: number, feedback: \"up\" | \"down\") => {\n    setMessages((prev) => {\n      const newMessages = [...prev];\n      newMessages[index] = {\n        ...newMessages[index],\n        feedback: newMessages[index].feedback === feedback ? null : feedback,\n      };\n      return newMessages;\n    });\n  };\n\n  const regenerateResponse = (messageIndex: number) => {\n    if (isLoading) return;\n    sendMessage(messageIndex);\n  };\n\n  const handleKeyPress = (e: React.KeyboardEvent) => {\n    if (e.key === \"Enter\" && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    } else if (e.key === \"Enter\" && (e.ctrlKey || e.metaKey)) {\n      e.preventDefault();\n      sendMessage();\n    } else if (e.key === \"Escape\") {\n      e.preventDefault();\n      if (isStreaming) {\n        stopGeneration();\n      } else if (uploadedFile) {\n        setUploadedFile(null);\n      }\n    }\n  };\n\n  const groupedConversations = () => {\n    const now = new Date();\n    const today: Conversation[] = [];\n    const yesterday: Conversation[] = [];\n    const lastWeek: Conversation[] = [];\n    const older: Conversation[] = [];\n\n    conversations.forEach((conv: Conversation) => {\n      const convDate = new Date(conv.updatedAt);\n      const diffTime = now.getTime() - convDate.getTime();\n      const diffDays = diffTime / (1000 * 3600 * 24);\n\n      if (diffDays < 1) today.push(conv);\n      else if (diffDays < 2) yesterday.push(conv);\n      else if (diffDays < 7) lastWeek.push(conv);\n      else older.push(conv);\n    });\n\n    return { today, yesterday, lastWeek, older };\n  };\n\n  const filtered = conversations.filter((c: Conversation) =>\n    c.title.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  const { today, yesterday, lastWeek, older } = groupedConversations();\n\n  return (\n    <TooltipProvider delayDuration={300}>\n    <div className=\"fixed inset-0 top-16 flex z-40\">\n      {/* Sidebar - ChatGPT Dark Style */}\n      <div\n        className={cn(\n          \"bg-gradient-to-b from-zinc-950 to-zinc-900 border-r border-zinc-800 transition-all duration-300 flex flex-col relative\",\n          sidebarOpen ? \"w-64\" : \"w-0\"\n        )}\n      >\n        {sidebarOpen && (\n          <>\n            {/* Top header with collapse and new chat icons */}\n            <div className=\"flex items-center justify-between p-2 border-b border-zinc-800/50\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"h-9 w-9 rounded-lg hover:bg-zinc-800/50 text-zinc-300\"\n                    onClick={() => setSidebarOpen(false)}\n                    data-testid=\"button-close-sidebar\"\n                  >\n                    <PanelLeft className=\"w-5 h-5\" />\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent side=\"right\">\n                  <p>Close sidebar</p>\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    onClick={() => createConversationMutation.mutate()}\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"h-9 w-9 rounded-lg hover:bg-zinc-800/50 text-zinc-300\"\n                    data-testid=\"button-new-chat-icon\"\n                  >\n                    <SquarePen className=\"w-5 h-5\" />\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent side=\"right\">\n                  <p>New chat</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n\n            {/* New Chat Button */}\n            <div className=\"px-2 pt-2 pb-2\">\n              <Button\n                onClick={() => createConversationMutation.mutate()}\n                variant=\"outline\"\n                className=\"w-full justify-start gap-2 h-10 rounded-lg bg-transparent border-zinc-700 hover:bg-zinc-800/50 text-zinc-100\"\n                data-testid=\"button-new-chat\"\n              >\n                <Plus className=\"w-4 h-4\" />\n                <span className=\"text-sm font-medium\">New chat</span>\n              </Button>\n            </div>\n\n            <div className=\"px-2 pb-2\">\n              <div className=\"relative\">\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-3.5 h-3.5 text-zinc-500\" />\n                <Input\n                  placeholder=\"Search...\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"h-8 pl-9 text-sm rounded-lg bg-zinc-800/50 border-zinc-700 text-zinc-100 placeholder:text-zinc-500 focus-visible:ring-zinc-600\"\n                />\n              </div>\n            </div>\n\n            <div className=\"flex-1 overflow-y-auto px-1\">\n              {searchTerm ? (\n                <div className=\"p-2\">\n                  {filtered.map((conv: Conversation) => (\n                    <ConversationItem\n                      key={conv.id}\n                      conversation={conv}\n                      isActive={currentConversationId === conv.id}\n                      onSelect={() => loadConversation(conv.id)}\n                      onDelete={() => deleteConversationMutation.mutate(conv.id)}\n                      onRename={(newTitle) => handleRename(conv.id, newTitle)}\n                    />\n                  ))}\n                </div>\n              ) : (\n                <>\n                  {today.length > 0 && (\n                    <ConversationGroup\n                      title=\"Today\"\n                      conversations={today}\n                      currentId={currentConversationId}\n                      onSelect={loadConversation}\n                      onDelete={deleteConversationMutation.mutate}\n                      onRename={handleRename}\n                    />\n                  )}\n                  {yesterday.length > 0 && (\n                    <ConversationGroup\n                      title=\"Yesterday\"\n                      conversations={yesterday}\n                      currentId={currentConversationId}\n                      onSelect={loadConversation}\n                      onDelete={deleteConversationMutation.mutate}\n                      onRename={handleRename}\n                    />\n                  )}\n                  {lastWeek.length > 0 && (\n                    <ConversationGroup\n                      title=\"Previous 7 Days\"\n                      conversations={lastWeek}\n                      currentId={currentConversationId}\n                      onSelect={loadConversation}\n                      onDelete={deleteConversationMutation.mutate}\n                      onRename={handleRename}\n                    />\n                  )}\n                  {older.length > 0 && (\n                    <ConversationGroup\n                      title=\"Older\"\n                      conversations={older}\n                      currentId={currentConversationId}\n                      onSelect={loadConversation}\n                      onDelete={deleteConversationMutation.mutate}\n                      onRename={handleRename}\n                    />\n                  )}\n                </>\n              )}\n            </div>\n          </>\n        )}\n      </div>\n\n      {/* Open Sidebar Button - Only when closed */}\n      {!sidebarOpen && (\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              className=\"absolute left-2 top-2 z-50 h-8 w-8 rounded-full hover:bg-zinc-800/50\"\n              onClick={() => setSidebarOpen(true)}\n              data-testid=\"button-open-sidebar\"\n            >\n              <ChevronRight className=\"w-4 h-4\" />\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent side=\"right\">\n            <p>Open sidebar</p>\n          </TooltipContent>\n        </Tooltip>\n      )}\n\n      {/* Main Chat Area */}\n      <div className=\"flex-1 flex flex-col bg-background\">\n        {messages.length === 0 ? (\n          <div className=\"flex-1 flex items-center justify-center p-8\">\n            <div className=\"text-center space-y-8 max-w-4xl w-full px-4\">\n              {/* Icon */}\n              <div className=\"flex justify-center mb-4\">\n                <div className=\"w-16 h-16 rounded-full bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center shadow-lg\">\n                  <Sparkles className=\"w-8 h-8 text-white\" />\n                </div>\n              </div>\n              \n              {/* Heading */}\n              <h1 className=\"text-4xl font-semibold tracking-tight text-foreground\" data-testid=\"text-welcome-heading\">\n                How can I help you today?\n              </h1>\n              \n              {/* Suggestion Cards */}\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 max-w-4xl mx-auto mt-6\">\n                <button\n                  onClick={() => setInput(\"What are the best practices for improving typing speed?\")}\n                  className=\"group p-4 text-left rounded-2xl border border-border bg-gradient-to-br from-blue-500/5 to-transparent hover:from-blue-500/10 hover:border-blue-500/30 transition-all duration-300 hover:scale-[1.02] hover:shadow-lg hover:shadow-blue-500/10\"\n                  data-testid=\"suggestion-typing-speed\"\n                >\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <div className=\"p-1.5 rounded-lg bg-blue-500/10 group-hover:bg-blue-500/20 transition-colors\">\n                      <Zap className=\"w-4 h-4 text-blue-500\" />\n                    </div>\n                  </div>\n                  <div className=\"font-medium text-foreground group-hover:text-blue-400 transition-colors text-sm\">\n                    Improve speed\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    Type faster & accurately\n                  </div>\n                </button>\n                \n                <button\n                  onClick={() => setInput(\"How do I maintain proper typing posture and prevent strain?\")}\n                  className=\"group p-4 text-left rounded-2xl border border-border bg-gradient-to-br from-green-500/5 to-transparent hover:from-green-500/10 hover:border-green-500/30 transition-all duration-300 hover:scale-[1.02] hover:shadow-lg hover:shadow-green-500/10\"\n                  data-testid=\"suggestion-typing-posture\"\n                >\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <div className=\"p-1.5 rounded-lg bg-green-500/10 group-hover:bg-green-500/20 transition-colors\">\n                      <User className=\"w-4 h-4 text-green-500\" />\n                    </div>\n                  </div>\n                  <div className=\"font-medium text-foreground group-hover:text-green-400 transition-colors text-sm\">\n                    Ergonomics\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    Healthy typing habits\n                  </div>\n                </button>\n                \n                <button\n                  onClick={() => setInput(\"What keyboard shortcuts should every programmer know?\")}\n                  className=\"group p-4 text-left rounded-2xl border border-border bg-gradient-to-br from-purple-500/5 to-transparent hover:from-purple-500/10 hover:border-purple-500/30 transition-all duration-300 hover:scale-[1.02] hover:shadow-lg hover:shadow-purple-500/10\"\n                  data-testid=\"suggestion-keyboard-shortcuts\"\n                >\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <div className=\"p-1.5 rounded-lg bg-purple-500/10 group-hover:bg-purple-500/20 transition-colors\">\n                      <Code className=\"w-4 h-4 text-purple-500\" />\n                    </div>\n                  </div>\n                  <div className=\"font-medium text-foreground group-hover:text-purple-400 transition-colors text-sm\">\n                    Shortcuts\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    Essential keyboard tips\n                  </div>\n                </button>\n                \n                <button\n                  onClick={() => setInput(\"How can I practice touch typing effectively?\")}\n                  className=\"group p-4 text-left rounded-2xl border border-border bg-gradient-to-br from-orange-500/5 to-transparent hover:from-orange-500/10 hover:border-orange-500/30 transition-all duration-300 hover:scale-[1.02] hover:shadow-lg hover:shadow-orange-500/10\"\n                  data-testid=\"suggestion-touch-typing\"\n                >\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <div className=\"p-1.5 rounded-lg bg-orange-500/10 group-hover:bg-orange-500/20 transition-colors\">\n                      <BookOpen className=\"w-4 h-4 text-orange-500\" />\n                    </div>\n                  </div>\n                  <div className=\"font-medium text-foreground group-hover:text-orange-400 transition-colors text-sm\">\n                    Touch typing\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    Master typing technique\n                  </div>\n                </button>\n              </div>\n              \n              {/* Capabilities row */}\n              <div className=\"flex flex-wrap items-center justify-center gap-4 mt-8 text-xs text-muted-foreground\">\n                <div className=\"flex items-center gap-1.5\">\n                  <MessageSquare className=\"w-3.5 h-3.5\" />\n                  <span>Chat with AI</span>\n                </div>\n                <div className=\"flex items-center gap-1.5\">\n                  <Search className=\"w-3.5 h-3.5\" />\n                  <span>Web search</span>\n                </div>\n                <div className=\"flex items-center gap-1.5\">\n                  <Paperclip className=\"w-3.5 h-3.5\" />\n                  <span>Analyze files</span>\n                </div>\n                <div className=\"flex items-center gap-1.5\">\n                  <Code className=\"w-3.5 h-3.5\" />\n                  <span>Code help</span>\n                </div>\n              </div>\n            </div>\n          </div>\n        ) : (\n          <div \n            ref={messagesContainerRef}\n            className=\"flex-1 overflow-y-auto\"\n          >\n            <div className=\"w-full\">\n              {messages.map((message, index) => {\n                const isLastAssistant = message.role === \"assistant\" && index === messages.length - 1;\n                return (\n                <div\n                  key={index}\n                  ref={isLastAssistant ? lastAssistantMessageRef : undefined}\n                  className={cn(\n                    \"w-full py-6 px-4 group/message\",\n                    message.role === \"assistant\" ? \"bg-muted/30\" : \"bg-background\"\n                  )}\n                  data-testid={`message-${message.role}-${index}`}\n                >\n                  <div className=\"max-w-3xl mx-auto flex gap-4\">\n                    <Avatar className=\"w-8 h-8 flex-shrink-0 mt-1\">\n                      <AvatarFallback className={cn(\n                        message.role === \"assistant\" \n                          ? \"bg-gradient-to-br from-primary to-purple-600\" \n                          : \"bg-primary/10\"\n                      )}>\n                        {message.role === \"assistant\" ? (\n                          <AIIcon className=\"w-5 h-5\" />\n                        ) : (\n                          <User className=\"w-5 h-5 text-primary\" />\n                        )}\n                      </AvatarFallback>\n                    </Avatar>\n                    <div className=\"flex-1 space-y-2 overflow-hidden\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <span className=\"text-sm font-medium text-foreground\">\n                          {message.role === \"assistant\" ? \"TypeMasterAI\" : \"You\"}\n                        </span>\n                        {message.timestamp && (\n                          <span className=\"text-xs text-muted-foreground flex items-center gap-1\">\n                            <Clock className=\"w-3 h-3\" />\n                            {formatTimestamp(message.timestamp)}\n                          </span>\n                        )}\n                      </div>\n                      {message.role === \"assistant\" ? (\n                        <div className=\"prose prose-sm dark:prose-invert max-w-none\">\n                          <ReactMarkdown \n                            remarkPlugins={[remarkGfm]}\n                            components={{\n                              h1: ({node, ...props}) => <h1 className=\"text-3xl font-bold mt-8 mb-4 bg-gradient-to-r from-primary to-purple-600 bg-clip-text text-transparent\" {...props} />,\n                              h2: ({node, ...props}) => <h2 className=\"text-2xl font-semibold mt-6 mb-3 text-foreground border-l-4 border-primary pl-4\" {...props} />,\n                              h3: ({node, ...props}) => <h3 className=\"text-xl font-semibold mt-5 mb-2 text-foreground\" {...props} />,\n                              p: ({node, ...props}) => <div className=\"leading-7 my-3 text-foreground/90\" {...props} />,\n                              ul: ({node, ...props}) => <ul className=\"my-4 space-y-2 pl-6\" {...props} />,\n                              ol: ({node, ...props}) => <ol className=\"my-4 space-y-2 pl-6 list-decimal\" {...props} />,\n                              li: ({node, ...props}) => (\n                                <li className=\"leading-7 text-foreground/90 pl-2\" {...props} />\n                              ),\n                              a: ({node, href, ...props}) => (\n                                <a \n                                  href={href} \n                                  target=\"_blank\" \n                                  rel=\"noopener noreferrer\"\n                                  className=\"text-primary hover:text-primary/80 underline decoration-primary/30 hover:decoration-primary/60 transition-colors inline-flex items-center gap-1 font-medium\"\n                                  {...props}\n                                />\n                              ),\n                              code: ({node, inline, className, children, ...props}: any) => {\n                                if (inline) {\n                                  return (\n                                    <code \n                                      className=\"bg-muted/60 text-foreground px-1.5 py-0.5 rounded text-sm font-mono border border-border/40\"\n                                      {...props}\n                                    >\n                                      {children}\n                                    </code>\n                                  );\n                                }\n                                const codeString = String(children).replace(/\\n$/, '');\n                                return <CodeBlock language={className}>{codeString}</CodeBlock>;\n                              },\n                              pre: ({node, children, ...props}) => {\n                                return <>{children}</>;\n                              },\n                              blockquote: ({node, children, ...props}) => {\n                                // Extract text content from children for admonition detection\n                                const extractText = (children: any): string => {\n                                  if (typeof children === 'string') return children;\n                                  if (Array.isArray(children)) {\n                                    return children.map(extractText).join('');\n                                  }\n                                  if (children?.props?.children) {\n                                    return extractText(children.props.children);\n                                  }\n                                  return '';\n                                };\n                                \n                                const text = extractText(children).trim().toLowerCase();\n                                \n                                // Check for admonition markers at the START of the blockquote\n                                const notePattern = /^(\\*\\*note:?\\*\\*|â„¹ï¸|ðŸ“˜|\\*\\*info:?\\*\\*|note:|info:)/i;\n                                \n                                if (notePattern.test(text)) {\n                                  return (\n                                    <blockquote className=\"border-l-4 border-blue-500 pl-4 py-3 my-4 bg-blue-500/10 rounded-r-lg text-foreground\" {...props}>\n                                      <div className=\"flex items-start gap-2\">\n                                        <span className=\"text-blue-500 text-lg flex-shrink-0 mt-0.5\">â„¹ï¸</span>\n                                        <div className=\"flex-1\">{children}</div>\n                                      </div>\n                                    </blockquote>\n                                  );\n                                }\n                                \n                                const warningPattern = /^(\\*\\*warning:?\\*\\*|âš ï¸|\\*\\*caution:?\\*\\*|warning:|caution:)/i;\n                                const successPattern = /^(\\*\\*success:?\\*\\*|âœ…|âœ“|\\*\\*done:?\\*\\*|success:|done:)/i;\n                                const dangerPattern = /^(\\*\\*danger:?\\*\\*|âŒ|\\*\\*error:?\\*\\*|\\*\\*critical:?\\*\\*|danger:|error:|critical:)/i;\n                                const tipPattern = /^(\\*\\*tip:?\\*\\*|ðŸ’¡|\\*\\*hint:?\\*\\*|tip:|hint:)/i;\n                                \n                                if (warningPattern.test(text)) {\n                                  return (\n                                    <blockquote className=\"border-l-4 border-yellow-500 pl-4 py-3 my-4 bg-yellow-500/10 rounded-r-lg text-foreground\" {...props}>\n                                      <div className=\"flex items-start gap-2\">\n                                        <span className=\"text-yellow-500 text-lg flex-shrink-0 mt-0.5\">âš ï¸</span>\n                                        <div className=\"flex-1\">{children}</div>\n                                      </div>\n                                    </blockquote>\n                                  );\n                                }\n                                \n                                if (successPattern.test(text)) {\n                                  return (\n                                    <blockquote className=\"border-l-4 border-green-500 pl-4 py-3 my-4 bg-green-500/10 rounded-r-lg text-foreground\" {...props}>\n                                      <div className=\"flex items-start gap-2\">\n                                        <span className=\"text-green-500 text-lg flex-shrink-0 mt-0.5\">âœ…</span>\n                                        <div className=\"flex-1\">{children}</div>\n                                      </div>\n                                    </blockquote>\n                                  );\n                                }\n                                \n                                if (dangerPattern.test(text)) {\n                                  return (\n                                    <blockquote className=\"border-l-4 border-red-500 pl-4 py-3 my-4 bg-red-500/10 rounded-r-lg text-foreground\" {...props}>\n                                      <div className=\"flex items-start gap-2\">\n                                        <span className=\"text-red-500 text-lg flex-shrink-0 mt-0.5\">âŒ</span>\n                                        <div className=\"flex-1\">{children}</div>\n                                      </div>\n                                    </blockquote>\n                                  );\n                                }\n                                \n                                if (tipPattern.test(text)) {\n                                  return (\n                                    <blockquote className=\"border-l-4 border-purple-500 pl-4 py-3 my-4 bg-purple-500/10 rounded-r-lg text-foreground\" {...props}>\n                                      <div className=\"flex items-start gap-2\">\n                                        <span className=\"text-purple-500 text-lg flex-shrink-0 mt-0.5\">ðŸ’¡</span>\n                                        <div className=\"flex-1\">{children}</div>\n                                      </div>\n                                    </blockquote>\n                                  );\n                                }\n                                \n                                // Default blockquote (for sources and general quotes)\n                                return (\n                                  <blockquote className=\"border-l-4 border-primary/50 pl-4 py-3 my-4 bg-primary/5 rounded-r-lg text-foreground/90\" {...props}>\n                                    {children}\n                                  </blockquote>\n                                );\n                              },\n                              strong: ({node, ...props}) => (\n                                <strong className=\"font-semibold text-foreground\" {...props} />\n                              ),\n                              table: ({node, ...props}) => (\n                                <div className=\"my-4 overflow-x-auto\">\n                                  <table className=\"min-w-full border-collapse border border-border/40 rounded-lg overflow-hidden\" {...props} />\n                                </div>\n                              ),\n                              thead: ({node, ...props}) => (\n                                <thead className=\"bg-muted/40\" {...props} />\n                              ),\n                              tbody: ({node, ...props}) => (\n                                <tbody className=\"divide-y divide-border/40\" {...props} />\n                              ),\n                              tr: ({node, ...props}) => (\n                                <tr className=\"hover:bg-muted/20 transition-colors\" {...props} />\n                              ),\n                              th: ({node, ...props}) => (\n                                <th className=\"px-4 py-2 text-left font-semibold text-foreground border-r border-border/40 last:border-r-0\" {...props} />\n                              ),\n                              td: ({node, ...props}) => (\n                                <td className=\"px-4 py-2 text-foreground/90 border-r border-border/40 last:border-r-0\" {...props} />\n                              ),\n                            }}\n                          >\n                            {message.content || \"...\"}\n                          </ReactMarkdown>\n                          {message.sources && message.sources.length > 0 && (\n                            <SourcesPanel sources={message.sources} />\n                          )}\n                        </div>\n                      ) : (\n                        <div>\n                          {message.attachedFile && (\n                            <div className=\"flex items-center gap-2 mb-2 px-3 py-2 bg-primary/10 rounded-lg border border-primary/20 w-fit\">\n                              <FileText className=\"w-4 h-4 text-primary\" />\n                              <span className=\"text-sm font-medium text-primary\">{message.attachedFile.name}</span>\n                            </div>\n                          )}\n                          <p className=\"whitespace-pre-wrap leading-7 text-foreground\">\n                            {message.displayContent || message.content}\n                          </p>\n                        </div>\n                      )}\n                      \n                      {/* Message Actions */}\n                      <div className={cn(\n                        \"flex items-center gap-1 mt-3 pt-2 border-t border-border/30 opacity-0 group-hover/message:opacity-100 transition-opacity\",\n                        message.content && \"opacity-100 sm:opacity-0\"\n                      )}>\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <CopyButton text={message.content} />\n                          </TooltipTrigger>\n                          <TooltipContent side=\"bottom\">\n                            <p>Copy message</p>\n                          </TooltipContent>\n                        </Tooltip>\n                        \n                        {message.role === \"assistant\" && message.content && (\n                          <>\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"icon\"\n                                  className={cn(\n                                    \"h-7 w-7 rounded-md hover:bg-muted\",\n                                    message.feedback === \"up\" && \"text-green-500 bg-green-500/10\"\n                                  )}\n                                  onClick={() => handleFeedback(index, \"up\")}\n                                  data-testid={`button-thumbs-up-${index}`}\n                                >\n                                  <ThumbsUp className=\"w-3.5 h-3.5\" />\n                                </Button>\n                              </TooltipTrigger>\n                              <TooltipContent side=\"bottom\">\n                                <p>Good response</p>\n                              </TooltipContent>\n                            </Tooltip>\n                            \n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"icon\"\n                                  className={cn(\n                                    \"h-7 w-7 rounded-md hover:bg-muted\",\n                                    message.feedback === \"down\" && \"text-red-500 bg-red-500/10\"\n                                  )}\n                                  onClick={() => handleFeedback(index, \"down\")}\n                                  data-testid={`button-thumbs-down-${index}`}\n                                >\n                                  <ThumbsDown className=\"w-3.5 h-3.5\" />\n                                </Button>\n                              </TooltipTrigger>\n                              <TooltipContent side=\"bottom\">\n                                <p>Bad response</p>\n                              </TooltipContent>\n                            </Tooltip>\n                            \n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"icon\"\n                                  className=\"h-7 w-7 rounded-md hover:bg-muted\"\n                                  onClick={() => regenerateResponse(index)}\n                                  disabled={isLoading}\n                                  data-testid={`button-regenerate-${index}`}\n                                >\n                                  <RefreshCw className=\"w-3.5 h-3.5\" />\n                                </Button>\n                              </TooltipTrigger>\n                              <TooltipContent side=\"bottom\">\n                                <p>Regenerate response</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          </>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              );\n              })}\n              \n              {/* Loading / Streaming / Searching indicator */}\n              {(isLoading && !isStreaming) || searchState.isSearching || searchState.status === \"complete\" ? (\n                <div className=\"w-full py-6 px-4 bg-muted/30\">\n                  <div className=\"max-w-3xl mx-auto flex gap-4\">\n                    <Avatar className=\"w-8 h-8 flex-shrink-0 mt-1 animate-pulse\">\n                      <AvatarFallback className=\"bg-gradient-to-br from-primary to-purple-600\">\n                        <AIIcon className=\"w-5 h-5\" animated />\n                      </AvatarFallback>\n                    </Avatar>\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2 mb-1\">\n                        <span className=\"text-sm font-medium text-foreground\">TypeMasterAI</span>\n                      </div>\n                      <TypingIndicator searchState={searchState} />\n                    </div>\n                  </div>\n                </div>\n              ) : null}\n              \n              {/* Error Display with Retry */}\n              {chatError && !isLoading && (\n                <div className=\"w-full py-6 px-4\">\n                  <div className=\"max-w-3xl mx-auto flex gap-4\">\n                    <Avatar className=\"w-8 h-8 flex-shrink-0 mt-1\">\n                      <AvatarFallback className=\"bg-gradient-to-br from-red-500 to-orange-600\">\n                        <AIIcon className=\"w-5 h-5\" />\n                      </AvatarFallback>\n                    </Avatar>\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2 mb-2\">\n                        <span className=\"text-sm font-medium text-foreground\">TypeMasterAI</span>\n                      </div>\n                      <ChatErrorDisplay \n                        error={chatError} \n                        onRetry={handleRetry}\n                        isRetrying={isRetrying}\n                      />\n                    </div>\n                  </div>\n                </div>\n              )}\n              <div ref={messagesEndRef} />\n            </div>\n          </div>\n        )}\n\n        {/* Input Area - Clean & Dynamic */}\n        <div className=\"border-t border-border bg-background\">\n          <div className=\"max-w-2xl mx-auto px-4 py-3\">\n            <input\n              ref={fileInputRef}\n              type=\"file\"\n              accept=\"image/*,.pdf,.doc,.docx,.txt\"\n              onChange={handleFileSelect}\n              className=\"hidden\"\n            />\n            {/* File Analysis Progress */}\n            {isAnalyzingFile && (\n              <div className=\"mb-3 flex items-center gap-3 px-4 py-3 bg-primary/10 border border-primary/20 rounded-xl animate-pulse\">\n                <div className=\"relative\">\n                  <Loader2 className=\"w-5 h-5 text-primary animate-spin\" />\n                </div>\n                <div className=\"flex-1\">\n                  <p className=\"text-sm font-medium text-primary\">{fileAnalysisProgress || \"Processing file...\"}</p>\n                  <p className=\"text-xs text-muted-foreground mt-0.5\">This may take a few seconds</p>\n                </div>\n              </div>\n            )}\n            {/* File Preview - Above input */}\n            {uploadedFile && !isAnalyzingFile && (\n              <div className=\"mb-2\">\n                <div className=\"inline-flex items-center gap-2 px-3 py-1.5 bg-muted/50 rounded-full border border-border text-sm\">\n                  <Paperclip className=\"w-3.5 h-3.5 text-muted-foreground flex-shrink-0\" />\n                  <span className=\"text-foreground truncate max-w-[200px]\">\n                    {uploadedFile.name}\n                  </span>\n                  <button\n                    className=\"text-muted-foreground hover:text-foreground transition-colors\"\n                    onClick={() => setUploadedFile(null)}\n                  >\n                    <span className=\"text-sm\">Ã—</span>\n                  </button>\n                </div>\n              </div>\n            )}\n            {/* Dynamic pill-shaped input container */}\n            <div className={cn(\n              \"relative flex items-end gap-1 rounded-[24px] transition-all duration-300 ease-out\",\n              \"bg-zinc-800/50 border border-zinc-700/50\",\n              \"focus-within:border-primary/40 focus-within:bg-zinc-800/70 focus-within:shadow-lg focus-within:shadow-primary/5\",\n              \"hover:border-zinc-600/50\",\n              input.length > 100 ? \"px-3 py-2.5\" : \"px-2.5 py-2\"\n            )}>\n              {/* Attach button */}\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button\n                    className={cn(\n                      \"flex-shrink-0 p-1.5 rounded-lg transition-all duration-200\",\n                      \"text-zinc-500 hover:text-zinc-300 hover:bg-zinc-700/50\",\n                      (isLoading || isAnalyzingFile) && \"opacity-40 cursor-not-allowed\"\n                    )}\n                    disabled={isLoading || isAnalyzingFile}\n                    onClick={() => fileInputRef.current?.click()}\n                    data-testid=\"button-attach-file\"\n                  >\n                    <Paperclip className=\"w-[18px] h-[18px]\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent side=\"top\">\n                  <p>Attach</p>\n                </TooltipContent>\n              </Tooltip>\n              \n              {/* Dynamic textarea */}\n              <Textarea\n                ref={textareaRef}\n                value={input}\n                onChange={(e) => setInput(e.target.value)}\n                onKeyDown={handleKeyPress}\n                placeholder=\"Ask anything...\"\n                className={cn(\n                  \"flex-1 min-h-[20px] max-h-[120px] resize-none border-0 bg-transparent px-1 py-0 text-sm leading-relaxed\",\n                  \"focus-visible:ring-0 focus-visible:ring-offset-0\",\n                  \"placeholder:text-zinc-500 text-zinc-100\"\n                )}\n                disabled={isLoading}\n                rows={1}\n                data-testid=\"input-chat-message\"\n              />\n              \n              {/* Send/Stop button */}\n              {isStreaming ? (\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <button\n                      onClick={stopGeneration}\n                      className=\"flex-shrink-0 p-1.5 rounded-lg bg-red-500/90 hover:bg-red-500 text-white transition-all duration-200 hover:scale-105\"\n                      data-testid=\"button-stop-generation\"\n                    >\n                      <Square className=\"w-[18px] h-[18px] fill-current\" />\n                    </button>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\">\n                    <p>Stop (Esc)</p>\n                  </TooltipContent>\n                </Tooltip>\n              ) : (\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <button\n                      onClick={() => sendMessage()}\n                      disabled={isLoading || (!input.trim() && !uploadedFile)}\n                      className={cn(\n                        \"flex-shrink-0 p-1.5 rounded-lg transition-all duration-200\",\n                        (input.trim() || uploadedFile) && !isLoading \n                          ? \"bg-primary hover:bg-primary/90 text-primary-foreground hover:scale-105\" \n                          : \"text-zinc-600 cursor-not-allowed\"\n                      )}\n                      data-testid=\"button-send-message\"\n                    >\n                      {isLoading ? (\n                        <Loader2 className=\"w-[18px] h-[18px] animate-spin\" />\n                      ) : (\n                        <Send className=\"w-[18px] h-[18px]\" />\n                      )}\n                    </button>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\">\n                    <p>{isLoading ? 'Sending...' : 'Send (Enter)'}</p>\n                  </TooltipContent>\n                </Tooltip>\n              )}\n            </div>\n            {/* Minimal footer - only shows when typing */}\n            {input.length > 0 && (\n              <div className=\"flex items-center justify-center mt-1.5\">\n                <span className={cn(\n                  \"text-[10px] transition-colors\",\n                  input.length > 4000 ? \"text-red-400\" : \"text-muted-foreground/50\"\n                )}>\n                  {input.length.toLocaleString()}/4000\n                </span>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n    </TooltipProvider>\n  );\n}\n\nfunction ConversationGroup({\n  title,\n  conversations,\n  currentId,\n  onSelect,\n  onDelete,\n  onRename,\n}: {\n  title: string;\n  conversations: Conversation[];\n  currentId: number | null;\n  onSelect: (id: number) => void;\n  onDelete: (id: number) => void;\n  onRename: (id: number, newTitle: string) => void;\n}) {\n  return (\n    <div className=\"mb-3\">\n      <h3 className=\"px-3 py-2 text-xs font-medium text-zinc-500 uppercase tracking-wide\">\n        {title}\n      </h3>\n      <div className=\"space-y-1 px-2\">\n        {conversations.map((conv) => (\n          <ConversationItem\n            key={conv.id}\n            conversation={conv}\n            isActive={currentId === conv.id}\n            onSelect={() => onSelect(conv.id)}\n            onDelete={() => onDelete(conv.id)}\n            onRename={(newTitle) => onRename(conv.id, newTitle)}\n          />\n        ))}\n      </div>\n    </div>\n  );\n}\n\nfunction ConversationItem({\n  conversation,\n  isActive,\n  onSelect,\n  onDelete,\n  onRename,\n}: {\n  conversation: Conversation;\n  isActive: boolean;\n  onSelect: () => void;\n  onDelete: () => void;\n  onRename: (newTitle: string) => void;\n}) {\n  const [isOpen, setIsOpen] = useState(false);\n  const [isEditing, setIsEditing] = useState(false);\n  const [editTitle, setEditTitle] = useState(conversation.title);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  // Sync editTitle with conversation.title when it changes (after successful rename)\n  useEffect(() => {\n    setEditTitle(conversation.title);\n  }, [conversation.title]);\n\n  // Focus input when editing starts\n  useEffect(() => {\n    if (isEditing && inputRef.current) {\n      inputRef.current.focus();\n      inputRef.current.select();\n    }\n  }, [isEditing]);\n\n  const handleSave = () => {\n    if (editTitle.trim() && editTitle !== conversation.title) {\n      onRename(editTitle.trim());\n    } else {\n      setEditTitle(conversation.title);\n    }\n    setIsEditing(false);\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter') {\n      e.preventDefault();\n      handleSave();\n    } else if (e.key === 'Escape') {\n      e.preventDefault();\n      setEditTitle(conversation.title);\n      setIsEditing(false);\n    }\n    // Stop propagation to prevent Radix keyboard navigation\n    e.stopPropagation();\n  };\n\n  return (\n    <div\n      className={cn(\n        \"group relative px-3 py-2.5 rounded-lg cursor-pointer transition-all flex items-center gap-2\",\n        isActive \n          ? \"bg-zinc-800/70 text-zinc-50\" \n          : \"text-zinc-300 hover:bg-zinc-800/40\"\n      )}\n      onClick={isEditing ? undefined : onSelect}\n      data-testid={`conversation-${conversation.id}`}\n    >\n      {isEditing ? (\n        <input\n          ref={inputRef}\n          type=\"text\"\n          value={editTitle}\n          onChange={(e) => setEditTitle(e.target.value)}\n          onBlur={handleSave}\n          onKeyDown={handleKeyDown}\n          onClick={(e) => e.stopPropagation()}\n          onPointerDown={(e) => e.stopPropagation()}\n          className=\"flex-1 text-sm bg-zinc-700 text-zinc-100 px-2 py-1 rounded border border-zinc-600 focus:outline-none focus:ring-1 focus:ring-primary\"\n          data-testid={`input-rename-${conversation.id}`}\n        />\n      ) : (\n        <span className=\"text-sm truncate flex-1 leading-tight\">{conversation.title}</span>\n      )}\n      <div className={cn(\"opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0\", (isOpen || isEditing) && \"opacity-100\")}>\n        <DropdownMenu open={isOpen} onOpenChange={setIsOpen} modal={false}>\n          <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>\n            <Button \n              variant=\"ghost\" \n              size=\"icon\" \n              className=\"h-7 w-7 rounded-md hover:bg-zinc-700 text-zinc-400 hover:text-zinc-100\"\n              data-testid={`button-menu-${conversation.id}`}\n            >\n              <MoreVertical className=\"w-4 h-4\" />\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent \n            align=\"end\" \n            className=\"bg-zinc-800 border-zinc-700 min-w-[160px]\"\n            onClick={(e) => e.stopPropagation()}\n            onCloseAutoFocus={(e) => {\n              // Prevent dropdown from stealing focus when closing\n              // This is the KEY fix for the rename issue\n              if (isEditing) {\n                e.preventDefault();\n                inputRef.current?.focus();\n              }\n            }}\n          >\n            <DropdownMenuItem\n              onSelect={(e) => {\n                // Prevent default close behavior\n                e.preventDefault();\n                setIsEditing(true);\n                setIsOpen(false);\n              }}\n              className=\"text-zinc-300 hover:bg-zinc-700 focus:bg-zinc-700 focus:text-zinc-100 cursor-pointer\"\n              data-testid={`button-rename-${conversation.id}`}\n            >\n              <Pencil className=\"w-4 h-4 mr-2\" />\n              Rename\n            </DropdownMenuItem>\n            <DropdownMenuItem\n              onSelect={() => {\n                onDelete();\n                setIsOpen(false);\n              }}\n              className=\"text-red-400 hover:bg-zinc-700 focus:bg-zinc-700 focus:text-red-300 cursor-pointer\"\n              data-testid={`button-delete-${conversation.id}`}\n            >\n              <Trash2 className=\"w-4 h-4 mr-2\" />\n              Delete\n            </DropdownMenuItem>\n          </DropdownMenuContent>\n        </DropdownMenu>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":84036,"size_tokens":null},"client/src/pages/leaderboard.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Trophy, Medal, Clock, Target, ChevronLeft, ChevronRight, ShieldCheck, User, AlertCircle, RefreshCw, Info, Wifi, WifiOff, Ban, Globe, HelpCircle } from \"lucide-react\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { useQuery, keepPreviousData } from \"@tanstack/react-query\";\nimport { Loader2 } from \"lucide-react\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { SearchableSelect } from \"@/components/searchable-select\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { ErrorBoundary } from \"@/components/error-boundary\";\n\ntype Timeframe = \"all\" | \"daily\" | \"weekly\" | \"monthly\";\n\ninterface LeaderboardEntry {\n  userId: string;\n  username: string;\n  wpm: number;\n  accuracy: number;\n  mode: number;\n  totalTests: number;\n  rank: number | string;\n  avatarColor?: string;\n  isVerified?: boolean;\n  createdAt?: string;\n}\n\ninterface ErrorState {\n  type: \"network\" | \"rate_limit\" | \"auth\" | \"server\" | \"timeout\" | \"unknown\";\n  message: string;\n  retryable: boolean;\n}\n\nconst TIMEFRAME_TOOLTIPS: Record<Timeframe, string> = {\n  all: \"Rankings based on all-time best scores since the beginning\",\n  daily: \"Rankings based on best scores from today (resets at midnight)\",\n  weekly: \"Rankings based on best scores from this week (resets Sunday)\",\n  monthly: \"Rankings based on best scores from this month (resets on the 1st)\",\n};\n\nconst MEDAL_TOOLTIPS: Record<number, { label: string; description: string }> = {\n  1: { label: \"Gold Medal\", description: \"1st Place - Top performer!\" },\n  2: { label: \"Silver Medal\", description: \"2nd Place - Outstanding!\" },\n  3: { label: \"Bronze Medal\", description: \"3rd Place - Excellent work!\" },\n};\n\nfunction classifyError(error: unknown, response?: Response): ErrorState {\n  if (!navigator.onLine) {\n    return {\n      type: \"network\",\n      message: \"You're offline. Please check your internet connection.\",\n      retryable: true,\n    };\n  }\n\n  if (error instanceof Error) {\n    if (error.name === \"AbortError\") {\n      return {\n        type: \"timeout\",\n        message: \"Request timed out. Please try again.\",\n        retryable: true,\n      };\n    }\n    if (error.message.includes(\"NetworkError\") || error.message.includes(\"Failed to fetch\")) {\n      return {\n        type: \"network\",\n        message: \"Network error. Please check your connection and try again.\",\n        retryable: true,\n      };\n    }\n  }\n\n  if (response) {\n    if (response.status === 429) {\n      return {\n        type: \"rate_limit\",\n        message: \"Too many requests. Please wait a moment before trying again.\",\n        retryable: true,\n      };\n    }\n    if (response.status === 401 || response.status === 419) {\n      return {\n        type: \"auth\",\n        message: \"Session expired. Please refresh the page or log in again.\",\n        retryable: false,\n      };\n    }\n    if (response.status >= 500) {\n      return {\n        type: \"server\",\n        message: \"Server error. Our team has been notified. Please try again later.\",\n        retryable: true,\n      };\n    }\n  }\n\n  return {\n    type: \"unknown\",\n    message: error instanceof Error ? error.message : \"An unexpected error occurred.\",\n    retryable: true,\n  };\n}\n\nfunction getErrorIcon(type: ErrorState[\"type\"]) {\n  switch (type) {\n    case \"network\":\n      return <WifiOff className=\"w-12 h-12 text-orange-500 mb-4\" />;\n    case \"rate_limit\":\n      return <Ban className=\"w-12 h-12 text-yellow-500 mb-4\" />;\n    case \"timeout\":\n      return <Clock className=\"w-12 h-12 text-blue-500 mb-4\" />;\n    default:\n      return <AlertCircle className=\"w-12 h-12 text-destructive mb-4\" />;\n  }\n}\n\nfunction safeNumber(value: unknown, defaultValue: number = 0): number {\n  if (typeof value === \"number\" && !isNaN(value) && isFinite(value)) {\n    return value;\n  }\n  const parsed = parseFloat(String(value));\n  return isNaN(parsed) || !isFinite(parsed) ? defaultValue : parsed;\n}\n\nfunction safeString(value: unknown, defaultValue: string = \"Unknown\"): string {\n  if (typeof value === \"string\" && value.trim().length > 0) {\n    return value;\n  }\n  return defaultValue;\n}\n\nclass LeaderboardError extends Error {\n  constructor(\n    message: string,\n    public readonly errorType: ErrorState[\"type\"],\n    public readonly retryable: boolean\n  ) {\n    super(message);\n    this.name = \"LeaderboardError\";\n  }\n}\n\nconst LANGUAGE_NAMES: Record<string, string> = {\n  en: \"English\",\n  es: \"Spanish\",\n  fr: \"French\",\n  de: \"German\",\n  it: \"Italian\",\n  pt: \"Portuguese\",\n  ja: \"Japanese\",\n  zh: \"Chinese\",\n  hi: \"Hindi\",\n  ru: \"Russian\",\n  ar: \"Arabic\",\n  ko: \"Korean\",\n  mr: \"Marathi\",\n  bn: \"Bengali\",\n  ta: \"Tamil\",\n  te: \"Telugu\",\n  vi: \"Vietnamese\",\n  tr: \"Turkish\",\n  pl: \"Polish\",\n  nl: \"Dutch\",\n  sv: \"Swedish\",\n  th: \"Thai\",\n  id: \"Indonesian\",\n};\n\nconst VALID_LANGUAGES = Object.keys(LANGUAGE_NAMES);\n\nconst LANGUAGE_DESCRIPTIONS: Record<string, string> = {\n  en: \"Most popular - Global competitive leaderboard\",\n  es: \"Second most popular - Large Spanish-speaking community\",\n  fr: \"Active French typing community\",\n  de: \"German language typing excellence\",\n  it: \"Italian keyboard mastery\",\n  pt: \"Portuguese (Brazil & Portugal)\",\n  ja: \"Japanese (Hiragana, Katakana, Kanji)\",\n  zh: \"Chinese (Simplified & Traditional)\",\n  hi: \"Hindi - Devanagari script\",\n  ru: \"Russian - Cyrillic script\",\n  ar: \"Arabic - Right-to-left script\",\n  ko: \"Korean - Hangul script\",\n  mr: \"Marathi - Devanagari script\",\n  bn: \"Bengali - Bengali script\",\n  ta: \"Tamil - Tamil script\",\n  te: \"Telugu - Telugu script\",\n  vi: \"Vietnamese with diacritics\",\n  tr: \"Turkish language typing\",\n  pl: \"Polish language typing\",\n  nl: \"Dutch language typing\",\n  sv: \"Swedish language typing\",\n  th: \"Thai script typing\",\n  id: \"Indonesian language typing\",\n};\n\nfunction LeaderboardContent() {\n  const [timeframe, setTimeframe] = useState<Timeframe>(\"all\");\n  const [offset, setOffset] = useState(0);\n  const [language, setLanguage] = useState<string>(\"en\");\n  const [isOnline, setIsOnline] = useState(navigator.onLine);\n  const limit = 15;\n\n  useEffect(() => {\n    const handleOnline = () => setIsOnline(true);\n    const handleOffline = () => setIsOnline(false);\n    \n    window.addEventListener(\"online\", handleOnline);\n    window.addEventListener(\"offline\", handleOffline);\n    \n    return () => {\n      window.removeEventListener(\"online\", handleOnline);\n      window.removeEventListener(\"offline\", handleOffline);\n    };\n  }, []);\n\n  const { data, isLoading, isFetching, isError, error, refetch } = useQuery({\n    queryKey: [\"leaderboard\", timeframe, offset, limit, language],\n    queryFn: async ({ signal }) => {\n      const timeoutSignal = AbortSignal.timeout(15000);\n      const combinedController = new AbortController();\n      \n      const abortHandler = () => combinedController.abort();\n      signal.addEventListener(\"abort\", abortHandler);\n      timeoutSignal.addEventListener(\"abort\", abortHandler);\n      \n      try {\n        const response = await fetch(\n          `/api/leaderboard?limit=${limit}&offset=${offset}&timeframe=${timeframe}&language=${language}`,\n          { signal: combinedController.signal }\n        );\n        \n        if (!response.ok) {\n          const errorData = await response.json().catch(() => ({}));\n          const classified = classifyError(new Error(errorData.message || \"Request failed\"), response);\n          throw new LeaderboardError(classified.message, classified.type, classified.retryable);\n        }\n        \n        return response.json();\n      } catch (err) {\n        if (err instanceof Error && err.name === \"AbortError\") {\n          if (timeoutSignal.aborted) {\n            throw new LeaderboardError(\"Request timed out. Please try again.\", \"timeout\", true);\n          }\n          throw err;\n        }\n        if (err instanceof LeaderboardError) throw err;\n        const classified = classifyError(err);\n        throw new LeaderboardError(classified.message, classified.type, classified.retryable);\n      } finally {\n        signal.removeEventListener(\"abort\", abortHandler);\n        timeoutSignal.removeEventListener(\"abort\", abortHandler);\n      }\n    },\n    placeholderData: keepPreviousData,\n    staleTime: 30000,\n    retry: (failureCount, err) => {\n      if (err instanceof Error && err.name === \"AbortError\") return false;\n      if (err instanceof LeaderboardError && err.errorType === \"auth\") return false;\n      if (err instanceof LeaderboardError && err.errorType === \"timeout\") return false;\n      if (err instanceof LeaderboardError && !err.retryable) return false;\n      return failureCount < 2;\n    },\n    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 10000),\n  });\n\n  useEffect(() => {\n    if (data?.pagination && offset >= data.pagination.total && offset > 0 && data.pagination.total > 0) {\n      const newOffset = Math.max(0, Math.floor((data.pagination.total - 1) / limit) * limit);\n      if (newOffset !== offset) {\n        setOffset(newOffset);\n      }\n    }\n  }, [data?.pagination, offset, limit]);\n\n  const errorState: ErrorState | null = error instanceof LeaderboardError \n    ? { type: error.errorType, message: error.message, retryable: error.retryable }\n    : error instanceof Error \n      ? classifyError(error)\n      : null;\n\n  const { data: userData } = useQuery({\n    queryKey: [\"currentUser\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/auth/me\");\n      if (!response.ok) return null;\n      return response.json();\n    },\n    retry: false,\n    staleTime: 60000,\n  });\n\n  const { data: aroundMeData, isLoading: aroundMeLoading } = useQuery({\n    queryKey: [\"leaderboard-around-me\", timeframe, language],\n    queryFn: async () => {\n      try {\n        const response = await fetch(`/api/leaderboard/around-me?range=3&timeframe=${timeframe}&language=${language}`);\n        if (!response.ok) return null;\n        return response.json();\n      } catch {\n        return null;\n      }\n    },\n    enabled: !!userData?.user,\n    staleTime: 30000,\n    retry: 1,\n  });\n\n  const entries: LeaderboardEntry[] = data?.entries || [];\n  const pagination = data?.pagination || { total: 0, hasMore: false };\n  const currentPage = Math.floor(offset / limit) + 1;\n  const totalPages = Math.max(1, Math.ceil(pagination.total / limit));\n  const safeCurrentPage = Math.min(currentPage, totalPages);\n\n  const handleTimeframeChange = (value: string) => {\n    setTimeframe(value as Timeframe);\n    setOffset(0);\n  };\n\n  const handleLanguageChange = (value: string) => {\n    // Validate language code\n    if (!VALID_LANGUAGES.includes(value)) {\n      console.error(`Invalid language code: ${value}. Defaulting to English.`);\n      setLanguage(\"en\");\n      setOffset(0);\n      return;\n    }\n    \n    // Prevent rapid switching (debounce)\n    setLanguage(value);\n    setOffset(0);\n  };\n\n  const handlePrevPage = () => {\n    setOffset(Math.max(0, offset - limit));\n  };\n\n  const handleNextPage = () => {\n    if (pagination.hasMore && offset + limit < pagination.total) {\n      setOffset(offset + limit);\n    }\n  };\n\n  const formatTestMode = (seconds: number) => {\n    const safeSeconds = safeNumber(seconds, 60);\n    if (safeSeconds < 60) return `${safeSeconds}s`;\n    const minutes = Math.floor(safeSeconds / 60);\n    const remainingSeconds = safeSeconds % 60;\n    return remainingSeconds > 0 ? `${minutes}m ${remainingSeconds}s` : `${minutes}m`;\n  };\n\n  const getTimeframeLabel = (tf: Timeframe) => {\n    switch (tf) {\n      case \"daily\": return \"Today\";\n      case \"weekly\": return \"This Week\";\n      case \"monthly\": return \"This Month\";\n      default: return \"All Time\";\n    }\n  };\n\n  const getEmptyStateMessage = (tf: Timeframe, lang: string) => {\n    const langName = LANGUAGE_NAMES[lang] || \"this language\";\n    const timeLabel = tf === \"all\" ? \"yet\" : tf === \"daily\" ? \"today\" : tf === \"weekly\" ? \"this week\" : \"this month\";\n    \n    switch (tf) {\n      case \"daily\":\n        return { \n          title: `No ${langName} tests completed today`, \n          subtitle: `Be the first to set a ${langName} record today!` \n        };\n      case \"weekly\":\n        return { \n          title: `No ${langName} tests completed this week`, \n          subtitle: `Start the week strong with a ${langName} record!` \n        };\n      case \"monthly\":\n        return { \n          title: `No ${langName} tests completed this month`, \n          subtitle: `Be the first on the monthly ${langName} leaderboard!` \n        };\n      default:\n        return { \n          title: `No ${langName} test results yet`, \n          subtitle: `Complete a ${langName} typing test to appear on this leaderboard!` \n        };\n    }\n  };\n\n  return (\n    <TooltipProvider delayDuration={300}>\n      <div className=\"max-w-5xl mx-auto px-4 sm:px-0\">\n        {!isOnline && (\n          <div className=\"mb-4 p-3 bg-orange-500/10 border border-orange-500/30 rounded-lg flex items-center gap-2 text-orange-500\">\n            <WifiOff className=\"w-4 h-4\" />\n            <span className=\"text-sm\">You're offline. Some features may not work.</span>\n          </div>\n        )}\n\n        <div className=\"flex flex-col items-center gap-3 sm:gap-4 mb-6 sm:mb-10\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <div className=\"p-2.5 sm:p-3 rounded-full bg-primary/10 text-primary cursor-help\">\n                <Trophy className=\"w-6 h-6 sm:w-8 sm:h-8\" />\n              </div>\n            </TooltipTrigger>\n            <TooltipContent side=\"bottom\" className=\"max-w-xs\">\n              <p className=\"font-medium\">Global Leaderboard</p>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Compare your typing speed with players worldwide. Rankings are based on your best WPM score.\n              </p>\n            </TooltipContent>\n          </Tooltip>\n          <h1 className=\"text-2xl sm:text-3xl font-bold\">Global Leaderboard</h1>\n          <p className=\"text-sm sm:text-base text-muted-foreground\">Top typists worldwide</p>\n        </div>\n\n        <div className=\"mb-6 flex flex-col gap-4\">\n          <div className=\"flex flex-col sm:flex-row items-center justify-between gap-4\">\n            <Tabs value={timeframe} onValueChange={handleTimeframeChange} className=\"w-full sm:w-auto\">\n              <TabsList className=\"grid grid-cols-4 w-full sm:w-auto\" data-testid=\"timeframe-tabs\">\n                {([\"all\", \"daily\", \"weekly\", \"monthly\"] as Timeframe[]).map((tf) => (\n                  <Tooltip key={tf}>\n                    <TooltipTrigger asChild>\n                      <TabsTrigger value={tf} data-testid={`tab-${tf}`}>\n                        {tf === \"all\" ? \"All Time\" : tf.charAt(0).toUpperCase() + tf.slice(1)}\n                      </TabsTrigger>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\">\n                      <p>{TIMEFRAME_TOOLTIPS[tf]}</p>\n                    </TooltipContent>\n                  </Tooltip>\n                ))}\n              </TabsList>\n            </Tabs>\n\n            {userData?.user && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"flex items-center gap-2 text-sm text-muted-foreground cursor-help\">\n                    <User className=\"w-4 h-4\" />\n                    {aroundMeLoading ? (\n                      <Loader2 className=\"w-4 h-4 animate-spin\" />\n                    ) : aroundMeData?.userRank && aroundMeData.userRank > 0 ? (\n                      <span>Your rank: <strong className=\"text-foreground\">#{aroundMeData.userRank}</strong></span>\n                    ) : (\n                      <span className=\"text-muted-foreground\">Not ranked in {getTimeframeLabel(timeframe).toLowerCase()}</span>\n                    )}\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Your position in the {getTimeframeLabel(timeframe).toLowerCase()} leaderboard</p>\n                </TooltipContent>\n              </Tooltip>\n            )}\n          </div>\n\n          <div className=\"flex items-center gap-2 flex-wrap\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div className=\"flex items-center gap-2\">\n                  <Globe className=\"w-4 h-4 text-muted-foreground\" />\n                  <SearchableSelect\n                    value={language}\n                    onValueChange={handleLanguageChange}\n                    options={VALID_LANGUAGES.map((code) => ({\n                      value: code,\n                      label: LANGUAGE_NAMES[code],\n                    }))}\n                    placeholder=\"Select language\"\n                    searchPlaceholder=\"Search languages...\"\n                    emptyText=\"No language found.\"\n                    icon={<Globe className=\"w-4 h-4\" />}\n                    triggerClassName=\"w-[200px]\"\n                    contentClassName=\"max-h-[300px] overflow-y-auto\"\n                    data-testid=\"language-selector\"\n                  />\n                </div>\n              </TooltipTrigger>\n              <TooltipContent className=\"max-w-sm\" side=\"bottom\">\n                <div className=\"space-y-2\">\n                  <p className=\"font-medium\">Language Filter</p>\n                  <p className=\"text-xs text-muted-foreground\">\n                    Filter leaderboard by typing language. Only scores from tests typed in the selected language will appear.\n                  </p>\n                  <p className=\"text-xs text-muted-foreground\">\n                    <strong>Current:</strong> {LANGUAGE_NAMES[language]} - {LANGUAGE_DESCRIPTIONS[language]}\n                  </p>\n                  <p className=\"text-xs text-primary\">\n                    ðŸ’¡ Supports 23 languages with search functionality\n                  </p>\n                </div>\n              </TooltipContent>\n            </Tooltip>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <button \n                  type=\"button\" \n                  className=\"text-muted-foreground/60 hover:text-muted-foreground transition-colors\" \n                  aria-label=\"Language help\"\n                  data-testid=\"language-help-button\"\n                >\n                  <HelpCircle className=\"w-3.5 h-3.5\" />\n                </button>\n              </TooltipTrigger>\n              <TooltipContent side=\"bottom\" className=\"max-w-xs\">\n                <div className=\"space-y-2\">\n                  <p className=\"font-medium\">How Language Filtering Works</p>\n                  <ul className=\"text-xs text-muted-foreground space-y-1 list-disc list-inside\">\n                    <li>Rankings are separate per language</li>\n                    <li>Freestyle scores never count in rankings</li>\n                    <li>Use search to quickly find your language</li>\n                    <li>Changing language resets pagination</li>\n                    <li>Your rank updates automatically</li>\n                  </ul>\n                </div>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n        </div>\n\n        {userData?.user && aroundMeData?.entries?.length > 0 && aroundMeData.userRank > 0 && (\n          <Card className=\"border-primary/30 bg-primary/5 mb-6\">\n            <CardContent className=\"p-4\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"text-sm font-medium text-primary mb-3 flex items-center gap-2 cursor-help\">\n                    <User className=\"w-4 h-4\" />\n                    Your Position\n                    <Info className=\"w-3 h-3 opacity-50\" />\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Shows players ranked near you for the {getTimeframeLabel(timeframe).toLowerCase()} period</p>\n                </TooltipContent>\n              </Tooltip>\n              <div className=\"space-y-2\">\n                {aroundMeData.entries.map((entry: LeaderboardEntry) => (\n                  <div \n                    key={`around-${entry.rank}-${entry.userId}`} \n                    className={`flex items-center justify-between p-2 rounded ${entry.userId === userData.user.id ? 'bg-primary/20 font-medium' : 'bg-background/50'}`}\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      <span className=\"font-mono text-sm w-8\">#{safeNumber(entry.rank)}</span>\n                      <span>{safeString(entry.username)}</span>\n                      {entry.isVerified && (\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <ShieldCheck className=\"w-4 h-4 text-green-500 cursor-help\" />\n                          </TooltipTrigger>\n                          <TooltipContent>\n                            <p>Verified score - passed anti-cheat challenge</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      )}\n                    </div>\n                    <span className=\"font-mono text-primary\">{safeNumber(entry.wpm)} WPM</span>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        <Card className=\"border-border/50 bg-card/50 backdrop-blur-sm\">\n          <CardContent className=\"p-0\">\n            {isError || errorState ? (\n              <div className=\"flex flex-col items-center justify-center py-12 text-center px-4\">\n                {getErrorIcon(errorState?.type || \"unknown\")}\n                <p className=\"text-lg font-medium text-foreground mb-2\">\n                  {errorState?.type === \"network\" ? \"Connection Lost\" :\n                   errorState?.type === \"rate_limit\" ? \"Slow Down\" :\n                   errorState?.type === \"timeout\" ? \"Request Timed Out\" :\n                   \"Failed to load leaderboard\"}\n                </p>\n                <p className=\"text-sm text-muted-foreground mb-4 max-w-md\">\n                  {errorState?.message || (error instanceof Error ? error.message : \"An unexpected error occurred\")}\n                </p>\n                {(errorState?.retryable !== false) && (\n                  <Button \n                    variant=\"outline\" \n                    onClick={() => refetch()}\n                    disabled={isFetching}\n                    data-testid=\"retry-button\"\n                  >\n                    <RefreshCw className={`w-4 h-4 mr-2 ${isFetching ? 'animate-spin' : ''}`} />\n                    Try Again\n                  </Button>\n                )}\n                {errorState?.type === \"auth\" && (\n                  <Button \n                    variant=\"default\" \n                    onClick={() => window.location.reload()}\n                    className=\"mt-2\"\n                  >\n                    Refresh Page\n                  </Button>\n                )}\n              </div>\n            ) : isLoading ? (\n              <div className=\"flex flex-col items-center justify-center py-12\">\n                <Loader2 className=\"w-8 h-8 animate-spin text-muted-foreground mb-2\" />\n                <p className=\"text-sm text-muted-foreground\">Loading leaderboard...</p>\n              </div>\n            ) : entries.length === 0 ? (\n              <div className=\"text-center py-12 text-muted-foreground\">\n                <Trophy className=\"w-12 h-12 mx-auto mb-4 opacity-30\" />\n                <p className=\"text-lg font-medium\">{getEmptyStateMessage(timeframe, language).title}</p>\n                <p className=\"text-sm mt-2\">{getEmptyStateMessage(timeframe, language).subtitle}</p>\n                <div className=\"mt-4 text-xs\">\n                  <p className=\"text-muted-foreground/70\">\n                    Selected language: <strong className=\"text-foreground\">{LANGUAGE_NAMES[language]}</strong>\n                  </p>\n                  {language !== \"en\" && (\n                    <p className=\"text-muted-foreground/70 mt-1\">\n                      Try switching to English for more results\n                    </p>\n                  )}\n                </div>\n              </div>\n            ) : (\n              <>\n                <div className=\"divide-y divide-border/50\">\n                  <div className=\"grid grid-cols-12 gap-4 p-4 bg-muted/30 text-xs font-medium text-muted-foreground uppercase tracking-wider\">\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <div className=\"col-span-1 text-center cursor-help\">#</div>\n                      </TooltipTrigger>\n                      <TooltipContent><p>Rank position based on best WPM</p></TooltipContent>\n                    </Tooltip>\n                    <div className=\"col-span-4\">User</div>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <div className=\"col-span-2 text-center cursor-help\">WPM</div>\n                      </TooltipTrigger>\n                      <TooltipContent><p>Words Per Minute - typing speed</p></TooltipContent>\n                    </Tooltip>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <div className=\"col-span-2 text-center cursor-help\">Accuracy</div>\n                      </TooltipTrigger>\n                      <TooltipContent><p>Percentage of correctly typed characters</p></TooltipContent>\n                    </Tooltip>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <div className=\"col-span-2 text-center cursor-help\">Test Mode</div>\n                      </TooltipTrigger>\n                      <TooltipContent><p>Duration of the typing test</p></TooltipContent>\n                    </Tooltip>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <div className=\"col-span-1 text-center cursor-help\">Tests</div>\n                      </TooltipTrigger>\n                      <TooltipContent><p>Total number of tests completed</p></TooltipContent>\n                    </Tooltip>\n                  </div>\n\n                  {entries.map((entry: LeaderboardEntry) => {\n                    const rank = safeNumber(entry.rank, 999);\n                    const isCurrentUser = userData?.user?.id === entry.userId;\n                    const username = safeString(entry.username);\n                    const wpm = safeNumber(entry.wpm);\n                    const accuracy = safeNumber(entry.accuracy);\n                    const totalTests = safeNumber(entry.totalTests, 1);\n                    \n                    return (\n                      <div \n                        key={`${entry.userId}-${entry.createdAt || rank}`} \n                        className={`grid grid-cols-12 gap-4 p-4 items-center hover:bg-muted/30 transition-colors ${isCurrentUser ? 'bg-primary/10' : ''}`}\n                      >\n                        <div className=\"col-span-1 flex justify-center\">\n                          {rank <= 3 && MEDAL_TOOLTIPS[rank] ? (\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <div className=\"cursor-help\">\n                                  <Medal \n                                    className={`w-5 h-5 ${\n                                      rank === 1 ? 'text-yellow-500' : \n                                      rank === 2 ? 'text-gray-400' : \n                                      'text-amber-600'\n                                    }`} \n                                    data-testid={`medal-rank-${rank}`} \n                                  />\n                                </div>\n                              </TooltipTrigger>\n                              <TooltipContent>\n                                <p className=\"font-medium\">{MEDAL_TOOLTIPS[rank].label}</p>\n                                <p className=\"text-xs text-muted-foreground\">{MEDAL_TOOLTIPS[rank].description}</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          ) : (\n                            <span className=\"font-mono text-muted-foreground\" data-testid={`rank-${rank}`}>{rank}</span>\n                          )}\n                        </div>\n                        <div className=\"col-span-4 flex items-center gap-3\">\n                          <Avatar className=\"w-9 h-9\">\n                            <AvatarFallback \n                              className={entry.avatarColor || \"bg-primary/20\"} \n                              style={{ color: \"white\" }}\n                            >\n                              {username.charAt(0).toUpperCase()}\n                            </AvatarFallback>\n                          </Avatar>\n                          <div className=\"flex flex-col\">\n                            <div className=\"flex items-center gap-2\">\n                              <span className=\"font-medium truncate max-w-[120px]\" data-testid={`username-${username}`}>\n                                {username}\n                              </span>\n                              {entry.isVerified && (\n                                <Tooltip>\n                                  <TooltipTrigger asChild>\n                                    <ShieldCheck className=\"w-4 h-4 text-green-500 cursor-help flex-shrink-0\" data-testid={`verified-${entry.userId}`} />\n                                  </TooltipTrigger>\n                                  <TooltipContent>\n                                    <p>Verified score - passed anti-cheat challenge</p>\n                                  </TooltipContent>\n                                </Tooltip>\n                              )}\n                            </div>\n                            <span className=\"text-xs text-muted-foreground\">{totalTests} test{totalTests !== 1 ? 's' : ''}</span>\n                          </div>\n                        </div>\n                        <div className=\"col-span-2 text-center\">\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <div className=\"font-mono font-bold text-primary text-lg cursor-help\" data-testid={`wpm-${entry.userId}`}>\n                                {wpm}\n                              </div>\n                            </TooltipTrigger>\n                            <TooltipContent>\n                              <p>{wpm} words per minute</p>\n                            </TooltipContent>\n                          </Tooltip>\n                        </div>\n                        <div className=\"col-span-2 text-center\">\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <div className=\"font-mono text-muted-foreground cursor-help\" data-testid={`accuracy-${entry.userId}`}>\n                                {accuracy.toFixed(1)}%\n                              </div>\n                            </TooltipTrigger>\n                            <TooltipContent>\n                              <p>{accuracy.toFixed(2)}% typing accuracy</p>\n                            </TooltipContent>\n                          </Tooltip>\n                        </div>\n                        <div className=\"col-span-2 text-center\">\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <Badge variant=\"outline\" className=\"gap-1 cursor-help\" data-testid={`mode-${entry.userId}`}>\n                                <Clock className=\"w-3 h-3\" />\n                                {formatTestMode(entry.mode)}\n                              </Badge>\n                            </TooltipTrigger>\n                            <TooltipContent>\n                              <p>Test duration: {formatTestMode(entry.mode)}</p>\n                            </TooltipContent>\n                          </Tooltip>\n                        </div>\n                        <div className=\"col-span-1 text-center\">\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <Badge variant=\"secondary\" className=\"gap-1 cursor-help\" data-testid={`total-tests-${entry.userId}`}>\n                                <Target className=\"w-3 h-3\" />\n                                {totalTests}\n                              </Badge>\n                            </TooltipTrigger>\n                            <TooltipContent>\n                              <p>{totalTests} total test{totalTests !== 1 ? 's' : ''} completed</p>\n                            </TooltipContent>\n                          </Tooltip>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n\n                <div className=\"flex items-center justify-between p-4 border-t border-border/50\">\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div className=\"text-sm text-muted-foreground cursor-help\">\n                        Showing {Math.min(offset + 1, pagination.total)} - {Math.min(offset + entries.length, pagination.total)} of {pagination.total} results\n                        {isFetching && <Loader2 className=\"inline-block ml-2 w-4 h-4 animate-spin\" />}\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>{limit} entries per page</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  <div className=\"flex items-center gap-2\">\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={handlePrevPage}\n                          disabled={offset === 0 || isFetching}\n                          data-testid=\"prev-page\"\n                        >\n                          <ChevronLeft className=\"w-4 h-4 mr-1\" />\n                          Previous\n                        </Button>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p>{offset === 0 ? \"You're on the first page\" : `Go to page ${safeCurrentPage - 1}`}</p>\n                      </TooltipContent>\n                    </Tooltip>\n                    <span className=\"text-sm text-muted-foreground px-2\">\n                      Page {safeCurrentPage} of {totalPages}\n                    </span>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={handleNextPage}\n                          disabled={!pagination.hasMore || offset + limit >= pagination.total || isFetching}\n                          data-testid=\"next-page\"\n                        >\n                          Next\n                          <ChevronRight className=\"w-4 h-4 ml-1\" />\n                        </Button>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p>{!pagination.hasMore || offset + limit >= pagination.total ? \"You're on the last page\" : `Go to page ${safeCurrentPage + 1}`}</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                </div>\n              </>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </TooltipProvider>\n  );\n}\n\nexport default function Leaderboard() {\n  return (\n    <ErrorBoundary>\n      <LeaderboardContent />\n    </ErrorBoundary>\n  );\n}\n","path":null,"size_bytes":35837,"size_tokens":null},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, serial, integer, timestamp, real, index, jsonb, boolean, bigint } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  username: text(\"username\").notNull().unique(),\n  email: text(\"email\").notNull().unique(),\n  password: text(\"password\"),\n  emailVerified: boolean(\"email_verified\").default(false).notNull(),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  avatarColor: text(\"avatar_color\").default(\"bg-primary\"),\n  bio: text(\"bio\"),\n  country: text(\"country\"),\n  keyboardLayout: text(\"keyboard_layout\").default(\"QWERTY\"),\n  timezone: varchar(\"timezone\", { length: 50 }).default(\"UTC\").notNull(),\n  currentStreak: integer(\"current_streak\").default(0).notNull(),\n  bestStreak: integer(\"best_streak\").default(0).notNull(),\n  lastTestDate: timestamp(\"last_test_date\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n});\n\nconst passwordSchema = z.string()\n  .min(8, \"Password must be at least 8 characters\")\n  .max(100, \"Password must be less than 100 characters\")\n  .regex(/[A-Z]/, \"Password must contain at least one uppercase letter\")\n  .regex(/[a-z]/, \"Password must contain at least one lowercase letter\")\n  .regex(/[0-9]/, \"Password must contain at least one number\")\n  .regex(/[^A-Za-z0-9]/, \"Password must contain at least one special character\");\n\nexport const insertUserSchema = createInsertSchema(users, {\n  username: z.string().min(3, \"Username must be at least 3 characters\").max(30, \"Username must be less than 30 characters\").regex(/^[a-zA-Z0-9_]+$/, \"Username can only contain letters, numbers, and underscores\"),\n  email: z.string().email(\"Invalid email address\"),\n  password: passwordSchema.nullable().optional(),\n}).omit({ id: true, createdAt: true });\n\nexport { passwordSchema };\n\nexport const loginSchema = z.object({\n  email: z.string().email(\"Invalid email address\"),\n  password: z.string().min(1, \"Password is required\"),\n  twoFactorCode: z.string().optional(),\n});\n\nexport const updateProfileSchema = z.object({\n  avatarColor: z.string().optional(),\n  bio: z.string().max(200, \"Bio must be less than 200 characters\").optional(),\n  country: z.string().optional(),\n  keyboardLayout: z.string().optional(),\n});\n\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type User = typeof users.$inferSelect;\nexport type LoginCredentials = z.infer<typeof loginSchema>;\nexport type UpdateProfile = z.infer<typeof updateProfileSchema>;\n\n// Authentication Security Tables\nexport const loginHistory = pgTable(\"login_history\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }),\n  email: text(\"email\").notNull(),\n  ipAddress: varchar(\"ip_address\", { length: 45 }),\n  userAgent: text(\"user_agent\"),\n  deviceFingerprint: varchar(\"device_fingerprint\", { length: 64 }),\n  city: varchar(\"city\", { length: 100 }),\n  country: varchar(\"country\", { length: 100 }),\n  countryCode: varchar(\"country_code\", { length: 2 }),\n  latitude: real(\"latitude\"),\n  longitude: real(\"longitude\"),\n  success: boolean(\"success\").notNull(),\n  failureReason: varchar(\"failure_reason\", { length: 200 }),\n  isSuspicious: boolean(\"is_suspicious\").default(false).notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"login_history_user_id_idx\").on(table.userId),\n  emailIdx: index(\"login_history_email_idx\").on(table.email),\n  createdAtIdx: index(\"login_history_created_at_idx\").on(table.createdAt),\n}));\n\nexport const accountLockouts = pgTable(\"account_lockouts\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  failedAttempts: integer(\"failed_attempts\").default(0).notNull(),\n  lockedUntil: timestamp(\"locked_until\"),\n  lastFailedAt: timestamp(\"last_failed_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"account_lockouts_user_id_idx\").on(table.userId),\n}));\n\nexport const emailVerificationTokens = pgTable(\"email_verification_tokens\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().unique().references(() => users.id, { onDelete: \"cascade\" }),\n  token: varchar(\"token\", { length: 64 }).notNull().unique(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  verified: boolean(\"verified\").default(false).notNull(),\n  verifiedAt: timestamp(\"verified_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  tokenIdx: index(\"email_verification_tokens_token_idx\").on(table.token),\n}));\n\nexport const passwordResetTokens = pgTable(\"password_reset_tokens\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  token: varchar(\"token\", { length: 64 }),\n  tokenHash: varchar(\"token_hash\", { length: 64 }).notNull().unique(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  used: boolean(\"used\").default(false).notNull(),\n  usedAt: timestamp(\"used_at\"),\n  ipAddress: varchar(\"ip_address\", { length: 45 }),\n  failedAttempts: integer(\"failed_attempts\").default(0).notNull(),\n  lockedAt: timestamp(\"locked_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  tokenHashIdx: index(\"password_reset_tokens_token_hash_idx\").on(table.tokenHash),\n  userIdIdx: index(\"password_reset_tokens_user_id_idx\").on(table.userId),\n}));\n\nexport const userSessions = pgTable(\"user_sessions\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  sessionId: varchar(\"session_id\", { length: 128 }).notNull().unique(),\n  deviceName: varchar(\"device_name\", { length: 200 }),\n  deviceType: varchar(\"device_type\", { length: 50 }),\n  browser: varchar(\"browser\", { length: 100 }),\n  browserVersion: varchar(\"browser_version\", { length: 20 }),\n  os: varchar(\"os\", { length: 100 }),\n  osVersion: varchar(\"os_version\", { length: 20 }),\n  ipAddress: varchar(\"ip_address\", { length: 45 }),\n  city: varchar(\"city\", { length: 100 }),\n  country: varchar(\"country\", { length: 100 }),\n  lastActivity: timestamp(\"last_activity\").notNull().defaultNow(),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"user_sessions_user_id_idx\").on(table.userId),\n  sessionIdIdx: index(\"user_sessions_session_id_idx\").on(table.sessionId),\n}));\n\nexport const securitySettings = pgTable(\"security_settings\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().unique().references(() => users.id, { onDelete: \"cascade\" }),\n  twoFactorEnabled: boolean(\"two_factor_enabled\").default(false).notNull(),\n  twoFactorSecret: varchar(\"two_factor_secret\", { length: 32 }),\n  backupCodes: jsonb(\"backup_codes\").$type<string[]>(),\n  suspiciousLoginAlerts: boolean(\"suspicious_login_alerts\").default(true).notNull(),\n  newDeviceAlerts: boolean(\"new_device_alerts\").default(true).notNull(),\n  passwordChangedAt: timestamp(\"password_changed_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n});\n\nexport const insertLoginHistorySchema = createInsertSchema(loginHistory).omit({ id: true, createdAt: true });\nexport const insertAccountLockoutSchema = createInsertSchema(accountLockouts).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertEmailVerificationTokenSchema = createInsertSchema(emailVerificationTokens).omit({ id: true, createdAt: true });\nexport const insertPasswordResetTokenSchema = createInsertSchema(passwordResetTokens).omit({ id: true, createdAt: true });\nexport const insertUserSessionSchema = createInsertSchema(userSessions).omit({ id: true, createdAt: true });\nexport const insertSecuritySettingsSchema = createInsertSchema(securitySettings).omit({ id: true, createdAt: true, updatedAt: true });\n\nexport type LoginHistory = typeof loginHistory.$inferSelect;\nexport type InsertLoginHistory = z.infer<typeof insertLoginHistorySchema>;\nexport type AccountLockout = typeof accountLockouts.$inferSelect;\nexport type InsertAccountLockout = z.infer<typeof insertAccountLockoutSchema>;\nexport type EmailVerificationToken = typeof emailVerificationTokens.$inferSelect;\nexport type InsertEmailVerificationToken = z.infer<typeof insertEmailVerificationTokenSchema>;\nexport type PasswordResetToken = typeof passwordResetTokens.$inferSelect;\nexport type InsertPasswordResetToken = z.infer<typeof insertPasswordResetTokenSchema>;\nexport type UserSession = typeof userSessions.$inferSelect;\nexport type InsertUserSession = z.infer<typeof insertUserSessionSchema>;\nexport type SecuritySettings = typeof securitySettings.$inferSelect;\nexport type InsertSecuritySettings = z.infer<typeof insertSecuritySettingsSchema>;\n\n// OAuth Accounts - Links social providers to users\nexport const oauthProviderEnum = z.enum([\"google\", \"github\", \"facebook\"]);\nexport type OAuthProvider = z.infer<typeof oauthProviderEnum>;\n\nexport const oauthAccounts = pgTable(\"oauth_accounts\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  provider: varchar(\"provider\", { length: 20 }).notNull(), // google, github, facebook\n  providerUserId: varchar(\"provider_user_id\", { length: 255 }).notNull(),\n  email: varchar(\"email\", { length: 255 }),\n  profileName: varchar(\"profile_name\", { length: 100 }),\n  avatarUrl: text(\"avatar_url\"),\n  accessTokenHash: varchar(\"access_token_hash\", { length: 64 }),\n  refreshTokenHash: varchar(\"refresh_token_hash\", { length: 64 }),\n  linkedAt: timestamp(\"linked_at\").notNull().defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"oauth_accounts_user_id_idx\").on(table.userId),\n  providerIdx: index(\"oauth_accounts_provider_idx\").on(table.provider),\n  providerUserIdIdx: index(\"oauth_accounts_provider_user_id_idx\").on(table.provider, table.providerUserId),\n}));\n\nexport const insertOAuthAccountSchema = createInsertSchema(oauthAccounts, {\n  provider: oauthProviderEnum,\n  providerUserId: z.string().min(1).max(255),\n  email: z.string().email().nullable().optional(),\n  profileName: z.string().max(100).nullable().optional(),\n  avatarUrl: z.string().url().nullable().optional(),\n}).omit({ id: true, linkedAt: true });\n\nexport type OAuthAccount = typeof oauthAccounts.$inferSelect;\nexport type InsertOAuthAccount = z.infer<typeof insertOAuthAccountSchema>;\n\n// Persistent Login Tokens - Remember Me functionality\nexport const persistentLogins = pgTable(\"persistent_logins\", {\n  series: varchar(\"series\", { length: 64 }).primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  tokenHash: varchar(\"token_hash\", { length: 64 }).notNull(),\n  deviceName: varchar(\"device_name\", { length: 200 }),\n  deviceFingerprint: varchar(\"device_fingerprint\", { length: 64 }),\n  userAgent: text(\"user_agent\"),\n  ipAddress: varchar(\"ip_address\", { length: 45 }),\n  lastUsed: timestamp(\"last_used\").notNull().defaultNow(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n}, (table) => ({\n  userIdIdx: index(\"persistent_logins_user_id_idx\").on(table.userId),\n  expiresAtIdx: index(\"persistent_logins_expires_at_idx\").on(table.expiresAt),\n}));\n\nexport const insertPersistentLoginSchema = createInsertSchema(persistentLogins, {\n  series: z.string().length(64),\n  tokenHash: z.string().length(64),\n  deviceName: z.string().max(200).nullable().optional(),\n  deviceFingerprint: z.string().max(64).nullable().optional(),\n  userAgent: z.string().nullable().optional(),\n  ipAddress: z.string().max(45).nullable().optional(),\n}).omit({ createdAt: true });\n\nexport type PersistentLogin = typeof persistentLogins.$inferSelect;\nexport type InsertPersistentLogin = z.infer<typeof insertPersistentLoginSchema>;\n\n// OAuth States - CSRF protection for OAuth flows (database-persisted for multi-instance support)\nexport const oauthStates = pgTable(\"oauth_states\", {\n  state: varchar(\"state\", { length: 64 }).primaryKey(),\n  provider: varchar(\"provider\", { length: 20 }).notNull(),\n  codeVerifier: varchar(\"code_verifier\", { length: 128 }),\n  redirectTo: varchar(\"redirect_to\", { length: 255 }),\n  linkUserId: varchar(\"link_user_id\").references(() => users.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n}, (table) => ({\n  expiresAtIdx: index(\"oauth_states_expires_at_idx\").on(table.expiresAt),\n}));\n\nexport const insertOAuthStateSchema = createInsertSchema(oauthStates).omit({ createdAt: true });\nexport type OAuthState = typeof oauthStates.$inferSelect;\nexport type InsertOAuthState = z.infer<typeof insertOAuthStateSchema>;\n\n// Audit Logs - Security event tracking (database-persisted for compliance and querying)\nexport const auditLogs = pgTable(\"audit_logs\", {\n  id: serial(\"id\").primaryKey(),\n  eventType: varchar(\"event_type\", { length: 50 }).notNull(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  ipAddress: varchar(\"ip_address\", { length: 45 }),\n  userAgent: text(\"user_agent\"),\n  deviceFingerprint: varchar(\"device_fingerprint\", { length: 64 }),\n  provider: varchar(\"provider\", { length: 20 }),\n  success: boolean(\"success\").notNull(),\n  failureReason: varchar(\"failure_reason\", { length: 200 }),\n  metadata: jsonb(\"metadata\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  eventTypeIdx: index(\"audit_logs_event_type_idx\").on(table.eventType),\n  userIdIdx: index(\"audit_logs_user_id_idx\").on(table.userId),\n  createdAtIdx: index(\"audit_logs_created_at_idx\").on(table.createdAt),\n}));\n\nexport const insertAuditLogSchema = createInsertSchema(auditLogs).omit({ id: true, createdAt: true });\nexport type AuditLog = typeof auditLogs.$inferSelect;\nexport type InsertAuditLog = z.infer<typeof insertAuditLogSchema>;\n\nexport const testResults = pgTable(\"test_results\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  wpm: integer(\"wpm\").notNull(),\n  accuracy: real(\"accuracy\").notNull(),\n  mode: integer(\"mode\").notNull(),\n  characters: integer(\"characters\").notNull(),\n  errors: integer(\"errors\").notNull(),\n  freestyle: boolean(\"freestyle\").default(false).notNull(),\n  language: varchar(\"language\", { length: 10 }).notNull().default(\"en\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"user_id_idx\").on(table.userId),\n  wpmIdx: index(\"wpm_idx\").on(table.wpm),\n  createdAtIdx: index(\"created_at_idx\").on(table.createdAt),\n  freestyleIdx: index(\"freestyle_idx\").on(table.freestyle),\n  languageIdx: index(\"language_idx\").on(table.language),\n  languageModeTimeIdx: index(\"language_mode_time_idx\").on(table.language, table.mode, table.createdAt.desc(), table.wpm.desc()),\n}));\n\nexport const insertTestResultSchema = createInsertSchema(testResults, {\n  wpm: z.number().int().min(0).max(500),\n  accuracy: z.number().min(0).max(100),\n  mode: z.number().int().positive(),\n  characters: z.number().int().min(0),\n  errors: z.number().int().min(0),\n  freestyle: z.boolean().optional(),\n  language: z.string().min(2).max(10).default(\"en\"),\n}).omit({ id: true, createdAt: true });\n\nexport type InsertTestResult = z.infer<typeof insertTestResultSchema>;\nexport type TestResult = typeof testResults.$inferSelect;\n\nexport const sharedResults = pgTable(\"shared_results\", {\n  id: serial(\"id\").primaryKey(),\n  shareToken: varchar(\"share_token\", { length: 12 }).notNull().unique(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  username: text(\"username\"),\n  mode: text(\"mode\").notNull(),\n  wpm: integer(\"wpm\").notNull(),\n  accuracy: real(\"accuracy\").notNull(),\n  errors: integer(\"errors\").notNull(),\n  duration: integer(\"duration\"),\n  characters: integer(\"characters\"),\n  metadata: jsonb(\"metadata\"),\n  freestyle: boolean(\"freestyle\").default(false).notNull(),\n  isAnonymous: boolean(\"is_anonymous\").default(false).notNull(),\n  viewCount: integer(\"view_count\").default(0).notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  shareTokenIdx: index(\"share_token_idx\").on(table.shareToken),\n  modeIdx: index(\"shared_mode_idx\").on(table.mode),\n  createdAtIdx: index(\"shared_created_at_idx\").on(table.createdAt),\n}));\n\nexport const insertSharedResultSchema = createInsertSchema(sharedResults, {\n  shareToken: z.string().length(12),\n  mode: z.string().min(1),\n  wpm: z.number().int().min(0).max(500),\n  accuracy: z.number().min(0).max(100),\n  errors: z.number().int().min(0),\n  freestyle: z.boolean().optional(),\n  isAnonymous: z.boolean().optional(),\n}).omit({ id: true, createdAt: true, viewCount: true });\n\nexport type InsertSharedResult = z.infer<typeof insertSharedResultSchema>;\nexport type SharedResult = typeof sharedResults.$inferSelect;\n\nexport const conversations = pgTable(\"conversations\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  title: text(\"title\").notNull().default(\"New Chat\"),\n  isPinned: integer(\"is_pinned\").notNull().default(0),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"conversation_user_id_idx\").on(table.userId),\n  updatedAtIdx: index(\"conversation_updated_at_idx\").on(table.updatedAt),\n}));\n\nexport const messages = pgTable(\"messages\", {\n  id: serial(\"id\").primaryKey(),\n  conversationId: integer(\"conversation_id\").notNull().references(() => conversations.id, { onDelete: \"cascade\" }),\n  role: text(\"role\").notNull(),\n  content: text(\"content\").notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  conversationIdIdx: index(\"message_conversation_id_idx\").on(table.conversationId),\n}));\n\nexport const insertConversationSchema = createInsertSchema(conversations).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertMessageSchema = createInsertSchema(messages, {\n  role: z.enum([\"user\", \"assistant\", \"system\"]),\n}).omit({ id: true, createdAt: true });\n\nexport type InsertConversation = z.infer<typeof insertConversationSchema>;\nexport type Conversation = typeof conversations.$inferSelect;\nexport type InsertMessage = z.infer<typeof insertMessageSchema>;\nexport type Message = typeof messages.$inferSelect;\n\nexport const typingParagraphs = pgTable(\"typing_paragraphs\", {\n  id: serial(\"id\").primaryKey(),\n  language: text(\"language\").notNull(),\n  mode: text(\"mode\").notNull(),\n  difficulty: text(\"difficulty\").notNull().default(\"medium\"),\n  content: text(\"content\").notNull(),\n  wordCount: integer(\"word_count\").notNull(),\n  isTypingRelated: boolean(\"is_typing_related\").default(false).notNull(), // Flag to exclude typing-focused paragraphs\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  languageIdx: index(\"paragraph_language_idx\").on(table.language),\n  modeIdx: index(\"paragraph_mode_idx\").on(table.mode),\n  languageModeIdx: index(\"paragraph_language_mode_idx\").on(table.language, table.mode),\n}));\n\nexport const insertTypingParagraphSchema = createInsertSchema(typingParagraphs, {\n  language: z.string().min(2).max(10),\n  mode: z.string().min(1),\n  difficulty: z.enum([\"easy\", \"medium\", \"hard\"]),\n  content: z.string().min(50),\n  wordCount: z.number().int().positive(),\n}).omit({ id: true, createdAt: true });\n\nexport type InsertTypingParagraph = z.infer<typeof insertTypingParagraphSchema>;\nexport type TypingParagraph = typeof typingParagraphs.$inferSelect;\n\nexport const keystrokeAnalytics = pgTable(\"keystroke_analytics\", {\n  id: serial(\"id\").primaryKey(),\n  testResultId: integer(\"test_result_id\").notNull().references(() => testResults.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  expectedKey: text(\"expected_key\").notNull(),\n  typedKey: text(\"typed_key\").notNull(),\n  isCorrect: integer(\"is_correct\").notNull(),\n  position: integer(\"position\").notNull(),\n  timestamp: bigint(\"timestamp\", { mode: \"number\" }).notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"keystroke_user_id_idx\").on(table.userId),\n  testResultIdIdx: index(\"keystroke_test_result_id_idx\").on(table.testResultId),\n  expectedKeyIdx: index(\"keystroke_expected_key_idx\").on(table.expectedKey),\n}));\n\nexport const insertKeystrokeAnalyticsSchema = createInsertSchema(keystrokeAnalytics, {\n  expectedKey: z.string().min(1),\n  typedKey: z.string().min(1),\n  isCorrect: z.number().int().min(0).max(1),\n  position: z.number().int().min(0),\n  timestamp: z.number().int(),\n}).omit({ id: true, createdAt: true });\n\nexport type InsertKeystrokeAnalytics = z.infer<typeof insertKeystrokeAnalyticsSchema>;\nexport type KeystrokeAnalytics = typeof keystrokeAnalytics.$inferSelect;\n\n// Multiplayer Racing System\nexport const races = pgTable(\"races\", {\n  id: serial(\"id\").primaryKey(),\n  roomCode: varchar(\"room_code\", { length: 6 }).notNull().unique(),\n  status: text(\"status\").notNull().default(\"waiting\"), // waiting, countdown, racing, finished\n  raceType: text(\"race_type\").notNull().default(\"standard\"), // standard (finish paragraph) or timed (race for duration)\n  timeLimitSeconds: integer(\"time_limit_seconds\"), // null for standard, 30/60/120/180 for timed\n  paragraphId: integer(\"paragraph_id\").references(() => typingParagraphs.id),\n  paragraphContent: text(\"paragraph_content\").notNull(),\n  maxPlayers: integer(\"max_players\").notNull().default(4),\n  isPrivate: integer(\"is_private\").notNull().default(0),\n  finishCounter: integer(\"finish_counter\").notNull().default(0),\n  startedAt: timestamp(\"started_at\"),\n  finishedAt: timestamp(\"finished_at\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  roomCodeIdx: index(\"race_room_code_idx\").on(table.roomCode),\n  statusIdx: index(\"race_status_idx\").on(table.status),\n  createdAtIdx: index(\"race_created_at_idx\").on(table.createdAt),\n  raceTypeIdx: index(\"race_type_idx\").on(table.raceType),\n}));\n\nexport const raceParticipants = pgTable(\"race_participants\", {\n  id: serial(\"id\").primaryKey(),\n  raceId: integer(\"race_id\").notNull().references(() => races.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  guestName: text(\"guest_name\"),\n  username: text(\"username\").notNull(),\n  avatarColor: text(\"avatar_color\").default(\"bg-primary\"),\n  isBot: integer(\"is_bot\").notNull().default(0),\n  isActive: integer(\"is_active\").notNull().default(1),\n  progress: integer(\"progress\").notNull().default(0), // characters typed\n  wpm: integer(\"wpm\").notNull().default(0),\n  accuracy: real(\"accuracy\").notNull().default(100), // 100% = no errors (not started yet)\n  errors: integer(\"errors\").notNull().default(0),\n  isFinished: integer(\"is_finished\").notNull().default(0),\n  finishPosition: integer(\"finish_position\"),\n  finishedAt: timestamp(\"finished_at\"),\n  joinedAt: timestamp(\"joined_at\").notNull().defaultNow(),\n}, (table) => ({\n  raceIdIdx: index(\"participant_race_id_idx\").on(table.raceId),\n  userIdIdx: index(\"participant_user_id_idx\").on(table.userId),\n  raceStatusIdx: index(\"participant_race_status_idx\").on(table.raceId, table.isFinished),\n  raceActiveIdx: index(\"participant_race_active_idx\").on(table.raceId, table.isActive),\n}));\n\nexport const insertRaceSchema = createInsertSchema(races, {\n  roomCode: z.string().length(6),\n  status: z.enum([\"waiting\", \"countdown\", \"racing\", \"finished\"]),\n  raceType: z.enum([\"standard\", \"timed\"]).optional(),\n  timeLimitSeconds: z.number().int().min(15).max(300).nullable().optional(),\n  paragraphContent: z.string().min(50),\n  maxPlayers: z.number().int().min(2).max(10),\n  isPrivate: z.number().int().min(0).max(1),\n}).omit({ id: true, createdAt: true });\n\nexport const insertRaceParticipantSchema = createInsertSchema(raceParticipants, {\n  username: z.string().min(1).max(30),\n  isBot: z.number().int().min(0).max(1),\n  progress: z.number().int().min(0),\n  wpm: z.number().int().min(0).max(500),\n  accuracy: z.number().min(0).max(100),\n  errors: z.number().int().min(0),\n  isFinished: z.number().int().min(0).max(1),\n}).omit({ id: true, joinedAt: true });\n\nexport type InsertRace = z.infer<typeof insertRaceSchema>;\nexport type Race = typeof races.$inferSelect;\nexport type InsertRaceParticipant = z.infer<typeof insertRaceParticipantSchema>;\nexport type RaceParticipant = typeof raceParticipants.$inferSelect;\n\n// ============================================================================\n// MULTIPLAYER RACING ENHANCED FEATURES\n// ============================================================================\n\n// User ELO Rating System\nexport const userRatings = pgTable(\"user_ratings\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().unique().references(() => users.id, { onDelete: \"cascade\" }),\n  \n  // ELO Rating\n  rating: integer(\"rating\").notNull().default(1200),\n  peakRating: integer(\"peak_rating\").notNull().default(1200),\n  \n  // Rating tier (calculated from rating)\n  tier: varchar(\"tier\", { length: 20 }).notNull().default(\"bronze\"), // bronze, silver, gold, platinum, diamond, master, grandmaster\n  \n  // Stats\n  totalRaces: integer(\"total_races\").notNull().default(0),\n  wins: integer(\"wins\").notNull().default(0),\n  losses: integer(\"losses\").notNull().default(0),\n  draws: integer(\"draws\").notNull().default(0),\n  winStreak: integer(\"win_streak\").notNull().default(0),\n  bestWinStreak: integer(\"best_win_streak\").notNull().default(0),\n  \n  // Provisional status (first 10 games have higher K-factor)\n  isProvisional: boolean(\"is_provisional\").default(true).notNull(),\n  provisionalGames: integer(\"provisional_games\").notNull().default(0),\n  \n  // Decay tracking\n  lastRaceAt: timestamp(\"last_race_at\"),\n  ratingDecay: integer(\"rating_decay\").notNull().default(0),\n  \n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n}, (table) => ({\n  ratingIdx: index(\"user_ratings_rating_idx\").on(table.rating),\n  tierIdx: index(\"user_ratings_tier_idx\").on(table.tier),\n  winsIdx: index(\"user_ratings_wins_idx\").on(table.wins),\n}));\n\n// Race Match History (for ELO calculations and stats)\nexport const raceMatchHistory = pgTable(\"race_match_history\", {\n  id: serial(\"id\").primaryKey(),\n  raceId: integer(\"race_id\").notNull().references(() => races.id, { onDelete: \"cascade\" }),\n  \n  // Player info\n  participantId: integer(\"participant_id\").notNull().references(() => raceParticipants.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  \n  // Result\n  finishPosition: integer(\"finish_position\").notNull(),\n  wpm: integer(\"wpm\").notNull(),\n  accuracy: real(\"accuracy\").notNull(),\n  \n  // Rating change\n  ratingBefore: integer(\"rating_before\"),\n  ratingAfter: integer(\"rating_after\"),\n  ratingChange: integer(\"rating_change\"),\n  \n  // Opponents info (stored for historical reference)\n  opponentCount: integer(\"opponent_count\").notNull().default(0),\n  avgOpponentRating: integer(\"avg_opponent_rating\"),\n  \n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  raceIdIdx: index(\"race_match_race_id_idx\").on(table.raceId),\n  userIdIdx: index(\"race_match_user_id_idx\").on(table.userId),\n  createdAtIdx: index(\"race_match_created_at_idx\").on(table.createdAt),\n  raceParticipantUnique: index(\"race_match_race_participant_unique_idx\").on(table.raceId, table.participantId),\n}));\n\n// Race Keystroke Log (for anti-cheat and replays)\nexport const raceKeystrokes = pgTable(\"race_keystrokes\", {\n  id: serial(\"id\").primaryKey(),\n  raceId: integer(\"race_id\").notNull().references(() => races.id, { onDelete: \"cascade\" }),\n  participantId: integer(\"participant_id\").notNull().references(() => raceParticipants.id, { onDelete: \"cascade\" }),\n  \n  // Keystroke data (stored as JSON array for efficiency)\n  keystrokes: jsonb(\"keystrokes\").notNull(), // [{key, expected, timestamp, correct, position}]\n  \n  // Content hash for integrity verification\n  contentHash: varchar(\"content_hash\", { length: 64 }),\n  \n  // Anti-cheat metrics (calculated server-side)\n  avgInterval: real(\"avg_interval\"), // average ms between keystrokes\n  minInterval: real(\"min_interval\"), // minimum ms between keystrokes\n  stdDevInterval: real(\"std_dev_interval\"), // consistency of typing rhythm\n  suspiciousPatterns: integer(\"suspicious_patterns\").notNull().default(0),\n  \n  // Validation\n  serverCalculatedWpm: integer(\"server_calculated_wpm\"),\n  clientReportedWpm: integer(\"client_reported_wpm\"),\n  wpmDiscrepancy: real(\"wpm_discrepancy\"),\n  \n  // Anti-cheat flags\n  isFlagged: boolean(\"is_flagged\").default(false).notNull(),\n  flagReasons: jsonb(\"flag_reasons\"), // [\"inhuman_speed\", \"perfect_accuracy\", etc.]\n  requiresReview: boolean(\"requires_review\").default(false).notNull(),\n  \n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  raceIdIdx: index(\"race_keystrokes_race_id_idx\").on(table.raceId),\n  participantIdIdx: index(\"race_keystrokes_participant_id_idx\").on(table.participantId),\n  flaggedIdx: index(\"race_keystrokes_flagged_idx\").on(table.isFlagged),\n  raceParticipantUnique: index(\"race_keystrokes_race_participant_unique_idx\").on(table.raceId, table.participantId),\n}));\n\n// Race Chat Messages\nexport const raceChatMessages = pgTable(\"race_chat_messages\", {\n  id: serial(\"id\").primaryKey(),\n  raceId: integer(\"race_id\").notNull().references(() => races.id, { onDelete: \"cascade\" }),\n  participantId: integer(\"participant_id\").references(() => raceParticipants.id, { onDelete: \"set null\" }),\n  \n  // Message content\n  messageType: varchar(\"message_type\", { length: 20 }).notNull().default(\"text\"), // text, emote, system\n  content: text(\"content\").notNull(),\n  \n  // For emotes\n  emoteCode: varchar(\"emote_code\", { length: 50 }),\n  \n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  raceIdIdx: index(\"race_chat_race_id_idx\").on(table.raceId),\n  createdAtIdx: index(\"race_chat_created_at_idx\").on(table.createdAt),\n}));\n\n// Race Spectators\nexport const raceSpectators = pgTable(\"race_spectators\", {\n  id: serial(\"id\").primaryKey(),\n  raceId: integer(\"race_id\").notNull().references(() => races.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  \n  // Guest spectator tracking\n  sessionId: varchar(\"session_id\", { length: 64 }),\n  \n  joinedAt: timestamp(\"joined_at\").notNull().defaultNow(),\n  leftAt: timestamp(\"left_at\"),\n  \n  isActive: boolean(\"is_active\").default(true).notNull(),\n}, (table) => ({\n  raceIdIdx: index(\"race_spectators_race_id_idx\").on(table.raceId),\n  activeIdx: index(\"race_spectators_active_idx\").on(table.raceId, table.isActive),\n}));\n\n// Race Replays (stored for completed races)\nexport const raceReplays = pgTable(\"race_replays\", {\n  id: serial(\"id\").primaryKey(),\n  raceId: integer(\"race_id\").notNull().unique().references(() => races.id, { onDelete: \"cascade\" }),\n  \n  // Race metadata snapshot\n  paragraphContent: text(\"paragraph_content\").notNull(),\n  duration: integer(\"duration\"), // total race duration in ms\n  \n  // All participants' keystroke data for replay\n  participantData: jsonb(\"participant_data\").notNull(), // [{participantId, username, keystrokes, wpm, accuracy, position}]\n  \n  // Replay accessibility\n  isPublic: boolean(\"is_public\").default(false).notNull(),\n  viewCount: integer(\"view_count\").notNull().default(0),\n  \n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  raceIdIdx: index(\"race_replays_race_id_idx\").on(table.raceId),\n  publicIdx: index(\"race_replays_public_idx\").on(table.isPublic),\n}));\n\n// Anti-Cheat Verification Challenges (CAPTCHA for high WPM)\nexport const antiCheatChallenges = pgTable(\"anti_cheat_challenges\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  \n  // Challenge details\n  challengeText: text(\"challenge_text\").notNull(),\n  challengeType: varchar(\"challenge_type\", { length: 20 }).notNull().default(\"typing\"), // typing, captcha\n  \n  // Result\n  triggered: boolean(\"triggered\").default(false).notNull(),\n  triggeredWpm: integer(\"triggered_wpm\"),\n  passed: boolean(\"passed\"),\n  challengeWpm: integer(\"challenge_wpm\"),\n  \n  // Certification (if passed, user is certified up to 25% above their challenge WPM)\n  certifiedWpm: integer(\"certified_wpm\"),\n  certifiedUntil: timestamp(\"certified_until\"),\n  \n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n  completedAt: timestamp(\"completed_at\"),\n}, (table) => ({\n  userIdIdx: index(\"anti_cheat_user_id_idx\").on(table.userId),\n  certifiedIdx: index(\"anti_cheat_certified_idx\").on(table.userId, table.certifiedUntil),\n}));\n\n// Insert schemas and types for new tables\nexport const insertUserRatingSchema = createInsertSchema(userRatings, {\n  rating: z.number().int().min(0).max(5000),\n  tier: z.enum([\"bronze\", \"silver\", \"gold\", \"platinum\", \"diamond\", \"master\", \"grandmaster\"]),\n}).omit({ id: true, createdAt: true, updatedAt: true });\n\nexport const insertRaceMatchHistorySchema = createInsertSchema(raceMatchHistory, {\n  finishPosition: z.number().int().min(1),\n  wpm: z.number().int().min(0).max(500),\n  accuracy: z.number().min(0).max(100),\n}).omit({ id: true, createdAt: true });\n\nexport const insertRaceKeystrokesSchema = createInsertSchema(raceKeystrokes).omit({ id: true, createdAt: true });\n\nexport const insertRaceChatMessageSchema = createInsertSchema(raceChatMessages, {\n  messageType: z.enum([\"text\", \"emote\", \"system\"]),\n  content: z.string().min(1).max(500),\n}).omit({ id: true, createdAt: true });\n\nexport const insertRaceSpectatorSchema = createInsertSchema(raceSpectators).omit({ id: true, joinedAt: true });\n\nexport const insertRaceReplaySchema = createInsertSchema(raceReplays).omit({ id: true, createdAt: true, viewCount: true });\n\nexport const insertAntiCheatChallengeSchema = createInsertSchema(antiCheatChallenges).omit({ id: true, createdAt: true, completedAt: true });\n\nexport type UserRating = typeof userRatings.$inferSelect;\nexport type InsertUserRating = z.infer<typeof insertUserRatingSchema>;\nexport type RaceMatchHistory = typeof raceMatchHistory.$inferSelect;\nexport type InsertRaceMatchHistory = z.infer<typeof insertRaceMatchHistorySchema>;\nexport type RaceKeystrokes = typeof raceKeystrokes.$inferSelect;\nexport type InsertRaceKeystrokes = z.infer<typeof insertRaceKeystrokesSchema>;\nexport type RaceChatMessage = typeof raceChatMessages.$inferSelect;\nexport type InsertRaceChatMessage = z.infer<typeof insertRaceChatMessageSchema>;\nexport type RaceSpectator = typeof raceSpectators.$inferSelect;\nexport type InsertRaceSpectator = z.infer<typeof insertRaceSpectatorSchema>;\nexport type RaceReplay = typeof raceReplays.$inferSelect;\nexport type InsertRaceReplay = z.infer<typeof insertRaceReplaySchema>;\nexport type AntiCheatChallenge = typeof antiCheatChallenges.$inferSelect;\nexport type InsertAntiCheatChallenge = z.infer<typeof insertAntiCheatChallengeSchema>;\n\nexport const codeSnippets = pgTable(\"code_snippets\", {\n  id: serial(\"id\").primaryKey(),\n  programmingLanguage: text(\"programming_language\").notNull(),\n  framework: text(\"framework\"),\n  difficulty: text(\"difficulty\").notNull().default(\"medium\"),\n  content: text(\"content\").notNull(),\n  lineCount: integer(\"line_count\").notNull(),\n  characterCount: integer(\"character_count\").notNull(),\n  description: text(\"description\"),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  langIdx: index(\"code_language_idx\").on(table.programmingLanguage),\n  difficultyIdx: index(\"code_difficulty_idx\").on(table.difficulty),\n  langDiffIdx: index(\"code_language_difficulty_idx\").on(table.programmingLanguage, table.difficulty),\n}));\n\nexport const insertCodeSnippetSchema = createInsertSchema(codeSnippets, {\n  programmingLanguage: z.string().min(1),\n  framework: z.string().optional(),\n  difficulty: z.enum([\"easy\", \"medium\", \"hard\"]),\n  content: z.string().min(10),\n  lineCount: z.number().int().positive(),\n  characterCount: z.number().int().positive(),\n  description: z.string().optional(),\n}).omit({ id: true, createdAt: true });\n\nexport type InsertCodeSnippet = z.infer<typeof insertCodeSnippetSchema>;\nexport type CodeSnippet = typeof codeSnippets.$inferSelect;\n\nexport const codeTypingTests = pgTable(\"code_typing_tests\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  codeSnippetId: integer(\"code_snippet_id\").references(() => codeSnippets.id, { onDelete: \"set null\" }),\n  programmingLanguage: text(\"programming_language\").notNull(),\n  framework: text(\"framework\"),\n  wpm: integer(\"wpm\").notNull(),\n  accuracy: real(\"accuracy\").notNull(),\n  characters: integer(\"characters\").notNull(),\n  errors: integer(\"errors\").notNull(),\n  syntaxErrors: integer(\"syntax_errors\").notNull().default(0),\n  duration: integer(\"duration\").notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"code_test_user_id_idx\").on(table.userId),\n  langIdx: index(\"code_test_language_idx\").on(table.programmingLanguage),\n  wpmIdx: index(\"code_test_wpm_idx\").on(table.wpm),\n  userLangIdx: index(\"code_test_user_language_idx\").on(table.userId, table.programmingLanguage),\n  createdAtIdx: index(\"code_test_created_at_idx\").on(table.createdAt),\n}));\n\nexport const insertCodeTypingTestSchema = createInsertSchema(codeTypingTests, {\n  codeSnippetId: z.number().int().positive().nullable().optional(),\n  programmingLanguage: z.string().min(1).max(50),\n  framework: z.string().max(50).nullable().optional(),\n  wpm: z.number().int().min(0).max(500),\n  accuracy: z.number().min(0).max(100),\n  characters: z.number().int().min(1),\n  errors: z.number().int().min(0),\n  syntaxErrors: z.number().int().min(0),\n  duration: z.number().int().min(1).max(3600),\n}).omit({ id: true, createdAt: true });\n\nexport type InsertCodeTypingTest = z.infer<typeof insertCodeTypingTestSchema>;\nexport type CodeTypingTest = typeof codeTypingTests.$inferSelect;\n\n// Shared Code Typing Results\nexport const sharedCodeResults = pgTable(\"shared_code_results\", {\n  id: serial(\"id\").primaryKey(),\n  shareId: varchar(\"share_id\", { length: 10 }).notNull().unique(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  username: text(\"username\").notNull(),\n  programmingLanguage: text(\"programming_language\").notNull(),\n  framework: text(\"framework\"),\n  difficulty: text(\"difficulty\").notNull(),\n  testMode: text(\"test_mode\").notNull(), // normal, expert, master\n  wpm: integer(\"wpm\").notNull(),\n  accuracy: real(\"accuracy\").notNull(),\n  errors: integer(\"errors\").notNull(),\n  syntaxErrors: integer(\"syntax_errors\").notNull().default(0),\n  duration: integer(\"duration\").notNull(), // in seconds\n  codeContent: text(\"code_content\").notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  shareIdIdx: index(\"shared_code_share_id_idx\").on(table.shareId),\n  createdAtIdx: index(\"shared_code_created_at_idx\").on(table.createdAt),\n}));\n\nexport const insertSharedCodeResultSchema = createInsertSchema(sharedCodeResults, {\n  shareId: z.string().length(10),\n  username: z.string().min(1).max(30),\n  programmingLanguage: z.string().min(1),\n  framework: z.string().nullable(),\n  difficulty: z.enum([\"easy\", \"medium\", \"hard\"]),\n  testMode: z.enum([\"normal\", \"expert\", \"master\"]),\n  wpm: z.number().int().min(0).max(500),\n  accuracy: z.number().min(0).max(100),\n  errors: z.number().int().min(0),\n  syntaxErrors: z.number().int().min(0),\n  duration: z.number().int().positive(),\n  codeContent: z.string().min(10),\n}).omit({ id: true, createdAt: true });\n\nexport type InsertSharedCodeResult = z.infer<typeof insertSharedCodeResultSchema>;\nexport type SharedCodeResult = typeof sharedCodeResults.$inferSelect;\n\n// Certificates - Achievement certificates for all typing modes\nexport const certificates = pgTable(\"certificates\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  certificateType: varchar(\"certificate_type\", { length: 20 }).notNull(), // standard, code, book, race, dictation, stress\n  \n  // Test result references (based on type)\n  testResultId: integer(\"test_result_id\").references(() => testResults.id, { onDelete: \"cascade\" }),\n  codeTestId: integer(\"code_test_id\").references(() => codeTypingTests.id, { onDelete: \"cascade\" }),\n  bookTestId: integer(\"book_test_id\").references(() => bookTypingTests.id, { onDelete: \"cascade\" }),\n  raceId: integer(\"race_id\").references(() => races.id, { onDelete: \"cascade\" }),\n  dictationTestId: integer(\"dictation_test_id\").references(() => dictationTests.id, { onDelete: \"cascade\" }),\n  stressTestId: integer(\"stress_test_id\").references(() => stressTests.id, { onDelete: \"cascade\" }),\n  \n  // Performance metrics (denormalized for quick display)\n  wpm: integer(\"wpm\").notNull(),\n  accuracy: real(\"accuracy\").notNull(),\n  consistency: integer(\"consistency\").notNull(), // 0-100\n  duration: integer(\"duration\").notNull(), // in seconds\n  \n  // Certificate metadata (varies by type)\n  metadata: jsonb(\"metadata\").$type<{\n    // Common\n    tier?: string;\n    username?: string;\n    \n    // Standard test\n    mode?: number;\n    characters?: number;\n    errors?: number;\n    \n    // Code test\n    programmingLanguage?: string;\n    framework?: string;\n    difficulty?: string; // Used by both Code and Stress tests\n    testMode?: string;\n    syntaxErrors?: number;\n    \n    // Book test\n    bookTitle?: string;\n    author?: string;\n    chapter?: number;\n    chapterTitle?: string;\n    paragraphsCompleted?: number;\n    wordsTyped?: number;\n    \n    // Race\n    placement?: number;\n    totalParticipants?: number;\n    raceId?: string;\n    \n    // Dictation\n    speedLevel?: string;\n    sentencesCompleted?: number;\n    totalWords?: number;\n    \n    // Stress Test\n    stressScore?: number;\n    maxCombo?: number;\n    completionRate?: number;\n    survivalTime?: number;\n    activeChallenges?: number;\n  }>(),\n  \n  // Sharing\n  shareId: varchar(\"share_id\", { length: 12 }).unique(),\n  viewCount: integer(\"view_count\").default(0).notNull(),\n  isPublic: boolean(\"is_public\").default(false).notNull(),\n  \n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"certificates_user_id_idx\").on(table.userId),\n  typeIdx: index(\"certificates_type_idx\").on(table.certificateType),\n  shareIdIdx: index(\"certificates_share_id_idx\").on(table.shareId),\n  createdAtIdx: index(\"certificates_created_at_idx\").on(table.createdAt),\n  userTypeIdx: index(\"certificates_user_type_idx\").on(table.userId, table.certificateType),\n}));\n\nexport const insertCertificateSchema = createInsertSchema(certificates, {\n  certificateType: z.enum([\"standard\", \"code\", \"book\", \"race\", \"dictation\", \"stress\"]),\n  wpm: z.number().int().min(0).max(500),\n  accuracy: z.number().min(0).max(100),\n  consistency: z.number().int().min(0).max(100),\n  duration: z.number().int().positive(),\n  metadata: z.record(z.any()).optional(),\n  shareId: z.string().length(12).nullable().optional(),\n  viewCount: z.number().int().min(0).optional(),\n  isPublic: z.boolean().optional(),\n}).omit({ id: true, createdAt: true });\n\nexport type InsertCertificate = z.infer<typeof insertCertificateSchema>;\nexport type Certificate = typeof certificates.$inferSelect;\n\n// Books metadata for Book Library\nexport const books = pgTable(\"books\", {\n  id: integer(\"id\").primaryKey(), // Gutendex book ID\n  slug: text(\"slug\").notNull().unique(),\n  title: text(\"title\").notNull(),\n  author: text(\"author\").notNull(),\n  language: text(\"language\").notNull().default(\"en\"),\n  topic: text(\"topic\").notNull(),\n  difficulty: text(\"difficulty\").notNull(), // easy, medium, hard (dominant difficulty)\n  totalParagraphs: integer(\"total_paragraphs\").notNull(),\n  totalChapters: integer(\"total_chapters\").notNull().default(1),\n  coverImageUrl: text(\"cover_image_url\"),\n  description: text(\"description\"),\n  estimatedDurationMap: jsonb(\"estimated_duration_map\"), // JSON object: {30: count, 60: count, 90: count, 120: count}\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  slugIdx: index(\"book_slug_idx\").on(table.slug),\n  topicIdx: index(\"book_meta_topic_idx\").on(table.topic),\n  difficultyIdx: index(\"book_meta_difficulty_idx\").on(table.difficulty),\n  languageIdx: index(\"book_meta_language_idx\").on(table.language),\n}));\n\n// Book Paragraphs for Book Typing Mode\nexport const bookParagraphs = pgTable(\"book_paragraphs\", {\n  id: serial(\"id\").primaryKey(),\n  text: text(\"text\").notNull(),\n  difficulty: text(\"difficulty\").notNull(), // easy, medium, hard\n  topic: text(\"topic\").notNull(), // fiction, classics, adventure, etc.\n  durationMode: integer(\"duration_mode\").notNull(), // estimated seconds to type\n  lengthWords: integer(\"length_words\").notNull(),\n  source: text(\"source\").notNull(), // \"Title by Author\"\n  bookId: integer(\"book_id\").notNull().references(() => books.id, { onDelete: \"cascade\" }), // FK to books table\n  paragraphIndex: integer(\"paragraph_index\").notNull(), // position in book (0-indexed)\n  chapter: integer(\"chapter\"), // chapter number (1-indexed, null for unchapterized books)\n  sectionIndex: integer(\"section_index\"), // section within chapter (0-indexed)\n  chapterTitle: text(\"chapter_title\"), // optional chapter heading text\n  language: text(\"language\").notNull().default(\"en\"),\n  metadata: text(\"metadata\"), // JSON string for additional info\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  topicDifficultyDurationIdx: index(\"book_topic_difficulty_duration_idx\").on(table.topic, table.difficulty, table.durationMode),\n  bookIdParagraphIdx: index(\"book_id_paragraph_idx\").on(table.bookId, table.paragraphIndex),\n  bookIdChapterIdx: index(\"book_id_chapter_idx\").on(table.bookId, table.chapter),\n  difficultyIdx: index(\"book_difficulty_idx\").on(table.difficulty),\n  topicIdx: index(\"book_topic_idx\").on(table.topic),\n  durationIdx: index(\"book_duration_idx\").on(table.durationMode),\n}));\n\n// User book progress tracking\nexport const userBookProgress = pgTable(\"user_book_progress\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  bookId: integer(\"book_id\").notNull().references(() => books.id, { onDelete: \"cascade\" }),\n  lastParagraphIndex: integer(\"last_paragraph_index\").notNull().default(0),\n  completedParagraphs: jsonb(\"completed_paragraphs\").default([]), // array of paragraph indices\n  wordsTyped: integer(\"words_typed\").notNull().default(0),\n  totalTests: integer(\"total_tests\").notNull().default(0),\n  averageWpm: real(\"average_wpm\").default(0),\n  averageAccuracy: real(\"average_accuracy\").default(100),\n  isCompleted: boolean(\"is_completed\").notNull().default(false),\n  updatedAt: timestamp(\"updated_at\").notNull().defaultNow(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"user_book_progress_user_id_idx\").on(table.userId),\n  bookIdIdx: index(\"user_book_progress_book_id_idx\").on(table.bookId),\n  userBookIdx: index(\"user_book_progress_user_book_idx\").on(table.userId, table.bookId),\n}));\n\nexport const insertBookSchema = createInsertSchema(books, {\n  id: z.number().int().positive(),\n  slug: z.string().min(1),\n  title: z.string().min(1),\n  author: z.string().min(1),\n  language: z.string().length(2),\n  topic: z.string().min(1),\n  difficulty: z.enum([\"easy\", \"medium\", \"hard\"]),\n  totalParagraphs: z.number().int().positive(),\n  totalChapters: z.number().int().positive(),\n  coverImageUrl: z.string().nullable().optional(),\n  description: z.string().nullable().optional(),\n  estimatedDurationMap: z.any().nullable().optional(),\n}).omit({ createdAt: true });\n\nexport type InsertBook = z.infer<typeof insertBookSchema>;\nexport type Book = typeof books.$inferSelect;\n\nexport const insertBookParagraphSchema = createInsertSchema(bookParagraphs, {\n  text: z.string().min(50),\n  difficulty: z.enum([\"easy\", \"medium\", \"hard\"]),\n  topic: z.string().min(1),\n  durationMode: z.number().int().positive(),\n  lengthWords: z.number().int().positive(),\n  source: z.string().min(1),\n  bookId: z.number().int().positive(),\n  paragraphIndex: z.number().int().min(0),\n  chapter: z.number().int().positive().nullable().optional(),\n  sectionIndex: z.number().int().min(0).nullable().optional(),\n  chapterTitle: z.string().nullable().optional(),\n  language: z.string().length(2),\n  metadata: z.string().nullable().optional(),\n}).omit({ id: true, createdAt: true });\n\nexport type InsertBookParagraph = z.infer<typeof insertBookParagraphSchema>;\nexport type BookParagraph = typeof bookParagraphs.$inferSelect;\n\nexport const insertUserBookProgressSchema = createInsertSchema(userBookProgress, {\n  bookId: z.number().int().positive(),\n  lastParagraphIndex: z.number().int().min(0),\n  completedParagraphs: z.any().nullable().optional(),\n  wordsTyped: z.number().int().min(0),\n  totalTests: z.number().int().min(0),\n  averageWpm: z.number().min(0).max(500),\n  averageAccuracy: z.number().min(0).max(100),\n  isCompleted: z.boolean(),\n}).omit({ id: true, createdAt: true, updatedAt: true });\n\nexport type InsertUserBookProgress = z.infer<typeof insertUserBookProgressSchema>;\nexport type UserBookProgress = typeof userBookProgress.$inferSelect;\n\n// Book Typing Test Results\nexport const bookTypingTests = pgTable(\"book_typing_tests\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  paragraphId: integer(\"paragraph_id\").notNull().references(() => bookParagraphs.id),\n  wpm: integer(\"wpm\").notNull(),\n  accuracy: real(\"accuracy\").notNull(),\n  characters: integer(\"characters\").notNull(),\n  errors: integer(\"errors\").notNull(),\n  duration: integer(\"duration\").notNull(), // actual time taken in seconds\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"book_test_user_id_idx\").on(table.userId),\n  paragraphIdIdx: index(\"book_test_paragraph_id_idx\").on(table.paragraphId),\n  wpmIdx: index(\"book_test_wpm_idx\").on(table.wpm),\n  createdAtIdx: index(\"book_test_created_at_idx\").on(table.createdAt),\n}));\n\nexport const insertBookTypingTestSchema = createInsertSchema(bookTypingTests, {\n  paragraphId: z.number().int().positive(),\n  wpm: z.number().int().min(0).max(500),\n  accuracy: z.number().min(0).max(100),\n  characters: z.number().int().min(1),\n  errors: z.number().int().min(0),\n  duration: z.number().int().positive(),\n}).omit({ id: true, createdAt: true });\n\nexport type InsertBookTypingTest = z.infer<typeof insertBookTypingTestSchema>;\nexport type BookTypingTest = typeof bookTypingTests.$inferSelect;\n\n// Dictation Mode - Sentence Bank\nexport const dictationSentences = pgTable(\"dictation_sentences\", {\n  id: serial(\"id\").primaryKey(),\n  sentence: text(\"sentence\").notNull(),\n  difficulty: text(\"difficulty\").notNull(), // easy, medium, hard\n  category: text(\"category\").default(\"general\"),\n  wordCount: integer(\"word_count\").notNull(),\n  characterCount: integer(\"character_count\").notNull(),\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  difficultyIdx: index(\"dictation_sentence_difficulty_idx\").on(table.difficulty),\n  categoryIdx: index(\"dictation_sentence_category_idx\").on(table.category),\n  difficultyCategoryIdx: index(\"dictation_sentence_difficulty_category_idx\").on(table.difficulty, table.category),\n}));\n\nexport const insertDictationSentenceSchema = createInsertSchema(dictationSentences, {\n  sentence: z.string().min(10).max(500),\n  difficulty: z.enum([\"easy\", \"medium\", \"hard\"]),\n  category: z.string().min(1),\n  wordCount: z.number().int().positive(),\n  characterCount: z.number().int().positive(),\n}).omit({ id: true, createdAt: true });\n\nexport type InsertDictationSentence = z.infer<typeof insertDictationSentenceSchema>;\nexport type DictationSentence = typeof dictationSentences.$inferSelect;\n\n// Dictation Mode - Test Results\nexport const dictationTests = pgTable(\"dictation_tests\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  sentenceId: integer(\"sentence_id\").notNull().references(() => dictationSentences.id),\n  speedLevel: text(\"speed_level\").notNull(), // slow, medium, fast, random\n  actualSpeed: real(\"actual_speed\").notNull(), // actual rate value used (0.7-1.5)\n  actualSentence: text(\"actual_sentence\").notNull(),\n  typedText: text(\"typed_text\").notNull(),\n  wpm: integer(\"wpm\").notNull(),\n  accuracy: real(\"accuracy\").notNull(),\n  errors: integer(\"errors\").notNull(),\n  replayCount: integer(\"replay_count\").notNull().default(0),\n  hintUsed: integer(\"hint_used\").notNull().default(0),\n  duration: integer(\"duration\").notNull(), // seconds\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"dictation_test_user_id_idx\").on(table.userId),\n  sentenceIdIdx: index(\"dictation_test_sentence_id_idx\").on(table.sentenceId),\n  wpmIdx: index(\"dictation_test_wpm_idx\").on(table.wpm),\n  accuracyIdx: index(\"dictation_test_accuracy_idx\").on(table.accuracy),\n  speedLevelIdx: index(\"dictation_test_speed_level_idx\").on(table.speedLevel),\n  createdAtIdx: index(\"dictation_test_created_at_idx\").on(table.createdAt),\n}));\n\nexport const insertDictationTestSchema = createInsertSchema(dictationTests, {\n  sentenceId: z.number().int().positive(),\n  speedLevel: z.enum([\"slow\", \"medium\", \"fast\", \"random\"]),\n  actualSpeed: z.number().min(0.5).max(2.0),\n  actualSentence: z.string().min(1),\n  typedText: z.string(),\n  wpm: z.number().int().min(0).max(500),\n  accuracy: z.number().min(0).max(100),\n  errors: z.number().int().min(0),\n  replayCount: z.number().int().min(0),\n  hintUsed: z.number().int().min(0).max(1),\n  duration: z.number().int().positive(),\n}).omit({ id: true, createdAt: true });\n\nexport type InsertDictationTest = z.infer<typeof insertDictationTestSchema>;\nexport type DictationTest = typeof dictationTests.$inferSelect;\n\n// Stress Test Mode - For Advanced Users\nexport const stressTests = pgTable(\"stress_tests\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  difficulty: text(\"difficulty\").notNull(), // beginner, intermediate, expert, nightmare, impossible\n  enabledEffects: jsonb(\"enabled_effects\").notNull(), // {screenShake, distractions, sounds, speedIncrease, limitedVisibility, glitch, textFade, reverseText, randomJumps, etc}\n  wpm: integer(\"wpm\").notNull(),\n  accuracy: real(\"accuracy\").notNull(),\n  errors: integer(\"errors\").notNull(),\n  maxCombo: integer(\"max_combo\").notNull().default(0),\n  totalCharacters: integer(\"total_characters\").notNull(),\n  duration: integer(\"duration\").notNull(), // seconds\n  survivalTime: integer(\"survival_time\").notNull(), // how long they lasted before failing\n  completionRate: real(\"completion_rate\").notNull(), // percentage of test completed\n  stressScore: integer(\"stress_score\").notNull(), // calculated score based on difficulty + performance\n  createdAt: timestamp(\"created_at\").notNull().defaultNow(),\n}, (table) => ({\n  userIdIdx: index(\"stress_test_user_id_idx\").on(table.userId),\n  difficultyIdx: index(\"stress_test_difficulty_idx\").on(table.difficulty),\n  stressScoreIdx: index(\"stress_test_score_idx\").on(table.stressScore),\n  wpmIdx: index(\"stress_test_wpm_idx\").on(table.wpm),\n  createdAtIdx: index(\"stress_test_created_at_idx\").on(table.createdAt),\n}));\n\nexport const insertStressTestSchema = createInsertSchema(stressTests, {\n  difficulty: z.enum([\"beginner\", \"intermediate\", \"expert\", \"nightmare\", \"impossible\"]),\n  enabledEffects: z.object({\n    screenShake: z.boolean(),\n    distractions: z.boolean(),\n    sounds: z.boolean(),\n    speedIncrease: z.boolean(),\n    limitedVisibility: z.boolean(),\n    colorShift: z.boolean(),\n    gravity: z.boolean(),\n    rotation: z.boolean(),\n    glitch: z.boolean(),\n    textFade: z.boolean(),\n    reverseText: z.boolean(),\n    randomJumps: z.boolean(),\n    screenInvert: z.boolean(),\n    zoomChaos: z.boolean(),\n    screenFlip: z.boolean(),\n  }),\n  wpm: z.number().int().min(0).max(500),\n  accuracy: z.number().min(0).max(100),\n  errors: z.number().int().min(0),\n  maxCombo: z.number().int().min(0),\n  totalCharacters: z.number().int().min(0),\n  duration: z.number().int().positive(),\n  survivalTime: z.number().int().min(0),\n  completionRate: z.number().min(0).max(100),\n  stressScore: z.number().int().min(0),\n}).omit({ id: true, createdAt: true });\n\nexport type InsertStressTest = z.infer<typeof insertStressTestSchema>;\nexport type StressTest = typeof stressTests.$inferSelect;\n\n// Keystroke Analytics - Advanced Typing Performance Tracking\nexport const keystrokeEvents = pgTable(\"keystroke_events\", {\n  id: serial(\"id\").primaryKey(),\n  testResultId: integer(\"test_result_id\").references(() => testResults.id, { onDelete: \"cascade\" }),\n  key: varchar(\"key\", { length: 10 }).notNull(),\n  keyCode: varchar(\"key_code\", { length: 50 }).notNull(),\n  pressTime: bigint(\"press_time\", { mode: \"number\" }).notNull(), // ms timestamp\n  releaseTime: bigint(\"release_time\", { mode: \"number\" }), // ms timestamp (null if still pressed)\n  dwellTime: integer(\"dwell_time\"), // time key was held down (ms)\n  flightTime: integer(\"flight_time\"), // time since previous key release (ms)\n  isCorrect: boolean(\"is_correct\").notNull(),\n  expectedKey: varchar(\"expected_key\", { length: 10 }),\n  position: integer(\"position\").notNull(), // position in text\n  finger: varchar(\"finger\", { length: 20 }), // which finger used\n  hand: varchar(\"hand\", { length: 10 }), // left/right\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const typingAnalytics = pgTable(\"typing_analytics\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull(),\n  testResultId: integer(\"test_result_id\").references(() => testResults.id, { onDelete: \"cascade\" }),\n  \n  // Core Metrics\n  wpm: integer(\"wpm\").notNull(),\n  rawWpm: integer(\"raw_wpm\").notNull(), // includes errors\n  accuracy: real(\"accuracy\").notNull(),\n  consistency: real(\"consistency\"), // coefficient of variation (0-100)\n  \n  // Advanced Timing Metrics\n  avgDwellTime: real(\"avg_dwell_time\"), // average key hold time\n  avgFlightTime: real(\"avg_flight_time\"), // average inter-key latency\n  stdDevFlightTime: real(\"std_dev_flight_time\"), // rhythm variance\n  fastestDigraph: varchar(\"fastest_digraph\", { length: 10 }),\n  slowestDigraph: varchar(\"slowest_digraph\", { length: 10 }),\n  \n  // Finger Usage Distribution (JSON)\n  fingerUsage: jsonb(\"finger_usage\"), // {L_Pinky: 50, L_Ring: 30, ...}\n  handBalance: real(\"hand_balance\"), // % left vs right hand usage\n  \n  // Error Analysis\n  totalErrors: integer(\"total_errors\").notNull(),\n  errorsByType: jsonb(\"errors_by_type\"), // {substitution: 5, adjacent: 3, doublet: 2}\n  errorKeys: jsonb(\"error_keys\"), // array of problematic keys\n  \n  // Speed Variation\n  wpmByPosition: jsonb(\"wpm_by_position\"), // speed across text chunks\n  slowestWords: jsonb(\"slowest_words\"), // words typed slower than average\n  \n  // Keyboard Heatmap Data\n  keyHeatmap: jsonb(\"key_heatmap\"), // {A: 50, B: 12, ...} frequency counts\n  \n  // Enhanced Industry-Standard Metrics (Production-Ready)\n  burstWpm: integer(\"burst_wpm\"), // Peak 5-second WPM (like Monkeytype)\n  adjustedWpm: integer(\"adjusted_wpm\"), // WPM with error penalty\n  consistencyRating: integer(\"consistency_percentile\"), // Rhythm rating based on timing consistency (0-100)\n  rollingAccuracy: jsonb(\"rolling_accuracy\"), // Accuracy across 5 chunks\n  topDigraphs: jsonb(\"top_digraphs\"), // Top 5 fastest digraphs with timing\n  bottomDigraphs: jsonb(\"bottom_digraphs\"), // Top 5 slowest digraphs with timing  \n  typingRhythm: real(\"typing_rhythm\"), // Rhythm score (0-100)\n  peakPerformanceWindow: jsonb(\"peak_performance_window\"), // Best 20% window\n  fatigueIndicator: real(\"fatigue_indicator\"), // Speed drop % (positive=fatigue)\n  errorBurstCount: integer(\"error_burst_count\"), // Consecutive error sequences\n  \n  // Anti-Cheat Validation Flags (Production-Ready)\n  isSuspicious: boolean(\"is_suspicious\").default(false), // Overall suspicious flag\n  suspiciousFlags: jsonb(\"suspicious_flags\"), // Array of detected anomalies\n  validationScore: integer(\"validation_score\"), // 0-100 trustworthiness score\n  minKeystrokeInterval: integer(\"min_keystroke_interval\"), // Fastest interval (ms) - for inhuman detection\n  keystrokeVariance: real(\"keystroke_variance\"), // Variance in timing - too consistent = bot\n  syntheticInputDetected: boolean(\"synthetic_input_detected\").default(false), // Clipboard/macro detection\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const typingInsights = pgTable(\"typing_insights\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull(),\n  \n  // AI-Generated Insights\n  insightType: varchar(\"insight_type\", { length: 50 }).notNull(), // \"weakness\", \"strength\", \"recommendation\"\n  category: varchar(\"category\", { length: 50 }).notNull(), // \"speed\", \"accuracy\", \"rhythm\", \"ergonomics\"\n  title: varchar(\"title\", { length: 200 }).notNull(),\n  description: text(\"description\").notNull(),\n  actionable: text(\"actionable\"), // specific action to take\n  \n  // Supporting Data\n  confidence: real(\"confidence\"), // AI confidence score\n  affectedKeys: jsonb(\"affected_keys\"), // keys related to this insight\n  metric: varchar(\"metric\", { length: 50 }), // which metric triggered this\n  metricValue: real(\"metric_value\"),\n  \n  // Status\n  dismissed: boolean(\"dismissed\").default(false),\n  resolved: boolean(\"resolved\").default(false),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const practiceRecommendations = pgTable(\"practice_recommendations\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull(),\n  \n  // Recommendation Details\n  title: varchar(\"title\", { length: 200 }).notNull(),\n  description: text(\"description\").notNull(),\n  difficulty: varchar(\"difficulty\", { length: 20 }).notNull(), // easy, medium, hard\n  \n  // Practice Content\n  practiceText: text(\"practice_text\"), // custom generated text\n  focusKeys: jsonb(\"focus_keys\"), // keys to practice\n  focusDigraphs: jsonb(\"focus_digraphs\"), // letter combinations\n  \n  // Metrics\n  estimatedDuration: integer(\"estimated_duration\"), // minutes\n  targetWpm: integer(\"target_wpm\"),\n  completed: boolean(\"completed\").default(false),\n  completedAt: timestamp(\"completed_at\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Push Notification Subscriptions\nexport const pushSubscriptions = pgTable(\"push_subscriptions\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull(),\n  \n  // Web Push subscription data (JSON)\n  endpoint: text(\"endpoint\").notNull(),\n  expirationTime: bigint(\"expiration_time\", { mode: \"number\" }),\n  keys: jsonb(\"keys\").notNull(), // { p256dh, auth }\n  \n  // Metadata\n  userAgent: text(\"user_agent\"),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  lastUsed: timestamp(\"last_used\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// User Notification Preferences\nexport const notificationPreferences = pgTable(\"notification_preferences\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull().unique(),\n  \n  // Daily Reminders\n  dailyReminder: boolean(\"daily_reminder\").default(true).notNull(),\n  dailyReminderTime: varchar(\"daily_reminder_time\", { length: 5 }).default(\"09:00\"), // HH:MM format\n  \n  // Streak Notifications\n  streakWarning: boolean(\"streak_warning\").default(true).notNull(),\n  streakMilestone: boolean(\"streak_milestone\").default(true).notNull(),\n  \n  // Weekly Summaries\n  weeklySummary: boolean(\"weekly_summary\").default(true).notNull(),\n  weeklySummaryDay: varchar(\"weekly_summary_day\", { length: 10 }).default(\"sunday\"), // day of week\n  \n  // Achievements & Challenges\n  achievementUnlocked: boolean(\"achievement_unlocked\").default(true).notNull(),\n  challengeInvite: boolean(\"challenge_invite\").default(true).notNull(),\n  challengeComplete: boolean(\"challenge_complete\").default(true).notNull(),\n  \n  // Leaderboard & Social\n  leaderboardChange: boolean(\"leaderboard_change\").default(false).notNull(),\n  newPersonalRecord: boolean(\"new_personal_record\").default(true).notNull(),\n  \n  // Multiplayer\n  raceInvite: boolean(\"race_invite\").default(true).notNull(),\n  raceStarting: boolean(\"race_starting\").default(true).notNull(),\n  \n  // Community & Learning\n  socialUpdates: boolean(\"social_updates\").default(true).notNull(),\n  tipOfTheDay: boolean(\"tip_of_the_day\").default(true).notNull(),\n  \n  // User Preferences\n  timezone: varchar(\"timezone\", { length: 50 }).default(\"UTC\"),\n  quietHoursStart: varchar(\"quiet_hours_start\", { length: 5 }), // HH:MM format\n  quietHoursEnd: varchar(\"quiet_hours_end\", { length: 5 }), // HH:MM format\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Notification History (for tracking and preventing duplicates)\nexport const notificationHistory = pgTable(\"notification_history\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull(),\n  \n  // Notification Details\n  type: varchar(\"type\", { length: 50 }).notNull(), // daily_reminder, streak_warning, weekly_summary, etc.\n  title: varchar(\"title\", { length: 200 }).notNull(),\n  body: text(\"body\").notNull(),\n  data: jsonb(\"data\"), // Additional context data\n  \n  // Delivery Status\n  status: varchar(\"status\", { length: 20 }).default(\"sent\").notNull(), // sent, delivered, failed, clicked\n  errorMessage: text(\"error_message\"),\n  \n  // Engagement Tracking\n  sentAt: timestamp(\"sent_at\").defaultNow().notNull(),\n  deliveredAt: timestamp(\"delivered_at\"),\n  clickedAt: timestamp(\"clicked_at\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Notification Jobs Queue (for scheduled notifications)\nexport const notificationJobs = pgTable(\"notification_jobs\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull(),\n  \n  // Job Details\n  notificationType: varchar(\"notification_type\", { length: 50 }).notNull(), // daily_reminder, streak_warning, weekly_summary\n  sendAtUtc: timestamp(\"send_at_utc\").notNull(), // When to send in UTC\n  status: varchar(\"status\", { length: 20 }).default(\"pending\").notNull(), // pending, claimed, completed, failed\n  \n  // Retry Logic\n  attemptCount: integer(\"attempt_count\").default(0).notNull(),\n  lastAttemptAt: timestamp(\"last_attempt_at\"),\n  errorMessage: text(\"error_message\"),\n  \n  // Payload Metadata (cached to avoid requerying)\n  payloadMeta: jsonb(\"payload_meta\"), // { streak, avgWpm, etc. }\n  \n  // Timestamps\n  claimedAt: timestamp(\"claimed_at\"),\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => ({\n  sendAtStatusIdx: index(\"notification_jobs_send_at_status_idx\").on(table.sendAtUtc, table.status),\n  userIdTypeIdx: index(\"notification_jobs_user_id_type_idx\").on(table.userId, table.notificationType),\n}));\n\n// Achievements & Badges System\nexport const achievements = pgTable(\"achievements\", {\n  id: serial(\"id\").primaryKey(),\n  \n  // Achievement Details\n  key: varchar(\"key\", { length: 50 }).notNull().unique(), // speedster_100, streak_master_30, etc.\n  name: varchar(\"name\", { length: 100 }).notNull(),\n  description: text(\"description\").notNull(),\n  category: varchar(\"category\", { length: 50 }).notNull(), // speed, accuracy, consistency, streak, social\n  \n  // Requirements\n  tier: varchar(\"tier\", { length: 20 }).default(\"bronze\").notNull(), // bronze, silver, gold, platinum, diamond\n  requirement: jsonb(\"requirement\").notNull(), // { type: \"wpm\", value: 100 } or { type: \"streak\", value: 30 }\n  points: integer(\"points\").default(10).notNull(), // gamification points\n  \n  // Visual\n  icon: varchar(\"icon\", { length: 50 }).notNull(), // lucide icon name\n  color: varchar(\"color\", { length: 50 }).notNull(), // tailwind color class\n  \n  // Metadata\n  isSecret: boolean(\"is_secret\").default(false).notNull(), // hidden until unlocked\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// User Achievements (unlocked badges)\nexport const userAchievements = pgTable(\"user_achievements\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull(),\n  achievementId: integer(\"achievement_id\").references(() => achievements.id, { onDelete: \"cascade\" }).notNull(),\n  \n  // Unlock Details\n  unlockedAt: timestamp(\"unlocked_at\").defaultNow().notNull(),\n  testResultId: integer(\"test_result_id\").references(() => testResults.id, { onDelete: \"set null\" }),\n  \n  // Notification\n  notified: boolean(\"notified\").default(false).notNull(),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Daily/Weekly Challenges\nexport const challenges = pgTable(\"challenges\", {\n  id: serial(\"id\").primaryKey(),\n  \n  // Challenge Details\n  type: varchar(\"type\", { length: 20 }).notNull(), // daily, weekly, special\n  title: varchar(\"title\", { length: 200 }).notNull(),\n  description: text(\"description\").notNull(),\n  \n  // Requirements\n  goal: jsonb(\"goal\").notNull(), // { type: \"tests_completed\", target: 5 } or { type: \"wpm_reached\", target: 80 }\n  difficulty: varchar(\"difficulty\", { length: 20 }).default(\"medium\").notNull(), // easy, medium, hard, expert\n  \n  // Rewards\n  pointsReward: integer(\"points_reward\").default(50).notNull(),\n  badgeReward: varchar(\"badge_reward\", { length: 50 }), // optional achievement unlock\n  \n  // Timing\n  startDate: timestamp(\"start_date\").notNull(),\n  endDate: timestamp(\"end_date\").notNull(),\n  \n  // Metadata\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  category: varchar(\"category\", { length: 50 }).notNull(), // speed, accuracy, consistency, endurance\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// User Challenge Progress\nexport const userChallenges = pgTable(\"user_challenges\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull(),\n  challengeId: integer(\"challenge_id\").references(() => challenges.id, { onDelete: \"cascade\" }).notNull(),\n  \n  // Progress\n  progress: integer(\"progress\").default(0).notNull(), // current count toward goal\n  isCompleted: boolean(\"is_completed\").default(false).notNull(),\n  completedAt: timestamp(\"completed_at\"),\n  \n  // Notifications\n  startNotified: boolean(\"start_notified\").default(false).notNull(),\n  completionNotified: boolean(\"completion_notified\").default(false).notNull(),\n  \n  // Metadata\n  startedAt: timestamp(\"started_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// User Gamification Profile\nexport const userGamification = pgTable(\"user_gamification\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"cascade\" }).notNull().unique(),\n  \n  // Points & Level\n  totalPoints: integer(\"total_points\").default(0).notNull(),\n  level: integer(\"level\").default(1).notNull(),\n  experiencePoints: integer(\"experience_points\").default(0).notNull(), // XP toward next level\n  \n  // Statistics\n  totalAchievements: integer(\"total_achievements\").default(0).notNull(),\n  totalChallengesCompleted: integer(\"total_challenges_completed\").default(0).notNull(),\n  totalShares: integer(\"total_shares\").default(0).notNull(), // Social sharing count\n  \n  // Titles & Badges\n  currentTitle: varchar(\"current_title\", { length: 100 }), // \"Speed Demon\", \"Accuracy Master\", etc.\n  featuredBadges: jsonb(\"featured_badges\"), // array of achievement IDs to display on profile\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const insertKeystrokeEventSchema = createInsertSchema(keystrokeEvents).omit({ id: true, createdAt: true });\nexport const insertTypingAnalyticsSchema = createInsertSchema(typingAnalytics).omit({ id: true, createdAt: true });\nexport const insertTypingInsightSchema = createInsertSchema(typingInsights).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertPracticeRecommendationSchema = createInsertSchema(practiceRecommendations).omit({ id: true, createdAt: true });\nexport const insertPushSubscriptionSchema = createInsertSchema(pushSubscriptions).omit({ id: true, createdAt: true, updatedAt: true, expirationTime: true });\nexport const insertNotificationPreferencesSchema = createInsertSchema(notificationPreferences).omit({ id: true, createdAt: true, updatedAt: true });\nexport const updateNotificationPreferencesSchema = insertNotificationPreferencesSchema.omit({ userId: true }).partial();\nexport const insertNotificationHistorySchema = createInsertSchema(notificationHistory).omit({ id: true, createdAt: true });\nexport const insertNotificationJobSchema = createInsertSchema(notificationJobs).omit({ id: true, createdAt: true, claimedAt: true, completedAt: true });\nexport const insertAchievementSchema = createInsertSchema(achievements).omit({ id: true, createdAt: true });\nexport const insertUserAchievementSchema = createInsertSchema(userAchievements).omit({ id: true, createdAt: true, unlockedAt: true });\nexport const insertChallengeSchema = createInsertSchema(challenges).omit({ id: true, createdAt: true });\nexport const insertUserChallengeSchema = createInsertSchema(userChallenges).omit({ id: true, startedAt: true, updatedAt: true });\nexport const insertUserGamificationSchema = createInsertSchema(userGamification).omit({ id: true, createdAt: true, updatedAt: true });\n\nexport type InsertKeystrokeEvent = z.infer<typeof insertKeystrokeEventSchema>;\nexport type KeystrokeEvent = typeof keystrokeEvents.$inferSelect;\nexport type InsertTypingAnalytics = z.infer<typeof insertTypingAnalyticsSchema>;\nexport type TypingAnalytics = typeof typingAnalytics.$inferSelect;\nexport type InsertTypingInsight = z.infer<typeof insertTypingInsightSchema>;\nexport type TypingInsight = typeof typingInsights.$inferSelect;\nexport type InsertPracticeRecommendation = z.infer<typeof insertPracticeRecommendationSchema>;\nexport type PracticeRecommendation = typeof practiceRecommendations.$inferSelect;\nexport type InsertPushSubscription = z.infer<typeof insertPushSubscriptionSchema>;\nexport type PushSubscription = typeof pushSubscriptions.$inferSelect;\nexport type InsertNotificationPreferences = z.infer<typeof insertNotificationPreferencesSchema>;\nexport type NotificationPreferences = typeof notificationPreferences.$inferSelect;\nexport type InsertNotificationHistory = z.infer<typeof insertNotificationHistorySchema>;\nexport type NotificationHistory = typeof notificationHistory.$inferSelect;\nexport type InsertNotificationJob = z.infer<typeof insertNotificationJobSchema>;\nexport type NotificationJob = typeof notificationJobs.$inferSelect;\nexport type InsertAchievement = z.infer<typeof insertAchievementSchema>;\nexport type Achievement = typeof achievements.$inferSelect;\nexport type InsertUserAchievement = z.infer<typeof insertUserAchievementSchema>;\nexport type UserAchievement = typeof userAchievements.$inferSelect;\nexport type InsertChallenge = z.infer<typeof insertChallengeSchema>;\nexport type Challenge = typeof challenges.$inferSelect;\nexport type InsertUserChallenge = z.infer<typeof insertUserChallengeSchema>;\nexport type UserChallenge = typeof userChallenges.$inferSelect;\nexport type InsertUserGamification = z.infer<typeof insertUserGamificationSchema>;\nexport type UserGamification = typeof userGamification.$inferSelect;\n\n// ==========================================\n// ENTERPRISE FEEDBACK SYSTEM\n// ==========================================\n\n// Feedback Categories\nexport const feedbackCategories = pgTable(\"feedback_categories\", {\n  id: serial(\"id\").primaryKey(),\n  name: varchar(\"name\", { length: 100 }).notNull().unique(),\n  slug: varchar(\"slug\", { length: 50 }).notNull().unique(),\n  description: text(\"description\"),\n  icon: varchar(\"icon\", { length: 50 }), // lucide icon name\n  color: varchar(\"color\", { length: 20 }).default(\"blue\"),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  sortOrder: integer(\"sort_order\").default(0).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Main Feedback Table\nexport const feedback = pgTable(\"feedback\", {\n  id: serial(\"id\").primaryKey(),\n  \n  // Submitter Info (nullable for anonymous)\n  userId: varchar(\"user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  isAnonymous: boolean(\"is_anonymous\").default(false).notNull(),\n  contactEmail: varchar(\"contact_email\", { length: 255 }), // for follow-up on anonymous feedback\n  \n  // Feedback Content\n  categoryId: integer(\"category_id\").references(() => feedbackCategories.id, { onDelete: \"set null\" }),\n  subject: varchar(\"subject\", { length: 200 }).notNull(),\n  message: text(\"message\").notNull(),\n  \n  // Priority & Status\n  priority: varchar(\"priority\", { length: 20 }).default(\"medium\").notNull(), // low, medium, high, critical\n  status: varchar(\"status\", { length: 30 }).default(\"new\").notNull(), // new, under_review, in_progress, resolved, closed, wont_fix\n  \n  // AI Analysis\n  sentimentScore: real(\"sentiment_score\"), // -1 to 1 (negative to positive)\n  sentimentLabel: varchar(\"sentiment_label\", { length: 20 }), // negative, neutral, positive\n  aiCategoryId: integer(\"ai_category_id\").references(() => feedbackCategories.id, { onDelete: \"set null\" }),\n  aiSummary: text(\"ai_summary\"),\n  aiPriorityScore: real(\"ai_priority_score\"), // 0 to 1 for auto-escalation\n  aiTags: jsonb(\"ai_tags\").$type<string[]>(),\n  aiProcessedAt: timestamp(\"ai_processed_at\"),\n  \n  // Source & Context\n  source: varchar(\"source\", { length: 30 }).default(\"in_app\").notNull(), // in_app, email, widget, api\n  pageUrl: text(\"page_url\"),\n  browserInfo: jsonb(\"browser_info\"),\n  \n  // Anti-spam\n  ipAddress: varchar(\"ip_address\", { length: 45 }),\n  deviceFingerprint: varchar(\"device_fingerprint\", { length: 64 }),\n  \n  // Resolution\n  resolvedAt: timestamp(\"resolved_at\"),\n  resolvedByUserId: varchar(\"resolved_by_user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  resolutionNotes: text(\"resolution_notes\"),\n  userNotified: boolean(\"user_notified\").default(false).notNull(),\n  \n  // Metadata\n  isSpam: boolean(\"is_spam\").default(false).notNull(),\n  isArchived: boolean(\"is_archived\").default(false).notNull(),\n  upvotes: integer(\"upvotes\").default(0).notNull(),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  userIdIdx: index(\"feedback_user_id_idx\").on(table.userId),\n  categoryIdIdx: index(\"feedback_category_id_idx\").on(table.categoryId),\n  statusIdx: index(\"feedback_status_idx\").on(table.status),\n  priorityIdx: index(\"feedback_priority_idx\").on(table.priority),\n  sentimentIdx: index(\"feedback_sentiment_idx\").on(table.sentimentLabel),\n  createdAtIdx: index(\"feedback_created_at_idx\").on(table.createdAt),\n  statusPriorityIdx: index(\"feedback_status_priority_idx\").on(table.status, table.priority),\n}));\n\n// Feedback Attachments (screenshots, files)\nexport const feedbackAttachments = pgTable(\"feedback_attachments\", {\n  id: serial(\"id\").primaryKey(),\n  feedbackId: integer(\"feedback_id\").notNull().references(() => feedback.id, { onDelete: \"cascade\" }),\n  \n  // File Info\n  filename: varchar(\"filename\", { length: 255 }).notNull(),\n  originalFilename: varchar(\"original_filename\", { length: 255 }).notNull(),\n  mimeType: varchar(\"mime_type\", { length: 100 }).notNull(),\n  fileSize: integer(\"file_size\").notNull(),\n  storagePath: text(\"storage_path\").notNull(),\n  \n  // Security\n  uploadedByUserId: varchar(\"uploaded_by_user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  virusScanStatus: varchar(\"virus_scan_status\", { length: 20 }).default(\"pending\"), // pending, clean, infected\n  virusScanAt: timestamp(\"virus_scan_at\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => ({\n  feedbackIdIdx: index(\"feedback_attachments_feedback_id_idx\").on(table.feedbackId),\n}));\n\n// Admin Responses to Feedback\nexport const feedbackResponses = pgTable(\"feedback_responses\", {\n  id: serial(\"id\").primaryKey(),\n  feedbackId: integer(\"feedback_id\").notNull().references(() => feedback.id, { onDelete: \"cascade\" }),\n  \n  // Response Content\n  adminUserId: varchar(\"admin_user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  message: text(\"message\").notNull(),\n  isInternalNote: boolean(\"is_internal_note\").default(false).notNull(), // if true, not visible to user\n  \n  // Template Used (optional)\n  templateName: varchar(\"template_name\", { length: 100 }),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  feedbackIdIdx: index(\"feedback_responses_feedback_id_idx\").on(table.feedbackId),\n  adminUserIdIdx: index(\"feedback_responses_admin_user_id_idx\").on(table.adminUserId),\n}));\n\n// Status History / Audit Trail\nexport const feedbackStatusHistory = pgTable(\"feedback_status_history\", {\n  id: serial(\"id\").primaryKey(),\n  feedbackId: integer(\"feedback_id\").notNull().references(() => feedback.id, { onDelete: \"cascade\" }),\n  \n  // Change Details\n  previousStatus: varchar(\"previous_status\", { length: 30 }),\n  newStatus: varchar(\"new_status\", { length: 30 }).notNull(),\n  previousPriority: varchar(\"previous_priority\", { length: 20 }),\n  newPriority: varchar(\"new_priority\", { length: 20 }),\n  \n  // Actor\n  changedByUserId: varchar(\"changed_by_user_id\").references(() => users.id, { onDelete: \"set null\" }),\n  changeReason: text(\"change_reason\"),\n  isAutomated: boolean(\"is_automated\").default(false).notNull(),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => ({\n  feedbackIdIdx: index(\"feedback_status_history_feedback_id_idx\").on(table.feedbackId),\n  createdAtIdx: index(\"feedback_status_history_created_at_idx\").on(table.createdAt),\n}));\n\n// Feedback Analytics (aggregated stats)\nexport const feedbackAnalytics = pgTable(\"feedback_analytics\", {\n  id: serial(\"id\").primaryKey(),\n  \n  // Time Period\n  periodType: varchar(\"period_type\", { length: 20 }).notNull(), // daily, weekly, monthly\n  periodStart: timestamp(\"period_start\").notNull(),\n  periodEnd: timestamp(\"period_end\").notNull(),\n  \n  // Volume Metrics\n  totalFeedback: integer(\"total_feedback\").default(0).notNull(),\n  newFeedback: integer(\"new_feedback\").default(0).notNull(),\n  resolvedFeedback: integer(\"resolved_feedback\").default(0).notNull(),\n  \n  // Breakdown by Category\n  categoryBreakdown: jsonb(\"category_breakdown\").$type<Record<string, number>>(),\n  \n  // Breakdown by Priority\n  priorityBreakdown: jsonb(\"priority_breakdown\").$type<Record<string, number>>(),\n  \n  // Breakdown by Status\n  statusBreakdown: jsonb(\"status_breakdown\").$type<Record<string, number>>(),\n  \n  // Sentiment Analysis\n  sentimentBreakdown: jsonb(\"sentiment_breakdown\").$type<{ negative: number; neutral: number; positive: number }>(),\n  averageSentimentScore: real(\"average_sentiment_score\"),\n  \n  // Resolution Metrics\n  averageResolutionTimeHours: real(\"average_resolution_time_hours\"),\n  firstResponseTimeHours: real(\"first_response_time_hours\"),\n  \n  // Source Breakdown\n  sourceBreakdown: jsonb(\"source_breakdown\").$type<Record<string, number>>(),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  periodTypeIdx: index(\"feedback_analytics_period_type_idx\").on(table.periodType),\n  periodStartIdx: index(\"feedback_analytics_period_start_idx\").on(table.periodStart),\n  periodTypeStartIdx: index(\"feedback_analytics_period_type_start_idx\").on(table.periodType, table.periodStart),\n}));\n\n// Feedback Upvotes (for feature requests)\nexport const feedbackUpvotes = pgTable(\"feedback_upvotes\", {\n  id: serial(\"id\").primaryKey(),\n  feedbackId: integer(\"feedback_id\").notNull().references(() => feedback.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n}, (table) => ({\n  feedbackUserIdx: index(\"feedback_upvotes_feedback_user_idx\").on(table.feedbackId, table.userId),\n}));\n\n// Feedback Rate Limiting\nexport const feedbackRateLimits = pgTable(\"feedback_rate_limits\", {\n  id: serial(\"id\").primaryKey(),\n  identifier: varchar(\"identifier\", { length: 100 }).notNull(), // IP or user ID\n  identifierType: varchar(\"identifier_type\", { length: 20 }).notNull(), // ip, user\n  submissionCount: integer(\"submission_count\").default(0).notNull(),\n  windowStart: timestamp(\"window_start\").notNull(),\n  lastSubmission: timestamp(\"last_submission\"),\n  isBlocked: boolean(\"is_blocked\").default(false).notNull(),\n  blockedUntil: timestamp(\"blocked_until\"),\n  blockedReason: varchar(\"blocked_reason\", { length: 200 }),\n});\n\n// Admin users for feedback management (role-based)\nexport const feedbackAdmins = pgTable(\"feedback_admins\", {\n  id: serial(\"id\").primaryKey(),\n  userId: varchar(\"user_id\").notNull().unique().references(() => users.id, { onDelete: \"cascade\" }),\n  role: varchar(\"role\", { length: 20 }).default(\"moderator\").notNull(), // viewer, moderator, admin, super_admin\n  canRespond: boolean(\"can_respond\").default(true).notNull(),\n  canChangeStatus: boolean(\"can_change_status\").default(true).notNull(),\n  canChangePriority: boolean(\"can_change_priority\").default(true).notNull(),\n  canDelete: boolean(\"can_delete\").default(false).notNull(),\n  canManageAdmins: boolean(\"can_manage_admins\").default(false).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n}, (table) => ({\n  userIdIdx: index(\"feedback_admins_user_id_idx\").on(table.userId),\n}));\n\n// Insert Schemas\nexport const insertFeedbackCategorySchema = createInsertSchema(feedbackCategories).omit({ id: true, createdAt: true });\nexport const insertFeedbackSchema = createInsertSchema(feedback).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertFeedbackAttachmentSchema = createInsertSchema(feedbackAttachments).omit({ id: true, createdAt: true });\nexport const insertFeedbackResponseSchema = createInsertSchema(feedbackResponses).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertFeedbackStatusHistorySchema = createInsertSchema(feedbackStatusHistory).omit({ id: true, createdAt: true });\nexport const insertFeedbackAnalyticsSchema = createInsertSchema(feedbackAnalytics).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertFeedbackUpvoteSchema = createInsertSchema(feedbackUpvotes).omit({ id: true, createdAt: true });\nexport const insertFeedbackAdminSchema = createInsertSchema(feedbackAdmins).omit({ id: true, createdAt: true, updatedAt: true });\n\n// Types\nexport type InsertFeedbackCategory = z.infer<typeof insertFeedbackCategorySchema>;\nexport type FeedbackCategory = typeof feedbackCategories.$inferSelect;\nexport type InsertFeedback = z.infer<typeof insertFeedbackSchema>;\nexport type Feedback = typeof feedback.$inferSelect;\nexport type InsertFeedbackAttachment = z.infer<typeof insertFeedbackAttachmentSchema>;\nexport type FeedbackAttachment = typeof feedbackAttachments.$inferSelect;\nexport type InsertFeedbackResponse = z.infer<typeof insertFeedbackResponseSchema>;\nexport type FeedbackResponse = typeof feedbackResponses.$inferSelect;\nexport type InsertFeedbackStatusHistory = z.infer<typeof insertFeedbackStatusHistorySchema>;\nexport type FeedbackStatusHistory = typeof feedbackStatusHistory.$inferSelect;\nexport type InsertFeedbackAnalytics = z.infer<typeof insertFeedbackAnalyticsSchema>;\nexport type FeedbackAnalytics = typeof feedbackAnalytics.$inferSelect;\nexport type InsertFeedbackUpvote = z.infer<typeof insertFeedbackUpvoteSchema>;\nexport type FeedbackUpvote = typeof feedbackUpvotes.$inferSelect;\nexport type InsertFeedbackAdmin = z.infer<typeof insertFeedbackAdminSchema>;\nexport type FeedbackAdmin = typeof feedbackAdmins.$inferSelect;\n\n// Validation Schemas for API\nexport const submitFeedbackSchema = z.object({\n  categoryId: z.number().int().positive().optional(),\n  subject: z.string().min(5, \"Subject must be at least 5 characters\").max(200, \"Subject must be less than 200 characters\"),\n  message: z.string().min(20, \"Message must be at least 20 characters\").max(5000, \"Message must be less than 5000 characters\"),\n  priority: z.enum([\"low\", \"medium\", \"high\", \"critical\"]).default(\"medium\"),\n  isAnonymous: z.boolean().default(false),\n  contactEmail: z.string().email().optional().nullable(),\n  pageUrl: z.string().url().optional().nullable(),\n  honeypot: z.string().optional(), // anti-spam field (should be empty)\n});\n\nexport const updateFeedbackStatusSchema = z.object({\n  status: z.enum([\"new\", \"under_review\", \"in_progress\", \"resolved\", \"closed\", \"wont_fix\"]),\n  priority: z.enum([\"low\", \"medium\", \"high\", \"critical\"]).optional(),\n  changeReason: z.string().max(500).optional(),\n  resolutionNotes: z.string().max(2000).optional(),\n  notifyUser: z.boolean().default(false),\n});\n\nexport const feedbackResponseSchema = z.object({\n  message: z.string().min(10, \"Response must be at least 10 characters\").max(5000, \"Response must be less than 5000 characters\"),\n  isInternalNote: z.boolean().default(false),\n  templateName: z.string().max(100).optional(),\n});\n\nexport type SubmitFeedbackInput = z.infer<typeof submitFeedbackSchema>;\nexport type UpdateFeedbackStatusInput = z.infer<typeof updateFeedbackStatusSchema>;\nexport type FeedbackResponseInput = z.infer<typeof feedbackResponseSchema>;\n","path":null,"size_bytes":90840,"size_tokens":null},"server/ai-paragraph-generator.ts":{"content":"import OpenAI from \"openai\";\n\n// This is using Replit's AI Integrations service, which provides OpenAI-compatible API access without requiring your own OpenAI API key.\nconst openai = new OpenAI({\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY\n});\n\n// Diverse subtopics for each mode to ensure variety\nconst MODE_SUBTOPICS: Record<string, string[]> = {\n  general: [\n    // Technology & Digital Life (Trending 2025)\n    \"how AI is changing everyday tasks\",\n    \"understanding algorithms and recommendations\",\n    \"digital wellness and screen time balance\",\n    \"online privacy and data protection\",\n    \"how the internet works\",\n    \"social media and mental health\",\n    \"virtual reality and the metaverse\",\n    \"smart homes and IoT devices\",\n    \"cybersecurity basics for everyone\",\n    \"the future of smartphones and gadgets\",\n    \"cloud storage and digital backups\",\n    \"understanding cryptocurrency basics\",\n    \n    // Friendship & Relationships\n    \"building strong friendships\",\n    \"effective communication in the digital age\",\n    \"active listening skills\",\n    \"resolving conflicts peacefully\",\n    \"supporting friends through challenges\",\n    \"celebrating diversity in friendships\",\n    \"maintaining long-distance relationships\",\n    \"trust and honesty in relationships\",\n    \n    // Personal Growth & Mindset\n    \"developing good daily habits\",\n    \"time management strategies\",\n    \"setting achievable goals\",\n    \"overcoming procrastination\",\n    \"learning from failure\",\n    \"growth mindset vs fixed mindset\",\n    \"building self-confidence\",\n    \"managing stress effectively\",\n    \"the power of gratitude\",\n    \"developing emotional intelligence\",\n    \n    // Mental Health & Well-Being (High Engagement 2025)\n    \"understanding anxiety and coping strategies\",\n    \"mindfulness and meditation basics\",\n    \"the importance of sleep\",\n    \"recognizing burnout and recovery\",\n    \"building resilience\",\n    \"positive self-talk techniques\",\n    \"healthy ways to express emotions\",\n    \"dealing with social pressure\",\n    \"the importance of asking for help\",\n    \"self-care routines that work\",\n    \n    // Career & Future Skills (92% value soft skills)\n    \"teamwork and collaboration\",\n    \"creative problem solving\",\n    \"critical thinking in daily life\",\n    \"public speaking confidence\",\n    \"leadership skills for everyone\",\n    \"adapting to change\",\n    \"continuous learning mindset\",\n    \"work-life balance strategies\",\n    \"networking and building connections\",\n    \"interview skills and preparation\",\n    \n    // Science & Discovery (Sparks Curiosity)\n    \"how vaccines work\",\n    \"fascinating facts about the human brain\",\n    \"the science of sleep and dreams\",\n    \"climate change explained simply\",\n    \"renewable energy basics\",\n    \"space exploration milestones\",\n    \"how plants communicate\",\n    \"the mystery of black holes\",\n    \"ocean depths and unexplored regions\",\n    \"the science behind emotions\",\n    \n    // Life Skills & Financial Literacy\n    \"budgeting basics for beginners\",\n    \"understanding credit and debt\",\n    \"smart saving strategies\",\n    \"investing fundamentals\",\n    \"healthy eating on a budget\",\n    \"meal planning and cooking skills\",\n    \"sustainable living choices\",\n    \"first aid essentials\",\n    \"home organization tips\",\n    \n    // Culture, Society & Global Awareness\n    \"celebrating cultural diversity\",\n    \"famous festivals around the world\",\n    \"how music shapes cultures\",\n    \"art movements that changed history\",\n    \"languages and their evolution\",\n    \"environmental activism\",\n    \"volunteering and community impact\",\n    \"human rights and equality\",\n    \"immigration stories and experiences\",\n    \n    // Entertainment & Creativity\n    \"the psychology of storytelling\",\n    \"how movies influence society\",\n    \"music and brain development\",\n    \"photography basics and composition\",\n    \"creative writing techniques\",\n    \"the rise of podcasts\",\n    \"gaming and problem-solving skills\",\n    \n    // Current Trends & Innovations\n    \"electric vehicles and transportation\",\n    \"sustainable fashion movement\",\n    \"urban gardening and farming\",\n    \"the sharing economy\",\n    \"remote work revolution\",\n    \"social entrepreneurship\",\n    \"biotechnology breakthroughs\",\n    \"renewable energy innovations\",\n    \"food delivery and ghost kitchens\",\n    \"personalized medicine advances\"\n  ],\n  entertainment: [\n    \"streaming services and binge-watching\",\n    \"video games and esports\",\n    \"movies and cinema\",\n    \"music festivals and concerts\",\n    \"social media trends\",\n    \"podcasts and audio content\",\n    \"comedy and standup\",\n    \"theater and performing arts\",\n    \"celebrity culture\",\n    \"animation and cartoons\",\n    \"fan communities\",\n    \"virtual reality entertainment\",\n    \"board games and tabletop gaming\",\n    \"theme parks and attractions\",\n    \"karaoke and singing\"\n  ],\n  technical: [\n    \"artificial intelligence and machine learning\",\n    \"cloud computing and services\",\n    \"cybersecurity and privacy\",\n    \"internet of things (IoT)\",\n    \"blockchain and cryptocurrency\",\n    \"5G networks and connectivity\",\n    \"quantum computing\",\n    \"renewable energy technology\",\n    \"biotechnology innovations\",\n    \"space exploration technology\",\n    \"robotics and automation\",\n    \"augmented and virtual reality\",\n    \"edge computing and distributed systems\",\n    \"nanotechnology applications\",\n    \"3D printing and additive manufacturing\"\n  ],\n  quotes: [\n    \"perseverance and determination\",\n    \"creativity and innovation\",\n    \"kindness and compassion\",\n    \"courage and bravery\",\n    \"wisdom and knowledge\",\n    \"success and achievement\",\n    \"happiness and joy\",\n    \"leadership and influence\",\n    \"mindfulness and peace\",\n    \"change and growth\",\n    \"gratitude and appreciation\",\n    \"integrity and honesty\",\n    \"resilience and strength\",\n    \"love and relationships\",\n    \"purpose and meaning\"\n  ],\n  programming: [\n    \"web development frameworks\",\n    \"mobile app development\",\n    \"database design and optimization\",\n    \"API design and REST principles\",\n    \"version control and Git\",\n    \"testing and quality assurance\",\n    \"agile and scrum methodologies\",\n    \"DevOps and CI/CD\",\n    \"clean code principles\",\n    \"design patterns\",\n    \"microservices architecture\",\n    \"software security best practices\",\n    \"code review and collaboration\",\n    \"performance optimization techniques\",\n    \"containerization and orchestration\"\n  ],\n  news: [\n    \"climate change initiatives\",\n    \"technological breakthroughs\",\n    \"global health developments\",\n    \"economic trends\",\n    \"education reform\",\n    \"renewable energy progress\",\n    \"space exploration milestones\",\n    \"wildlife conservation\",\n    \"urban development\",\n    \"scientific discoveries\",\n    \"transportation innovations\",\n    \"social movements\",\n    \"cultural heritage preservation\",\n    \"sustainable agriculture\",\n    \"disaster relief and preparedness\"\n  ],\n  stories: [\n    \"a mysterious discovery\",\n    \"an unexpected journey\",\n    \"overcoming a challenge\",\n    \"a heartwarming encounter\",\n    \"a lesson learned\",\n    \"childhood memories\",\n    \"an adventure in nature\",\n    \"meeting a mentor\",\n    \"solving a puzzle\",\n    \"a day that changed everything\",\n    \"finding hidden talents\",\n    \"a second chance\",\n    \"breaking free from comfort zones\",\n    \"an act of kindness\",\n    \"pursuing a dream\"\n  ],\n  business: [\n    \"remote work and hybrid models\",\n    \"startup entrepreneurship\",\n    \"digital marketing strategies\",\n    \"customer experience\",\n    \"sustainable business practices\",\n    \"leadership development\",\n    \"project management\",\n    \"workplace diversity and inclusion\",\n    \"business ethics\",\n    \"innovation and disruption\",\n    \"supply chain management\",\n    \"data-driven decision making\",\n    \"corporate social responsibility\",\n    \"employee engagement and retention\",\n    \"strategic planning and execution\"\n  ]\n};\n\n// Helper function to count words (used for logging only)\nfunction countWords(text: string): number {\n  return text.trim().split(/\\s+/).filter(word => word.length > 0).length;\n}\n\nexport async function generateTypingParagraph(\n  language: string,\n  mode: string,\n  difficulty: \"easy\" | \"medium\" | \"hard\" = \"medium\",\n  customPrompt?: string\n): Promise<string> {\n  const languageNames: Record<string, string> = {\n    en: \"English\",\n    es: \"Spanish\",\n    fr: \"French\",\n    de: \"German\",\n    it: \"Italian\",\n    pt: \"Portuguese\",\n    ja: \"Japanese\",\n    zh: \"Chinese (Simplified)\",\n    hi: \"Hindi\",\n    ru: \"Russian\",\n    ar: \"Arabic\",\n    ko: \"Korean\",\n    mr: \"Marathi\",\n    bn: \"Bengali\",\n    ta: \"Tamil\",\n    te: \"Telugu\",\n    vi: \"Vietnamese\",\n    tr: \"Turkish\",\n    pl: \"Polish\",\n    nl: \"Dutch\",\n    sv: \"Swedish\",\n    th: \"Thai\",\n    id: \"Indonesian\",\n  };\n\n  const languageName = languageNames[language] || language;\n  \n  // Difficulty-specific writing guidelines (no word count limits - focus on complexity)\n  const difficultyGuidelines: Record<string, string> = {\n    easy: `- Use simple, common vocabulary that's easy to understand\n- Write short, clear sentences (8-12 words per sentence)\n- Focus on basic concepts and straightforward ideas\n- Use everyday language without technical jargon\n- Structure should be simple: introduce topic, explain briefly, conclude`,\n    \n    medium: `- Use moderate vocabulary with some varied word choices\n- Mix short and medium-length sentences (10-15 words average)\n- Include intermediate concepts and some detail\n- Occasional specialized terms are okay but explain them\n- Structure should be clear: introduce topic, develop ideas, provide examples`,\n    \n    hard: `- Use advanced, sophisticated vocabulary and precise terminology\n- Write complex sentences with varied structure (12-20 words average)\n- Include nuanced concepts, technical details, and deeper insights\n- Use specialized terminology appropriate to the subject\n- Structure should be sophisticated: introduce complex ideas, analyze deeply, draw connections`\n  };\n  \n  // Select a random subtopic for variety\n  const subtopics = MODE_SUBTOPICS[mode] || MODE_SUBTOPICS[\"general\"];\n  const randomSubtopic = subtopics[Math.floor(Math.random() * subtopics.length)];\n\n  let prompt: string;\n  \n  if (customPrompt) {\n    // Custom user-specified content\n    const scriptNote = language !== 'en' ? ` Use appropriate script (Devanagari for Hindi/Marathi, Arabic script for Arabic, etc.).` : '';\n    \n    prompt = `Write a ${difficulty}-level paragraph about: \"${customPrompt}\".\n\nCRITICAL REQUIREMENTS:\n1. Use proper grammar and natural sentence structure appropriate for ${difficulty} level\n2. Make it engaging and educational about the topic: \"${customPrompt}\"${scriptNote}\n3. Focus specifically on the user's requested topic: \"${customPrompt}\"\n4. Write ONLY about \"${customPrompt}\" - do NOT mention typing, keyboards, or practice\n5. Write a complete paragraph with natural length based on the content and difficulty level\n\n${difficulty.toUpperCase()} DIFFICULTY GUIDELINES:\n${difficultyGuidelines[difficulty]}\n\nReturn ONLY the paragraph text, no explanations or meta-commentary.`;\n  } else {\n    // Standard mode-based content with random subtopic for variety\n    const scriptNote = language !== 'en' ? ` Use appropriate script (Devanagari for Hindi/Marathi, Arabic script for Arabic, etc.).` : '';\n    \n    // Extra guidance for general mode to make content educational and engaging\n    const generalModeGuidance = mode === \"general\" ? `\n\nEDUCATIONAL FOCUS (Important for General Mode):\n- Help the reader LEARN something valuable about this topic\n- Include practical insights, interesting facts, or useful knowledge\n- Make the content relatable and applicable to real life\n- Inspire curiosity or provide actionable takeaways\n- Write as if teaching a friend something interesting and useful` : '';\n    \n    prompt = `Write a ${difficulty}-level paragraph in ${languageName} about \"${randomSubtopic}\" (${mode} category).\n\nCRITICAL REQUIREMENTS:\n1. Use proper grammar and natural sentence structure appropriate for ${difficulty} level\n2. Make it engaging, informative, and educational about \"${randomSubtopic}\"${scriptNote}\n3. Focus specifically on the subtopic \"${randomSubtopic}\" - provide interesting facts, insights, or perspectives that help users LEARN\n4. Avoid generic content - make it specific, engaging, and valuable about this particular subtopic\n5. Write ONLY about \"${randomSubtopic}\" - do NOT mention typing, keyboards, or practice\n6. Write a complete paragraph with natural length based on the content and difficulty level${generalModeGuidance}\n\n${difficulty.toUpperCase()} DIFFICULTY GUIDELINES:\n${difficultyGuidelines[difficulty]}\n\nReturn ONLY the paragraph text, no explanations or meta-commentary.`;\n  }\n\n  // Expert system prompt to prevent typing-related content and emphasize educational value\n  const systemPrompt = `You are an expert educator and content writer who creates engaging, valuable paragraphs that help people LEARN while they read.\n\nYOUR MISSION:\n- Every paragraph should teach the reader something useful, interesting, or valuable\n- Write as if explaining fascinating topics to a curious friend\n- Include practical insights, surprising facts, or actionable knowledge\n- Make learning enjoyable and relatable to real life\n\nMULTI-LANGUAGE & CULTURAL ADAPTATION:\n- When writing in ANY language, adapt the content to be culturally relevant and respectful\n- Use examples, references, and contexts that resonate with speakers of that language\n- Ensure topics are universally relatable while honoring cultural nuances\n- All 95 topics (technology, mental health, career skills, science, culture, etc.) are universal concepts - adapt them naturally to the target language and culture\n- Write with cultural sensitivity and awareness for the language's native speakers\n\nCRITICAL RULES:\n1. NEVER mention typing, keyboards, typing practice, typing speed, accuracy, or any typing-related concepts\n2. Focus ONLY on the specified topic - write informative, educational content that helps users learn\n3. Write naturally as if creating general knowledge content, NOT practice material\n4. Use proper grammar and clear sentences suitable for reading\n5. Make content engaging, factual, and EDUCATIONAL about the actual subject matter\n6. Help readers gain knowledge, insights, or practical understanding\n7. Adapt content culturally for the target language while maintaining universal relevance\n\nFORBIDDEN WORDS (never use these): typing, keyboard, type, practice, speed, accuracy, WPM, keys, keystroke\n\nYour role is to educate and engage readers with interesting, valuable content about meaningful topics across ALL languages and cultures.`;\n\n  const maxRetries = 3;\n  let attempt = 0;\n\n  try {\n    if (!customPrompt) {\n      console.log(`ðŸ“ Generating ${languageName}/${mode} paragraph about: \"${randomSubtopic}\" (${difficulty} difficulty)`);\n    }\n    \n    // Retry loop for content validation (forbidden terms only)\n    while (attempt < maxRetries) {\n      attempt++;\n      console.log(`ðŸ“ Generation attempt ${attempt}/${maxRetries} - ${difficulty} difficulty`);\n      \n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o\",\n        messages: [\n          { role: \"system\", content: systemPrompt },\n          { role: \"user\", content: prompt }\n        ],\n        max_tokens: 500,\n        temperature: 0.9,\n      });\n      \n      const content = response.choices[0]?.message?.content?.trim() || \"\";\n      \n      if (!content) {\n        console.error(\"Empty content from AI. Full response:\", JSON.stringify(response));\n        if (attempt === maxRetries) {\n          throw new Error(\"AI generated empty content after all retries\");\n        }\n        continue;\n      }\n\n      // Count words for logging\n      const wordCount = countWords(content);\n      console.log(`ðŸ“Š Generated content: ${wordCount} words`);\n\n      // Validate content doesn't contain typing-related terms\n      const forbiddenTerms = ['typing', 'keyboard', 'type', 'practice', ' wpm', 'keystroke', 'accuracy', 'speed test'];\n      const lowerContent = content.toLowerCase();\n      const foundTerms = forbiddenTerms.filter(term => lowerContent.includes(term));\n      \n      if (foundTerms.length > 0) {\n        console.warn(`âš ï¸ AI generated content with forbidden terms: ${foundTerms.join(', ')}`);\n        console.warn(`Content: ${content.substring(0, 200)}...`);\n        if (attempt === maxRetries) {\n          throw new Error(`Generated content contains typing-related terms: ${foundTerms.join(', ')}`);\n        }\n        continue;\n      }\n\n      // Success - content validated\n      console.log(`âœ… Generated ${wordCount} words for ${languageName}/${mode} (difficulty: ${difficulty})`);\n      console.log(`âœ… Content validated - no typing-related terms`);\n      return content;\n    }\n\n    // Should never reach here, but just in case\n    throw new Error(\"Unexpected error in generation loop\");\n  } catch (error: any) {\n    console.error(\"âŒ AI paragraph generation error:\", error.message || error);\n    if (error.response) {\n      console.error(\"API Error Response:\", error.response.data);\n    }\n    throw error;\n  }\n}\n","path":null,"size_bytes":17195,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/pages/cookie-policy.tsx":{"content":"import { Link } from \"wouter\";\n\nexport default function CookiePolicy() {\n  return (\n    <div className=\"max-w-4xl mx-auto\" data-testid=\"page-cookie-policy\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-4xl font-bold mb-2\" data-testid=\"heading-cookie-policy\">Cookie Policy</h1>\n        <p className=\"text-muted-foreground text-sm mb-4\">Last Updated: December 9, 2025</p>\n        <p className=\"text-muted-foreground text-lg\">\n          This Cookie Policy explains how TypeMasterAI uses cookies and similar technologies to recognize you when you visit our platform.\n        </p>\n      </div>\n\n      <div className=\"space-y-10 prose prose-invert max-w-none\">\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">1. What Are Cookies?</h2>\n          <p className=\"text-muted-foreground\">\n            Cookies are small text files that are placed on your device (computer, smartphone, or tablet) when you visit a website. They help websites remember your preferences and improve your browsing experience.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">2. Types of Cookies We Use</h2>\n          \n          <h3 className=\"text-xl font-semibold text-foreground mb-3\">2.1 Strictly Necessary Cookies</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            These cookies are essential for the platform to function properly and cannot be disabled.\n          </p>\n          <div className=\"bg-card/30 p-4 rounded-lg border border-border space-y-3\">\n            <div>\n              <p className=\"font-semibold text-foreground\">Session Cookies</p>\n              <p className=\"text-sm text-muted-foreground\">Used for authentication and maintaining your login state</p>\n              <p className=\"text-xs text-muted-foreground mt-1\">Duration: Session (deleted when browser closes)</p>\n            </div>\n            <div>\n              <p className=\"font-semibold text-foreground\">Security Cookies</p>\n              <p className=\"text-sm text-muted-foreground\">Protect against CSRF attacks and ensure secure connections</p>\n              <p className=\"text-xs text-muted-foreground mt-1\">Duration: Session to 1 day</p>\n            </div>\n          </div>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">2.2 Functional Cookies</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            These cookies enable enhanced functionality and personalization.\n          </p>\n          <div className=\"bg-card/30 p-4 rounded-lg border border-border space-y-3\">\n            <div>\n              <p className=\"font-semibold text-foreground\">Theme Preference</p>\n              <p className=\"text-sm text-muted-foreground\">Remembers your dark/light mode preference</p>\n              <p className=\"text-xs text-muted-foreground mt-1\">Cookie name: <code className=\"bg-accent px-1 rounded\">typemasterai-theme</code></p>\n              <p className=\"text-xs text-muted-foreground\">Duration: 1 year</p>\n            </div>\n            <div>\n              <p className=\"font-semibold text-foreground\">Test Settings</p>\n              <p className=\"text-sm text-muted-foreground\">Saves your preferred language, mode, and test duration</p>\n              <p className=\"text-xs text-muted-foreground mt-1\">Duration: 30 days</p>\n            </div>\n            <div>\n              <p className=\"font-semibold text-foreground\">User Preferences</p>\n              <p className=\"text-sm text-muted-foreground\">Stores keyboard layout, country, and other profile settings</p>\n              <p className=\"text-xs text-muted-foreground mt-1\">Duration: 90 days</p>\n            </div>\n          </div>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">2.3 Analytics Cookies</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            These cookies help us understand how visitors interact with our platform.\n          </p>\n          <div className=\"bg-card/30 p-4 rounded-lg border border-border space-y-3\">\n            <div>\n              <p className=\"font-semibold text-foreground\">Usage Analytics</p>\n              <p className=\"text-sm text-muted-foreground\">Tracks page views, test completions, and feature usage</p>\n              <p className=\"text-xs text-muted-foreground mt-1\">Duration: 2 years</p>\n            </div>\n            <div>\n              <p className=\"font-semibold text-foreground\">Performance Metrics</p>\n              <p className=\"text-sm text-muted-foreground\">Monitors load times, errors, and system performance</p>\n              <p className=\"text-xs text-muted-foreground mt-1\">Duration: 1 year</p>\n            </div>\n          </div>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">2.4 Local Storage</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            We also use browser local storage for:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Caching typing test paragraphs for offline access</li>\n            <li>Storing temporary test state (current progress, time remaining)</li>\n            <li>Saving draft messages in AI chat</li>\n            <li>Maintaining UI state (sidebar collapse, dialog positions)</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">3. Third-Party Cookies</h2>\n          \n          <h3 className=\"text-xl font-semibold text-foreground mb-3\">3.1 Third-Party AI Services</h3>\n          <p className=\"text-muted-foreground\">\n            When you use our AI features (chat assistant, content generation), our third-party AI service providers may set cookies to process your requests. These are governed by their respective privacy policies.\n          </p>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">3.2 Hosting and Infrastructure</h3>\n          <p className=\"text-muted-foreground\">\n            Our hosting provider (Replit) may use cookies for security, load balancing, and service delivery. We do not control these third-party cookies.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">4. Why We Use Cookies</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            We use cookies to:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Keep you logged in:</strong> Maintain your authenticated session across pages</li>\n            <li><strong className=\"text-foreground\">Remember your preferences:</strong> Save your theme, language, and test settings</li>\n            <li><strong className=\"text-foreground\">Improve security:</strong> Prevent unauthorized access and protect against attacks</li>\n            <li><strong className=\"text-foreground\">Analyze usage:</strong> Understand how users interact with features to improve the platform</li>\n            <li><strong className=\"text-foreground\">Personalize experience:</strong> Show relevant content and recommendations</li>\n            <li><strong className=\"text-foreground\">Track progress:</strong> Save your typing test history and statistics</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">5. Managing Cookies</h2>\n          \n          <h3 className=\"text-xl font-semibold text-foreground mb-3\">5.1 Browser Settings</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            You can control and manage cookies through your browser settings:\n          </p>\n          <div className=\"bg-card/30 p-4 rounded-lg border border-border space-y-2 text-sm text-muted-foreground\">\n            <p><strong className=\"text-foreground\">Chrome:</strong> Settings â†’ Privacy and Security â†’ Cookies and other site data</p>\n            <p><strong className=\"text-foreground\">Firefox:</strong> Settings â†’ Privacy & Security â†’ Cookies and Site Data</p>\n            <p><strong className=\"text-foreground\">Safari:</strong> Preferences â†’ Privacy â†’ Manage Website Data</p>\n            <p><strong className=\"text-foreground\">Edge:</strong> Settings â†’ Cookies and site permissions â†’ Manage cookies</p>\n          </div>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">5.2 Disabling Cookies</h3>\n          <p className=\"text-muted-foreground mb-4\">\n            You can block or delete cookies, but note that:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>You will need to log in every time you visit</li>\n            <li>Your preferences and settings will not be saved</li>\n            <li>Some features may not function properly</li>\n            <li>Typing test progress may not be tracked correctly</li>\n          </ul>\n\n          <h3 className=\"text-xl font-semibold text-foreground mb-3 mt-6\">5.3 Opt-Out Options</h3>\n          <p className=\"text-muted-foreground\">\n            While you cannot opt out of strictly necessary cookies, you can control optional cookies through your account settings or browser preferences.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">6. Cookie Retention</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            Cookie retention periods vary by type:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Session cookies:</strong> Deleted when you close your browser</li>\n            <li><strong className=\"text-foreground\">Preference cookies:</strong> 30 days to 1 year</li>\n            <li><strong className=\"text-foreground\">Analytics cookies:</strong> Up to 2 years</li>\n            <li><strong className=\"text-foreground\">Authentication cookies:</strong> 30 days or until logout</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">7. Do Not Track</h2>\n          <p className=\"text-muted-foreground\">\n            Some browsers have a \"Do Not Track\" (DNT) feature. Currently, there is no industry consensus on how to respond to DNT signals. TypeMasterAI does not currently respond to DNT browser settings.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">8. Updates to This Policy</h2>\n          <p className=\"text-muted-foreground\">\n            We may update this Cookie Policy from time to time. Any changes will be posted on this page with an updated \"Last Updated\" date. We encourage you to review this policy periodically.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">9. Related Policies</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            For more information about how we handle your data:\n          </p>\n          <ul className=\"list-disc pl-6 space-y-2\">\n            <li>\n              <Link href=\"/privacy-policy\" className=\"text-primary hover:underline\">Privacy Policy</Link>\n              <span className=\"text-muted-foreground\"> - How we collect and use your personal information</span>\n            </li>\n            <li>\n              <Link href=\"/terms-of-service\" className=\"text-primary hover:underline\">Terms of Service</Link>\n              <span className=\"text-muted-foreground\"> - Rules and guidelines for using TypeMasterAI</span>\n            </li>\n          </ul>\n        </section>\n\n        <section className=\"bg-card/30 p-8 rounded-xl border border-border\">\n          <h2 className=\"text-2xl font-bold text-foreground mb-6\">Questions About Cookies?</h2>\n          <p className=\"text-muted-foreground mb-6\">\n            If you have questions about our use of cookies, please contact us:\n          </p>\n          <div className=\"space-y-4\">\n            <div>\n              <p className=\"text-sm font-semibold text-foreground mb-1\">Email</p>\n              <a href=\"mailto:support@typemasterai.com\" className=\"text-primary hover:underline text-lg\">\n                support@typemasterai.com\n              </a>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-foreground mb-1\">Mailing Address</p>\n              <p className=\"text-muted-foreground\">\n                TypeMasterAI<br />\n                Solapur, Maharashtra 413224<br />\n                India\n              </p>\n            </div>\n          </div>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":12953,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { Toaster as SonnerToaster } from \"sonner\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { AuthProvider } from \"@/lib/auth-context\";\nimport { ThemeProvider } from \"@/lib/theme-context\";\nimport { NetworkProvider } from \"@/lib/network-context\";\nimport { ErrorProvider } from \"@/lib/error-context\";\nimport { NetworkStatusBanner } from \"@/components/NetworkStatusBanner\";\nimport { ErrorBoundary } from \"@/components/error-boundary\";\nimport { AchievementCelebrationProvider } from \"@/components/achievement-celebration\";\nimport { CookieConsentBanner } from \"@/components/cookie-consent-banner\";\nimport Layout from \"@/components/layout\";\nimport NotFound from \"@/pages/not-found\";\nimport Home from \"@/pages/home\";\nimport Profile from \"@/pages/profile\";\nimport ProfileEdit from \"@/pages/profile-edit\";\nimport Leaderboard from \"@/pages/leaderboard\";\nimport Settings from \"@/pages/settings\";\nimport Chat from \"@/pages/chat\";\nimport Login from \"@/pages/login\";\nimport Register from \"@/pages/register\";\nimport ForgotPassword from \"@/pages/forgot-password\";\nimport ResetPassword from \"@/pages/reset-password\";\nimport VerifyEmail from \"@/pages/verify-email\";\nimport Analytics from \"@/pages/analytics\";\nimport Multiplayer from \"@/pages/multiplayer\";\nimport Race from \"@/pages/race\";\nimport CodeMode from \"@/pages/code-mode\";\nimport CodeLeaderboard from \"@/pages/code-leaderboard\";\nimport BookMode from \"@/pages/book-mode\";\nimport BookLibrary from \"@/pages/book-library\";\nimport BookDetail from \"@/pages/book-detail\";\nimport ChapterTyping from \"@/pages/chapter-typing\";\nimport DictationTest from \"@/pages/dictation-test\";\nimport StressTest from \"@/pages/stress-test\";\nimport StressLeaderboard from \"@/pages/stress-leaderboard\";\nimport SharedResult from \"@/pages/shared-result\";\nimport PrivacyPolicy from \"@/pages/privacy-policy\";\nimport TermsOfService from \"@/pages/terms-of-service\";\nimport CookiePolicy from \"@/pages/cookie-policy\";\nimport About from \"@/pages/about\";\nimport Contact from \"@/pages/contact\";\nimport NotificationSettings from \"@/pages/NotificationSettings\";\nimport TypingTest1Min from \"@/pages/typing-test-1-min\";\nimport TypingTest3Min from \"@/pages/typing-test-3-min\";\nimport TypingTest5Min from \"@/pages/typing-test-5-min\";\nimport MonkeytypeAlternative from \"@/pages/monkeytype-alternative\";\nimport TyperacerAlternative from \"@/pages/typeracer-alternative\";\nimport TenFastFingersAlternative from \"@/pages/10fastfingers-alternative\";\nimport TypingComAlternative from \"@/pages/typingcom-alternative\";\nimport AdminFeedbackDashboard from \"@/pages/admin/feedback\";\nimport Learn from \"@/pages/learn\";\nimport AITransparency from \"@/pages/ai-transparency\";\nimport AccessibilityStatement from \"@/pages/accessibility\";\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/login\" component={Login} />\n      <Route path=\"/register\" component={Register} />\n      <Route path=\"/forgot-password\" component={ForgotPassword} />\n      <Route path=\"/reset-password\" component={ResetPassword} />\n      <Route path=\"/verify-email\" component={VerifyEmail} />\n      <Route path=\"/share/:shareId\" component={SharedResult} />\n      <Route>\n        <Layout>\n          <Switch>\n            <Route path=\"/\" component={Home} />\n            <Route path=\"/1-minute-typing-test\" component={TypingTest1Min} />\n            <Route path=\"/3-minute-typing-test\" component={TypingTest3Min} />\n            <Route path=\"/5-minute-typing-test\" component={TypingTest5Min} />\n            <Route path=\"/monkeytype-alternative\" component={MonkeytypeAlternative} />\n            <Route path=\"/typeracer-alternative\" component={TyperacerAlternative} />\n            <Route path=\"/10fastfingers-alternative\" component={TenFastFingersAlternative} />\n            <Route path=\"/typingcom-alternative\" component={TypingComAlternative} />\n            <Route path=\"/profile\" component={Profile} />\n            <Route path=\"/profile/edit\" component={ProfileEdit} />\n            <Route path=\"/leaderboard\" component={Leaderboard} />\n            <Route path=\"/analytics\" component={Analytics} />\n            <Route path=\"/multiplayer\" component={Multiplayer} />\n            <Route path=\"/race/:id\" component={Race} />\n            <Route path=\"/code-mode\" component={CodeMode} />\n            <Route path=\"/code-leaderboard\" component={CodeLeaderboard} />\n            <Route path=\"/book-mode\" component={BookMode} />\n            <Route path=\"/dictation-mode\" component={DictationTest} />\n            <Route path=\"/stress-test\" component={StressTest} />\n            <Route path=\"/stress-leaderboard\" component={StressLeaderboard} />\n            <Route path=\"/books/:slug/chapter/:chapterNum\" component={ChapterTyping} />\n            <Route path=\"/books/:slug\" component={BookDetail} />\n            <Route path=\"/books\" component={BookLibrary} />\n            <Route path=\"/chat\" component={Chat} />\n            <Route path=\"/settings\" component={Settings} />\n            <Route path=\"/notifications\" component={NotificationSettings} />\n            <Route path=\"/privacy-policy\" component={PrivacyPolicy} />\n            <Route path=\"/terms-of-service\" component={TermsOfService} />\n            <Route path=\"/cookie-policy\" component={CookiePolicy} />\n            <Route path=\"/about\" component={About} />\n            <Route path=\"/contact\" component={Contact} />\n            <Route path=\"/learn\" component={Learn} />\n            <Route path=\"/ai-transparency\" component={AITransparency} />\n            <Route path=\"/accessibility\" component={AccessibilityStatement} />\n            <Route path=\"/admin/feedback\" component={AdminFeedbackDashboard} />\n            <Route component={NotFound} />\n          </Switch>\n        </Layout>\n      </Route>\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <ErrorBoundary>\n      <QueryClientProvider client={queryClient}>\n        <ThemeProvider>\n          <NetworkProvider>\n            <ErrorProvider>\n              <AuthProvider>\n                <AchievementCelebrationProvider>\n                  <TooltipProvider>\n                    <NetworkStatusBanner />\n                    <Toaster />\n                    <SonnerToaster \n                      position=\"top-right\"\n                      richColors\n                      closeButton\n                      toastOptions={{\n                        duration: 5000,\n                        className: \"font-sans\",\n                      }}\n                    />\n                    <Router />\n                    <CookieConsentBanner />\n                  </TooltipProvider>\n                </AchievementCelebrationProvider>\n              </AuthProvider>\n            </ErrorProvider>\n          </NetworkProvider>\n        </ThemeProvider>\n      </QueryClientProvider>\n    </ErrorBoundary>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":6986,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\" +\n\" hover-elevate active-elevate-2\",\n  {\n    variants: {\n      variant: {\n        default:\n           // @replit: no hover, and add primary border\n           \"bg-primary text-primary-foreground border border-primary-border\",\n        destructive:\n          \"bg-destructive text-destructive-foreground shadow-sm border-destructive-border\",\n        outline:\n          // @replit Shows the background color of whatever card / sidebar / accent background it is inside of.\n          // Inherits the current text color. Uses shadow-xs. no shadow on active\n          // No hover state\n          \" border [border-color:var(--button-outline)] shadow-xs active:shadow-none \",\n        secondary:\n          // @replit border, no hover, no shadow, secondary border.\n          \"border bg-secondary text-secondary-foreground border border-secondary-border \",\n        // @replit no hover, transparent border\n        ghost: \"border border-transparent\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        // @replit changed sizes\n        default: \"min-h-9 px-4 py-2\",\n        sm: \"min-h-8 rounded-md px-3 text-xs\",\n        lg: \"min-h-10 rounded-md px-8\",\n        icon: \"h-9 w-9\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":2356,"size_tokens":null},"client/src/components/ui/input-group.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Textarea } from \"@/components/ui/textarea\"\n\nfunction InputGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"input-group\"\n      role=\"group\"\n      className={cn(\n        \"group/input-group border-input dark:bg-input/30 shadow-xs relative flex w-full items-center rounded-md border outline-none transition-[color,box-shadow]\",\n        \"h-9 has-[>textarea]:h-auto\",\n\n        // Variants based on alignment.\n        \"has-[>[data-align=inline-start]]:[&>input]:pl-2\",\n        \"has-[>[data-align=inline-end]]:[&>input]:pr-2\",\n        \"has-[>[data-align=block-start]]:h-auto has-[>[data-align=block-start]]:flex-col has-[>[data-align=block-start]]:[&>input]:pb-3\",\n        \"has-[>[data-align=block-end]]:h-auto has-[>[data-align=block-end]]:flex-col has-[>[data-align=block-end]]:[&>input]:pt-3\",\n\n        // Focus state.\n        \"has-[[data-slot=input-group-control]:focus-visible]:ring-ring has-[[data-slot=input-group-control]:focus-visible]:ring-1\",\n\n        // Error state.\n        \"has-[[data-slot][aria-invalid=true]]:ring-destructive/20 has-[[data-slot][aria-invalid=true]]:border-destructive dark:has-[[data-slot][aria-invalid=true]]:ring-destructive/40\",\n\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst inputGroupAddonVariants = cva(\n  \"text-muted-foreground flex h-auto cursor-text select-none items-center justify-center gap-2 py-1.5 text-sm font-medium group-data-[disabled=true]/input-group:opacity-50 [&>kbd]:rounded-[calc(var(--radius)-5px)] [&>svg:not([class*='size-'])]:size-4\",\n  {\n    variants: {\n      align: {\n        \"inline-start\":\n          \"order-first pl-3 has-[>button]:ml-[-0.45rem] has-[>kbd]:ml-[-0.35rem]\",\n        \"inline-end\":\n          \"order-last pr-3 has-[>button]:mr-[-0.4rem] has-[>kbd]:mr-[-0.35rem]\",\n        \"block-start\":\n          \"[.border-b]:pb-3 order-first w-full justify-start px-3 pt-3 group-has-[>input]/input-group:pt-2.5\",\n        \"block-end\":\n          \"[.border-t]:pt-3 order-last w-full justify-start px-3 pb-3 group-has-[>input]/input-group:pb-2.5\",\n      },\n    },\n    defaultVariants: {\n      align: \"inline-start\",\n    },\n  }\n)\n\nfunction InputGroupAddon({\n  className,\n  align = \"inline-start\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof inputGroupAddonVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"input-group-addon\"\n      data-align={align}\n      className={cn(inputGroupAddonVariants({ align }), className)}\n      onClick={(e) => {\n        if ((e.target as HTMLElement).closest(\"button\")) {\n          return\n        }\n        e.currentTarget.parentElement?.querySelector(\"input\")?.focus()\n      }}\n      {...props}\n    />\n  )\n}\n\nconst inputGroupButtonVariants = cva(\n  \"flex items-center gap-2 text-sm shadow-none\",\n  {\n    variants: {\n      size: {\n        xs: \"h-6 gap-1 rounded-[calc(var(--radius)-5px)] px-2 has-[>svg]:px-2 [&>svg:not([class*='size-'])]:size-3.5\",\n        sm: \"h-8 gap-1.5 rounded-md px-2.5 has-[>svg]:px-2.5\",\n        \"icon-xs\":\n          \"size-6 rounded-[calc(var(--radius)-5px)] p-0 has-[>svg]:p-0\",\n        \"icon-sm\": \"size-8 p-0 has-[>svg]:p-0\",\n      },\n    },\n    defaultVariants: {\n      size: \"xs\",\n    },\n  }\n)\n\nfunction InputGroupButton({\n  className,\n  type = \"button\",\n  variant = \"ghost\",\n  size = \"xs\",\n  ...props\n}: Omit<React.ComponentProps<typeof Button>, \"size\"> &\n  VariantProps<typeof inputGroupButtonVariants>) {\n  return (\n    <Button\n      type={type}\n      data-size={size}\n      variant={variant}\n      className={cn(inputGroupButtonVariants({ size }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupText({ className, ...props }: React.ComponentProps<\"span\">) {\n  return (\n    <span\n      className={cn(\n        \"text-muted-foreground flex items-center gap-2 text-sm [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupInput({\n  className,\n  ...props\n}: React.ComponentProps<\"input\">) {\n  return (\n    <Input\n      data-slot=\"input-group-control\"\n      className={cn(\n        \"flex-1 rounded-none border-0 bg-transparent shadow-none focus-visible:ring-0 dark:bg-transparent\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction InputGroupTextarea({\n  className,\n  ...props\n}: React.ComponentProps<\"textarea\">) {\n  return (\n    <Textarea\n      data-slot=\"input-group-control\"\n      className={cn(\n        \"flex-1 resize-none rounded-none border-0 bg-transparent py-3 shadow-none focus-visible:ring-0 dark:bg-transparent\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  InputGroup,\n  InputGroupAddon,\n  InputGroupButton,\n  InputGroupText,\n  InputGroupInput,\n  InputGroupTextarea,\n}\n","path":null,"size_bytes":4971,"size_tokens":null},"vite-plugin-meta-images.ts":{"content":"import type { Plugin } from 'vite';\nimport fs from 'fs';\nimport path from 'path';\n\n/**\n * Vite plugin that updates og:image and twitter:image meta tags\n * to point to the app's opengraph image with the correct Replit domain.\n */\nexport function metaImagesPlugin(): Plugin {\n  return {\n    name: 'vite-plugin-meta-images',\n    transformIndexHtml(html) {\n      const baseUrl = getDeploymentUrl();\n      if (!baseUrl) {\n        log('[meta-images] no Replit deployment domain found, skipping meta tag updates');\n        return html;\n      }\n\n      // Check if opengraph image exists in public directory\n      const publicDir = path.resolve(process.cwd(), 'client', 'public');\n      const opengraphPngPath = path.join(publicDir, 'opengraph.png');\n      const opengraphJpgPath = path.join(publicDir, 'opengraph.jpg');\n      const opengraphJpegPath = path.join(publicDir, 'opengraph.jpeg');\n\n      let imageExt: string | null = null;\n      if (fs.existsSync(opengraphPngPath)) {\n        imageExt = 'png';\n      } else if (fs.existsSync(opengraphJpgPath)) {\n        imageExt = 'jpg';\n      } else if (fs.existsSync(opengraphJpegPath)) {\n        imageExt = 'jpeg';\n      }\n\n      if (!imageExt) {\n        log('[meta-images] OpenGraph image not found, skipping meta tag updates');\n        return html;\n      }\n\n      const imageUrl = `${baseUrl}/opengraph.${imageExt}`;\n\n      log('[meta-images] updating meta image tags to:', imageUrl);\n\n      html = html.replace(\n        /<meta\\s+property=\"og:image\"\\s+content=\"[^\"]*\"\\s*\\/>/g,\n        `<meta property=\"og:image\" content=\"${imageUrl}\" />`\n      );\n\n      html = html.replace(\n        /<meta\\s+name=\"twitter:image\"\\s+content=\"[^\"]*\"\\s*\\/>/g,\n        `<meta name=\"twitter:image\" content=\"${imageUrl}\" />`\n      );\n\n      return html;\n    },\n  };\n}\n\nfunction getDeploymentUrl(): string | null {\n  if (process.env.REPLIT_INTERNAL_APP_DOMAIN) {\n    const url = `https://${process.env.REPLIT_INTERNAL_APP_DOMAIN}`;\n    log('[meta-images] using internal app domain:', url);\n    return url;\n  }\n\n  if (process.env.REPLIT_DEV_DOMAIN) {\n    const url = `https://${process.env.REPLIT_DEV_DOMAIN}`;\n    log('[meta-images] using dev domain:', url);\n    return url;\n  }\n\n  return null;\n}\n\nfunction log(...args: any[]): void {\n  if (process.env.NODE_ENV === 'production') {\n    console.log(...args);\n  }\n}\n","path":null,"size_bytes":2333,"size_tokens":null},"client/src/components/layout.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { cn } from \"@/lib/utils\";\nimport { Keyboard, BarChart2, User, Settings, Trophy, LogOut, Sparkles, Github, Twitter, Mail, Globe, Zap, Shield, BookOpen, Users, Award, TrendingUp, Code, Book, Headphones, Star, Menu, MessageSquarePlus, Palette, Sun, Waves, Trees, Moon, Minimize2, Sunset as SunsetIcon, Tv, Cpu } from \"lucide-react\";\nimport FeedbackWidget from \"@/components/FeedbackWidget\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useTheme } from \"@/lib/theme-context\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n} from \"@/components/ui/dropdown-menu\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetTrigger } from \"@/components/ui/sheet\";\n\nexport default function Layout({ children }: { children: React.ReactNode }) {\n  const [location, setLocation] = useLocation();\n  const { user, logout } = useAuth();\n  const { theme, setTheme } = useTheme();\n  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);\n\n  useEffect(() => {\n    setMobileMenuOpen(false);\n  }, [location]);\n\n  const { data: gamificationData } = useQuery({\n    queryKey: [\"gamification\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/gamification\", {\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch gamification\");\n      return response.json();\n    },\n    enabled: !!user,\n    staleTime: 30000,\n  });\n\n  const level = gamificationData?.gamification?.level || 1;\n  const xp = gamificationData?.gamification?.experiencePoints || 0;\n  const xpForNextLevel = level * 100;\n  const xpInCurrentLevel = xp % 100;\n  const xpProgress = (xpInCurrentLevel / 100) * 100;\n\n  const primaryNavItems = [\n    { href: \"/\", icon: Keyboard, label: \"Quick Test\", description: \"Practice typing with various texts and languages\" },\n    { href: \"/code-mode\", icon: Code, label: \"Code Practice\", description: \"Practice typing real programming code\" },\n    { href: \"/books\", icon: Book, label: \"Book Library\", description: \"Type passages from famous books\" },\n    { href: \"/dictation-mode\", icon: Headphones, label: \"Listen & Type\", description: \"Listen and type what you hear\" },\n    { href: \"/stress-test\", icon: Zap, label: \"Speed Challenge\", description: \"Test your typing under pressure\" },\n    { href: \"/multiplayer\", icon: Users, label: \"Live Race\", description: \"Race against other players in real-time\" },\n  ];\n\n  const secondaryNavItems = [\n    { href: \"/leaderboard\", icon: Trophy, label: \"Leaderboard\", description: \"See top typists and rankings\" },\n    { href: \"/analytics\", icon: BarChart2, label: \"Analytics\", description: \"View your typing statistics and progress\" },\n    { href: \"/chat\", icon: Sparkles, label: \"AI Chat\", description: \"Get AI-powered typing tips and help\" },\n    { href: \"/profile\", icon: User, label: \"Profile\", description: \"View and edit your profile\" },\n    { href: \"/settings\", icon: Settings, label: \"Settings\", description: \"Customize your typing experience\" },\n  ];\n\n  const allNavItems = [...primaryNavItems, ...secondaryNavItems];\n\n  const handleLogout = async () => {\n    await logout();\n    setLocation(\"/login\");\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background text-foreground font-sans selection:bg-primary selection:text-primary-foreground flex flex-col\">\n      <header className=\"fixed top-0 left-0 right-0 z-50 border-b border-border/40 bg-background/80 backdrop-blur-md\">\n        <div className=\"max-w-[1800px] mx-auto px-2 h-14 flex items-center justify-between\">\n          <Link href=\"/\">\n            <div className=\"flex items-center gap-2 shrink-0 cursor-pointer group p-1.5\">\n              <img \n                src=\"/logo-horizontal.svg\" \n                alt=\"TypeMasterAI Logo\" \n                className=\"h-9 w-auto object-contain transition-transform group-hover:scale-105\"\n              />\n            </div>\n          </Link>\n\n          <nav className=\"hidden md:flex items-center flex-1 justify-center\">\n            {allNavItems.map((item) => {\n              const Icon = item.icon;\n              const isActive = location === item.href;\n              return (\n                <Tooltip key={item.href}>\n                  <TooltipTrigger asChild>\n                    <Link href={item.href}>\n                      <div\n                        className={cn(\n                          \"flex items-center gap-1.5 px-2.5 py-1.5 rounded-md transition-all duration-200 text-xs font-medium cursor-pointer whitespace-nowrap\",\n                          isActive\n                            ? \"text-primary bg-primary/10\"\n                            : \"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                        )}\n                        data-testid={`nav-${item.label.toLowerCase().replace(/\\s+/g, '-')}`}\n                      >\n                        <Icon className=\"w-4 h-4\" />\n                        <span>{item.label}</span>\n                      </div>\n                    </Link>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"bottom\" className=\"bg-card border-border\">\n                    <p className=\"text-sm\">{item.description}</p>\n                  </TooltipContent>\n                </Tooltip>\n              );\n            })}\n            \n            {location !== \"/\" && (\n              <DropdownMenu>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <DropdownMenuTrigger asChild>\n                      <button\n                        type=\"button\"\n                        className=\"flex items-center gap-1.5 px-2.5 py-1.5 rounded-md transition-all duration-200 text-xs font-medium text-muted-foreground hover:text-foreground hover:bg-accent whitespace-nowrap\"\n                        data-testid=\"nav-theme-toggle\"\n                      >\n                        <Palette className=\"w-4 h-4\" />\n                        <span>Theme</span>\n                      </button>\n                    </DropdownMenuTrigger>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"bottom\" className=\"bg-card border-border\">\n                    <p className=\"text-sm\">Change color theme</p>\n                  </TooltipContent>\n                </Tooltip>\n              <DropdownMenuContent align=\"center\" className=\"w-56\">\n                <DropdownMenuLabel>Choose Theme</DropdownMenuLabel>\n                <DropdownMenuSeparator />\n                <DropdownMenuItem\n                  onClick={() => setTheme(\"focus\")}\n                  className=\"flex items-center gap-3 cursor-pointer\"\n                  data-testid=\"theme-option-focus\"\n                >\n                  <Zap className=\"w-4 h-4 text-blue-500\" />\n                  <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-blue-500 to-blue-700\" />\n                  <span className=\"flex-1 text-sm\">Focus</span>\n                  {theme === \"focus\" && <span className=\"text-primary\">âœ“</span>}\n                </DropdownMenuItem>\n                <DropdownMenuItem\n                  onClick={() => setTheme(\"light\")}\n                  className=\"flex items-center gap-3 cursor-pointer\"\n                  data-testid=\"theme-option-light\"\n                >\n                  <Sun className=\"w-4 h-4 text-yellow-500\" />\n                  <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-yellow-300 to-yellow-500\" />\n                  <span className=\"flex-1 text-sm\">Light</span>\n                  {theme === \"light\" && <span className=\"text-primary\">âœ“</span>}\n                </DropdownMenuItem>\n                <DropdownMenuItem\n                  onClick={() => setTheme(\"ocean\")}\n                  className=\"flex items-center gap-3 cursor-pointer\"\n                  data-testid=\"theme-option-ocean\"\n                >\n                  <Waves className=\"w-4 h-4 text-cyan-500\" />\n                  <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600\" />\n                  <span className=\"flex-1 text-sm\">Ocean</span>\n                  {theme === \"ocean\" && <span className=\"text-primary\">âœ“</span>}\n                </DropdownMenuItem>\n                <DropdownMenuItem\n                  onClick={() => setTheme(\"forest\")}\n                  className=\"flex items-center gap-3 cursor-pointer\"\n                  data-testid=\"theme-option-forest\"\n                >\n                  <Trees className=\"w-4 h-4 text-green-500\" />\n                  <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-green-500 to-emerald-600\" />\n                  <span className=\"flex-1 text-sm\">Forest</span>\n                  {theme === \"forest\" && <span className=\"text-primary\">âœ“</span>}\n                </DropdownMenuItem>\n                <DropdownMenuItem\n                  onClick={() => setTheme(\"dracula\")}\n                  className=\"flex items-center gap-3 cursor-pointer\"\n                  data-testid=\"theme-option-dracula\"\n                >\n                  <Moon className=\"w-4 h-4 text-purple-400\" />\n                  <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-purple-500 to-pink-500\" />\n                  <span className=\"flex-1 text-sm\">Dracula</span>\n                  {theme === \"dracula\" && <span className=\"text-primary\">âœ“</span>}\n                </DropdownMenuItem>\n                <DropdownMenuItem\n                  onClick={() => setTheme(\"minimal\")}\n                  className=\"flex items-center gap-3 cursor-pointer\"\n                  data-testid=\"theme-option-minimal\"\n                >\n                  <Minimize2 className=\"w-4 h-4 text-gray-400\" />\n                  <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-gray-400 to-gray-600\" />\n                  <span className=\"flex-1 text-sm\">Minimal</span>\n                  {theme === \"minimal\" && <span className=\"text-primary\">âœ“</span>}\n                </DropdownMenuItem>\n                <DropdownMenuItem\n                  onClick={() => setTheme(\"sunset\")}\n                  className=\"flex items-center gap-3 cursor-pointer\"\n                  data-testid=\"theme-option-sunset\"\n                >\n                  <SunsetIcon className=\"w-4 h-4 text-orange-500\" />\n                  <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-orange-500 to-pink-500\" />\n                  <span className=\"flex-1 text-sm\">Sunset</span>\n                  {theme === \"sunset\" && <span className=\"text-primary\">âœ“</span>}\n                </DropdownMenuItem>\n                <DropdownMenuItem\n                  onClick={() => setTheme(\"retro\")}\n                  className=\"flex items-center gap-3 cursor-pointer\"\n                  data-testid=\"theme-option-retro\"\n                >\n                  <Tv className=\"w-4 h-4 text-amber-500\" />\n                  <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-orange-500 to-amber-600\" />\n                  <span className=\"flex-1 text-sm\">Retro</span>\n                  {theme === \"retro\" && <span className=\"text-primary\">âœ“</span>}\n                </DropdownMenuItem>\n                <DropdownMenuItem\n                  onClick={() => setTheme(\"cyber\")}\n                  className=\"flex items-center gap-3 cursor-pointer\"\n                  data-testid=\"theme-option-cyber\"\n                >\n                  <Cpu className=\"w-4 h-4 text-pink-500\" />\n                  <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-purple-500 to-pink-500\" />\n                  <span className=\"flex-1 text-sm\">Cyber</span>\n                  {theme === \"cyber\" && <span className=\"text-primary\">âœ“</span>}\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n            )}\n          </nav>\n\n          <div className=\"flex items-center gap-1.5 shrink-0\">\n            {user && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Link href=\"/profile\">\n                    <div \n                      className=\"hidden lg:flex items-center gap-1 px-1.5 py-0.5 rounded-lg bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20 hover:border-amber-500/40 transition-all cursor-pointer\"\n                      data-testid=\"xp-level-display\"\n                    >\n                      <div className=\"flex items-center justify-center w-5 h-5 rounded-full bg-gradient-to-br from-amber-500 to-orange-500 text-white font-bold text-[9px] shadow-lg shadow-amber-500/25\">\n                        {level}\n                      </div>\n                      <div className=\"flex flex-col gap-0 min-w-[50px]\">\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-[8px] font-semibold text-amber-500/90 uppercase tracking-wider\">Lv {level}</span>\n                          <span className=\"text-[8px] font-mono text-muted-foreground\">{xpInCurrentLevel}/100</span>\n                        </div>\n                        <Progress \n                          value={xpProgress} \n                          className=\"h-0.5 bg-amber-950/30 [&>div]:bg-gradient-to-r [&>div]:from-amber-500 [&>div]:to-orange-500\"\n                          data-testid=\"xp-progress-bar\"\n                        />\n                      </div>\n                    </div>\n                  </Link>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\" className=\"bg-card border-border\">\n                  <div className=\"text-sm\">\n                    <p className=\"font-semibold text-amber-500\">Level {level}</p>\n                    <p className=\"text-muted-foreground\">{xpInCurrentLevel} / 100 XP to next level</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">Total: {xp} XP</p>\n                  </div>\n                </TooltipContent>\n              </Tooltip>\n            )}\n\n            {user ? (\n              <>\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button variant=\"ghost\" className=\"h-7 w-7 rounded-full p-0\">\n                      <Avatar className=\"h-7 w-7\">\n                        <AvatarFallback className=\"bg-primary text-primary-foreground text-xs\">\n                          {user.username[0].toUpperCase()}\n                        </AvatarFallback>\n                      </Avatar>\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"end\" className=\"w-56\">\n                    <DropdownMenuLabel>\n                      <div className=\"flex flex-col\">\n                        <span className=\"font-semibold\">{user.username}</span>\n                        <span className=\"text-xs text-muted-foreground\">{user.email}</span>\n                      </div>\n                    </DropdownMenuLabel>\n                    <DropdownMenuSeparator />\n                    {user.email?.toLowerCase() === \"amar01pawar80@gmail.com\" && (\n                      <>\n                        <Link href=\"/admin/feedback\">\n                          <DropdownMenuItem data-testid=\"button-admin-feedback\">\n                            <Shield className=\"w-4 h-4 mr-2\" />\n                            Admin Feedback\n                          </DropdownMenuItem>\n                        </Link>\n                        <DropdownMenuSeparator />\n                      </>\n                    )}\n                    <DropdownMenuSub>\n                      <DropdownMenuSubTrigger data-testid=\"button-theme-menu\">\n                        <Palette className=\"w-4 h-4 mr-2\" />\n                        Theme\n                      </DropdownMenuSubTrigger>\n                      <DropdownMenuSubContent>\n                        <DropdownMenuItem \n                          onClick={() => setTheme(\"focus\")}\n                          className={cn(theme === \"focus\" && \"bg-accent\")}\n                          data-testid=\"theme-focus\"\n                        >\n                          <Zap className=\"w-3.5 h-3.5 mr-2 text-blue-500\" />\n                          <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 mr-2\" />\n                          <span className=\"flex-1\">Focus</span>\n                          {theme === \"focus\" && <span className=\"ml-auto\">âœ“</span>}\n                        </DropdownMenuItem>\n                        <DropdownMenuItem \n                          onClick={() => setTheme(\"light\")}\n                          className={cn(theme === \"light\" && \"bg-accent\")}\n                          data-testid=\"theme-light\"\n                        >\n                          <Sun className=\"w-3.5 h-3.5 mr-2 text-yellow-500\" />\n                          <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-yellow-300 to-yellow-500 mr-2\" />\n                          <span className=\"flex-1\">Light</span>\n                          {theme === \"light\" && <span className=\"ml-auto\">âœ“</span>}\n                        </DropdownMenuItem>\n                        <DropdownMenuItem \n                          onClick={() => setTheme(\"ocean\")}\n                          className={cn(theme === \"ocean\" && \"bg-accent\")}\n                          data-testid=\"theme-ocean\"\n                        >\n                          <Waves className=\"w-3.5 h-3.5 mr-2 text-cyan-500\" />\n                          <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 mr-2\" />\n                          <span className=\"flex-1\">Ocean</span>\n                          {theme === \"ocean\" && <span className=\"ml-auto\">âœ“</span>}\n                        </DropdownMenuItem>\n                        <DropdownMenuItem \n                          onClick={() => setTheme(\"forest\")}\n                          className={cn(theme === \"forest\" && \"bg-accent\")}\n                          data-testid=\"theme-forest\"\n                        >\n                          <Trees className=\"w-3.5 h-3.5 mr-2 text-green-500\" />\n                          <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 mr-2\" />\n                          <span className=\"flex-1\">Forest</span>\n                          {theme === \"forest\" && <span className=\"ml-auto\">âœ“</span>}\n                        </DropdownMenuItem>\n                        <DropdownMenuItem \n                          onClick={() => setTheme(\"dracula\")}\n                          className={cn(theme === \"dracula\" && \"bg-accent\")}\n                          data-testid=\"theme-dracula\"\n                        >\n                          <Moon className=\"w-3.5 h-3.5 mr-2 text-purple-400\" />\n                          <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 mr-2\" />\n                          <span className=\"flex-1\">Dracula</span>\n                          {theme === \"dracula\" && <span className=\"ml-auto\">âœ“</span>}\n                        </DropdownMenuItem>\n                        <DropdownMenuItem \n                          onClick={() => setTheme(\"minimal\")}\n                          className={cn(theme === \"minimal\" && \"bg-accent\")}\n                          data-testid=\"theme-minimal\"\n                        >\n                          <Minimize2 className=\"w-3.5 h-3.5 mr-2 text-gray-400\" />\n                          <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-gray-400 to-gray-600 mr-2\" />\n                          <span className=\"flex-1\">Minimal</span>\n                          {theme === \"minimal\" && <span className=\"ml-auto\">âœ“</span>}\n                        </DropdownMenuItem>\n                        <DropdownMenuItem \n                          onClick={() => setTheme(\"sunset\")}\n                          className={cn(theme === \"sunset\" && \"bg-accent\")}\n                          data-testid=\"theme-sunset\"\n                        >\n                          <SunsetIcon className=\"w-3.5 h-3.5 mr-2 text-orange-500\" />\n                          <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-orange-500 to-pink-500 mr-2\" />\n                          <span className=\"flex-1\">Sunset</span>\n                          {theme === \"sunset\" && <span className=\"ml-auto\">âœ“</span>}\n                        </DropdownMenuItem>\n                        <DropdownMenuItem \n                          onClick={() => setTheme(\"retro\")}\n                          className={cn(theme === \"retro\" && \"bg-accent\")}\n                          data-testid=\"theme-retro\"\n                        >\n                          <Tv className=\"w-3.5 h-3.5 mr-2 text-amber-500\" />\n                          <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-orange-500 to-amber-600 mr-2\" />\n                          <span className=\"flex-1\">Retro</span>\n                          {theme === \"retro\" && <span className=\"ml-auto\">âœ“</span>}\n                        </DropdownMenuItem>\n                        <DropdownMenuItem \n                          onClick={() => setTheme(\"cyber\")}\n                          className={cn(theme === \"cyber\" && \"bg-accent\")}\n                          data-testid=\"theme-cyber\"\n                        >\n                          <Cpu className=\"w-3.5 h-3.5 mr-2 text-pink-500\" />\n                          <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 mr-2\" />\n                          <span className=\"flex-1\">Cyber</span>\n                          {theme === \"cyber\" && <span className=\"ml-auto\">âœ“</span>}\n                        </DropdownMenuItem>\n                      </DropdownMenuSubContent>\n                    </DropdownMenuSub>\n                    <DropdownMenuSeparator />\n                    <DropdownMenuItem onClick={handleLogout} data-testid=\"button-logout\">\n                      <LogOut className=\"w-4 h-4 mr-2\" />\n                      Logout\n                    </DropdownMenuItem>\n                  </DropdownMenuContent>\n                </DropdownMenu>\n              </>\n            ) : (\n              <div className=\"hidden md:flex items-center gap-1\">\n                <Link href=\"/login\">\n                  <Button variant=\"ghost\" size=\"sm\" className=\"text-[11px] h-7 px-2\" data-testid=\"button-nav-login\">\n                    Sign In\n                  </Button>\n                </Link>\n                <Link href=\"/register\">\n                  <Button size=\"sm\" className=\"text-[11px] h-7 px-2\" data-testid=\"button-nav-register\">\n                    Sign Up\n                  </Button>\n                </Link>\n              </div>\n            )}\n\n            <Sheet open={mobileMenuOpen} onOpenChange={setMobileMenuOpen}>\n              <SheetTrigger asChild>\n                <Button variant=\"ghost\" size=\"sm\" className=\"md:hidden h-7 w-7 p-0\" data-testid=\"button-mobile-menu\">\n                  <Menu className=\"h-4 w-4\" />\n                </Button>\n              </SheetTrigger>\n              <SheetContent side=\"right\" className=\"w-72 p-0\">\n                <SheetHeader className=\"p-4 border-b\">\n                  <SheetTitle className=\"flex items-center gap-2\">\n                    <div className=\"w-7 h-7 bg-primary rounded-md flex items-center justify-center text-primary-foreground font-mono font-bold text-lg\">\n                      T\n                    </div>\n                    TypeMasterAI\n                  </SheetTitle>\n                </SheetHeader>\n                \n                {user && (\n                  <div className=\"p-4 border-b\">\n                    <Link href=\"/profile\" onClick={() => setMobileMenuOpen(false)}>\n                      <div \n                        className=\"flex items-center gap-3 p-3 rounded-lg bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20\"\n                      >\n                        <div className=\"flex items-center justify-center w-10 h-10 rounded-full bg-gradient-to-br from-amber-500 to-orange-500 text-white font-bold text-sm shadow-lg shadow-amber-500/25\">\n                          {level}\n                        </div>\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center justify-between mb-1\">\n                            <span className=\"text-xs font-semibold text-amber-500/90\">Level {level}</span>\n                            <span className=\"text-xs font-mono text-muted-foreground\">{xpInCurrentLevel}/100 XP</span>\n                          </div>\n                          <Progress \n                            value={xpProgress} \n                            className=\"h-2 bg-amber-950/30 [&>div]:bg-gradient-to-r [&>div]:from-amber-500 [&>div]:to-orange-500\"\n                          />\n                        </div>\n                      </div>\n                    </Link>\n                  </div>\n                )}\n\n                <div className=\"p-2 overflow-y-auto max-h-[calc(100vh-200px)]\">\n                  <div className=\"space-y-1\">\n                    {allNavItems.map((item) => {\n                      const Icon = item.icon;\n                      const isActive = location === item.href;\n                      return (\n                        <Link key={item.href} href={item.href}>\n                          <div\n                            onClick={() => setMobileMenuOpen(false)}\n                            className={cn(\n                              \"flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 text-sm font-medium cursor-pointer\",\n                              isActive\n                                ? \"text-primary bg-primary/10\"\n                                : \"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                            )}\n                            data-testid={`mobile-nav-${item.label.toLowerCase().replace(/\\s+/g, '-')}`}\n                          >\n                            <Icon className=\"w-4 h-4\" />\n                            <span>{item.label}</span>\n                          </div>\n                        </Link>\n                      );\n                    })}\n                  </div>\n                  \n                  <div className=\"mt-4 pt-4 border-t\">\n                    <div className=\"px-3 py-2 text-xs font-semibold text-muted-foreground uppercase tracking-wider\">\n                      Theme\n                    </div>\n                    <div className=\"space-y-1\">\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          setTheme(\"focus\");\n                          setMobileMenuOpen(false);\n                        }}\n                        className={cn(\n                          \"w-full flex items-center gap-2 px-3 py-2.5 rounded-lg transition-all duration-200 text-sm font-medium\",\n                          theme === \"focus\"\n                            ? \"text-primary bg-primary/10\"\n                            : \"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                        )}\n                        data-testid=\"mobile-theme-focus\"\n                      >\n                        <Zap className=\"w-4 h-4 text-blue-500\" />\n                        <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-blue-500 to-blue-700\" />\n                        <span className=\"flex-1 text-left\">Focus</span>\n                        {theme === \"focus\" && <span className=\"text-primary\">âœ“</span>}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          setTheme(\"light\");\n                          setMobileMenuOpen(false);\n                        }}\n                        className={cn(\n                          \"w-full flex items-center gap-2 px-3 py-2.5 rounded-lg transition-all duration-200 text-sm font-medium\",\n                          theme === \"light\"\n                            ? \"text-primary bg-primary/10\"\n                            : \"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                        )}\n                        data-testid=\"mobile-theme-light\"\n                      >\n                        <Sun className=\"w-4 h-4 text-yellow-500\" />\n                        <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-yellow-300 to-yellow-500\" />\n                        <span className=\"flex-1 text-left\">Light</span>\n                        {theme === \"light\" && <span className=\"text-primary\">âœ“</span>}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          setTheme(\"ocean\");\n                          setMobileMenuOpen(false);\n                        }}\n                        className={cn(\n                          \"w-full flex items-center gap-2 px-3 py-2.5 rounded-lg transition-all duration-200 text-sm font-medium\",\n                          theme === \"ocean\"\n                            ? \"text-primary bg-primary/10\"\n                            : \"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                        )}\n                        data-testid=\"mobile-theme-ocean\"\n                      >\n                        <Waves className=\"w-4 h-4 text-cyan-500\" />\n                        <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600\" />\n                        <span className=\"flex-1 text-left\">Ocean</span>\n                        {theme === \"ocean\" && <span className=\"text-primary\">âœ“</span>}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          setTheme(\"forest\");\n                          setMobileMenuOpen(false);\n                        }}\n                        className={cn(\n                          \"w-full flex items-center gap-2 px-3 py-2.5 rounded-lg transition-all duration-200 text-sm font-medium\",\n                          theme === \"forest\"\n                            ? \"text-primary bg-primary/10\"\n                            : \"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                        )}\n                        data-testid=\"mobile-theme-forest\"\n                      >\n                        <Trees className=\"w-4 h-4 text-green-500\" />\n                        <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-green-500 to-emerald-600\" />\n                        <span className=\"flex-1 text-left\">Forest</span>\n                        {theme === \"forest\" && <span className=\"text-primary\">âœ“</span>}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          setTheme(\"dracula\");\n                          setMobileMenuOpen(false);\n                        }}\n                        className={cn(\n                          \"w-full flex items-center gap-2 px-3 py-2.5 rounded-lg transition-all duration-200 text-sm font-medium\",\n                          theme === \"dracula\"\n                            ? \"text-primary bg-primary/10\"\n                            : \"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                        )}\n                        data-testid=\"mobile-theme-dracula\"\n                      >\n                        <Moon className=\"w-4 h-4 text-purple-400\" />\n                        <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-purple-500 to-pink-500\" />\n                        <span className=\"flex-1 text-left\">Dracula</span>\n                        {theme === \"dracula\" && <span className=\"text-primary\">âœ“</span>}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          setTheme(\"minimal\");\n                          setMobileMenuOpen(false);\n                        }}\n                        className={cn(\n                          \"w-full flex items-center gap-2 px-3 py-2.5 rounded-lg transition-all duration-200 text-sm font-medium\",\n                          theme === \"minimal\"\n                            ? \"text-primary bg-primary/10\"\n                            : \"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                        )}\n                        data-testid=\"mobile-theme-minimal\"\n                      >\n                        <Minimize2 className=\"w-4 h-4 text-gray-400\" />\n                        <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-gray-400 to-gray-600\" />\n                        <span className=\"flex-1 text-left\">Minimal</span>\n                        {theme === \"minimal\" && <span className=\"text-primary\">âœ“</span>}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          setTheme(\"sunset\");\n                          setMobileMenuOpen(false);\n                        }}\n                        className={cn(\n                          \"w-full flex items-center gap-2 px-3 py-2.5 rounded-lg transition-all duration-200 text-sm font-medium\",\n                          theme === \"sunset\"\n                            ? \"text-primary bg-primary/10\"\n                            : \"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                        )}\n                        data-testid=\"mobile-theme-sunset\"\n                      >\n                        <SunsetIcon className=\"w-4 h-4 text-orange-500\" />\n                        <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-orange-500 to-pink-500\" />\n                        <span className=\"flex-1 text-left\">Sunset</span>\n                        {theme === \"sunset\" && <span className=\"text-primary\">âœ“</span>}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          setTheme(\"retro\");\n                          setMobileMenuOpen(false);\n                        }}\n                        className={cn(\n                          \"w-full flex items-center gap-2 px-3 py-2.5 rounded-lg transition-all duration-200 text-sm font-medium\",\n                          theme === \"retro\"\n                            ? \"text-primary bg-primary/10\"\n                            : \"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                        )}\n                        data-testid=\"mobile-theme-retro\"\n                      >\n                        <Tv className=\"w-4 h-4 text-amber-500\" />\n                        <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-orange-500 to-amber-600\" />\n                        <span className=\"flex-1 text-left\">Retro</span>\n                        {theme === \"retro\" && <span className=\"text-primary\">âœ“</span>}\n                      </button>\n                      <button\n                        type=\"button\"\n                        onClick={() => {\n                          setTheme(\"cyber\");\n                          setMobileMenuOpen(false);\n                        }}\n                        className={cn(\n                          \"w-full flex items-center gap-2 px-3 py-2.5 rounded-lg transition-all duration-200 text-sm font-medium\",\n                          theme === \"cyber\"\n                            ? \"text-primary bg-primary/10\"\n                            : \"text-muted-foreground hover:text-foreground hover:bg-accent\"\n                        )}\n                        data-testid=\"mobile-theme-cyber\"\n                      >\n                        <Cpu className=\"w-4 h-4 text-pink-500\" />\n                        <div className=\"w-3 h-3 rounded-full bg-gradient-to-br from-purple-500 to-pink-500\" />\n                        <span className=\"flex-1 text-left\">Cyber</span>\n                        {theme === \"cyber\" && <span className=\"text-primary\">âœ“</span>}\n                      </button>\n                    </div>\n                  </div>\n                  \n                  {!user && (\n                    <div className=\"mt-4 pt-4 border-t space-y-2\">\n                      <Link href=\"/login\">\n                        <Button variant=\"outline\" className=\"w-full\" onClick={() => setMobileMenuOpen(false)} data-testid=\"mobile-button-login\">\n                          Sign In\n                        </Button>\n                      </Link>\n                      <Link href=\"/register\">\n                        <Button className=\"w-full\" onClick={() => setMobileMenuOpen(false)} data-testid=\"mobile-button-register\">\n                          Sign Up\n                        </Button>\n                      </Link>\n                    </div>\n                  )}\n                  \n                  {user && (\n                    <div className=\"mt-4 pt-4 border-t\">\n                      <Button \n                        variant=\"ghost\" \n                        className=\"w-full justify-start text-destructive hover:text-destructive hover:bg-destructive/10\"\n                        onClick={() => {\n                          handleLogout();\n                          setMobileMenuOpen(false);\n                        }}\n                        data-testid=\"mobile-button-logout\"\n                      >\n                        <LogOut className=\"w-4 h-4 mr-2\" />\n                        Logout\n                      </Button>\n                    </div>\n                  )}\n                </div>\n              </SheetContent>\n            </Sheet>\n          </div>\n        </div>\n      </header>\n\n      <main className=\"flex-1 pt-16 pb-12 container mx-auto px-4\">\n        {children}\n      </main>\n\n      <footer \n        className=\"border-t border-border/40\"\n        role=\"contentinfo\"\n        aria-label=\"Site footer\"\n      >\n        <div className=\"container mx-auto px-4 py-3\">\n          <div className=\"flex flex-wrap items-center justify-center gap-x-3 gap-y-2 text-xs text-muted-foreground\">\n            <Link href=\"/contact\" className=\"hover:text-primary transition-colors\" data-testid=\"link-footer-contact\">Contact</Link>\n            <span className=\"text-muted-foreground/40\">Â·</span>\n            <Link href=\"/about\" className=\"hover:text-primary transition-colors\" data-testid=\"link-footer-about\">About</Link>\n            <span className=\"text-muted-foreground/40\">Â·</span>\n            <Link href=\"/privacy-policy\" className=\"hover:text-primary transition-colors\" data-testid=\"link-footer-privacy\">Privacy</Link>\n            <span className=\"text-muted-foreground/40\">Â·</span>\n            <Link href=\"/terms-of-service\" className=\"hover:text-primary transition-colors\" data-testid=\"link-footer-terms\">Terms</Link>\n            <span className=\"text-muted-foreground/40\">Â·</span>\n            <Link href=\"/cookie-policy\" className=\"hover:text-primary transition-colors\" data-testid=\"link-footer-cookies\">Cookies</Link>\n            <span className=\"text-muted-foreground/40\">Â·</span>\n            <Link href=\"/ai-transparency\" className=\"hover:text-primary transition-colors\" data-testid=\"link-footer-ai\">AI Transparency</Link>\n            <span className=\"text-muted-foreground/40\">Â·</span>\n            <Link href=\"/accessibility\" className=\"hover:text-primary transition-colors\" data-testid=\"link-footer-accessibility\">Accessibility</Link>\n            <span className=\"text-muted-foreground/40\">Â·</span>\n            <Link href=\"/privacy-policy#california-residents\" className=\"hover:text-amber-500 transition-colors\" data-testid=\"link-footer-ccpa\">Do Not Sell</Link>\n            <span className=\"text-muted-foreground/40\">Â·</span>\n            <span>Â© {new Date().getFullYear()} TypeMasterAI</span>\n            <span className=\"text-muted-foreground/40\">Â·</span>\n            <a href=\"mailto:support@typemasterai.com\" className=\"hover:text-primary transition-colors\" data-testid=\"link-footer-support-email\">support@typemasterai.com</a>\n            <span className=\"text-muted-foreground/40\">Â·</span>\n            <span className=\"text-[10px]\">Registered in Solapur, India</span>\n          </div>\n        </div>\n      </footer>\n    </div>\n  );\n}\n","path":null,"size_bytes":40776,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-2 w-full overflow-hidden rounded-full bg-primary/20\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":792,"size_tokens":null},"client/src/components/certificate-generator.tsx":{"content":"import { useRef, useEffect, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Download } from \"lucide-react\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { jsPDF } from \"jspdf\";\n\ninterface CertificateProps {\n  username: string;\n  wpm: number;\n  accuracy: number;\n  mode: number;\n  date: Date;\n  freestyle?: boolean;\n  characters?: number;\n  words?: number;\n  consistency?: number;\n}\n\ntype DownloadFormat = \"png\" | \"pdf\" | \"jpeg\";\n\nexport function CertificateGenerator({ username, wpm, accuracy, mode, date, freestyle = false, characters = 0, words = 0, consistency = 100 }: CertificateProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [selectedFormat, setSelectedFormat] = useState<DownloadFormat>(\"png\");\n\n  useEffect(() => {\n    generateCertificate();\n  }, [username, wpm, accuracy, mode, date, freestyle, characters, words, consistency]);\n\n  const generateCertificate = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const ctx = canvas.getContext(\"2d\");\n    if (!ctx) return;\n\n    // Set canvas size for higher quality\n    canvas.width = 1200;\n    canvas.height = 800;\n\n    // Background gradient\n    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);\n    gradient.addColorStop(0, \"#0f172a\");\n    gradient.addColorStop(0.5, \"#1e293b\");\n    gradient.addColorStop(1, \"#0f172a\");\n    ctx.fillStyle = gradient;\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n\n    // Decorative border\n    ctx.strokeStyle = \"#00ffff\";\n    ctx.lineWidth = 8;\n    ctx.strokeRect(40, 40, canvas.width - 80, canvas.height - 80);\n\n    // Inner border\n    ctx.strokeStyle = \"#a855f7\";\n    ctx.lineWidth = 2;\n    ctx.strokeRect(60, 60, canvas.width - 120, canvas.height - 120);\n\n    // Corner decorations\n    const cornerSize = 40;\n    ctx.fillStyle = \"#00ffff\";\n    // Top-left\n    ctx.fillRect(40, 40, cornerSize, 8);\n    ctx.fillRect(40, 40, 8, cornerSize);\n    // Top-right\n    ctx.fillRect(canvas.width - 80, 40, cornerSize, 8);\n    ctx.fillRect(canvas.width - 48, 40, 8, cornerSize);\n    // Bottom-left\n    ctx.fillRect(40, canvas.height - 48, cornerSize, 8);\n    ctx.fillRect(40, canvas.height - 80, 8, cornerSize);\n    // Bottom-right\n    ctx.fillRect(canvas.width - 80, canvas.height - 48, cornerSize, 8);\n    ctx.fillRect(canvas.width - 48, canvas.height - 80, 8, cornerSize);\n\n    // Logo/Seal (top-left corner)\n    ctx.beginPath();\n    ctx.arc(140, 140, 45, 0, Math.PI * 2);\n    ctx.strokeStyle = \"#00ffff\";\n    ctx.lineWidth = 3;\n    ctx.stroke();\n    ctx.fillStyle = \"#00ffff\";\n    ctx.font = \"bold 30px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"TM\", 140, 148);\n\n    // Title\n    ctx.fillStyle = \"#00ffff\";\n    ctx.font = \"bold 48px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"CERTIFICATE OF ACHIEVEMENT\", canvas.width / 2, 150);\n\n    // Subtitle\n    ctx.fillStyle = \"#94a3b8\";\n    ctx.font = \"24px 'DM Sans', sans-serif\";\n    ctx.fillText(\"This certifies that\", canvas.width / 2, 220);\n\n    // User name\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 56px 'DM Sans', sans-serif\";\n    ctx.fillText(username, canvas.width / 2, 300);\n\n    // Achievement text\n    ctx.fillStyle = \"#94a3b8\";\n    ctx.font = \"24px 'DM Sans', sans-serif\";\n    const achievementText = freestyle \n      ? \"has successfully completed a freestyle typing session with\"\n      : \"has successfully completed a typing test with\";\n    ctx.fillText(achievementText, canvas.width / 2, 360);\n\n    // Stats box\n    const boxY = 400;\n    const boxHeight = 140;\n    ctx.fillStyle = \"rgba(30, 41, 59, 0.7)\";\n    ctx.fillRect(200, boxY, canvas.width - 400, boxHeight);\n    ctx.strokeStyle = \"#a855f7\";\n    ctx.lineWidth = 2;\n    ctx.strokeRect(200, boxY, canvas.width - 400, boxHeight);\n\n    if (freestyle) {\n      // Freestyle mode: Show WPM, Words, Characters\n      // WPM stat\n      ctx.fillStyle = \"#00ffff\";\n      ctx.font = \"bold 64px 'JetBrains Mono', monospace\";\n      ctx.textAlign = \"center\";\n      ctx.fillText(`${wpm}`, 400, boxY + 70);\n      ctx.fillStyle = \"#94a3b8\";\n      ctx.font = \"18px 'DM Sans', sans-serif\";\n      ctx.fillText(\"Words Per Minute\", 400, boxY + 105);\n\n      // Words stat\n      ctx.fillStyle = \"#a855f7\";\n      ctx.font = \"bold 64px 'JetBrains Mono', monospace\";\n      ctx.fillText(`${words}`, canvas.width / 2, boxY + 70);\n      ctx.fillStyle = \"#94a3b8\";\n      ctx.font = \"18px 'DM Sans', sans-serif\";\n      ctx.fillText(\"Words Typed\", canvas.width / 2, boxY + 105);\n\n      // Characters stat\n      ctx.fillStyle = \"#00ffff\";\n      ctx.font = \"bold 64px 'JetBrains Mono', monospace\";\n      ctx.fillText(`${characters}`, 800, boxY + 70);\n      ctx.fillStyle = \"#94a3b8\";\n      ctx.font = \"18px 'DM Sans', sans-serif\";\n      ctx.fillText(\"Characters\", 800, boxY + 105);\n    } else {\n      // Standard mode: Show WPM, Accuracy, Duration\n      // WPM stat\n      ctx.fillStyle = \"#00ffff\";\n      ctx.font = \"bold 64px 'JetBrains Mono', monospace\";\n      ctx.textAlign = \"center\";\n      ctx.fillText(`${wpm}`, 400, boxY + 70);\n      ctx.fillStyle = \"#94a3b8\";\n      ctx.font = \"18px 'DM Sans', sans-serif\";\n      ctx.fillText(\"Words Per Minute\", 400, boxY + 105);\n\n      // Accuracy stat\n      ctx.fillStyle = \"#a855f7\";\n      ctx.font = \"bold 64px 'JetBrains Mono', monospace\";\n      ctx.fillText(`${accuracy}%`, canvas.width / 2, boxY + 70);\n      ctx.fillStyle = \"#94a3b8\";\n      ctx.font = \"18px 'DM Sans', sans-serif\";\n      ctx.fillText(\"Accuracy\", canvas.width / 2, boxY + 105);\n\n      // Mode stat\n      ctx.fillStyle = \"#00ffff\";\n      ctx.font = \"bold 64px 'JetBrains Mono', monospace\";\n      const modeText = mode >= 60 ? `${Math.floor(mode / 60)}min` : `${mode}s`;\n      ctx.fillText(modeText, 800, boxY + 70);\n      ctx.fillStyle = \"#94a3b8\";\n      ctx.font = \"18px 'DM Sans', sans-serif\";\n      ctx.fillText(\"Test Duration\", 800, boxY + 105);\n    }\n\n    // Date\n    ctx.fillStyle = \"#64748b\";\n    ctx.font = \"18px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"center\";\n    const formattedDate = date.toLocaleDateString(\"en-US\", {\n      year: \"numeric\",\n      month: \"long\",\n      day: \"numeric\",\n    });\n    ctx.fillText(`Completed on ${formattedDate}`, canvas.width / 2, 600);\n\n    // TypeMasterAI branding\n    ctx.textAlign = \"center\";\n    ctx.fillStyle = \"#00ffff\";\n    ctx.font = \"bold 36px 'DM Sans', sans-serif\";\n    ctx.fillText(\"TypeMasterAI\", canvas.width / 2, 670);\n    \n    ctx.fillStyle = \"#64748b\";\n    ctx.font = \"16px 'DM Sans', sans-serif\";\n    ctx.fillText(\"Master Your Typing with AI\", canvas.width / 2, 700);\n    \n    // Website URL\n    ctx.fillStyle = \"#a855f7\";\n    ctx.font = \"bold 18px 'DM Sans', sans-serif\";\n    ctx.fillText(\"typemasterai.com\", canvas.width / 2, 730);\n\n    // Signature line (bottom right)\n    const signatureX = canvas.width - 280;\n    const signatureY = 750;\n    ctx.strokeStyle = \"#475569\";\n    ctx.lineWidth = 1;\n    ctx.beginPath();\n    ctx.moveTo(signatureX, signatureY);\n    ctx.lineTo(signatureX + 200, signatureY);\n    ctx.stroke();\n    ctx.fillStyle = \"#64748b\";\n    ctx.font = \"12px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"Certified by TypeMasterAI\", signatureX + 100, signatureY + 15);\n  };\n\n  const downloadCertificate = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const filename = `TypeMasterAI_Certificate_${username}_${wpm}WPM`;\n\n    switch (selectedFormat) {\n      case \"png\":\n        downloadPNG(canvas, filename);\n        break;\n      case \"jpeg\":\n        downloadJPEG(canvas, filename);\n        break;\n      case \"pdf\":\n        downloadPDF(canvas, filename);\n        break;\n    }\n  };\n\n  const downloadPNG = (canvas: HTMLCanvasElement, filename: string) => {\n    const link = document.createElement(\"a\");\n    link.download = `${filename}.png`;\n    link.href = canvas.toDataURL(\"image/png\");\n    link.click();\n  };\n\n  const downloadJPEG = (canvas: HTMLCanvasElement, filename: string) => {\n    const link = document.createElement(\"a\");\n    link.download = `${filename}.jpg`;\n    link.href = canvas.toDataURL(\"image/jpeg\", 0.95);\n    link.click();\n  };\n\n  const downloadPDF = (canvas: HTMLCanvasElement, filename: string) => {\n    const imgData = canvas.toDataURL(\"image/png\");\n    \n    // Create PDF with landscape orientation\n    const pdf = new jsPDF({\n      orientation: \"landscape\",\n      unit: \"mm\",\n      format: \"a4\",\n    });\n\n    // A4 landscape dimensions: 297mm x 210mm\n    const pdfWidth = 297;\n    const pdfHeight = 210;\n    \n    // Calculate aspect ratio\n    const canvasAspectRatio = canvas.width / canvas.height;\n    const pdfAspectRatio = pdfWidth / pdfHeight;\n    \n    let imgWidth = pdfWidth;\n    let imgHeight = pdfHeight;\n    \n    // Fit image to PDF while maintaining aspect ratio\n    if (canvasAspectRatio > pdfAspectRatio) {\n      imgHeight = pdfWidth / canvasAspectRatio;\n    } else {\n      imgWidth = pdfHeight * canvasAspectRatio;\n    }\n    \n    // Center the image\n    const xOffset = (pdfWidth - imgWidth) / 2;\n    const yOffset = (pdfHeight - imgHeight) / 2;\n    \n    pdf.addImage(imgData, \"PNG\", xOffset, yOffset, imgWidth, imgHeight);\n    pdf.save(`${filename}.pdf`);\n  };\n\n  return (\n    <div className=\"flex flex-col items-center gap-6\">\n      <canvas\n        ref={canvasRef}\n        className=\"border-2 border-border rounded-lg shadow-2xl max-w-full h-auto\"\n        style={{ maxHeight: \"500px\" }}\n      />\n      \n      {/* Download Section */}\n      <div className=\"flex flex-col sm:flex-row items-center gap-4 w-full max-w-md\">\n        <div className=\"flex flex-col gap-2 w-full sm:w-auto\">\n          <label className=\"text-sm text-muted-foreground font-medium\">\n            Download Format\n          </label>\n          <Select\n            value={selectedFormat}\n            onValueChange={(value) => setSelectedFormat(value as DownloadFormat)}\n          >\n            <SelectTrigger \n              className=\"w-full sm:w-[180px]\"\n              data-testid=\"select-certificate-format\"\n            >\n              <SelectValue placeholder=\"Select format\" />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"png\" data-testid=\"format-png\">\n                PNG (High Quality)\n              </SelectItem>\n              <SelectItem value=\"jpeg\" data-testid=\"format-jpeg\">\n                JPEG (Compressed)\n              </SelectItem>\n              <SelectItem value=\"pdf\" data-testid=\"format-pdf\">\n                PDF (Printable)\n              </SelectItem>\n            </SelectContent>\n          </Select>\n        </div>\n\n        <Button\n          onClick={downloadCertificate}\n          size=\"lg\"\n          className=\"gap-2 w-full sm:w-auto sm:mt-7\"\n          data-testid=\"button-download-certificate\"\n        >\n          <Download className=\"w-5 h-5\" />\n          Download {selectedFormat.toUpperCase()}\n        </Button>\n      </div>\n      \n      <p className=\"text-sm text-muted-foreground text-center\">\n        Use the Share button after completing a test to share your certificate on social media\n      </p>\n    </div>\n  );\n}\n","path":null,"size_bytes":11175,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"import * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3007,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/pages/profile-edit.tsx":{"content":"import { useState, useEffect, useCallback } from \"react\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { ArrowLeft, Check, HelpCircle, Loader2, AlertCircle, RefreshCw } from \"lucide-react\";\nimport { cn } from \"@/lib/utils\";\nimport { SearchableSelect } from \"@/components/searchable-select\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\n\nconst AVATAR_COLORS = [\n  { value: \"bg-primary\", label: \"Amber\", class: \"bg-primary\" },\n  { value: \"bg-blue-500\", label: \"Blue\", class: \"bg-blue-500\" },\n  { value: \"bg-green-500\", label: \"Green\", class: \"bg-green-500\" },\n  { value: \"bg-purple-500\", label: \"Purple\", class: \"bg-purple-500\" },\n  { value: \"bg-pink-500\", label: \"Pink\", class: \"bg-pink-500\" },\n  { value: \"bg-red-500\", label: \"Red\", class: \"bg-red-500\" },\n  { value: \"bg-orange-500\", label: \"Orange\", class: \"bg-orange-500\" },\n  { value: \"bg-cyan-500\", label: \"Cyan\", class: \"bg-cyan-500\" },\n];\n\nconst COUNTRY_OPTIONS = [\n  \"Afghanistan\", \"Albania\", \"Algeria\", \"Andorra\", \"Angola\", \"Antigua and Barbuda\", \"Argentina\", \"Armenia\",\n  \"Australia\", \"Austria\", \"Azerbaijan\", \"Bahamas\", \"Bahrain\", \"Bangladesh\", \"Barbados\", \"Belarus\",\n  \"Belgium\", \"Belize\", \"Benin\", \"Bhutan\", \"Bolivia\", \"Bosnia and Herzegovina\", \"Botswana\", \"Brazil\",\n  \"Brunei\", \"Bulgaria\", \"Burkina Faso\", \"Burundi\", \"Cabo Verde\", \"Cambodia\", \"Cameroon\", \"Canada\",\n  \"Central African Republic\", \"Chad\", \"Chile\", \"China\", \"Colombia\", \"Comoros\", \"Congo (Democratic Republic)\",\n  \"Congo (Republic)\", \"Costa Rica\", \"Croatia\", \"Cuba\", \"Cyprus\", \"Czech Republic\", \"Denmark\", \"Djibouti\",\n  \"Dominica\", \"Dominican Republic\", \"East Timor\", \"Ecuador\", \"Egypt\", \"El Salvador\", \"Equatorial Guinea\",\n  \"Eritrea\", \"Estonia\", \"Eswatini\", \"Ethiopia\", \"Fiji\", \"Finland\", \"France\", \"Gabon\", \"Gambia\", \"Georgia\",\n  \"Germany\", \"Ghana\", \"Greece\", \"Grenada\", \"Guatemala\", \"Guinea\", \"Guinea-Bissau\", \"Guyana\", \"Haiti\",\n  \"Honduras\", \"Hungary\", \"Iceland\", \"India\", \"Indonesia\", \"Iran\", \"Iraq\", \"Ireland\", \"Israel\", \"Italy\",\n  \"Ivory Coast\", \"Jamaica\", \"Japan\", \"Jordan\", \"Kazakhstan\", \"Kenya\", \"Kiribati\", \"Kosovo\", \"Kuwait\",\n  \"Kyrgyzstan\", \"Laos\", \"Latvia\", \"Lebanon\", \"Lesotho\", \"Liberia\", \"Libya\", \"Liechtenstein\", \"Lithuania\",\n  \"Luxembourg\", \"Madagascar\", \"Malawi\", \"Malaysia\", \"Maldives\", \"Mali\", \"Malta\", \"Marshall Islands\",\n  \"Mauritania\", \"Mauritius\", \"Mexico\", \"Micronesia\", \"Moldova\", \"Monaco\", \"Mongolia\", \"Montenegro\",\n  \"Morocco\", \"Mozambique\", \"Myanmar\", \"Namibia\", \"Nauru\", \"Nepal\", \"Netherlands\", \"New Zealand\",\n  \"Nicaragua\", \"Niger\", \"Nigeria\", \"North Korea\", \"North Macedonia\", \"Norway\", \"Oman\", \"Pakistan\",\n  \"Palau\", \"Palestine\", \"Panama\", \"Papua New Guinea\", \"Paraguay\", \"Peru\", \"Philippines\", \"Poland\",\n  \"Portugal\", \"Qatar\", \"Romania\", \"Russia\", \"Rwanda\", \"Saint Kitts and Nevis\", \"Saint Lucia\",\n  \"Saint Vincent and the Grenadines\", \"Samoa\", \"San Marino\", \"Sao Tome and Principe\", \"Saudi Arabia\",\n  \"Senegal\", \"Serbia\", \"Seychelles\", \"Sierra Leone\", \"Singapore\", \"Slovakia\", \"Slovenia\", \"Solomon Islands\",\n  \"Somalia\", \"South Africa\", \"South Korea\", \"South Sudan\", \"Spain\", \"Sri Lanka\", \"Sudan\", \"Suriname\",\n  \"Sweden\", \"Switzerland\", \"Syria\", \"Taiwan\", \"Tajikistan\", \"Tanzania\", \"Thailand\", \"Togo\", \"Tonga\",\n  \"Trinidad and Tobago\", \"Tunisia\", \"Turkey\", \"Turkmenistan\", \"Tuvalu\", \"Uganda\", \"Ukraine\",\n  \"United Arab Emirates\", \"United Kingdom\", \"United States\", \"Uruguay\", \"Uzbekistan\", \"Vanuatu\",\n  \"Vatican City\", \"Venezuela\", \"Vietnam\", \"Yemen\", \"Zambia\", \"Zimbabwe\", \"Other\"\n].map(c => ({ value: c, label: c }));\n\nconst KEYBOARD_LAYOUTS = [\"QWERTY\", \"DVORAK\", \"COLEMAK\", \"AZERTY\", \"QWERTZ\", \"Other\"];\n\nexport default function ProfileEdit() {\n  const { user } = useAuth();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const [avatarColor, setAvatarColor] = useState(user?.avatarColor || \"bg-primary\");\n  const [bio, setBio] = useState(user?.bio || \"\");\n  const [country, setCountry] = useState(user?.country || \"\");\n  const [keyboardLayout, setKeyboardLayout] = useState(user?.keyboardLayout || \"QWERTY\");\n  const [errorMessage, setErrorMessage] = useState<string | null>(null);\n  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);\n  const [retryCount, setRetryCount] = useState(0);\n\n  const initialValues = {\n    avatarColor: user?.avatarColor || \"bg-primary\",\n    bio: user?.bio || \"\",\n    country: user?.country || \"\",\n    keyboardLayout: user?.keyboardLayout || \"QWERTY\",\n  };\n\n  useEffect(() => {\n    const hasChanges = \n      avatarColor !== initialValues.avatarColor ||\n      bio !== initialValues.bio ||\n      country !== initialValues.country ||\n      keyboardLayout !== initialValues.keyboardLayout;\n    setHasUnsavedChanges(hasChanges);\n  }, [avatarColor, bio, country, keyboardLayout, initialValues.avatarColor, initialValues.bio, initialValues.country, initialValues.keyboardLayout]);\n\n  useEffect(() => {\n    const handleBeforeUnload = (e: BeforeUnloadEvent) => {\n      if (hasUnsavedChanges) {\n        e.preventDefault();\n        e.returnValue = \"\";\n      }\n    };\n    window.addEventListener(\"beforeunload\", handleBeforeUnload);\n    return () => window.removeEventListener(\"beforeunload\", handleBeforeUnload);\n  }, [hasUnsavedChanges]);\n\n  const updateProfileMutation = useMutation({\n    mutationFn: async (data: any) => {\n      setErrorMessage(null);\n      const response = await fetch(\"/api/profile\", {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.message || errorData.error || `Failed to update profile (Error ${response.status})`);\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"user\"] });\n      setHasUnsavedChanges(false);\n      toast({\n        title: \"Profile Updated!\",\n        description: \"Your profile has been updated successfully.\",\n      });\n      setLocation(\"/profile\");\n    },\n    onError: (error: Error) => {\n      setErrorMessage(error.message);\n      setRetryCount(prev => prev + 1);\n      toast({\n        title: \"Update Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleRetry = useCallback(() => {\n    updateProfileMutation.mutate({\n      avatarColor,\n      bio: bio || null,\n      country: country || null,\n      keyboardLayout,\n    });\n  }, [avatarColor, bio, country, keyboardLayout, updateProfileMutation]);\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    updateProfileMutation.mutate({\n      avatarColor,\n      bio: bio || null,\n      country: country || null,\n      keyboardLayout,\n    });\n  };\n\n  if (!user) {\n    setLocation(\"/login\");\n    return null;\n  }\n\n  const bioCharWarning = bio.length >= 180;\n  const bioCharLimit = bio.length >= 200;\n\n  return (\n    <TooltipProvider delayDuration={200}>\n      <div className=\"max-w-2xl mx-auto space-y-6\">\n        <div className=\"flex items-center gap-4\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button variant=\"ghost\" size=\"icon\" onClick={() => setLocation(\"/profile\")} data-testid=\"button-back\">\n                <ArrowLeft className=\"w-5 h-5\" />\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>Back to profile</p>\n            </TooltipContent>\n          </Tooltip>\n          <div>\n            <h1 className=\"text-3xl font-bold\">Edit Profile</h1>\n            <p className=\"text-muted-foreground\">Customize your typing profile</p>\n          </div>\n          {hasUnsavedChanges && (\n            <div className=\"ml-auto flex items-center gap-2 text-amber-500 text-sm\">\n              <AlertCircle className=\"w-4 h-4\" />\n              <span>Unsaved changes</span>\n            </div>\n          )}\n        </div>\n\n        {errorMessage && (\n          <Alert variant=\"destructive\" className=\"border-destructive/50 bg-destructive/10\">\n            <AlertCircle className=\"h-4 w-4\" />\n            <AlertDescription className=\"flex items-center justify-between\">\n              <span>{errorMessage}</span>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={handleRetry}\n                disabled={updateProfileMutation.isPending}\n                className=\"ml-4\"\n                data-testid=\"button-retry\"\n              >\n                <RefreshCw className={cn(\"w-4 h-4 mr-2\", updateProfileMutation.isPending && \"animate-spin\")} />\n                Retry {retryCount > 1 ? `(${retryCount})` : \"\"}\n              </Button>\n            </AlertDescription>\n          </Alert>\n        )}\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <CardTitle>Avatar Color</CardTitle>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                  </TooltipTrigger>\n                  <TooltipContent side=\"right\" className=\"max-w-xs\">\n                    <p>Your avatar color appears on your profile, leaderboards, and in multiplayer races. Choose a color that represents you!</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n              <CardDescription>Choose a color for your avatar</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center gap-4\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Avatar className=\"w-20 h-20 border-4 border-background shadow-xl cursor-pointer\">\n                      <AvatarFallback className={cn(avatarColor, \"text-primary-foreground text-2xl\")}>\n                        {user.username[0].toUpperCase()}\n                      </AvatarFallback>\n                    </Avatar>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>This is how your avatar will appear to others</p>\n                  </TooltipContent>\n                </Tooltip>\n                <div className=\"flex-1\">\n                  <div className=\"grid grid-cols-8 gap-2\">\n                    {AVATAR_COLORS.map((color) => (\n                      <Tooltip key={color.value}>\n                        <TooltipTrigger asChild>\n                          <button\n                            type=\"button\"\n                            onClick={() => setAvatarColor(color.value)}\n                            className={cn(\n                              \"w-10 h-10 rounded-full border-2 transition-all\",\n                              color.class,\n                              avatarColor === color.value\n                                ? \"border-foreground scale-110 ring-2 ring-foreground/20\"\n                                : \"border-border hover:scale-105\"\n                            )}\n                            data-testid={`color-${color.label.toLowerCase()}`}\n                          >\n                            {avatarColor === color.value && (\n                              <Check className=\"w-5 h-5 mx-auto text-white drop-shadow-sm\" />\n                            )}\n                          </button>\n                        </TooltipTrigger>\n                        <TooltipContent>\n                          <p>{color.label}</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    ))}\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <CardTitle>Bio</CardTitle>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                  </TooltipTrigger>\n                  <TooltipContent side=\"right\" className=\"max-w-xs\">\n                    <p>Write a short description about yourself. This will be visible on your public profile and helps other typists get to know you.</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n              <CardDescription>Tell others about yourself (max 200 characters)</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Textarea\n                value={bio}\n                onChange={(e) => setBio(e.target.value)}\n                placeholder=\"I love typing and improving my speed...\"\n                maxLength={200}\n                rows={3}\n                className={cn(\n                  bioCharLimit && \"border-destructive focus-visible:ring-destructive\",\n                  bioCharWarning && !bioCharLimit && \"border-amber-500 focus-visible:ring-amber-500\"\n                )}\n                data-testid=\"input-bio\"\n              />\n              <div className=\"flex items-center justify-between mt-2\">\n                <p className={cn(\n                  \"text-xs transition-colors\",\n                  bioCharLimit ? \"text-destructive font-medium\" : \n                  bioCharWarning ? \"text-amber-500\" : \"text-muted-foreground\"\n                )}>\n                  {bio.length}/200 characters\n                  {bioCharLimit && \" (limit reached)\"}\n                  {bioCharWarning && !bioCharLimit && \" (approaching limit)\"}\n                </p>\n                {bio.length > 0 && (\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        type=\"button\"\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        className=\"h-6 text-xs text-muted-foreground hover:text-foreground\"\n                        onClick={() => setBio(\"\")}\n                        data-testid=\"button-clear-bio\"\n                      >\n                        Clear\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>Clear your bio</p>\n                    </TooltipContent>\n                  </Tooltip>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <CardTitle>Location</CardTitle>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                  </TooltipTrigger>\n                  <TooltipContent side=\"right\" className=\"max-w-xs\">\n                    <p>Your country is displayed on your profile and helps you find typists from your region. It may also be used for regional leaderboards.</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n              <CardDescription>Your country or region</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-2\">\n              <SearchableSelect\n                value={country}\n                onValueChange={setCountry}\n                options={COUNTRY_OPTIONS}\n                placeholder=\"Select your country\"\n                searchPlaceholder=\"Search countries...\"\n                emptyText=\"No country found.\"\n                data-testid=\"select-country\"\n              />\n              {country && (\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button\n                      type=\"button\"\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      className=\"h-6 text-xs text-muted-foreground hover:text-foreground\"\n                      onClick={() => setCountry(\"\")}\n                      data-testid=\"button-clear-country\"\n                    >\n                      Clear selection\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Remove country from profile</p>\n                  </TooltipContent>\n                </Tooltip>\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-2\">\n                <CardTitle>Keyboard Layout</CardTitle>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                  </TooltipTrigger>\n                  <TooltipContent side=\"right\" className=\"max-w-xs\">\n                    <p>Your keyboard layout affects typing analytics and comparisons. Select the layout that matches your physical keyboard for accurate statistics.</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n              <CardDescription>Your preferred keyboard layout</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Select value={keyboardLayout} onValueChange={setKeyboardLayout}>\n                <SelectTrigger data-testid=\"select-keyboard\">\n                  <SelectValue placeholder=\"Select layout\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {KEYBOARD_LAYOUTS.map((layout) => (\n                    <SelectItem key={layout} value={layout}>\n                      {layout}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <p className=\"text-xs text-muted-foreground mt-2\">\n                {keyboardLayout === \"QWERTY\" && \"Standard layout used in most English-speaking countries\"}\n                {keyboardLayout === \"DVORAK\" && \"Alternative layout optimized for efficiency\"}\n                {keyboardLayout === \"COLEMAK\" && \"Modern layout balancing efficiency and ease of learning\"}\n                {keyboardLayout === \"AZERTY\" && \"Standard layout used in French-speaking countries\"}\n                {keyboardLayout === \"QWERTZ\" && \"Standard layout used in German-speaking countries\"}\n                {keyboardLayout === \"Other\" && \"Custom or non-standard keyboard layout\"}\n              </p>\n            </CardContent>\n          </Card>\n\n          <div className=\"flex gap-3 justify-end items-center\">\n            {hasUnsavedChanges && (\n              <span className=\"text-sm text-muted-foreground mr-auto\">\n                Don't forget to save your changes!\n              </span>\n            )}\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => setLocation(\"/profile\")}\n                  disabled={updateProfileMutation.isPending}\n                  data-testid=\"button-cancel\"\n                >\n                  Cancel\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Discard changes and return to profile</p>\n              </TooltipContent>\n            </Tooltip>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Button \n                  type=\"submit\" \n                  disabled={updateProfileMutation.isPending || !hasUnsavedChanges} \n                  data-testid=\"button-save-profile\"\n                  className=\"min-w-[120px]\"\n                >\n                  {updateProfileMutation.isPending ? (\n                    <>\n                      <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                      Saving...\n                    </>\n                  ) : (\n                    \"Save Changes\"\n                  )}\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>{hasUnsavedChanges ? \"Save your profile changes\" : \"No changes to save\"}</p>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n        </form>\n      </div>\n    </TooltipProvider>\n  );\n}\n","path":null,"size_bytes":20811,"size_tokens":null},"client/src/components/ui/field.tsx":{"content":"\"use client\"\n\nimport { useMemo } from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\nimport { Separator } from \"@/components/ui/separator\"\n\nfunction FieldSet({ className, ...props }: React.ComponentProps<\"fieldset\">) {\n  return (\n    <fieldset\n      data-slot=\"field-set\"\n      className={cn(\n        \"flex flex-col gap-6\",\n        \"has-[>[data-slot=checkbox-group]]:gap-3 has-[>[data-slot=radio-group]]:gap-3\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldLegend({\n  className,\n  variant = \"legend\",\n  ...props\n}: React.ComponentProps<\"legend\"> & { variant?: \"legend\" | \"label\" }) {\n  return (\n    <legend\n      data-slot=\"field-legend\"\n      data-variant={variant}\n      className={cn(\n        \"mb-3 font-medium\",\n        \"data-[variant=legend]:text-base\",\n        \"data-[variant=label]:text-sm\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-group\"\n      className={cn(\n        \"group/field-group @container/field-group flex w-full flex-col gap-7 data-[slot=checkbox-group]:gap-3 [&>[data-slot=field-group]]:gap-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nconst fieldVariants = cva(\n  \"group/field data-[invalid=true]:text-destructive flex w-full gap-3\",\n  {\n    variants: {\n      orientation: {\n        vertical: [\"flex-col [&>*]:w-full [&>.sr-only]:w-auto\"],\n        horizontal: [\n          \"flex-row items-center\",\n          \"[&>[data-slot=field-label]]:flex-auto\",\n          \"has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px has-[>[data-slot=field-content]]:items-start\",\n        ],\n        responsive: [\n          \"@md/field-group:flex-row @md/field-group:items-center @md/field-group:[&>*]:w-auto flex-col [&>*]:w-full [&>.sr-only]:w-auto\",\n          \"@md/field-group:[&>[data-slot=field-label]]:flex-auto\",\n          \"@md/field-group:has-[>[data-slot=field-content]]:items-start @md/field-group:has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px\",\n        ],\n      },\n    },\n    defaultVariants: {\n      orientation: \"vertical\",\n    },\n  }\n)\n\nfunction Field({\n  className,\n  orientation = \"vertical\",\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof fieldVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"field\"\n      data-orientation={orientation}\n      className={cn(fieldVariants({ orientation }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction FieldContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-content\"\n      className={cn(\n        \"group/field-content flex flex-1 flex-col gap-1.5 leading-snug\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldLabel({\n  className,\n  ...props\n}: React.ComponentProps<typeof Label>) {\n  return (\n    <Label\n      data-slot=\"field-label\"\n      className={cn(\n        \"group/field-label peer/field-label flex w-fit gap-2 leading-snug group-data-[disabled=true]/field:opacity-50\",\n        \"has-[>[data-slot=field]]:w-full has-[>[data-slot=field]]:flex-col has-[>[data-slot=field]]:rounded-md has-[>[data-slot=field]]:border [&>[data-slot=field]]:p-4\",\n        \"has-data-[state=checked]:bg-primary/5 has-data-[state=checked]:border-primary dark:has-data-[state=checked]:bg-primary/10\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"field-label\"\n      className={cn(\n        \"flex w-fit items-center gap-2 text-sm font-medium leading-snug group-data-[disabled=true]/field:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldDescription({ className, ...props }: React.ComponentProps<\"p\">) {\n  return (\n    <p\n      data-slot=\"field-description\"\n      className={cn(\n        \"text-muted-foreground text-sm font-normal leading-normal group-has-[[data-orientation=horizontal]]/field:text-balance\",\n        \"nth-last-2:-mt-1 last:mt-0 [[data-variant=legend]+&]:-mt-1.5\",\n        \"[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction FieldSeparator({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  children?: React.ReactNode\n}) {\n  return (\n    <div\n      data-slot=\"field-separator\"\n      data-content={!!children}\n      className={cn(\n        \"relative -my-2 h-5 text-sm group-data-[variant=outline]/field-group:-mb-2\",\n        className\n      )}\n      {...props}\n    >\n      <Separator className=\"absolute inset-0 top-1/2\" />\n      {children && (\n        <span\n          className=\"bg-background text-muted-foreground relative mx-auto block w-fit px-2\"\n          data-slot=\"field-separator-content\"\n        >\n          {children}\n        </span>\n      )}\n    </div>\n  )\n}\n\nfunction FieldError({\n  className,\n  children,\n  errors,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  errors?: Array<{ message?: string } | undefined>\n}) {\n  const content = useMemo(() => {\n    if (children) {\n      return children\n    }\n\n    if (!errors) {\n      return null\n    }\n\n    if (errors?.length === 1 && errors[0]?.message) {\n      return errors[0].message\n    }\n\n    return (\n      <ul className=\"ml-4 flex list-disc flex-col gap-1\">\n        {errors.map(\n          (error, index) =>\n            error?.message && <li key={index}>{error.message}</li>\n        )}\n      </ul>\n    )\n  }, [children, errors])\n\n  if (!content) {\n    return null\n  }\n\n  return (\n    <div\n      role=\"alert\"\n      data-slot=\"field-error\"\n      className={cn(\"text-destructive text-sm font-normal\", className)}\n      {...props}\n    >\n      {content}\n    </div>\n  )\n}\n\nexport {\n  Field,\n  FieldLabel,\n  FieldDescription,\n  FieldError,\n  FieldGroup,\n  FieldLegend,\n  FieldSeparator,\n  FieldSet,\n  FieldContent,\n  FieldTitle,\n}\n","path":null,"size_bytes":6044,"size_tokens":null},"client/src/pages/settings.tsx":{"content":"import { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Label } from \"@/components/ui/label\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Moon, Volume2, Keyboard, Shield, Trash2, Eye, EyeOff, CheckCircle2, XCircle, AlertCircle, HelpCircle, Link2, Unlink, Github, Loader2 } from \"lucide-react\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useTheme } from \"@/lib/theme-context\";\nimport { useState, useEffect } from \"react\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useLocation } from \"wouter\";\nimport { keyboardSound, type SoundType } from \"@/lib/keyboard-sounds\";\nimport { cn } from \"@/lib/utils\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \"@/components/ui/alert-dialog\";\n\nfunction GoogleIcon({ className }: { className?: string }) {\n  return (\n    <svg className={className} viewBox=\"0 0 24 24\" fill=\"currentColor\">\n      <path d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\" fill=\"#4285F4\"/>\n      <path d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\" fill=\"#34A853\"/>\n      <path d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z\" fill=\"#FBBC05\"/>\n      <path d=\"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\" fill=\"#EA4335\"/>\n    </svg>\n  );\n}\n\nfunction FacebookIcon({ className }: { className?: string }) {\n  return (\n    <svg className={className} viewBox=\"0 0 24 24\" fill=\"#1877F2\">\n      <path d=\"M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z\"/>\n    </svg>\n  );\n}\n\ninterface LinkedProvider {\n  provider: string;\n  profileName: string | null;\n  email: string | null;\n  linkedAt: string;\n}\n\ninterface ProviderAvailability {\n  google: boolean;\n  github: boolean;\n  facebook: boolean;\n}\n\nexport default function Settings() {\n  const { user, logout } = useAuth();\n  const { theme, setTheme } = useTheme();\n  const { toast } = useToast();\n  const [, navigate] = useLocation();\n  const queryClient = useQueryClient();\n  \n  const [currentPassword, setCurrentPassword] = useState(\"\");\n  const [newPassword, setNewPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [showCurrentPassword, setShowCurrentPassword] = useState(false);\n  const [showNewPassword, setShowNewPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n  \n  // Sound settings state\n  const [soundEnabled, setSoundEnabled] = useState(false); // Disabled by default\n  const [soundType, setSoundType] = useState<SoundType>('mechanical');\n\n  // Typing behavior settings state\n  const [smoothCaret, setSmoothCaret] = useState(true);\n  const [quickRestart, setQuickRestart] = useState(true);\n  const [zenMode, setZenMode] = useState(false);\n\n  // Load sound settings on mount\n  useEffect(() => {\n    const settings = keyboardSound.getSettings();\n    setSoundEnabled(settings.enabled);\n    setSoundType(settings.soundType);\n  }, []);\n\n  // Load typing behavior settings on mount\n  useEffect(() => {\n    const smoothCaretSetting = localStorage.getItem('smoothCaret');\n    const quickRestartSetting = localStorage.getItem('quickRestart');\n    const zenModeSetting = localStorage.getItem('zenMode');\n    \n    if (smoothCaretSetting !== null) {\n      setSmoothCaret(smoothCaretSetting === 'true');\n    }\n    if (quickRestartSetting !== null) {\n      setQuickRestart(quickRestartSetting === 'true');\n    }\n    if (zenModeSetting !== null) {\n      setZenMode(zenModeSetting === 'true');\n    }\n  }, []);\n\n  const handleSoundEnabledChange = (enabled: boolean) => {\n    setSoundEnabled(enabled);\n    keyboardSound.setEnabled(enabled);\n    toast({\n      title: enabled ? \"Keyboard Sounds Enabled\" : \"Keyboard Sounds Disabled\",\n      description: enabled ? \"You'll hear sound when typing\" : \"Sound is now muted\",\n    });\n  };\n\n  const handleSoundTypeChange = (type: SoundType) => {\n    setSoundType(type);\n    keyboardSound.setSoundType(type);\n    // Play a preview\n    keyboardSound.play();\n    toast({\n      title: \"Sound Type Changed\",\n      description: `Switched to ${type} sound`,\n    });\n  };\n\n  const handleSmoothCaretChange = (enabled: boolean) => {\n    setSmoothCaret(enabled);\n    localStorage.setItem('smoothCaret', enabled.toString());\n    toast({\n      title: enabled ? \"Smooth Caret Enabled\" : \"Smooth Caret Disabled\",\n      description: enabled ? \"Cursor will animate smoothly\" : \"Cursor will jump instantly\",\n    });\n  };\n\n  const handleQuickRestartChange = (enabled: boolean) => {\n    setQuickRestart(enabled);\n    localStorage.setItem('quickRestart', enabled.toString());\n    toast({\n      title: enabled ? \"Quick Restart Enabled\" : \"Quick Restart Disabled\",\n      description: enabled ? \"Press Tab to restart\" : \"Use the restart button\",\n    });\n  };\n\n  const handleZenModeChange = (enabled: boolean) => {\n    setZenMode(enabled);\n    localStorage.setItem('zenMode', enabled.toString());\n    toast({\n      title: enabled ? \"Zen Mode Enabled\" : \"Zen Mode Disabled\",\n      description: enabled ? \"Minimalist typing experience - focus on the text\" : \"Full UI with all controls visible\",\n    });\n  };\n\n  const changePasswordMutation = useMutation({\n    mutationFn: async (data: { currentPassword: string; newPassword: string }) => {\n      const response = await fetch(\"/api/auth/change-password\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(data),\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to change password\");\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Password Changed\",\n        description: \"Your password has been updated successfully\",\n      });\n      setCurrentPassword(\"\");\n      setNewPassword(\"\");\n      setConfirmPassword(\"\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Password Change Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteAccountMutation = useMutation({\n    mutationFn: async () => {\n      const response = await fetch(\"/api/auth/delete-account\", {\n        method: \"DELETE\",\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to delete account\");\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Account Deleted\",\n        description: \"Your account has been permanently deleted\",\n      });\n      logout();\n      navigate(\"/\");\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Account Deletion Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const { data: providerData, isLoading: providersLoading } = useQuery({\n    queryKey: [\"linked-providers\"],\n    queryFn: async (): Promise<{ linkedProviders: LinkedProvider[]; availableProviders: ProviderAvailability }> => {\n      const response = await fetch(\"/api/auth/providers\", {\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch linked providers\");\n      }\n      return response.json();\n    },\n    enabled: !!user,\n  });\n\n  const linkedProviders = providerData?.linkedProviders;\n  const availableProviders = providerData?.availableProviders;\n\n  const unlinkProviderMutation = useMutation({\n    mutationFn: async (provider: string) => {\n      const response = await fetch(`/api/auth/providers/${provider}`, {\n        method: \"DELETE\",\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to unlink provider\");\n      }\n      return response.json();\n    },\n    onSuccess: (_, provider) => {\n      queryClient.invalidateQueries({ queryKey: [\"linked-providers\"] });\n      toast({\n        title: \"Account Unlinked\",\n        description: `Your ${provider.charAt(0).toUpperCase() + provider.slice(1)} account has been unlinked`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Unlink Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const isProviderLinked = (provider: string) => {\n    return linkedProviders?.some(p => p.provider === provider) ?? false;\n  };\n\n  const getProviderInfo = (provider: string) => {\n    return linkedProviders?.find(p => p.provider === provider);\n  };\n\n  const handleLinkProvider = (provider: string) => {\n    window.location.href = `/api/auth/link/${provider}`;\n  };\n\n  const isProviderAvailable = (provider: keyof ProviderAvailability) => {\n    return availableProviders?.[provider] ?? false;\n  };\n\n  const handleUnlinkProvider = (provider: string) => {\n    unlinkProviderMutation.mutate(provider);\n  };\n\n  // Password validation helper\n  const getPasswordStrength = (password: string) => {\n    if (password.length === 0) return { strength: 0, label: '', color: '' };\n    \n    // Must meet minimum requirements to even start calculating strength\n    const meetsMinimum = password.length >= 8 && \n                        /[A-Z]/.test(password) && \n                        /[a-z]/.test(password) && \n                        /\\d/.test(password);\n    \n    if (!meetsMinimum) {\n      return { strength: 0, label: 'Weak', color: 'text-destructive' };\n    }\n    \n    let strength = 0;\n    if (password.length >= 8) strength++;\n    if (password.length >= 12) strength++;\n    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;\n    if (/\\d/.test(password)) strength++;\n    if (/[^a-zA-Z0-9]/.test(password)) strength++;\n    \n    if (strength <= 2) return { strength, label: 'Weak', color: 'text-destructive' };\n    if (strength <= 3) return { strength, label: 'Fair', color: 'text-yellow-500' };\n    if (strength <= 4) return { strength, label: 'Good', color: 'text-blue-500' };\n    return { strength, label: 'Strong', color: 'text-green-500' };\n  };\n\n  const passwordStrength = getPasswordStrength(newPassword);\n\n  const validatePassword = () => {\n    const errors: string[] = [];\n    \n    if (!currentPassword) {\n      errors.push(\"Current password is required\");\n    }\n    \n    if (!newPassword) {\n      errors.push(\"New password is required\");\n    } else {\n      if (newPassword.length < 8) {\n        errors.push(\"Password must be at least 8 characters\");\n      }\n      if (!/[A-Z]/.test(newPassword)) {\n        errors.push(\"Password must contain at least one uppercase letter\");\n      }\n      if (!/[a-z]/.test(newPassword)) {\n        errors.push(\"Password must contain at least one lowercase letter\");\n      }\n      if (!/\\d/.test(newPassword)) {\n        errors.push(\"Password must contain at least one number\");\n      }\n    }\n    \n    if (newPassword && confirmPassword && newPassword !== confirmPassword) {\n      errors.push(\"Passwords do not match\");\n    }\n    \n    if (newPassword && currentPassword && newPassword === currentPassword) {\n      errors.push(\"New password must be different from current password\");\n    }\n    \n    return errors;\n  };\n\n  const handleChangePassword = () => {\n    // Capture values at the moment of submission to avoid race conditions\n    const currentPwd = currentPassword;\n    const newPwd = newPassword;\n    const confirmPwd = confirmPassword;\n    \n    // Re-validate with frozen values\n    const errors: string[] = [];\n    \n    if (!currentPwd) {\n      errors.push(\"Current password is required\");\n    }\n    \n    if (!newPwd) {\n      errors.push(\"New password is required\");\n    } else {\n      if (newPwd.length < 8) {\n        errors.push(\"Password must be at least 8 characters\");\n      }\n      if (!/[A-Z]/.test(newPwd)) {\n        errors.push(\"Password must contain at least one uppercase letter\");\n      }\n      if (!/[a-z]/.test(newPwd)) {\n        errors.push(\"Password must contain at least one lowercase letter\");\n      }\n      if (!/\\d/.test(newPwd)) {\n        errors.push(\"Password must contain at least one number\");\n      }\n    }\n    \n    if (newPwd && confirmPwd && newPwd !== confirmPwd) {\n      errors.push(\"Passwords do not match\");\n    }\n    \n    if (newPwd && currentPwd && newPwd === currentPwd) {\n      errors.push(\"New password must be different from current password\");\n    }\n    \n    if (errors.length > 0) {\n      toast({\n        title: \"Validation Error\",\n        description: errors[0],\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    // Submit with frozen values\n    changePasswordMutation.mutate({ currentPassword: currentPwd, newPassword: newPwd });\n  };\n\n  return (\n    <TooltipProvider delayDuration={300}>\n      <div className=\"max-w-2xl mx-auto space-y-6 sm:space-y-8 px-4 sm:px-0\">\n        <div className=\"space-y-2\">\n           <h1 className=\"text-2xl sm:text-3xl font-bold\">Settings</h1>\n           <p className=\"text-sm sm:text-base text-muted-foreground\">\n             Customize your typing experience\n             {!user && \" (Settings are saved locally on this device)\"}\n           </p>\n        </div>\n\n        <div className=\"space-y-4 sm:space-y-6\">\n          {/* Appearance */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Moon className=\"w-5 h-5\" /> Appearance\n              </CardTitle>\n              <CardDescription>Manage theme and visual preferences</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"theme\" className=\"flex flex-col gap-1\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <span>Theme</span>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button type=\"button\" className=\"text-muted-foreground/60 hover:text-muted-foreground transition-colors\">\n                          <HelpCircle className=\"w-3.5 h-3.5\" />\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"right\" className=\"max-w-[280px]\">\n                        <p className=\"font-medium mb-1\">Color Theme</p>\n                        <div className=\"text-xs text-muted-foreground space-y-1\">\n                          <p><span className=\"text-blue-400\">Focus Flow:</span> Dark theme optimized for typing</p>\n                          <p><span className=\"text-yellow-400\">Light:</span> Bright theme for well-lit environments</p>\n                          <p><span className=\"text-purple-400\">Cyberpunk:</span> Neon-inspired futuristic look</p>\n                          <p><span className=\"text-orange-400\">Retro:</span> Classic vintage terminal style</p>\n                        </div>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                  <span className=\"font-normal text-xs text-muted-foreground\">Select your preferred color scheme</span>\n                </Label>\n                <Select value={theme} onValueChange={(value) => setTheme(value as any)}>\n                  <SelectTrigger className=\"w-[140px] sm:w-[180px]\" data-testid=\"select-theme\">\n                    <SelectValue placeholder=\"Select theme\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"focus\">Focus Flow (Dark)</SelectItem>\n                    <SelectItem value=\"light\">Light</SelectItem>\n                    <SelectItem value=\"cyber\">Cyberpunk</SelectItem>\n                    <SelectItem value=\"retro\">Retro</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div className=\"flex items-center justify-between\">\n                 <Label htmlFor=\"blur\" className=\"flex flex-col gap-1\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <span>Blur Effects</span>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button type=\"button\" className=\"text-muted-foreground/60 hover:text-muted-foreground transition-colors\">\n                          <HelpCircle className=\"w-3.5 h-3.5\" />\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"right\" className=\"max-w-[240px]\">\n                        <p className=\"font-medium mb-1\">Glassmorphism Effects</p>\n                        <p className=\"text-xs text-muted-foreground\">Adds a frosted glass blur effect to cards and backgrounds. Disable for better performance on older devices.</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                  <span className=\"font-normal text-xs text-muted-foreground\">Enable glassmorphism blur</span>\n                </Label>\n                <Switch id=\"blur\" defaultChecked data-testid=\"switch-blur\" />\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Sound */}\n           <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Volume2 className=\"w-5 h-5\" /> Sound\n              </CardTitle>\n              <CardDescription>Audio feedback on keystrokes</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"sound-enabled\" className=\"flex flex-col gap-1\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <span>Keyboard Sounds</span>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button type=\"button\" className=\"text-muted-foreground/60 hover:text-muted-foreground transition-colors\">\n                          <HelpCircle className=\"w-3.5 h-3.5\" />\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"right\" className=\"max-w-[240px]\">\n                        <p className=\"font-medium mb-1\">Typing Audio Feedback</p>\n                        <p className=\"text-xs text-muted-foreground\">Plays realistic keyboard sounds as you type. Great for improving rhythm and making practice more satisfying!</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                  <span className=\"font-normal text-xs text-muted-foreground\">Play sound when typing</span>\n                </Label>\n                <Switch\n                  id=\"sound-enabled\"\n                  checked={soundEnabled}\n                  onCheckedChange={handleSoundEnabledChange}\n                  data-testid=\"switch-sound-enabled\"\n                />\n              </div>\n              \n               <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"sound-type\" className=\"flex flex-col gap-1\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <span>Sound Type</span>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button type=\"button\" className=\"text-muted-foreground/60 hover:text-muted-foreground transition-colors\">\n                          <HelpCircle className=\"w-3.5 h-3.5\" />\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"right\" className=\"max-w-[280px]\">\n                        <p className=\"font-medium mb-1\">Keyboard Switch Type</p>\n                        <div className=\"text-xs text-muted-foreground space-y-1\">\n                          <p><span className=\"text-blue-400\">Mechanical:</span> Classic clicky switch sound</p>\n                          <p><span className=\"text-green-400\">Linear:</span> Smooth thock sound, no click</p>\n                          <p><span className=\"text-yellow-400\">Typewriter:</span> Vintage typewriter bell</p>\n                          <p><span className=\"text-purple-400\">Cherry MX Blue:</span> Premium tactile switch</p>\n                        </div>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                  <span className=\"font-normal text-xs text-muted-foreground\">Choose switch type</span>\n                </Label>\n                <Select\n                  value={soundType}\n                  onValueChange={(value) => handleSoundTypeChange(value as SoundType)}\n                  disabled={!soundEnabled}\n                >\n                  <SelectTrigger className=\"w-[140px] sm:w-[180px]\" data-testid=\"select-sound-type\">\n                    <SelectValue placeholder=\"Select sound\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"mechanical\">Mechanical (Clicky)</SelectItem>\n                    <SelectItem value=\"linear\">Linear (Thock)</SelectItem>\n                    <SelectItem value=\"typewriter\">Typewriter</SelectItem>\n                    <SelectItem value=\"cherry\">Cherry MX Blue</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"flex items-center justify-between\">\n                <Label className=\"flex flex-col gap-1\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <span>Test Sound</span>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button type=\"button\" className=\"text-muted-foreground/60 hover:text-muted-foreground transition-colors\">\n                          <HelpCircle className=\"w-3.5 h-3.5\" />\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"right\" className=\"max-w-[200px]\">\n                        <p className=\"text-xs\">Click to hear a preview of the currently selected keyboard sound.</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                  <span className=\"font-normal text-xs text-muted-foreground\">Preview the selected sound</span>\n                </Label>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => keyboardSound.play()}\n                  disabled={!soundEnabled}\n                  data-testid=\"button-test-sound\"\n                >\n                  <Volume2 className=\"w-4 h-4 mr-2\" />\n                  Play Sound\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Typing */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Keyboard className=\"w-5 h-5\" /> Typing Behavior\n              </CardTitle>\n              <CardDescription>Adjust how the test behaves</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n               <div className=\"flex items-center justify-between\">\n                 <Label htmlFor=\"smooth-caret\" className=\"flex flex-col gap-1\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <span>Smooth Caret</span>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button type=\"button\" className=\"text-muted-foreground/60 hover:text-muted-foreground transition-colors\">\n                          <HelpCircle className=\"w-3.5 h-3.5\" />\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"right\" className=\"max-w-[240px]\">\n                        <p className=\"font-medium mb-1\">Cursor Animation</p>\n                        <p className=\"text-xs text-muted-foreground\">When enabled, the typing cursor glides smoothly between characters. Disable for instant cursor movement.</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                  <span className=\"font-normal text-xs text-muted-foreground\">Animate cursor movement</span>\n                </Label>\n                <Switch\n                  id=\"smooth-caret\"\n                  checked={smoothCaret}\n                  onCheckedChange={handleSmoothCaretChange}\n                  data-testid=\"switch-smooth-caret\"\n                />\n              </div>\n\n              <div className=\"flex items-center justify-between\">\n                 <Label htmlFor=\"quick-restart\" className=\"flex flex-col gap-1\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <span>Quick Restart</span>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button type=\"button\" className=\"text-muted-foreground/60 hover:text-muted-foreground transition-colors\">\n                          <HelpCircle className=\"w-3.5 h-3.5\" />\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"right\" className=\"max-w-[240px]\">\n                        <p className=\"font-medium mb-1\">Keyboard Shortcut</p>\n                        <p className=\"text-xs text-muted-foreground\">Press the Tab key anytime during a test to instantly restart with a fresh paragraph. Perfect for quick practice sessions!</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                  <span className=\"font-normal text-xs text-muted-foreground\">Press 'Tab' to restart test</span>\n                </Label>\n                <Switch\n                  id=\"quick-restart\"\n                  checked={quickRestart}\n                  onCheckedChange={handleQuickRestartChange}\n                  data-testid=\"switch-quick-restart\"\n                />\n              </div>\n\n{/* Zen Mode setting hidden for now\n              <div className=\"flex items-center justify-between\">\n                 <Label htmlFor=\"zen-mode\" className=\"flex flex-col gap-1\">\n                  <div className=\"flex items-center gap-1.5\">\n                    <span>Zen Mode</span>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button type=\"button\" className=\"text-muted-foreground/60 hover:text-muted-foreground transition-colors\">\n                          <HelpCircle className=\"w-3.5 h-3.5\" />\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"right\" className=\"max-w-[260px]\">\n                        <p className=\"font-medium mb-1\">Distraction-Free Mode</p>\n                        <p className=\"text-xs text-muted-foreground\">Hides WPM, accuracy, timer, and controls while typing. Only the text remains visible so you can focus purely on typing without distractions.</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                  <span className=\"font-normal text-xs text-muted-foreground\">Minimalist UI - hides stats and controls during typing</span>\n                </Label>\n                <Switch\n                  id=\"zen-mode\"\n                  checked={zenMode}\n                  onCheckedChange={handleZenModeChange}\n                  data-testid=\"switch-zen-mode\"\n                />\n              </div>\n*/}\n            </CardContent>\n          </Card>\n\n          {/* Connected Accounts - Only show if user is logged in */}\n          {user && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Link2 className=\"w-5 h-5\" /> Connected Accounts\n                </CardTitle>\n                <CardDescription>Link social accounts for easy sign-in</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {providersLoading ? (\n                  <div className=\"flex items-center justify-center py-4\">\n                    <Loader2 className=\"w-5 h-5 animate-spin text-muted-foreground\" />\n                  </div>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {/* Google */}\n                    <div className=\"flex items-center justify-between p-3 rounded-lg border bg-card\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-10 h-10 rounded-full bg-muted flex items-center justify-center\">\n                          <GoogleIcon className=\"w-5 h-5\" />\n                        </div>\n                        <div>\n                          <p className=\"text-sm font-medium\">Google</p>\n                          {isProviderLinked(\"google\") ? (\n                            <p className=\"text-xs text-muted-foreground\">\n                              {getProviderInfo(\"google\")?.email || \"Connected\"}\n                            </p>\n                          ) : (\n                            <p className=\"text-xs text-muted-foreground\">Not connected</p>\n                          )}\n                        </div>\n                      </div>\n                      {isProviderLinked(\"google\") ? (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleUnlinkProvider(\"google\")}\n                          disabled={unlinkProviderMutation.isPending}\n                          data-testid=\"button-unlink-google\"\n                        >\n                          {unlinkProviderMutation.isPending ? (\n                            <Loader2 className=\"w-4 h-4 animate-spin\" />\n                          ) : (\n                            <>\n                              <Unlink className=\"w-4 h-4 mr-2\" />\n                              Unlink\n                            </>\n                          )}\n                        </Button>\n                      ) : isProviderAvailable(\"google\") ? (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleLinkProvider(\"google\")}\n                          data-testid=\"button-link-google\"\n                        >\n                          <Link2 className=\"w-4 h-4 mr-2\" />\n                          Link\n                        </Button>\n                      ) : (\n                        <span className=\"text-xs text-muted-foreground\">Not configured</span>\n                      )}\n                    </div>\n\n                    {/* GitHub */}\n                    <div className=\"flex items-center justify-between p-3 rounded-lg border bg-card\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-10 h-10 rounded-full bg-muted flex items-center justify-center\">\n                          <Github className=\"w-5 h-5\" />\n                        </div>\n                        <div>\n                          <p className=\"text-sm font-medium\">GitHub</p>\n                          {isProviderLinked(\"github\") ? (\n                            <p className=\"text-xs text-muted-foreground\">\n                              {getProviderInfo(\"github\")?.profileName || \"Connected\"}\n                            </p>\n                          ) : (\n                            <p className=\"text-xs text-muted-foreground\">Not connected</p>\n                          )}\n                        </div>\n                      </div>\n                      {isProviderLinked(\"github\") ? (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleUnlinkProvider(\"github\")}\n                          disabled={unlinkProviderMutation.isPending}\n                          data-testid=\"button-unlink-github\"\n                        >\n                          {unlinkProviderMutation.isPending ? (\n                            <Loader2 className=\"w-4 h-4 animate-spin\" />\n                          ) : (\n                            <>\n                              <Unlink className=\"w-4 h-4 mr-2\" />\n                              Unlink\n                            </>\n                          )}\n                        </Button>\n                      ) : isProviderAvailable(\"github\") ? (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleLinkProvider(\"github\")}\n                          data-testid=\"button-link-github\"\n                        >\n                          <Link2 className=\"w-4 h-4 mr-2\" />\n                          Link\n                        </Button>\n                      ) : (\n                        <span className=\"text-xs text-muted-foreground\">Not configured</span>\n                      )}\n                    </div>\n\n                    {/* Facebook */}\n                    <div className=\"flex items-center justify-between p-3 rounded-lg border bg-card\">\n                      <div className=\"flex items-center gap-3\">\n                        <div className=\"w-10 h-10 rounded-full bg-muted flex items-center justify-center\">\n                          <FacebookIcon className=\"w-5 h-5\" />\n                        </div>\n                        <div>\n                          <p className=\"text-sm font-medium\">Facebook</p>\n                          {isProviderLinked(\"facebook\") ? (\n                            <p className=\"text-xs text-muted-foreground\">\n                              {getProviderInfo(\"facebook\")?.profileName || \"Connected\"}\n                            </p>\n                          ) : (\n                            <p className=\"text-xs text-muted-foreground\">Not connected</p>\n                          )}\n                        </div>\n                      </div>\n                      {isProviderLinked(\"facebook\") ? (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleUnlinkProvider(\"facebook\")}\n                          disabled={unlinkProviderMutation.isPending}\n                          data-testid=\"button-unlink-facebook\"\n                        >\n                          {unlinkProviderMutation.isPending ? (\n                            <Loader2 className=\"w-4 h-4 animate-spin\" />\n                          ) : (\n                            <>\n                              <Unlink className=\"w-4 h-4 mr-2\" />\n                              Unlink\n                            </>\n                          )}\n                        </Button>\n                      ) : isProviderAvailable(\"facebook\") ? (\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleLinkProvider(\"facebook\")}\n                          data-testid=\"button-link-facebook\"\n                        >\n                          <Link2 className=\"w-4 h-4 mr-2\" />\n                          Link\n                        </Button>\n                      ) : (\n                        <span className=\"text-xs text-muted-foreground\">Not configured</span>\n                      )}\n                    </div>\n                  </div>\n                )}\n\n                <p className=\"text-xs text-muted-foreground\">\n                  Linking social accounts allows you to sign in faster. You can unlink accounts at any time.\n                </p>\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Security - Only show if user is logged in */}\n          {user && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Shield className=\"w-5 h-5\" /> Security & Privacy\n                </CardTitle>\n                <CardDescription>Manage your password and account settings</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-8\">\n                {/* Change Password */}\n                <div className=\"space-y-4\">\n                  <div className=\"space-y-1\">\n                    <h3 className=\"text-sm font-medium\">Change Password</h3>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Keep your account secure with a strong password\n                    </p>\n                  </div>\n                  \n                  <div className=\"grid gap-3\">\n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"current-password\" className=\"text-xs\">Current Password</Label>\n                      <div className=\"relative\">\n                        <Input\n                          id=\"current-password\"\n                          type={showCurrentPassword ? \"text\" : \"password\"}\n                          value={currentPassword}\n                          onChange={(e) => setCurrentPassword(e.target.value)}\n                          data-testid=\"input-current-password\"\n                          placeholder=\"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\"\n                          className=\"pr-10 h-9\"\n                          autoComplete=\"current-password\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={() => setShowCurrentPassword(!showCurrentPassword)}\n                          className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors\"\n                          data-testid=\"toggle-current-password\"\n                        >\n                          {showCurrentPassword ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n                        </button>\n                      </div>\n                    </div>\n                    \n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"new-password\" className=\"text-xs\">New Password</Label>\n                      <div className=\"relative\">\n                        <Input\n                          id=\"new-password\"\n                          type={showNewPassword ? \"text\" : \"password\"}\n                          value={newPassword}\n                          onChange={(e) => setNewPassword(e.target.value)}\n                          data-testid=\"input-new-password\"\n                          placeholder=\"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\"\n                          className=\"pr-10 h-9\"\n                          autoComplete=\"new-password\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={() => setShowNewPassword(!showNewPassword)}\n                          className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors\"\n                          data-testid=\"toggle-new-password\"\n                        >\n                          {showNewPassword ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n                        </button>\n                      </div>\n                    </div>\n                    \n                    <div className=\"grid gap-2\">\n                      <Label htmlFor=\"confirm-password\" className=\"text-xs\">Confirm Password</Label>\n                      <div className=\"relative\">\n                        <Input\n                          id=\"confirm-password\"\n                          type={showConfirmPassword ? \"text\" : \"password\"}\n                          value={confirmPassword}\n                          onChange={(e) => setConfirmPassword(e.target.value)}\n                          data-testid=\"input-confirm-password\"\n                          placeholder=\"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\"\n                          className=\"pr-10 h-9\"\n                          autoComplete=\"new-password\"\n                        />\n                        <button\n                          type=\"button\"\n                          onClick={() => setShowConfirmPassword(!showConfirmPassword)}\n                          className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors\"\n                          data-testid=\"toggle-confirm-password\"\n                        >\n                          {showConfirmPassword ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n                        </button>\n                      </div>\n                    </div>\n                    \n                    <Button\n                      onClick={handleChangePassword}\n                      disabled={!currentPassword || !newPassword || !confirmPassword || changePasswordMutation.isPending || validatePassword().length > 0}\n                      data-testid=\"button-change-password\"\n                      size=\"sm\"\n                      className=\"mt-2\"\n                    >\n                      {changePasswordMutation.isPending ? \"Updating...\" : \"Update Password\"}\n                    </Button>\n                  </div>\n                </div>\n\n                {/* Danger Zone */}\n                <div className=\"rounded-lg border border-destructive/20 bg-destructive/5 p-4 space-y-3\">\n                  <div className=\"flex items-start gap-3\">\n                    <div className=\"rounded-full bg-destructive/10 p-2\">\n                      <AlertCircle className=\"w-4 h-4 text-destructive\" />\n                    </div>\n                    <div className=\"flex-1 space-y-1\">\n                      <h3 className=\"text-sm font-semibold text-destructive\">Delete Account</h3>\n                      <p className=\"text-xs text-muted-foreground\">\n                        Permanently remove your account and all associated data. This action cannot be undone.\n                      </p>\n                    </div>\n                  </div>\n                  \n                  <AlertDialog>\n                    <AlertDialogTrigger asChild>\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\"\n                        className=\"border-destructive/30 text-destructive hover:bg-destructive hover:text-destructive-foreground\"\n                        data-testid=\"button-delete-account\"\n                      >\n                        <Trash2 className=\"w-3.5 h-3.5 mr-2\" />\n                        Delete My Account\n                      </Button>\n                    </AlertDialogTrigger>\n                    <AlertDialogContent>\n                      <AlertDialogHeader>\n                        <AlertDialogTitle className=\"flex items-center gap-2\">\n                          <div className=\"rounded-full bg-destructive/10 p-2\">\n                            <AlertCircle className=\"w-5 h-5 text-destructive\" />\n                          </div>\n                          Delete Account?\n                        </AlertDialogTitle>\n                        <AlertDialogDescription className=\"space-y-3\">\n                          <p>This will permanently delete your TypeMasterAI account and remove all your data from our servers.</p>\n                          \n                          <div className=\"rounded-md bg-muted p-3 space-y-2\">\n                            <p className=\"text-xs font-medium text-foreground\">This includes:</p>\n                            <ul className=\"text-xs space-y-1 text-muted-foreground\">\n                              <li className=\"flex items-center gap-2\">\n                                <span className=\"w-1 h-1 rounded-full bg-current\"></span>\n                                All typing test results and statistics\n                              </li>\n                              <li className=\"flex items-center gap-2\">\n                                <span className=\"w-1 h-1 rounded-full bg-current\"></span>\n                                AI chat conversation history\n                              </li>\n                              <li className=\"flex items-center gap-2\">\n                                <span className=\"w-1 h-1 rounded-full bg-current\"></span>\n                                Profile information and preferences\n                              </li>\n                              <li className=\"flex items-center gap-2\">\n                                <span className=\"w-1 h-1 rounded-full bg-current\"></span>\n                                Leaderboard rankings and achievements\n                              </li>\n                            </ul>\n                          </div>\n                          \n                          <p className=\"text-xs font-medium text-destructive\">This action cannot be undone.</p>\n                        </AlertDialogDescription>\n                      </AlertDialogHeader>\n                      <AlertDialogFooter>\n                        <AlertDialogCancel data-testid=\"button-cancel-delete\">Cancel</AlertDialogCancel>\n                        <AlertDialogAction\n                          onClick={() => deleteAccountMutation.mutate()}\n                          className=\"bg-destructive hover:bg-destructive/90\"\n                          data-testid=\"button-confirm-delete\"\n                        >\n                          {deleteAccountMutation.isPending ? \"Deleting...\" : \"Yes, Delete My Account\"}\n                        </AlertDialogAction>\n                      </AlertDialogFooter>\n                    </AlertDialogContent>\n                  </AlertDialog>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n        </div>\n      </div>\n    </TooltipProvider>\n  );\n}\n","path":null,"size_bytes":46767,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Link } from \"wouter\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { \n  Home, \n  Search, \n  Keyboard, \n  Code, \n  Users, \n  Trophy, \n  BarChart3, \n  BookOpen, \n  Mic, \n  Zap, \n  HelpCircle,\n  ArrowRight,\n  Gamepad2,\n  Target,\n  Award\n} from \"lucide-react\";\nimport { useState } from \"react\";\nimport { useSEO } from \"@/lib/seo\";\n\nexport default function NotFound() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  useSEO({\n    title: \"Page Not Found | TypeMasterAI - Free Typing Test\",\n    description: \"Oops! The page you're looking for doesn't exist. Try our free typing test, code typing mode, or multiplayer racing instead.\",\n    canonical: \"https://typemaster-ai.replit.app/404\",\n  });\n\n  const popularPages = [\n    { name: \"Home - Typing Test\", href: \"/\", icon: Home, description: \"Start a free typing test\" },\n    { name: \"Code Typing Mode\", href: \"/code-mode\", icon: Code, description: \"Practice typing code in 20+ languages\" },\n    { name: \"Multiplayer Racing\", href: \"/multiplayer\", icon: Users, description: \"Race against other typists live\" },\n    { name: \"Global Leaderboard\", href: \"/leaderboard\", icon: Trophy, description: \"See the fastest typists\" },\n    { name: \"Analytics Dashboard\", href: \"/analytics\", icon: BarChart3, description: \"View your typing stats\" },\n    { name: \"Stress Test\", href: \"/stress-test\", icon: Zap, description: \"Type under pressure\" },\n  ];\n\n  const quickLinks = [\n    { name: \"1-Minute Typing Test\", href: \"/1-minute-typing-test\" },\n    { name: \"3-Minute Typing Test\", href: \"/3-minute-typing-test\" },\n    { name: \"5-Minute Typing Test\", href: \"/5-minute-typing-test\" },\n    { name: \"Code Leaderboard\", href: \"/code-leaderboard\" },\n    { name: \"Stress Leaderboard\", href: \"/stress-leaderboard\" },\n    { name: \"Dictation Mode\", href: \"/dictation-mode\" },\n    { name: \"Book Typing\", href: \"/books\" },\n    { name: \"AI Chat Assistant\", href: \"/chat\" },\n    { name: \"Learn Typing\", href: \"/learn\" },\n    { name: \"Your Profile\", href: \"/profile\" },\n    { name: \"Settings\", href: \"/settings\" },\n    { name: \"About Us\", href: \"/about\" },\n    { name: \"Contact\", href: \"/contact\" },\n  ];\n\n  const alternativePages = [\n    { name: \"Monkeytype Alternative\", href: \"/monkeytype-alternative\" },\n    { name: \"TypeRacer Alternative\", href: \"/typeracer-alternative\" },\n    { name: \"10FastFingers Alternative\", href: \"/10fastfingers-alternative\" },\n    { name: \"Typing.com Alternative\", href: \"/typingcom-alternative\" },\n  ];\n\n  const handleSearch = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (searchQuery.trim()) {\n      window.location.href = `/?q=${encodeURIComponent(searchQuery.trim())}`;\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen w-full bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 pt-8 pb-16\">\n      <div className=\"container mx-auto px-4 max-w-6xl\">\n        \n        {/* Hero Section */}\n        <div className=\"text-center mb-12\">\n          <div className=\"inline-flex items-center justify-center w-24 h-24 rounded-full bg-gradient-to-br from-cyan-500/20 to-blue-500/20 border border-cyan-500/30 mb-6\">\n            <span className=\"text-6xl\">ðŸ”</span>\n          </div>\n          <h1 className=\"text-4xl md:text-6xl font-bold text-white mb-4\">\n            404 - Page Not Found\n          </h1>\n          <p className=\"text-xl text-slate-400 max-w-2xl mx-auto mb-2\">\n            Oops! Looks like this page took a typing break.\n          </p>\n          <p className=\"text-lg text-slate-500 max-w-2xl mx-auto\">\n            The page you're looking for doesn't exist or has been moved. \n            But don't worry - there's plenty more to explore!\n          </p>\n        </div>\n\n        {/* Search Bar */}\n        <Card className=\"bg-slate-800/50 border-slate-700 max-w-xl mx-auto mb-12\">\n          <CardContent className=\"p-6\">\n            <form onSubmit={handleSearch} className=\"flex gap-3\">\n              <div className=\"relative flex-1\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400\" />\n                <Input\n                  type=\"text\"\n                  placeholder=\"Search TypeMasterAI...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-10 bg-slate-900/50 border-slate-600 text-white placeholder:text-slate-500\"\n                  data-testid=\"input-404-search\"\n                />\n              </div>\n              <Button \n                type=\"submit\" \n                className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600\"\n                data-testid=\"button-404-search\"\n              >\n                Search\n              </Button>\n            </form>\n          </CardContent>\n        </Card>\n\n        {/* Back to Home CTA */}\n        <div className=\"text-center mb-12\">\n          <Link href=\"/\">\n            <Button \n              size=\"lg\" \n              className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-8 py-6\"\n              data-testid=\"button-back-home\"\n            >\n              <Home className=\"mr-2 h-5 w-5\" />\n              Back to Typing Test\n              <ArrowRight className=\"ml-2 h-5 w-5\" />\n            </Button>\n          </Link>\n        </div>\n\n        {/* Popular Pages Grid */}\n        <div className=\"mb-12\">\n          <h2 className=\"text-2xl font-bold text-white mb-6 text-center\">\n            <Keyboard className=\"inline-block mr-2 h-6 w-6 text-cyan-400\" />\n            Popular Pages\n          </h2>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {popularPages.map((page) => (\n              <Link key={page.href} href={page.href}>\n                <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500/50 hover:bg-slate-800 transition-all cursor-pointer h-full\">\n                  <CardContent className=\"p-5 flex items-start gap-4\">\n                    <div className=\"p-3 rounded-lg bg-gradient-to-br from-cyan-500/20 to-blue-500/20\">\n                      <page.icon className=\"h-6 w-6 text-cyan-400\" />\n                    </div>\n                    <div>\n                      <h3 className=\"font-semibold text-white mb-1\">{page.name}</h3>\n                      <p className=\"text-sm text-slate-400\">{page.description}</p>\n                    </div>\n                  </CardContent>\n                </Card>\n              </Link>\n            ))}\n          </div>\n        </div>\n\n        {/* Quick Links Section */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-8 mb-12\">\n          {/* More Pages */}\n          <Card className=\"bg-slate-800/50 border-slate-700\">\n            <CardContent className=\"p-6\">\n              <h3 className=\"text-xl font-bold text-white mb-4 flex items-center gap-2\">\n                <Target className=\"h-5 w-5 text-cyan-400\" />\n                More Features\n              </h3>\n              <div className=\"grid grid-cols-2 gap-2\">\n                {quickLinks.map((link) => (\n                  <Link key={link.href} href={link.href}>\n                    <span className=\"text-slate-300 hover:text-cyan-400 transition-colors text-sm block py-1 cursor-pointer\">\n                      â†’ {link.name}\n                    </span>\n                  </Link>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Alternative Pages */}\n          <Card className=\"bg-slate-800/50 border-slate-700\">\n            <CardContent className=\"p-6\">\n              <h3 className=\"text-xl font-bold text-white mb-4 flex items-center gap-2\">\n                <Award className=\"h-5 w-5 text-cyan-400\" />\n                Compare TypeMasterAI\n              </h3>\n              <p className=\"text-slate-400 text-sm mb-4\">\n                See how TypeMasterAI compares to other popular typing test sites:\n              </p>\n              <div className=\"space-y-2\">\n                {alternativePages.map((link) => (\n                  <Link key={link.href} href={link.href}>\n                    <span className=\"text-slate-300 hover:text-cyan-400 transition-colors text-sm block py-1 cursor-pointer\">\n                      â†’ {link.name}\n                    </span>\n                  </Link>\n                ))}\n              </div>\n              \n              <div className=\"mt-6 pt-4 border-t border-slate-700\">\n                <h4 className=\"text-lg font-semibold text-white mb-3 flex items-center gap-2\">\n                  <HelpCircle className=\"h-4 w-4 text-cyan-400\" />\n                  Need Help?\n                </h4>\n                <div className=\"space-y-2\">\n                  <Link href=\"/contact\">\n                    <span className=\"text-slate-300 hover:text-cyan-400 transition-colors text-sm block py-1 cursor-pointer\">\n                      â†’ Contact Support\n                    </span>\n                  </Link>\n                  <Link href=\"/privacy-policy\">\n                    <span className=\"text-slate-300 hover:text-cyan-400 transition-colors text-sm block py-1 cursor-pointer\">\n                      â†’ Privacy Policy\n                    </span>\n                  </Link>\n                  <Link href=\"/terms-of-service\">\n                    <span className=\"text-slate-300 hover:text-cyan-400 transition-colors text-sm block py-1 cursor-pointer\">\n                      â†’ Terms of Service\n                    </span>\n                  </Link>\n                  <Link href=\"/accessibility\">\n                    <span className=\"text-slate-300 hover:text-cyan-400 transition-colors text-sm block py-1 cursor-pointer\">\n                      â†’ Accessibility\n                    </span>\n                  </Link>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Fun Typing Tip */}\n        <Card className=\"bg-gradient-to-r from-cyan-900/30 to-blue-900/30 border-cyan-500/30 max-w-2xl mx-auto\">\n          <CardContent className=\"p-6 text-center\">\n            <Gamepad2 className=\"h-8 w-8 text-cyan-400 mx-auto mb-3\" />\n            <h3 className=\"text-lg font-semibold text-white mb-2\">\n              While you're here...\n            </h3>\n            <p className=\"text-slate-300 mb-4\">\n              Did you know? The average typing speed is 40 WPM, but with regular practice on TypeMasterAI, \n              you can reach 80+ WPM in just a few weeks!\n            </p>\n            <Link href=\"/\">\n              <Button \n                variant=\"outline\" \n                className=\"border-cyan-500/50 text-cyan-400 hover:bg-cyan-500/10\"\n                data-testid=\"button-start-practice\"\n              >\n                <Keyboard className=\"mr-2 h-4 w-4\" />\n                Start Practicing Now\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":11034,"size_tokens":null},"client/src/pages/profile.tsx":{"content":"import { useState } from \"react\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Avatar, AvatarFallback } from \"@/components/ui/avatar\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Loader2, User as UserIcon, TrendingUp, MapPin, Keyboard, Edit, Award, Flame, Star, Target, ChevronRight, Trophy, Sparkles, Check, Zap, Share2, Moon, Sunrise, Rocket, Timer, HelpCircle, MessageSquare, Download, RefreshCw, Filter, FileText } from \"lucide-react\";\nimport { useUserCertificates, useDeleteCertificate } from \"@/hooks/useCertificates\";\nimport { DictationCertificate } from \"@/components/DictationCertificate\";\nimport { StressCertificate } from \"@/components/StressCertificate\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { cn } from \"@/lib/utils\";\nimport { BADGES, TOTAL_BADGES, type UserBadgeProgress, getTierColor, getTierBorder, type Badge as BadgeType } from \"@shared/badges\";\nimport { BadgeCard } from \"@/components/badge-card\";\nimport { BadgeShareCard } from \"@/components/badge-share-card\";\nimport FeedbackWidget from \"@/components/FeedbackWidget\";\n\nfunction ProfileHeaderSkeleton() {\n  return (\n    <div className=\"flex items-start gap-6 p-6 rounded-2xl bg-card/70 backdrop-blur-md border border-border/50 shadow-xl\">\n      <Skeleton className=\"w-24 h-24 rounded-full\" />\n      <div className=\"flex-1 space-y-3\">\n        <div className=\"flex items-start justify-between\">\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center gap-3\">\n              <Skeleton className=\"h-8 w-40\" />\n              <Skeleton className=\"h-5 w-16 rounded-full\" />\n            </div>\n            <Skeleton className=\"h-4 w-48\" />\n            <Skeleton className=\"h-4 w-64 mt-2\" />\n            <div className=\"flex items-center gap-4 mt-2\">\n              <Skeleton className=\"h-4 w-24\" />\n              <Skeleton className=\"h-4 w-20\" />\n              <Skeleton className=\"h-4 w-28\" />\n            </div>\n          </div>\n          <Skeleton className=\"h-9 w-28\" />\n        </div>\n        <div className=\"flex gap-8\">\n          <div>\n            <Skeleton className=\"h-8 w-16 mb-1\" />\n            <Skeleton className=\"h-3 w-12\" />\n          </div>\n          <div>\n            <Skeleton className=\"h-8 w-16 mb-1\" />\n            <Skeleton className=\"h-3 w-14\" />\n          </div>\n          <div>\n            <Skeleton className=\"h-8 w-16 mb-1\" />\n            <Skeleton className=\"h-3 w-14\" />\n          </div>\n        </div>\n        <div className=\"max-w-xs space-y-2\">\n          <div className=\"flex justify-between\">\n            <Skeleton className=\"h-3 w-12\" />\n            <Skeleton className=\"h-3 w-16\" />\n          </div>\n          <Skeleton className=\"h-2 w-full\" />\n        </div>\n      </div>\n    </div>\n  );\n}\n\nfunction StatsSkeleton() {\n  return (\n    <div className=\"flex gap-8\">\n      <div>\n        <Skeleton className=\"h-8 w-16 mb-1\" />\n        <Skeleton className=\"h-3 w-12\" />\n      </div>\n      <div>\n        <Skeleton className=\"h-8 w-16 mb-1\" />\n        <Skeleton className=\"h-3 w-14\" />\n      </div>\n      <div>\n        <Skeleton className=\"h-8 w-16 mb-1\" />\n        <Skeleton className=\"h-3 w-14\" />\n      </div>\n    </div>\n  );\n}\n\nfunction BadgeCardSkeleton() {\n  return (\n    <div className=\"p-4 rounded-xl border-2 border-border/50 bg-card/50 space-y-3\">\n      <div className=\"flex items-center gap-3\">\n        <Skeleton className=\"w-12 h-12 rounded-lg\" />\n        <div className=\"flex-1\">\n          <Skeleton className=\"h-4 w-24 mb-1\" />\n          <Skeleton className=\"h-3 w-32\" />\n        </div>\n      </div>\n      <Skeleton className=\"h-2 w-full\" />\n    </div>\n  );\n}\n\n\nfunction ErrorState({ \n  message, \n  onRetry, \n  isRetrying,\n  testId = \"button-retry\"\n}: { \n  message: string; \n  onRetry: () => void; \n  isRetrying?: boolean;\n  testId?: string;\n}) {\n  return (\n    <div className=\"flex flex-col items-center justify-center p-6 text-center space-y-3 bg-destructive/5 border border-destructive/20 rounded-lg\">\n      <div className=\"w-10 h-10 rounded-full bg-destructive/10 flex items-center justify-center\">\n        <svg \n          xmlns=\"http://www.w3.org/2000/svg\" \n          className=\"h-5 w-5 text-destructive\" \n          viewBox=\"0 0 24 24\" \n          fill=\"none\" \n          stroke=\"currentColor\" \n          strokeWidth=\"2\" \n          strokeLinecap=\"round\" \n          strokeLinejoin=\"round\"\n        >\n          <circle cx=\"12\" cy=\"12\" r=\"10\"></circle>\n          <line x1=\"12\" y1=\"8\" x2=\"12\" y2=\"12\"></line>\n          <line x1=\"12\" y1=\"16\" x2=\"12.01\" y2=\"16\"></line>\n        </svg>\n      </div>\n      <p className=\"text-sm text-muted-foreground\">{message}</p>\n      <Button \n        variant=\"outline\" \n        size=\"sm\" \n        onClick={onRetry}\n        disabled={isRetrying}\n        data-testid={testId}\n      >\n        {isRetrying ? (\n          <>\n            <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n            Retrying...\n          </>\n        ) : (\n          <>\n            <svg \n              xmlns=\"http://www.w3.org/2000/svg\" \n              className=\"h-4 w-4 mr-2\" \n              viewBox=\"0 0 24 24\" \n              fill=\"none\" \n              stroke=\"currentColor\" \n              strokeWidth=\"2\" \n              strokeLinecap=\"round\" \n              strokeLinejoin=\"round\"\n            >\n              <path d=\"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8\" />\n              <path d=\"M21 3v5h-5\" />\n            </svg>\n            Retry\n          </>\n        )}\n      </Button>\n    </div>\n  );\n}\n\nconst iconMap: Record<string, React.ComponentType<{ className?: string }>> = {\n  Zap,\n  Target,\n  Flame,\n  TrendingUp,\n  Star,\n  Award,\n  Share2,\n  Moon,\n  Sunrise,\n  Rocket,\n  Sparkles,\n  Timer,\n};\n\nfunction BadgeIcon({ iconName, className }: { iconName: string; className?: string }) {\n  const IconComponent = iconMap[iconName] || Star;\n  return <IconComponent className={className} />;\n}\n\nconst tierDescriptions: Record<string, string> = {\n  bronze: \"Entry-level achievement\",\n  silver: \"Intermediate milestone\",\n  gold: \"Advanced accomplishment\", \n  platinum: \"Expert-level mastery\",\n  diamond: \"Ultimate achievement\",\n};\n\ninterface NextAchievement {\n  key: string;\n  name: string;\n  description: string;\n  category: string;\n  tier: string;\n  points: number;\n  icon: string;\n  color: string;\n  progress: number;\n  currentValue: number;\n  targetValue: number;\n}\n\ninterface UserAchievement {\n  id: number;\n  unlockedAt: string;\n  testResultId: number | null;\n  achievement: {\n    id: number;\n    key: string;\n    name: string;\n    description: string;\n    category: string;\n    tier: string;\n    points: number;\n    icon: string;\n    color: string;\n  };\n}\n\nexport default function Profile() {\n  const { user } = useAuth();\n  const [, setLocation] = useLocation();\n\n  const { data: statsData, error: statsError, isLoading: statsLoading, refetch: refetchStats, isFetching: statsRefetching } = useQuery({\n    queryKey: [\"stats\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/stats\", {\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch stats\");\n      return response.json();\n    },\n    enabled: !!user,\n  });\n\n  const { data: badgeData, error: badgeError, isLoading: badgeLoading, refetch: refetchBadges, isFetching: badgeRefetching } = useQuery({\n    queryKey: [\"badges\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/badges\", {\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch badges\");\n      return response.json();\n    },\n    enabled: !!user,\n  });\n\n  const { data: achievementsData, error: achievementsError, isLoading: achievementsLoading, refetch: refetchAchievements, isFetching: achievementsRefetching } = useQuery({\n    queryKey: [\"achievements\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/achievements\", {\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch achievements\");\n      return response.json();\n    },\n    enabled: !!user,\n  });\n\n  const { data: gamificationData, error: gamificationError, isLoading: gamificationLoading, refetch: refetchGamification, isFetching: gamificationRefetching } = useQuery({\n    queryKey: [\"gamification\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/gamification\", {\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch gamification\");\n      return response.json();\n    },\n    enabled: !!user,\n  });\n\n  const { data: nextAchievementData } = useQuery<{ nextAchievement: NextAchievement | null }>({\n    queryKey: [\"next-achievement\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/achievements/next\", {\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch next achievement\");\n      return response.json();\n    },\n    enabled: !!user,\n    staleTime: 30000,\n  });\n\n  const { data: showcaseBadgesData, refetch: refetchShowcase } = useQuery<{ showcaseBadges: string[] }>({\n    queryKey: [\"showcase-badges\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/showcase-badges\", {\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch showcase badges\");\n      return response.json();\n    },\n    enabled: !!user,\n  });\n\n  const queryClient = useQueryClient();\n  const [showShowcaseModal, setShowShowcaseModal] = useState(false);\n  const [selectedShowcaseBadges, setSelectedShowcaseBadges] = useState<string[]>([]);\n  const [badgeToShare, setBadgeToShare] = useState<BadgeType | null>(null);\n  const [showBadgeShareCard, setShowBadgeShareCard] = useState(false);\n  const [certificateFilter, setCertificateFilter] = useState<string>(\"all\");\n  const [selectedCertificate, setSelectedCertificate] = useState<any>(null);\n  \n  const { data: certificatesData, isLoading: certificatesLoading, error: certificatesError, refetch: refetchCertificates } = useUserCertificates(user?.id?.toString(), certificateFilter === \"all\" ? undefined : certificateFilter);\n  const deleteCertificateMutation = useDeleteCertificate();\n\n  const showcaseMutation = useMutation({\n    mutationFn: async (badgeKeys: string[]) => {\n      const response = await fetch(\"/api/showcase-badges\", {\n        method: \"PUT\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ badgeKeys }),\n      });\n      if (!response.ok) throw new Error(\"Failed to update showcase badges\");\n      return response.json();\n    },\n    onSuccess: () => {\n      refetchShowcase();\n      setShowShowcaseModal(false);\n    },\n  });\n\n  const handleBadgeShare = (badge: BadgeType) => {\n    setBadgeToShare(badge);\n    setShowBadgeShareCard(true);\n  };\n\n  const handleShareTracked = async (platform: string) => {\n    try {\n      await fetch(\"/api/share/track\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ type: \"badge\", platform, badgeId: badgeToShare?.id }),\n      });\n      queryClient.invalidateQueries({ queryKey: [\"badges\"] });\n      queryClient.invalidateQueries({ queryKey: [\"gamification\"] });\n    } catch (error) {\n      console.error(\"Failed to track share:\", error);\n    }\n  };\n\n  const showcaseBadges = showcaseBadgesData?.showcaseBadges || [];\n  const nextAchievement = nextAchievementData?.nextAchievement;\n\n  const unlockedAchievements: UserAchievement[] = achievementsData?.achievements || [];\n  const unlockedKeys = new Set(unlockedAchievements.map(a => a.achievement.key));\n  const unlockedMap = new Map(unlockedAchievements.map(a => [a.achievement.key, a]));\n\n  const badgeProgress: UserBadgeProgress[] = BADGES.map((badge) => {\n    const isUnlocked = unlockedKeys.has(badge.id);\n    const userAchievement = unlockedMap.get(badge.id);\n    \n    if (!badgeData?.badgeData) {\n      return {\n        badge,\n        unlocked: isUnlocked,\n        unlockedAt: userAchievement?.unlockedAt,\n        progress: isUnlocked ? 100 : 0,\n        currentValue: 0,\n        requiredValue: badge.requirement.value,\n      };\n    }\n\n    const data = badgeData.badgeData;\n    let currentValue = 0;\n\n    switch (badge.requirement.type) {\n      case \"wpm\":\n        currentValue = data.bestWpm || 0;\n        break;\n      case \"accuracy\":\n        currentValue = data.bestAccuracy || 0;\n        break;\n      case \"testCount\":\n        currentValue = data.totalTests || 0;\n        break;\n      case \"streak\":\n        currentValue = Math.max(data.currentStreak || 0, data.bestStreak || 0);\n        break;\n      case \"shares\":\n        currentValue = data.totalShares || 0;\n        break;\n      case \"special\":\n        currentValue = isUnlocked ? 1 : 0;\n        break;\n    }\n\n    const progress = isUnlocked \n      ? 100 \n      : badge.requirement.value > 0 \n        ? Math.min((currentValue / badge.requirement.value) * 100, 99.9) \n        : 0;\n\n    return {\n      badge,\n      unlocked: isUnlocked,\n      unlockedAt: userAchievement?.unlockedAt,\n      progress,\n      currentValue,\n      requiredValue: badge.requirement.value,\n    };\n  });\n\n  const unlockedCount = badgeProgress.filter((b) => b.unlocked).length;\n  const totalPoints = gamificationData?.gamification?.totalPoints || 0;\n  const level = gamificationData?.gamification?.level || 1;\n  const xp = gamificationData?.gamification?.experiencePoints || 0;\n  const xpForNextLevel = level * 100;\n  const xpProgress = (xp % 100) / 100 * 100;\n\n  if (!user) {\n    return (\n        <div className=\"max-w-3xl mx-auto px-4 sm:px-0\">\n          <Card className=\"border-border/50 bg-card/50 backdrop-blur-sm\">\n            <CardContent className=\"p-6 sm:p-12\">\n              <div className=\"flex flex-col items-center text-center space-y-4 sm:space-y-6\">\n                <div className=\"w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-primary/10 flex items-center justify-center\">\n                  <UserIcon className=\"w-8 h-8 sm:w-10 sm:h-10 text-primary\" />\n                </div>\n                <div className=\"space-y-2\">\n                  <h2 className=\"text-2xl sm:text-3xl font-bold\">View Your Typing Stats</h2>\n                  <p className=\"text-sm sm:text-base text-muted-foreground max-w-md\">\n                    Sign in to access your personal profile, track your progress over time, and see detailed analytics of your typing performance.\n                  </p>\n                </div>\n                <div className=\"grid grid-cols-3 gap-2 sm:gap-4 w-full max-w-md pt-4\">\n                  <div className=\"p-3 sm:p-4 bg-background/50 rounded-lg\">\n                    <div className=\"text-xl sm:text-2xl font-bold text-primary\">ðŸ“Š</div>\n                    <div className=\"text-[10px] sm:text-xs text-muted-foreground mt-1\">Charts</div>\n                  </div>\n                  <div className=\"p-3 sm:p-4 bg-background/50 rounded-lg\">\n                    <div className=\"text-xl sm:text-2xl font-bold text-primary\">ðŸ“ˆ</div>\n                    <div className=\"text-[10px] sm:text-xs text-muted-foreground mt-1\">History</div>\n                  </div>\n                  <div className=\"p-3 sm:p-4 bg-background/50 rounded-lg\">\n                    <div className=\"text-xl sm:text-2xl font-bold text-primary\">ðŸ†</div>\n                    <div className=\"text-[10px] sm:text-xs text-muted-foreground mt-1\">Stats</div>\n                  </div>\n                </div>\n                <div className=\"flex flex-col sm:flex-row gap-3 pt-4 w-full sm:w-auto\">\n                  <Button onClick={() => setLocation(\"/register\")} size=\"lg\" className=\"w-full sm:w-auto\">\n                    Create Account\n                  </Button>\n                  <Button onClick={() => setLocation(\"/login\")} variant=\"outline\" size=\"lg\" className=\"w-full sm:w-auto\">\n                    Sign In\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n    );\n  }\n\n  const stats = statsData?.stats;\n\n  return (\n      <div className=\"max-w-5xl mx-auto space-y-6 sm:space-y-8 px-4 sm:px-0\">\n        <TooltipProvider delayDuration={200}>\n        <div className=\"flex flex-col sm:flex-row items-center sm:items-start gap-4 sm:gap-6 p-4 sm:p-6 rounded-2xl bg-card/70 backdrop-blur-md border border-border/50 shadow-xl\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Avatar className=\"w-20 h-20 sm:w-24 sm:h-24 border-4 border-background shadow-xl cursor-pointer shrink-0\">\n                <AvatarFallback className={cn(user.avatarColor || \"bg-primary\", \"text-primary-foreground text-2xl sm:text-3xl\")}>\n                  {user.username[0].toUpperCase()}\n                </AvatarFallback>\n              </Avatar>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>Your profile avatar</p>\n            </TooltipContent>\n          </Tooltip>\n          <div className=\"flex-1 space-y-3 w-full text-center sm:text-left\">\n            <div className=\"flex flex-col sm:flex-row items-center sm:items-start justify-between gap-3 sm:gap-0\">\n              <div>\n                <div className=\"flex items-center justify-center sm:justify-start gap-2 sm:gap-3 flex-wrap\">\n                  <h1 className=\"text-2xl sm:text-3xl font-bold\" data-testid=\"text-username\">{user.username}</h1>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Badge variant=\"secondary\" className=\"bg-primary/20 text-primary border-primary/20 cursor-help\" data-testid=\"badge-level\">\n                        Level {level}\n                      </Badge>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"right\" className=\"max-w-xs\">\n                      <p className=\"font-semibold\">Your Level</p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">Levels are earned by gaining XP. Each level requires 100 XP. Keep typing to level up!</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n                <p className=\"text-muted-foreground mt-1\" data-testid=\"text-email\">{user.email}</p>\n                {user.bio && (\n                  <p className=\"text-foreground/80 mt-2 max-w-2xl\" data-testid=\"text-bio\">{user.bio}</p>\n                )}\n                <div className=\"flex items-center justify-center sm:justify-start gap-3 sm:gap-4 mt-2 text-xs sm:text-sm text-muted-foreground flex-wrap\">\n                  {user.country && (\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <div className=\"flex items-center gap-1 cursor-help\" data-testid=\"text-country\">\n                          <MapPin className=\"w-4 h-4\" />\n                          <span>{user.country}</span>\n                        </div>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p>Your location</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  )}\n                  {user.keyboardLayout && (\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <div className=\"flex items-center gap-1 cursor-help\" data-testid=\"text-keyboard\">\n                          <Keyboard className=\"w-4 h-4\" />\n                          <span>{user.keyboardLayout}</span>\n                        </div>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p>Your keyboard layout</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  )}\n                  {stats && (\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <span className=\"cursor-help\" data-testid=\"text-tests-count\">{stats.totalTests} Tests Completed</span>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p>Total typing tests you've completed</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  )}\n                </div>\n              </div>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"flex gap-2\">\n                    <Button variant=\"outline\" size=\"sm\" onClick={() => setLocation(\"/profile/edit\")} data-testid=\"button-edit-profile\">\n                      <Edit className=\"w-4 h-4 mr-2\" />\n                      Edit Profile\n                    </Button>\n                    <FeedbackWidget \n                      triggerVariant=\"outline\"\n                      triggerSize=\"sm\"\n                    />\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Customize your avatar, bio, and preferences</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n            {statsError ? (\n              <ErrorState \n                message=\"Failed to load stats. Please try again.\" \n                onRetry={() => refetchStats()} \n                isRetrying={statsRefetching}\n                testId=\"button-retry-stats\"\n              />\n            ) : statsLoading ? (\n              <StatsSkeleton />\n            ) : stats ? (\n              <div className=\"flex justify-center sm:justify-start gap-6 sm:gap-8 flex-wrap\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"cursor-help text-center sm:text-left\" data-testid=\"stat-avg-wpm\">\n                      <div className=\"text-2xl sm:text-3xl font-bold font-mono\">{stats.avgWpm || 0}</div>\n                      <div className=\"text-[10px] sm:text-xs text-muted-foreground uppercase tracking-wider\">Avg WPM</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"bottom\" className=\"max-w-xs\">\n                    <p className=\"font-semibold\">Average Words Per Minute</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">Your average typing speed across all tests. Higher is better!</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"cursor-help text-center sm:text-left\" data-testid=\"stat-best-wpm\">\n                      <div className=\"text-2xl sm:text-3xl font-bold font-mono text-primary\">{stats.bestWpm || 0}</div>\n                      <div className=\"text-[10px] sm:text-xs text-muted-foreground uppercase tracking-wider\">Best WPM</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"bottom\" className=\"max-w-xs\">\n                    <p className=\"font-semibold\">Personal Best Speed</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">Your highest typing speed ever recorded. Keep practicing to beat it!</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"cursor-help text-center sm:text-left\" data-testid=\"stat-total-xp\">\n                      <div className=\"text-2xl sm:text-3xl font-bold font-mono text-amber-500\">{totalPoints}</div>\n                      <div className=\"text-[10px] sm:text-xs text-muted-foreground uppercase tracking-wider\">Total XP</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"bottom\" className=\"max-w-xs\">\n                    <p className=\"font-semibold\">Experience Points</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">Earn XP by completing tests, unlocking badges, and maintaining streaks. XP contributes to your level!</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n            ) : (\n              <StatsSkeleton />\n            )}\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div className=\"max-w-xs mx-auto sm:mx-0 cursor-help\" data-testid=\"level-progress\">\n                  <div className=\"flex justify-between text-[10px] sm:text-xs text-muted-foreground mb-1\">\n                    <span>Level {level}</span>\n                    <span>{xp % 100} / 100 XP</span>\n                  </div>\n                  <div className=\"w-full h-2 bg-secondary rounded-full overflow-hidden\">\n                    <div \n                      className=\"h-full bg-gradient-to-r from-primary to-primary/70 transition-all duration-500\"\n                      style={{ width: `${xpProgress}%` }}\n                    />\n                  </div>\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"bottom\" className=\"max-w-xs\">\n                <p className=\"font-semibold\">Level Progress</p>\n                <p className=\"text-xs text-muted-foreground mt-1\">Earn 100 XP to reach the next level. Complete tests and unlock badges to earn XP faster!</p>\n              </TooltipContent>\n            </Tooltip>\n            \n            {unlockedCount > 0 && (\n              <div className=\"pt-3 border-t border-border/30\">\n                <div className=\"flex items-center justify-between mb-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <Trophy className=\"w-4 h-4 text-amber-500\" />\n                    <span className=\"text-sm font-semibold\">Badge Showcase</span>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <HelpCircle className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                      </TooltipTrigger>\n                      <TooltipContent side=\"top\" className=\"max-w-xs\">\n                        <p className=\"text-sm\">Display your top achievements on your profile. Select up to 5 badges to showcase.</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        className=\"text-xs h-7 px-2\"\n                        onClick={() => {\n                          setSelectedShowcaseBadges(showcaseBadges);\n                          setShowShowcaseModal(true);\n                        }}\n                        data-testid=\"button-edit-showcase\"\n                      >\n                        <Edit className=\"w-3 h-3 mr-1\" />\n                        Edit\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>Customize your badge showcase</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n                <div className=\"flex gap-2 flex-wrap\">\n                  {showcaseBadges.length > 0 ? (\n                    showcaseBadges.map((badgeKey) => {\n                      const badge = BADGES.find(b => b.id === badgeKey);\n                      if (!badge) return null;\n                      return (\n                        <Tooltip key={badge.id}>\n                          <TooltipTrigger asChild>\n                            <div\n                              className={cn(\n                                \"relative group flex items-center gap-2 px-3 py-2 rounded-lg border-2 transition-all hover:scale-105 cursor-pointer\",\n                                getTierBorder(badge.tier),\n                                `bg-gradient-to-br ${getTierColor(badge.tier)} bg-opacity-20`\n                              )}\n                              data-testid={`showcase-badge-${badge.id}`}\n                            >\n                              <div className={cn(\n                                \"w-7 h-7 rounded-md flex items-center justify-center\",\n                                `bg-gradient-to-br ${getTierColor(badge.tier)}`\n                              )}>\n                                <BadgeIcon iconName={badge.icon} className=\"w-4 h-4 text-white drop-shadow-sm\" />\n                              </div>\n                              <span className=\"text-sm font-medium\">{badge.name}</span>\n                            </div>\n                          </TooltipTrigger>\n                          <TooltipContent side=\"bottom\" className=\"max-w-xs\">\n                            <div className=\"space-y-1\">\n                              <p className=\"font-semibold\">{badge.name}</p>\n                              <p className=\"text-xs text-muted-foreground\">{badge.description}</p>\n                              <div className=\"flex items-center gap-2 pt-1\">\n                                <Badge variant=\"outline\" className=\"text-[10px] capitalize\" style={{ borderColor: badge.color, color: badge.color }}>\n                                  {badge.tier}\n                                </Badge>\n                                <span className=\"text-xs text-primary\">+{badge.points} XP</span>\n                              </div>\n                            </div>\n                          </TooltipContent>\n                        </Tooltip>\n                      );\n                    })\n                  ) : (\n                    <div className=\"flex items-center gap-2 text-sm text-muted-foreground italic\">\n                      <Sparkles className=\"w-4 h-4\" />\n                      <p>No badges showcased yet. Click Edit to select up to 5 badges to display!</p>\n                    </div>\n                  )}\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n\n        {nextAchievement && (\n          <Card \n            className=\"border-2 border-primary/30 bg-gradient-to-br from-primary/5 via-card/80 to-purple-500/5 backdrop-blur-md shadow-lg shadow-primary/10 hover:border-primary/50 transition-all duration-300 overflow-hidden\"\n            data-testid=\"next-badge-widget\"\n          >\n            <CardContent className=\"p-3 sm:p-4\">\n              <div className=\"flex flex-col gap-3 sm:gap-4 md:grid md:grid-cols-[auto,minmax(0,1fr),auto] md:items-center\">\n                {/* Icon Column - Fixed Width */}\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"shrink-0 mx-auto md:mx-0 cursor-help\">\n                      <div \n                        className=\"aspect-square w-12 sm:w-14 overflow-hidden rounded-xl bg-gradient-to-br from-muted/80 to-muted border border-border/50 flex items-center justify-center shadow-md\"\n                        style={{ \n                          boxShadow: `0 4px 16px ${nextAchievement.color}20`,\n                        }}\n                      >\n                        <BadgeIcon iconName={nextAchievement.icon} className=\"w-6 h-6 sm:w-7 sm:h-7 text-primary\" />\n                      </div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"left\" className=\"max-w-xs\">\n                    <p className=\"font-semibold\">{nextAchievement.name}</p>\n                    <p className=\"text-xs text-muted-foreground mt-1\">Your next achievement to unlock. Complete the requirements to earn this badge and {nextAchievement.points} XP!</p>\n                  </TooltipContent>\n                </Tooltip>\n                \n                {/* Text Column - Flexible with Overflow Protection */}\n                <div className=\"min-w-0 flex flex-col gap-1.5 text-center md:text-left overflow-hidden\">\n                  <div className=\"flex flex-wrap items-center justify-center md:justify-start gap-1.5\">\n                    <span className=\"text-[10px] sm:text-xs font-semibold uppercase tracking-wider text-primary\">\n                      Next Badge to Unlock\n                    </span>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Badge \n                          variant=\"outline\" \n                          className=\"text-[9px] sm:text-[10px] px-1 py-0 capitalize shrink-0 cursor-help\"\n                          style={{ \n                            borderColor: nextAchievement.color,\n                            color: nextAchievement.color\n                          }}\n                          data-testid=\"next-badge-tier\"\n                        >\n                          {nextAchievement.tier}\n                        </Badge>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p className=\"text-xs\">Badge tier: <span className=\"capitalize font-semibold\">{nextAchievement.tier}</span></p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">Rarer badges are harder to unlock and more prestigious</p>\n                      </TooltipContent>\n                    </Tooltip>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Badge \n                          variant=\"secondary\" \n                          className=\"text-[9px] sm:text-[10px] px-1 py-0 shrink-0 cursor-help\"\n                          data-testid=\"next-badge-points\"\n                        >\n                          +{nextAchievement.points} XP\n                        </Badge>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p className=\"text-xs\">Experience points reward</p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">Unlock this badge to earn {nextAchievement.points} XP towards your next level</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                  \n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <h3 className=\"text-base sm:text-lg font-semibold text-balance break-words cursor-help\" data-testid=\"next-badge-name\">\n                        {nextAchievement.name}\n                      </h3>\n                    </TooltipTrigger>\n                    <TooltipContent className=\"max-w-xs\">\n                      <p className=\"font-semibold\">{nextAchievement.name}</p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">{nextAchievement.description}</p>\n                      <p className=\"text-xs text-primary mt-2\">Progress: {nextAchievement.currentValue} / {nextAchievement.targetValue} ({nextAchievement.progress}%)</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  \n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <p className=\"text-xs sm:text-sm text-muted-foreground text-pretty break-words cursor-help\" data-testid=\"next-badge-description\">\n                        {nextAchievement.description}\n                      </p>\n                    </TooltipTrigger>\n                    <TooltipContent className=\"max-w-xs\">\n                      <p className=\"text-xs\">Requirement: {nextAchievement.description}</p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">Keep typing to make progress towards unlocking this badge!</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  \n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div className=\"mt-1 space-y-1.5 cursor-help\">\n                        <div className=\"flex flex-wrap justify-between gap-x-2 gap-y-1 text-xs sm:text-sm\">\n                          <span className=\"text-muted-foreground\">Progress</span>\n                          <span className=\"font-mono font-semibold text-primary\" data-testid=\"next-badge-progress-text\">\n                            {nextAchievement.currentValue} / {nextAchievement.targetValue}\n                            <span className=\"text-muted-foreground ml-1 text-[10px] sm:text-xs\">({nextAchievement.progress}%)</span>\n                          </span>\n                        </div>\n                        <Progress \n                          value={nextAchievement.progress} \n                          className=\"h-2 sm:h-2.5 rounded-full bg-secondary [&>div]:bg-gradient-to-r [&>div]:from-primary [&>div]:to-purple-500\"\n                          data-testid=\"next-badge-progress\"\n                        />\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent className=\"max-w-xs\">\n                      <p className=\"font-semibold\">Your Progress</p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        You've completed {nextAchievement.currentValue} out of {nextAchievement.targetValue} required. \n                        Only {nextAchievement.targetValue - nextAchievement.currentValue} more to go!\n                      </p>\n                      <p className=\"text-xs text-primary mt-2\">{Math.round(nextAchievement.progress)}% complete</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n                \n                {/* CTA Button Column */}\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button \n                      variant=\"ghost\" \n                      size=\"icon\"\n                      className=\"shrink-0 hidden md:flex md:justify-self-end h-8 w-8\"\n                      onClick={() => setLocation(\"/\")}\n                      data-testid=\"next-badge-start-typing\"\n                    >\n                      <ChevronRight className=\"w-4 h-4\" />\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p className=\"text-xs\">Start typing to earn this badge!</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        <Card className=\"border-border/50 bg-card/60 backdrop-blur-md\">\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <Award className=\"w-6 h-6 text-primary\" />\n                <div>\n                  <CardTitle>Achievements & Badges</CardTitle>\n                  <p className=\"text-sm text-muted-foreground mt-1\">\n                    Unlock badges by reaching milestones\n                  </p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                {badgeData?.badgeData && (\n                  <>\n                    <div className=\"flex items-center gap-2 px-3 py-2 rounded-lg bg-primary/10 border border-primary/20\">\n                      <Flame className=\"w-5 h-5 text-orange-500\" />\n                      <span className=\"text-sm font-semibold\">\n                        {badgeData.badgeData.currentStreak} Day Streak\n                      </span>\n                    </div>\n                    <div className=\"flex items-center gap-2 px-3 py-2 rounded-lg bg-amber-500/10 border border-amber-500/20\">\n                      <Star className=\"w-5 h-5 text-amber-500\" />\n                      <span className=\"text-sm font-semibold\">\n                        {totalPoints} XP\n                      </span>\n                    </div>\n                    <Badge variant=\"outline\" className=\"text-base px-4 py-2\">\n                      {unlockedCount} / {TOTAL_BADGES} Unlocked\n                    </Badge>\n                  </>\n                )}\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <Tabs defaultValue=\"all\" className=\"w-full\">\n              <TabsList className=\"grid w-full grid-cols-7\">\n                <TabsTrigger value=\"all\">All</TabsTrigger>\n                <TabsTrigger value=\"speed\">Speed</TabsTrigger>\n                <TabsTrigger value=\"accuracy\">Accuracy</TabsTrigger>\n                <TabsTrigger value=\"consistency\">Consistency</TabsTrigger>\n                <TabsTrigger value=\"streak\">Streaks</TabsTrigger>\n                <TabsTrigger value=\"special\">Special</TabsTrigger>\n                <TabsTrigger value=\"secret\" className=\"text-indigo-400\">Secret</TabsTrigger>\n              </TabsList>\n              <TabsContent value=\"all\" className=\"mt-6\">\n                <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\n                  {badgeProgress.map((item) => (\n                    <BadgeCard\n                      key={item.badge.id}\n                      badge={item.badge}\n                      unlocked={item.unlocked}\n                      progress={item.progress}\n                      currentValue={item.currentValue}\n                      unlockedAt={item.unlockedAt}\n                      onShare={item.unlocked ? handleBadgeShare : undefined}\n                    />\n                  ))}\n                </div>\n              </TabsContent>\n              <TabsContent value=\"speed\" className=\"mt-6\">\n                <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\n                  {badgeProgress\n                    .filter((item) => item.badge.category === \"speed\")\n                    .map((item) => (\n                      <BadgeCard\n                        key={item.badge.id}\n                        badge={item.badge}\n                        unlocked={item.unlocked}\n                        progress={item.progress}\n                        currentValue={item.currentValue}\n                        unlockedAt={item.unlockedAt}\n                        onShare={item.unlocked ? handleBadgeShare : undefined}\n                      />\n                    ))}\n                </div>\n              </TabsContent>\n              <TabsContent value=\"accuracy\" className=\"mt-6\">\n                <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\n                  {badgeProgress\n                    .filter((item) => item.badge.category === \"accuracy\")\n                    .map((item) => (\n                      <BadgeCard\n                        key={item.badge.id}\n                        badge={item.badge}\n                        unlocked={item.unlocked}\n                        progress={item.progress}\n                        currentValue={item.currentValue}\n                        unlockedAt={item.unlockedAt}\n                        onShare={item.unlocked ? handleBadgeShare : undefined}\n                      />\n                    ))}\n                </div>\n              </TabsContent>\n              <TabsContent value=\"consistency\" className=\"mt-6\">\n                <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\n                  {badgeProgress\n                    .filter((item) => item.badge.category === \"consistency\")\n                    .map((item) => (\n                      <BadgeCard\n                        key={item.badge.id}\n                        badge={item.badge}\n                        unlocked={item.unlocked}\n                        progress={item.progress}\n                        currentValue={item.currentValue}\n                        unlockedAt={item.unlockedAt}\n                        onShare={item.unlocked ? handleBadgeShare : undefined}\n                      />\n                    ))}\n                </div>\n              </TabsContent>\n              <TabsContent value=\"streak\" className=\"mt-6\">\n                <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\n                  {badgeProgress\n                    .filter((item) => item.badge.category === \"streak\")\n                    .map((item) => (\n                      <BadgeCard\n                        key={item.badge.id}\n                        badge={item.badge}\n                        unlocked={item.unlocked}\n                        progress={item.progress}\n                        currentValue={item.currentValue}\n                        unlockedAt={item.unlockedAt}\n                        onShare={item.unlocked ? handleBadgeShare : undefined}\n                      />\n                    ))}\n                </div>\n              </TabsContent>\n              <TabsContent value=\"special\" className=\"mt-6\">\n                <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\n                  {badgeProgress\n                    .filter((item) => item.badge.category === \"special\")\n                    .map((item) => (\n                      <BadgeCard\n                        key={item.badge.id}\n                        badge={item.badge}\n                        unlocked={item.unlocked}\n                        progress={item.progress}\n                        currentValue={item.currentValue}\n                        unlockedAt={item.unlockedAt}\n                        onShare={item.unlocked ? handleBadgeShare : undefined}\n                      />\n                    ))}\n                </div>\n              </TabsContent>\n              <TabsContent value=\"secret\" className=\"mt-6\">\n                <div className=\"mb-4 p-4 rounded-lg bg-indigo-500/10 border border-indigo-500/20\">\n                  <p className=\"text-sm text-indigo-400\">\n                    Secret badges are hidden until you unlock them. Explore different ways to practice typing to discover them!\n                  </p>\n                </div>\n                <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4\">\n                  {badgeProgress\n                    .filter((item) => item.badge.category === \"secret\")\n                    .map((item) => (\n                      <BadgeCard\n                        key={item.badge.id}\n                        badge={item.badge}\n                        unlocked={item.unlocked}\n                        progress={item.progress}\n                        currentValue={item.currentValue}\n                        unlockedAt={item.unlockedAt}\n                        onShare={item.unlocked ? handleBadgeShare : undefined}\n                      />\n                    ))}\n                </div>\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n\n        <Card className=\"border-border/50 bg-card/60 backdrop-blur-md\">\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <FileText className=\"w-6 h-6 text-primary\" />\n                <div>\n                  <CardTitle>Certificates</CardTitle>\n                  <p className=\"text-sm text-muted-foreground mt-1\">\n                    Your typing achievement certificates\n                  </p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                {certificatesData && certificatesData.length > 0 && (\n                  <Badge variant=\"outline\" className=\"text-base px-4 py-2\">\n                    {certificatesData.length} Certificate{certificatesData.length !== 1 ? 's' : ''}\n                  </Badge>\n                )}\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <Tabs defaultValue=\"all\" className=\"w-full\" onValueChange={(value) => setCertificateFilter(value)}>\n              <TabsList className=\"grid w-full grid-cols-7\">\n                <TabsTrigger value=\"all\">All</TabsTrigger>\n                <TabsTrigger value=\"standard\">Standard</TabsTrigger>\n                <TabsTrigger value=\"code\">Code</TabsTrigger>\n                <TabsTrigger value=\"book\">Book</TabsTrigger>\n                <TabsTrigger value=\"chapter\">Chapter</TabsTrigger>\n                <TabsTrigger value=\"dictation\">Dictation</TabsTrigger>\n                <TabsTrigger value=\"stress\">Stress</TabsTrigger>\n              </TabsList>\n              <TabsContent value={certificateFilter} className=\"mt-6\">\n                {certificatesLoading ? (\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    {[1, 2, 3, 4].map((i) => (\n                      <div key={i} className=\"p-4 rounded-xl border-2 border-border/50 bg-card/50 space-y-3\">\n                        <Skeleton className=\"h-6 w-32\" />\n                        <Skeleton className=\"h-20 w-full\" />\n                        <Skeleton className=\"h-4 w-full\" />\n                      </div>\n                    ))}\n                  </div>\n                ) : certificatesError ? (\n                  <ErrorState\n                    message=\"Failed to load certificates\"\n                    onRetry={() => refetchCertificates()}\n                    testId=\"button-retry-certificates\"\n                  />\n                ) : !certificatesData || certificatesData.length === 0 ? (\n                  <div className=\"text-center py-12 text-muted-foreground\">\n                    <FileText className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n                    <p>No certificates yet</p>\n                    <p className=\"text-sm mt-2\">Complete typing tests to earn certificates</p>\n                  </div>\n                ) : (\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                    {certificatesData.map((cert: any) => (\n                      <div key={cert.id} className=\"space-y-3\">\n                        <div className=\"p-4 rounded-xl border-2 border-border/50 bg-card/50\">\n                          <div className=\"flex items-start justify-between mb-3\">\n                            <div>\n                              <h3 className=\"font-semibold capitalize\">{cert.certificateType} Test</h3>\n                              <p className=\"text-xs text-muted-foreground\">\n                                {new Date(cert.createdAt).toLocaleDateString()}\n                              </p>\n                            </div>\n                            <Badge variant=\"outline\" className=\"capitalize\">\n                              {cert.metadata?.tier || 'Bronze'}\n                            </Badge>\n                          </div>\n                          <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                            <div>\n                              <span className=\"text-muted-foreground\">WPM:</span>\n                              <span className=\"ml-2 font-semibold\">{cert.wpm}</span>\n                            </div>\n                            <div>\n                              <span className=\"text-muted-foreground\">Accuracy:</span>\n                              <span className=\"ml-2 font-semibold\">{cert.accuracy.toFixed(1)}%</span>\n                            </div>\n                          </div>\n                          <div className=\"flex gap-2 mt-4\">\n                            <Button\n                              size=\"sm\"\n                              variant=\"outline\"\n                              className=\"flex-1\"\n                              onClick={() => setSelectedCertificate(cert)}\n                              data-testid={`button-view-certificate-${cert.id}`}\n                            >\n                              <FileText className=\"w-4 h-4 mr-2\" />\n                              View\n                            </Button>\n                          </div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                )}\n              </TabsContent>\n            </Tabs>\n          </CardContent>\n        </Card>\n\n        <Dialog open={selectedCertificate !== null} onOpenChange={(open) => !open && setSelectedCertificate(null)}>\n          <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle className=\"capitalize\">{selectedCertificate?.certificateType} Test Certificate</DialogTitle>\n              <DialogDescription>\n                Earned on {selectedCertificate && new Date(selectedCertificate.createdAt).toLocaleDateString()}\n              </DialogDescription>\n            </DialogHeader>\n            {selectedCertificate && (\n              <div className=\"mt-4\">\n                {selectedCertificate.certificateType === 'dictation' ? (\n                  <DictationCertificate\n                    wpm={selectedCertificate.wpm}\n                    accuracy={selectedCertificate.accuracy}\n                    consistency={selectedCertificate.consistency}\n                    speedLevel={selectedCertificate.metadata?.speedLevel || 'Normal'}\n                    sentencesCompleted={selectedCertificate.metadata?.sentencesCompleted || 0}\n                    totalWords={selectedCertificate.metadata?.totalWords || 0}\n                    duration={selectedCertificate.duration}\n                    username={selectedCertificate.metadata?.username || user?.username || 'Typing Expert'}\n                  />\n                ) : selectedCertificate.certificateType === 'stress' ? (\n                  <StressCertificate\n                    wpm={selectedCertificate.wpm}\n                    accuracy={selectedCertificate.accuracy}\n                    consistency={selectedCertificate.consistency}\n                    difficulty={selectedCertificate.metadata?.difficulty || 'Beginner'}\n                    stressScore={selectedCertificate.metadata?.stressScore || 0}\n                    survivalTime={selectedCertificate.metadata?.survivalTime || selectedCertificate.duration}\n                    completionRate={selectedCertificate.metadata?.completionRate || 0}\n                    maxCombo={selectedCertificate.metadata?.maxCombo || 0}\n                    activeChallenges={selectedCertificate.metadata?.activeChallenges || []}\n                    duration={selectedCertificate.duration}\n                    username={selectedCertificate.metadata?.username || user?.username || 'Typing Expert'}\n                  />\n                ) : (\n                  <div className=\"text-center py-8\">\n                    <p className=\"text-muted-foreground\">Certificate preview not available for this type</p>\n                  </div>\n                )}\n              </div>\n            )}\n          </DialogContent>\n        </Dialog>\n\n        <Dialog open={showShowcaseModal} onOpenChange={setShowShowcaseModal}>\n          <DialogContent className=\"max-w-2xl max-h-[85vh] overflow-hidden flex flex-col\" data-testid=\"showcase-modal\">\n            <DialogHeader className=\"flex-shrink-0\">\n              <DialogTitle className=\"flex items-center gap-2\">\n                <Trophy className=\"w-5 h-5 text-amber-500\" />\n                Select Badges to Showcase\n              </DialogTitle>\n              <DialogDescription>\n                Choose up to 5 unlocked badges to display prominently on your profile. These badges will be visible to other users.\n              </DialogDescription>\n            </DialogHeader>\n            \n            <TooltipProvider delayDuration={300}>\n              <div className=\"flex-1 overflow-hidden flex flex-col py-4\">\n                <div className=\"flex items-center justify-between mb-4 flex-shrink-0\">\n                  <div className=\"space-y-1\">\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-sm font-medium\">\n                        {selectedShowcaseBadges.length} / 5 badges selected\n                      </span>\n                      {selectedShowcaseBadges.length === 5 && (\n                        <Badge variant=\"secondary\" className=\"text-[10px]\">Maximum reached</Badge>\n                      )}\n                    </div>\n                  </div>\n                  {selectedShowcaseBadges.length > 0 && (\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => setSelectedShowcaseBadges([])}\n                          data-testid=\"button-clear-selection\"\n                        >\n                          Clear All\n                        </Button>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p>Remove all selected badges</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  )}\n                </div>\n                \n                <div className=\"flex-1 overflow-y-auto pr-2 -mr-2\">\n                  <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\n                    {badgeProgress\n                      .filter((item) => item.unlocked)\n                      .map((item) => {\n                        const isSelected = selectedShowcaseBadges.includes(item.badge.id);\n                        const canSelect = selectedShowcaseBadges.length < 5 || isSelected;\n                        \n                        return (\n                          <Tooltip key={item.badge.id}>\n                            <TooltipTrigger asChild>\n                              <div\n                                className={cn(\n                                  \"relative flex items-center gap-3 p-3 rounded-lg border-2 cursor-pointer transition-all hover:shadow-md\",\n                                  isSelected \n                                    ? `${getTierBorder(item.badge.tier)} bg-gradient-to-br ${getTierColor(item.badge.tier)} bg-opacity-10 shadow-sm` \n                                    : \"border-border hover:border-primary/50 bg-background\",\n                                  !canSelect && \"opacity-50 cursor-not-allowed hover:shadow-none\"\n                                )}\n                                onClick={() => {\n                                  if (!canSelect) return;\n                                  if (isSelected) {\n                                    setSelectedShowcaseBadges(prev => prev.filter(k => k !== item.badge.id));\n                                  } else {\n                                    setSelectedShowcaseBadges(prev => [...prev, item.badge.id]);\n                                  }\n                                }}\n                                data-testid={`showcase-select-${item.badge.id}`}\n                              >\n                                <div className={cn(\n                                  \"w-12 h-12 rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm\",\n                                  `bg-gradient-to-br ${getTierColor(item.badge.tier)}`\n                                )}>\n                                  <BadgeIcon iconName={item.badge.icon} className=\"w-6 h-6 text-white drop-shadow-md\" />\n                                </div>\n                                <div className=\"flex-1 min-w-0\">\n                                  <div className=\"font-semibold text-sm truncate\">{item.badge.name}</div>\n                                  <div className=\"text-xs text-muted-foreground line-clamp-1\">{item.badge.description}</div>\n                                  <div className=\"flex items-center gap-2 mt-1.5\">\n                                    <Badge \n                                      variant=\"outline\" \n                                      className=\"text-[10px] px-1.5 py-0 capitalize\"\n                                      style={{ borderColor: item.badge.color, color: item.badge.color }}\n                                    >\n                                      {item.badge.tier}\n                                    </Badge>\n                                    <span className=\"text-[10px] text-primary font-medium\">+{item.badge.points} XP</span>\n                                  </div>\n                                </div>\n                                <div className={cn(\n                                  \"w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0\",\n                                  isSelected \n                                    ? \"bg-primary border-primary\" \n                                    : \"border-muted-foreground/30 hover:border-primary/50\"\n                                )}>\n                                  {isSelected && <Check className=\"w-4 h-4 text-primary-foreground\" />}\n                                </div>\n                              </div>\n                            </TooltipTrigger>\n                            <TooltipContent side=\"top\" className=\"max-w-[250px]\">\n                              <div className=\"space-y-1.5\">\n                                <p className=\"font-semibold\">{item.badge.name}</p>\n                                <p className=\"text-xs text-muted-foreground\">{item.badge.description}</p>\n                                <p className=\"text-[10px] text-muted-foreground\">{tierDescriptions[item.badge.tier] || \"Achievement\"}</p>\n                                {item.unlockedAt && (\n                                  <p className=\"text-[10px] text-green-500\">\n                                    Unlocked: {new Date(item.unlockedAt).toLocaleDateString()}\n                                  </p>\n                                )}\n                              </div>\n                            </TooltipContent>\n                          </Tooltip>\n                        );\n                      })}\n                  </div>\n                </div>\n                \n                {badgeProgress.filter(item => item.unlocked).length === 0 && (\n                  <div className=\"text-center py-12 text-muted-foreground\">\n                    <div className=\"w-16 h-16 rounded-full bg-muted/50 flex items-center justify-center mx-auto mb-4\">\n                      <Sparkles className=\"w-8 h-8 opacity-50\" />\n                    </div>\n                    <p className=\"font-medium\">No badges unlocked yet!</p>\n                    <p className=\"text-sm mt-2 max-w-xs mx-auto\">Complete typing tests and reach milestones to earn badges you can showcase.</p>\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      className=\"mt-4\"\n                      onClick={() => {\n                        setShowShowcaseModal(false);\n                        setLocation(\"/\");\n                      }}\n                    >\n                      Start Typing\n                    </Button>\n                  </div>\n                )}\n              </div>\n            </TooltipProvider>\n            \n            <div className=\"flex justify-between items-center gap-3 pt-4 border-t flex-shrink-0\">\n              <div className=\"text-xs text-muted-foreground\">\n                {badgeProgress.filter(item => item.unlocked).length} badge{badgeProgress.filter(item => item.unlocked).length !== 1 ? 's' : ''} available\n              </div>\n              <div className=\"flex gap-3\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() => setShowShowcaseModal(false)}\n                  data-testid=\"button-cancel-showcase\"\n                >\n                  Cancel\n                </Button>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <span className=\"inline-flex\">\n                      <Button\n                        onClick={() => showcaseMutation.mutate(selectedShowcaseBadges)}\n                        disabled={showcaseMutation.isPending}\n                        data-testid=\"button-save-showcase\"\n                      >\n                        {showcaseMutation.isPending ? (\n                          <>\n                            <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                            Saving...\n                          </>\n                        ) : (\n                          <>\n                            <Check className=\"w-4 h-4 mr-2\" />\n                            Save Showcase\n                          </>\n                        )}\n                      </Button>\n                    </span>\n                  </TooltipTrigger>\n                  {selectedShowcaseBadges.length > 0 && selectedShowcaseBadges.length < 3 && (\n                    <TooltipContent>\n                      <p>Select at least 3 badges to save</p>\n                    </TooltipContent>\n                  )}\n                </Tooltip>\n              </div>\n            </div>\n          </DialogContent>\n        </Dialog>\n\n        {badgeToShare && (\n          <BadgeShareCard\n            badge={badgeToShare}\n            username={user?.username}\n            unlockedAt={badgeProgress.find(b => b.badge.id === badgeToShare.id)?.unlockedAt}\n            isOpen={showBadgeShareCard}\n            onClose={() => {\n              setShowBadgeShareCard(false);\n              setBadgeToShare(null);\n            }}\n            onShareTracked={handleShareTracked}\n          />\n        )}\n      </TooltipProvider>\n      </div>\n  );\n}\n","path":null,"size_bytes":65354,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"client/src/components/auth-prompt-dialog.tsx":{"content":"import {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n} from \"@/components/ui/alert-dialog\";\nimport { useLocation } from \"wouter\";\n\ninterface AuthPromptDialogProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  title?: string;\n  description?: string;\n}\n\nexport default function AuthPromptDialog({\n  open,\n  onOpenChange,\n  title = \"Save Your Progress\",\n  description = \"Create an account to save your typing test results, track your progress, and compete on the leaderboard!\",\n}: AuthPromptDialogProps) {\n  const [, setLocation] = useLocation();\n\n  const handleSignUp = () => {\n    onOpenChange(false);\n    setLocation(\"/register\");\n  };\n\n  const handleSignIn = () => {\n    onOpenChange(false);\n    setLocation(\"/login\");\n  };\n\n  return (\n    <AlertDialog open={open} onOpenChange={onOpenChange}>\n      <AlertDialogContent>\n        <AlertDialogHeader>\n          <AlertDialogTitle>{title}</AlertDialogTitle>\n          <AlertDialogDescription>{description}</AlertDialogDescription>\n        </AlertDialogHeader>\n        <AlertDialogFooter className=\"flex-col sm:flex-row gap-2\">\n          <AlertDialogCancel>Maybe Later</AlertDialogCancel>\n          <AlertDialogAction onClick={handleSignIn} className=\"bg-secondary text-secondary-foreground hover:bg-secondary/80\">\n            Sign In\n          </AlertDialogAction>\n          <AlertDialogAction onClick={handleSignUp}>\n            Sign Up\n          </AlertDialogAction>\n        </AlertDialogFooter>\n      </AlertDialogContent>\n    </AlertDialog>\n  );\n}\n","path":null,"size_bytes":1638,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"import * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-9 items-center space-x-1 rounded-md border bg-background p-1 shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-4 w-4 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8608,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-4 w-4 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7406,"size_tokens":null},"server/seed-paragraphs.ts":{"content":"import { db } from \"./storage\";\nimport { typingParagraphs } from \"@shared/schema\";\n\nconst paragraphsData = [\n  // ENGLISH - General\n  {\n    language: \"en\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"The quick brown fox jumps over the lazy dog. This sentence contains every letter of the alphabet and is perfect for practicing typing. Regular practice helps improve both speed and accuracy over time.\",\n    wordCount: 33,\n  },\n  {\n    language: \"en\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"Technology has revolutionized the way we communicate and work. From smartphones to cloud computing, digital tools have become essential in our daily lives. Learning to type efficiently is now more important than ever before.\",\n    wordCount: 37,\n  },\n  {\n    language: \"en\",\n    mode: \"general\",\n    difficulty: \"hard\",\n    content: \"Globalization has interconnected economies, cultures, and societies across the world. International trade agreements, technological advancements, and improved transportation systems have facilitated unprecedented levels of cross-border cooperation. However, this interconnectedness also presents challenges related to economic inequality, cultural homogenization, and environmental sustainability that require collaborative solutions.\",\n    wordCount: 48,\n  },\n\n  // ENGLISH - Entertainment\n  {\n    language: \"en\",\n    mode: \"entertainment\",\n    difficulty: \"easy\",\n    content: \"Movies transport us to different worlds and tell amazing stories. From action-packed adventures to heartwarming dramas, cinema offers something for everyone. Popcorn and good company make the experience even better.\",\n    wordCount: 33,\n  },\n  {\n    language: \"en\",\n    mode: \"entertainment\",\n    difficulty: \"medium\",\n    content: \"Gaming has evolved from simple pixelated graphics to photorealistic virtual worlds. Modern video games feature complex narratives, stunning visuals, and immersive gameplay that rival blockbuster movies. Esports competitions now fill stadiums with passionate fans watching professional gamers compete.\",\n    wordCount: 41,\n  },\n  {\n    language: \"en\",\n    mode: \"entertainment\",\n    difficulty: \"hard\",\n    content: \"Streaming platforms have fundamentally transformed how we consume entertainment content. Netflix, Disney Plus, and Amazon Prime offer vast libraries of movies and shows available on demand. Binge-watching entire seasons has become a cultural phenomenon, and original streaming content now competes with traditional Hollywood productions for prestigious awards. The convenience of watching anything, anywhere, has made traditional cable television increasingly obsolete.\",\n    wordCount: 63,\n  },\n\n  // ENGLISH - Technical\n  {\n    language: \"en\",\n    mode: \"technical\",\n    difficulty: \"easy\",\n    content: \"HTML and CSS are the building blocks of web development. HTML structures content while CSS styles it. Learning these technologies opens doors to creating beautiful websites and applications.\",\n    wordCount: 29,\n  },\n  {\n    language: \"en\",\n    mode: \"technical\",\n    difficulty: \"medium\",\n    content: \"JavaScript is a versatile programming language used for both frontend and backend development. Modern frameworks like React and Vue make building interactive user interfaces efficient and enjoyable. Node.js enables developers to use JavaScript on the server side as well.\",\n    wordCount: 43,\n  },\n  {\n    language: \"en\",\n    mode: \"technical\",\n    difficulty: \"hard\",\n    content: \"Microservices architecture decomposes applications into small, independent services that communicate through APIs. Each microservice handles a specific business capability and can be developed, deployed, and scaled independently. This approach offers flexibility and resilience but introduces complexity in managing distributed systems, requiring robust orchestration tools like Kubernetes and service mesh implementations.\",\n    wordCount: 55,\n  },\n\n  // ENGLISH - Programming\n  {\n    language: \"en\",\n    mode: \"programming\",\n    difficulty: \"easy\",\n    content: \"function greet(name) { return 'Hello, ' + name + '!'; } const message = greet('World'); console.log(message);\",\n    wordCount: 16,\n  },\n  {\n    language: \"en\",\n    mode: \"programming\",\n    difficulty: \"medium\",\n    content: \"const fetchData = async (url) => { try { const response = await fetch(url); const data = await response.json(); return data; } catch (error) { console.error('Error:', error); throw error; } };\",\n    wordCount: 32,\n  },\n  {\n    language: \"en\",\n    mode: \"programming\",\n    difficulty: \"hard\",\n    content: \"class BinarySearchTree { constructor() { this.root = null; } insert(value) { const newNode = { value, left: null, right: null }; if (!this.root) { this.root = newNode; return; } let current = this.root; while (true) { if (value < current.value) { if (!current.left) { current.left = newNode; break; } current = current.left; } else { if (!current.right) { current.right = newNode; break; } current = current.right; } } } }\",\n    wordCount: 78,\n  },\n\n  // ENGLISH - Quotes\n  {\n    language: \"en\",\n    mode: \"quotes\",\n    difficulty: \"medium\",\n    content: \"The only way to do great work is to love what you do. If you haven't found it yet, keep looking. Don't settle. As with all matters of the heart, you'll know when you find it. - Steve Jobs\",\n    wordCount: 42,\n  },\n  {\n    language: \"en\",\n    mode: \"quotes\",\n    difficulty: \"medium\",\n    content: \"In the end, we will remember not the words of our enemies, but the silence of our friends. Injustice anywhere is a threat to justice everywhere. We are caught in an inescapable network of mutuality. - Martin Luther King Jr.\",\n    wordCount: 42,\n  },\n\n  // SPANISH - General\n  {\n    language: \"es\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"El sol brilla en el cielo azul. Los pÃ¡jaros cantan en los Ã¡rboles. Es un dÃ­a perfecto para salir a caminar por el parque y disfrutar de la naturaleza.\",\n    wordCount: 31,\n  },\n  {\n    language: \"es\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"La tecnologÃ­a ha cambiado nuestra forma de vivir y trabajar. Las computadoras y telÃ©fonos inteligentes nos permiten conectarnos con personas de todo el mundo instantÃ¡neamente. El futuro promete aÃºn mÃ¡s innovaciones emocionantes.\",\n    wordCount: 35,\n  },\n  {\n    language: \"es\",\n    mode: \"general\",\n    difficulty: \"hard\",\n    content: \"La educaciÃ³n es fundamental para el desarrollo de cualquier sociedad. A travÃ©s del conocimiento y la formaciÃ³n continua, las personas pueden alcanzar sus metas y contribuir positivamente a sus comunidades. Invertir en educaciÃ³n de calidad es invertir en un futuro mejor para todos.\",\n    wordCount: 45,\n  },\n\n  // SPANISH - Entertainment\n  {\n    language: \"es\",\n    mode: \"entertainment\",\n    difficulty: \"medium\",\n    content: \"El cine latinoamericano ha ganado reconocimiento mundial con pelÃ­culas galardonadas. Directores talentosos cuentan historias Ãºnicas que reflejan la cultura y las experiencias de la regiÃ³n. Los festivales internacionales celebran estas producciones cinematogrÃ¡ficas.\",\n    wordCount: 34,\n  },\n  \n  // SPANISH - Technical\n  {\n    language: \"es\",\n    mode: \"technical\",\n    difficulty: \"medium\",\n    content: \"La inteligencia artificial estÃ¡ transformando la industria tecnolÃ³gica. Los algoritmos de aprendizaje automÃ¡tico procesan grandes cantidades de datos para identificar patrones y hacer predicciones precisas. Las aplicaciones van desde reconocimiento de voz hasta vehÃ­culos autÃ³nomos.\",\n    wordCount: 38,\n  },\n  \n  // SPANISH - Programming\n  {\n    language: \"es\",\n    mode: \"programming\",\n    difficulty: \"medium\",\n    content: \"function calcular(a, b) { const suma = a + b; const producto = a * b; return { suma, producto }; } const resultado = calcular(5, 3); console.log(resultado);\",\n    wordCount: 28,\n  },\n\n  // SPANISH - Quotes\n  {\n    language: \"es\",\n    mode: \"quotes\",\n    difficulty: \"medium\",\n    content: \"La imaginaciÃ³n es mÃ¡s importante que el conocimiento. El conocimiento es limitado, mientras que la imaginaciÃ³n no tiene lÃ­mites. - Albert Einstein\",\n    wordCount: 24,\n  },\n\n  // FRENCH - Technical\n  {\n    language: \"fr\",\n    mode: \"technical\",\n    difficulty: \"medium\",\n    content: \"L'informatique quantique promet de rÃ©volutionner le calcul. Les ordinateurs quantiques utilisent les principes de la mÃ©canique quantique pour traiter l'information de maniÃ¨re radicalement diffÃ©rente. Cette technologie pourrait rÃ©soudre des problÃ¨mes actuellement impossibles.\",\n    wordCount: 35,\n  },\n\n  // FRENCH - Entertainment\n  {\n    language: \"fr\",\n    mode: \"entertainment\",\n    difficulty: \"medium\",\n    content: \"Le cinÃ©ma franÃ§ais a une longue tradition d'excellence artistique. Des rÃ©alisateurs innovants crÃ©ent des films qui explorent la condition humaine avec profondeur et sensibilitÃ©. Les festivals de Cannes attirent l'attention mondiale.\",\n    wordCount: 33,\n  },\n\n  // GERMAN - Technical\n  {\n    language: \"de\",\n    mode: \"technical\",\n    difficulty: \"medium\",\n    content: \"Die Digitalisierung verÃ¤ndert alle Bereiche unseres Lebens. KÃ¼nstliche Intelligenz und maschinelles Lernen ermÃ¶glichen neue Anwendungen. Cloud Computing bietet flexible und skalierbare Infrastruktur fÃ¼r moderne Unternehmen.\",\n    wordCount: 28,\n  },\n\n  // GERMAN - Entertainment\n  {\n    language: \"de\",\n    mode: \"entertainment\",\n    difficulty: \"medium\",\n    content: \"Die deutsche Filmindustrie produziert vielfÃ¤ltige Werke. Von historischen Dramen bis zu modernen KomÃ¶dien bietet das deutsche Kino fÃ¼r jeden Geschmack etwas. Internationale Filmfestivals prÃ¤sentieren diese Produktionen.\",\n    wordCount: 29,\n  },\n\n  // ITALIAN - Technical\n  {\n    language: \"it\",\n    mode: \"technical\",\n    difficulty: \"medium\",\n    content: \"La tecnologia blockchain sta rivoluzionando molti settori. Questa tecnologia distribuita garantisce trasparenza e sicurezza nelle transazioni digitali. Le criptovalute sono solo una delle tante applicazioni possibili di questa innovazione.\",\n    wordCount: 31,\n  },\n\n  // ITALIAN - Entertainment\n  {\n    language: \"it\",\n    mode: \"entertainment\",\n    difficulty: \"medium\",\n    content: \"Il cinema italiano Ã¨ famoso in tutto il mondo per la sua creativitÃ . Registi leggendari hanno creato capolavori che continuano a ispirare nuove generazioni. I festival cinematografici celebrano questa ricca tradizione artistica.\",\n    wordCount: 33,\n  },\n\n  // PORTUGUESE - Technical\n  {\n    language: \"pt\",\n    mode: \"technical\",\n    difficulty: \"medium\",\n    content: \"A computaÃ§Ã£o em nuvem transformou a forma como armazenamos e processamos dados. Empresas podem escalar recursos conforme necessÃ¡rio sem investir em infraestrutura fÃ­sica. A seguranÃ§a e a disponibilidade sÃ£o prioridades neste modelo.\",\n    wordCount: 32,\n  },\n\n  // PORTUGUESE - Entertainment\n  {\n    language: \"pt\",\n    mode: \"entertainment\",\n    difficulty: \"medium\",\n    content: \"A mÃºsica brasileira Ã© conhecida mundialmente pela sua diversidade e ritmo. Do samba Ã  bossa nova, cada estilo conta uma histÃ³ria Ãºnica. Festivais de mÃºsica celebram essa riqueza cultural com artistas de todo o paÃ­s.\",\n    wordCount: 37,\n  },\n\n  // JAPANESE - Technical\n  {\n    language: \"ja\",\n    mode: \"technical\",\n    difficulty: \"medium\",\n    content: \"äººå·¥çŸ¥èƒ½æŠ€è¡“ã¯æ€¥é€Ÿã«é€²åŒ–ã—ã¦ã„ã¾ã™ã€‚æ©Ÿæ¢°å­¦ç¿’ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã¯å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æžã—ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è­˜åˆ¥ã—ã¾ã™ã€‚ã“ã®æŠ€è¡“ã¯åŒ»ç™‚ã€é‡‘èžã€è£½é€ æ¥­ãªã©å¤šãã®åˆ†é‡Žã§æ´»ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚\",\n    wordCount: 52,\n  },\n\n  // CHINESE - Technical\n  {\n    language: \"zh\",\n    mode: \"technical\",\n    difficulty: \"medium\",\n    content: \"äº‘è®¡ç®—æŠ€æœ¯æ”¹å˜äº†ä¼ä¸šçš„è¿è¥æ–¹å¼ã€‚é€šè¿‡äº’è”ç½‘è®¿é—®è®¡ç®—èµ„æºï¼Œå…¬å¸å¯ä»¥å¿«é€Ÿæ‰©å±•ä¸šåŠ¡ã€‚æ•°æ®å®‰å…¨å’Œéšç§ä¿æŠ¤æ˜¯äº‘æœåŠ¡çš„é‡è¦è€ƒè™‘å› ç´ ã€‚\",\n    wordCount: 42,\n  },\n\n  // More English modes coverage\n  {\n    language: \"en\",\n    mode: \"quotes\",\n    difficulty: \"medium\",\n    content: \"Success is not final, failure is not fatal: it is the courage to continue that counts. We make a living by what we get, but we make a life by what we give. - Winston Churchill\",\n    wordCount: 38,\n  },\n\n  // FRENCH - General\n  {\n    language: \"fr\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"Bonjour! Comment allez-vous aujourd'hui? Le temps est magnifique et le ciel est bleu. C'est une belle journÃ©e pour se promener dans le parc.\",\n    wordCount: 25,\n  },\n  {\n    language: \"fr\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"La France est cÃ©lÃ¨bre pour sa cuisine, son art et son histoire. Paris, la capitale, attire des millions de visiteurs chaque annÃ©e. La Tour Eiffel et le Louvre sont parmi les sites les plus visitÃ©s au monde.\",\n    wordCount: 40,\n  },\n\n  // GERMAN - General\n  {\n    language: \"de\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"Guten Tag! Wie geht es Ihnen? Das Wetter ist heute sehr schÃ¶n. Die Sonne scheint und der Himmel ist blau.\",\n    wordCount: 21,\n  },\n  {\n    language: \"de\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"Deutschland ist bekannt fÃ¼r seine Ingenieurskunst und PrÃ¤zision. Die Automobilindustrie spielt eine wichtige Rolle in der deutschen Wirtschaft. Marken wie BMW, Mercedes und Volkswagen sind weltweit anerkannt.\",\n    wordCount: 29,\n  },\n\n  // ITALIAN - General\n  {\n    language: \"it\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"Ciao! Come stai oggi? L'Italia Ã¨ un paese bellissimo con una storia ricca. La cucina italiana Ã¨ amata in tutto il mondo.\",\n    wordCount: 23,\n  },\n  {\n    language: \"it\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"Roma, la capitale d'Italia, Ã¨ conosciuta come la CittÃ  Eterna. Il Colosseo, il Pantheon e la Fontana di Trevi sono solo alcune delle meraviglie che si possono ammirare visitando questa magnifica cittÃ .\",\n    wordCount: 35,\n  },\n\n  // PORTUGUESE - General\n  {\n    language: \"pt\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"OlÃ¡! Como vocÃª estÃ¡? O Brasil Ã© um paÃ­s grande e diverso. As praias sÃ£o lindas e o povo Ã© muito amigÃ¡vel.\",\n    wordCount: 24,\n  },\n  {\n    language: \"pt\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"A lÃ­ngua portuguesa Ã© falada em vÃ¡rios paÃ­ses ao redor do mundo. Brasil, Portugal, Angola e MoÃ§ambique sÃ£o apenas alguns exemplos. A cultura lusÃ³fona Ã© rica em tradiÃ§Ãµes, mÃºsica e literatura.\",\n    wordCount: 34,\n  },\n\n  // JAPANESE - General  \n  {\n    language: \"ja\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"ã“ã‚“ã«ã¡ã¯ã€‚ä»Šæ—¥ã¯ã„ã„å¤©æ°—ã§ã™ã­ã€‚æ—¥æœ¬ã¯ç¾Žã—ã„å›½ã§ã™ã€‚æ¡œã®èŠ±ãŒã¨ã¦ã‚‚ç¶ºéº—ã§ã™ã€‚\",\n    wordCount: 28,\n  },\n  {\n    language: \"ja\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"æ—¥æœ¬ã®æŠ€è¡“ã¯ä¸–ç•Œä¸­ã§æœ‰åã§ã™ã€‚ãƒ­ãƒœãƒƒãƒˆå·¥å­¦ã¨é›»å­æ©Ÿå™¨ã®åˆ†é‡Žã§ãƒªãƒ¼ãƒ€ãƒ¼ã§ã™ã€‚æ±äº¬ã¯è¿‘ä»£çš„ãªéƒ½å¸‚ã§ã€ä¼çµ±ã¨é©æ–°ãŒå…±å­˜ã—ã¦ã„ã¾ã™ã€‚\",\n    wordCount: 36,\n  },\n\n  // CHINESE - General\n  {\n    language: \"zh\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"ä½ å¥½ï¼ä»Šå¤©å¤©æ°”å¾ˆå¥½ã€‚ä¸­å›½æ˜¯ä¸€ä¸ªåŽ†å²æ‚ ä¹…çš„å›½å®¶ã€‚é•¿åŸŽæ˜¯ä¸–ç•Œä¸ƒå¤§å¥‡è¿¹ä¹‹ä¸€ã€‚\",\n    wordCount: 26,\n  },\n  {\n    language: \"zh\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"ä¸­å›½çš„ç§‘æŠ€å‘å±•éžå¸¸è¿…é€Ÿã€‚äººå·¥æ™ºèƒ½å’Œç”µå­å•†åŠ¡é¢†åŸŸå–å¾—äº†é‡å¤§è¿›å±•ã€‚è®¸å¤šåˆ›æ–°å…¬å¸æ­£åœ¨æ”¹å˜æˆ‘ä»¬çš„ç”Ÿæ´»æ–¹å¼ã€‚\",\n    wordCount: 32,\n  },\n\n  // HINDI - General\n  {\n    language: \"hi\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"à¤¨à¤®à¤¸à¥à¤¤à¥‡! à¤†à¤œ à¤®à¥Œà¤¸à¤® à¤¬à¤¹à¥à¤¤ à¤…à¤šà¥à¤›à¤¾ à¤¹à¥ˆà¥¤ à¤­à¤¾à¤°à¤¤ à¤à¤• à¤µà¤¿à¤µà¤¿à¤§ à¤”à¤° à¤¸à¥à¤‚à¤¦à¤° à¤¦à¥‡à¤¶ à¤¹à¥ˆà¥¤ à¤¯à¤¹à¤¾à¤ à¤•à¤ˆ à¤­à¤¾à¤·à¤¾à¤à¤ à¤”à¤° à¤¸à¤‚à¤¸à¥à¤•à¥ƒà¤¤à¤¿à¤¯à¤¾à¤ à¤¹à¥ˆà¤‚à¥¤\",\n    wordCount: 22,\n  },\n\n  // RUSSIAN - General\n  {\n    language: \"ru\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ! ÐšÐ°Ðº Ð´ÐµÐ»Ð°? Ð Ð¾ÑÑÐ¸Ñ ÑÐ°Ð¼Ð°Ñ Ð±Ð¾Ð»ÑŒÑˆÐ°Ñ ÑÑ‚Ñ€Ð°Ð½Ð° Ð² Ð¼Ð¸Ñ€Ðµ. ÐœÐ¾ÑÐºÐ²Ð° ÐºÑ€Ð°ÑÐ¸Ð²Ñ‹Ð¹ Ð¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð³Ð¾Ñ€Ð¾Ð´.\",\n    wordCount: 16,\n  },\n\n  // ARABIC - General\n  {\n    language: \"ar\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"Ù…Ø±Ø­Ø¨Ø§! ÙƒÙŠÙ Ø­Ø§Ù„Ùƒ Ø§Ù„ÙŠÙˆÙ…ØŸ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¬Ù…ÙŠÙ„Ø© Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø«Ù‚Ø§ÙØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ØºÙ†ÙŠØ© Ø¨Ø§Ù„ØªÙ‚Ø§Ù„ÙŠØ¯ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®.\",\n    wordCount: 14,\n  },\n\n  // KOREAN - General\n  {\n    language: \"ko\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"ì•ˆë…•í•˜ì„¸ìš”! ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì¢‹ë„¤ìš”. í•œêµ­ì€ ê¸°ìˆ ê³¼ ë¬¸í™”ë¡œ ìœ ëª…í•©ë‹ˆë‹¤. K-popê³¼ í•œêµ­ ë“œë¼ë§ˆëŠ” ì„¸ê³„ì ìœ¼ë¡œ ì¸ê¸°ê°€ ìžˆìŠµë‹ˆë‹¤.\",\n    wordCount: 24,\n  },\n\n  // MARATHI - General\n  {\n    language: \"mr\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"à¤¨à¤®à¤¸à¥à¤•à¤¾à¤°! à¤†à¤œ à¤¹à¤µà¤¾à¤®à¤¾à¤¨ à¤–à¥‚à¤ª à¤›à¤¾à¤¨ à¤†à¤¹à¥‡. à¤®à¤¹à¤¾à¤°à¤¾à¤·à¥à¤Ÿà¥à¤° à¤¹à¥€ à¤­à¤¾à¤°à¤¤à¤¾à¤¤à¥€à¤² à¤à¤• à¤®à¤¹à¤¤à¥à¤¤à¥à¤µà¤¾à¤šà¥€ à¤°à¤¾à¤œà¥à¤¯ à¤†à¤¹à¥‡. à¤®à¤°à¤¾à¤ à¥€ à¤­à¤¾à¤·à¤¾ à¤–à¥‚à¤ª à¤¸à¤®à¥ƒà¤¦à¥à¤§ à¤†à¤£à¤¿ à¤¸à¥à¤‚à¤¦à¤° à¤†à¤¹à¥‡.\",\n    wordCount: 24,\n  },\n  {\n    language: \"mr\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"à¤¤à¤‚à¤¤à¥à¤°à¤œà¥à¤žà¤¾à¤¨ à¤†à¤ªà¤²à¥à¤¯à¤¾ à¤œà¥€à¤µà¤¨à¤¾à¤¤ à¤®à¥‹à¤ à¥‡ à¤¬à¤¦à¤² à¤˜à¤¡à¤µà¥‚à¤¨ à¤†à¤£à¤¤ à¤†à¤¹à¥‡. à¤¸à¤‚à¤—à¤£à¤• à¤†à¤£à¤¿ à¤¸à¥à¤®à¤¾à¤°à¥à¤Ÿà¤«à¥‹à¤¨ à¤†à¤¤à¤¾ à¤†à¤ªà¤²à¥à¤¯à¤¾ à¤¦à¥ˆà¤¨à¤‚à¤¦à¤¿à¤¨ à¤œà¥€à¤µà¤¨à¤¾à¤šà¤¾ à¤­à¤¾à¤— à¤¬à¤¨à¤²à¥‡ à¤†à¤¹à¥‡à¤¤. à¤¶à¤¿à¤•à¥à¤·à¤£ à¤†à¤£à¤¿ à¤®à¤¾à¤¹à¤¿à¤¤à¥€ à¤®à¤¿à¤³à¤µà¤£à¥‡ à¤†à¤¤à¤¾ à¤–à¥‚à¤ª à¤¸à¥‹à¤ªà¥‡ à¤à¤¾à¤²à¥‡ à¤†à¤¹à¥‡.\",\n    wordCount: 30,\n  },\n  {\n    language: \"mr\",\n    mode: \"technical\",\n    difficulty: \"medium\",\n    content: \"à¤•à¥ƒà¤¤à¥à¤°à¤¿à¤® à¤¬à¥à¤¦à¥à¤§à¤¿à¤®à¤¤à¥à¤¤à¤¾ à¤¹à¥‡ à¤†à¤§à¥à¤¨à¤¿à¤• à¤¤à¤‚à¤¤à¥à¤°à¤œà¥à¤žà¤¾à¤¨à¤¾à¤šà¥‡ à¤à¤• à¤®à¤¹à¤¤à¥à¤¤à¥à¤µà¤¾à¤šà¥‡ à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤†à¤¹à¥‡. à¤®à¤¶à¥€à¤¨ à¤²à¤°à¥à¤¨à¤¿à¤‚à¤— à¤…à¤²à¥à¤—à¥‹à¤°à¤¿à¤¦à¤® à¤®à¥‹à¤ à¥à¤¯à¤¾ à¤ªà¥à¤°à¤®à¤¾à¤£à¤¾à¤¤ à¤¡à¥‡à¤Ÿà¤¾ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤•à¤°à¥‚ à¤¶à¤•à¤¤à¤¾à¤¤. à¤¯à¤¾ à¤¤à¤‚à¤¤à¥à¤°à¤œà¥à¤žà¤¾à¤¨à¤¾à¤šà¤¾ à¤‰à¤ªà¤¯à¥‹à¤— à¤†à¤°à¥‹à¤—à¥à¤¯, à¤µà¤¿à¤¤à¥à¤¤ à¤†à¤£à¤¿ à¤‰à¤¤à¥à¤ªà¤¾à¤¦à¤¨ à¤•à¥à¤·à¥‡à¤¤à¥à¤°à¤¾à¤¤ à¤¹à¥‹à¤¤ à¤†à¤¹à¥‡.\",\n    wordCount: 32,\n  },\n\n  // BENGALI - General\n  {\n    language: \"bn\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"à¦¨à¦®à¦¸à§à¦•à¦¾à¦°! à¦†à¦œ à¦†à¦¬à¦¹à¦¾à¦“à¦¯à¦¼à¦¾ à¦–à§à¦¬ à¦­à¦¾à¦²à§‹à¥¤ à¦¬à¦¾à¦‚à¦²à¦¾à¦¦à§‡à¦¶ à¦à¦¬à¦‚ à¦­à¦¾à¦°à¦¤à§‡ à¦¬à¦¾à¦‚à¦²à¦¾ à¦­à¦¾à¦·à¦¾ à¦ªà§à¦°à¦šà¦²à¦¿à¦¤à¥¤ à¦¬à¦¾à¦‚à¦²à¦¾ à¦¸à¦¾à¦¹à¦¿à¦¤à§à¦¯ à¦…à¦¤à§à¦¯à¦¨à§à¦¤ à¦¸à¦®à§ƒà¦¦à§à¦§ à¦à¦¬à¦‚ à¦¸à§à¦¨à§à¦¦à¦°à¥¤\",\n    wordCount: 22,\n  },\n  {\n    language: \"bn\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"à¦ªà§à¦°à¦¯à§à¦•à§à¦¤à¦¿ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦œà§€à¦¬à¦¨à§‡ à¦¬à¦¿à¦ªà§à¦²à¦¬ à¦à¦¨à§‡à¦›à§‡à¥¤ à¦•à¦®à§à¦ªà¦¿à¦‰à¦Ÿà¦¾à¦° à¦à¦¬à¦‚ à¦¸à§à¦®à¦¾à¦°à§à¦Ÿà¦«à§‹à¦¨ à¦à¦–à¦¨ à¦¦à§ˆà¦¨à¦¨à§à¦¦à¦¿à¦¨ à¦œà§€à¦¬à¦¨à§‡à¦° à¦…à¦‚à¦¶à¥¤ à¦‡à¦¨à§à¦Ÿà¦¾à¦°à¦¨à§‡à¦Ÿ à¦¤à¦¥à§à¦¯ à¦à¦¬à¦‚ à¦¯à§‹à¦—à¦¾à¦¯à§‹à¦—à¦•à§‡ à¦¸à¦¹à¦œ à¦•à¦°à§‡à¦›à§‡à¥¤\",\n    wordCount: 24,\n  },\n\n  // TAMIL - General\n  {\n    language: \"ta\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"à®µà®£à®•à¯à®•à®®à¯! à®‡à®©à¯à®±à¯ à®µà®¾à®©à®¿à®²à¯ˆ à®®à®¿à®•à®µà¯à®®à¯ à®¨à®©à¯à®±à®¾à®• à®‰à®³à¯à®³à®¤à¯. à®¤à®®à®¿à®´à¯ à®®à¯Šà®´à®¿ à®®à®¿à®•à®µà¯à®®à¯ à®ªà®´à®®à¯ˆà®¯à®¾à®© à®®à¯Šà®´à®¿à®•à®³à®¿à®²à¯ à®’à®©à¯à®±à¯. à®¤à®®à®¿à®´à¯ à®‡à®²à®•à¯à®•à®¿à®¯à®®à¯ à®®à®¿à®•à®µà¯à®®à¯ à®šà®¿à®±à®ªà¯à®ªà®¾à®©à®¤à¯.\",\n    wordCount: 24,\n  },\n  {\n    language: \"ta\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"à®¤à¯Šà®´à®¿à®²à¯à®¨à¯à®Ÿà¯à®ªà®®à¯ à®¨à®®à®¤à¯ à®µà®¾à®´à¯à®•à¯à®•à¯ˆà®¯à®¿à®²à¯ à®ªà¯†à®°à®¿à®¯ à®®à®¾à®±à¯à®±à®™à¯à®•à®³à¯ˆ à®à®±à¯à®ªà®Ÿà¯à®¤à¯à®¤à®¿à®¯à¯à®³à¯à®³à®¤à¯. à®•à®£à®¿à®©à®¿à®•à®³à¯ à®®à®±à¯à®±à¯à®®à¯ à®¸à¯à®®à®¾à®°à¯à®Ÿà¯à®ªà¯‹à®©à¯à®•à®³à¯ à®‡à®ªà¯à®ªà¯‹à®¤à¯ à®…à®©à¯à®±à®¾à®Ÿ à®µà®¾à®´à¯à®µà®¿à®©à¯ à®ªà®•à¯à®¤à®¿à®¯à®¾à®• à®‰à®³à¯à®³à®©. à®¤à®•à®µà®²à¯ à®®à®±à¯à®±à¯à®®à¯ à®¤à¯Šà®Ÿà®°à¯à®ªà¯ à®‡à®ªà¯à®ªà¯‹à®¤à¯ à®®à®¿à®•à®µà¯à®®à¯ à®Žà®³à®¿à®¤à®¾à®• à®‰à®³à¯à®³à®¤à¯.\",\n    wordCount: 28,\n  },\n\n  // TELUGU - General\n  {\n    language: \"te\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"à°¨à°®à°¸à±à°•à°¾à°°à°‚! à°ˆà°°à±‹à°œà± à°µà°¾à°¤à°¾à°µà°°à°£à°‚ à°šà°¾à°²à°¾ à°¬à°¾à°—à±à°‚à°¦à°¿. à°¤à±†à°²à±à°—à± à°­à°¾à°· à°šà°¾à°²à°¾ à°®à°§à±à°°à°®à±ˆà°¨à°¦à°¿. à°¤à±†à°²à±à°—à± à°¸à°¾à°¹à°¿à°¤à±à°¯à°‚ à°šà°¾à°²à°¾ à°—à±Šà°ªà±à°ªà°¦à°¿.\",\n    wordCount: 18,\n  },\n  {\n    language: \"te\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"à°¸à°¾à°‚à°•à±‡à°¤à°¿à°•à°¤ à°®à°¨ à°œà±€à°µà°¿à°¤à°¾à°²à°²à±‹ à°ªà±†à°¦à±à°¦ à°®à°¾à°°à±à°ªà±à°²à°¨à± à°¤à±†à°šà±à°šà°¿à°‚à°¦à°¿. à°•à°‚à°ªà±à°¯à±‚à°Ÿà°°à±à°²à± à°®à°°à°¿à°¯à± à°¸à±à°®à°¾à°°à±à°Ÿà±â€Œà°«à±‹à°¨à±â€Œà°²à± à°‡à°ªà±à°ªà±à°¡à± à°°à±‹à°œà±à°µà°¾à°°à±€ à°œà±€à°µà°¿à°¤à°‚à°²à±‹ à°­à°¾à°—à°‚. à°¸à°®à°¾à°šà°¾à°°à°‚ à°®à°°à°¿à°¯à± à°•à°®à±à°¯à±‚à°¨à°¿à°•à±‡à°·à°¨à± à°‡à°ªà±à°ªà±à°¡à± à°šà°¾à°²à°¾ à°¸à±à°²à°­à°‚.\",\n    wordCount: 22,\n  },\n\n  // VIETNAMESE - General\n  {\n    language: \"vi\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"Xin chÃ o! HÃ´m nay thá»i tiáº¿t ráº¥t Ä‘áº¹p. Viá»‡t Nam lÃ  má»™t Ä‘áº¥t nÆ°á»›c xinh Ä‘áº¹p vá»›i vÄƒn hÃ³a phong phÃº. NgÆ°á»i Viá»‡t Nam ráº¥t thÃ¢n thiá»‡n vÃ  hiáº¿u khÃ¡ch.\",\n    wordCount: 29,\n  },\n  {\n    language: \"vi\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"CÃ´ng nghá»‡ Ä‘ang thay Ä‘á»•i cuá»™c sá»‘ng cá»§a chÃºng ta. MÃ¡y tÃ­nh vÃ  Ä‘iá»‡n thoáº¡i thÃ´ng minh Ä‘Ã£ trá»Ÿ thÃ nh má»™t pháº§n khÃ´ng thá»ƒ thiáº¿u. Internet giÃºp káº¿t ná»‘i má»i ngÆ°á»i trÃªn toÃ n tháº¿ giá»›i.\",\n    wordCount: 34,\n  },\n  {\n    language: \"vi\",\n    mode: \"technical\",\n    difficulty: \"medium\",\n    content: \"TrÃ­ tuá»‡ nhÃ¢n táº¡o Ä‘ang cÃ¡ch máº¡ng hÃ³a nhiá»u ngÃ nh cÃ´ng nghiá»‡p. CÃ¡c thuáº­t toÃ¡n há»c mÃ¡y cÃ³ thá»ƒ phÃ¢n tÃ­ch lÆ°á»£ng dá»¯ liá»‡u lá»›n. CÃ´ng nghá»‡ nÃ y Ä‘Æ°á»£c á»©ng dá»¥ng trong y táº¿, tÃ i chÃ­nh vÃ  sáº£n xuáº¥t.\",\n    wordCount: 35,\n  },\n\n  // TURKISH - General\n  {\n    language: \"tr\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"Merhaba! BugÃ¼n hava Ã§ok gÃ¼zel. TÃ¼rkiye gÃ¼zel bir Ã¼lkedir ve zengin bir tarihe sahiptir. TÃ¼rk mutfaÄŸÄ± dÃ¼nyada Ã§ok Ã¼nlÃ¼dÃ¼r.\",\n    wordCount: 22,\n  },\n  {\n    language: \"tr\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"Teknoloji hayatÄ±mÄ±zÄ± deÄŸiÅŸtiriyor. Bilgisayarlar ve akÄ±llÄ± telefonlar artÄ±k gÃ¼nlÃ¼k yaÅŸamÄ±mÄ±zÄ±n bir parÃ§asÄ±. Ä°nternet bilgiye eriÅŸimi kolaylaÅŸtÄ±rdÄ± ve dÃ¼nyayÄ± birbirine baÄŸladÄ±.\",\n    wordCount: 23,\n  },\n  {\n    language: \"tr\",\n    mode: \"technical\",\n    difficulty: \"medium\",\n    content: \"Yapay zeka modern teknolojinin Ã¶nemli bir alanÄ±dÄ±r. Makine Ã¶ÄŸrenmesi algoritmalarÄ± bÃ¼yÃ¼k veri kÃ¼melerini analiz edebilir. Bu teknoloji saÄŸlÄ±k, finans ve Ã¼retim sektÃ¶rlerinde kullanÄ±lmaktadÄ±r.\",\n    wordCount: 24,\n  },\n\n  // POLISH - General\n  {\n    language: \"pl\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"CzeÅ›Ä‡! Dzisiaj pogoda jest bardzo Å‚adna. Polska jest piÄ™knym krajem z bogatÄ… historiÄ…. Polska kuchnia jest bardzo smaczna i rÃ³Å¼norodna.\",\n    wordCount: 23,\n  },\n  {\n    language: \"pl\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"Technologia zmienia nasze Å¼ycie. Komputery i smartfony staÅ‚y siÄ™ czÄ™Å›ciÄ… codziennoÅ›ci. Internet uÅ‚atwiÅ‚ dostÄ™p do informacji i poÅ‚Ä…czyÅ‚ ludzi na caÅ‚ym Å›wiecie.\",\n    wordCount: 23,\n  },\n\n  // DUTCH - General\n  {\n    language: \"nl\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"Hallo! Het weer is vandaag heel mooi. Nederland is een prachtig land met rijke geschiedenis. De Nederlandse cultuur is zeer divers en interessant.\",\n    wordCount: 25,\n  },\n  {\n    language: \"nl\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"Technologie verandert ons leven. Computers en smartphones zijn nu deel van het dagelijks leven. Internet heeft toegang tot informatie vergemakkelijkt en de wereld verbonden.\",\n    wordCount: 26,\n  },\n\n  // SWEDISH - General\n  {\n    language: \"sv\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"Hej! VÃ¤dret Ã¤r mycket fint idag. Sverige Ã¤r ett vackert land med rik historia. Svensk kultur Ã¤r mycket intressant och mÃ¥ngsidig.\",\n    wordCount: 23,\n  },\n  {\n    language: \"sv\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"Teknologi fÃ¶rÃ¤ndrar vÃ¥ra liv. Datorer och smartphones har blivit en del av vardagen. Internet har gjort det lÃ¤ttare att fÃ¥ tillgÃ¥ng till information och fÃ¶rbundit vÃ¤rlden.\",\n    wordCount: 28,\n  },\n\n  // THAI - General\n  {\n    language: \"th\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š! à¸§à¸±à¸™à¸™à¸µà¹‰à¸­à¸²à¸à¸²à¸¨à¸”à¸µà¸¡à¸²à¸ à¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸—à¸¢à¹€à¸›à¹‡à¸™à¸›à¸£à¸°à¹€à¸—à¸¨à¸—à¸µà¹ˆà¸ªà¸§à¸¢à¸‡à¸²à¸¡ à¸§à¸±à¸’à¸™à¸˜à¸£à¸£à¸¡à¹„à¸—à¸¢à¸¡à¸µà¸„à¸§à¸²à¸¡à¸«à¸¥à¸²à¸à¸«à¸¥à¸²à¸¢à¹à¸¥à¸°à¸™à¹ˆà¸²à¸ªà¸™à¹ƒà¸ˆ\",\n    wordCount: 16,\n  },\n  {\n    language: \"th\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"à¹€à¸—à¸„à¹‚à¸™à¹‚à¸¥à¸¢à¸µà¸à¸³à¸¥à¸±à¸‡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸Šà¸µà¸§à¸´à¸•à¸‚à¸­à¸‡à¹€à¸£à¸² à¸„à¸­à¸¡à¸žà¸´à¸§à¹€à¸•à¸­à¸£à¹Œà¹à¸¥à¸°à¸ªà¸¡à¸²à¸£à¹Œà¸—à¹‚à¸Ÿà¸™à¸à¸¥à¸²à¸¢à¹€à¸›à¹‡à¸™à¸ªà¹ˆà¸§à¸™à¸«à¸™à¸¶à¹ˆà¸‡à¸‚à¸­à¸‡à¸Šà¸µà¸§à¸´à¸•à¸›à¸£à¸°à¸ˆà¸³à¸§à¸±à¸™ à¸­à¸´à¸™à¹€à¸—à¸­à¸£à¹Œà¹€à¸™à¹‡à¸•à¸—à¸³à¹ƒà¸«à¹‰à¸à¸²à¸£à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸‡à¹ˆà¸²à¸¢à¸‚à¸¶à¹‰à¸™à¹à¸¥à¸°à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¹‚à¸¢à¸‡à¹‚à¸¥à¸\",\n    wordCount: 20,\n  },\n\n  // INDONESIAN - General\n  {\n    language: \"id\",\n    mode: \"general\",\n    difficulty: \"easy\",\n    content: \"Halo! Cuaca hari ini sangat bagus. Indonesia adalah negara yang indah dengan budaya yang kaya. Makanan Indonesia sangat lezat dan beragam.\",\n    wordCount: 24,\n  },\n  {\n    language: \"id\",\n    mode: \"general\",\n    difficulty: \"medium\",\n    content: \"Teknologi mengubah kehidupan kita. Komputer dan smartphone telah menjadi bagian dari kehidupan sehari-hari. Internet memudahkan akses informasi dan menghubungkan dunia.\",\n    wordCount: 22,\n  },\n  {\n    language: \"id\",\n    mode: \"technical\",\n    difficulty: \"medium\",\n    content: \"Kecerdasan buatan adalah bidang penting dalam teknologi modern. Algoritma pembelajaran mesin dapat menganalisis data dalam jumlah besar. Teknologi ini digunakan dalam kesehatan, keuangan, dan manufaktur.\",\n    wordCount: 27,\n  },\n\n  // ENGLISH - News\n  {\n    language: \"en\",\n    mode: \"news\",\n    difficulty: \"medium\",\n    content: \"Scientists have discovered a breakthrough in renewable energy technology. Solar panels with increased efficiency could revolutionize power generation worldwide. Researchers expect commercial availability within the next five years, potentially reducing carbon emissions significantly.\",\n    wordCount: 35,\n  },\n\n  // ENGLISH - Stories\n  {\n    language: \"en\",\n    mode: \"stories\",\n    difficulty: \"medium\",\n    content: \"Once upon a time in a small village nestled between mountains, there lived a curious girl named Maya. She loved exploring the forests surrounding her home, discovering new plants and animals. One day, while wandering deeper than usual, she stumbled upon a hidden waterfall that sparkled in the sunlight.\",\n    wordCount: 51,\n  },\n\n  // ENGLISH - Business\n  {\n    language: \"en\",\n    mode: \"business\",\n    difficulty: \"medium\",\n    content: \"Effective communication is crucial in modern business environments. Clear emails, professional presentations, and articulate meetings drive successful collaborations. Companies investing in communication training see improved productivity and employee satisfaction. Time management and organizational skills complement strong communication abilities.\",\n    wordCount: 37,\n  },\n];\n\nexport async function seedTypingParagraphs() {\n  console.log(\"Seeding typing paragraphs...\");\n  \n  try {\n    for (const para of paragraphsData) {\n      await db.insert(typingParagraphs).values(para);\n    }\n    console.log(`Successfully seeded ${paragraphsData.length} typing paragraphs`);\n  } catch (error) {\n    console.error(\"Error seeding paragraphs:\", error);\n    throw error;\n  }\n}\n\nseedTypingParagraphs()\n  .then(() => {\n    console.log(\"Seeding completed!\");\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error(\"Seeding failed:\", error);\n    process.exit(1);\n  });\n","path":null,"size_bytes":28772,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Minus } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-9 w-9 items-center justify-center border-y border-r border-input text-sm shadow-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-1 ring-ring\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Minus />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2143,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, VariantProps } from \"class-variance-authority\"\nimport { PanelLeftIcon } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nfunction SidebarProvider({\n  defaultOpen = true,\n  open: openProp,\n  onOpenChange: setOpenProp,\n  className,\n  style,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  defaultOpen?: boolean\n  open?: boolean\n  onOpenChange?: (open: boolean) => void\n}) {\n  const isMobile = useIsMobile()\n  const [openMobile, setOpenMobile] = React.useState(false)\n\n  // This is the internal state of the sidebar.\n  // We use openProp and setOpenProp for control from outside the component.\n  const [_open, _setOpen] = React.useState(defaultOpen)\n  const open = openProp ?? _open\n  const setOpen = React.useCallback(\n    (value: boolean | ((value: boolean) => boolean)) => {\n      const openState = typeof value === \"function\" ? value(open) : value\n      if (setOpenProp) {\n        setOpenProp(openState)\n      } else {\n        _setOpen(openState)\n      }\n\n      // This sets the cookie to keep the sidebar state.\n      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n    },\n    [setOpenProp, open]\n  )\n\n  // Helper to toggle the sidebar.\n  const toggleSidebar = React.useCallback(() => {\n    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open)\n  }, [isMobile, setOpen, setOpenMobile])\n\n  // Adds a keyboard shortcut to toggle the sidebar.\n  React.useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (\n        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n        (event.metaKey || event.ctrlKey)\n      ) {\n        event.preventDefault()\n        toggleSidebar()\n      }\n    }\n\n    window.addEventListener(\"keydown\", handleKeyDown)\n    return () => window.removeEventListener(\"keydown\", handleKeyDown)\n  }, [toggleSidebar])\n\n  // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n  // This makes it easier to style the sidebar with Tailwind classes.\n  const state = open ? \"expanded\" : \"collapsed\"\n\n  const contextValue = React.useMemo<SidebarContextProps>(\n    () => ({\n      state,\n      open,\n      setOpen,\n      isMobile,\n      openMobile,\n      setOpenMobile,\n      toggleSidebar,\n    }),\n    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n  )\n\n  return (\n    <SidebarContext.Provider value={contextValue}>\n      <TooltipProvider delayDuration={0}>\n        <div\n          data-slot=\"sidebar-wrapper\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH,\n              \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n              ...style,\n            } as React.CSSProperties\n          }\n          className={cn(\n            \"group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full\",\n            className\n          )}\n          {...props}\n        >\n          {children}\n        </div>\n      </TooltipProvider>\n    </SidebarContext.Provider>\n  )\n}\n\nfunction Sidebar({\n  side = \"left\",\n  variant = \"sidebar\",\n  collapsible = \"offcanvas\",\n  className,\n  children,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  side?: \"left\" | \"right\"\n  variant?: \"sidebar\" | \"floating\" | \"inset\"\n  collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n}) {\n  const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n  if (collapsible === \"none\") {\n    return (\n      <div\n        data-slot=\"sidebar\"\n        className={cn(\n          \"bg-sidebar text-sidebar-foreground flex h-full w-[var(--sidebar-width)] flex-col\",\n          className\n        )}\n        {...props}\n      >\n        {children}\n      </div>\n    )\n  }\n\n  if (isMobile) {\n    return (\n      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n        <SheetContent\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar\"\n          data-mobile=\"true\"\n          className=\"bg-sidebar text-sidebar-foreground w-[var(--sidebar-width)] p-0 [&>button]:hidden\"\n          style={\n            {\n              \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n            } as React.CSSProperties\n          }\n          side={side}\n        >\n          <SheetHeader className=\"sr-only\">\n            <SheetTitle>Sidebar</SheetTitle>\n            <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n          </SheetHeader>\n          <div className=\"flex h-full w-full flex-col\">{children}</div>\n        </SheetContent>\n      </Sheet>\n    )\n  }\n\n  return (\n    <div\n      className=\"group peer text-sidebar-foreground hidden md:block\"\n      data-state={state}\n      data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n      data-variant={variant}\n      data-side={side}\n      data-slot=\"sidebar\"\n    >\n      {/* This is what handles the sidebar gap on desktop */}\n      <div\n        data-slot=\"sidebar-gap\"\n        className={cn(\n          \"relative w-[var(--sidebar-width)] bg-transparent transition-[width] duration-200 ease-linear\",\n          \"group-data-[collapsible=offcanvas]:w-0\",\n          \"group-data-[side=right]:rotate-180\",\n          variant === \"floating\" || variant === \"inset\"\n            ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4))]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)]\"\n        )}\n      />\n      <div\n        data-slot=\"sidebar-container\"\n        className={cn(\n          \"fixed inset-y-0 z-10 hidden h-svh w-[var(--sidebar-width)] transition-[left,right,width] duration-200 ease-linear md:flex\",\n          side === \"left\"\n            ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n            : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n          // Adjust the padding for floating and inset variants.\n          variant === \"floating\" || variant === \"inset\"\n            ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+var(--spacing-4)+2px)]\"\n            : \"group-data-[collapsible=icon]:w-[var(--sidebar-width-icon)] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n          className\n        )}\n        {...props}\n      >\n        <div\n          data-sidebar=\"sidebar\"\n          data-slot=\"sidebar-inner\"\n          className=\"bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm\"\n        >\n          {children}\n        </div>\n      </div>\n    </div>\n  )\n}\n\nfunction SidebarTrigger({\n  className,\n  onClick,\n  ...props\n}: React.ComponentProps<typeof Button>) {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      data-sidebar=\"trigger\"\n      data-slot=\"sidebar-trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeftIcon />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n}\n\nfunction SidebarRail({ className, ...props }: React.ComponentProps<\"button\">) {\n  const { toggleSidebar } = useSidebar()\n\n  // Note: Tailwind v3.4 doesn't support \"in-\" selectors. So the rail won't work perfectly.\n  return (\n    <button\n      data-sidebar=\"rail\"\n      data-slot=\"sidebar-rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex\",\n        \"in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInset({ className, ...props }: React.ComponentProps<\"main\">) {\n  return (\n    <main\n      data-slot=\"sidebar-inset\"\n      className={cn(\n        \"bg-background relative flex w-full flex-1 flex-col\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarInput({\n  className,\n  ...props\n}: React.ComponentProps<typeof Input>) {\n  return (\n    <Input\n      data-slot=\"sidebar-input\"\n      data-sidebar=\"input\"\n      className={cn(\"bg-background h-8 w-full shadow-none\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-header\"\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-footer\"\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarSeparator({\n  className,\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"sidebar-separator\"\n      data-sidebar=\"separator\"\n      className={cn(\"bg-sidebar-border mx-2 w-auto\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-content\"\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroup({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group\"\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupLabel({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-label\"\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:h-4 [&>svg]:w-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupAction({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"button\"> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-group-action\"\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarGroupContent({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-group-content\"\n      data-sidebar=\"group-content\"\n      className={cn(\"w-full text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenu({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu\"\n      data-sidebar=\"menu\"\n      className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuItem({ className, ...props }: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-item\"\n      data-sidebar=\"menu-item\"\n      className={cn(\"group/menu-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:w-8! group-data-[collapsible=icon]:h-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:p-0!\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nfunction SidebarMenuButton({\n  asChild = false,\n  isActive = false,\n  variant = \"default\",\n  size = \"default\",\n  tooltip,\n  className,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  isActive?: boolean\n  tooltip?: string | React.ComponentProps<typeof TooltipContent>\n} & VariantProps<typeof sidebarMenuButtonVariants>) {\n  const Comp = asChild ? Slot : \"button\"\n  const { isMobile, state } = useSidebar()\n\n  const button = (\n    <Comp\n      data-slot=\"sidebar-menu-button\"\n      data-sidebar=\"menu-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n      {...props}\n    />\n  )\n\n  if (!tooltip) {\n    return button\n  }\n\n  if (typeof tooltip === \"string\") {\n    tooltip = {\n      children: tooltip,\n    }\n  }\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>{button}</TooltipTrigger>\n      <TooltipContent\n        side=\"right\"\n        align=\"center\"\n        hidden={state !== \"collapsed\" || isMobile}\n        {...tooltip}\n      />\n    </Tooltip>\n  )\n}\n\nfunction SidebarMenuAction({\n  className,\n  asChild = false,\n  showOnHover = false,\n  ...props\n}: React.ComponentProps<\"button\"> & {\n  asChild?: boolean\n  showOnHover?: boolean\n}) {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-action\"\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 md:after:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuBadge({\n  className,\n  ...props\n}: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"sidebar-menu-badge\"\n      data-sidebar=\"menu-badge\"\n      className={cn(\n        \"text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none\",\n        \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSkeleton({\n  className,\n  showIcon = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  showIcon?: boolean\n}) {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      data-slot=\"sidebar-menu-skeleton\"\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[var(--skeleton-width)] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n}\n\nfunction SidebarMenuSub({ className, ...props }: React.ComponentProps<\"ul\">) {\n  return (\n    <ul\n      data-slot=\"sidebar-menu-sub\"\n      data-sidebar=\"menu-sub\"\n      className={cn(\n        \"border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubItem({\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) {\n  return (\n    <li\n      data-slot=\"sidebar-menu-sub-item\"\n      data-sidebar=\"menu-sub-item\"\n      className={cn(\"group/menu-sub-item relative\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction SidebarMenuSubButton({\n  asChild = false,\n  size = \"md\",\n  isActive = false,\n  className,\n  ...props\n}: React.ComponentProps<\"a\"> & {\n  asChild?: boolean\n  size?: \"sm\" | \"md\"\n  isActive?: boolean\n}) {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      data-slot=\"sidebar-menu-sub-button\"\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline outline-2 outline-transparent outline-offset-2 focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":21846,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-base shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":768,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000\nconst TOAST_AUTO_DISMISS_DELAY = 6000 // Auto-dismiss after 6 seconds\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\nconst autoDismissTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\n// Auto-dismiss toast after specified delay\nconst scheduleAutoDismiss = (toastId: string) => {\n  if (autoDismissTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    autoDismissTimeouts.delete(toastId)\n    dispatch({ type: \"DISMISS_TOAST\", toastId })\n  }, TOAST_AUTO_DISMISS_DELAY)\n\n  autoDismissTimeouts.set(toastId, timeout)\n}\n\nconst clearAutoDismiss = (toastId: string) => {\n  const timeout = autoDismissTimeouts.get(toastId)\n  if (timeout) {\n    clearTimeout(timeout)\n    autoDismissTimeouts.delete(toastId)\n  }\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => {\n    clearAutoDismiss(id)\n    dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n  }\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  // Schedule auto-dismiss after 6 seconds\n  scheduleAutoDismiss(id)\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":4691,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Portal>\n    <TooltipPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 overflow-hidden rounded-lg bg-zinc-900 border border-zinc-700 px-3 py-2 text-xs text-zinc-100 shadow-xl shadow-black/20 animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </TooltipPrimitive.Portal>\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1305,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-9 w-full items-center justify-between whitespace-nowrap rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-1 focus:ring-ring disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"px-2 py-1.5 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute right-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5745,"size_tokens":null},"client/src/lib/auth-context.tsx":{"content":"import { createContext, useContext, useState, useEffect, ReactNode } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\n\ninterface User {\n  id: string;\n  username: string;\n  email: string;\n  avatarColor?: string | null;\n  bio?: string | null;\n  country?: string | null;\n  keyboardLayout?: string | null;\n}\n\ninterface AuthContextType {\n  user: User | null;\n  isLoading: boolean;\n  login: (email: string, password: string, rememberMe?: boolean) => Promise<void>;\n  register: (username: string, email: string, password: string) => Promise<void>;\n  logout: () => Promise<void>;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nasync function fetchCurrentUser(): Promise<User | null> {\n  const response = await fetch(\"/api/auth/me\", {\n    credentials: \"include\",\n  });\n  \n  if (!response.ok) {\n    if (response.status === 401) {\n      return null;\n    }\n    throw new Error(\"Failed to fetch user\");\n  }\n  \n  const data = await response.json();\n  return data.user;\n}\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const queryClient = useQueryClient();\n  \n  const { data: user, isLoading } = useQuery({\n    queryKey: [\"user\"],\n    queryFn: fetchCurrentUser,\n    retry: false,\n    staleTime: Infinity,\n  });\n\n  const loginMutation = useMutation({\n    mutationFn: async ({ email, password, rememberMe }: { email: string; password: string; rememberMe?: boolean }) => {\n      const response = await fetch(\"/api/auth/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ email, password, rememberMe: rememberMe ?? false }),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json();\n        const errorMessage = errorData.error?.message || errorData.message || \"Invalid email or password\";\n        throw new Error(errorMessage);\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"user\"] });\n    },\n  });\n\n  const registerMutation = useMutation({\n    mutationFn: async ({ username, email, password }: { username: string; email: string; password: string }) => {\n      const response = await fetch(\"/api/auth/register\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ username, email, password }),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json();\n        const errorMessage = errorData.error?.message || errorData.message || \"Registration failed. Please try again.\";\n        throw new Error(errorMessage);\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"user\"] });\n    },\n  });\n\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      const response = await fetch(\"/api/auth/logout\", {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Logout failed\");\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.setQueryData([\"user\"], null);\n    },\n  });\n\n  const login = async (email: string, password: string, rememberMe?: boolean) => {\n    await loginMutation.mutateAsync({ email, password, rememberMe });\n  };\n\n  const register = async (username: string, email: string, password: string) => {\n    await registerMutation.mutateAsync({ username, email, password });\n  };\n\n  const logout = async () => {\n    await logoutMutation.mutateAsync();\n  };\n\n  return (\n    <AuthContext.Provider value={{ user: user || null, isLoading, login, register, logout }}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error(\"useAuth must be used within an AuthProvider\");\n  }\n  return context;\n}\n","path":null,"size_bytes":4002,"size_tokens":null},"client/src/components/typing-test.tsx":{"content":"import { useState, useEffect, useRef, useCallback, useMemo, memo, forwardRef } from \"react\";\nimport { generateText, calculateWPM, calculateAccuracy } from \"@/lib/typing-utils\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { RefreshCw, Zap, Target, Clock, Globe, BookOpen, Sparkles, Award, Share2, Twitter, Facebook, MessageCircle, Copy, Check, Link2, Linkedin, Mail, Send, AlertCircle, Loader2, HelpCircle, Timer, BarChart3, Eye, EyeOff, PenLine, Info } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport confetti from \"canvas-confetti\";\nimport { cn } from \"@/lib/utils\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport AuthPromptDialog from \"@/components/auth-prompt-dialog\";\nimport { SearchableSelect } from \"@/components/searchable-select\";\nimport { CertificateGenerator } from \"@/components/certificate-generator\";\nimport { ShareCard } from \"@/components/share-card\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { KeystrokeTracker } from \"@/lib/keystroke-tracker\";\nimport { useAchievementCelebration, type UnlockedAchievement, preWarmAudioContext } from \"@/components/achievement-celebration\";\n\ntype TestMode = 15 | 30 | 45 | 60 | 90 | 120 | 180 | number;\n\n// Character component with forwardRef for cursor positioning\n// Removed memo() to ensure refs stay synchronized with text changes\nconst CharSpan = forwardRef<HTMLSpanElement, { \n  char: string; \n  index: number; \n  state: 'pending' | 'correct' | 'incorrect';\n  typedChar?: string;\n}>(({ char, index, state, typedChar }, ref) => {\n  const className = state === 'pending' \n    ? \"relative text-muted-foreground/40\"\n    : state === 'correct' \n      ? \"relative text-green-500\" \n      : \"relative text-destructive\";\n  \n  // Show typed character when incorrect, expected character otherwise\n  const displayChar = state === 'incorrect' && typedChar ? typedChar : char;\n  \n  return (\n    <span ref={ref} data-char-index={index} className={className}>\n      {displayChar}\n    </span>\n  );\n});\nCharSpan.displayName = 'CharSpan';\n\nconst LANGUAGE_NAMES: Record<string, string> = {\n  en: \"English\",\n  es: \"Spanish\",\n  fr: \"French\",\n  de: \"German\",\n  it: \"Italian\",\n  pt: \"Portuguese\",\n  ja: \"Japanese\",\n  zh: \"Chinese\",\n  hi: \"Hindi\",\n  ru: \"Russian\",\n  ar: \"Arabic\",\n  ko: \"Korean\",\n  mr: \"Marathi\",\n  bn: \"Bengali\",\n  ta: \"Tamil\",\n  te: \"Telugu\",\n  vi: \"Vietnamese\",\n  tr: \"Turkish\",\n  pl: \"Polish\",\n  nl: \"Dutch\",\n  sv: \"Swedish\",\n  th: \"Thai\",\n  id: \"Indonesian\",\n};\n\nconst MODE_NAMES: Record<string, string> = {\n  general: \"General\",\n  entertainment: \"Entertainment\",\n  technical: \"Technical\",\n  quotes: \"Quotes\",\n  programming: \"Programming\",\n  news: \"News\",\n  stories: \"Stories\",\n  business: \"Business\",\n};\n\nconst TIME_PRESETS = [\n  { value: 15, label: \"15s\" },\n  { value: 30, label: \"30s\" },\n  { value: 45, label: \"45s\" },\n  { value: 60, label: \"1 min\" },\n  { value: 90, label: \"1.5 min\" },\n  { value: 120, label: \"2 min\" },\n  { value: 180, label: \"3 min\" },\n];\n\n// Character state interface for Monkeytype-style validation\ninterface CharState {\n  expected: string;\n  typed: string | null;\n  state: 'pending' | 'correct' | 'incorrect';\n}\n\nexport default function TypingTest() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const { celebrateMultiple } = useAchievementCelebration();\n  const [mode, setMode] = useState<TestMode>(60);\n  const [customTime, setCustomTime] = useState<string>(\"\");\n  const [showCustomInput, setShowCustomInput] = useState(false);\n  const [language, setLanguage] = useState(\"en\");\n  const [paragraphMode, setParagraphMode] = useState<string>(\"general\");\n  const [difficulty, setDifficulty] = useState<\"easy\" | \"medium\" | \"hard\">(\"easy\");\n  const [customPrompt, setCustomPrompt] = useState(\"\");\n  const [showCustomPrompt, setShowCustomPrompt] = useState(false);\n  const [text, setText] = useState(\"\");\n  const [originalText, setOriginalText] = useState(\"\"); // Store original paragraph for repeating\n  const [userInput, setUserInput] = useState(\"\");\n  // Monkeytype-style character tracking - persistent state for each character\n  const [charStates, setCharStates] = useState<CharState[]>([]);\n  const [cursorIndex, setCursorIndex] = useState(0);\n  const [startTime, setStartTime] = useState<number | null>(null);\n  const [timeLeft, setTimeLeft] = useState<number>(mode);\n  const [isActive, setIsActive] = useState(false);\n  const [isFinished, setIsFinished] = useState(false);\n  const [wpm, setWpm] = useState(0);\n  const [rawWpm, setRawWpm] = useState(0);\n  const [consistency, setConsistency] = useState(100);\n  const [accuracy, setAccuracy] = useState(100);\n  const [errors, setErrors] = useState(0);\n  const wpmHistoryRef = useRef<number[]>([]);\n  const [showAuthPrompt, setShowAuthPrompt] = useState(false);\n  const [isGenerating, setIsGenerating] = useState(false);\n  const [showCertificate, setShowCertificate] = useState(false);\n  const [testCompletionDate, setTestCompletionDate] = useState<Date>(new Date());\n  const [showShareModal, setShowShareModal] = useState(false);\n  const [lastResultId, setLastResultId] = useState<number | null>(null);\n  const [shareUrl, setShareUrl] = useState<string>(\"\");\n  const [isCreatingShare, setIsCreatingShare] = useState(false);\n  const [copied, setCopied] = useState(false);\n  const [smoothCaret, setSmoothCaret] = useState(true);\n  const [caretSpeed, setCaretSpeed] = useState<'off' | 'fast' | 'medium' | 'smooth'>('medium');\n  const [quickRestart, setQuickRestart] = useState(true);\n  const [zenMode, setZenMode] = useState(false);\n  const [freestyleMode, setFreestyleMode] = useState(false);\n  const [freestyleText, setFreestyleText] = useState(\"\");\n  const freestyleLastKeystrokeRef = useRef<number>(0);\n  const [lastResultSnapshot, setLastResultSnapshot] = useState<{\n    wpm: number;\n    accuracy: number;\n    errors: number;\n    characters: number;\n    words: number;\n    consistency: number;\n    freestyle: boolean;\n    mode: number;\n    completionDate: string; // ISO string to avoid Date serialization issues\n  } | null>(null);\n  const [cursorPosition, setCursorPosition] = useState({ left: 0, top: 0, height: 40 });\n  const [isTypingFast, setIsTypingFast] = useState(false);\n  const lastKeystrokeTimeRef = useRef<number>(0);\n  const [prefersReducedMotion, setPrefersReducedMotion] = useState(false);\n  \n  // Detect prefers-reduced-motion for accessibility\n  useEffect(() => {\n    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');\n    setPrefersReducedMotion(mediaQuery.matches);\n    \n    const handler = (e: MediaQueryListEvent) => setPrefersReducedMotion(e.matches);\n    mediaQuery.addEventListener('change', handler);\n    return () => mediaQuery.removeEventListener('change', handler);\n  }, []);\n  const [isComposing, setIsComposing] = useState(false);\n  const [hasInteracted, setHasInteracted] = useState(false);\n  const [paragraphError, setParagraphError] = useState<string | null>(null);\n  const [fetchRetryCount, setFetchRetryCount] = useState(0);\n  const MAX_RETRY_ATTEMPTS = 3;\n  \n  const inputRef = useRef<HTMLInputElement>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const charRefs = useRef<(HTMLSpanElement | null)[]>([]);\n  const keystrokeTrackerRef = useRef<KeystrokeTracker | null>(null);\n  const pendingFetchesRef = useRef(0);\n  const latestRequestIdRef = useRef(0);\n  const appliedRequestIdRef = useRef(0);\n  const [trackingEnabled, setTrackingEnabled] = useState(true);\n  \n  // PRODUCTION-READY: Capture selection BEFORE it collapses\n  const selectionRangeRef = useRef<{ start: number; end: number }>({ start: 0, end: 0 });\n  \n  // Track user-initiated scrolling to pause auto-scroll\n  const isUserScrollingRef = useRef(false);\n  const userScrollTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  \n  // Paragraph queue for seamless continuous typing\n  interface QueuedParagraph { id: number; content: string; }\n  const paragraphQueueRef = useRef<QueuedParagraph[]>([]);\n  const usedParagraphIdsRef = useRef<Set<number>>(new Set());\n  const isFetchingQueueRef = useRef(false);\n  const MIN_QUEUE_SIZE = 3;\n\n  const { data: languagesData, isError: languagesError, isFetching: languagesFetching, refetch: refetchLanguages } = useQuery({\n    queryKey: [\"languages\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/typing/languages\");\n      if (!response.ok) throw new Error(\"Failed to fetch languages\");\n      return response.json();\n    },\n    retry: 2,\n    staleTime: 5 * 60 * 1000,\n  });\n\n  const { data: modesData, isError: modesError, isFetching: modesFetching, refetch: refetchModes } = useQuery({\n    queryKey: [\"modes\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/typing/modes\");\n      if (!response.ok) throw new Error(\"Failed to fetch modes\");\n      return response.json();\n    },\n    retry: 2,\n    staleTime: 5 * 60 * 1000,\n  });\n\n  // Fast batch fetch for paragraph queue (database only, no AI generation)\n  const fillParagraphQueue = useCallback(async () => {\n    if (isFetchingQueueRef.current) return;\n    if (paragraphQueueRef.current.length >= MIN_QUEUE_SIZE) return;\n    \n    isFetchingQueueRef.current = true;\n    try {\n      const needed = MIN_QUEUE_SIZE - paragraphQueueRef.current.length + 3;\n      const url = `/api/typing/paragraphs/batch?language=${language}&mode=${paragraphMode}&difficulty=${difficulty}&count=${needed}&t=${Date.now()}`;\n      const response = await fetch(url);\n      if (response.ok) {\n        const data = await response.json();\n        if (data.paragraphs && data.paragraphs.length > 0) {\n          // Filter out already-used paragraphs and add new ones\n          const newParagraphs: QueuedParagraph[] = [];\n          for (const p of data.paragraphs) {\n            if (!usedParagraphIdsRef.current.has(p.id)) {\n              newParagraphs.push({ id: p.id, content: p.content });\n              usedParagraphIdsRef.current.add(p.id);\n            }\n          }\n          // Atomic update of queue\n          paragraphQueueRef.current = [...paragraphQueueRef.current, ...newParagraphs];\n        }\n      }\n    } catch (error) {\n      console.error(\"Queue fetch error:\", error);\n    } finally {\n      isFetchingQueueRef.current = false;\n    }\n  }, [language, paragraphMode, difficulty]);\n\n  // Get next paragraph from queue (instant) or fetch if empty\n  const getNextFromQueue = useCallback((): string | null => {\n    if (paragraphQueueRef.current.length > 0) {\n      const next = paragraphQueueRef.current.shift()!;\n      // Trigger background refill if queue is getting low\n      if (paragraphQueueRef.current.length < MIN_QUEUE_SIZE) {\n        fillParagraphQueue();\n      }\n      return next.content;\n    }\n    return null;\n  }, [fillParagraphQueue]);\n\n  const fetchParagraph = useCallback(async (useCustomPrompt = false, forceGenerate = false) => {\n    // Increment request ID and capture it for this fetch\n    latestRequestIdRef.current++;\n    const currentRequestId = latestRequestIdRef.current;\n    \n    // Clear any existing error state when starting a new fetch\n    setParagraphError(null);\n    \n    // Increment pending fetches counter\n    pendingFetchesRef.current++;\n    setIsGenerating(true);\n    \n    try {\n      // Show toast notification for custom prompts or force-generate\n      if (useCustomPrompt) {\n        toast({\n          title: \"ðŸ¤– Generating Custom Content...\",\n          description: \"AI is creating a paragraph based on your request\",\n        });\n      } else if (forceGenerate) {\n        toast({\n          title: \"ðŸ¤– Generating New Paragraph...\",\n          description: \"AI is creating fresh content for you\",\n        });\n      }\n      \n      // Try with AI generation enabled - add timestamp to prevent caching\n      let url = `/api/typing/paragraph?language=${language}&mode=${paragraphMode}&difficulty=${difficulty}&generate=true&t=${Date.now()}`;\n      \n      if (forceGenerate) {\n        url += `&forceGenerate=true`;\n      }\n      \n      if (useCustomPrompt && customPrompt.trim()) {\n        url += `&customPrompt=${encodeURIComponent(customPrompt.trim())}`;\n      }\n      \n      const response = await fetch(url, {\n        cache: 'no-store', // Prevent browser caching\n      });\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch paragraph\");\n      }\n      const data = await response.json();\n      const paragraphText = data.paragraph.content;\n      \n      // Calculate initial text size - cap at ~500 words for performance\n      // The queue system will extend text dynamically as user types\n      // IMPORTANT: Skip extension for explicitly generated paragraphs to preserve AI content as-is\n      let extendedText = paragraphText;\n      \n      if (!forceGenerate) {\n        // Only extend text for database-fetched paragraphs, not explicit AI generations\n        // This ensures AI-generated paragraphs are used as-is when user clicks \"New Paragraph\"\n        const MAX_INITIAL_WORDS = 500; // ~10 minutes of typing at 50 WPM\n        const wordsNeeded = Math.min(Math.ceil((mode / 60) * 50), MAX_INITIAL_WORDS);\n        const currentWords = paragraphText.split(/\\s+/).length;\n        \n        // Build initial text, ensuring we don't exceed the word cap\n        if (currentWords < wordsNeeded) {\n          const repetitionsNeeded = Math.ceil(wordsNeeded / currentWords);\n          extendedText = Array(repetitionsNeeded).fill(paragraphText).join(\" \");\n        }\n        \n        // Strictly enforce word cap by slicing to exact limit\n        const words = extendedText.split(/\\s+/);\n        if (words.length > MAX_INITIAL_WORDS) {\n          extendedText = words.slice(0, MAX_INITIAL_WORDS).join(\" \");\n        }\n      }\n      \n      // Only update state if this is still the latest request (ignore stale responses)\n      if (currentRequestId === latestRequestIdRef.current) {\n        setText(extendedText);\n        setOriginalText(paragraphText);\n        setParagraphError(null);\n        setFetchRetryCount(0);\n        // Mark this request as successfully applied\n        appliedRequestIdRef.current = currentRequestId;\n        // Clear isGenerating immediately when latest request applies (don't wait for stale fetches)\n        setIsGenerating(false);\n        setUserInput(\"\"); // Clean slate for new test\n        // Add current paragraph ID to used set to prevent duplicates in queue\n        if (data.paragraph.id) {\n          usedParagraphIdsRef.current.add(data.paragraph.id);\n        }\n        // Pre-seed paragraph queue for seamless continuous typing\n        if (paragraphQueueRef.current.length < MIN_QUEUE_SIZE) {\n          fillParagraphQueue();\n        }\n      } else {\n        // Stale response - silently ignore\n        return;\n      }\n      \n      // Notify user based on context (only for latest request)\n      if (data.fallbackUsed) {\n        const requestedLang = LANGUAGE_NAMES[language] || language;\n        const deliveredLang = LANGUAGE_NAMES[data.paragraph.language] || data.paragraph.language;\n        const deliveredMode = MODE_NAMES[data.paragraph.mode] || data.paragraph.mode;\n        \n        toast({\n          title: \"Content adjusted\",\n          description: `${requestedLang} ${MODE_NAMES[paragraphMode] || paragraphMode} not available. Showing ${deliveredLang} ${deliveredMode} instead.`,\n          variant: \"default\",\n        });\n      } else if (useCustomPrompt) {\n        toast({\n          title: \"âœ¨ Custom Content Ready!\",\n          description: \"AI created your requested paragraph\",\n        });\n      } else if (forceGenerate) {\n        toast({\n          title: \"âœ¨ New Paragraph Ready!\",\n          description: `Fresh ${difficulty} difficulty content generated`,\n        });\n      }\n    } catch (error) {\n      console.error(\"Error fetching paragraph:\", error);\n      \n      // Only update state if this is still the latest request\n      if (currentRequestId === latestRequestIdRef.current) {\n        const newRetryCount = fetchRetryCount + 1;\n        setFetchRetryCount(newRetryCount);\n        \n        // Check if we've exceeded max retries\n        if (newRetryCount >= MAX_RETRY_ATTEMPTS) {\n          // Use fallback text after max retries\n          const fallbackText = generateText(100);\n          setText(fallbackText);\n          setOriginalText(fallbackText);\n          setParagraphError(null);\n          toast({\n            title: \"Using practice text\",\n            description: \"Unable to connect to server. Using generated text for practice.\",\n            variant: \"default\",\n          });\n        } else {\n          // Show error state with retry option\n          setParagraphError(\"Unable to load typing content. Please check your connection.\");\n          toast({\n            title: \"Connection issue\",\n            description: `Failed to load content (attempt ${newRetryCount}/${MAX_RETRY_ATTEMPTS}). Tap retry or we'll use practice text.`,\n            variant: \"destructive\",\n          });\n        }\n        \n        // Mark this request as successfully applied\n        appliedRequestIdRef.current = currentRequestId;\n        setIsGenerating(false);\n        setUserInput(\"\");\n      }\n    } finally {\n      pendingFetchesRef.current = Math.max(0, pendingFetchesRef.current - 1);\n    }\n  }, [language, paragraphMode, difficulty, customPrompt, mode, toast, fetchRetryCount]);\n\n  const [pendingResult, setPendingResult] = useState<{ wpm: number; accuracy: number; mode: number; characters: number; errors: number; language: string; freestyle?: boolean } | null>(null);\n\n  const saveResultMutation = useMutation({\n    mutationFn: async (result: { wpm: number; accuracy: number; mode: number; characters: number; errors: number; language: string; freestyle?: boolean }) => {\n      const response = await fetch(\"/api/test-results\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(result),\n      });\n      \n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.message || \"Failed to save test result\");\n      }\n      \n      return response.json();\n    },\n    onSuccess: (data) => {\n      if (data?.id) {\n        setLastResultId(data.id);\n      }\n      setPendingResult(null);\n      toast({\n        title: \"Test Saved!\",\n        description: \"Your result has been saved to your profile.\",\n      });\n      \n      if (data?.newAchievements && data.newAchievements.length > 0) {\n        const categoryIcons: Record<string, string> = {\n          speed: \"âš¡\",\n          accuracy: \"ðŸŽ¯\",\n          streak: \"ðŸ”¥\",\n          consistency: \"ðŸ“ˆ\",\n          special: \"â­\",\n        };\n        \n        const formattedAchievements: UnlockedAchievement[] = data.newAchievements.map((a: any) => ({\n          id: a.key,\n          name: a.name,\n          description: a.description,\n          icon: categoryIcons[a.category] || \"ðŸ†\",\n          tier: a.tier as UnlockedAchievement[\"tier\"],\n          points: a.points,\n          category: a.category,\n        }));\n        \n        celebrateMultiple(formattedAchievements);\n      }\n      \n      // Show \"Almost There\" notifications for near-completion achievements (80%+)\n      if (data?.nearCompletionAchievements && data.nearCompletionAchievements.length > 0) {\n        const categoryIcons: Record<string, string> = {\n          speed: \"âš¡\",\n          accuracy: \"ðŸŽ¯\",\n          streak: \"ðŸ”¥\",\n          consistency: \"ðŸ“ˆ\",\n          special: \"â­\",\n        };\n        \n        // Show only the top 1-2 closest achievements to avoid notification spam\n        const topNearAchievements = data.nearCompletionAchievements.slice(0, 2);\n        \n        // Delay near-completion toasts to avoid overlap with celebration modal\n        setTimeout(() => {\n          topNearAchievements.forEach((achievement: any, index: number) => {\n            setTimeout(() => {\n              const icon = categoryIcons[achievement.category] || \"ðŸŽ¯\";\n              const remaining = Math.max(0, achievement.targetValue - achievement.currentValue);\n              \n              let progressMessage = \"\";\n              if (achievement.category === \"speed\") {\n                progressMessage = remaining > 0 \n                  ? `Just ${remaining} more WPM to go!` \n                  : `${achievement.progress}% there!`;\n              } else if (achievement.category === \"accuracy\") {\n                const accuracyRemaining = Math.max(0, achievement.targetValue - achievement.currentValue);\n                progressMessage = accuracyRemaining > 0 \n                  ? `Just ${accuracyRemaining.toFixed(1)}% more accuracy needed!`\n                  : `${achievement.progress}% there - keep it accurate!`;\n              } else if (achievement.category === \"streak\") {\n                progressMessage = remaining > 0 \n                  ? `${remaining} more day${remaining !== 1 ? 's' : ''} to unlock!`\n                  : `${achievement.progress}% there!`;\n              } else if (achievement.category === \"consistency\") {\n                progressMessage = remaining > 0 \n                  ? `${remaining} more test${remaining !== 1 ? 's' : ''} to go!`\n                  : `${achievement.progress}% there!`;\n              } else {\n                progressMessage = `${achievement.progress}% complete!`;\n              }\n              \n              toast({\n                title: `${icon} Almost There: ${achievement.name}`,\n                description: progressMessage,\n              });\n            }, index * 1500);\n          });\n        }, data.newAchievements?.length > 0 ? 4000 : 500);\n      }\n    },\n    onError: (error, variables) => {\n      setPendingResult(variables);\n      toast({\n        title: \"Save Failed\",\n        description: \"Could not save your test result. Use the retry button below.\",\n        variant: \"destructive\",\n        action: (\n          <button\n            onClick={() => saveResultMutation.mutate(variables)}\n            className=\"bg-primary text-primary-foreground px-3 py-1 rounded text-sm\"\n          >\n            Retry\n          </button>\n        ),\n      });\n    },\n    retry: 1,\n  });\n\n  const retryPendingResult = useCallback(() => {\n    if (pendingResult) {\n      saveResultMutation.mutate(pendingResult);\n    }\n  }, [pendingResult, saveResultMutation]);\n\n  const resetTest = useCallback(async (forceNewParagraph = false) => {\n    // Reset test state first\n    setUserInput(\"\");\n    setFreestyleText(\"\");\n    setStartTime(null);\n    setTimeLeft(mode);\n    setIsActive(false);\n    setIsFinished(false);\n    setWpm(0);\n    setRawWpm(0);\n    setConsistency(100);\n    setAccuracy(100);\n    setShowAuthPrompt(false);\n    setShowShareModal(false);\n    setShareUrl(\"\");\n    setLastResultId(null);\n    setHasInteracted(false);\n    \n    // Reset Monkeytype-style character tracking\n    setCursorIndex(0);\n    setCharStates([]);\n    \n    // NOTE: certificateMetrics intentionally NOT cleared here\n    // This allows users to view their certificate even after quick restart\n    // Metrics will be updated when the next test completes\n    \n    // Clear keystroke tracker and WPM history to start fresh\n    keystrokeTrackerRef.current = null;\n    wpmHistoryRef.current = [];\n    \n    // Reset freestyle last keystroke time\n    freestyleLastKeystrokeRef.current = 0;\n    \n    // Only fetch new paragraph if not in freestyle mode\n    if (!freestyleMode) {\n      if (forceNewParagraph) {\n        // User explicitly requested a new paragraph - always use AI generation for diversity\n        await fetchParagraph(false, true);\n      } else {\n        // Normal restart - try queue first for instant loading\n        const queuedParagraph = getNextFromQueue();\n        if (queuedParagraph) {\n          setText(queuedParagraph);\n          setOriginalText(queuedParagraph);\n        } else {\n          // Queue empty - fetch from database\n          await fetchParagraph(false, false);\n        }\n      }\n    }\n    \n    setTimeout(() => inputRef.current?.focus({ preventScroll: true }), 100);\n  }, [mode, fetchParagraph, freestyleMode, getNextFromQueue]);\n\n  const createShareLink = async () => {\n    if (!lastResultId) {\n      toast({\n        title: \"Cannot Share\",\n        description: \"Please save your result first by logging in.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsCreatingShare(true);\n    try {\n      const response = await fetch('/api/share', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify({\n          mode: 'typing-test',\n          resultId: lastResultId,\n          isAnonymous: false\n        }),\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to create share link');\n      }\n\n      const data = await response.json();\n      setShareUrl(data.shareUrl);\n      setShowShareModal(true);\n      \n      toast({\n        title: \"Share Link Created!\",\n        description: \"Your result is ready to share with others.\",\n      });\n    } catch (error) {\n      console.error('Share error:', error);\n      toast({\n        title: \"Share Failed\",\n        description: \"Could not create share link. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsCreatingShare(false);\n    }\n  };\n\n  const copyShareLink = async () => {\n    if (!shareUrl) return;\n    \n    try {\n      await navigator.clipboard.writeText(shareUrl);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n      toast({\n        title: \"Copied!\",\n        description: \"Share link copied to clipboard.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Copy Failed\",\n        description: \"Could not copy link to clipboard.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const getPerformanceRating = () => {\n    if (wpm >= 100 && accuracy >= 98) return { emoji: \"ðŸ†\", title: \"Legendary Typist\", badge: \"Diamond\" };\n    if (wpm >= 80 && accuracy >= 95) return { emoji: \"âš¡\", title: \"Speed Demon\", badge: \"Platinum\" };\n    if (wpm >= 60 && accuracy >= 90) return { emoji: \"ðŸ”¥\", title: \"Fast & Accurate\", badge: \"Gold\" };\n    if (wpm >= 40 && accuracy >= 85) return { emoji: \"ðŸ’ª\", title: \"Solid Performance\", badge: \"Silver\" };\n    return { emoji: \"ðŸŽ¯\", title: \"Rising Star\", badge: \"Bronze\" };\n  };\n\n  const trackShare = async (platform: string) => {\n    if (!user) return;\n    \n    try {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 5000);\n      \n      const response = await fetch('/api/share/track', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify({ platform, resultId: lastResultId }),\n        signal: controller.signal,\n      });\n      \n      clearTimeout(timeoutId);\n      \n      if (response.ok) {\n        const data = await response.json();\n        toast({\n          title: `+${data.bonusXP} XP Earned!`,\n          description: data.totalShares === 1 \n            ? \"First share bonus! Keep sharing to unlock achievements.\"\n            : `Total shares: ${data.totalShares}. Share more to level up!`,\n        });\n      } else {\n        console.warn(`Share tracking failed: ${response.status}`);\n      }\n    } catch (error) {\n      if (error instanceof Error && error.name === 'AbortError') {\n        console.warn('Share tracking timed out');\n      } else {\n        console.error('Share tracking error:', error);\n      }\n    }\n  };\n\n  const shareToSocial = (platform: string) => {\n    const rating = getPerformanceRating();\n    const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n    const siteUrl = \"https://typemasterai.com\";\n    \n    const shareTexts: Record<string, string> = {\n      twitter: `${rating.emoji} Just achieved ${wpm} WPM with ${accuracy}% accuracy on TypeMasterAI!\n\nâŒ¨ï¸ ${rating.title} | ${rating.badge} Badge\nâ±ï¸ ${modeDisplay} test\nðŸŒ ${LANGUAGE_NAMES[language]}\n\nThink you can beat me? ðŸŽ®\n\n#TypingTest #TypeMasterAI #WPM`,\n      \n      facebook: `${rating.emoji} I just achieved ${wpm} Words Per Minute with ${accuracy}% accuracy on TypeMasterAI!\n\nðŸ… ${rating.title} - ${rating.badge} Badge Earned!\nâ±ï¸ ${modeDisplay} typing test\nðŸŒ Language: ${LANGUAGE_NAMES[language]}\n\nChallenge yourself and see how fast you can type! ðŸš€`,\n      \n      linkedin: `Excited to share my typing achievement! ${rating.emoji}\n\nðŸ“Š Performance Stats:\nâ€¢ Speed: ${wpm} Words Per Minute\nâ€¢ Accuracy: ${accuracy}%\nâ€¢ Duration: ${modeDisplay} test\nâ€¢ Rating: ${rating.title} (${rating.badge})\n\nContinuous improvement in professional skills matters. TypeMasterAI helps track and improve typing efficiency.\n\n#ProfessionalDevelopment #Productivity #TypingSkills #TypeMasterAI`,\n      \n      whatsapp: `${rating.emoji} Check out my typing score on TypeMasterAI!\n\nâŒ¨ï¸ *${wpm} WPM* | *${accuracy}% Accuracy*\nðŸ… ${rating.title} - ${rating.badge} Badge\nâ±ï¸ ${modeDisplay} test\n\nCan you beat my score? Try it here: `,\n    };\n    \n    const shareText = shareTexts[platform] || shareTexts.twitter;\n    const encodedText = encodeURIComponent(shareText);\n    const encodedUrl = encodeURIComponent(siteUrl);\n    \n    const urls: Record<string, string> = {\n      twitter: `https://twitter.com/intent/tweet?text=${encodedText}&url=${encodedUrl}`,\n      facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}&quote=${encodedText}`,\n      linkedin: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`,\n      whatsapp: `https://wa.me/?text=${encodedText}${encodedUrl}`,\n    };\n    \n    if (urls[platform]) {\n      window.open(urls[platform], '_blank', 'width=600,height=400');\n      trackShare(platform);\n    }\n  };\n\n  const handleNativeShare = async () => {\n    const rating = getPerformanceRating();\n    const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n    const shareText = `${rating.emoji} I scored ${wpm} WPM with ${accuracy}% accuracy on TypeMasterAI!\\n\\nðŸ… ${rating.title} - ${rating.badge} Badge\\nâ±ï¸ ${modeDisplay} test\\n\\nCan you beat my score?`;\n    const shareUrl = 'https://typemasterai.com';\n    \n    if ('share' in navigator && typeof navigator.canShare === 'function') {\n      try {\n        await navigator.share({\n          title: 'TypeMasterAI - My Typing Result',\n          text: shareText,\n          url: shareUrl,\n        });\n        trackShare('native');\n      } catch (error) {\n        if (error instanceof Error) {\n          if (error.name === 'AbortError') {\n            return;\n          }\n          if (error.name === 'NotAllowedError') {\n            toast({\n              title: \"Share Blocked\",\n              description: \"Browser denied share request. Try copying the link instead.\",\n              variant: \"default\",\n            });\n            return;\n          }\n        }\n        copyToClipboardFallback(`${shareText}\\n${shareUrl}`);\n      }\n    } else {\n      copyToClipboardFallback(`${shareText}\\n${shareUrl}`);\n    }\n  };\n\n  const copyToClipboardFallback = async (text: string) => {\n    try {\n      if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {\n        await navigator.clipboard.writeText(text);\n        toast({\n          title: \"Copied!\",\n          description: \"Text copied to clipboard. Paste to share!\",\n        });\n      } else {\n        const textArea = document.createElement('textarea');\n        textArea.value = text;\n        textArea.style.position = 'fixed';\n        textArea.style.opacity = '0';\n        document.body.appendChild(textArea);\n        textArea.select();\n        const success = document.execCommand('copy');\n        document.body.removeChild(textArea);\n        \n        if (success) {\n          toast({\n            title: \"Copied!\",\n            description: \"Text copied to clipboard. Paste to share!\",\n          });\n        } else {\n          toast({\n            title: \"Copy Failed\",\n            description: \"Please manually select and copy the text.\",\n            variant: \"destructive\",\n          });\n        }\n      }\n    } catch (error) {\n      toast({\n        title: \"Copy Failed\",\n        description: \"Unable to copy to clipboard. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Initialize character states when text changes (Monkeytype-style validation)\n  useEffect(() => {\n    if (text) {\n      setCharStates(prevStates => {\n        const newLength = text.length;\n        const prevLength = prevStates.length;\n        \n        // Text extended during test (continuous typing) - preserve existing states\n        if (newLength > prevLength && prevLength > 0) {\n          // Keep all existing character states (including errors!)\n          // Only append new pending states for the new characters\n          const newChars = text.slice(prevLength);\n          const appendedStates: CharState[] = newChars.split('').map(char => ({\n            expected: char,\n            typed: null,\n            state: 'pending' as const\n          }));\n          return [...prevStates, ...appendedStates];\n        } else {\n          // New paragraph or reset - replace all states\n          const initialStates: CharState[] = text.split('').map(char => ({\n            expected: char,\n            typed: null,\n            state: 'pending' as const\n          }));\n          // Only reset cursor on full replacement, not extension\n          setCursorIndex(0);\n          return initialStates;\n        }\n      });\n    }\n  }, [text]);\n\n  // Initial setup and when time mode changes\n  useEffect(() => {\n    fetchParagraph();\n    setUserInput(\"\");\n    setOriginalText(\"\");\n    setStartTime(null);\n    setTimeLeft(mode);\n    setIsActive(false);\n    setIsFinished(false);\n    setWpm(0);\n    setRawWpm(0);\n    setConsistency(100);\n    setAccuracy(100);\n    // Clear keystroke tracker and WPM history for new test\n    keystrokeTrackerRef.current = null;\n    wpmHistoryRef.current = [];\n    // charRefs cleanup handled automatically by useMemo when text changes\n    // Reset paragraph queue (will be filled after fetchParagraph returns with ID)\n    paragraphQueueRef.current = [];\n    usedParagraphIdsRef.current = new Set();\n    // Reset cursor index\n    setCursorIndex(0);\n    setTimeout(() => inputRef.current?.focus({ preventScroll: true }), 0);\n  }, [mode]);\n\n  // Fetch new paragraph when language, paragraph mode, or difficulty changes\n  useEffect(() => {\n    if (text) {\n      fetchParagraph();\n      setUserInput(\"\");\n      setOriginalText(\"\");\n      setStartTime(null);\n      setIsActive(false);\n      setIsFinished(false);\n      setWpm(0);\n      setRawWpm(0);\n      setConsistency(100);\n      setAccuracy(100);\n      // Clear keystroke tracker and WPM history for new test\n      keystrokeTrackerRef.current = null;\n      wpmHistoryRef.current = [];\n      // charRefs cleanup handled automatically by useMemo when text changes\n      // Reset queue (will be filled after fetchParagraph returns with ID)\n      paragraphQueueRef.current = [];\n      usedParagraphIdsRef.current = new Set();\n      // Reset cursor index\n      setCursorIndex(0);\n    }\n  }, [language, paragraphMode, difficulty]);\n\n  // Timer logic\n  useEffect(() => {\n    let interval: NodeJS.Timeout;\n    if (isActive && timeLeft > 0) {\n      interval = setInterval(() => {\n        setTimeLeft((prev) => prev - 1);\n      }, 1000);\n    } else if (timeLeft === 0 && isActive) {\n      finishTest();\n    }\n    return () => clearInterval(interval);\n  }, [isActive, timeLeft]);\n\n  // Calculate live stats with Raw WPM and Consistency tracking\n  useEffect(() => {\n    if (isActive && startTime) {\n      const chars = userInput.length;\n      const errorCount = userInput.split(\"\").filter((char, i) => char !== text[i]).length;\n      const correctChars = chars - errorCount;\n      const timeElapsed = (Date.now() - startTime) / 1000;\n      \n      // Net WPM (adjusted for errors) - standard metric\n      const netWpm = calculateWPM(correctChars, timeElapsed);\n      // Raw WPM (pure speed, no error penalty)\n      const rawWpmValue = calculateWPM(chars, timeElapsed);\n      \n      setWpm(netWpm);\n      setRawWpm(rawWpmValue);\n      setAccuracy(calculateAccuracy(correctChars, chars));\n      setErrors(errorCount);\n      \n      // Track WPM history for consistency calculation (sample every ~1 second)\n      if (timeElapsed > 1 && Math.floor(timeElapsed) !== Math.floor((Date.now() - startTime - 100) / 1000)) {\n        wpmHistoryRef.current.push(netWpm);\n        \n        // Calculate consistency (lower standard deviation = higher consistency)\n        if (wpmHistoryRef.current.length >= 3) {\n          const avg = wpmHistoryRef.current.reduce((a, b) => a + b, 0) / wpmHistoryRef.current.length;\n          const variance = wpmHistoryRef.current.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / wpmHistoryRef.current.length;\n          const stdDev = Math.sqrt(variance);\n          // Convert to 0-100% scale (lower deviation = higher consistency)\n          // Using formula: 100 - (stdDev / avg * 100), clamped to 0-100\n          const consistencyScore = avg > 0 ? Math.max(0, Math.min(100, Math.round(100 - (stdDev / avg * 100)))) : 100;\n          setConsistency(consistencyScore);\n        }\n      }\n      \n      // Adaptive cursor: detect fast typing (>80 WPM or <150ms between keystrokes)\n      const now = Date.now();\n      if (lastKeystrokeTimeRef.current > 0) {\n        const timeSinceLastKeystroke = now - lastKeystrokeTimeRef.current;\n        setIsTypingFast(timeSinceLastKeystroke < 150 || rawWpmValue > 80);\n      }\n      lastKeystrokeTimeRef.current = now;\n    }\n  }, [userInput, isActive, startTime, text]);\n\n  const finishTest = (completedNaturally = true) => {\n    setIsActive(false);\n    setIsFinished(true);\n    setTestCompletionDate(new Date());\n    \n    // Calculate elapsed time with idle time handling for Freestyle mode\n    let elapsedSeconds: number;\n    \n    if (completedNaturally) {\n      // Timer expired naturally - use mode duration\n      elapsedSeconds = mode;\n    } else if (freestyleMode && startTime && freestyleLastKeystrokeRef.current > 0) {\n      // Freestyle mode with manual finish (Shift+Enter) - use time until last keystroke\n      // This ignores idle time between last keystroke and test finish\n      elapsedSeconds = (freestyleLastKeystrokeRef.current - startTime) / 1000;\n    } else {\n      // Standard mode or fallback - use actual elapsed time\n      elapsedSeconds = startTime ? (Date.now() - startTime) / 1000 : mode;\n    }\n    \n    // Handle Freestyle mode differently - no reference text to compare\n    const typedText = freestyleMode ? freestyleText : userInput;\n    const chars = typedText.length;\n    \n    // Calculate word count based on mode\n    // Freestyle: actual word count (space-separated, matching UI display)\n    // Standard: chars / 5 estimate (matching WPM calculation)\n    const wordCount = freestyleMode\n      ? typedText.trim().split(/\\s+/).filter(w => w.length > 0).length\n      : Math.floor(chars / 5);\n    \n    // Edge case: no characters typed\n    if (chars === 0) {\n      setWpm(0);\n      setRawWpm(0);\n      setAccuracy(freestyleMode ? 100 : 0);\n      setErrors(0);\n      \n      // Show appropriate message\n      if (freestyleMode) {\n        toast({\n          title: \"No Text Typed\",\n          description: \"You didn't type anything during the test. Try again!\",\n          variant: \"default\",\n        });\n      }\n      return;\n    }\n    \n    let errorCount = 0;\n    let correctChars = chars;\n    \n    if (!freestyleMode) {\n      errorCount = userInput.split(\"\").filter((char, i) => char !== text[i]).length;\n      correctChars = chars - errorCount;\n    }\n    \n    // Edge case: prevent division by zero and handle minimum time threshold\n    // At least 1 second to prevent unrealistic WPM values\n    const safeElapsedSeconds = Math.max(elapsedSeconds, 1);\n    \n    // Calculate final WPM with cap to prevent unrealistic values\n    const rawFinalWpm = calculateWPM(correctChars, safeElapsedSeconds);\n    const finalWpm = Math.min(Math.max(rawFinalWpm, 0), 300); // Cap at 0-300 WPM range\n    const finalAccuracy = freestyleMode ? 100 : calculateAccuracy(correctChars, chars);\n    const finalErrors = errorCount;\n    \n    // Calculate final consistency from WPM history (works for both standard and freestyle modes)\n    let finalConsistency = 100; // Default if no samples\n    if (wpmHistoryRef.current.length >= 3) {\n      const avg = wpmHistoryRef.current.reduce((a, b) => a + b, 0) / wpmHistoryRef.current.length;\n      const variance = wpmHistoryRef.current.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / wpmHistoryRef.current.length;\n      const stdDev = Math.sqrt(variance);\n      // Convert to 0-100% scale (lower deviation = higher consistency)\n      finalConsistency = avg > 0 ? Math.max(0, Math.min(100, Math.round(100 - (stdDev / avg * 100)))) : 100;\n    }\n    \n    // Update state with precise final values\n    setWpm(finalWpm);\n    setAccuracy(finalAccuracy);\n    setErrors(finalErrors);\n    setConsistency(finalConsistency); // Use calculated consistency, not reset to 100\n    \n    // Create immutable snapshot for certificate (never cleared, only updated on new test completion)\n    setLastResultSnapshot({\n      wpm: finalWpm,\n      accuracy: finalAccuracy,\n      errors: finalErrors,\n      characters: chars,\n      words: wordCount,\n      consistency: finalConsistency,\n      freestyle: freestyleMode,\n      mode,\n      completionDate: new Date().toISOString(),\n    });\n    \n    // Safe confetti call with error handling\n    try {\n      if (typeof confetti === 'function') {\n        confetti({\n          particleCount: 100,\n          spread: 70,\n          origin: { y: 0.6 },\n          colors: ['#FFD700', '#00FFFF', '#FF00FF']\n        });\n      }\n    } catch (error) {\n      console.warn('Confetti animation failed:', error);\n    }\n\n    if (user) {\n      const testData = {\n        wpm: finalWpm,\n        accuracy: finalAccuracy,\n        mode,\n        characters: chars,\n        errors: finalErrors,\n        freestyle: freestyleMode,\n        language: language,\n      };\n      \n      saveResultMutation.mutate(testData);\n      \n      // Save keystroke analytics if tracking is enabled (skip for free type mode)\n      if (!freestyleMode && trackingEnabled && keystrokeTrackerRef.current) {\n        try {\n          const rawWpm = calculateWPM(chars, elapsedSeconds);\n          const analytics = keystrokeTrackerRef.current.computeAnalytics(\n            finalWpm,\n            rawWpm,\n            finalAccuracy,\n            finalErrors,\n            null\n          );\n          \n          // Save analytics to backend\n          fetch('/api/analytics/save', {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            credentials: 'include',\n            body: JSON.stringify({\n              analytics,\n              keystrokeEvents: keystrokeTrackerRef.current.getEvents(),\n            }),\n          }).catch(err => console.error('Failed to save keystroke analytics:', err));\n        } catch (error) {\n          console.error('Error computing keystroke analytics:', error);\n        }\n      }\n    } else {\n      setShowAuthPrompt(true);\n    }\n  };\n\n  const processInput = (value: string) => {\n    if (isFinished) return;\n    if (!text) return;\n    \n    // Safety check - should not happen due to handleBeforeInput validation\n    if (value.length > text.length) {\n      if (inputRef.current) inputRef.current.value = userInput;\n      return;\n    }\n    \n    const previousLength = userInput.length;\n    const now = Date.now();\n    const isForwardTyping = value.length > previousLength;\n    const isBackspace = value.length < previousLength;\n    \n    // Track typing speed to disable smooth animation during fast typing\n    if (isForwardTyping) {\n      const timeSinceLastKeystroke = now - lastKeystrokeTimeRef.current;\n      lastKeystrokeTimeRef.current = now;\n      \n      if (timeSinceLastKeystroke < 80 && timeSinceLastKeystroke > 0) {\n        setIsTypingFast(true);\n      } else {\n        setIsTypingFast(false);\n      }\n      \n      // Play keyboard sound\n      import('@/lib/keyboard-sounds')\n        .then((module) => {\n          if (module.keyboardSound && typeof module.keyboardSound.play === 'function') {\n            module.keyboardSound.play();\n          }\n        })\n        .catch((error) => {\n          console.warn('Keyboard sound failed to load:', error);\n        });\n    }\n    \n    // Start timer on first keystroke\n    if (!isActive && value.length === 1) {\n      setIsActive(true);\n      setStartTime(now);\n      preWarmAudioContext();\n    }\n\n    // PRODUCTION-READY CHARACTER VALIDATION\n    // All strict rules enforced in handleBeforeInput\n    // This function just updates character states\n    \n    const newStates: CharState[] = [];\n    let newErrorCount = 0;\n    \n    // Process each position\n    for (let i = 0; i < text.length; i++) {\n      const expectedChar = text[i];\n      \n      if (i < value.length) {\n        // User has typed this position - validate it\n        const typedChar = value[i];\n        const isCorrect = typedChar === expectedChar;\n        \n        // Track new errors (only increment on first mistake at this position)\n        const previousState = charStates[i];\n        const wasIncorrect = previousState?.state === 'incorrect';\n        \n        if (!isCorrect && !wasIncorrect) {\n          newErrorCount++;\n        }\n        \n        newStates[i] = {\n          expected: expectedChar,\n          typed: typedChar,\n          state: isCorrect ? 'correct' : 'incorrect'\n        };\n      } else {\n        // User hasn't typed this position yet\n        // CRITICAL: Preserve incorrect state for Monkeytype-style error persistence\n        // This ensures red characters stay red even after backspace\n        const previousState = charStates[i];\n        if (previousState?.state === 'incorrect') {\n          // Keep the incorrect state with the wrong character visible\n          newStates[i] = previousState;\n        } else {\n          // Position not yet typed and no previous error\n          newStates[i] = {\n            expected: expectedChar,\n            typed: '',\n            state: 'pending'\n          };\n        }\n      }\n    }\n    \n    // Single atomic state update - prevents race conditions\n    setCharStates(newStates);\n    if (newErrorCount > 0) {\n      setErrors(prev => prev + newErrorCount);\n    }\n    setCursorIndex(value.length);\n    setUserInput(value);\n\n    // Extend text if approaching end\n    if (value.length >= text.length - 100 && timeLeft > 5) {\n      const nextParagraph = getNextFromQueue();\n      if (nextParagraph) {\n        setText(prevText => {\n          const newText = prevText + \" \" + nextParagraph;\n          if (keystrokeTrackerRef.current) {\n            keystrokeTrackerRef.current.expectedText = newText;\n          }\n          return newText;\n        });\n      } else if (originalText) {\n        setText(prevText => {\n          const newText = prevText + \" \" + originalText;\n          if (keystrokeTrackerRef.current) {\n            keystrokeTrackerRef.current.expectedText = newText;\n          }\n          return newText;\n        });\n      }\n    }\n  };\n\n  // PRODUCTION-READY INPUT VALIDATION - Block invalid inputs BEFORE they happen\n  const handleBeforeInput = (e: React.FormEvent<HTMLInputElement>) => {\n    const nativeEvent = e.nativeEvent as InputEvent;\n    \n    // Capture selection for anti-cheat detection\n    if (inputRef.current) {\n      selectionRangeRef.current = {\n        start: inputRef.current.selectionStart ?? 0,\n        end: inputRef.current.selectionEnd ?? 0\n      };\n    }\n    \n    // Block any selection-based manipulation\n    const { start: selectionStart, end: selectionEnd } = selectionRangeRef.current;\n    if (selectionStart !== selectionEnd) {\n      e.preventDefault();\n      toast({\n        title: \"Selection Disabled\",\n        description: \"Please type character-by-character for accurate results\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    if (!text || isFinished) return;\n    \n    const currentPosition = userInput.length;\n    const inputData = nativeEvent.data;\n    \n    // Handle deletion (backspace)\n    if (nativeEvent.inputType === 'deleteContentBackward') {\n      // STRICT RULE: Block backspace at position 0\n      if (currentPosition === 0) {\n        e.preventDefault();\n        toast({\n          title: \"Cannot Backspace\",\n          description: \"Already at the beginning\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      // Allow backspace otherwise\n      return;\n    }\n    \n    // Handle character input\n    if (inputData && inputData.length > 0) {\n      const typedChar = inputData[0];\n      const expectedChar = text[currentPosition];\n      \n      if (!expectedChar) {\n        // Already at end of text\n        e.preventDefault();\n        return;\n      }\n      \n      // STRICT RULE: Check if there are any uncorrected errors before this position\n      const hasUncorrectedErrors = charStates.slice(0, currentPosition).some(\n        state => state?.state === 'incorrect'\n      );\n      \n      if (hasUncorrectedErrors) {\n        // STOP-ON-ERROR: Must backspace to fix errors before continuing\n        e.preventDefault();\n        toast({\n          title: \"Fix Errors First\",\n          description: \"Backspace to correct mistakes before continuing\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      \n      // STRICT RULE: If expected character is space, must type space\n      if (expectedChar === ' ' && typedChar !== ' ') {\n        e.preventDefault();\n        toast({\n          title: \"Space Required\",\n          description: \"You must type a space here\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n      \n      // STRICT RULE: If expected is NOT space, cannot type space\n      if (expectedChar !== ' ' && typedChar === ' ') {\n        e.preventDefault();\n        toast({\n          title: \"No Space Allowed\",\n          description: `Expected character: \"${expectedChar}\"`,\n          variant: \"destructive\",\n        });\n        return;\n      }\n      \n      // Character input is valid - will be processed in onChange\n    }\n  };\n\n  const handleInput = (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (isComposing) return;\n    processInput(e.target.value);\n    \n    // CRITICAL: Lock cursor at end of input to prevent jumping\n    // Force cursor to always be at the end of userInput\n    if (inputRef.current) {\n      const cursorPos = e.target.value.length;\n      inputRef.current.setSelectionRange(cursorPos, cursorPos);\n    }\n  };\n\n  const handleCompositionStart = () => {\n    setIsComposing(true);\n  };\n\n  const handleCompositionEnd = (e: React.CompositionEvent<HTMLInputElement>) => {\n    setIsComposing(false);\n    if (e.data && inputRef.current) {\n      const newValue = userInput + e.data;\n      inputRef.current.value = newValue;\n      setTimeout(() => {\n        processInput(newValue);\n        // Lock cursor at end after composition\n        if (inputRef.current) {\n          const cursorPos = newValue.length;\n          inputRef.current.setSelectionRange(cursorPos, cursorPos);\n        }\n      }, 0);\n    }\n  };\n  \n  // Handle keyboard events with strict validation\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {\n    // Block Ctrl+A (select all) - anti-cheat measure\n    if ((e.ctrlKey || e.metaKey) && e.key === 'a') {\n      e.preventDefault();\n      return;\n    }\n    \n    // Block other keyboard shortcuts for copying\n    if ((e.ctrlKey || e.metaKey) && ['c', 'x', 'v'].includes(e.key.toLowerCase())) {\n      e.preventDefault();\n      return;\n    }\n    \n    // STRICT VALIDATION: Block arrow keys (prevent cursor manipulation)\n    if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {\n      e.preventDefault();\n      return;\n    }\n    \n    // STRICT VALIDATION: Block Home, End, PageUp, PageDown (prevent jumping)\n    if (['Home', 'End', 'PageUp', 'PageDown'].includes(e.key)) {\n      e.preventDefault();\n      return;\n    }\n    \n    // STRICT VALIDATION: Block Delete key (forward delete not allowed)\n    if (e.key === 'Delete') {\n      e.preventDefault();\n      return;\n    }\n    \n    // Keyboard shortcuts for test control handled by global listener\n    // (Tab/Escape handled in useEffect below - don't block them here)\n    \n    // Allow Shift+Enter to finish early\n    if (e.key === 'Enter' && e.shiftKey) {\n      e.preventDefault();\n      if (isActive && !isFinished) {\n        finishTest();\n      }\n      return;\n    }\n    \n    // Capture selection before any key press (for anti-cheat detection)\n    if (inputRef.current) {\n      selectionRangeRef.current = {\n        start: inputRef.current.selectionStart ?? 0,\n        end: inputRef.current.selectionEnd ?? 0\n      };\n    }\n  };\n\n  const handlePaste = (e: React.ClipboardEvent<HTMLInputElement>) => {\n    e.preventDefault();\n    toast({\n      title: \"Paste Disabled\",\n      description: \"Please type manually for accurate results\",\n      variant: \"default\",\n    });\n  };\n\n  const handleCut = (e: React.ClipboardEvent<HTMLInputElement>) => {\n    e.preventDefault();\n  };\n\n  // Load typing behavior settings on mount\n  useEffect(() => {\n    const smoothCaretSetting = localStorage.getItem('smoothCaret');\n    const caretSpeedSetting = localStorage.getItem('caretSpeed');\n    const quickRestartSetting = localStorage.getItem('quickRestart');\n    const zenModeSetting = localStorage.getItem('zenMode');\n    \n    if (smoothCaretSetting !== null) {\n      setSmoothCaret(smoothCaretSetting === 'true');\n    }\n    if (caretSpeedSetting !== null && ['off', 'fast', 'medium', 'smooth'].includes(caretSpeedSetting)) {\n      setCaretSpeed(caretSpeedSetting as 'off' | 'fast' | 'medium' | 'smooth');\n    }\n    if (quickRestartSetting !== null) {\n      setQuickRestart(quickRestartSetting === 'true');\n    }\n    if (zenModeSetting !== null) {\n      setZenMode(zenModeSetting === 'true');\n    }\n  }, []);\n\n  // Track if cursor update is from keystroke (for auto-scroll gating)\n  const lastCursorIndexRef = useRef(0);\n  \n  // Update cursor position based on typing progress and layout changes\n  const updateCursorPosition = useCallback((fromKeystroke = false) => {\n    // Use requestAnimationFrame to ensure DOM has updated before measuring\n    requestAnimationFrame(() => {\n      const container = containerRef.current;\n      if (!container) return;\n      \n      // Find the character element at current position using refs\n      const targetIndex = userInput.length;\n      const charElement = charRefs.current[targetIndex];\n      \n      if (charElement) {\n        const charRect = charElement.getBoundingClientRect();\n        const containerRect = container.getBoundingClientRect();\n        const scrollTop = container.scrollTop;\n        \n        // Calculate position in CONTENT COORDINATES (includes scrollTop)\n        // This makes cursor position absolute within content, not viewport\n        const relativeLeft = charRect.left - containerRect.left;\n        const relativeTop = charRect.top - containerRect.top + scrollTop;\n        const height = charRect.height || 40;\n        \n        // Only update if position actually changed (prevents unnecessary re-renders)\n        setCursorPosition(prev => {\n          if (prev.left === relativeLeft && prev.top === relativeTop && prev.height === height) {\n            return prev;\n          }\n          return { left: relativeLeft, top: relativeTop, height };\n        });\n        \n        // Auto-scroll: ONLY on keystroke-driven changes, NOT during manual scroll or resize\n        // This prevents cursor from jumping during user-initiated scrolling\n        if (fromKeystroke && !isUserScrollingRef.current) {\n          const cursorTopRelative = charRect.top - containerRect.top;\n          const containerHeight = container.clientHeight;\n          const idealCursorPosition = containerHeight * 0.3; // Keep cursor at 30% from top\n          \n          // If cursor is below the ideal position, scroll to bring it up\n          if (cursorTopRelative > idealCursorPosition) {\n            const scrollAmount = cursorTopRelative - idealCursorPosition;\n            container.scrollTop = scrollTop + scrollAmount;\n          }\n          // If cursor is above view (e.g., using backspace), scroll up\n          else if (cursorTopRelative < 0) {\n            container.scrollTop = scrollTop + cursorTopRelative - 20; // Small padding at top\n          }\n        }\n      } else {\n        // Fallback: position at start (first character using ref)\n        const firstChar = charRefs.current[0];\n        if (firstChar) {\n          const containerRect = container.getBoundingClientRect();\n          const charRect = firstChar.getBoundingClientRect();\n          const scrollTop = container.scrollTop;\n          const relativeLeft = charRect.left - containerRect.left;\n          const relativeTop = charRect.top - containerRect.top + scrollTop;\n          const height = charRect.height || 40;\n          setCursorPosition(prev => {\n            if (prev.left === relativeLeft && prev.top === relativeTop && prev.height === height) return prev;\n            return { left: relativeLeft, top: relativeTop, height };\n          });\n        } else {\n          // No characters rendered yet - use container origin\n          setCursorPosition(prev => {\n            if (prev.left === 0 && prev.top === 0 && prev.height === 40) return prev;\n            return { left: 0, top: 0, height: 40 };\n          });\n        }\n        // Reset scroll to top when starting fresh\n        container.scrollTop = 0;\n      }\n    });\n  }, [userInput.length, text]);\n\n  // Only update cursor position on keystroke changes (not on every layout change)\n  useEffect(() => {\n    const cursorIndex = userInput.length;\n    const wasKeystroke = cursorIndex !== lastCursorIndexRef.current;\n    lastCursorIndexRef.current = cursorIndex;\n    \n    // Pass fromKeystroke=true only when cursor actually moved from typing\n    updateCursorPosition(wasKeystroke);\n  }, [userInput.length, updateCursorPosition]);\n\n  // Recalculate cursor position on resize/layout changes (but don't auto-scroll)\n  useEffect(() => {\n    if (!containerRef.current) return;\n\n    const resizeObserver = new ResizeObserver(() => {\n      updateCursorPosition(false); // false = not from keystroke, don't auto-scroll\n    });\n\n    resizeObserver.observe(containerRef.current);\n    return () => resizeObserver.disconnect();\n  }, [updateCursorPosition]);\n\n  // Initialize keystroke tracker when test is ready (before first keystroke)\n  useEffect(() => {\n    if (text && trackingEnabled && !isActive) {\n      // Create fresh tracker when text loads for new test (not during active test/extension)\n      keystrokeTrackerRef.current = new KeystrokeTracker(text);\n    }\n  }, [text, trackingEnabled, isActive]);\n\n  // Keystroke tracking event handlers\n  useEffect(() => {\n    if (!trackingEnabled || !keystrokeTrackerRef.current || !inputRef.current) return;\n\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Skip special keys except space and backspace\n      if (e.key.length > 1 && e.key !== 'Backspace' && e.key !== ' ') return;\n      \n      const timestamp = Date.now();\n      const key = e.key === ' ' ? ' ' : e.key;\n      keystrokeTrackerRef.current?.onKeyDown(key, e.code, timestamp);\n    };\n\n    const handleKeyUp = (e: KeyboardEvent) => {\n      if (!keystrokeTrackerRef.current || !inputRef.current) return;\n      \n      // Skip special keys except space and backspace\n      if (e.key.length > 1 && e.key !== 'Backspace' && e.key !== ' ') return;\n      \n      const timestamp = Date.now();\n      const key = e.key === ' ' ? ' ' : e.key;\n      \n      // For backspace, decrement position and mark as deletion\n      if (e.key === 'Backspace') {\n        keystrokeTrackerRef.current.currentPosition = Math.max(0, keystrokeTrackerRef.current.currentPosition - 1);\n        keystrokeTrackerRef.current.onKeyUp(key, e.code, timestamp, true);\n        return;\n      }\n      \n      // Get the current tracker position (what we're about to type)\n      const currentPos = keystrokeTrackerRef.current.currentPosition;\n      const expectedKey = text[currentPos] || null;\n      const isCorrect = key === expectedKey;\n      \n      keystrokeTrackerRef.current.onKeyUp(key, e.code, timestamp, isCorrect);\n      \n      // Always increment position after tracking the keystroke\n      keystrokeTrackerRef.current.currentPosition++;\n    };\n\n    document.addEventListener('keydown', handleKeyDown);\n    document.addEventListener('keyup', handleKeyUp);\n    \n    return () => {\n      document.removeEventListener('keydown', handleKeyDown);\n      document.removeEventListener('keyup', handleKeyUp);\n    };\n  }, [trackingEnabled, text]);\n\n  // Keyboard shortcuts for typing test (Code Mode-style)\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      const activeElement = document.activeElement;\n      const isTypingInputFocused = activeElement === inputRef.current;\n      \n      // Tab key - restart test (only when quick restart enabled and input focused)\n      if (e.key === 'Tab' && !e.shiftKey && !e.ctrlKey && !e.altKey && !e.metaKey && quickRestart) {\n        if (isTypingInputFocused) {\n          e.preventDefault();\n          resetTest();\n        }\n      }\n      \n      // Escape key - reset/restart test anytime\n      if (e.key === 'Escape') {\n        e.preventDefault();\n        resetTest();\n      }\n      \n      // Shift+Enter - finish test early (like Monkeytype and Code Mode)\n      if (e.shiftKey && e.key === 'Enter') {\n        e.preventDefault();\n        if (isActive && userInput.length > 0 && !isFinished) {\n          finishTest(false); // false = manual finish\n          toast({\n            title: \"Test Finished\",\n            description: \"You ended the test early with Shift+Enter.\",\n          });\n        }\n      }\n    };\n\n    document.addEventListener('keydown', handleKeyDown);\n    return () => document.removeEventListener('keydown', handleKeyDown);\n  }, [quickRestart, resetTest, isActive, userInput.length, isFinished, finishTest, toast]);\n\n  // Focus handling - only focus when clicking on the typing area\n  useEffect(() => {\n    const handleClick = (e: MouseEvent) => {\n      const target = e.target as HTMLElement;\n      // Don't focus if clicking on interactive elements\n      if (target.tagName === 'SELECT' || target.tagName === 'OPTION' || target.tagName === 'BUTTON' || target.tagName === 'INPUT') {\n        return;\n      }\n      // Don't focus if clicking inside interactive elements\n      if (target.closest('select') || target.closest('button') || target.closest('input')) {\n        return;\n      }\n      inputRef.current?.focus({ preventScroll: true });\n    };\n    document.addEventListener(\"click\", handleClick);\n    return () => document.removeEventListener(\"click\", handleClick);\n  }, []);\n\n  const getCharClass = (index: number) => {\n    if (index >= userInput.length) return \"text-muted-foreground/40\";\n    const isCorrect = userInput[index] === text[index];\n    return isCorrect ? \"text-green-500\" : \"text-destructive\";\n  };\n\n  // Memoize the characters array to avoid recreating on every render\n  const characters = useMemo(() => {\n    // Ensure charRefs array length matches text length to prevent stale refs\n    charRefs.current.length = text.length;\n    return text.split(\"\");\n  }, [text]);\n  \n  const availableLanguages = languagesData?.languages || [\"en\"];\n  const availableModes = modesData?.modes || [\"general\"];\n\n  // RTL languages that need right-to-left direction\n  const rtlLanguages = [\"ar\", \"he\"];\n  const isRTL = rtlLanguages.includes(language);\n\n  // Format time display (e.g., 60s â†’ 1:00, 90s â†’ 1:30)\n  const formatTime = (seconds: number): string => {\n    if (seconds < 60) {\n      return `${seconds}s`;\n    }\n    const hours = Math.floor(seconds / 3600);\n    const mins = Math.floor((seconds % 3600) / 60);\n    const secs = seconds % 60;\n    if (hours > 0) {\n      return `${hours}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;\n    }\n    return `${mins}:${secs.toString().padStart(2, '0')}`;\n  };\n\n  return (\n    <TooltipProvider delayDuration={300}>\n      <div className=\"w-full max-w-5xl mx-auto flex flex-col gap-4 md:gap-8 px-2 sm:px-0\">\n        {/* API Error Banner - only show when there's an error and not currently fetching */}\n        {((languagesError && !languagesFetching) || (modesError && !modesFetching)) && (\n          <div className=\"flex items-center justify-center gap-2 p-2 bg-destructive/10 border border-destructive/20 rounded-lg text-sm text-destructive\">\n            <AlertCircle className=\"w-4 h-4\" />\n            <span>Some options may be limited. </span>\n            <button \n              onClick={() => {\n                if (languagesError && !languagesFetching) refetchLanguages();\n                if (modesError && !modesFetching) refetchModes();\n              }}\n              className=\"underline hover:no-underline\"\n              disabled={languagesFetching || modesFetching}\n            >\n              {languagesFetching || modesFetching ? 'Retrying...' : 'Retry'}\n            </button>\n          </div>\n        )}\n\n        {/* Language & Mode Selectors */}\n        <div className=\"flex flex-col gap-3 md:gap-4 transition-opacity duration-300\">\n          <div className=\"flex items-center justify-center gap-2 md:gap-4 flex-wrap\">\n            <div className=\"flex items-center gap-1.5\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"relative\">\n                    <SearchableSelect\n                      value={language}\n                      onValueChange={setLanguage}\n                      options={availableLanguages.map((lang: string) => ({\n                        value: lang,\n                        label: LANGUAGE_NAMES[lang] || lang,\n                      }))}\n                      placeholder=\"Select language\"\n                      searchPlaceholder=\"Search languages...\"\n                      emptyText=\"No language found.\"\n                      icon={<Globe className=\"w-4 h-4\" />}\n                    />\n                    {languagesError && !languagesFetching && !languagesData && (\n                      <div className=\"absolute -top-1 -right-1 w-2 h-2 rounded-full bg-destructive\" title=\"Failed to load languages\" />\n                    )}\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs bg-popover text-popover-foreground border shadow-lg p-3\">\n                  <p className=\"font-medium mb-1\">Language Selection</p>\n                  <p className=\"text-xs opacity-80\">Practice typing in your preferred language. Supports 23+ languages including English, Spanish, Hindi, Japanese, Arabic, and more. Great for learning new languages!</p>\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button type=\"button\" className=\"text-muted-foreground/60 hover:text-muted-foreground transition-colors\" aria-label=\"Language help\">\n                    <HelpCircle className=\"w-3.5 h-3.5\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\" className=\"max-w-[280px]\">\n                  <p className=\"font-medium mb-1\">Typing Language</p>\n                  <p className=\"text-xs text-muted-foreground\">Select from 23+ languages with native script support. Perfect for practicing multilingual typing or learning new languages through muscle memory!</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n\n            <div className=\"flex items-center gap-1.5\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"relative\">\n                    <SearchableSelect\n                      value={paragraphMode}\n                      onValueChange={setParagraphMode}\n                      options={availableModes.map((m: string) => ({\n                        value: m,\n                        label: MODE_NAMES[m] || m,\n                      }))}\n                      placeholder=\"Select mode\"\n                      searchPlaceholder=\"Search modes...\"\n                      emptyText=\"No mode found.\"\n                      icon={<BookOpen className=\"w-4 h-4\" />}\n                    />\n                    {modesError && !modesFetching && !modesData && (\n                      <div className=\"absolute -top-1 -right-1 w-2 h-2 rounded-full bg-destructive\" title=\"Failed to load modes\" />\n                    )}\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs bg-popover text-popover-foreground border shadow-lg p-3\">\n                  <p className=\"font-medium mb-1\">Paragraph Topic</p>\n                  <p className=\"text-xs opacity-80\">Choose what you want to type about. General for everyday text, Programming for code terms, Business for professional vocabulary, News for current events style, and more!</p>\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button type=\"button\" className=\"text-muted-foreground/60 hover:text-muted-foreground transition-colors\" aria-label=\"Topic help\">\n                    <HelpCircle className=\"w-3.5 h-3.5\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\" className=\"max-w-[280px]\">\n                  <p className=\"font-medium mb-1\">Content Topic</p>\n                  <div className=\"text-xs text-muted-foreground space-y-1\">\n                    <p><span className=\"text-blue-400\">General:</span> Everyday topics and common text</p>\n                    <p><span className=\"text-green-400\">Programming:</span> Code-related terminology</p>\n                    <p><span className=\"text-purple-400\">Business:</span> Professional vocabulary</p>\n                    <p><span className=\"text-orange-400\">News:</span> Current events style</p>\n                  </div>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n\n            <div className=\"flex items-center gap-1.5\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div>\n                    <SearchableSelect\n                      value={difficulty}\n                      onValueChange={(val) => setDifficulty(val as \"easy\" | \"medium\" | \"hard\")}\n                      options={[\n                        { value: \"easy\", label: \"Easy\" },\n                        { value: \"medium\", label: \"Medium\" },\n                        { value: \"hard\", label: \"Hard\" },\n                      ]}\n                      placeholder=\"Select difficulty\"\n                      searchPlaceholder=\"Search difficulty...\"\n                      emptyText=\"No difficulty found.\"\n                      icon={<Target className=\"w-4 h-4\" />}\n                    />\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-xs bg-popover text-popover-foreground border shadow-lg p-3\">\n                  <p className=\"font-medium mb-2\">Difficulty Level</p>\n                  <p className=\"text-xs opacity-90 mb-1\"><span className=\"text-green-400 font-semibold\">Easy:</span> Short sentences, common words - perfect for beginners</p>\n                  <p className=\"text-xs opacity-90 mb-1\"><span className=\"text-yellow-400 font-semibold\">Medium:</span> Standard paragraphs with varied vocabulary</p>\n                  <p className=\"text-xs opacity-90\"><span className=\"text-orange-400 font-semibold\">Hard:</span> Complex sentences, advanced vocabulary, punctuation</p>\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button type=\"button\" className=\"text-muted-foreground/60 hover:text-muted-foreground transition-colors\" aria-label=\"Difficulty help\">\n                    <HelpCircle className=\"w-3.5 h-3.5\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\" className=\"max-w-[280px]\">\n                  <p className=\"font-medium mb-1\">Text Complexity</p>\n                  <p className=\"text-xs text-muted-foreground\">Controls word length, sentence complexity, and punctuation frequency. Start with Easy and gradually increase as your speed improves!</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </div>\n\n        {/* Time Mode Selector */}\n        <div className=\"flex flex-col gap-2 md:gap-3\">\n          <div className=\"flex justify-center items-center gap-1.5 md:gap-2 flex-wrap\">\n            <div className=\"flex items-center gap-1 md:gap-1.5 mr-0.5 md:mr-1\">\n              <Timer className=\"w-3.5 h-3.5 md:w-4 md:h-4 text-muted-foreground\" />\n              <span className=\"text-[10px] md:text-xs text-muted-foreground font-medium\">Duration:</span>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button type=\"button\" className=\"text-muted-foreground/60 hover:text-muted-foreground transition-colors\" aria-label=\"Duration help\">\n                    <HelpCircle className=\"w-3.5 h-3.5\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\" className=\"max-w-[280px]\">\n                  <p className=\"font-medium mb-1\">Test Duration</p>\n                  <p className=\"text-xs text-muted-foreground mb-2\">Choose how long you want to type. Shorter tests (15-30s) measure burst speed, while longer tests (1-5 min) measure sustained speed and endurance.</p>\n                  <p className=\"text-xs text-muted-foreground\"><span className=\"text-blue-400\">Tip:</span> Use Custom for marathon sessions up to 4 hours!</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n            {TIME_PRESETS.map((preset) => (\n              <Tooltip key={preset.value}>\n                <TooltipTrigger asChild>\n                  <button\n                    onClick={() => {\n                      setMode(preset.value);\n                      setShowCustomInput(false);\n                    }}\n                    className={cn(\n                      \"px-2.5 py-1.5 md:px-4 md:py-2 rounded-full text-xs md:text-sm font-medium transition-all\",\n                      mode === preset.value && !showCustomInput\n                        ? \"bg-primary text-primary-foreground\" \n                        : \"bg-secondary text-muted-foreground hover:text-foreground\"\n                    )}\n                    data-testid={`button-time-${preset.value}`}\n                  >\n                    {preset.label}\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Test your typing speed for {preset.label}</p>\n                </TooltipContent>\n              </Tooltip>\n            ))}\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <button\n                  onClick={() => setShowCustomInput(!showCustomInput)}\n                  className={cn(\n                    \"px-2.5 py-1.5 md:px-4 md:py-2 rounded-full text-xs md:text-sm font-medium transition-all\",\n                    showCustomInput\n                      ? \"bg-primary text-primary-foreground\" \n                      : \"bg-secondary text-muted-foreground hover:text-foreground\"\n                  )}\n                  data-testid=\"button-custom-time\"\n                >\n                  Custom\n                </button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Set your own test duration (up to 4 hours)</p>\n              </TooltipContent>\n            </Tooltip>\n            \n            <Tooltip>\n              <TooltipTrigger asChild>\n                <button\n                  onClick={() => resetTest(true)}\n                  disabled={isGenerating || freestyleMode}\n                  className={cn(\n                    \"px-2.5 py-1.5 md:px-4 md:py-2 rounded-full text-xs md:text-sm font-medium transition-all flex items-center gap-1.5 md:gap-2\",\n                    isGenerating\n                      ? \"bg-primary/50 text-primary-foreground cursor-not-allowed\"\n                      : freestyleMode\n                        ? \"bg-secondary/50 text-muted-foreground/50 cursor-not-allowed\"\n                        : \"bg-secondary text-muted-foreground hover:text-foreground\"\n                  )}\n                  data-testid=\"button-new-paragraph\"\n                >\n                  <RefreshCw className={cn(\"w-3.5 h-3.5 md:w-4 md:h-4\", isGenerating && \"animate-spin\")} />\n                  <span className=\"hidden sm:inline\">{isGenerating ? \"Generating...\" : \"New Paragraph\"}</span>\n                  <span className=\"sm:hidden\">{isGenerating ? \"...\" : \"New\"}</span>\n                </button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>{freestyleMode ? \"Disabled in Freestyle mode\" : isGenerating ? \"AI is generating fresh content...\" : \"Get a fresh paragraph without changing settings\"}</p>\n              </TooltipContent>\n            </Tooltip>\n            \n            <Tooltip>\n              <TooltipTrigger asChild>\n                <button\n                  onClick={() => {\n                    const newValue = !freestyleMode;\n                    setFreestyleMode(newValue);\n                    setFreestyleText(\"\");\n                    setUserInput(\"\");\n                    setIsActive(false);\n                    setIsFinished(false);\n                    setTimeLeft(mode);\n                    setWpm(0);\n                    setRawWpm(0);\n                    setAccuracy(100);\n                    setErrors(0);\n                    setStartTime(null);\n                    toast({\n                      title: newValue ? \"Freestyle Mode\" : \"Standard Mode\",\n                      description: newValue \n                        ? \"Type anything you want! WPM will be tracked.\" \n                        : \"Switched back to standard typing test.\",\n                    });\n                  }}\n                  className={cn(\n                    \"px-2.5 py-1.5 md:px-4 md:py-2 rounded-full text-xs md:text-sm font-medium transition-all flex items-center gap-1.5 md:gap-2\",\n                    freestyleMode\n                      ? \"bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-lg shadow-purple-500/25\" \n                      : \"bg-secondary text-muted-foreground hover:text-foreground\"\n                  )}\n                  data-testid=\"button-freestyle\"\n                >\n                  <PenLine className=\"w-3.5 h-3.5 md:w-4 md:h-4\" />\n                  <span className=\"hidden sm:inline\">Freestyle</span>\n                  <span className=\"sm:hidden\">Free</span>\n                </button>\n              </TooltipTrigger>\n              <TooltipContent className=\"max-w-[280px]\">\n                <p className=\"font-medium mb-1\">{freestyleMode ? \"Exit Freestyle Mode\" : \"Freestyle Mode\"}</p>\n                <p className=\"text-xs text-muted-foreground mb-2\">\n                  {freestyleMode \n                    ? \"Return to standard typing test with AI-generated paragraphs\" \n                    : \"Type anything you want without a pre-defined paragraph. Perfect for practice notes, creative writing, or just flowing thoughts.\"\n                  }\n                </p>\n                <div className=\"text-xs text-muted-foreground space-y-1\">\n                  {!freestyleMode && (\n                    <>\n                      <p><span className=\"text-purple-400\">Timer:</span> Uses your selected duration</p>\n                      <p><span className=\"text-pink-400\">WPM:</span> Tracked in real-time</p>\n                      <p><span className=\"text-green-400\">Accuracy:</span> Always 100% (no reference text)</p>\n                    </>\n                  )}\n                </div>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n          \n          {showCustomInput && (\n            <div className=\"flex flex-col items-center gap-3\">\n              {/* Quick Duration Presets */}\n              <div className=\"flex flex-wrap items-center justify-center gap-2\">\n                <span className=\"text-xs text-muted-foreground mr-1\">Quick:</span>\n                {[\n                  { value: 300, label: \"5 min\" },\n                  { value: 600, label: \"10 min\" },\n                  { value: 900, label: \"15 min\" },\n                  { value: 1800, label: \"30 min\" },\n                  { value: 3600, label: \"1 hr\" },\n                  { value: 7200, label: \"2 hr\" },\n                  { value: 10800, label: \"3 hr\" },\n                  { value: 14400, label: \"4 hr\" },\n                ].map((preset) => (\n                  <button\n                    key={preset.value}\n                    onClick={() => {\n                      setMode(preset.value);\n                      setCustomTime(preset.value.toString());\n                      setShowCustomInput(false);\n                      toast({\n                        title: \"Duration set\",\n                        description: `Test duration: ${preset.label}`,\n                      });\n                    }}\n                    className={cn(\n                      \"px-3 py-1.5 rounded-full text-xs font-medium transition-all\",\n                      mode === preset.value\n                        ? \"bg-primary text-primary-foreground\"\n                        : \"bg-secondary/80 text-muted-foreground hover:text-foreground hover:bg-secondary\"\n                    )}\n                    data-testid={`button-preset-${preset.value}`}\n                  >\n                    {preset.label}\n                  </button>\n                ))}\n              </div>\n              \n              {/* Custom Input */}\n              <div className=\"flex items-center gap-2\">\n                <input\n                  type=\"number\"\n                  min=\"5\"\n                  max=\"14400\"\n                  value={customTime}\n                  onChange={(e) => setCustomTime(e.target.value)}\n                  placeholder=\"Seconds (5-14400)\"\n                  className=\"px-3 py-2 rounded-lg bg-secondary border border-border text-sm w-36 focus:outline-none focus:ring-2 focus:ring-primary\"\n                  data-testid=\"input-custom-time\"\n                />\n                <span className=\"text-xs text-muted-foreground\">\n                  {customTime && parseInt(customTime) > 0 ? (\n                    (() => {\n                      const t = parseInt(customTime);\n                      const h = Math.floor(t / 3600);\n                      const m = Math.floor((t % 3600) / 60);\n                      const s = t % 60;\n                      if (h > 0) return `= ${h}h ${m}m ${s}s`;\n                      if (m > 0) return `= ${m}m ${s}s`;\n                      return `= ${s}s`;\n                    })()\n                  ) : \"\"}\n                </span>\n                <button\n                  onClick={() => {\n                    const time = parseInt(customTime);\n                    if (time >= 5 && time <= 14400) {\n                      setMode(time);\n                      setShowCustomInput(false);\n                      const hours = Math.floor(time / 3600);\n                      const mins = Math.floor((time % 3600) / 60);\n                      const secs = time % 60;\n                      let formatted = '';\n                      if (hours > 0) {\n                        formatted = `${hours} hour${hours > 1 ? 's' : ''}`;\n                        if (mins > 0) formatted += ` ${mins} min`;\n                      } else if (mins > 0) {\n                        formatted = `${mins} min${mins > 1 ? 's' : ''}`;\n                        if (secs > 0) formatted += ` ${secs}s`;\n                      } else {\n                        formatted = `${secs} seconds`;\n                      }\n                      toast({\n                        title: \"Custom time set\",\n                        description: `Test duration: ${formatted}`,\n                      });\n                    } else {\n                      toast({\n                        title: \"Invalid time\",\n                        description: \"Please enter a value between 5 seconds and 4 hours\",\n                        variant: \"destructive\",\n                      });\n                    }\n                  }}\n                  className=\"px-4 py-2 rounded-lg bg-primary text-primary-foreground text-sm font-medium hover:bg-primary/90\"\n                  data-testid=\"button-set-custom-time\"\n                >\n                  Set\n                </button>\n              </div>\n              <p className=\"text-xs text-muted-foreground\">\n                Enter any duration from 5 seconds to 4 hours\n              </p>\n            </div>\n          )}\n          \n          {/* AI Custom Prompt */}\n          <div className=\"flex items-center justify-center gap-2\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <button\n                  onClick={() => setShowCustomPrompt(!showCustomPrompt)}\n                  className={cn(\n                    \"px-4 py-2 rounded-full text-sm font-medium transition-all flex items-center gap-2\",\n                    showCustomPrompt\n                      ? \"bg-primary text-primary-foreground\" \n                      : \"bg-secondary text-muted-foreground hover:text-foreground\"\n                  )}\n                  data-testid=\"button-toggle-custom-prompt\"\n                >\n                  <Sparkles className=\"w-4 h-4\" />\n                  AI Custom Content\n                </button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Tell AI what kind of paragraph you want (e.g., \"about space exploration\")</p>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n          \n          {showCustomPrompt && (\n            <div className=\"flex flex-col items-center justify-center gap-2 max-w-2xl mx-auto\">\n              <div className=\"flex items-center w-full gap-2\">\n                <input\n                  type=\"text\"\n                  value={customPrompt}\n                  onChange={(e) => setCustomPrompt(e.target.value)}\n                  placeholder=\"E.g., 'about artificial intelligence and future technology'\"\n                  disabled={isGenerating}\n                  className={cn(\n                    \"flex-1 px-4 py-2 rounded-lg text-foreground placeholder:text-muted-foreground border border-border focus:outline-none focus:ring-2 focus:ring-primary\",\n                    isGenerating ? \"bg-secondary/50 cursor-not-allowed\" : \"bg-secondary\"\n                  )}\n                  data-testid=\"input-custom-prompt\"\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' && customPrompt.trim() && !isGenerating) {\n                      fetchParagraph(true);\n                      setUserInput(\"\");\n                      setOriginalText(\"\");\n                      setStartTime(null);\n                      setIsActive(false);\n                      setIsFinished(false);\n                      setWpm(0);\n                      setRawWpm(0);\n                      setConsistency(100);\n                      setAccuracy(100);\n                      keystrokeTrackerRef.current = null;\n                      wpmHistoryRef.current = [];\n                    }\n                  }}\n                />\n                <button\n                  onClick={() => {\n                    if (customPrompt.trim()) {\n                      fetchParagraph(true);\n                      setUserInput(\"\");\n                      setOriginalText(\"\");\n                      setStartTime(null);\n                      setIsActive(false);\n                      setIsFinished(false);\n                      setWpm(0);\n                      setRawWpm(0);\n                      setConsistency(100);\n                      setAccuracy(100);\n                      keystrokeTrackerRef.current = null;\n                      wpmHistoryRef.current = [];\n                    } else {\n                      toast({\n                        title: \"Empty prompt\",\n                        description: \"Please describe what you want the paragraph to be about\",\n                        variant: \"destructive\",\n                      });\n                    }\n                  }}\n                  disabled={isGenerating || !customPrompt.trim()}\n                  className={cn(\n                    \"px-6 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-all\",\n                    isGenerating || !customPrompt.trim()\n                      ? \"bg-primary/50 text-primary-foreground cursor-not-allowed\"\n                      : \"bg-primary text-primary-foreground hover:bg-primary/90\"\n                  )}\n                  data-testid=\"button-generate-custom\"\n                >\n                  <Sparkles className={cn(\"w-4 h-4\", isGenerating && \"animate-spin\")} />\n                  {isGenerating ? \"Generating...\" : \"Generate\"}\n                </button>\n              </div>\n              <p className=\"text-xs text-muted-foreground text-center\">\n                Describe the topic or theme for your typing test paragraph\n              </p>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Stats Overview (Live) - 6 metrics like Monkeytype (or 8 for Freestyle) */}\n      <div className={cn(\n        \"grid gap-2 md:gap-3 transition-opacity duration-300\",\n        freestyleMode ? \"grid-cols-4 md:grid-cols-8\" : \"grid-cols-3 md:grid-cols-6\"\n      )}>\n         <Tooltip>\n           <TooltipTrigger asChild>\n             <div className=\"flex flex-col items-center p-2 md:p-3 rounded-lg md:rounded-xl bg-card border border-border cursor-help\">\n               <span className=\"text-muted-foreground text-[9px] md:text-[10px] uppercase tracking-wider mb-0.5 md:mb-1\">Time</span>\n               <span className=\"text-xl md:text-3xl font-mono font-bold text-primary\" data-testid=\"text-time-left\">{formatTime(timeLeft)}</span>\n             </div>\n           </TooltipTrigger>\n           <TooltipContent className=\"max-w-[220px]\">\n             <p className=\"font-medium mb-1\">Time Remaining</p>\n             <p className=\"text-xs text-muted-foreground\">Countdown timer showing how much time is left in your test. Timer starts when you begin typing.</p>\n           </TooltipContent>\n         </Tooltip>\n         <Tooltip>\n           <TooltipTrigger asChild>\n             <div className=\"flex flex-col items-center p-2 md:p-3 rounded-lg md:rounded-xl bg-card border border-border cursor-help\">\n               <span className=\"text-muted-foreground text-[9px] md:text-[10px] uppercase tracking-wider mb-0.5 md:mb-1\">WPM</span>\n               <span className=\"text-xl md:text-3xl font-mono font-bold\" data-testid=\"text-wpm\">{wpm}</span>\n             </div>\n           </TooltipTrigger>\n           <TooltipContent className=\"max-w-[260px]\">\n             <p className=\"font-medium mb-1\">Words Per Minute (Net)</p>\n             <p className=\"text-xs text-muted-foreground mb-1\">Your effective typing speed accounting for errors. This is the standard WPM used in typing tests.</p>\n             <p className=\"text-xs text-muted-foreground\"><span className=\"text-green-400\">40+ WPM:</span> Good | <span className=\"text-blue-400\">60+ WPM:</span> Fast | <span className=\"text-purple-400\">80+ WPM:</span> Expert</p>\n           </TooltipContent>\n         </Tooltip>\n         <Tooltip>\n           <TooltipTrigger asChild>\n             <div className=\"flex flex-col items-center p-2 md:p-3 rounded-lg md:rounded-xl bg-card border border-border cursor-help\">\n               <span className=\"text-muted-foreground text-[9px] md:text-[10px] uppercase tracking-wider mb-0.5 md:mb-1\">Raw</span>\n               <span className=\"text-xl md:text-3xl font-mono font-bold text-muted-foreground\" data-testid=\"text-raw-wpm\">{rawWpm}</span>\n             </div>\n           </TooltipTrigger>\n           <TooltipContent className=\"max-w-[260px]\">\n             <p className=\"font-medium mb-1\">Raw Speed (Uncorrected)</p>\n             <p className=\"text-xs text-muted-foreground\">Your total typing speed including errors. Compare Raw with WPM to see how much mistakes affect your final score.</p>\n           </TooltipContent>\n         </Tooltip>\n         {/* Hide Accuracy in Freestyle mode - no reference text to compare */}\n         {!freestyleMode && (\n           <Tooltip>\n             <TooltipTrigger asChild>\n               <div className=\"flex flex-col items-center p-2 md:p-3 rounded-lg md:rounded-xl bg-card border border-border cursor-help\">\n                 <span className=\"text-muted-foreground text-[9px] md:text-[10px] uppercase tracking-wider mb-0.5 md:mb-1\">Accuracy</span>\n                 <span className=\"text-xl md:text-3xl font-mono font-bold\" data-testid=\"text-accuracy\">{accuracy}%</span>\n               </div>\n             </TooltipTrigger>\n             <TooltipContent className=\"max-w-[240px]\">\n               <p className=\"font-medium mb-1\">Typing Accuracy</p>\n               <p className=\"text-xs text-muted-foreground mb-1\">Percentage of characters typed correctly. Higher accuracy = fewer mistakes.</p>\n               <p className=\"text-xs text-muted-foreground\"><span className=\"text-yellow-400\">Tip:</span> Aim for 95%+ accuracy before focusing on speed!</p>\n             </TooltipContent>\n           </Tooltip>\n         )}\n         <Tooltip>\n           <TooltipTrigger asChild>\n             <div className=\"flex flex-col items-center p-2 md:p-3 rounded-lg md:rounded-xl bg-card border border-border cursor-help\">\n               <span className=\"text-muted-foreground text-[9px] md:text-[10px] uppercase tracking-wider mb-0.5 md:mb-1\">Consistency</span>\n               <span className={cn(\"text-xl md:text-3xl font-mono font-bold\", \n                 consistency >= 80 ? \"text-green-500\" : consistency >= 60 ? \"text-yellow-500\" : \"text-orange-500\"\n               )} data-testid=\"text-consistency\">{consistency}%</span>\n             </div>\n           </TooltipTrigger>\n           <TooltipContent className=\"max-w-[260px]\">\n             <p className=\"font-medium mb-1\">Typing Consistency</p>\n             <p className=\"text-xs text-muted-foreground mb-1\">Measures how steady your typing rhythm is. Higher = more uniform keystrokes.</p>\n             <p className=\"text-xs text-muted-foreground\"><span className=\"text-green-400\">80%+:</span> Excellent | <span className=\"text-yellow-400\">60-79%:</span> Good | <span className=\"text-orange-400\">&lt;60%:</span> Practice rhythm</p>\n           </TooltipContent>\n         </Tooltip>\n         <Tooltip>\n           <TooltipTrigger asChild>\n             <div className=\"flex flex-col items-center p-2 md:p-3 rounded-lg md:rounded-xl bg-card border border-border cursor-help\">\n               <span className=\"text-muted-foreground text-[9px] md:text-[10px] uppercase tracking-wider mb-0.5 md:mb-1\">Status</span>\n               <span className={cn(\"text-xl md:text-3xl font-mono font-bold\", isActive ? \"text-green-500\" : \"text-muted-foreground\")} data-testid=\"text-status\">\n                 {isActive ? \"GO\" : isFinished ? \"DONE\" : \"READY\"}\n               </span>\n             </div>\n           </TooltipTrigger>\n           <TooltipContent className=\"max-w-[220px]\">\n             <p className=\"font-medium mb-1\">Test Status</p>\n             <div className=\"text-xs text-muted-foreground space-y-1\">\n               <p><span className=\"text-muted-foreground\">READY:</span> Waiting for you to start typing</p>\n               <p><span className=\"text-green-400\">GO:</span> Test in progress, keep typing!</p>\n               <p><span className=\"text-blue-400\">DONE:</span> Test complete, results displayed</p>\n             </div>\n           </TooltipContent>\n         </Tooltip>\n         \n         {/* Freestyle Mode Extra Stats */}\n         {freestyleMode && (\n           <>\n             <Tooltip>\n               <TooltipTrigger asChild>\n                 <div className=\"flex flex-col items-center p-2 md:p-3 rounded-lg md:rounded-xl bg-card border border-purple-500/20 cursor-help\">\n                   <span className=\"text-muted-foreground text-[9px] md:text-[10px] uppercase tracking-wider mb-0.5 md:mb-1\">Words</span>\n                   <span className=\"text-xl md:text-3xl font-mono font-bold text-purple-400\" data-testid=\"text-freestyle-words\">\n                     {freestyleText.trim().split(/\\s+/).filter(w => w.length > 0).length}\n                   </span>\n                 </div>\n               </TooltipTrigger>\n               <TooltipContent>\n                 <p className=\"font-medium mb-1\">Words Typed</p>\n                 <p className=\"text-xs text-muted-foreground\">Total words you've typed in Freestyle mode (space-separated count)</p>\n               </TooltipContent>\n             </Tooltip>\n             <Tooltip>\n               <TooltipTrigger asChild>\n                 <div className=\"flex flex-col items-center p-2 md:p-3 rounded-lg md:rounded-xl bg-card border border-pink-500/20 cursor-help\">\n                   <span className=\"text-muted-foreground text-[9px] md:text-[10px] uppercase tracking-wider mb-0.5 md:mb-1\">Chars</span>\n                   <span className=\"text-xl md:text-3xl font-mono font-bold text-pink-400\" data-testid=\"text-freestyle-chars\">\n                     {freestyleText.length}\n                   </span>\n                 </div>\n               </TooltipTrigger>\n               <TooltipContent>\n                 <p className=\"font-medium mb-1\">Characters Typed</p>\n                 <p className=\"text-xs text-muted-foreground\">Total characters including spaces (used for WPM: chars Ã· 5)</p>\n               </TooltipContent>\n             </Tooltip>\n           </>\n         )}\n      </div>\n\n      {/* Freestyle Mode Notice */}\n      {freestyleMode && (\n        <div className=\"mb-3 px-3 py-2 bg-purple-500/10 border border-purple-500/20 rounded-lg flex items-start gap-2\" data-testid=\"notice-freestyle-leaderboard\">\n          <Info className=\"w-4 h-4 text-purple-400 mt-0.5 flex-shrink-0\" />\n          <p className=\"text-xs text-purple-300\">\n            <span className=\"font-medium\">Practice Mode:</span> Freestyle test results are excluded from all leaderboards and competitive statistics.\n          </p>\n        </div>\n      )}\n\n      {/* Typing Area */}\n      <div className=\"relative min-h-[200px] md:min-h-[300px] max-h-[300px] md:max-h-[400px] overflow-hidden group\">\n        \n        {/* Freestyle Mode Interface */}\n        {freestyleMode && (\n          <div className=\"w-full h-full min-h-[200px] md:min-h-[300px] flex flex-col relative\">\n            <textarea\n              value={freestyleText}\n              onChange={(e) => {\n                const newText = e.target.value;\n                \n                // Prevent changes if test is finished\n                if (isFinished) return;\n                \n                // Track last keystroke time for idle time handling\n                freestyleLastKeystrokeRef.current = Date.now();\n                \n                setFreestyleText(newText);\n                \n                // Start timer on first keystroke (handle edge case of paste)\n                if (!isActive && !isFinished && newText.length > 0 && freestyleText.length === 0) {\n                  setIsActive(true);\n                  setStartTime(Date.now());\n                  setHasInteracted(true);\n                  freestyleLastKeystrokeRef.current = Date.now();\n                }\n                \n                // Calculate WPM in real-time for free type with edge case handling\n                if (isActive && startTime) {\n                  const elapsedMs = Date.now() - startTime;\n                  const elapsedMinutes = elapsedMs / 60000;\n                  const elapsedSeconds = elapsedMs / 1000;\n                  \n                  // Prevent division by zero and handle very short typing sessions\n                  if (elapsedMinutes > 0.0167) { // At least 1 second\n                    const charCount = newText.length;\n                    // Use character-based WPM (standard: 5 chars = 1 word)\n                    const charBasedWpm = Math.round((charCount / 5) / elapsedMinutes);\n                    // Cap WPM at reasonable max to handle edge cases (prevent unrealistic values)\n                    const cappedWpm = Math.min(Math.max(charBasedWpm, 0), 300);\n                    setWpm(cappedWpm);\n                    setRawWpm(cappedWpm);\n                    \n                    // Track WPM history for consistency calculation (sample every ~1 second)\n                    if (elapsedSeconds > 1 && Math.floor(elapsedSeconds) !== Math.floor((elapsedSeconds - 0.1))) {\n                      wpmHistoryRef.current.push(cappedWpm);\n                      \n                      // Calculate consistency (lower standard deviation = higher consistency)\n                      if (wpmHistoryRef.current.length >= 3) {\n                        const avg = wpmHistoryRef.current.reduce((a, b) => a + b, 0) / wpmHistoryRef.current.length;\n                        const variance = wpmHistoryRef.current.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / wpmHistoryRef.current.length;\n                        const stdDev = Math.sqrt(variance);\n                        // Convert to 0-100% scale (lower deviation = higher consistency)\n                        const consistencyScore = avg > 0 ? Math.max(0, Math.min(100, Math.round(100 - (stdDev / avg * 100)))) : 100;\n                        setConsistency(consistencyScore);\n                      }\n                    }\n                  }\n                }\n              }}\n              onKeyDown={(e) => {\n                // Shift+Enter to finish test early (like Monkeytype)\n                if (e.shiftKey && e.key === 'Enter') {\n                  e.preventDefault();\n                  if (isActive && freestyleText.length > 0) {\n                    finishTest(false); // Pass false since user ended manually\n                    toast({\n                      title: \"Test Finished\",\n                      description: \"You ended the test early with Shift+Enter.\",\n                    });\n                  } else if (!isActive && freestyleText.length === 0) {\n                    toast({\n                      title: \"Nothing to Save\",\n                      description: \"Start typing first, then use Shift+Enter to finish.\",\n                      variant: \"default\",\n                    });\n                  }\n                }\n                \n                // Escape to exit freestyle mode\n                if (e.key === 'Escape') {\n                  if (!isActive || isFinished) {\n                    setFreestyleMode(false);\n                    setFreestyleText(\"\");\n                    setIsActive(false);\n                    setIsFinished(false);\n                    setTimeLeft(mode);\n                    toast({\n                      title: \"Exited Freestyle Mode\",\n                      description: \"Switched back to standard typing test.\",\n                    });\n                  }\n                }\n              }}\n              onPaste={(e) => {\n                // Prevent pasting in Freestyle mode - only typing allowed\n                e.preventDefault();\n                toast({\n                  title: \"Pasting Not Allowed\",\n                  description: \"Please type the text yourself to get accurate WPM metrics.\",\n                  variant: \"destructive\",\n                });\n              }}\n              onCut={(e) => {\n                // Prevent cutting text\n                e.preventDefault();\n              }}\n              onDrop={(e) => {\n                // Prevent drag-and-drop text\n                e.preventDefault();\n                toast({\n                  title: \"Drag & Drop Not Allowed\",\n                  description: \"Please type the text yourself for accurate results.\",\n                  variant: \"destructive\",\n                });\n              }}\n              onDragOver={(e) => {\n                // Prevent drag-over visual feedback\n                e.preventDefault();\n              }}\n              onBeforeInput={(e: any) => {\n                // Block mobile long-press paste and autocomplete insertions\n                if (e.inputType === 'insertFromPaste' || e.inputType === 'insertFromDrop') {\n                  e.preventDefault();\n                  toast({\n                    title: \"Pasting Not Allowed\",\n                    description: \"Please type the text yourself to get accurate WPM metrics.\",\n                    variant: \"destructive\",\n                  });\n                }\n              }}\n              placeholder=\"Start typing anything you want... Your WPM will be tracked in real-time!\"\n              disabled={isFinished}\n              autoFocus\n              spellCheck={false}\n              autoCorrect=\"off\"\n              autoCapitalize=\"off\"\n              autoComplete=\"off\"\n              aria-label=\"Free type text area - type anything you want\"\n              aria-describedby=\"freestyle-instructions\"\n              className={cn(\n                \"w-full h-full min-h-[200px] md:min-h-[300px] p-4 md:p-8 text-lg sm:text-xl md:text-2xl font-mono leading-relaxed\",\n                \"bg-transparent border-none outline-none resize-none\",\n                \"placeholder:text-muted-foreground/50\",\n                \"focus:ring-0 focus:outline-none\",\n                \"caret-primary\",\n                isFinished && \"opacity-60 cursor-not-allowed\"\n              )}\n              data-testid=\"textarea-freestyle\"\n            />\n            \n            {/* Keyboard shortcut hint */}\n            {isActive && !isFinished && freestyleText.length > 0 && (\n              <div className=\"absolute bottom-2 right-2 md:bottom-4 md:right-4 text-xs text-muted-foreground/60 hidden md:block\" id=\"freestyle-instructions\">\n                <kbd className=\"px-1.5 py-0.5 bg-secondary/50 rounded text-[10px] font-mono\">Shift</kbd>\n                <span className=\"mx-0.5\">+</span>\n                <kbd className=\"px-1.5 py-0.5 bg-secondary/50 rounded text-[10px] font-mono\">Enter</kbd>\n                <span className=\"ml-1\">to finish early</span>\n              </div>\n            )}\n            \n            {/* Initial State Overlay */}\n            {!isActive && !isFinished && freestyleText.length === 0 && (\n              <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none\">\n                <div className=\"flex flex-col items-center gap-3 text-center px-4\">\n                  <div className=\"w-16 h-16 rounded-full bg-gradient-to-r from-purple-500/20 to-pink-500/20 flex items-center justify-center\">\n                    <PenLine className=\"w-8 h-8 text-purple-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-lg font-medium text-foreground\">Freestyle Mode</p>\n                    <p className=\"text-sm text-muted-foreground mt-1\">Type anything - practice notes, thoughts, or random words</p>\n                    <p className=\"text-xs text-muted-foreground/70 mt-2\">Timer starts when you begin typing</p>\n                  </div>\n                </div>\n              </div>\n            )}\n            \n            {/* Finished State Overlay */}\n            {isFinished && freestyleText.length === 0 && (\n              <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none\">\n                <div className=\"flex flex-col items-center gap-3 text-center px-4\">\n                  <div className=\"w-16 h-16 rounded-full bg-yellow-500/20 flex items-center justify-center\">\n                    <AlertCircle className=\"w-8 h-8 text-yellow-500\" />\n                  </div>\n                  <div>\n                    <p className=\"text-lg font-medium text-foreground\">No Text Typed</p>\n                    <p className=\"text-sm text-muted-foreground mt-1\">Time ran out before you started typing</p>\n                    <p className=\"text-xs text-muted-foreground/70 mt-2\">Click \"Restart\" to try again</p>\n                  </div>\n                </div>\n              </div>\n            )}\n            \n            {/* Finished with content */}\n            {isFinished && freestyleText.length > 0 && (\n              <div className=\"absolute bottom-2 left-2 md:bottom-4 md:left-4 flex items-center gap-2 px-3 py-1.5 bg-green-500/10 rounded-full border border-green-500/20\">\n                <Check className=\"w-4 h-4 text-green-500\" />\n                <span className=\"text-xs md:text-sm text-green-500 font-medium\">Test Complete</span>\n              </div>\n            )}\n          </div>\n        )}\n        \n        {/* Error State */}\n        {!freestyleMode && paragraphError && !text && (\n          <div className=\"absolute inset-0 flex flex-col items-center justify-center p-8 text-center\">\n            <div className=\"w-16 h-16 rounded-full bg-destructive/10 flex items-center justify-center mb-4\">\n              <AlertCircle className=\"w-8 h-8 text-destructive\" />\n            </div>\n            <h3 className=\"text-xl font-semibold mb-2\">Unable to Load Content</h3>\n            <p className=\"text-muted-foreground mb-4 max-w-md\">{paragraphError}</p>\n            <div className=\"flex gap-3\">\n              <Button\n                variant=\"default\"\n                onClick={() => {\n                  setParagraphError(null);\n                  fetchParagraph();\n                }}\n                disabled={isGenerating}\n                data-testid=\"button-retry-paragraph\"\n              >\n                {isGenerating ? (\n                  <>\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                    Retrying...\n                  </>\n                ) : (\n                  <>\n                    <RefreshCw className=\"w-4 h-4 mr-2\" />\n                    Try Again\n                  </>\n                )}\n              </Button>\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  const fallbackText = generateText(100);\n                  setText(fallbackText);\n                  setOriginalText(fallbackText);\n                  setParagraphError(null);\n                  setFetchRetryCount(0);\n                }}\n                data-testid=\"button-use-practice-text\"\n              >\n                Use Practice Text\n              </Button>\n            </div>\n          </div>\n        )}\n\n        {/* Loading State - only show full overlay if no text exists yet */}\n        {!freestyleMode && isGenerating && !text && (\n          <div className=\"absolute inset-0 flex flex-col items-center justify-center bg-background/80 backdrop-blur-sm z-10\">\n            <Loader2 className=\"w-12 h-12 animate-spin text-primary mb-4\" />\n            <p className=\"text-muted-foreground\">Generating content...</p>\n          </div>\n        )}\n        \n        {/* Inline loading indicator when text exists (regenerating) */}\n        {!freestyleMode && isGenerating && text && (\n          <div className=\"absolute top-4 right-4 flex items-center gap-2 px-3 py-1 bg-primary/10 rounded-full z-10\">\n            <Loader2 className=\"w-4 h-4 animate-spin text-primary\" />\n            <span className=\"text-xs text-primary\">Loading new content...</span>\n          </div>\n        )}\n\n        {/* Hidden Input */}\n        {!freestyleMode && (\n          <input\n            ref={inputRef}\n            type=\"text\"\n            value={userInput}\n            onBeforeInput={handleBeforeInput}\n            onChange={handleInput}\n            onKeyDown={handleKeyDown}\n            onCompositionStart={handleCompositionStart}\n            onCompositionEnd={handleCompositionEnd}\n            onPaste={handlePaste}\n            onCut={handleCut}\n            onDragStart={(e) => e.preventDefault()}\n            onDrop={(e) => e.preventDefault()}\n            onContextMenu={(e) => e.preventDefault()}\n            onSelect={(e) => {\n              // Force cursor to end if user tries to select\n              if (inputRef.current) {\n                const pos = userInput.length;\n                inputRef.current.setSelectionRange(pos, pos);\n              }\n            }}\n            className=\"absolute opacity-0 w-full h-full cursor-default z-0\"\n            autoFocus\n            autoComplete=\"off\"\n            autoCorrect=\"off\"\n            autoCapitalize=\"off\"\n            spellCheck=\"false\"\n            disabled={!!paragraphError && !text}\n          />\n        )}\n\n        {/* Visual Text Display */}\n        {!freestyleMode && text && (\n          <div \n            ref={containerRef}\n            lang={language}\n            dir={isRTL ? \"rtl\" : \"ltr\"}\n            data-testid=\"text-paragraph\"\n            data-paragraph-text={text}\n            data-original-paragraph={originalText}\n            className={cn(\n              \"w-full h-full max-h-[300px] md:max-h-[400px] overflow-y-auto p-4 md:p-8 text-lg sm:text-xl md:text-3xl font-mono leading-relaxed break-words outline-none transition-all duration-300 scroll-smooth select-none\",\n              !isActive && !isFinished && !hasInteracted && \"blur-[2px] opacity-60 group-hover:blur-0 group-hover:opacity-100\"\n            )}\n            onClick={() => {\n              setHasInteracted(true);\n              inputRef.current?.focus({ preventScroll: true });\n            }}\n            onMouseDown={(e) => e.preventDefault()}\n            onContextMenu={(e) => e.preventDefault()}\n            onScroll={() => {\n              // Detect manual user scrolling\n              isUserScrollingRef.current = true;\n              \n              // CRITICAL: Recalculate cursor position SYNCHRONOUSLY during scroll\n              // This keeps cursor aligned with character without React state lag\n              updateCursorPosition(false);\n              \n              // Clear any existing timeout\n              if (userScrollTimeoutRef.current) {\n                clearTimeout(userScrollTimeoutRef.current);\n              }\n              \n              // Resume auto-scroll after user stops scrolling for 150ms\n              userScrollTimeoutRef.current = setTimeout(() => {\n                isUserScrollingRef.current = false;\n              }, 150);\n            }}\n          >\n            {characters.map((char, index) => {\n              // MONKEYTYPE-STYLE VALIDATION: Use persistent character states\n              // Characters remain in 'incorrect' (red) state even after backspace\n              const charState = charStates[index];\n              const state = charState ? charState.state : 'pending';\n              const typedChar = charState?.typed || undefined;\n              \n              return (\n                <CharSpan \n                  key={`${text.length}-${index}`}\n                  ref={(el) => {\n                    charRefs.current[index] = el;\n                  }}\n                  char={char}\n                  index={index}\n                  state={state}\n                  typedChar={typedChar}\n                />\n              );\n            })}\n            \n            {/* Blinking cursor */}\n            {!isFinished && (\n              <div\n                className=\"absolute w-0.5 bg-primary animate-pulse\"\n                style={{\n                  left: `${cursorPosition.left}px`,\n                  top: `${cursorPosition.top}px`,\n                  height: `${cursorPosition.height}px`,\n                  transition: prefersReducedMotion || isTypingFast ? 'none' : 'left 0.1s ease-out, top 0.1s ease-out',\n                }}\n                aria-hidden=\"true\"\n              />\n            )}\n          </div>\n        )}\n        \n        {/* Focus Overlay - Professional Monkeytype-style hint */}\n        {!freestyleMode && !isActive && !isFinished && !hasInteracted && userInput.length === 0 && text && !isGenerating && (\n          <div \n            className=\"absolute inset-0 flex items-center justify-center cursor-text transition-opacity duration-200\"\n            onClick={() => {\n              setHasInteracted(true);\n              inputRef.current?.focus({ preventScroll: true });\n            }}\n          >\n            <div className=\"flex items-center gap-2 px-4 py-2 bg-card/80 backdrop-blur-sm border border-border/50 rounded-md shadow-sm\">\n              <span className=\"text-muted-foreground text-base font-medium tracking-wide\">\n                Click here or start typing\n              </span>\n            </div>\n          </div>\n        )}\n      </div>\n\n      {/* Controls */}\n      <div className=\"flex justify-center gap-2 md:gap-3 transition-opacity duration-300\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <button\n                onClick={() => resetTest()}\n                className=\"flex items-center gap-1.5 md:gap-2 px-4 md:px-8 py-2 md:py-3 rounded-lg bg-secondary hover:bg-secondary/80 transition-colors text-secondary-foreground font-medium text-sm md:text-base\"\n                data-testid=\"button-restart-test\"\n              >\n                <RefreshCw className=\"w-4 h-4 md:w-5 md:h-5\" />\n                <span className=\"hidden sm:inline\">Restart Test</span>\n                <span className=\"sm:hidden\">Restart</span>\n              </button>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>Get a new paragraph and restart the test</p>\n            </TooltipContent>\n          </Tooltip>\n          \n{/* Zen Mode button hidden for now\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <button\n                onClick={() => {\n                  const newValue = !zenMode;\n                  setZenMode(newValue);\n                  localStorage.setItem('zenMode', String(newValue));\n                  toast({\n                    title: newValue ? \"Zen Mode Enabled\" : \"Zen Mode Disabled\",\n                    description: newValue \n                      ? \"Stats and controls will be hidden during typing\" \n                      : \"Stats and controls will remain visible\",\n                  });\n                }}\n                className={cn(\n                  \"flex items-center gap-2 px-4 py-3 rounded-lg transition-colors font-medium\",\n                  zenMode \n                    ? \"bg-primary text-primary-foreground hover:bg-primary/90\" \n                    : \"bg-secondary hover:bg-secondary/80 text-secondary-foreground\"\n                )}\n                data-testid=\"button-zen-mode\"\n              >\n                {zenMode ? <Eye className=\"w-5 h-5\" /> : <EyeOff className=\"w-5 h-5\" />}\n                Zen\n              </button>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>{zenMode ? \"Disable Zen Mode - show stats while typing\" : \"Enable Zen Mode - hide stats while typing\"}</p>\n            </TooltipContent>\n          </Tooltip>\n*/}\n      </div>\n\n      {/* Result Modal / Section */}\n      <AnimatePresence>\n        {isFinished && (\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            exit={{ opacity: 0, y: 20 }}\n            className=\"fixed inset-0 z-50 flex items-center justify-center bg-background/80 backdrop-blur-sm p-2 sm:p-4\"\n          >\n            <div className=\"bg-card border border-border p-4 sm:p-6 md:p-8 rounded-xl sm:rounded-2xl shadow-2xl max-w-lg w-full relative overflow-hidden max-h-[90vh] overflow-y-auto\">\n              <div className=\"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-primary via-purple-500 to-primary animate-gradient\" />\n              \n              <h2 className=\"text-2xl sm:text-3xl font-bold mb-4 sm:mb-6 md:mb-8 text-center\">Test Complete!</h2>\n              \n              <div className={cn(\n                \"grid gap-3 sm:gap-4 md:gap-6 mb-4 sm:mb-6 md:mb-8\",\n                freestyleMode ? \"grid-cols-1\" : \"grid-cols-2\"\n              )}>\n                <div className=\"flex flex-col items-center p-3 sm:p-4 bg-background/50 rounded-lg sm:rounded-xl\">\n                  <div className=\"text-muted-foreground text-xs sm:text-sm mb-1 flex items-center gap-1.5 sm:gap-2\">\n                    <Zap className=\"w-3.5 h-3.5 sm:w-4 sm:h-4\" /> WPM\n                  </div>\n                  <div className=\"text-3xl sm:text-4xl md:text-5xl font-mono font-bold text-primary\">{wpm}</div>\n                </div>\n                {/* Hide Accuracy in Freestyle mode */}\n                {!freestyleMode && (\n                  <div className=\"flex flex-col items-center p-3 sm:p-4 bg-background/50 rounded-lg sm:rounded-xl\">\n                    <div className=\"text-muted-foreground text-xs sm:text-sm mb-1 flex items-center gap-1.5 sm:gap-2\">\n                      <Target className=\"w-3.5 h-3.5 sm:w-4 sm:h-4\" /> Accuracy\n                    </div>\n                    <div className=\"text-3xl sm:text-4xl md:text-5xl font-mono font-bold\">{accuracy}%</div>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"space-y-2 sm:space-y-3 md:space-y-4\">\n                <div className=\"flex justify-between text-sm text-muted-foreground\">\n                  <span>Raw WPM</span>\n                  <span className=\"font-mono text-foreground\">{wpm + Math.round((100 - accuracy) / 2)}</span>\n                </div>\n                <div className=\"flex justify-between text-sm text-muted-foreground\">\n                  <span>Characters</span>\n                  <span className=\"font-mono text-foreground\">{freestyleMode ? freestyleText.length : userInput.length}</span>\n                </div>\n                 <div className=\"flex justify-between text-sm text-muted-foreground\">\n                  <span>Time</span>\n                  <span className=\"font-mono text-foreground\">{mode}s</span>\n                </div>\n              </div>\n\n              {/* Celebratory Share Prompt - appears for good performances */}\n              {wpm >= 40 && (\n                <motion.div\n                  initial={{ opacity: 0, scale: 0.9 }}\n                  animate={{ opacity: 1, scale: 1 }}\n                  transition={{ delay: 0.5, duration: 0.4 }}\n                  className=\"mb-4 p-4 bg-gradient-to-r from-yellow-500/10 via-orange-500/10 to-pink-500/10 rounded-xl border border-yellow-500/30 text-center\"\n                >\n                  <div className=\"flex items-center justify-center gap-2 mb-2\">\n                    <span className=\"text-2xl\">{wpm >= 80 ? \"ðŸ”¥\" : wpm >= 60 ? \"âš¡\" : \"ðŸŽ‰\"}</span>\n                    <span className=\"font-bold text-lg\">\n                      {wpm >= 80 ? \"Amazing Performance!\" : wpm >= 60 ? \"Great Job!\" : \"Nice Work!\"}\n                    </span>\n                    <span className=\"text-2xl\">{wpm >= 80 ? \"ðŸ”¥\" : wpm >= 60 ? \"âš¡\" : \"ðŸŽ‰\"}</span>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground mb-3\">\n                    {wpm >= 80 \n                      ? \"You're faster than 95% of typists! Share your achievement!\" \n                      : wpm >= 60 \n                      ? \"You're faster than 75% of typists! Challenge your friends!\" \n                      : \"You're above average! Share and see if your friends can beat you!\"}\n                  </p>\n                  <motion.button\n                    whileHover={{ scale: 1.02 }}\n                    whileTap={{ scale: 0.98 }}\n                    onClick={() => setShowShareModal(true)}\n                    className=\"px-6 py-2 bg-gradient-to-r from-yellow-500 via-orange-500 to-pink-500 text-white font-bold rounded-lg shadow-lg animate-pulse hover:animate-none\"\n                    data-testid=\"button-share-celebration\"\n                  >\n                    <Share2 className=\"w-4 h-4 inline mr-2\" />\n                    Share & Earn 5 XP\n                  </motion.button>\n                </motion.div>\n              )}\n\n              <div className=\"mt-4 flex flex-col gap-3\">\n                {user && (\n                  <>\n                    <button\n                      onClick={() => setShowCertificate(true)}\n                      className=\"w-full py-3 bg-gradient-to-r from-purple-500 to-cyan-500 text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2\"\n                      data-testid=\"button-view-certificate\"\n                    >\n                      <Award className=\"w-5 h-5\" />\n                      Get Certificate\n                    </button>\n                    <button\n                      onClick={() => setShowShareModal(true)}\n                      disabled={isCreatingShare}\n                      className=\"w-full py-3 bg-gradient-to-r from-blue-500 to-green-500 text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2\"\n                      data-testid=\"button-share-result\"\n                    >\n                      <Share2 className=\"w-5 h-5\" />\n                      {isCreatingShare ? \"Creating...\" : \"Share Result\"}\n                    </button>\n                  </>\n                )}\n                {!user && (\n                  <button\n                    onClick={() => setShowShareModal(true)}\n                    className=\"w-full py-3 bg-gradient-to-r from-blue-500 to-green-500 text-white font-bold rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center gap-2\"\n                    data-testid=\"button-share-result\"\n                  >\n                    <Share2 className=\"w-5 h-5\" />\n                    Share Result\n                  </button>\n                )}\n                <div className=\"flex gap-3\">\n                  <button\n                    onClick={() => resetTest()}\n                    className=\"flex-1 py-3 bg-primary text-primary-foreground font-bold rounded-lg hover:opacity-90 transition-opacity\"\n                    data-testid=\"button-next-test\"\n                  >\n                    Next Test\n                  </button>\n                  <button\n                    onClick={() => resetTest()}\n                    className=\"px-6 py-3 border border-border rounded-lg hover:bg-accent transition-colors\"\n                    data-testid=\"button-close-results\"\n                  >\n                    Close\n                  </button>\n                </div>\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n\n      {/* Auth Prompt Dialog */}\n      <AuthPromptDialog\n        open={showAuthPrompt}\n        onOpenChange={setShowAuthPrompt}\n        title=\"Save Your Progress\"\n        description={`Great job! You scored ${wpm} WPM with ${accuracy}% accuracy. Create an account to save your results and track your progress over time!`}\n      />\n\n      {/* Certificate Dialog */}\n      <Dialog open={showCertificate} onOpenChange={setShowCertificate}>\n        <DialogContent className=\"max-w-5xl\">\n          <DialogHeader>\n            <DialogTitle className=\"text-2xl font-bold text-center\">Your Achievement Certificate</DialogTitle>\n          </DialogHeader>\n          {user && lastResultSnapshot && (\n            <CertificateGenerator\n              username={user.username}\n              wpm={lastResultSnapshot.wpm}\n              accuracy={lastResultSnapshot.accuracy}\n              mode={lastResultSnapshot.mode}\n              date={new Date(lastResultSnapshot.completionDate)}\n              freestyle={lastResultSnapshot.freestyle}\n              characters={lastResultSnapshot.characters}\n              words={lastResultSnapshot.words}\n              consistency={lastResultSnapshot.consistency}\n            />\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Share Modal */}\n      <Dialog open={showShareModal} onOpenChange={setShowShareModal}>\n        <DialogContent className=\"sm:max-w-xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-xl\">\n              <Share2 className=\"w-5 h-5 text-primary\" />\n              Share Your Achievement\n            </DialogTitle>\n          </DialogHeader>\n          \n          <Tabs defaultValue=\"quick\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-3 mb-4\">\n              <TabsTrigger value=\"quick\" data-testid=\"tab-quick-share\">Quick Share</TabsTrigger>\n              <TabsTrigger value=\"card\" data-testid=\"tab-visual-card\">Visual Card</TabsTrigger>\n              <TabsTrigger value=\"challenge\" data-testid=\"tab-challenge\">Challenge</TabsTrigger>\n            </TabsList>\n            \n            {/* Quick Share Tab */}\n            <TabsContent value=\"quick\" className=\"space-y-4\">\n              {/* Pre-composed Share Message Preview */}\n              <div className=\"relative\">\n                <div className=\"absolute -top-2 left-3 px-2 bg-background text-xs font-medium text-muted-foreground\">\n                  Your Share Message\n                </div>\n                <div className=\"p-4 bg-gradient-to-br from-slate-900/50 to-slate-800/50 rounded-xl border border-primary/20 text-sm leading-relaxed\">\n                  <div className=\"space-y-2\">\n                    <p className=\"text-base font-medium\">\n                      {getPerformanceRating().emoji} I just scored <span className=\"text-primary font-bold\">{wpm} WPM</span> on TypeMasterAI!\n                    </p>\n                    <p className=\"text-muted-foreground\">\n                      âŒ¨ï¸ <span className=\"text-foreground\">{wpm} WPM</span> | âœ¨ <span className=\"text-foreground\">{accuracy}% Accuracy</span>\n                    </p>\n                    <p className=\"text-muted-foreground\">\n                      ðŸ… <span className=\"text-yellow-400\">{getPerformanceRating().title}</span> - {getPerformanceRating().badge} Badge\n                    </p>\n                    <p className=\"text-muted-foreground\">\n                      â±ï¸ {mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`} typing test\n                    </p>\n                    <p className=\"text-primary/80 text-xs mt-3\">\n                      Think you can beat my score? Try it now! ðŸŽ¯\n                    </p>\n                    <p className=\"text-xs text-primary mt-2 font-medium\">\n                      ðŸ”— typemasterai.com\n                    </p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      #TypingTest #TypeMasterAI #WPM\n                    </p>\n                  </div>\n                </div>\n                <button\n                  onClick={() => {\n                    const rating = getPerformanceRating();\n                    const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n                    const text = `${rating.emoji} I just scored ${wpm} WPM on TypeMasterAI!\\n\\nâŒ¨ï¸ ${wpm} WPM | âœ¨ ${accuracy}% Accuracy\\nðŸ… ${rating.title} - ${rating.badge} Badge\\nâ±ï¸ ${modeDisplay} typing test\\n\\nThink you can beat my score? Try it now! ðŸŽ¯\\n\\nðŸ”— https://typemasterai.com\\n\\n#TypingTest #TypeMasterAI #WPM`;\n                    navigator.clipboard.writeText(text);\n                    toast({ title: \"Message Copied!\", description: \"Share message copied to clipboard\" });\n                  }}\n                  className=\"absolute top-3 right-3 p-1.5 rounded-md bg-background/80 hover:bg-background border border-border/50 transition-colors\"\n                  data-testid=\"button-copy-message\"\n                >\n                <Copy className=\"w-3.5 h-3.5 text-muted-foreground\" />\n              </button>\n            </div>\n\n            {/* Quick Share Buttons - One Click Share */}\n            <div className=\"space-y-3\">\n              <p className=\"text-xs font-medium text-center text-muted-foreground uppercase tracking-wide\">\n                Click to Share Instantly\n              </p>\n              <div className=\"grid grid-cols-4 gap-3\">\n                <button\n                  onClick={() => shareToSocial('twitter')}\n                  className=\"flex flex-col items-center gap-2 p-4 rounded-xl bg-[#1DA1F2]/10 hover:bg-[#1DA1F2]/25 border border-[#1DA1F2]/20 hover:border-[#1DA1F2]/40 transition-all group\"\n                  data-testid=\"button-share-twitter\"\n                >\n                  <Twitter className=\"w-6 h-6 text-[#1DA1F2]\" />\n                  <span className=\"text-xs font-medium text-muted-foreground group-hover:text-foreground\">Twitter</span>\n                </button>\n                <button\n                  onClick={() => shareToSocial('facebook')}\n                  className=\"flex flex-col items-center gap-2 p-4 rounded-xl bg-[#1877F2]/10 hover:bg-[#1877F2]/25 border border-[#1877F2]/20 hover:border-[#1877F2]/40 transition-all group\"\n                  data-testid=\"button-share-facebook\"\n                >\n                  <Facebook className=\"w-6 h-6 text-[#1877F2]\" />\n                  <span className=\"text-xs font-medium text-muted-foreground group-hover:text-foreground\">Facebook</span>\n                </button>\n                <button\n                  onClick={() => shareToSocial('linkedin')}\n                  className=\"flex flex-col items-center gap-2 p-4 rounded-xl bg-[#0A66C2]/10 hover:bg-[#0A66C2]/25 border border-[#0A66C2]/20 hover:border-[#0A66C2]/40 transition-all group\"\n                  data-testid=\"button-share-linkedin\"\n                >\n                  <Linkedin className=\"w-6 h-6 text-[#0A66C2]\" />\n                  <span className=\"text-xs font-medium text-muted-foreground group-hover:text-foreground\">LinkedIn</span>\n                </button>\n                <button\n                  onClick={() => shareToSocial('whatsapp')}\n                  className=\"flex flex-col items-center gap-2 p-4 rounded-xl bg-[#25D366]/10 hover:bg-[#25D366]/25 border border-[#25D366]/20 hover:border-[#25D366]/40 transition-all group\"\n                  data-testid=\"button-share-whatsapp\"\n                >\n                  <MessageCircle className=\"w-6 h-6 text-[#25D366]\" />\n                  <span className=\"text-xs font-medium text-muted-foreground group-hover:text-foreground\">WhatsApp</span>\n                </button>\n              </div>\n            </div>\n\n            {/* Shareable Link for logged in users */}\n            {user && lastResultId && (\n              <div className=\"space-y-2\">\n                <p className=\"text-xs font-medium text-center text-muted-foreground uppercase tracking-wide\">\n                  Permanent Link\n                </p>\n                {!shareUrl ? (\n                  <button\n                    onClick={createShareLink}\n                    disabled={isCreatingShare}\n                    className=\"w-full py-2.5 bg-primary/10 text-primary font-medium rounded-lg hover:bg-primary/20 transition-colors flex items-center justify-center gap-2 border border-primary/20\"\n                    data-testid=\"button-create-share-link\"\n                  >\n                    <Link2 className=\"w-4 h-4\" />\n                    {isCreatingShare ? \"Creating...\" : \"Create Shareable Link\"}\n                  </button>\n                ) : (\n                  <div className=\"flex items-center gap-2\">\n                    <input\n                      type=\"text\"\n                      value={shareUrl}\n                      readOnly\n                      className=\"flex-1 px-3 py-2 bg-muted/50 border rounded-lg text-sm font-mono\"\n                      data-testid=\"input-share-url\"\n                    />\n                    <button\n                      onClick={copyShareLink}\n                      className=\"px-3 py-2 bg-primary text-primary-foreground rounded-lg hover:opacity-90 transition-opacity\"\n                      data-testid=\"button-copy-link\"\n                    >\n                      {copied ? <Check className=\"w-4 h-4\" /> : <Copy className=\"w-4 h-4\" />}\n                    </button>\n                  </div>\n                )}\n              </div>\n            )}\n\n            {/* Share Certificate Section - Only for logged in users */}\n            {user && (\n              <div className=\"space-y-3 pt-2 border-t\">\n                <div className=\"flex items-center gap-2 justify-center\">\n                  <Award className=\"w-4 h-4 text-yellow-400\" />\n                  <p className=\"text-xs font-medium text-center text-muted-foreground uppercase tracking-wide\">\n                    Share Your Certificate\n                  </p>\n                  <Award className=\"w-4 h-4 text-yellow-400\" />\n                </div>\n                \n                {/* Certificate Share Message */}\n                <div className=\"p-3 bg-gradient-to-r from-yellow-500/10 to-orange-500/10 rounded-lg border border-yellow-500/20\">\n                  <p className=\"text-sm text-center text-foreground\">\n                    ðŸŽ“ <span className=\"font-medium\">Show off your official TypeMasterAI certificate!</span>\n                  </p>\n                  <p className=\"text-xs text-center text-muted-foreground mt-1\">\n                    Share your {wpm} WPM achievement with friends and colleagues\n                  </p>\n                </div>\n\n                {/* Certificate Social Share Buttons */}\n                <div className=\"grid grid-cols-4 gap-2\">\n                  <button\n                    onClick={() => {\n                      const rating = getPerformanceRating();\n                      const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n                      const text = encodeURIComponent(`ðŸŽ“ I just earned my TypeMasterAI Certificate!\\n\\nâŒ¨ï¸ ${wpm} WPM | ${accuracy}% Accuracy\\nðŸ… ${rating.title} - ${rating.badge} Badge\\nâ±ï¸ ${modeDisplay} typing test\\n\\nGet your certificate too!\\n\\n#TypeMasterAI #TypingCertificate`);\n                      window.open(`https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent('https://typemasterai.com')}`, '_blank', 'width=600,height=400');\n                    }}\n                    className=\"flex flex-col items-center gap-1 p-2 rounded-lg bg-[#1DA1F2]/10 hover:bg-[#1DA1F2]/25 border border-[#1DA1F2]/20 transition-all group\"\n                    data-testid=\"button-share-cert-twitter\"\n                  >\n                    <Twitter className=\"w-5 h-5 text-[#1DA1F2]\" />\n                    <span className=\"text-[10px] text-muted-foreground group-hover:text-foreground\">Twitter</span>\n                  </button>\n                  <button\n                    onClick={() => {\n                      const rating = getPerformanceRating();\n                      const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n                      const text = encodeURIComponent(`ðŸŽ“ I just earned my TypeMasterAI Certificate!\\n\\nðŸ† ${wpm} Words Per Minute\\nâœ¨ ${accuracy}% Accuracy\\nðŸ… ${rating.title} - ${rating.badge} Badge\\nâ±ï¸ ${modeDisplay} test\\n\\nTest your typing skills and get certified!`);\n                      window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent('https://typemasterai.com')}&quote=${text}`, '_blank', 'width=600,height=400');\n                    }}\n                    className=\"flex flex-col items-center gap-1 p-2 rounded-lg bg-[#1877F2]/10 hover:bg-[#1877F2]/25 border border-[#1877F2]/20 transition-all group\"\n                    data-testid=\"button-share-cert-facebook\"\n                  >\n                    <Facebook className=\"w-5 h-5 text-[#1877F2]\" />\n                    <span className=\"text-[10px] text-muted-foreground group-hover:text-foreground\">Facebook</span>\n                  </button>\n                  <button\n                    onClick={() => {\n                      const rating = getPerformanceRating();\n                      const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n                      const text = encodeURIComponent(`Proud to share my TypeMasterAI Certificate of Achievement! ðŸŽ“\\n\\nðŸ“œ Certification Details:\\nâ€¢ Typing Speed: ${wpm} Words Per Minute\\nâ€¢ Accuracy: ${accuracy}%\\nâ€¢ Performance Rating: ${rating.title} (${rating.badge})\\nâ€¢ Test Duration: ${modeDisplay}\\n\\nContinuous skill development is key to professional growth.\\n\\n#Certificate #TypeMasterAI #ProfessionalDevelopment`);\n                      window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent('https://typemasterai.com')}`, '_blank', 'width=600,height=400');\n                    }}\n                    className=\"flex flex-col items-center gap-1 p-2 rounded-lg bg-[#0A66C2]/10 hover:bg-[#0A66C2]/25 border border-[#0A66C2]/20 transition-all group\"\n                    data-testid=\"button-share-cert-linkedin\"\n                  >\n                    <Linkedin className=\"w-5 h-5 text-[#0A66C2]\" />\n                    <span className=\"text-[10px] text-muted-foreground group-hover:text-foreground\">LinkedIn</span>\n                  </button>\n                  <button\n                    onClick={() => {\n                      const rating = getPerformanceRating();\n                      const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n                      const text = encodeURIComponent(`ðŸŽ“ Check out my TypeMasterAI Certificate!\\n\\nðŸ“œ *Certificate of Achievement*\\nâŒ¨ï¸ *${wpm} WPM* | *${accuracy}% Accuracy*\\nðŸ… ${rating.title} - ${rating.badge} Badge\\nâ±ï¸ ${modeDisplay} test\\n\\nGet your certificate: `);\n                      window.open(`https://wa.me/?text=${text}${encodeURIComponent('https://typemasterai.com')}`, '_blank', 'width=600,height=400');\n                    }}\n                    className=\"flex flex-col items-center gap-1 p-2 rounded-lg bg-[#25D366]/10 hover:bg-[#25D366]/25 border border-[#25D366]/20 transition-all group\"\n                    data-testid=\"button-share-cert-whatsapp\"\n                  >\n                    <MessageCircle className=\"w-5 h-5 text-[#25D366]\" />\n                    <span className=\"text-[10px] text-muted-foreground group-hover:text-foreground\">WhatsApp</span>\n                  </button>\n                </div>\n                \n                <p className=\"text-xs text-center text-muted-foreground\">\n                  ðŸ’¡ Tip: View your certificate to download it, then attach it to your post!\n                </p>\n              </div>\n            )}\n\n              {/* Native Share - More Options */}\n              {'share' in navigator && (\n                <button\n                  onClick={handleNativeShare}\n                  className=\"w-full py-3 bg-gradient-to-r from-primary/10 to-purple-500/10 text-foreground font-medium rounded-xl hover:from-primary/20 hover:to-purple-500/20 transition-all flex items-center justify-center gap-2 border border-primary/20\"\n                  data-testid=\"button-native-share\"\n                >\n                  <Share2 className=\"w-4 h-4\" />\n                  More Sharing Options\n                </button>\n              )}\n            </TabsContent>\n\n            {/* Visual Card Tab */}\n            <TabsContent value=\"card\" className=\"space-y-4\">\n              <div className=\"text-center mb-4\">\n                <p className=\"text-sm text-muted-foreground\">\n                  Create a beautiful visual card to share on social media\n                </p>\n              </div>\n              {isFinished && lastResultSnapshot && (\n                <ShareCard\n                  wpm={lastResultSnapshot.wpm}\n                  accuracy={lastResultSnapshot.accuracy}\n                  mode={lastResultSnapshot.mode}\n                  language={language}\n                  username={user?.username}\n                  freestyle={lastResultSnapshot.freestyle}\n                  consistency={lastResultSnapshot.consistency}\n                  words={lastResultSnapshot.words}\n                  characters={lastResultSnapshot.characters}\n                  onShareTracked={trackShare}\n                />\n              )}\n            </TabsContent>\n\n            {/* Challenge Tab */}\n            <TabsContent value=\"challenge\" className=\"space-y-4\">\n              <div className=\"text-center space-y-2 mb-4\">\n                <div className=\"text-4xl\">ðŸŽ¯</div>\n                <h3 className=\"text-lg font-bold\">Challenge a Friend</h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  Send a personalized challenge and see if they can beat your score!\n                </p>\n              </div>\n\n              {/* Challenge Link Generator */}\n              <div className=\"p-4 bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-xl border border-purple-500/20\">\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm font-medium\">Your Score to Beat:</span>\n                    <span className=\"text-lg font-bold text-primary\">{wpm} WPM</span>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm font-medium\">Accuracy Target:</span>\n                    <span className=\"text-lg font-bold text-green-400\">{accuracy}%</span>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm font-medium\">Test Duration:</span>\n                    <span className=\"text-lg font-bold text-purple-400\">\n                      {mode >= 60 ? `${Math.floor(mode / 60)} min` : `${mode}s`}\n                    </span>\n                  </div>\n                </div>\n              </div>\n\n              {/* Challenge Share Buttons */}\n              <div className=\"space-y-2\">\n                <p className=\"text-xs text-center text-muted-foreground uppercase tracking-wide\">\n                  Send Challenge Via\n                </p>\n                <div className=\"grid grid-cols-3 gap-2\">\n                  <button\n                    onClick={() => {\n                      const rating = getPerformanceRating();\n                      const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n                      const text = encodeURIComponent(`ðŸŽ¯ I CHALLENGE YOU!\\n\\n${rating.emoji} Can you beat my ${wpm} WPM with ${accuracy}% accuracy?\\n\\nâ±ï¸ ${modeDisplay} typing test\\nðŸ… Try to claim my ${rating.badge} Badge!\\n\\nAccept the challenge now:\\n`);\n                      window.open(`https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent('https://typemasterai.com')}`, '_blank', 'width=600,height=400');\n                      trackShare('challenge_twitter');\n                    }}\n                    className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#1DA1F2]/10 hover:bg-[#1DA1F2]/25 border border-[#1DA1F2]/20 transition-all\"\n                    data-testid=\"button-challenge-twitter\"\n                  >\n                    <Twitter className=\"w-4 h-4 text-[#1DA1F2]\" />\n                    <span className=\"text-xs font-medium\">Twitter</span>\n                  </button>\n                  <button\n                    onClick={() => {\n                      const rating = getPerformanceRating();\n                      const text = encodeURIComponent(`ðŸŽ¯ TYPING CHALLENGE! Can you beat my ${wpm} WPM with ${accuracy}% accuracy? ${rating.emoji}`);\n                      window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent('https://typemasterai.com')}&quote=${text}`, '_blank', 'width=600,height=400');\n                      trackShare('challenge_facebook');\n                    }}\n                    className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#1877F2]/10 hover:bg-[#1877F2]/25 border border-[#1877F2]/20 transition-all\"\n                    data-testid=\"button-challenge-facebook\"\n                  >\n                    <Facebook className=\"w-4 h-4 text-[#1877F2]\" />\n                    <span className=\"text-xs font-medium\">Facebook</span>\n                  </button>\n                  <button\n                    onClick={() => {\n                      const rating = getPerformanceRating();\n                      const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n                      const fullText = `ðŸŽ¯ *TYPING CHALLENGE*\\n\\nCan you beat me?\\n\\n${rating.emoji} *My Score: ${wpm} WPM*\\nâœ¨ *Accuracy: ${accuracy}%*\\nâ±ï¸ ${modeDisplay} test\\n\\nðŸ”¥ Accept the challenge: https://typemasterai.com`;\n                      window.open(`https://wa.me/?text=${encodeURIComponent(fullText)}`, '_blank', 'width=600,height=400');\n                      trackShare('challenge_whatsapp');\n                    }}\n                    className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#25D366]/10 hover:bg-[#25D366]/25 border border-[#25D366]/20 transition-all\"\n                    data-testid=\"button-challenge-whatsapp\"\n                  >\n                    <MessageCircle className=\"w-4 h-4 text-[#25D366]\" />\n                    <span className=\"text-xs font-medium\">WhatsApp</span>\n                  </button>\n                  <button\n                    onClick={() => {\n                      const title = encodeURIComponent(`I challenge you to beat my ${wpm} WPM typing score!`);\n                      window.open(`https://www.reddit.com/submit?url=${encodeURIComponent('https://typemasterai.com')}&title=${title}`, '_blank', 'width=600,height=600');\n                      trackShare('challenge_reddit');\n                    }}\n                    className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#FF4500]/10 hover:bg-[#FF4500]/25 border border-[#FF4500]/20 transition-all\"\n                    data-testid=\"button-challenge-reddit\"\n                  >\n                    <svg className=\"w-4 h-4 text-[#FF4500]\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                      <path d=\"M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z\"/>\n                    </svg>\n                    <span className=\"text-xs font-medium\">Reddit</span>\n                  </button>\n                  <button\n                    onClick={() => {\n                      const rating = getPerformanceRating();\n                      const text = `ðŸŽ¯ TYPING CHALLENGE!\\n\\n${rating.emoji} Can you beat my ${wpm} WPM with ${accuracy}% accuracy?\\n\\nAccept the challenge:`;\n                      window.open(`https://t.me/share/url?url=${encodeURIComponent('https://typemasterai.com')}&text=${encodeURIComponent(text)}`, '_blank', 'width=600,height=400');\n                      trackShare('challenge_telegram');\n                    }}\n                    className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#0088cc]/10 hover:bg-[#0088cc]/25 border border-[#0088cc]/20 transition-all\"\n                    data-testid=\"button-challenge-telegram\"\n                  >\n                    <Send className=\"w-4 h-4 text-[#0088cc]\" />\n                    <span className=\"text-xs font-medium\">Telegram</span>\n                  </button>\n                  <button\n                    onClick={() => {\n                      const rating = getPerformanceRating();\n                      const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n                      const subject = encodeURIComponent(`ðŸŽ¯ Typing Challenge: Can you beat my ${wpm} WPM?`);\n                      const body = encodeURIComponent(`Hey!\\n\\nðŸŽ¯ I CHALLENGE YOU!\\n\\n${rating.emoji} Can you beat my typing score?\\n\\nâŒ¨ï¸ My Score: ${wpm} WPM\\nâœ¨ Accuracy: ${accuracy}%\\nâ±ï¸ ${modeDisplay} test\\nðŸ… ${rating.badge} Badge\\n\\nAccept the challenge and prove your typing skills!\\n\\nðŸ”— https://typemasterai.com\\n\\nGood luck! ðŸŽ¯`);\n                      window.open(`mailto:?subject=${subject}&body=${body}`);\n                      trackShare('challenge_email');\n                    }}\n                    className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-gray-500/10 hover:bg-gray-500/25 border border-gray-500/20 transition-all\"\n                    data-testid=\"button-challenge-email\"\n                  >\n                    <Mail className=\"w-4 h-4 text-gray-400\" />\n                    <span className=\"text-xs font-medium\">Email</span>\n                  </button>\n                </div>\n\n                {/* Copy Challenge Link */}\n                <button\n                  onClick={() => {\n                    const rating = getPerformanceRating();\n                    const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n                    const text = `ðŸŽ¯ TYPING CHALLENGE!\\n\\nCan you beat my score?\\n\\n${rating.emoji} My Score: ${wpm} WPM\\nâœ¨ Accuracy: ${accuracy}%\\nâ±ï¸ ${modeDisplay} test\\n\\nðŸ… Beat me to claim the ${rating.badge} Badge!\\n\\nðŸ”— Accept the challenge: https://typemasterai.com`;\n                    navigator.clipboard.writeText(text);\n                    toast({ title: \"Challenge Copied!\", description: \"Send it to your friends!\" });\n                    trackShare('challenge_copy');\n                  }}\n                  className=\"w-full py-3 bg-gradient-to-r from-yellow-500/10 to-orange-500/10 text-foreground font-medium rounded-xl hover:from-yellow-500/20 hover:to-orange-500/20 transition-all flex items-center justify-center gap-2 border border-yellow-500/20\"\n                  data-testid=\"button-copy-challenge\"\n                >\n                  <Copy className=\"w-4 h-4\" />\n                  Copy Challenge Message\n                </button>\n              </div>\n\n              {/* Fun Stats */}\n              <div className=\"pt-3 border-t border-border/50 text-center\">\n                <p className=\"text-xs text-muted-foreground\">\n                  {wpm >= 80 ? \"ðŸ”¥ That's faster than 95% of typists!\" : \n                   wpm >= 60 ? \"ðŸ’ª That's faster than 75% of typists!\" :\n                   wpm >= 40 ? \"âš¡ You're above average!\" : \n                   \"ðŸŒ± Keep practicing to improve!\"}\n                </p>\n              </div>\n            </TabsContent>\n          </Tabs>\n        </DialogContent>\n      </Dialog>\n      </div>\n    </TooltipProvider>\n  );\n}\n","path":null,"size_bytes":155566,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-xl border bg-card text-card-foreground shadow\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"font-semibold leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1828,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nexport class NetworkError extends Error {\n  constructor(message: string = \"Network connection lost\") {\n    super(message);\n    this.name = \"NetworkError\";\n  }\n}\n\nexport class ServerError extends Error {\n  status: number;\n  \n  constructor(status: number, message: string) {\n    super(message);\n    this.name = \"ServerError\";\n    this.status = status;\n  }\n}\n\nfunction isNetworkError(error: unknown): boolean {\n  if (error instanceof TypeError) {\n    const message = error.message.toLowerCase();\n    return (\n      message.includes('fetch') ||\n      message.includes('network') ||\n      message.includes('failed to fetch') ||\n      message.includes('load failed') ||\n      message.includes('networkerror')\n    );\n  }\n  return error instanceof NetworkError;\n}\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new ServerError(res.status, `${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  try {\n    const res = await fetch(url, {\n      method,\n      headers: data ? { \"Content-Type\": \"application/json\" } : {},\n      body: data ? JSON.stringify(data) : undefined,\n      credentials: \"include\",\n    });\n\n    await throwIfResNotOk(res);\n    return res;\n  } catch (error) {\n    if (isNetworkError(error)) {\n      throw new NetworkError(\"Unable to connect. Please check your internet connection.\");\n    }\n    throw error;\n  }\n}\n\nexport async function apiRequestWithRetry(\n  method: string,\n  url: string,\n  data?: unknown,\n  options: { maxRetries?: number; retryDelay?: number } = {}\n): Promise<Response> {\n  const { maxRetries = 2, retryDelay = 1000 } = options;\n  let lastError: Error | null = null;\n  \n  for (let attempt = 0; attempt <= maxRetries; attempt++) {\n    try {\n      return await apiRequest(method, url, data);\n    } catch (error) {\n      lastError = error as Error;\n      \n      if (!isNetworkError(error) || attempt === maxRetries) {\n        throw error;\n      }\n      \n      await new Promise(resolve => setTimeout(resolve, retryDelay * (attempt + 1)));\n    }\n  }\n  \n  throw lastError;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    try {\n      const res = await fetch(queryKey.join(\"/\") as string, {\n        credentials: \"include\",\n      });\n\n      if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n        return null;\n      }\n\n      await throwIfResNotOk(res);\n      return await res.json();\n    } catch (error) {\n      if (isNetworkError(error)) {\n        throw new NetworkError(\"Unable to connect. Please check your internet connection.\");\n      }\n      throw error;\n    }\n  };\n\nfunction shouldRetryOnError(error: unknown): boolean {\n  if (isNetworkError(error)) {\n    return navigator.onLine;\n  }\n  \n  if (error instanceof ServerError) {\n    return error.status >= 500 && error.status < 600;\n  }\n  \n  return false;\n}\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: (failureCount, error) => {\n        if (failureCount >= 2) return false;\n        return shouldRetryOnError(error);\n      },\n      retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 10000),\n      networkMode: 'online',\n    },\n    mutations: {\n      retry: (failureCount, error) => {\n        if (failureCount >= 1) return false;\n        return shouldRetryOnError(error);\n      },\n      retryDelay: 1000,\n      networkMode: 'online',\n    },\n  },\n});\n\nexport { isNetworkError };\n","path":null,"size_bytes":3900,"size_tokens":null},"client/src/components/ui/button-group.tsx":{"content":"import { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Separator } from \"@/components/ui/separator\"\n\nconst buttonGroupVariants = cva(\n  \"flex w-fit items-stretch has-[>[data-slot=button-group]]:gap-2 [&>*]:focus-visible:relative [&>*]:focus-visible:z-10 has-[select[aria-hidden=true]:last-child]:[&>[data-slot=select-trigger]:last-of-type]:rounded-r-md [&>[data-slot=select-trigger]:not([class*='w-'])]:w-fit [&>input]:flex-1\",\n  {\n    variants: {\n      orientation: {\n        horizontal:\n          \"[&>*:not(:first-child)]:rounded-l-none [&>*:not(:first-child)]:border-l-0 [&>*:not(:last-child)]:rounded-r-none\",\n        vertical:\n          \"flex-col [&>*:not(:first-child)]:rounded-t-none [&>*:not(:first-child)]:border-t-0 [&>*:not(:last-child)]:rounded-b-none\",\n      },\n    },\n    defaultVariants: {\n      orientation: \"horizontal\",\n    },\n  }\n)\n\nfunction ButtonGroup({\n  className,\n  orientation,\n  ...props\n}: React.ComponentProps<\"div\"> & VariantProps<typeof buttonGroupVariants>) {\n  return (\n    <div\n      role=\"group\"\n      data-slot=\"button-group\"\n      data-orientation={orientation}\n      className={cn(buttonGroupVariants({ orientation }), className)}\n      {...props}\n    />\n  )\n}\n\nfunction ButtonGroupText({\n  className,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"div\"> & {\n  asChild?: boolean\n}) {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      className={cn(\n        \"bg-muted shadow-xs flex items-center gap-2 rounded-md border px-4 text-sm font-medium [&_svg:not([class*='size-'])]:size-4 [&_svg]:pointer-events-none\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction ButtonGroupSeparator({\n  className,\n  orientation = \"vertical\",\n  ...props\n}: React.ComponentProps<typeof Separator>) {\n  return (\n    <Separator\n      data-slot=\"button-group-separator\"\n      orientation={orientation}\n      className={cn(\n        \"bg-input relative !m-0 self-stretch data-[orientation=vertical]:h-auto\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nexport {\n  ButtonGroup,\n  ButtonGroupSeparator,\n  ButtonGroupText,\n  buttonGroupVariants,\n}\n","path":null,"size_bytes":2209,"size_tokens":null},"client/src/components/error-boundary.tsx":{"content":"import React, { Component, ReactNode, useEffect, useState } from \"react\";\nimport { AlertTriangle, RefreshCw, Home, Bug, ChevronDown, ChevronUp, Copy, Check } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\n\ninterface ComponentErrorInfo {\n  componentStack: string;\n}\n\ninterface ErrorReport {\n  message: string;\n  stack?: string;\n  componentStack?: string;\n  timestamp: string;\n  url: string;\n  userAgent: string;\n}\n\ninterface ErrorBoundaryProps {\n  children: ReactNode;\n  fallback?: ReactNode;\n  onError?: (error: Error, errorInfo: ComponentErrorInfo) => void;\n  onReset?: () => void;\n  showReportButton?: boolean;\n  maxRetries?: number;\n  retryDelay?: number;\n}\n\ninterface ErrorBoundaryState {\n  hasError: boolean;\n  error: Error | null;\n  errorInfo: ComponentErrorInfo | null;\n  retryCount: number;\n  isRetrying: boolean;\n  copied: boolean;\n  showDetails: boolean;\n}\n\nfunction generateErrorReport(error: Error, errorInfo?: ComponentErrorInfo | null): ErrorReport {\n  return {\n    message: error.message,\n    stack: error.stack,\n    componentStack: errorInfo?.componentStack,\n    timestamp: new Date().toISOString(),\n    url: window.location.href,\n    userAgent: navigator.userAgent,\n  };\n}\n\nexport class ErrorBoundary extends Component<ErrorBoundaryProps, ErrorBoundaryState> {\n  private retryTimeoutId: NodeJS.Timeout | null = null;\n\n  static defaultProps = {\n    showReportButton: true,\n    maxRetries: 2,\n    retryDelay: 1000,\n  };\n\n  constructor(props: ErrorBoundaryProps) {\n    super(props);\n    this.state = {\n      hasError: false,\n      error: null,\n      errorInfo: null,\n      retryCount: 0,\n      isRetrying: false,\n      copied: false,\n      showDetails: false,\n    };\n  }\n\n  static getDerivedStateFromError(error: Error): Partial<ErrorBoundaryState> {\n    return { hasError: true, error };\n  }\n\n  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {\n    console.error(\"ErrorBoundary caught an error:\", error, errorInfo);\n    \n    this.setState({ errorInfo: errorInfo as unknown as ComponentErrorInfo });\n    \n    this.props.onError?.(error, errorInfo as unknown as ComponentErrorInfo);\n    \n    if (process.env.NODE_ENV === \"production\") {\n      this.reportError(error, errorInfo as unknown as ComponentErrorInfo);\n    }\n  }\n\n  componentWillUnmount() {\n    if (this.retryTimeoutId) {\n      clearTimeout(this.retryTimeoutId);\n    }\n  }\n\n  private async reportError(error: Error, errorInfo: ComponentErrorInfo) {\n    try {\n      const report = generateErrorReport(error, errorInfo);\n      \n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 5000);\n      \n      await fetch(\"/api/error-report\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          error: {\n            message: report.message?.slice(0, 500),\n            code: \"REACT_ERROR\",\n          },\n          timestamp: report.timestamp,\n          url: report.url?.replace(/[?#].*$/, ''),\n        }),\n        signal: controller.signal,\n      }).finally(() => clearTimeout(timeoutId));\n    } catch {\n    }\n  }\n\n  private handleRetry = () => {\n    const { maxRetries = 2, retryDelay = 1000 } = this.props;\n    const { retryCount } = this.state;\n\n    if (retryCount >= maxRetries) {\n      return;\n    }\n\n    this.setState({ isRetrying: true });\n\n    const delay = retryDelay * Math.pow(2, retryCount);\n\n    this.retryTimeoutId = setTimeout(() => {\n      this.setState({\n        hasError: false,\n        error: null,\n        errorInfo: null,\n        isRetrying: false,\n        retryCount: retryCount + 1,\n      });\n      this.props.onReset?.();\n    }, delay);\n  };\n\n  private handleReset = () => {\n    this.setState({\n      hasError: false,\n      error: null,\n      errorInfo: null,\n      retryCount: 0,\n      isRetrying: false,\n    });\n    this.props.onReset?.();\n  };\n\n  private handleGoHome = () => {\n    window.location.href = \"/\";\n  };\n\n  private handleReload = () => {\n    window.location.reload();\n  };\n\n  private handleCopyError = async () => {\n    const { error, errorInfo } = this.state;\n    if (!error) return;\n\n    const report = generateErrorReport(error, errorInfo);\n    const text = JSON.stringify(report, null, 2);\n\n    try {\n      await navigator.clipboard.writeText(text);\n      this.setState({ copied: true });\n      setTimeout(() => this.setState({ copied: false }), 2000);\n    } catch {\n    }\n  };\n\n  private handleToggleDetails = () => {\n    this.setState((prev) => ({ showDetails: !prev.showDetails }));\n  };\n\n  render() {\n    const { hasError, error, errorInfo, retryCount, isRetrying, copied, showDetails } = this.state;\n    const { children, fallback, maxRetries = 2 } = this.props;\n\n    if (!hasError) {\n      return children;\n    }\n\n    if (fallback) {\n      return fallback;\n    }\n\n    const canRetry = retryCount < maxRetries;\n    const isDev = process.env.NODE_ENV === \"development\";\n\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-background p-4\">\n        <Card className=\"w-full max-w-lg\">\n          <CardHeader className=\"text-center\">\n            <div className=\"flex justify-center mb-4\">\n              <div className=\"rounded-full bg-destructive/10 p-4\">\n                <AlertTriangle className=\"h-12 w-12 text-destructive\" />\n              </div>\n            </div>\n            <CardTitle className=\"text-2xl\">Something went wrong</CardTitle>\n            <CardDescription>\n              We encountered an unexpected error. Don't worry, your data is safe.\n            </CardDescription>\n          </CardHeader>\n\n          <CardContent className=\"space-y-4\">\n            {retryCount > 0 && (\n              <p className=\"text-sm text-muted-foreground text-center\">\n                Retry attempt {retryCount} of {maxRetries}\n              </p>\n            )}\n\n            {isDev && error && (\n              <div>\n                <Button \n                  variant=\"ghost\" \n                  className=\"w-full justify-between\" \n                  onClick={this.handleToggleDetails}\n                  data-testid=\"button-toggle-error-details\"\n                >\n                  <span className=\"flex items-center gap-2\">\n                    <Bug className=\"h-4 w-4\" />\n                    Error Details\n                  </span>\n                  {showDetails ? (\n                    <ChevronUp className=\"h-4 w-4\" />\n                  ) : (\n                    <ChevronDown className=\"h-4 w-4\" />\n                  )}\n                </Button>\n                {showDetails && (\n                  <div className=\"bg-muted/50 p-4 rounded-lg mt-2 space-y-2\">\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-xs text-muted-foreground\">Error message</span>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={this.handleCopyError}\n                        className=\"h-6 px-2\"\n                        data-testid=\"button-copy-error\"\n                      >\n                        {copied ? (\n                          <Check className=\"h-3 w-3\" />\n                        ) : (\n                          <Copy className=\"h-3 w-3\" />\n                        )}\n                      </Button>\n                    </div>\n                    <p className=\"text-sm font-mono text-destructive break-all\">\n                      {error.message}\n                    </p>\n                    {error.stack && (\n                      <pre className=\"text-xs font-mono text-muted-foreground overflow-auto max-h-40 mt-2\">\n                        {error.stack}\n                      </pre>\n                    )}\n                  </div>\n                )}\n              </div>\n            )}\n          </CardContent>\n\n          <CardFooter className=\"flex flex-col gap-3\">\n            <div className=\"flex gap-3 w-full\">\n              {canRetry && (\n                <Button\n                  onClick={this.handleRetry}\n                  disabled={isRetrying}\n                  className=\"flex-1\"\n                  data-testid=\"button-retry\"\n                >\n                  {isRetrying ? (\n                    <>\n                      <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n                      Retrying...\n                    </>\n                  ) : (\n                    <>\n                      <RefreshCw className=\"h-4 w-4 mr-2\" />\n                      Try Again\n                    </>\n                  )}\n                </Button>\n              )}\n              <Button\n                variant=\"outline\"\n                onClick={this.handleReload}\n                className=\"flex-1\"\n                data-testid=\"button-reload\"\n              >\n                Reload Page\n              </Button>\n            </div>\n            <Button\n              variant=\"ghost\"\n              onClick={this.handleGoHome}\n              className=\"w-full\"\n              data-testid=\"button-go-home\"\n            >\n              <Home className=\"h-4 w-4 mr-2\" />\n              Go to Home\n            </Button>\n          </CardFooter>\n        </Card>\n      </div>\n    );\n  }\n}\n\ninterface AsyncErrorBoundaryProps {\n  children: ReactNode;\n  fallback?: ReactNode;\n  onError?: (error: Error) => void;\n}\n\nexport function AsyncErrorBoundary({ children, fallback, onError }: AsyncErrorBoundaryProps) {\n  const [error, setError] = useState<Error | null>(null);\n\n  useEffect(() => {\n    const handleUnhandledRejection = (event: PromiseRejectionEvent) => {\n      const error = event.reason instanceof Error \n        ? event.reason \n        : new Error(String(event.reason));\n      \n      console.error(\"Unhandled promise rejection:\", error);\n      setError(error);\n      onError?.(error);\n    };\n\n    const handleError = (event: ErrorEvent) => {\n      console.error(\"Unhandled error:\", event.error);\n      setError(event.error || new Error(event.message));\n      onError?.(event.error || new Error(event.message));\n    };\n\n    window.addEventListener(\"unhandledrejection\", handleUnhandledRejection);\n    window.addEventListener(\"error\", handleError);\n\n    return () => {\n      window.removeEventListener(\"unhandledrejection\", handleUnhandledRejection);\n      window.removeEventListener(\"error\", handleError);\n    };\n  }, [onError]);\n\n  if (error) {\n    if (fallback) {\n      return <>{fallback}</>;\n    }\n\n    return (\n      <ErrorBoundary>\n        <ErrorThrower error={error} />\n      </ErrorBoundary>\n    );\n  }\n\n  return <>{children}</>;\n}\n\nfunction ErrorThrower({ error }: { error: Error }): never {\n  throw error;\n}\n\nexport function withErrorBoundary<P extends object>(\n  WrappedComponent: React.ComponentType<P>,\n  errorBoundaryProps?: Omit<ErrorBoundaryProps, \"children\">\n) {\n  const WithErrorBoundary = (props: P) => (\n    <ErrorBoundary {...errorBoundaryProps}>\n      <WrappedComponent {...props} />\n    </ErrorBoundary>\n  );\n\n  WithErrorBoundary.displayName = `WithErrorBoundary(${\n    WrappedComponent.displayName || WrappedComponent.name || \"Component\"\n  })`;\n\n  return WithErrorBoundary;\n}\n","path":null,"size_bytes":11239,"size_tokens":null},"client/src/components/badge-card.tsx":{"content":"import { Badge } from \"@/components/ui/badge\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Lock, Zap, Target, Flame, TrendingUp, Star, Award, Share2, Moon, Sunrise, Rocket, Sparkles, Timer, HelpCircle } from \"lucide-react\";\nimport { getTierColor, getTierBorder, getCategoryColor, type Badge as BadgeType } from \"@shared/badges\";\nimport { cn } from \"@/lib/utils\";\n\nconst tierDescriptions: Record<string, string> = {\n  bronze: \"Entry-level achievement - Great start!\",\n  silver: \"Intermediate milestone - Keep going!\",\n  gold: \"Advanced accomplishment - Impressive!\",\n  platinum: \"Expert-level mastery - Outstanding!\",\n  diamond: \"Ultimate achievement - Legendary!\",\n};\n\nconst categoryTips: Record<string, string> = {\n  speed: \"Practice regularly to increase your typing speed\",\n  accuracy: \"Focus on precision over speed to unlock these\",\n  consistency: \"Keep taking tests to build your practice habit\",\n  streak: \"Type every day to maintain and grow your streak\",\n  special: \"Complete unique challenges to unlock these\",\n  secret: \"Hidden achievements - explore to discover them!\",\n};\n\nconst iconMap: Record<string, React.ComponentType<{ className?: string }>> = {\n  Zap,\n  Target,\n  Flame,\n  TrendingUp,\n  Star,\n  Award,\n  Share2,\n  Moon,\n  Sunrise,\n  Rocket,\n  Sparkles,\n  Timer,\n};\n\ninterface BadgeCardProps {\n  badge: BadgeType;\n  unlocked: boolean;\n  progress?: number;\n  currentValue?: number;\n  unlockedAt?: string;\n  onShare?: (badge: BadgeType) => void;\n}\n\nexport function BadgeCard({ badge, unlocked, progress = 0, currentValue = 0, unlockedAt, onShare }: BadgeCardProps) {\n  const isAlmostUnlocked = !unlocked && progress >= 50;\n  const IconComponent = iconMap[badge.icon] || Star;\n  const isSecret = badge.isSecret === true;\n  const isHiddenSecret = isSecret && !unlocked;\n\n  const tooltipContent = isHiddenSecret ? (\n    <div className=\"space-y-2 max-w-xs\">\n      <p className=\"font-semibold text-indigo-400\">Secret Badge</p>\n      <p className=\"text-xs text-muted-foreground\">\n        This is a hidden achievement. Keep exploring different ways to practice typing to discover it!\n      </p>\n      <div className=\"flex items-center gap-2 pt-1\">\n        <Badge variant=\"outline\" className=\"text-[10px] border-indigo-500/50 text-indigo-400\">\n          ???\n        </Badge>\n        <span className=\"text-xs text-muted-foreground\">??? XP</span>\n      </div>\n    </div>\n  ) : (\n    <div className=\"space-y-2 max-w-xs\">\n      <p className=\"font-semibold\">{badge.name}</p>\n      <p className=\"text-xs text-muted-foreground\">{badge.description}</p>\n      <div className=\"flex items-center gap-2 pt-1 flex-wrap\">\n        <Badge \n          variant=\"outline\" \n          className=\"text-[10px] capitalize\"\n          style={{ borderColor: badge.color, color: badge.color }}\n        >\n          {badge.tier}\n        </Badge>\n        <Badge variant=\"secondary\" className=\"text-[10px] capitalize\">\n          {badge.category}\n        </Badge>\n        <span className={cn(\"text-xs font-medium\", getCategoryColor(badge.category))}>\n          +{badge.points} XP\n        </span>\n      </div>\n      <p className=\"text-[10px] text-muted-foreground italic pt-1\">\n        {tierDescriptions[badge.tier]}\n      </p>\n      {!unlocked && (\n        <p className=\"text-[10px] text-primary/80 pt-1\">\n          {categoryTips[badge.category]}\n        </p>\n      )}\n      {unlocked && unlockedAt && (\n        <p className=\"text-[10px] text-green-500/80 pt-1\">\n          Unlocked on {new Date(unlockedAt).toLocaleDateString()}\n        </p>\n      )}\n    </div>\n  );\n\n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>\n        <Card\n          className={cn(\n        \"relative p-4 transition-all duration-300\",\n        unlocked\n          ? `border-2 ${getTierBorder(badge.tier)} bg-gradient-to-br ${getTierColor(badge.tier)} bg-opacity-10 hover:scale-105 shadow-lg`\n          : isHiddenSecret\n            ? \"border border-dashed border-indigo-500/50 bg-gradient-to-br from-indigo-950/20 to-purple-950/20 hover:border-indigo-400/70\"\n            : \"border border-border/50 bg-muted/30 opacity-70 hover:opacity-90\",\n        isAlmostUnlocked && !isHiddenSecret && \"animate-pulse\"\n      )}\n      data-testid={`badge-${badge.id}`}\n    >\n      <div className=\"absolute top-2 right-2\">\n        <Badge\n          variant={unlocked ? \"default\" : \"secondary\"}\n          className={cn(\n            \"text-[10px] px-2 py-0.5\",\n            unlocked && `bg-gradient-to-r ${getTierColor(badge.tier)} border-0 text-white`,\n            isHiddenSecret && \"bg-indigo-500/20 text-indigo-400 border-indigo-500/30\"\n          )}\n        >\n          {isHiddenSecret ? \"???\" : badge.tier.toUpperCase()}\n        </Badge>\n      </div>\n\n      <div className=\"flex flex-col items-center justify-center space-y-3\">\n        <div\n          className={cn(\n            \"w-20 h-20 rounded-full flex items-center justify-center\",\n            unlocked\n              ? `bg-gradient-to-br ${getTierColor(badge.tier)} shadow-md`\n              : isHiddenSecret\n                ? \"bg-gradient-to-br from-indigo-600/30 to-purple-600/30 animate-pulse\"\n                : \"bg-muted/50\"\n          )}\n        >\n          {unlocked ? (\n            <IconComponent className=\"w-10 h-10 text-white drop-shadow-lg\" />\n          ) : isHiddenSecret ? (\n            <HelpCircle className=\"w-10 h-10 text-indigo-400\" />\n          ) : (\n            <Lock className=\"w-8 h-8 text-muted-foreground\" />\n          )}\n        </div>\n\n        <div className=\"text-center space-y-1\">\n          <h3 className={cn(\n            \"font-bold text-sm\", \n            unlocked ? \"text-foreground\" : isHiddenSecret ? \"text-indigo-400\" : \"text-muted-foreground\"\n          )}>\n            {isHiddenSecret ? \"???\" : badge.name}\n          </h3>\n          <p className={cn(\n            \"text-xs line-clamp-2\",\n            isHiddenSecret ? \"text-indigo-400/70 italic\" : \"text-muted-foreground\"\n          )}>\n            {isHiddenSecret ? \"Unlock to reveal this secret badge!\" : badge.description}\n          </p>\n        </div>\n\n        {!unlocked && progress > 0 && (\n          <div className=\"w-full space-y-1\">\n            <div className=\"flex justify-between text-xs text-muted-foreground\">\n              <span>Progress</span>\n              <span>\n                {currentValue} / {badge.requirement.value}\n              </span>\n            </div>\n            <div className=\"w-full h-2 bg-secondary rounded-full overflow-hidden\">\n              <div\n                className={cn(\n                  \"h-full transition-all duration-500\",\n                  progress >= 75\n                    ? \"bg-gradient-to-r from-green-500 to-emerald-500\"\n                    : progress >= 50\n                    ? \"bg-gradient-to-r from-yellow-500 to-orange-500\"\n                    : \"bg-gradient-to-r from-blue-500 to-cyan-500\"\n                )}\n                style={{ width: `${Math.min(progress, 100)}%` }}\n              />\n            </div>\n          </div>\n        )}\n\n        {unlocked && (\n          <div className=\"flex flex-col items-center gap-1\">\n            <div className=\"flex items-center gap-1 text-xs text-green-500 font-semibold\">\n              <span className=\"text-base\">âœ“</span>\n              Unlocked\n            </div>\n            {unlockedAt && (\n              <span className=\"text-[10px] text-muted-foreground\">\n                {new Date(unlockedAt).toLocaleDateString()}\n              </span>\n            )}\n            {onShare && (\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"h-6 px-2 text-[10px] text-muted-foreground hover:text-primary mt-1\"\n                onClick={(e) => {\n                  e.stopPropagation();\n                  onShare(badge);\n                }}\n                data-testid={`button-share-badge-${badge.id}`}\n              >\n                <Share2 className=\"w-3 h-3 mr-1\" />\n                Share\n              </Button>\n            )}\n          </div>\n        )}\n\n        <div className={cn(\"text-xs font-semibold\", getCategoryColor(badge.category))}>\n          +{badge.points} XP\n        </div>\n      </div>\n        </Card>\n      </TooltipTrigger>\n      <TooltipContent side=\"top\" className=\"p-3\">\n        {tooltipContent}\n      </TooltipContent>\n    </Tooltip>\n  );\n}\n","path":null,"size_bytes":8422,"size_tokens":null},"shared/badges.ts":{"content":"export interface Badge {\n  id: string;\n  name: string;\n  description: string;\n  icon: string;\n  category: \"speed\" | \"accuracy\" | \"consistency\" | \"streak\" | \"special\" | \"secret\";\n  tier: \"bronze\" | \"silver\" | \"gold\" | \"platinum\" | \"diamond\";\n  points: number;\n  color: string;\n  requirement: {\n    type: \"wpm\" | \"accuracy\" | \"testCount\" | \"streak\" | \"special\" | \"shares\" | \"secret\";\n    value: number;\n  };\n  isSecret?: boolean;\n}\n\nexport const BADGES: Badge[] = [\n  // Speed Achievements (5)\n  {\n    id: \"speed_rookie_30\",\n    name: \"Speed Rookie\",\n    description: \"Reach 30 WPM\",\n    icon: \"Zap\",\n    category: \"speed\",\n    tier: \"bronze\",\n    points: 10,\n    color: \"amber\",\n    requirement: { type: \"wpm\", value: 30 },\n  },\n  {\n    id: \"speed_novice_50\",\n    name: \"Speed Novice\",\n    description: \"Reach 50 WPM\",\n    icon: \"Zap\",\n    category: \"speed\",\n    tier: \"silver\",\n    points: 25,\n    color: \"amber\",\n    requirement: { type: \"wpm\", value: 50 },\n  },\n  {\n    id: \"speed_expert_80\",\n    name: \"Speed Expert\",\n    description: \"Reach 80 WPM\",\n    icon: \"Zap\",\n    category: \"speed\",\n    tier: \"gold\",\n    points: 50,\n    color: \"amber\",\n    requirement: { type: \"wpm\", value: 80 },\n  },\n  {\n    id: \"speed_master_100\",\n    name: \"Speed Master\",\n    description: \"Reach 100 WPM\",\n    icon: \"Zap\",\n    category: \"speed\",\n    tier: \"platinum\",\n    points: 100,\n    color: \"amber\",\n    requirement: { type: \"wpm\", value: 100 },\n  },\n  {\n    id: \"speed_legend_120\",\n    name: \"Speed Legend\",\n    description: \"Reach 120 WPM\",\n    icon: \"Zap\",\n    category: \"speed\",\n    tier: \"diamond\",\n    points: 200,\n    color: \"amber\",\n    requirement: { type: \"wpm\", value: 120 },\n  },\n\n  // Accuracy Achievements (3)\n  {\n    id: \"accuracy_precise_95\",\n    name: \"Precision Seeker\",\n    description: \"Achieve 95% accuracy\",\n    icon: \"Target\",\n    category: \"accuracy\",\n    tier: \"bronze\",\n    points: 15,\n    color: \"blue\",\n    requirement: { type: \"accuracy\", value: 95 },\n  },\n  {\n    id: \"accuracy_perfect_98\",\n    name: \"Near Perfect\",\n    description: \"Achieve 98% accuracy\",\n    icon: \"Target\",\n    category: \"accuracy\",\n    tier: \"gold\",\n    points: 75,\n    color: \"blue\",\n    requirement: { type: \"accuracy\", value: 98 },\n  },\n  {\n    id: \"accuracy_flawless_100\",\n    name: \"Flawless Typist\",\n    description: \"Achieve 100% accuracy in a single test\",\n    icon: \"Target\",\n    category: \"accuracy\",\n    tier: \"diamond\",\n    points: 250,\n    color: \"blue\",\n    requirement: { type: \"accuracy\", value: 100 },\n  },\n\n  // Streak Achievements (4)\n  {\n    id: \"streak_committed_7\",\n    name: \"Week Warrior\",\n    description: \"Maintain a 7-day streak\",\n    icon: \"Flame\",\n    category: \"streak\",\n    tier: \"bronze\",\n    points: 20,\n    color: \"orange\",\n    requirement: { type: \"streak\", value: 7 },\n  },\n  {\n    id: \"streak_dedicated_30\",\n    name: \"Monthly Dedication\",\n    description: \"Maintain a 30-day streak\",\n    icon: \"Flame\",\n    category: \"streak\",\n    tier: \"silver\",\n    points: 50,\n    color: \"orange\",\n    requirement: { type: \"streak\", value: 30 },\n  },\n  {\n    id: \"streak_master_100\",\n    name: \"Streak Master\",\n    description: \"Maintain a 100-day streak\",\n    icon: \"Flame\",\n    category: \"streak\",\n    tier: \"gold\",\n    points: 150,\n    color: \"orange\",\n    requirement: { type: \"streak\", value: 100 },\n  },\n  {\n    id: \"streak_legend_365\",\n    name: \"Year-Long Dedication\",\n    description: \"Maintain a 365-day streak\",\n    icon: \"Flame\",\n    category: \"streak\",\n    tier: \"diamond\",\n    points: 500,\n    color: \"orange\",\n    requirement: { type: \"streak\", value: 365 },\n  },\n\n  // Consistency Achievements (5)\n  {\n    id: \"consistency_beginner_10\",\n    name: \"Getting Started\",\n    description: \"Complete 10 tests\",\n    icon: \"TrendingUp\",\n    category: \"consistency\",\n    tier: \"bronze\",\n    points: 10,\n    color: \"green\",\n    requirement: { type: \"testCount\", value: 10 },\n  },\n  {\n    id: \"consistency_regular_50\",\n    name: \"Regular Typist\",\n    description: \"Complete 50 tests\",\n    icon: \"TrendingUp\",\n    category: \"consistency\",\n    tier: \"silver\",\n    points: 25,\n    color: \"green\",\n    requirement: { type: \"testCount\", value: 50 },\n  },\n  {\n    id: \"consistency_dedicated_100\",\n    name: \"Dedicated Practitioner\",\n    description: \"Complete 100 tests\",\n    icon: \"TrendingUp\",\n    category: \"consistency\",\n    tier: \"gold\",\n    points: 50,\n    color: \"green\",\n    requirement: { type: \"testCount\", value: 100 },\n  },\n  {\n    id: \"consistency_veteran_500\",\n    name: \"Typing Veteran\",\n    description: \"Complete 500 tests\",\n    icon: \"TrendingUp\",\n    category: \"consistency\",\n    tier: \"platinum\",\n    points: 150,\n    color: \"green\",\n    requirement: { type: \"testCount\", value: 500 },\n  },\n  {\n    id: \"consistency_master_1000\",\n    name: \"Typing Master\",\n    description: \"Complete 1000 tests\",\n    icon: \"TrendingUp\",\n    category: \"consistency\",\n    tier: \"diamond\",\n    points: 300,\n    color: \"green\",\n    requirement: { type: \"testCount\", value: 1000 },\n  },\n\n  // Special Achievements (5)\n  {\n    id: \"special_first_test\",\n    name: \"First Steps\",\n    description: \"Complete your first typing test\",\n    icon: \"Star\",\n    category: \"special\",\n    tier: \"bronze\",\n    points: 5,\n    color: \"purple\",\n    requirement: { type: \"testCount\", value: 1 },\n  },\n  {\n    id: \"special_speed_accuracy\",\n    name: \"Speed & Precision\",\n    description: \"Achieve 80 WPM with 95% accuracy in one test\",\n    icon: \"Award\",\n    category: \"special\",\n    tier: \"platinum\",\n    points: 200,\n    color: \"purple\",\n    requirement: { type: \"special\", value: 0 },\n  },\n  {\n    id: \"social_first_share\",\n    name: \"Social Butterfly\",\n    description: \"Share your first typing result\",\n    icon: \"Share2\",\n    category: \"special\",\n    tier: \"bronze\",\n    points: 15,\n    color: \"cyan\",\n    requirement: { type: \"shares\", value: 1 },\n  },\n  {\n    id: \"social_sharer_10\",\n    name: \"Community Champion\",\n    description: \"Share 10 typing results\",\n    icon: \"Share2\",\n    category: \"special\",\n    tier: \"silver\",\n    points: 50,\n    color: \"cyan\",\n    requirement: { type: \"shares\", value: 10 },\n  },\n  {\n    id: \"social_influencer_25\",\n    name: \"Typing Influencer\",\n    description: \"Share 25 typing results\",\n    icon: \"Share2\",\n    category: \"special\",\n    tier: \"gold\",\n    points: 100,\n    color: \"cyan\",\n    requirement: { type: \"shares\", value: 25 },\n  },\n\n  // Secret Achievements (5) - Hidden until unlocked\n  {\n    id: \"secret_night_owl\",\n    name: \"Night Owl\",\n    description: \"Complete a test between midnight and 4 AM\",\n    icon: \"Moon\",\n    category: \"secret\",\n    tier: \"gold\",\n    points: 75,\n    color: \"indigo\",\n    requirement: { type: \"secret\", value: 0 },\n    isSecret: true,\n  },\n  {\n    id: \"secret_early_bird\",\n    name: \"Early Bird\",\n    description: \"Complete a test between 5 AM and 7 AM\",\n    icon: \"Sunrise\",\n    category: \"secret\",\n    tier: \"gold\",\n    points: 75,\n    color: \"yellow\",\n    requirement: { type: \"secret\", value: 0 },\n    isSecret: true,\n  },\n  {\n    id: \"secret_speed_demon\",\n    name: \"Speed Demon\",\n    description: \"Achieve 100+ WPM within your first 10 tests\",\n    icon: \"Rocket\",\n    category: \"secret\",\n    tier: \"platinum\",\n    points: 150,\n    color: \"red\",\n    requirement: { type: \"secret\", value: 0 },\n    isSecret: true,\n  },\n  {\n    id: \"secret_perfectionist\",\n    name: \"Perfectionist\",\n    description: \"Get 100% accuracy 5 times in a row\",\n    icon: \"Sparkles\",\n    category: \"secret\",\n    tier: \"diamond\",\n    points: 200,\n    color: \"pink\",\n    requirement: { type: \"secret\", value: 5 },\n    isSecret: true,\n  },\n  {\n    id: \"secret_marathon_runner\",\n    name: \"Marathon Runner\",\n    description: \"Complete 10 tests in a single day\",\n    icon: \"Timer\",\n    category: \"secret\",\n    tier: \"gold\",\n    points: 100,\n    color: \"emerald\",\n    requirement: { type: \"secret\", value: 10 },\n    isSecret: true,\n  },\n];\n\nexport function getTierColor(tier: Badge[\"tier\"]): string {\n  switch (tier) {\n    case \"bronze\":\n      return \"from-amber-600 to-amber-800\";\n    case \"silver\":\n      return \"from-slate-300 to-slate-500\";\n    case \"gold\":\n      return \"from-yellow-400 to-yellow-600\";\n    case \"platinum\":\n      return \"from-cyan-300 to-cyan-500\";\n    case \"diamond\":\n      return \"from-purple-400 to-pink-500\";\n  }\n}\n\nexport function getTierBorder(tier: Badge[\"tier\"]): string {\n  switch (tier) {\n    case \"bronze\":\n      return \"border-amber-600\";\n    case \"silver\":\n      return \"border-slate-400\";\n    case \"gold\":\n      return \"border-yellow-500\";\n    case \"platinum\":\n      return \"border-cyan-400\";\n    case \"diamond\":\n      return \"border-purple-400\";\n  }\n}\n\nexport function getCategoryColor(category: Badge[\"category\"]): string {\n  switch (category) {\n    case \"speed\":\n      return \"text-amber-500\";\n    case \"accuracy\":\n      return \"text-blue-500\";\n    case \"consistency\":\n      return \"text-green-500\";\n    case \"streak\":\n      return \"text-orange-500\";\n    case \"special\":\n      return \"text-purple-500\";\n    case \"secret\":\n      return \"text-indigo-500\";\n  }\n}\n\nexport interface UserBadgeProgress {\n  badge: Badge;\n  unlocked: boolean;\n  unlockedAt?: string;\n  progress: number;\n  currentValue: number;\n  requiredValue: number;\n}\n\nexport function getBadgeById(id: string): Badge | undefined {\n  return BADGES.find(b => b.id === id);\n}\n\nexport const TOTAL_BADGES = BADGES.length;\n","path":null,"size_bytes":9367,"size_tokens":null},"client/src/pages/analytics.tsx":{"content":"import { useEffect, useState, useMemo, useCallback, Component, ReactNode, ErrorInfo } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as ChartTooltip, Legend, ResponsiveContainer, Area, AreaChart } from \"recharts\";\nimport { TrendingUp, TrendingDown, Target, Keyboard, Calendar, Sparkles, Brain, Loader2, AlertTriangle, RefreshCw, LogIn, Info, WifiOff, Clock, HelpCircle } from \"lucide-react\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { toast } from \"sonner\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { format, parseISO, isValid } from \"date-fns\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Link } from \"wouter\";\n\n// ============================================================================\n// ANALYTICS CONFIGURATION - Centralized, production-ready settings\n// ============================================================================\n\nconst ANALYTICS_CONFIG = {\n  // Time range options (in days) - sorted ascending\n  timeRangeOptions: [7, 14, 30, 60, 90] as const,\n  defaultTimeRange: 30,\n  \n  // AI Configuration\n  ai: {\n    timeoutMs: 45000,\n    maxRetries: 2,\n  },\n  \n  // Display limits - how many items to show in various contexts\n  limits: {\n    insightsDisplay: 10,\n    mistakeKeysInPrompt: 8,\n    mistakeKeysInFallback: 5,\n    mistakeKeysInWeeklyFallback: 3,\n    commonMistakesInPrompt: 8,\n    dailyExercises: 4,\n    weeklyGoals: 4,\n    keystrokeAnalyticsDepth: 10,\n    digraphsInPrompt: 5,\n  },\n  \n  // Query caching\n  cache: {\n    staleTimeMs: 30000,\n    retryCount: 2,\n  },\n  \n  // Skill level thresholds (WPM) - configurable speed tiers\n  // Based on industry research from typing.com, keybr.com, and Ratatype\n  skillThresholds: {\n    beginner: 30,       // Below this = beginner\n    developing: 40,     // 30-40 WPM\n    intermediate: 50,   // 40-50 WPM\n    advanced: 70,       // 50-70 WPM\n    expert: 90,         // 70+ WPM = expert\n  },\n  \n  // Skill level profiles with improvement rates and descriptions\n  skillProfiles: {\n    beginner: {\n      level: \"Beginner\",\n      description: \"Focus on accuracy and proper technique\",\n      improvementRates: { week1: 8, week2: 12, week3: 15 },\n    },\n    developing: {\n      level: \"Developing\",\n      description: \"Building muscle memory and speed\",\n      improvementRates: { week1: 6, week2: 10, week3: 12 },\n    },\n    intermediate: {\n      level: \"Intermediate\",\n      description: \"Refining skills and consistency\",\n      improvementRates: { week1: 5, week2: 8, week3: 10 },\n    },\n    advanced: {\n      level: \"Advanced\",\n      description: \"Optimizing for peak performance\",\n      improvementRates: { week1: 4, week2: 6, week3: 8 },\n    },\n    expert: {\n      level: \"Expert\",\n      description: \"Maintaining excellence and precision\",\n      improvementRates: { week1: 2, week2: 4, week3: 5 },\n    },\n  },\n  \n  // Consistency thresholds\n  consistency: {\n    coefficientOfVariationThreshold: 15, // CV% above this = inconsistent\n    minStdDevFactor: 0.2, // stdDev > avgWpm * this factor = inconsistent\n    minStdDevAbsolute: 10, // Minimum absolute std dev threshold\n    excellentCV: 10, // CV% below this = excellent consistency\n  },\n  \n  // Industry-standard benchmarks for professional-grade insights\n  // Based on research from Typing.com, Monkeytype, and academic typing studies\n  benchmarks: {\n    // Average typist benchmarks (industry standard ranges)\n    wpm: {\n      average: 41,           // Average adult typing speed\n      professional: 65,      // Professional typist minimum\n      elite: 100,            // Top 1% typists\n      worldClass: 150,       // Competitive speed typing\n    },\n    accuracy: {\n      acceptable: 92,        // Minimum acceptable for work\n      good: 96,              // Good professional standard\n      excellent: 98,         // High accuracy target\n      perfect: 99.5,         // Near-perfect typing\n    },\n    consistency: {\n      excellent: 8,          // CV% - very consistent\n      good: 12,              // CV% - consistent\n      needsWork: 18,         // CV% - some variation\n      poor: 25,              // CV% - significant variation\n    },\n    // Timing benchmarks (milliseconds)\n    timing: {\n      avgFlightTime: {\n        fast: 80,            // Fast transition between keys\n        average: 120,        // Normal typing rhythm\n        slow: 180,           // Slow, deliberate typing\n      },\n      avgDwellTime: {\n        quick: 70,           // Quick key press\n        normal: 100,         // Normal key hold\n        long: 150,           // Long key press (potential issue)\n      },\n    },\n    // Fatigue indicators\n    fatigue: {\n      none: 0.05,            // <5% slowdown = no fatigue\n      mild: 0.10,            // 5-10% slowdown = mild fatigue\n      moderate: 0.20,        // 10-20% slowdown = moderate fatigue\n      significant: 0.30,     // >30% slowdown = significant fatigue\n    },\n    // Hand balance (% left hand usage - 50% is perfect balance)\n    handBalance: {\n      balanced: { min: 45, max: 55 },\n      slightImbalance: { min: 40, max: 60 },\n      imbalanced: { min: 30, max: 70 },\n    },\n    // Typing rhythm (coefficient of variation in keystroke timing)\n    rhythm: {\n      excellent: 15,         // Very consistent rhythm\n      good: 25,              // Consistent rhythm\n      irregular: 40,         // Irregular rhythm\n      erratic: 60,           // Very inconsistent\n    },\n  },\n  \n  // Finger names mapping for readable output\n  fingerNames: {\n    L_Pinky: \"Left Pinky\",\n    L_Ring: \"Left Ring\",\n    L_Middle: \"Left Middle\",\n    L_Index: \"Left Index\",\n    R_Index: \"Right Index\",\n    R_Middle: \"Right Middle\",\n    R_Ring: \"Right Ring\",\n    R_Pinky: \"Right Pinky\",\n    Thumb: \"Thumb (Space)\",\n  } as Record<string, string>,\n} as const;\n\n// Dynamic thresholds calculator - derives all thresholds from config and user data\nconst calculateDynamicThresholds = (analytics: AnalyticsData) => {\n  const avgWpm = analytics.consistency.avgWpm;\n  const stdDev = analytics.consistency.stdDeviation;\n  const wpmRange = analytics.consistency.maxWpm - analytics.consistency.minWpm;\n  \n  // Use configurable thresholds and profiles from config\n  const { skillThresholds, skillProfiles, consistency: consistencyConfig } = ANALYTICS_CONFIG;\n  \n  // Consistency calculation using config thresholds\n  const coefficientOfVariation = avgWpm > 0 ? (stdDev / avgWpm) * 100 : 0;\n  const isInconsistent = coefficientOfVariation > consistencyConfig.coefficientOfVariationThreshold \n    || stdDev > Math.max(consistencyConfig.minStdDevAbsolute, avgWpm * consistencyConfig.minStdDevFactor);\n  \n  // Determine skill profile key based on WPM thresholds\n  const getSkillProfileKey = (): keyof typeof skillProfiles => {\n    if (avgWpm < skillThresholds.beginner) return 'beginner';\n    if (avgWpm < skillThresholds.developing) return 'developing';\n    if (avgWpm < skillThresholds.intermediate) return 'intermediate';\n    if (avgWpm < skillThresholds.advanced) return 'advanced';\n    return 'expert';\n  };\n  \n  const profileKey = getSkillProfileKey();\n  const currentProfile = skillProfiles[profileKey];\n  \n  return {\n    speedThresholds: skillThresholds,\n    isInconsistent,\n    coefficientOfVariation,\n    improvementRates: currentProfile.improvementRates,\n    skillLevel: { level: currentProfile.level, description: currentProfile.description },\n    wpmRange,\n    // Dynamic accuracy threshold - lower WPM users should focus more on accuracy\n    accuracyFocus: avgWpm < skillThresholds.intermediate,\n  };\n};\n\ninterface AnalyticsData {\n  wpmOverTime: Array<{ date: string; wpm: number; accuracy: number; testCount: number }>;\n  mistakesHeatmap: Array<{ key: string; errorCount: number; totalCount: number; errorRate: number }>;\n  consistency: {\n    avgWpm: number;\n    stdDeviation: number;\n    minWpm: number;\n    maxWpm: number;\n  };\n  commonMistakes: Array<{ expectedKey: string; typedKey: string; count: number }>;\n}\n\ninterface AIInsight {\n  type: \"improvement\" | \"strength\" | \"practice\" | \"warning\" | \"milestone\";\n  category: \"speed\" | \"accuracy\" | \"rhythm\" | \"ergonomics\" | \"technique\" | \"endurance\" | \"general\";\n  message: string;\n  priority: \"critical\" | \"high\" | \"medium\" | \"low\";\n  dataPoint?: string;\n  benchmark?: string;\n  actionItem?: string;\n}\n\ninterface ComprehensiveAnalyticsPayload {\n  userProfile: {\n    skillLevel: string;\n    skillDescription: string;\n    focusArea: string;\n  };\n  coreMetrics: {\n    avgWpm: number;\n    wpmRange: { min: number; max: number };\n    consistency: { isConsistent: boolean; cvPercent: number; rating: string };\n    avgAccuracy: number | null;\n    testCount: number;\n  };\n  advancedMetrics: {\n    burstWpm: number | null;\n    adjustedWpm: number | null;\n    typingRhythm: { value: number | null; rating: string };\n    timing: {\n      avgDwellTime: { value: number | null; rating: string };\n      avgFlightTime: { value: number | null; rating: string };\n    };\n    fatigue: { indicator: number | null; rating: string };\n    errorBurstCount: number | null;\n  };\n  digraphAnalysis: {\n    fastest: string | null;\n    slowest: string | null;\n    topDigraphs: Array<{ digraph: string; avgTime: number; count: number }>;\n    bottomDigraphs: Array<{ digraph: string; avgTime: number; count: number }>;\n  };\n  ergonomics: {\n    handBalance: { value: number | null; rating: string };\n    fingerUsage: Record<string, { count: number; percentage: number }>;\n    weakestFingers: string[];\n    strongestFingers: string[];\n  };\n  problemAreas: {\n    topMistakeKeys: Array<{ key: string; errorRate: number }>;\n    commonMistakes: Array<{ expected: string; typed: string; count: number }>;\n    slowestWords: Array<{ word: string; time: number }>;\n  };\n  benchmarkComparisons: {\n    wpmVsAverage: { difference: number; percentile: string };\n    wpmVsProfessional: { difference: number; percentile: string };\n    accuracyRating: string;\n    consistencyRating: string;\n  };\n  trends: {\n    weekOverWeek: { wpm: number; accuracy: number };\n    monthOverMonth: { wpm: number; accuracy: number };\n    allTimeImprovement: number;\n  } | null;\n}\n\ninterface DailyExercise {\n  title: string;\n  description: string;\n  duration: string;\n}\n\ninterface WeeklyGoal {\n  week: string;\n  title: string;\n  tasks: string[];\n  target: string;\n  status: \"current\" | \"next\" | \"later\";\n}\n\ninterface HistoricalTrends {\n  weeklyAggregates: Array<{\n    weekStart: string;\n    weekEnd: string;\n    avgWpm: number;\n    avgAccuracy: number;\n    testCount: number;\n    bestWpm: number;\n  }>;\n  monthlyAggregates: Array<{\n    month: string;\n    avgWpm: number;\n    avgAccuracy: number;\n    testCount: number;\n    bestWpm: number;\n  }>;\n  improvement: {\n    weekOverWeek: { wpm: number; accuracy: number };\n    monthOverMonth: { wpm: number; accuracy: number };\n    allTime: { firstWpm: number; currentWpm: number; improvementPercent: number };\n  };\n  milestones: Array<{\n    type: string;\n    value: number;\n    achievedAt: string;\n  }>;\n}\n\nconst formatChartDate = (dateStr: string): string => {\n  try {\n    const date = parseISO(dateStr);\n    if (!isValid(date)) return dateStr;\n    return format(date, 'MMM d');\n  } catch {\n    return dateStr;\n  }\n};\n\nconst formatTooltipDate = (dateStr: string): string => {\n  try {\n    const date = parseISO(dateStr);\n    if (!isValid(date)) return dateStr;\n    return format(date, 'MMMM d, yyyy');\n  } catch {\n    return dateStr;\n  }\n};\n\ninterface CustomTooltipProps {\n  active?: boolean;\n  payload?: Array<{ value: number; name: string; color?: string }>;\n  label?: string;\n}\n\nconst WPMTooltip = ({ active, payload, label }: CustomTooltipProps) => {\n  if (!active || !payload || !payload.length) return null;\n  return (\n    <div className=\"bg-slate-800 border border-slate-700 rounded-lg p-3 shadow-lg\">\n      <p className=\"text-sm font-medium text-white mb-1\">{formatTooltipDate(label || '')}</p>\n      {payload.map((entry, idx) => (\n        <p key={idx} className=\"text-sm\" style={{ color: entry.color || '#00ffff' }}>\n          {entry.name === 'wpm' ? 'WPM' : entry.name}: {typeof entry.value === 'number' ? entry.value.toFixed(1) : entry.value}\n        </p>\n      ))}\n    </div>\n  );\n};\n\ninterface ExtendedTooltipProps {\n  active?: boolean;\n  payload?: Array<{ value: number; name: string; color?: string; payload?: { testCount?: number; wpm?: number; accuracy?: number } }>;\n  label?: string;\n}\n\nconst AccuracyTooltip = ({ active, payload, label }: ExtendedTooltipProps) => {\n  if (!active || !payload || !payload.length) return null;\n  const dataPoint = payload[0]?.payload;\n  return (\n    <div className=\"bg-slate-800 border border-slate-700 rounded-lg p-3 shadow-lg\">\n      <p className=\"text-sm font-medium text-white mb-1\">{formatTooltipDate(label || '')}</p>\n      {payload.map((entry, idx) => (\n        <p key={idx} className=\"text-sm\" style={{ color: entry.color || '#a855f7' }}>\n          Accuracy: {typeof entry.value === 'number' ? entry.value.toFixed(1) : entry.value}%\n        </p>\n      ))}\n      {dataPoint?.testCount && (\n        <p className=\"text-xs text-muted-foreground mt-1\">\n          Based on {dataPoint.testCount} test{dataPoint.testCount > 1 ? 's' : ''}\n        </p>\n      )}\n    </div>\n  );\n};\n\ninterface ErrorBoundaryProps {\n  children: ReactNode;\n  fallback?: ReactNode;\n}\n\ninterface ErrorBoundaryState {\n  hasError: boolean;\n  error: Error | null;\n}\n\nclass AnalyticsErrorBoundary extends Component<ErrorBoundaryProps, ErrorBoundaryState> {\n  constructor(props: ErrorBoundaryProps) {\n    super(props);\n    this.state = { hasError: false, error: null };\n  }\n\n  static getDerivedStateFromError(error: Error): ErrorBoundaryState {\n    return { hasError: true, error };\n  }\n\n  componentDidCatch(error: Error, errorInfo: ErrorInfo) {\n    console.error('Analytics Error:', error, errorInfo);\n  }\n\n  handleRetry = () => {\n    this.setState({ hasError: false, error: null });\n  };\n\n  render() {\n    if (this.state.hasError) {\n      if (this.props.fallback) {\n        return this.props.fallback;\n      }\n      return (\n        <Alert variant=\"destructive\" className=\"m-4\">\n          <AlertTriangle className=\"h-4 w-4\" />\n          <AlertTitle>Something went wrong</AlertTitle>\n          <AlertDescription className=\"flex items-center gap-4\">\n            <span>Failed to load analytics. Please try again.</span>\n            <Button variant=\"outline\" size=\"sm\" onClick={this.handleRetry}>\n              <RefreshCw className=\"w-4 h-4 mr-2\" />\n              Retry\n            </Button>\n          </AlertDescription>\n        </Alert>\n      );\n    }\n\n    return this.props.children;\n  }\n}\n\nconst validateAnalyticsData = (data: AnalyticsData | undefined): data is AnalyticsData => {\n  if (!data) return false;\n  if (!Array.isArray(data.wpmOverTime)) return false;\n  if (!Array.isArray(data.mistakesHeatmap)) return false;\n  if (!Array.isArray(data.commonMistakes)) return false;\n  if (!data.consistency || typeof data.consistency.avgWpm !== 'number') return false;\n  return true;\n};\n\nconst safeNumber = (value: unknown, fallback: number = 0): number => {\n  if (typeof value === 'number' && !isNaN(value) && isFinite(value)) {\n    return value;\n  }\n  return fallback;\n};\n\nconst safeString = (value: unknown, fallback: string = ''): string => {\n  if (typeof value === 'string') {\n    return value.trim();\n  }\n  return fallback;\n};\n\nconst sanitizeWpmDataPoint = (point: Record<string, unknown>): { date: string; wpm: number; accuracy: number; testCount: number } => ({\n  date: safeString(point?.date, new Date().toISOString()),\n  wpm: safeNumber(point?.wpm, 0),\n  accuracy: safeNumber(point?.accuracy, 0),\n  testCount: safeNumber(point?.testCount, 1),\n});\n\nconst sanitizeMistakeEntry = (entry: Record<string, unknown>): { key: string; errorCount: number; totalCount: number; errorRate: number } => ({\n  key: safeString(entry?.key, '?'),\n  errorCount: safeNumber(entry?.errorCount, 0),\n  totalCount: safeNumber(entry?.totalCount, 1),\n  errorRate: safeNumber(entry?.errorRate, 0),\n});\n\nconst sanitizeAnalyticsData = (data: Partial<AnalyticsData> | undefined): AnalyticsData | null => {\n  if (!data) return null;\n  \n  try {\n    const wpmOverTime = Array.isArray(data.wpmOverTime) \n      ? data.wpmOverTime.map(p => sanitizeWpmDataPoint(p as Record<string, unknown>)).filter(p => p.wpm > 0)\n      : [];\n    \n    const mistakesHeatmap = Array.isArray(data.mistakesHeatmap)\n      ? data.mistakesHeatmap.map(m => sanitizeMistakeEntry(m as Record<string, unknown>))\n      : [];\n    \n    const commonMistakes = Array.isArray(data.commonMistakes)\n      ? data.commonMistakes.map(m => ({\n          expectedKey: safeString((m as Record<string, unknown>)?.expectedKey, '?'),\n          typedKey: safeString((m as Record<string, unknown>)?.typedKey, '?'),\n          count: safeNumber((m as Record<string, unknown>)?.count, 0),\n        }))\n      : [];\n    \n    const consistency = {\n      avgWpm: safeNumber(data.consistency?.avgWpm, 0),\n      stdDeviation: safeNumber(data.consistency?.stdDeviation, 0),\n      minWpm: safeNumber(data.consistency?.minWpm, 0),\n      maxWpm: safeNumber(data.consistency?.maxWpm, 0),\n    };\n    \n    return { wpmOverTime, mistakesHeatmap, commonMistakes, consistency };\n  } catch {\n    return null;\n  }\n};\n\ninterface PartialDataWarningProps {\n  hasWpmData: boolean;\n  hasMistakeData: boolean;\n  hasCommonMistakes: boolean;\n}\n\nconst PartialDataWarning = ({ hasWpmData, hasMistakeData, hasCommonMistakes }: PartialDataWarningProps) => {\n  const missingParts: string[] = [];\n  if (!hasWpmData) missingParts.push('WPM history');\n  if (!hasMistakeData) missingParts.push('mistake patterns');\n  if (!hasCommonMistakes) missingParts.push('common errors');\n  \n  if (missingParts.length === 0) return null;\n  \n  return (\n    <Alert className=\"mb-4\" data-testid=\"partial-data-warning\">\n      <Info className=\"h-4 w-4\" />\n      <AlertTitle>Partial Data Available</AlertTitle>\n      <AlertDescription>\n        Some analytics data is limited: {missingParts.join(', ')}. Complete more typing tests to see full insights.\n      </AlertDescription>\n    </Alert>\n  );\n};\n\nconst EmptyDataState = ({ message }: { message: string }) => (\n  <div className=\"flex flex-col items-center justify-center py-12 text-center\" data-testid=\"empty-state\">\n    <Target className=\"w-12 h-12 text-muted-foreground mb-4\" />\n    <h3 className=\"text-lg font-medium text-muted-foreground mb-2\">No Data Available</h3>\n    <p className=\"text-sm text-muted-foreground max-w-md\">{message}</p>\n  </div>\n);\n\nconst buildComprehensiveAnalyticsPayload = (\n  analytics: AnalyticsData,\n  keystrokeData: {\n    analytics: {\n      avgDwellTime: number | null;\n      avgFlightTime: number | null;\n      consistency: number | null;\n      fingerUsage: Record<string, number> | null;\n      handBalance: number | null;\n      burstWpm: number | null;\n      adjustedWpm: number | null;\n      typingRhythm: number | null;\n      fatigueIndicator: number | null;\n      errorBurstCount: number | null;\n      fastestDigraph: string | null;\n      slowestDigraph: string | null;\n      topDigraphs: Array<{ digraph: string; avgTime: number; count: number }> | null;\n      bottomDigraphs: Array<{ digraph: string; avgTime: number; count: number }> | null;\n      slowestWords: Array<{ word: string; time: number }> | null;\n    };\n  } | null,\n  dynamicThresholds: ReturnType<typeof calculateDynamicThresholds>,\n  trendsData: { trends: HistoricalTrends } | undefined\n): ComprehensiveAnalyticsPayload => {\n  const { benchmarks, fingerNames, limits } = ANALYTICS_CONFIG;\n  const ks = keystrokeData?.analytics;\n\n  const getRhythmRating = (rhythm: number | null): string => {\n    if (rhythm === null) return \"Unknown\";\n    if (rhythm < benchmarks.rhythm.excellent) return \"Excellent\";\n    if (rhythm < benchmarks.rhythm.good) return \"Good\";\n    if (rhythm < benchmarks.rhythm.irregular) return \"Irregular\";\n    return \"Erratic\";\n  };\n\n  const getDwellTimeRating = (dwell: number | null): string => {\n    if (dwell === null) return \"Unknown\";\n    if (dwell < benchmarks.timing.avgDwellTime.quick) return \"Quick\";\n    if (dwell < benchmarks.timing.avgDwellTime.normal) return \"Normal\";\n    return \"Long\";\n  };\n\n  const getFlightTimeRating = (flight: number | null): string => {\n    if (flight === null) return \"Unknown\";\n    if (flight < benchmarks.timing.avgFlightTime.fast) return \"Fast\";\n    if (flight < benchmarks.timing.avgFlightTime.average) return \"Average\";\n    return \"Slow\";\n  };\n\n  const getFatigueRating = (fatigue: number | null): string => {\n    if (fatigue === null) return \"Unknown\";\n    if (fatigue < benchmarks.fatigue.none) return \"None\";\n    if (fatigue < benchmarks.fatigue.mild) return \"Mild\";\n    if (fatigue < benchmarks.fatigue.moderate) return \"Moderate\";\n    return \"Significant\";\n  };\n\n  const getHandBalanceRating = (balance: number | null): string => {\n    if (balance === null) return \"Unknown\";\n    const { balanced, slightImbalance } = benchmarks.handBalance;\n    if (balance >= balanced.min && balance <= balanced.max) return \"Balanced\";\n    if (balance >= slightImbalance.min && balance <= slightImbalance.max) return \"Slight imbalance\";\n    return \"Imbalanced\";\n  };\n\n  const getConsistencyRating = (cv: number): string => {\n    if (cv < benchmarks.consistency.excellent) return \"Excellent\";\n    if (cv < benchmarks.consistency.good) return \"Good\";\n    if (cv < benchmarks.consistency.needsWork) return \"Needs work\";\n    return \"Poor\";\n  };\n\n  const getAccuracyRating = (accuracy: number): string => {\n    if (accuracy >= benchmarks.accuracy.perfect) return \"Near-perfect\";\n    if (accuracy >= benchmarks.accuracy.excellent) return \"Excellent\";\n    if (accuracy >= benchmarks.accuracy.good) return \"Good\";\n    if (accuracy >= benchmarks.accuracy.acceptable) return \"Acceptable\";\n    return \"Needs improvement\";\n  };\n\n  const getWpmPercentile = (wpm: number): string => {\n    if (wpm >= benchmarks.wpm.worldClass) return \"Top 0.1%\";\n    if (wpm >= benchmarks.wpm.elite) return \"Top 1%\";\n    if (wpm >= benchmarks.wpm.professional) return \"Top 10%\";\n    if (wpm >= benchmarks.wpm.average) return \"Above average\";\n    return \"Below average\";\n  };\n\n  const fingerUsageWithPercentages: Record<string, { count: number; percentage: number }> = {};\n  let totalFingerUsage = 0;\n  if (ks?.fingerUsage) {\n    totalFingerUsage = Object.values(ks.fingerUsage).reduce((sum, count) => sum + count, 0);\n    Object.entries(ks.fingerUsage).forEach(([finger, count]) => {\n      fingerUsageWithPercentages[fingerNames[finger] || finger] = {\n        count,\n        percentage: totalFingerUsage > 0 ? (count / totalFingerUsage) * 100 : 0,\n      };\n    });\n  }\n\n  const sortedFingers = Object.entries(fingerUsageWithPercentages).sort((a, b) => a[1].percentage - b[1].percentage);\n  const weakestFingers = sortedFingers.slice(0, 2).map(([finger]) => finger);\n  const strongestFingers = sortedFingers.slice(-2).reverse().map(([finger]) => finger);\n\n  const avgAccuracy = analytics.wpmOverTime.length > 0\n    ? analytics.wpmOverTime.reduce((sum, d) => sum + d.accuracy, 0) / analytics.wpmOverTime.length\n    : null;\n\n  return {\n    userProfile: {\n      skillLevel: dynamicThresholds.skillLevel.level,\n      skillDescription: dynamicThresholds.skillLevel.description,\n      focusArea: dynamicThresholds.accuracyFocus ? \"Accuracy improvement\" : \"Speed optimization\",\n    },\n    coreMetrics: {\n      avgWpm: analytics.consistency.avgWpm,\n      wpmRange: { min: analytics.consistency.minWpm, max: analytics.consistency.maxWpm },\n      consistency: {\n        isConsistent: !dynamicThresholds.isInconsistent,\n        cvPercent: dynamicThresholds.coefficientOfVariation,\n        rating: getConsistencyRating(dynamicThresholds.coefficientOfVariation),\n      },\n      avgAccuracy,\n      testCount: analytics.wpmOverTime.length,\n    },\n    advancedMetrics: {\n      burstWpm: ks?.burstWpm ?? null,\n      adjustedWpm: ks?.adjustedWpm ?? null,\n      typingRhythm: {\n        value: ks?.typingRhythm ?? null,\n        rating: getRhythmRating(ks?.typingRhythm ?? null),\n      },\n      timing: {\n        avgDwellTime: {\n          value: ks?.avgDwellTime ?? null,\n          rating: getDwellTimeRating(ks?.avgDwellTime ?? null),\n        },\n        avgFlightTime: {\n          value: ks?.avgFlightTime ?? null,\n          rating: getFlightTimeRating(ks?.avgFlightTime ?? null),\n        },\n      },\n      fatigue: {\n        indicator: ks?.fatigueIndicator ?? null,\n        rating: getFatigueRating(ks?.fatigueIndicator ?? null),\n      },\n      errorBurstCount: ks?.errorBurstCount ?? null,\n    },\n    digraphAnalysis: {\n      fastest: ks?.fastestDigraph ?? null,\n      slowest: ks?.slowestDigraph ?? null,\n      topDigraphs: (ks?.topDigraphs ?? []).slice(0, limits.digraphsInPrompt),\n      bottomDigraphs: (ks?.bottomDigraphs ?? []).slice(0, limits.digraphsInPrompt),\n    },\n    ergonomics: {\n      handBalance: {\n        value: ks?.handBalance ?? null,\n        rating: getHandBalanceRating(ks?.handBalance ?? null),\n      },\n      fingerUsage: fingerUsageWithPercentages,\n      weakestFingers,\n      strongestFingers,\n    },\n    problemAreas: {\n      topMistakeKeys: analytics.mistakesHeatmap\n        .slice(0, limits.mistakeKeysInPrompt)\n        .map(m => ({ key: m.key, errorRate: m.errorRate })),\n      commonMistakes: analytics.commonMistakes\n        .slice(0, limits.commonMistakesInPrompt)\n        .map(m => ({ expected: m.expectedKey, typed: m.typedKey, count: m.count })),\n      slowestWords: (ks?.slowestWords ?? []).slice(0, 5),\n    },\n    benchmarkComparisons: {\n      wpmVsAverage: {\n        difference: analytics.consistency.avgWpm - benchmarks.wpm.average,\n        percentile: getWpmPercentile(analytics.consistency.avgWpm),\n      },\n      wpmVsProfessional: {\n        difference: analytics.consistency.avgWpm - benchmarks.wpm.professional,\n        percentile: analytics.consistency.avgWpm >= benchmarks.wpm.professional ? \"Professional level\" : \"Below professional\",\n      },\n      accuracyRating: avgAccuracy !== null ? getAccuracyRating(avgAccuracy) : \"No data\",\n      consistencyRating: getConsistencyRating(dynamicThresholds.coefficientOfVariation),\n    },\n    trends: trendsData?.trends ? {\n      weekOverWeek: trendsData.trends.improvement.weekOverWeek,\n      monthOverMonth: trendsData.trends.improvement.monthOverMonth,\n      allTimeImprovement: trendsData.trends.improvement.allTime.improvementPercent,\n    } : null,\n  };\n};\n\nfunction AnalyticsContent() {\n  const { user, isLoading: authLoading } = useAuth();\n  const [selectedDays, setSelectedDays] = useState<number>(ANALYTICS_CONFIG.defaultTimeRange);\n  const [aiInsights, setAiInsights] = useState<AIInsight[]>([]);\n  const [loadingInsights, setLoadingInsights] = useState(false);\n  const [dailyPlan, setDailyPlan] = useState<DailyExercise[]>([]);\n  const [loadingDailyPlan, setLoadingDailyPlan] = useState(false);\n  const [weeklyPlan, setWeeklyPlan] = useState<WeeklyGoal[]>([]);\n  const [loadingWeeklyPlan, setLoadingWeeklyPlan] = useState(false);\n\n  const { data: analyticsData, isLoading, isError, error, refetch } = useQuery<{ analytics: AnalyticsData }>({\n    queryKey: [`/api/analytics?days=${selectedDays}`],\n    retry: ANALYTICS_CONFIG.cache.retryCount,\n    staleTime: ANALYTICS_CONFIG.cache.staleTimeMs,\n    enabled: !!user,\n  });\n\n  const { data: keystrokeData } = useQuery({\n    queryKey: [`/api/analytics/user?limit=${ANALYTICS_CONFIG.limits.keystrokeAnalyticsDepth}`],\n    queryFn: async () => {\n      const response = await fetch(`/api/analytics/user?limit=${ANALYTICS_CONFIG.limits.keystrokeAnalyticsDepth}`, {\n        credentials: \"include\",\n      });\n      if (!response.ok) return null;\n      const data = await response.json();\n      \n      if (!data.analytics || data.analytics.length === 0) return null;\n      \n      const analyticsArray = data.analytics as Array<{\n        avgDwellTime: number | null;\n        avgFlightTime: number | null;\n        consistency: number | null;\n        fingerUsage: Record<string, number> | null;\n        handBalance: number | null;\n        keyHeatmap: Record<string, number> | null;\n        wpm: number;\n        accuracy: number;\n        totalErrors: number;\n        fastestDigraph: string | null;\n        slowestDigraph: string | null;\n        wpmByPosition: Array<{position: number; wpm: number}> | null;\n        slowestWords: Array<{word: string; time: number}> | null;\n        burstWpm: number | null;\n        adjustedWpm: number | null;\n        consistencyRating: number | null;\n        rollingAccuracy: number[] | null;\n        topDigraphs: Array<{digraph: string; avgTime: number; count: number}> | null;\n        bottomDigraphs: Array<{digraph: string; avgTime: number; count: number}> | null;\n        typingRhythm: number | null;\n        peakPerformanceWindow: {startPos: number; endPos: number; wpm: number} | null;\n        fatigueIndicator: number | null;\n        errorBurstCount: number | null;\n      }>;\n      \n      // Find the first record with valid keystroke data (wpm > 0 and has avgFlightTime)\n      // This ensures we display complete analytics, not data from incomplete tests\n      const validRecord = analyticsArray.find(a => a.wpm > 0 && a.avgFlightTime !== null);\n      const latest = validRecord || analyticsArray[0];\n      \n      // Aggregate finger usage across all tests for comprehensive view\n      const aggregatedFingerUsage: Record<string, number> = {};\n      analyticsArray.forEach(a => {\n        if (a.fingerUsage) {\n          Object.entries(a.fingerUsage).forEach(([finger, count]) => {\n            aggregatedFingerUsage[finger] = (aggregatedFingerUsage[finger] || 0) + (count as number);\n          });\n        }\n      });\n      \n      // Aggregate key heatmap across all tests for comprehensive view\n      const aggregatedKeyHeatmap: Record<string, number> = {};\n      analyticsArray.forEach(a => {\n        if (a.keyHeatmap) {\n          Object.entries(a.keyHeatmap).forEach(([key, count]) => {\n            aggregatedKeyHeatmap[key] = (aggregatedKeyHeatmap[key] || 0) + (count as number);\n          });\n        }\n      });\n      \n      // Use latest record metrics but aggregated heatmap/finger data\n      return {\n        analytics: {\n          avgDwellTime: latest.avgDwellTime,\n          avgFlightTime: latest.avgFlightTime,\n          consistency: latest.consistency,\n          handBalance: latest.handBalance,\n          fingerUsage: Object.keys(aggregatedFingerUsage).length > 0 ? aggregatedFingerUsage : latest.fingerUsage,\n          keyHeatmap: Object.keys(aggregatedKeyHeatmap).length > 0 ? aggregatedKeyHeatmap : latest.keyHeatmap,\n          totalTests: analyticsArray.length,\n          fastestDigraph: latest.fastestDigraph,\n          slowestDigraph: latest.slowestDigraph,\n          wpmByPosition: latest.wpmByPosition,\n          slowestWords: latest.slowestWords,\n          burstWpm: latest.burstWpm,\n          adjustedWpm: latest.adjustedWpm,\n          consistencyRating: latest.consistencyRating,\n          rollingAccuracy: latest.rollingAccuracy,\n          topDigraphs: latest.topDigraphs,\n          bottomDigraphs: latest.bottomDigraphs,\n          typingRhythm: latest.typingRhythm,\n          peakPerformanceWindow: latest.peakPerformanceWindow,\n          fatigueIndicator: latest.fatigueIndicator,\n          errorBurstCount: latest.errorBurstCount,\n        }\n      };\n    },\n    enabled: !!user,\n  });\n\n  const { data: trendsData, isLoading: trendsLoading } = useQuery<{ trends: HistoricalTrends }>({\n    queryKey: ['/api/analytics/trends'],\n    retry: ANALYTICS_CONFIG.cache.retryCount,\n    staleTime: ANALYTICS_CONFIG.cache.staleTimeMs * 2,\n    enabled: !!user,\n  });\n\n  const rawAnalytics = analyticsData?.analytics;\n  \n  const analytics = useMemo(() => {\n    if (!rawAnalytics) return undefined;\n    return sanitizeAnalyticsData(rawAnalytics) ?? undefined;\n  }, [rawAnalytics]);\n  \n  const isDataValid = validateAnalyticsData(analytics);\n  \n  const partialDataFlags = useMemo(() => ({\n    hasWpmData: (analytics?.wpmOverTime?.length ?? 0) > 0,\n    hasMistakeData: (analytics?.mistakesHeatmap?.length ?? 0) > 0,\n    hasCommonMistakes: (analytics?.commonMistakes?.length ?? 0) > 0,\n  }), [analytics]);\n  \n  const hasPartialData = useMemo(() => {\n    const { hasWpmData, hasMistakeData, hasCommonMistakes } = partialDataFlags;\n    return hasWpmData && (!hasMistakeData || !hasCommonMistakes);\n  }, [partialDataFlags]);\n  \n  const dynamicThresholds = useMemo(() => {\n    if (!isDataValid || !analytics) return null;\n    return calculateDynamicThresholds(analytics);\n  }, [analytics, isDataValid]);\n\n  const sanitizeText = useCallback((text: string): string => {\n    return text\n      .replace(/<[^>]*>/g, '')\n      .replace(/[^\\x20-\\x7E\\n]/g, '')\n      .trim();\n  }, []);\n\n  const deduplicateInsights = useCallback((insights: AIInsight[]): AIInsight[] => {\n    const seen = new Set<string>();\n    return insights.filter(insight => {\n      const normalized = insight.message.toLowerCase().slice(0, 50);\n      if (seen.has(normalized)) return false;\n      seen.add(normalized);\n      return true;\n    });\n  }, []);\n\n  const parseInsightsFromText = useCallback((text: string, analyticsParam: AnalyticsData): AIInsight[] => {\n    const insights: AIInsight[] = [];\n    const lines = text.split(/\\n/).map(l => l.trim()).filter(l => l.length > 10);\n    const thresholds = calculateDynamicThresholds(analyticsParam);\n    \n    const structuredPattern = /\\[(\\w+)\\|(\\w+)\\|(\\w+)\\]\\s*(.+?)(?:\\s*ACTION:\\s*(.+))?$/i;\n    const stripLeadingPattern = /^[\\d.)\\-*â€¢\\s]+/;\n    \n    const typeMap: Record<string, AIInsight[\"type\"]> = {\n      improvement: \"improvement\",\n      strength: \"strength\",\n      practice: \"practice\",\n      warning: \"warning\",\n      milestone: \"milestone\",\n    };\n    \n    const categoryMap: Record<string, AIInsight[\"category\"]> = {\n      speed: \"speed\",\n      accuracy: \"accuracy\",\n      rhythm: \"rhythm\",\n      ergonomics: \"ergonomics\",\n      technique: \"technique\",\n      endurance: \"endurance\",\n      general: \"general\",\n    };\n    \n    const priorityMap: Record<string, AIInsight[\"priority\"]> = {\n      critical: \"critical\",\n      high: \"high\",\n      medium: \"medium\",\n      low: \"low\",\n    };\n    \n    for (const line of lines) {\n      const cleanedLine = line.replace(stripLeadingPattern, '');\n      const structuredMatch = cleanedLine.match(structuredPattern);\n      \n      if (structuredMatch) {\n        const [, typeRaw, categoryRaw, priorityRaw, messageRaw, actionRaw] = structuredMatch;\n        const type = typeMap[typeRaw.toLowerCase()] || \"practice\";\n        const category = categoryMap[categoryRaw.toLowerCase()] || \"general\";\n        const priority = priorityMap[priorityRaw.toLowerCase()] || \"medium\";\n        \n        let message = sanitizeText(messageRaw);\n        const actionItem = actionRaw ? sanitizeText(actionRaw) : undefined;\n        \n        const dataPointMatch = message.match(/\\(([^)]+(?:WPM|%|ms|CV)[^)]*)\\)/i);\n        const dataPoint = dataPointMatch ? dataPointMatch[1] : undefined;\n        \n        const benchmarkMatch = message.match(/(?:vs|compared to|benchmark:?\\s*)([^.]+)/i);\n        const benchmark = benchmarkMatch ? benchmarkMatch[1].trim() : undefined;\n        \n        insights.push({ type, category, message, priority, dataPoint, benchmark, actionItem });\n      } else {\n        const cleanLine = sanitizeText(line.replace(/^[\\d.)\\-*â€¢]+\\s*/, ''));\n        if (cleanLine.length < 15) continue;\n        \n        const lowerLine = cleanLine.toLowerCase();\n        \n        const warningKeywords = ['warning', 'caution', 'alert', 'critical', 'fatigue', 'strain'];\n        const milestoneKeywords = ['milestone', 'achieved', 'reached', 'congratulations', 'breakthrough'];\n        const improvementKeywords = ['improve', 'focus', 'work on', 'reduce', 'avoid', 'weakness', 'error', 'mistake'];\n        const strengthKeywords = ['strength', 'good', 'excellent', 'strong', 'well', 'consistent', 'above average'];\n        const practiceKeywords = ['practice', 'exercise', 'drill', 'try', 'recommend', 'suggest', 'action'];\n        \n        let type: AIInsight[\"type\"] = \"practice\";\n        let priority: AIInsight[\"priority\"] = \"medium\";\n        let category: AIInsight[\"category\"] = \"general\";\n        \n        if (warningKeywords.some(kw => lowerLine.includes(kw))) {\n          type = \"warning\";\n          priority = \"critical\";\n          category = \"endurance\";\n        } else if (milestoneKeywords.some(kw => lowerLine.includes(kw))) {\n          type = \"milestone\";\n          priority = \"low\";\n          category = \"general\";\n        } else if (improvementKeywords.some(kw => lowerLine.includes(kw))) {\n          type = \"improvement\";\n          priority = \"high\";\n          if (lowerLine.includes(\"accuracy\") || lowerLine.includes(\"error\")) category = \"accuracy\";\n          else if (lowerLine.includes(\"speed\") || lowerLine.includes(\"wpm\")) category = \"speed\";\n          else if (lowerLine.includes(\"rhythm\") || lowerLine.includes(\"consistent\")) category = \"rhythm\";\n        } else if (strengthKeywords.some(kw => lowerLine.includes(kw))) {\n          type = \"strength\";\n          priority = \"medium\";\n        } else if (practiceKeywords.some(kw => lowerLine.includes(kw))) {\n          type = \"practice\";\n          priority = \"medium\";\n          category = \"technique\";\n        }\n        \n        const actionMatch = cleanLine.match(/ACTION:\\s*(.+)/i);\n        const actionItem = actionMatch ? actionMatch[1].trim() : undefined;\n        const message = actionMatch ? cleanLine.replace(/ACTION:\\s*.+/i, '').trim() : cleanLine;\n        \n        insights.push({ type, category, message, priority, actionItem });\n      }\n    }\n    \n    if (insights.length === 0) {\n      const topMistakeKeys = analyticsParam.mistakesHeatmap\n        .slice(0, ANALYTICS_CONFIG.limits.mistakeKeysInFallback)\n        .map(m => m.key);\n      \n      if (topMistakeKeys.length > 0) {\n        insights.push({\n          type: \"improvement\",\n          category: \"accuracy\",\n          message: `Focus on keys with high error rates: ${topMistakeKeys.join(\", \")}`,\n          priority: \"high\",\n          actionItem: `Practice typing words containing ${topMistakeKeys[0]} for 5 minutes daily`,\n        });\n      }\n      \n      if (thresholds.isInconsistent) {\n        insights.push({\n          type: \"improvement\",\n          category: \"rhythm\",\n          message: `Work on consistency - your WPM varies by ${thresholds.coefficientOfVariation.toFixed(0)}% between tests`,\n          priority: \"high\",\n          dataPoint: `${thresholds.coefficientOfVariation.toFixed(0)}% CV`,\n          actionItem: \"Complete 5 tests at 80% of your max speed to build consistency\",\n        });\n      }\n      \n      const { skillLevel } = thresholds;\n      if (skillLevel.level === \"Beginner\" || skillLevel.level === \"Developing\") {\n        insights.push({\n          type: \"practice\",\n          category: \"technique\",\n          message: `${skillLevel.description}. Practice daily for 15-20 minutes to build muscle memory`,\n          priority: \"medium\",\n          actionItem: \"Complete at least 3 typing tests daily, focusing on accuracy over speed\",\n        });\n      } else if (skillLevel.level === \"Advanced\" || skillLevel.level === \"Expert\") {\n        insights.push({\n          type: \"strength\",\n          category: \"speed\",\n          message: `${skillLevel.description}. Your typing speed is excellent - maintain quality with focused practice`,\n          priority: \"medium\",\n          benchmark: `Professional: 65 WPM, Elite: 100 WPM`,\n        });\n      } else {\n        insights.push({\n          type: \"practice\",\n          category: \"general\",\n          message: `${skillLevel.description}. Continue regular practice to improve both speed and accuracy`,\n          priority: \"medium\",\n          actionItem: \"Alternate between accuracy-focused and speed-focused practice sessions\",\n        });\n      }\n    }\n    \n    return deduplicateInsights(insights).slice(0, ANALYTICS_CONFIG.limits.insightsDisplay);\n  }, []);\n\n  const generateAIInsights = async () => {\n    if (!analytics || !dynamicThresholds) return;\n\n    const abortController = new AbortController();\n    const timeoutId = setTimeout(() => abortController.abort(), ANALYTICS_CONFIG.ai.timeoutMs);\n    \n    const payload = buildComprehensiveAnalyticsPayload(analytics, keystrokeData ?? null, dynamicThresholds, trendsData);\n    const { benchmarks } = ANALYTICS_CONFIG;\n    \n    const formatDigraphs = (digraphs: Array<{ digraph: string; avgTime: number }>) =>\n      digraphs.map(d => `\"${d.digraph}\" (${d.avgTime.toFixed(0)}ms)`).join(\", \");\n    \n    const formatMistakeKeys = (keys: Array<{ key: string; errorRate: number }>) =>\n      keys.map(k => `\"${k.key}\" (${k.errorRate.toFixed(1)}% error rate)`).join(\", \");\n    \n    const formatCommonMistakes = (mistakes: Array<{ expected: string; typed: string; count: number }>) =>\n      mistakes.map(m => `\"${m.expected}\"â†’\"${m.typed}\" (${m.count}x)`).join(\", \");\n    \n    setLoadingInsights(true);\n    try {\n      const promptMessage = `You are an expert typing coach analyzing detailed keystroke analytics. Provide research-backed, actionable insights.\n\n## USER PROFILE\n- Skill Level: ${payload.userProfile.skillLevel} (${payload.userProfile.skillDescription})\n- Focus Area: ${payload.userProfile.focusArea}\n- Tests Completed: ${payload.coreMetrics.testCount}\n\n## CORE METRICS\n- Average WPM: ${payload.coreMetrics.avgWpm.toFixed(1)} (${payload.benchmarkComparisons.wpmVsAverage.percentile})\n- WPM Range: ${payload.coreMetrics.wpmRange.min} - ${payload.coreMetrics.wpmRange.max}\n- Average Accuracy: ${payload.coreMetrics.avgAccuracy !== null ? `${payload.coreMetrics.avgAccuracy.toFixed(1)}%` : \"N/A\"} (${payload.benchmarkComparisons.accuracyRating})\n- Consistency: ${payload.coreMetrics.consistency.rating} (CV: ${payload.coreMetrics.consistency.cvPercent.toFixed(1)}%)\n\n## ADVANCED METRICS\n${payload.advancedMetrics.burstWpm ? `- Burst WPM: ${payload.advancedMetrics.burstWpm.toFixed(0)} (peak short-burst speed)` : \"\"}\n${payload.advancedMetrics.adjustedWpm ? `- Adjusted WPM: ${payload.advancedMetrics.adjustedWpm.toFixed(1)} (accuracy-weighted)` : \"\"}\n- Typing Rhythm: ${payload.advancedMetrics.typingRhythm.rating}${payload.advancedMetrics.typingRhythm.value ? ` (CV: ${payload.advancedMetrics.typingRhythm.value.toFixed(0)}%)` : \"\"}\n- Key Transition Speed: ${payload.advancedMetrics.timing.avgFlightTime.rating}${payload.advancedMetrics.timing.avgFlightTime.value ? ` (${payload.advancedMetrics.timing.avgFlightTime.value.toFixed(0)}ms avg)` : \"\"}\n- Fatigue: ${payload.advancedMetrics.fatigue.rating}${payload.advancedMetrics.fatigue.indicator ? ` (${(payload.advancedMetrics.fatigue.indicator * 100).toFixed(0)}% slowdown)` : \"\"}\n${payload.advancedMetrics.errorBurstCount ? `- Error Bursts: ${payload.advancedMetrics.errorBurstCount} clusters of consecutive errors` : \"\"}\n\n## DIGRAPH ANALYSIS (Two-Key Combinations)\n${payload.digraphAnalysis.fastest ? `- Fastest: \"${payload.digraphAnalysis.fastest}\"` : \"\"}\n${payload.digraphAnalysis.slowest ? `- Slowest: \"${payload.digraphAnalysis.slowest}\"` : \"\"}\n${payload.digraphAnalysis.topDigraphs.length > 0 ? `- Best Digraphs: ${formatDigraphs(payload.digraphAnalysis.topDigraphs)}` : \"\"}\n${payload.digraphAnalysis.bottomDigraphs.length > 0 ? `- Struggling Digraphs: ${formatDigraphs(payload.digraphAnalysis.bottomDigraphs)}` : \"\"}\n\n## ERGONOMICS\n- Hand Balance: ${payload.ergonomics.handBalance.rating}${payload.ergonomics.handBalance.value ? ` (${payload.ergonomics.handBalance.value.toFixed(0)}% left hand)` : \"\"}\n${payload.ergonomics.weakestFingers.length > 0 ? `- Weaker Fingers: ${payload.ergonomics.weakestFingers.join(\", \")}` : \"\"}\n${payload.ergonomics.strongestFingers.length > 0 ? `- Stronger Fingers: ${payload.ergonomics.strongestFingers.join(\", \")}` : \"\"}\n\n## PROBLEM AREAS\n${payload.problemAreas.topMistakeKeys.length > 0 ? `- Error-Prone Keys: ${formatMistakeKeys(payload.problemAreas.topMistakeKeys)}` : \"- No significant error-prone keys identified\"}\n${payload.problemAreas.commonMistakes.length > 0 ? `- Common Substitutions: ${formatCommonMistakes(payload.problemAreas.commonMistakes)}` : \"\"}\n${payload.problemAreas.slowestWords.length > 0 ? `- Slow Words: ${payload.problemAreas.slowestWords.map(w => `\"${w.word}\"`).join(\", \")}` : \"\"}\n\n## BENCHMARKS\n- Industry Average: ${benchmarks.wpm.average} WPM | Professional: ${benchmarks.wpm.professional} WPM | Elite: ${benchmarks.wpm.elite} WPM\n- Your Position: ${payload.benchmarkComparisons.wpmVsAverage.difference > 0 ? `+${payload.benchmarkComparisons.wpmVsAverage.difference.toFixed(0)}` : payload.benchmarkComparisons.wpmVsAverage.difference.toFixed(0)} WPM vs average\n${payload.trends ? `\n## PROGRESS TRENDS\n- Week-over-week: ${payload.trends.weekOverWeek.wpm > 0 ? \"+\" : \"\"}${payload.trends.weekOverWeek.wpm.toFixed(1)} WPM\n- Month-over-month: ${payload.trends.monthOverMonth.wpm > 0 ? \"+\" : \"\"}${payload.trends.monthOverMonth.wpm.toFixed(1)} WPM\n- All-time improvement: ${payload.trends.allTimeImprovement.toFixed(0)}%` : \"\"}\n\n---\n\nProvide exactly 10 insights. Each insight MUST be on its own line using this EXACT format (do NOT number them):\n\n[TYPE|CATEGORY|PRIORITY] Your insight message citing a specific metric. ACTION: A specific exercise or technique.\n\nValid TYPE values: IMPROVEMENT, STRENGTH, PRACTICE, WARNING, MILESTONE\nValid CATEGORY values: speed, accuracy, rhythm, ergonomics, technique, endurance, general\nValid PRIORITY values: critical, high, medium, low\n\nDISTRIBUTION:\n- 3-4 IMPROVEMENT insights targeting specific weaknesses (cite error rates, slow digraphs, or rhythm issues)\n- 2-3 STRENGTH insights recognizing achievements (cite metrics that exceed benchmarks)\n- 2-3 PRACTICE insights with specific drills (reference problematic keys/digraphs)\n- 1 WARNING if fatigue or critical issues detected, otherwise 1 MILESTONE insight\n\nRULES:\n- Start each line directly with the bracket notation [TYPE|CATEGORY|PRIORITY]\n- Do NOT use numbers, bullets, or any prefix before the brackets\n- Each ACTION must be specific (e.g., \"Practice 'th' digraph 50 times daily\" not \"practice more\")\n- Reference industry benchmarks where relevant\n- Tailor advice to ${payload.userProfile.skillLevel.toLowerCase()} skill level\n\nEXAMPLE OUTPUT:\n[IMPROVEMENT|accuracy|high] Your \"e\" key has a 12.5% error rate, significantly above the 5% acceptable threshold. ACTION: Complete 3 sets of 20 words containing \"e\" at slow speed daily.\n[STRENGTH|speed|medium] Your 65 WPM average exceeds the industry average of 41 WPM by 58%. ACTION: Maintain this level with 10-minute daily practice sessions.`;\n\n      const response = await fetch(\"/api/chat\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        signal: abortController.signal,\n        body: JSON.stringify({\n          conversationId: null,\n          messages: [{ role: \"user\", content: promptMessage }],\n        }),\n      });\n\n      clearTimeout(timeoutId);\n      \n      if (!response.ok) throw new Error(\"Failed to generate insights\");\n\n      const reader = response.body?.getReader();\n      const decoder = new TextDecoder();\n      let fullResponse = \"\";\n\n      if (reader) {\n        while (true) {\n          const { done, value } = await reader.read();\n          if (done) break;\n          \n          const chunk = decoder.decode(value);\n          const lines = chunk.split(\"\\n\");\n          \n          for (const line of lines) {\n            if (line.startsWith(\"data: \")) {\n              const data = line.slice(6);\n              if (data === \"[DONE]\") break;\n              try {\n                const parsed = JSON.parse(data);\n                if (parsed.content) {\n                  fullResponse += parsed.content;\n                }\n              } catch {\n                // Ignore parse errors for malformed chunks\n              }\n            }\n          }\n        }\n      }\n\n      const insights = parseInsightsFromText(fullResponse, analytics);\n      setAiInsights(insights);\n      toast.success(\"AI insights generated successfully!\");\n    } catch (error) {\n      if (error instanceof Error && error.name === 'AbortError') {\n        toast.error(\"AI request timed out. Please try again.\");\n      } else {\n        console.error(\"AI insights error:\", error);\n        toast.error(\"Failed to generate AI insights\");\n      }\n      \n      const fallbackInsights = parseInsightsFromText(\"\", analytics);\n      if (fallbackInsights.length > 0) {\n        setAiInsights(fallbackInsights);\n      }\n    } finally {\n      clearTimeout(timeoutId);\n      setLoadingInsights(false);\n    }\n  };\n\n  const generateFallbackDailyPlan = useCallback((analytics: AnalyticsData): DailyExercise[] => {\n    const thresholds = calculateDynamicThresholds(analytics);\n    const { skillLevel, accuracyFocus, isInconsistent } = thresholds;\n    const topMistakeKeys = analytics.mistakesHeatmap\n      .slice(0, ANALYTICS_CONFIG.limits.mistakeKeysInFallback)\n      .map(m => m.key)\n      .join(\", \");\n    \n    // Generate exercises based on skill level and problem areas\n    const exercises: DailyExercise[] = [];\n    \n    // Exercise 1: Always address problem keys if they exist\n    if (topMistakeKeys) {\n      exercises.push({\n        title: \"Problem Keys Practice\",\n        description: `Focus on keys with high error rates: ${topMistakeKeys}`,\n        duration: skillLevel.level === \"Beginner\" ? \"15 min\" : \"10 min\",\n      });\n    } else {\n      exercises.push({\n        title: \"Finger Strength Building\",\n        description: \"Practice common letter combinations to build muscle memory\",\n        duration: \"10 min\",\n      });\n    }\n    \n    // Exercise 2: Based on whether user needs accuracy or speed focus\n    if (accuracyFocus || isInconsistent) {\n      exercises.push({\n        title: \"Accuracy Drills\",\n        description: \"Type at 70% of your normal speed focusing on 100% accuracy\",\n        duration: skillLevel.level === \"Beginner\" ? \"10 min\" : \"5 min\",\n      });\n    } else {\n      exercises.push({\n        title: \"Speed Bursts\",\n        description: \"Complete 5 short tests (30s each) pushing for maximum speed\",\n        duration: \"5 min\",\n      });\n    }\n    \n    // Exercise 3: Skill-level appropriate challenge\n    if (skillLevel.level === \"Beginner\" || skillLevel.level === \"Developing\") {\n      exercises.push({\n        title: \"Consistent Rhythm Practice\",\n        description: \"Focus on maintaining a steady typing rhythm without rushing\",\n        duration: \"5 min\",\n      });\n    } else {\n      exercises.push({\n        title: \"Endurance Challenge\",\n        description: \"Complete one 2-minute test to build typing stamina\",\n        duration: \"5 min\",\n      });\n    }\n    \n    return exercises.slice(0, ANALYTICS_CONFIG.limits.dailyExercises);\n  }, []);\n\n  const generateDailyPlan = async () => {\n    if (!analytics || !dynamicThresholds) return;\n\n    const abortController = new AbortController();\n    const timeoutId = setTimeout(() => abortController.abort(), ANALYTICS_CONFIG.ai.timeoutMs);\n    const { skillLevel, accuracyFocus, isInconsistent } = dynamicThresholds;\n    \n    // Build contextual data for the prompt\n    const topMistakeKeys = analytics.mistakesHeatmap\n      .slice(0, ANALYTICS_CONFIG.limits.mistakeKeysInPrompt)\n      .map(m => sanitizeText(m.key))\n      .join(\", \");\n    \n    const commonMistakes = analytics.commonMistakes\n      .slice(0, ANALYTICS_CONFIG.limits.commonMistakesInPrompt)\n      .map(m => `${sanitizeText(m.expectedKey)}â†’${sanitizeText(m.typedKey)}`)\n      .join(\", \");\n    \n    const latestAccuracy = analytics.wpmOverTime.length > 0 \n      ? safeNumber(analytics.wpmOverTime[analytics.wpmOverTime.length - 1].accuracy) \n      : 0;\n    \n    setLoadingDailyPlan(true);\n    try {\n      const promptMessage = `Create a personalized daily practice plan for a ${skillLevel.level.toLowerCase()} typist.\n\nUser Profile:\n- Skill Level: ${skillLevel.level} (${skillLevel.description})\n- Primary Focus: ${accuracyFocus ? \"Improving accuracy\" : \"Building speed\"}\n- Consistency: ${isInconsistent ? \"Needs improvement\" : \"Good\"}\n\nPerformance Data:\n- Average WPM: ${safeNumber(analytics.consistency.avgWpm).toFixed(1)}\n- Latest Accuracy: ${latestAccuracy.toFixed(1)}%\n- Problem Keys: ${topMistakeKeys || \"None identified\"}\n- Common Mistakes: ${commonMistakes || \"None identified\"}\n\nCreate exactly ${ANALYTICS_CONFIG.limits.dailyExercises} exercises in this format:\nExercise 1: [Title] | [Description] | [Duration]\nExercise 2: [Title] | [Description] | [Duration]\nExercise 3: [Title] | [Description] | [Duration]\n\nTailor exercises to ${skillLevel.level.toLowerCase()} level - ${accuracyFocus ? \"prioritize accuracy drills\" : \"include speed challenges\"}. Each should have a clear title, actionable description, and appropriate duration.`;\n\n      const response = await fetch(\"/api/chat\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        signal: abortController.signal,\n        body: JSON.stringify({\n          conversationId: null,\n          messages: [{ role: \"user\", content: promptMessage }],\n        }),\n      });\n\n      clearTimeout(timeoutId);\n      if (!response.ok) throw new Error(\"Failed to generate daily plan\");\n\n      const reader = response.body?.getReader();\n      const decoder = new TextDecoder();\n      let fullResponse = \"\";\n\n      if (reader) {\n        while (true) {\n          const { done, value } = await reader.read();\n          if (done) break;\n          \n          const chunk = decoder.decode(value);\n          const lines = chunk.split(\"\\n\");\n          \n          for (const line of lines) {\n            if (line.startsWith(\"data: \")) {\n              const data = line.slice(6);\n              if (data === \"[DONE]\") break;\n              try {\n                const parsed = JSON.parse(data);\n                if (parsed.content) {\n                  fullResponse += parsed.content;\n                }\n              } catch {\n                // Ignore parse errors\n              }\n            }\n          }\n        }\n      }\n\n      const exercises: DailyExercise[] = [];\n      const exerciseLines = fullResponse.split(\"\\n\").filter(l => l.includes(\"Exercise\") || l.match(/^\\d+[.:)]/));\n      \n      for (const line of exerciseLines) {\n        const parts = line.split(\"|\").map(p => sanitizeText(p));\n        if (parts.length >= 3) {\n          exercises.push({\n            title: parts[0].replace(/^Exercise \\d+:\\s*/, \"\").replace(/^\\d+[.:)]\\s*/, \"\").trim(),\n            description: parts[1].trim(),\n            duration: parts[2].trim(),\n          });\n        }\n      }\n\n      setDailyPlan(exercises.length > 0 ? exercises.slice(0, ANALYTICS_CONFIG.limits.dailyExercises) : generateFallbackDailyPlan(analytics));\n      toast.success(\"Daily practice plan generated!\");\n    } catch (error) {\n      if (error instanceof Error && error.name === 'AbortError') {\n        toast.error(\"AI request timed out. Using default plan.\");\n      } else {\n        console.error(\"Daily plan error:\", error);\n        toast.error(\"Failed to generate daily plan\");\n      }\n      setDailyPlan(generateFallbackDailyPlan(analytics));\n    } finally {\n      clearTimeout(timeoutId);\n      setLoadingDailyPlan(false);\n    }\n  };\n\n  const generateFallbackWeeklyPlan = useCallback((analytics: AnalyticsData): WeeklyGoal[] => {\n    const thresholds = calculateDynamicThresholds(analytics);\n    const { skillLevel, improvementRates, accuracyFocus, isInconsistent } = thresholds;\n    const avgWpm = analytics.consistency.avgWpm;\n    const topMistakeKeys = analytics.mistakesHeatmap\n      .slice(0, ANALYTICS_CONFIG.limits.mistakeKeysInWeeklyFallback)\n      .map(m => m.key)\n      .join(\", \");\n    \n    // Build skill-level appropriate weekly goals with dynamic targets\n    const goals: WeeklyGoal[] = [];\n    \n    // Week 1: Foundation based on skill level\n    if (skillLevel.level === \"Beginner\" || skillLevel.level === \"Developing\") {\n      goals.push({\n        week: \"Week 1\",\n        title: \"Building Foundation\",\n        tasks: [\n          \"Practice 15-20 min daily\",\n          accuracyFocus ? \"Focus on 95%+ accuracy before speed\" : \"Maintain current accuracy\",\n          topMistakeKeys ? `Target problem keys: ${topMistakeKeys}` : \"Work on proper finger placement\"\n        ],\n        target: `${Math.ceil(avgWpm + improvementRates.week1)} WPM`,\n        status: \"current\",\n      });\n    } else {\n      goals.push({\n        week: \"Week 1\",\n        title: \"Precision Tuning\",\n        tasks: [\n          \"10-15 min focused practice daily\",\n          isInconsistent ? \"Work on reducing WPM variance\" : \"Maintain consistency\",\n          topMistakeKeys ? `Eliminate errors on: ${topMistakeKeys}` : \"Fine-tune problem areas\"\n        ],\n        target: `${Math.ceil(avgWpm + improvementRates.week1)} WPM`,\n        status: \"current\",\n      });\n    }\n    \n    // Week 2: Progressive improvement\n    goals.push({\n      week: \"Week 2\",\n      title: skillLevel.level === \"Expert\" ? \"Peak Performance\" : \"Speed Development\",\n      tasks: [\n        skillLevel.level === \"Beginner\" ? \"Increase to 20 min sessions\" : \"Add speed burst exercises\",\n        \"Complete 3-5 timed challenges daily\",\n        accuracyFocus ? \"Target 97%+ accuracy\" : \"Push speed limits safely\"\n      ],\n      target: `${Math.ceil(avgWpm + improvementRates.week2)} WPM`,\n      status: \"next\",\n    });\n    \n    // Week 3-4: Consolidation\n    goals.push({\n      week: \"Week 3-4\",\n      title: skillLevel.level === \"Expert\" ? \"Excellence Maintenance\" : \"Skill Integration\",\n      tasks: [\n        \"Balance speed and accuracy practice\",\n        \"Test across different content types\",\n        \"Build and maintain consistent rhythm\"\n      ],\n      target: `${Math.ceil(avgWpm + improvementRates.week3)} WPM`,\n      status: \"later\",\n    });\n    \n    return goals.slice(0, ANALYTICS_CONFIG.limits.weeklyGoals);\n  }, []);\n\n  const generateWeeklyPlan = async () => {\n    if (!analytics || !dynamicThresholds) return;\n\n    const abortController = new AbortController();\n    const timeoutId = setTimeout(() => abortController.abort(), ANALYTICS_CONFIG.ai.timeoutMs);\n    const { skillLevel, improvementRates, isInconsistent, accuracyFocus } = dynamicThresholds;\n    \n    // Build contextual data for the prompt\n    const topMistakeKeys = analytics.mistakesHeatmap\n      .slice(0, ANALYTICS_CONFIG.limits.mistakeKeysInPrompt)\n      .map(m => sanitizeText(m.key))\n      .join(\", \");\n    \n    setLoadingWeeklyPlan(true);\n    try {\n      const promptMessage = `Create a personalized 4-week improvement roadmap for a ${skillLevel.level.toLowerCase()} typist.\n\nUser Profile:\n- Skill Level: ${skillLevel.level} (${skillLevel.description})\n- Primary Focus: ${accuracyFocus ? \"Accuracy improvement\" : \"Speed optimization\"}\n- Consistency: ${isInconsistent ? \"Needs improvement\" : \"Good\"}\n\nCurrent Performance:\n- Average WPM: ${safeNumber(analytics.consistency.avgWpm).toFixed(1)}\n- WPM Range: ${safeNumber(analytics.consistency.minWpm)} - ${safeNumber(analytics.consistency.maxWpm)}\n- Problem Keys: ${topMistakeKeys || \"None identified\"}\n\nRecommended Improvement Targets (based on skill level):\n- Week 1: +${improvementRates.week1} WPM (${Math.ceil(analytics.consistency.avgWpm + improvementRates.week1)} WPM)\n- Week 2: +${improvementRates.week2} WPM (${Math.ceil(analytics.consistency.avgWpm + improvementRates.week2)} WPM)\n- Week 3-4: +${improvementRates.week3} WPM (${Math.ceil(analytics.consistency.avgWpm + improvementRates.week3)} WPM)\n\nCreate exactly ${ANALYTICS_CONFIG.limits.weeklyGoals} weekly goals in this format:\nWeek 1: [Title] | [Task 1, Task 2, Task 3] | [Target WPM]\nWeek 2: [Title] | [Task 1, Task 2, Task 3] | [Target WPM]\nWeek 3-4: [Title] | [Task 1, Task 2, Task 3] | [Target WPM]\n\nMake goals progressive and appropriate for ${skillLevel.level.toLowerCase()} level. Use the recommended targets.`;\n\n      const response = await fetch(\"/api/chat\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        signal: abortController.signal,\n        body: JSON.stringify({\n          conversationId: null,\n          messages: [{ role: \"user\", content: promptMessage }],\n        }),\n      });\n\n      clearTimeout(timeoutId);\n      if (!response.ok) throw new Error(\"Failed to generate weekly plan\");\n\n      const reader = response.body?.getReader();\n      const decoder = new TextDecoder();\n      let fullResponse = \"\";\n\n      if (reader) {\n        while (true) {\n          const { done, value } = await reader.read();\n          if (done) break;\n          \n          const chunk = decoder.decode(value);\n          const lines = chunk.split(\"\\n\");\n          \n          for (const line of lines) {\n            if (line.startsWith(\"data: \")) {\n              const data = line.slice(6);\n              if (data === \"[DONE]\") break;\n              try {\n                const parsed = JSON.parse(data);\n                if (parsed.content) {\n                  fullResponse += parsed.content;\n                }\n              } catch {\n                // Ignore parse errors\n              }\n            }\n          }\n        }\n      }\n\n      const goals: WeeklyGoal[] = [];\n      const goalLines = fullResponse.split(\"\\n\").filter(l => l.includes(\"Week\"));\n      \n      for (let i = 0; i < goalLines.length && i < ANALYTICS_CONFIG.limits.weeklyGoals; i++) {\n        const line = goalLines[i];\n        const parts = line.split(\"|\").map(p => sanitizeText(p));\n        if (parts.length >= 3) {\n          const weekPart = parts[0];\n          const week = weekPart.match(/Week\\s+[\\d-]+/)?.[0] || `Week ${i + 1}`;\n          const title = weekPart.replace(/Week\\s+[\\d-]+:\\s*/, \"\").trim();\n          const tasks = parts[1].split(\",\").map(t => t.trim()).filter(t => t.length > 0);\n          const target = parts[2].trim();\n          \n          goals.push({\n            week,\n            title,\n            tasks: tasks.length > 0 ? tasks : [\"Practice daily\", \"Focus on accuracy\", \"Build consistency\"],\n            target,\n            status: i === 0 ? \"current\" : i === 1 ? \"next\" : \"later\",\n          });\n        }\n      }\n\n      setWeeklyPlan(goals.length > 0 ? goals : generateFallbackWeeklyPlan(analytics));\n      toast.success(\"Weekly improvement plan generated!\");\n    } catch (error) {\n      if (error instanceof Error && error.name === 'AbortError') {\n        toast.error(\"AI request timed out. Using default plan.\");\n      } else {\n        console.error(\"Weekly plan error:\", error);\n        toast.error(\"Failed to generate weekly plan\");\n      }\n      setWeeklyPlan(generateFallbackWeeklyPlan(analytics));\n    } finally {\n      clearTimeout(timeoutId);\n      setLoadingWeeklyPlan(false);\n    }\n  };\n\n  const wpmTrend = useMemo(() => {\n    if (!analytics || analytics.wpmOverTime.length < 2) return 0;\n    return analytics.wpmOverTime[analytics.wpmOverTime.length - 1].wpm - analytics.wpmOverTime[0].wpm;\n  }, [analytics]);\n\n  const accuracyTrend = useMemo(() => {\n    if (!analytics || analytics.wpmOverTime.length < 2) return 0;\n    return analytics.wpmOverTime[analytics.wpmOverTime.length - 1].accuracy - analytics.wpmOverTime[0].accuracy;\n  }, [analytics]);\n\n  const totalTests = useMemo(() => {\n    if (!analytics) return 0;\n    return analytics.wpmOverTime.reduce((sum, d) => sum + safeNumber(d.testCount), 0);\n  }, [analytics]);\n\n  const formattedChartData = useMemo(() => {\n    if (!analytics) return [];\n    return analytics.wpmOverTime.map(d => ({\n      ...d,\n      formattedDate: formatChartDate(d.date),\n    }));\n  }, [analytics]);\n\n  if (authLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8 flex items-center justify-center min-h-[400px]\" data-testid=\"analytics-loading\">\n        <div className=\"flex flex-col items-center gap-4\">\n          <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n          <p className=\"text-muted-foreground\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!user) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\" data-testid=\"analytics-login-required\">\n        <Card className=\"max-w-md mx-auto\">\n          <CardHeader className=\"text-center\">\n            <div className=\"mx-auto w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mb-4\">\n              <LogIn className=\"w-6 h-6 text-primary\" />\n            </div>\n            <CardTitle>Login Required</CardTitle>\n            <CardDescription>\n              Sign in to view your personalized typing analytics and track your progress over time.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"flex flex-col gap-4\">\n            <Link href=\"/login\">\n              <Button className=\"w-full\" data-testid=\"button-login\">\n                <LogIn className=\"w-4 h-4 mr-2\" />\n                Sign In\n              </Button>\n            </Link>\n            <p className=\"text-center text-sm text-muted-foreground\">\n              Don't have an account?{\" \"}\n              <Link href=\"/register\" className=\"text-primary hover:underline\">\n                Create one\n              </Link>\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto p-6 max-w-7xl\">\n        <div className=\"flex items-center justify-center min-h-[400px]\">\n          <div className=\"text-center\">\n            <Loader2 className=\"w-8 h-8 animate-spin text-primary mx-auto mb-4\" />\n            <p className=\"text-muted-foreground\">Loading your analytics...</p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (isError) {\n    const isNetworkError = error instanceof Error && (\n      error.message.includes('network') || \n      error.message.includes('fetch') ||\n      error.message.includes('Failed to fetch') ||\n      error.message.includes('NetworkError')\n    );\n    const isTimeoutError = error instanceof Error && (\n      error.message.includes('timeout') ||\n      error.message.includes('Timeout') ||\n      error.message.includes('aborted')\n    );\n    const isAuthError = error instanceof Error && (\n      error.message.includes('401') ||\n      error.message.includes('unauthorized') ||\n      error.message.includes('Unauthorized')\n    );\n    \n    const getErrorIcon = () => {\n      if (isNetworkError) return <WifiOff className=\"h-4 w-4\" />;\n      if (isTimeoutError) return <Clock className=\"h-4 w-4\" />;\n      return <AlertTriangle className=\"h-4 w-4\" />;\n    };\n    \n    const getErrorTitle = () => {\n      if (isNetworkError) return \"Connection Problem\";\n      if (isTimeoutError) return \"Request Timed Out\";\n      if (isAuthError) return \"Authentication Required\";\n      return \"Failed to Load Analytics\";\n    };\n    \n    const getErrorMessage = () => {\n      if (isNetworkError) {\n        return \"Unable to connect to the server. Please check your internet connection and try again.\";\n      }\n      if (isTimeoutError) {\n        return \"The request took too long to complete. This might be due to a slow connection or server load.\";\n      }\n      if (isAuthError) {\n        return \"Your session may have expired. Please log in again to view your analytics.\";\n      }\n      return error instanceof Error ? error.message : 'Unable to load your analytics data. Please try again.';\n    };\n    \n    const getErrorHelp = () => {\n      if (isNetworkError) {\n        return \"Tip: Try refreshing the page or checking if other websites are loading.\";\n      }\n      if (isTimeoutError) {\n        return \"Tip: Try selecting a shorter time range (7 or 14 days) for faster loading.\";\n      }\n      return null;\n    };\n    \n    return (\n      <div className=\"container mx-auto p-6 max-w-7xl\">\n        <Alert variant=\"destructive\" data-testid=\"error-alert\">\n          {getErrorIcon()}\n          <AlertTitle>{getErrorTitle()}</AlertTitle>\n          <AlertDescription className=\"flex flex-col gap-3 mt-2\">\n            <span>{getErrorMessage()}</span>\n            {getErrorHelp() && (\n              <span className=\"text-xs opacity-80 flex items-center gap-1\">\n                <HelpCircle className=\"w-3 h-3\" />\n                {getErrorHelp()}\n              </span>\n            )}\n            <div className=\"flex gap-2 mt-1\">\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={() => refetch()}\n                data-testid=\"button-retry\"\n              >\n                <RefreshCw className=\"w-4 h-4 mr-2\" />\n                Retry\n              </Button>\n              {isAuthError && (\n                <Button \n                  variant=\"default\" \n                  size=\"sm\" \n                  onClick={() => (window.location.href = \"/login\")}\n                  data-testid=\"button-login\"\n                >\n                  <LogIn className=\"w-4 h-4 mr-2\" />\n                  Log In\n                </Button>\n              )}\n            </div>\n          </AlertDescription>\n        </Alert>\n      </div>\n    );\n  }\n\n  if (!isDataValid || !analytics || analytics.wpmOverTime.length === 0) {\n    return (\n      <div className=\"container mx-auto px-4 sm:px-6 py-6 max-w-7xl\">\n        <div className=\"text-center py-12\" data-testid=\"empty-analytics\">\n          <Keyboard className=\"w-16 h-16 mx-auto mb-4 text-muted-foreground\" />\n          <h2 className=\"text-2xl font-bold mb-2\">No Analytics Data Yet</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            Complete some typing tests to see your progress and insights\n          </p>\n          <Button onClick={() => (window.location.href = \"/\")} data-testid=\"button-start-test\">\n            Start Your First Test\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 sm:px-6 py-6 max-w-7xl space-y-4 sm:space-y-6\">\n      <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n        <div>\n          <h1 className=\"text-2xl sm:text-3xl font-bold\" data-testid=\"heading-analytics\">Progress Analytics</h1>\n          <p className=\"text-muted-foreground\">Track your typing improvement over time</p>\n        </div>\n        <div className=\"flex flex-wrap gap-2\">\n          {ANALYTICS_CONFIG.timeRangeOptions.map(days => (\n            <Button\n              key={days}\n              variant={selectedDays === days ? \"default\" : \"outline\"}\n              onClick={() => { setSelectedDays(days); refetch(); }}\n              data-testid={`button-timeframe-${days}`}\n            >\n              {days} Days\n            </Button>\n          ))}\n        </div>\n      </div>\n\n      {/* Partial Data Warning */}\n      {hasPartialData && (\n        <PartialDataWarning\n          hasWpmData={partialDataFlags.hasWpmData}\n          hasMistakeData={partialDataFlags.hasMistakeData}\n          hasCommonMistakes={partialDataFlags.hasCommonMistakes}\n        />\n      )}\n\n      {/* Key Metrics */}\n      <TooltipProvider>\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardDescription className=\"flex items-center gap-1\">\n                Average WPM\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Info className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                    <p>Words Per Minute - measures your typing speed. The average is calculated from all tests in the selected time period.</p>\n                  </TooltipContent>\n                </Tooltip>\n              </CardDescription>\n              <CardTitle className=\"text-3xl\" data-testid=\"stat-avg-wpm\">\n                {analytics.consistency.avgWpm.toFixed(1)}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex items-center gap-1 text-sm\">\n                {wpmTrend >= 0 ? (\n                  <TrendingUp className=\"w-4 h-4 text-green-500\" />\n                ) : (\n                  <TrendingDown className=\"w-4 h-4 text-red-500\" />\n                )}\n                <span className={wpmTrend >= 0 ? \"text-green-500\" : \"text-red-500\"}>\n                  {wpmTrend >= 0 ? \"+\" : \"\"}{wpmTrend.toFixed(1)} WPM\n                </span>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardDescription className=\"flex items-center gap-1\">\n                Consistency\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Info className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\" className=\"max-w-[220px]\">\n                    <p>How stable your typing speed is. Lower variation means more consistent performance. Excellent: &lt;10% variation, Good: 10-15%, Needs Work: &gt;15%.</p>\n                  </TooltipContent>\n                </Tooltip>\n              </CardDescription>\n              <CardTitle className=\"text-3xl\" data-testid=\"stat-consistency\">\n                {dynamicThresholds ? (\n                  dynamicThresholds.isInconsistent ? \"Needs Work\" : \n                  dynamicThresholds.coefficientOfVariation < ANALYTICS_CONFIG.consistency.excellentCV ? \"Excellent\" : \"Good\"\n                ) : \"Loading...\"}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <p className=\"text-sm text-muted-foreground\">\n                Â±{analytics.consistency.stdDeviation.toFixed(1)} WPM ({dynamicThresholds?.coefficientOfVariation.toFixed(0) || 0}% variation)\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardDescription className=\"flex items-center gap-1\">\n                Best WPM\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Info className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                    <p>Your highest typing speed achieved in a single test during this time period. This is your personal record to beat!</p>\n                  </TooltipContent>\n                </Tooltip>\n              </CardDescription>\n              <CardTitle className=\"text-3xl\" data-testid=\"stat-best-wpm\">\n                {analytics.consistency.maxWpm}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <p className=\"text-sm text-muted-foreground\">\n                Personal record\n              </p>\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader className=\"pb-2\">\n              <CardDescription className=\"flex items-center gap-1\">\n                Total Tests\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Info className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                    <p>The number of typing tests you've completed. More tests give you more accurate analytics and help track your improvement.</p>\n                  </TooltipContent>\n                </Tooltip>\n              </CardDescription>\n              <CardTitle className=\"text-3xl\" data-testid=\"stat-total-tests\">\n                {totalTests}\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <p className=\"text-sm text-muted-foreground\">\n                In last {selectedDays} days\n              </p>\n            </CardContent>\n          </Card>\n        </div>\n      </TooltipProvider>\n\n      <Tabs defaultValue=\"performance\" className=\"space-y-4\">\n        <TabsList className=\"grid w-full grid-cols-5\">\n          <TabsTrigger value=\"performance\" data-testid=\"tab-performance\">Performance</TabsTrigger>\n          <TabsTrigger value=\"keystroke\" data-testid=\"tab-keystroke\">Keystroke Analysis</TabsTrigger>\n          <TabsTrigger value=\"mistakes\" data-testid=\"tab-mistakes\">Mistakes</TabsTrigger>\n          <TabsTrigger value=\"insights\" data-testid=\"tab-insights\">AI Insights</TabsTrigger>\n          <TabsTrigger value=\"practice\" data-testid=\"tab-practice\">Practice Plan</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"performance\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>WPM Progress</CardTitle>\n              <CardDescription>Your typing speed over time</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <ResponsiveContainer width=\"100%\" height={300}>\n                <AreaChart data={analytics.wpmOverTime} aria-label=\"WPM Progress Chart\">\n                  <defs>\n                    <linearGradient id=\"colorWpm\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\">\n                      <stop offset=\"5%\" stopColor=\"#00ffff\" stopOpacity={0.3}/>\n                      <stop offset=\"95%\" stopColor=\"#00ffff\" stopOpacity={0}/>\n                    </linearGradient>\n                  </defs>\n                  <CartesianGrid strokeDasharray=\"3 3\" opacity={0.1} />\n                  <XAxis \n                    dataKey=\"date\" \n                    stroke=\"#888\" \n                    tickFormatter={formatChartDate}\n                    tick={{ fontSize: 12 }}\n                    angle={-45}\n                    textAnchor=\"end\"\n                    height={60}\n                  />\n                  <YAxis stroke=\"#888\" domain={['dataMin - 5', 'dataMax + 5']} />\n                  <ChartTooltip content={<WPMTooltip />} />\n                  <Area \n                    type=\"monotone\" \n                    dataKey=\"wpm\" \n                    stroke=\"#00ffff\" \n                    fillOpacity={1} \n                    fill=\"url(#colorWpm)\"\n                    name=\"WPM\"\n                  />\n                </AreaChart>\n              </ResponsiveContainer>\n            </CardContent>\n          </Card>\n\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Accuracy Trend</CardTitle>\n                <CardDescription>How accurate you've been typing</CardDescription>\n              </CardHeader>\n              <CardContent>\n                <ResponsiveContainer width=\"100%\" height={250}>\n                  <LineChart data={analytics.wpmOverTime} aria-label=\"Accuracy Trend Chart\">\n                    <CartesianGrid strokeDasharray=\"3 3\" opacity={0.1} />\n                    <XAxis \n                      dataKey=\"date\" \n                      stroke=\"#888\" \n                      tickFormatter={formatChartDate}\n                      tick={{ fontSize: 12 }}\n                      angle={-45}\n                      textAnchor=\"end\"\n                      height={60}\n                    />\n                    <YAxis \n                      stroke=\"#888\" \n                      domain={[\n                        (dataMin: number) => Math.max(0, Math.floor(dataMin - 5)),\n                        (dataMax: number) => Math.min(100, Math.ceil(dataMax + 2))\n                      ]}\n                      tickFormatter={(value) => `${value}%`}\n                    />\n                    <ChartTooltip content={<AccuracyTooltip />} />\n                    <Line type=\"monotone\" dataKey=\"accuracy\" stroke=\"#a855f7\" strokeWidth={2} dot={{ r: 4 }} name=\"Accuracy\" />\n                  </LineChart>\n                </ResponsiveContainer>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle>Consistency Metrics</CardTitle>\n                <CardDescription>WPM distribution and stability</CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm\">Average WPM</span>\n                  <Badge variant=\"outline\" data-testid=\"badge-avg-wpm\">{analytics.consistency.avgWpm.toFixed(1)}</Badge>\n                </div>\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm\">Standard Deviation</span>\n                  <Badge variant=\"outline\" data-testid=\"badge-std-dev\">Â±{analytics.consistency.stdDeviation.toFixed(1)}</Badge>\n                </div>\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm\">Min WPM</span>\n                  <Badge variant=\"outline\" data-testid=\"badge-min-wpm\">{analytics.consistency.minWpm}</Badge>\n                </div>\n                <div className=\"flex justify-between items-center\">\n                  <span className=\"text-sm\">Max WPM</span>\n                  <Badge variant=\"outline\" data-testid=\"badge-max-wpm\">{analytics.consistency.maxWpm}</Badge>\n                </div>\n                <Separator />\n                <div className=\"pt-2\">\n                  <p className=\"text-sm text-muted-foreground\">\n                    {dynamicThresholds ? (\n                      dynamicThresholds.coefficientOfVariation < ANALYTICS_CONFIG.consistency.excellentCV\n                        ? \"Excellent consistency! Your typing speed is very stable.\" \n                        : !dynamicThresholds.isInconsistent\n                        ? \"Good consistency. Minor variations in speed.\"\n                        : \"Variable performance. Focus on maintaining steady speed.\"\n                    ) : \"Loading consistency analysis...\"}\n                  </p>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Historical Trends Section */}\n          <Card data-testid=\"card-historical-trends\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <TrendingUp className=\"w-5 h-5 text-cyan-400\" />\n                Historical Trends\n              </CardTitle>\n              <CardDescription>Your improvement over weeks and months</CardDescription>\n            </CardHeader>\n            <CardContent>\n              {trendsLoading ? (\n                <div className=\"flex items-center justify-center py-8\" data-testid=\"trends-loading\">\n                  <Loader2 className=\"w-8 h-8 animate-spin text-muted-foreground\" />\n                  <span className=\"ml-2 text-muted-foreground\">Loading trends...</span>\n                </div>\n              ) : !trendsData?.trends || (trendsData.trends.weeklyAggregates?.length ?? 0) === 0 ? (\n                <div className=\"text-center py-8\" data-testid=\"trends-empty\">\n                  <Calendar className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground opacity-50\" />\n                  <h3 className=\"text-lg font-medium text-muted-foreground mb-2\">Not Enough Data Yet</h3>\n                  <p className=\"text-sm text-muted-foreground max-w-md mx-auto\">\n                    Complete more typing tests over several weeks to see your improvement trends.\n                  </p>\n                </div>\n              ) : (\n                <div className=\"space-y-6\" data-testid=\"trends-content\">\n                  {/* Improvement Summary */}\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                    <div className=\"bg-slate-800/50 rounded-lg p-4 border border-slate-700\" data-testid=\"trend-card-wow\">\n                      <p className=\"text-sm text-muted-foreground mb-1\">Week-over-Week</p>\n                      <div className=\"flex items-center gap-2\">\n                        {(trendsData.trends.improvement?.weekOverWeek?.wpm ?? 0) >= 0 ? (\n                          <TrendingUp className=\"w-5 h-5 text-green-400\" />\n                        ) : (\n                          <TrendingDown className=\"w-5 h-5 text-red-400\" />\n                        )}\n                        <span className={`text-2xl font-bold ${(trendsData.trends.improvement?.weekOverWeek?.wpm ?? 0) >= 0 ? 'text-green-400' : 'text-red-400'}`} data-testid=\"trend-wow-wpm\">\n                          {(trendsData.trends.improvement?.weekOverWeek?.wpm ?? 0) >= 0 ? '+' : ''}{(trendsData.trends.improvement?.weekOverWeek?.wpm ?? 0).toFixed(1)} WPM\n                        </span>\n                      </div>\n                      <p className=\"text-xs text-muted-foreground mt-1\" data-testid=\"trend-wow-accuracy\">\n                        Accuracy: {(trendsData.trends.improvement?.weekOverWeek?.accuracy ?? 0) >= 0 ? '+' : ''}{(trendsData.trends.improvement?.weekOverWeek?.accuracy ?? 0).toFixed(1)}%\n                      </p>\n                    </div>\n\n                    <div className=\"bg-slate-800/50 rounded-lg p-4 border border-slate-700\" data-testid=\"trend-card-mom\">\n                      <p className=\"text-sm text-muted-foreground mb-1\">Month-over-Month</p>\n                      <div className=\"flex items-center gap-2\">\n                        {(trendsData.trends.improvement?.monthOverMonth?.wpm ?? 0) >= 0 ? (\n                          <TrendingUp className=\"w-5 h-5 text-green-400\" />\n                        ) : (\n                          <TrendingDown className=\"w-5 h-5 text-red-400\" />\n                        )}\n                        <span className={`text-2xl font-bold ${(trendsData.trends.improvement?.monthOverMonth?.wpm ?? 0) >= 0 ? 'text-green-400' : 'text-red-400'}`} data-testid=\"trend-mom-wpm\">\n                          {(trendsData.trends.improvement?.monthOverMonth?.wpm ?? 0) >= 0 ? '+' : ''}{(trendsData.trends.improvement?.monthOverMonth?.wpm ?? 0).toFixed(1)} WPM\n                        </span>\n                      </div>\n                      <p className=\"text-xs text-muted-foreground mt-1\" data-testid=\"trend-mom-accuracy\">\n                        Accuracy: {(trendsData.trends.improvement?.monthOverMonth?.accuracy ?? 0) >= 0 ? '+' : ''}{(trendsData.trends.improvement?.monthOverMonth?.accuracy ?? 0).toFixed(1)}%\n                      </p>\n                    </div>\n\n                    <div className=\"bg-slate-800/50 rounded-lg p-4 border border-slate-700\" data-testid=\"trend-card-alltime\">\n                      <p className=\"text-sm text-muted-foreground mb-1\">All-Time Improvement</p>\n                      <div className=\"flex items-center gap-2\">\n                        {(trendsData.trends.improvement?.allTime?.improvementPercent ?? 0) >= 0 ? (\n                          <TrendingUp className=\"w-5 h-5 text-cyan-400\" />\n                        ) : (\n                          <TrendingDown className=\"w-5 h-5 text-orange-400\" />\n                        )}\n                        <span className={`text-2xl font-bold ${(trendsData.trends.improvement?.allTime?.improvementPercent ?? 0) >= 0 ? 'text-cyan-400' : 'text-orange-400'}`} data-testid=\"trend-alltime\">\n                          {(trendsData.trends.improvement?.allTime?.improvementPercent ?? 0) >= 0 ? '+' : ''}{(trendsData.trends.improvement?.allTime?.improvementPercent ?? 0).toFixed(0)}%\n                        </span>\n                      </div>\n                      <p className=\"text-xs text-muted-foreground mt-1\" data-testid=\"trend-alltime-range\">\n                        {(trendsData.trends.improvement?.allTime?.firstWpm ?? 0).toFixed(0)} â†’ {(trendsData.trends.improvement?.allTime?.currentWpm ?? 0).toFixed(0)} WPM\n                      </p>\n                    </div>\n                  </div>\n\n                  {/* Weekly WPM Chart */}\n                  {(trendsData.trends.weeklyAggregates?.length ?? 0) > 1 && (\n                    <div data-testid=\"weekly-chart-container\">\n                      <h4 className=\"text-sm font-medium mb-3\">Weekly Average WPM</h4>\n                      <ResponsiveContainer width=\"100%\" height={200}>\n                        <BarChart data={trendsData.trends.weeklyAggregates} aria-label=\"Weekly WPM Chart\">\n                          <CartesianGrid strokeDasharray=\"3 3\" opacity={0.1} />\n                          <XAxis \n                            dataKey=\"weekStart\" \n                            stroke=\"#888\" \n                            tickFormatter={(val) => {\n                              try { return format(parseISO(val), 'MMM d'); } catch { return val; }\n                            }}\n                            tick={{ fontSize: 11 }}\n                          />\n                          <YAxis stroke=\"#888\" domain={['dataMin - 5', 'dataMax + 5']} />\n                          <ChartTooltip \n                            content={({ active, payload }) => {\n                              if (!active || !payload || !payload.length) return null;\n                              const data = payload[0].payload;\n                              const weekStartStr = data?.weekStart ? (() => { try { return format(parseISO(data.weekStart), 'MMM d'); } catch { return data.weekStart; } })() : 'N/A';\n                              const weekEndStr = data?.weekEnd ? (() => { try { return format(parseISO(data.weekEnd), 'MMM d'); } catch { return data.weekEnd; } })() : 'N/A';\n                              return (\n                                <div className=\"bg-slate-800 border border-slate-700 rounded-lg p-3 shadow-lg\">\n                                  <p className=\"text-sm font-medium text-white mb-1\">\n                                    {weekStartStr} - {weekEndStr}\n                                  </p>\n                                  <p className=\"text-sm text-cyan-400\">Avg WPM: {(data?.avgWpm ?? 0).toFixed(1)}</p>\n                                  <p className=\"text-sm text-purple-400\">Best WPM: {data?.bestWpm ?? 'N/A'}</p>\n                                  <p className=\"text-sm text-muted-foreground\">{data?.testCount ?? 0} tests</p>\n                                </div>\n                              );\n                            }}\n                          />\n                          <Bar dataKey=\"avgWpm\" fill=\"#00ffff\" radius={[4, 4, 0, 0]} name=\"Avg WPM\" />\n                        </BarChart>\n                      </ResponsiveContainer>\n                    </div>\n                  )}\n\n                  {/* Monthly Summary */}\n                  {(trendsData.trends.monthlyAggregates?.length ?? 0) > 0 && (\n                    <div data-testid=\"monthly-summary-container\">\n                      <h4 className=\"text-sm font-medium mb-3\">Monthly Summary</h4>\n                      <div className=\"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3\">\n                        {trendsData.trends.monthlyAggregates.slice(0, 6).map((month, idx) => {\n                          const monthLabel = month?.month ? (() => { try { return format(parseISO(month.month + '-01'), 'MMM yyyy'); } catch { return month.month; } })() : 'N/A';\n                          return (\n                            <div key={idx} className=\"bg-slate-800/30 rounded-lg p-3 border border-slate-700/50\" data-testid={`monthly-card-${idx}`}>\n                              <p className=\"text-xs text-muted-foreground\">{monthLabel}</p>\n                              <p className=\"text-lg font-bold text-cyan-400\" data-testid={`monthly-wpm-${idx}`}>{(month?.avgWpm ?? 0).toFixed(0)}</p>\n                              <p className=\"text-xs text-muted-foreground\" data-testid={`monthly-tests-${idx}`}>{month?.testCount ?? 0} tests</p>\n                            </div>\n                          );\n                        })}\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Milestones */}\n                  {(trendsData.trends.milestones?.length ?? 0) > 0 && (\n                    <div data-testid=\"milestones-container\">\n                      <h4 className=\"text-sm font-medium mb-3\">Speed Milestones</h4>\n                      <div className=\"flex flex-wrap gap-2\">\n                        {trendsData.trends.milestones.map((milestone, idx) => {\n                          const dateStr = milestone?.achievedAt ? (() => { try { return format(parseISO(milestone.achievedAt), 'MMM d, yyyy'); } catch { return milestone.achievedAt; } })() : 'N/A';\n                          return (\n                            <Badge key={idx} variant=\"secondary\" className=\"bg-cyan-500/10 text-cyan-400 border-cyan-500/30\" data-testid={`milestone-${idx}`}>\n                              {milestone?.value ?? 0} WPM ({dateStr})\n                            </Badge>\n                          );\n                        })}\n                      </div>\n                    </div>\n                  )}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"keystroke\" className=\"space-y-4\">\n          {!keystrokeData?.analytics ? (\n            <Card>\n              <CardContent className=\"py-12\">\n                <div className=\"text-center\">\n                  <Keyboard className=\"w-16 h-16 mx-auto mb-4 text-muted-foreground opacity-50\" />\n                  <h3 className=\"text-xl font-semibold mb-2\">No Keystroke Data Available</h3>\n                  <p className=\"text-muted-foreground mb-4\">\n                    Complete a typing test with keystroke tracking enabled to see detailed analytics\n                  </p>\n                  <Button onClick={() => (window.location.href = \"/\")} data-testid=\"button-start-test-keystroke\">\n                    Start a Test\n                  </Button>\n                </div>\n              </CardContent>\n            </Card>\n          ) : (\n            <>\n              {/* Timing Metrics */}\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      Average Dwell Time\n                      <TooltipProvider>\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <HelpCircle className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                          </TooltipTrigger>\n                          <TooltipContent side=\"top\" className=\"max-w-[220px]\">\n                            <p>How long you hold each key down. Shorter times (70-100ms) indicate faster finger release. Longer times may indicate hesitation.</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      </TooltipProvider>\n                    </CardDescription>\n                    <CardTitle className={`text-3xl ${keystrokeData.analytics.avgDwellTime && keystrokeData.analytics.avgDwellTime < 100 ? 'text-green-400' : keystrokeData.analytics.avgDwellTime && keystrokeData.analytics.avgDwellTime > 150 ? 'text-orange-400' : ''}`} data-testid=\"stat-avg-dwell\">\n                      {keystrokeData.analytics.avgDwellTime?.toFixed(0) || 'N/A'} ms\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {keystrokeData.analytics.avgDwellTime && keystrokeData.analytics.avgDwellTime < 100 \n                        ? \"âœ“ Quick key release\" \n                        : keystrokeData.analytics.avgDwellTime && keystrokeData.analytics.avgDwellTime > 150 \n                        ? \"âš ï¸ Keys held too long\" \n                        : \"Time keys are held down\"}\n                    </p>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      Average Flight Time\n                      <TooltipProvider>\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <HelpCircle className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                          </TooltipTrigger>\n                          <TooltipContent side=\"top\" className=\"max-w-[220px]\">\n                            <p>Time between releasing one key and pressing the next. Lower times (80-120ms) indicate faster transitions and better muscle memory.</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      </TooltipProvider>\n                    </CardDescription>\n                    <CardTitle className={`text-3xl ${keystrokeData.analytics.avgFlightTime && keystrokeData.analytics.avgFlightTime < 100 ? 'text-green-400' : keystrokeData.analytics.avgFlightTime && keystrokeData.analytics.avgFlightTime > 180 ? 'text-orange-400' : ''}`} data-testid=\"stat-avg-flight\">\n                      {keystrokeData.analytics.avgFlightTime?.toFixed(0) || 'N/A'} ms\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {keystrokeData.analytics.avgFlightTime && keystrokeData.analytics.avgFlightTime < 100 \n                        ? \"âœ“ Fast transitions\" \n                        : keystrokeData.analytics.avgFlightTime && keystrokeData.analytics.avgFlightTime > 180 \n                        ? \"âš ï¸ Slow key transitions\" \n                        : \"Time between keystrokes\"}\n                    </p>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      Consistency Score\n                      <TooltipProvider>\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <HelpCircle className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                          </TooltipTrigger>\n                          <TooltipContent side=\"top\" className=\"max-w-[220px]\">\n                            <p>How stable your typing rhythm is. Higher scores (80%+) indicate consistent timing between keystrokes, like a metronome. Lower scores suggest variable rhythm.</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      </TooltipProvider>\n                    </CardDescription>\n                    <CardTitle className={`text-3xl ${keystrokeData.analytics.consistency && keystrokeData.analytics.consistency >= 80 ? 'text-green-400' : keystrokeData.analytics.consistency && keystrokeData.analytics.consistency < 60 ? 'text-orange-400' : ''}`} data-testid=\"stat-consistency-score\">\n                      {keystrokeData.analytics.consistency?.toFixed(1) || 'N/A'}%\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {keystrokeData.analytics.consistency && keystrokeData.analytics.consistency >= 80 \n                        ? \"âœ“ Excellent rhythm\" \n                        : keystrokeData.analytics.consistency && keystrokeData.analytics.consistency < 60 \n                        ? \"âš ï¸ Rhythm needs work\" \n                        : \"Typing rhythm stability\"}\n                    </p>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Enhanced Industry Metrics */}\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      Burst WPM\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Info className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                        </TooltipTrigger>\n                        <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                          <p>Your peak typing speed over any 5-second window. This is your burst speed potential.</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </CardDescription>\n                    <CardTitle className=\"text-3xl text-cyan-400\" data-testid=\"stat-burst-wpm\">\n                      {keystrokeData.analytics.burstWpm ?? 'N/A'}\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground\">Peak 5-second speed</p>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      Adjusted WPM\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Info className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                        </TooltipTrigger>\n                        <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                          <p>Your WPM with error penalty applied. More accurate than raw WPM for skill assessment.</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </CardDescription>\n                    <CardTitle className=\"text-3xl text-purple-400\" data-testid=\"stat-adjusted-wpm\">\n                      {keystrokeData.analytics.adjustedWpm ?? 'N/A'}\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground\">Error-adjusted speed</p>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      Typing Rhythm\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Info className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                        </TooltipTrigger>\n                        <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                          <p>How consistent your keystroke timing is. Higher = more rhythmic typing like a pro.</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </CardDescription>\n                    <CardTitle className=\"text-3xl text-green-400\" data-testid=\"stat-typing-rhythm\">\n                      {keystrokeData.analytics.typingRhythm?.toFixed(0) ?? 'N/A'}\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground\">Rhythm score (0-100)</p>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      Fatigue\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Info className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                        </TooltipTrigger>\n                        <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                          <p>Speed change from first to second half. Positive = you slowed down, negative = you warmed up.</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </CardDescription>\n                    <CardTitle className={`text-3xl ${keystrokeData.analytics.fatigueIndicator !== null && keystrokeData.analytics.fatigueIndicator > 0 ? 'text-orange-400' : 'text-green-400'}`} data-testid=\"stat-fatigue\">\n                      {keystrokeData.analytics.fatigueIndicator !== null ? `${keystrokeData.analytics.fatigueIndicator > 0 ? '+' : ''}${keystrokeData.analytics.fatigueIndicator.toFixed(0)}%` : 'N/A'}\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {keystrokeData.analytics.fatigueIndicator !== null && keystrokeData.analytics.fatigueIndicator > 5 \n                        ? 'Slowing down' \n                        : keystrokeData.analytics.fatigueIndicator !== null && keystrokeData.analytics.fatigueIndicator < -5 \n                        ? 'Warming up' \n                        : 'Steady pace'}\n                    </p>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Additional Performance Metrics */}\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription className=\"flex items-center gap-1\">\n                      Rhythm Rating\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Info className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                        </TooltipTrigger>\n                        <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                          <p>Your typing rhythm quality based on consistency. Higher = more consistent key timing.</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </CardDescription>\n                    <CardTitle className=\"text-2xl\" data-testid=\"stat-rhythm-rating\">\n                      {keystrokeData.analytics.consistencyRating !== null \n                        ? `${keystrokeData.analytics.consistencyRating}/100` \n                        : 'N/A'}\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground\">Based on timing variance</p>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader className=\"pb-2\">\n                    <CardDescription>Error Bursts</CardDescription>\n                    <CardTitle className=\"text-2xl\" data-testid=\"stat-error-bursts\">\n                      {keystrokeData.analytics.errorBurstCount ?? 'N/A'}\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground\">Consecutive error sequences</p>\n                  </CardContent>\n                </Card>\n\n                {keystrokeData.analytics.peakPerformanceWindow && (\n                  <Card>\n                    <CardHeader className=\"pb-2\">\n                      <CardDescription>Peak Performance</CardDescription>\n                      <CardTitle className=\"text-2xl text-cyan-400\" data-testid=\"stat-peak-performance\">\n                        {keystrokeData.analytics.peakPerformanceWindow.wpm} WPM\n                      </CardTitle>\n                    </CardHeader>\n                    <CardContent>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Best 20% window (pos {keystrokeData.analytics.peakPerformanceWindow.startPos}-{keystrokeData.analytics.peakPerformanceWindow.endPos})\n                      </p>\n                    </CardContent>\n                  </Card>\n                )}\n              </div>\n\n              {/* Rolling Accuracy Trend */}\n              {keystrokeData.analytics.rollingAccuracy && keystrokeData.analytics.rollingAccuracy.length > 0 && (\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      Accuracy Throughout Test\n                      <TooltipProvider>\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                          </TooltipTrigger>\n                          <TooltipContent side=\"right\" className=\"max-w-xs\">\n                            <p>Tracks your accuracy at different points during the test. Declining accuracy may indicate fatigue or rushing. Consistent accuracy shows good technique.</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      </TooltipProvider>\n                    </CardTitle>\n                    <CardDescription>How your accuracy changed as you typed</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <ResponsiveContainer width=\"100%\" height={200}>\n                      <BarChart data={keystrokeData.analytics.rollingAccuracy.map((acc, idx) => ({\n                        chunk: `${(idx + 1) * 20}%`,\n                        accuracy: acc,\n                        position: idx + 1\n                      }))}>\n                        <CartesianGrid strokeDasharray=\"3 3\" opacity={0.1} />\n                        <XAxis dataKey=\"chunk\" stroke=\"#888\" />\n                        <YAxis stroke=\"#888\" domain={[0, 100]} tickFormatter={(v) => `${v}%`} />\n                        <ChartTooltip \n                          contentStyle={{ backgroundColor: \"#1e293b\", border: \"1px solid #334155\" }}\n                          content={({ active, payload }) => {\n                            if (!active || !payload || !payload.length) return null;\n                            const data = payload[0]?.payload as { chunk: string; accuracy: number; position: number };\n                            const isGood = data.accuracy >= 95;\n                            const isOkay = data.accuracy >= 90;\n                            return (\n                              <div className=\"bg-slate-800 border border-slate-700 rounded-lg p-3 shadow-lg\">\n                                <p className=\"text-sm font-bold text-white mb-1\">Position: {data.chunk}</p>\n                                <p className={`text-sm ${isGood ? 'text-green-400' : isOkay ? 'text-yellow-400' : 'text-red-400'}`}>\n                                  Accuracy: {data.accuracy.toFixed(1)}%\n                                </p>\n                                <p className=\"text-xs text-muted-foreground mt-1\">\n                                  {isGood ? 'âœ“ Excellent accuracy' : isOkay ? 'âš ï¸ Could improve' : 'âš ï¸ Focus on accuracy here'}\n                                </p>\n                              </div>\n                            );\n                          }}\n                        />\n                        <Bar dataKey=\"accuracy\" fill=\"#a855f7\" />\n                      </BarChart>\n                    </ResponsiveContainer>\n                  </CardContent>\n                </Card>\n              )}\n\n              {/* Top & Bottom Digraphs */}\n              {(keystrokeData.analytics.topDigraphs || keystrokeData.analytics.bottomDigraphs) && (\n                <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n                  {keystrokeData.analytics.topDigraphs && keystrokeData.analytics.topDigraphs.length > 0 && (\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"flex items-center gap-2 text-green-400\">\n                          Fastest Digraphs\n                          <TooltipProvider>\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                              </TooltipTrigger>\n                              <TooltipContent side=\"right\" className=\"max-w-xs\">\n                                <p>A digraph is a two-letter combination. These are your fastest key pairs - your fingers have strong muscle memory for these transitions.</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          </TooltipProvider>\n                        </CardTitle>\n                        <CardDescription>Your top 5 fastest two-key combinations</CardDescription>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"space-y-2\">\n                          {keystrokeData.analytics.topDigraphs.map((d, idx) => (\n                            <TooltipProvider key={idx}>\n                              <Tooltip>\n                                <TooltipTrigger asChild>\n                                  <div className=\"flex items-center justify-between p-2 rounded bg-green-500/10 border border-green-500/20 hover:bg-green-500/20 transition-colors cursor-help\">\n                                    <div className=\"flex items-center gap-3\">\n                                      <span className=\"text-xs text-muted-foreground\">#{idx + 1}</span>\n                                      <span className=\"font-mono text-lg\">{d.digraph}</span>\n                                    </div>\n                                    <div className=\"flex items-center gap-2\">\n                                      <Badge variant=\"outline\" className=\"bg-green-500/20\">{d.avgTime}ms</Badge>\n                                      <span className=\"text-xs text-muted-foreground\">{d.count}x</span>\n                                    </div>\n                                  </div>\n                                </TooltipTrigger>\n                                <TooltipContent side=\"left\">\n                                  <p>You typed \"{d.digraph}\" {d.count} times with an average speed of {d.avgTime}ms</p>\n                                  <p className=\"text-xs text-green-400 mt-1\">âœ“ Strong muscle memory</p>\n                                </TooltipContent>\n                              </Tooltip>\n                            </TooltipProvider>\n                          ))}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  )}\n\n                  {keystrokeData.analytics.bottomDigraphs && keystrokeData.analytics.bottomDigraphs.length > 0 && (\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"flex items-center gap-2 text-red-400\">\n                          Slowest Digraphs\n                          <TooltipProvider>\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                              </TooltipTrigger>\n                              <TooltipContent side=\"right\" className=\"max-w-xs\">\n                                <p>These key pairs take you longer to type. Practice these combinations specifically to build faster muscle memory.</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          </TooltipProvider>\n                        </CardTitle>\n                        <CardDescription>Two-key combinations that need practice</CardDescription>\n                      </CardHeader>\n                      <CardContent>\n                        <div className=\"space-y-2\">\n                          {keystrokeData.analytics.bottomDigraphs.map((d, idx) => (\n                            <TooltipProvider key={idx}>\n                              <Tooltip>\n                                <TooltipTrigger asChild>\n                                  <div className=\"flex items-center justify-between p-2 rounded bg-red-500/10 border border-red-500/20 hover:bg-red-500/20 transition-colors cursor-help\">\n                                    <div className=\"flex items-center gap-3\">\n                                      <span className=\"text-xs text-muted-foreground\">#{idx + 1}</span>\n                                      <span className=\"font-mono text-lg\">{d.digraph}</span>\n                                    </div>\n                                    <div className=\"flex items-center gap-2\">\n                                      <Badge variant=\"outline\" className=\"bg-red-500/20\">{d.avgTime}ms</Badge>\n                                      <span className=\"text-xs text-muted-foreground\">{d.count}x</span>\n                                    </div>\n                                  </div>\n                                </TooltipTrigger>\n                                <TooltipContent side=\"left\">\n                                  <p>You typed \"{d.digraph}\" {d.count} times with an average speed of {d.avgTime}ms</p>\n                                  <p className=\"text-xs text-orange-400 mt-1\">âš ï¸ Focus practice on this combination</p>\n                                </TooltipContent>\n                              </Tooltip>\n                            </TooltipProvider>\n                          ))}\n                        </div>\n                      </CardContent>\n                    </Card>\n                  )}\n                </div>\n              )}\n\n              {/* Finger Usage and Hand Balance */}\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      Finger Usage Distribution\n                      <TooltipProvider>\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                          </TooltipTrigger>\n                          <TooltipContent side=\"right\" className=\"max-w-xs\">\n                            <p>Shows how many keystrokes each finger made. Balanced usage across fingers indicates good technique. Heavy index finger usage is common and normal.</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      </TooltipProvider>\n                    </CardTitle>\n                    <CardDescription>Keystrokes per finger</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    {keystrokeData.analytics.fingerUsage ? (\n                      <ResponsiveContainer width=\"100%\" height={250}>\n                        <BarChart data={Object.entries(keystrokeData.analytics.fingerUsage).map(([finger, count]) => ({\n                          finger: finger.replace('Left ', 'L ').replace('Right ', 'R '),\n                          fullName: finger,\n                          count: count\n                        }))}>\n                          <CartesianGrid strokeDasharray=\"3 3\" opacity={0.1} />\n                          <XAxis dataKey=\"finger\" stroke=\"#888\" angle={-45} textAnchor=\"end\" height={80} />\n                          <YAxis stroke=\"#888\" />\n                          <ChartTooltip \n                            contentStyle={{ backgroundColor: \"#1e293b\", border: \"1px solid #334155\" }}\n                            content={({ active, payload }) => {\n                              if (!active || !payload || !payload.length) return null;\n                              const data = payload[0]?.payload as { finger: string; fullName: string; count: number };\n                              const total = Object.values(keystrokeData.analytics.fingerUsage || {}).reduce((a: number, b: number) => a + b, 0);\n                              const percentage = total > 0 ? ((data.count / total) * 100).toFixed(1) : '0';\n                              return (\n                                <div className=\"bg-slate-800 border border-slate-700 rounded-lg p-3 shadow-lg\">\n                                  <p className=\"text-sm font-bold text-white mb-1\">{data.fullName}</p>\n                                  <p className=\"text-sm text-cyan-400\">{data.count} keystrokes</p>\n                                  <p className=\"text-xs text-muted-foreground\">{percentage}% of total</p>\n                                </div>\n                              );\n                            }}\n                          />\n                          <Bar dataKey=\"count\" fill=\"#00ffff\" />\n                        </BarChart>\n                      </ResponsiveContainer>\n                    ) : (\n                      <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n                        <Keyboard className=\"w-10 h-10 text-muted-foreground mb-3\" />\n                        <p className=\"text-sm text-muted-foreground\">No finger usage data available</p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">Complete a typing test to see finger usage patterns</p>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      Hand Balance\n                      <TooltipProvider>\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                          </TooltipTrigger>\n                          <TooltipContent side=\"right\" className=\"max-w-xs\">\n                            <p>Compares left vs right hand usage. A 45-55% split is ideal. Significant imbalance may indicate technique issues or content bias.</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      </TooltipProvider>\n                    </CardTitle>\n                    <CardDescription>Left vs Right hand usage</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    {keystrokeData.analytics.handBalance !== null && keystrokeData.analytics.handBalance !== undefined ? (\n                      <div className=\"space-y-4\">\n                        <TooltipProvider>\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <div className=\"flex items-center justify-between cursor-help\">\n                                <span className=\"text-sm font-medium\">Left Hand</span>\n                                <Badge variant=\"outline\" className={`text-lg ${keystrokeData.analytics.handBalance > 55 ? 'border-blue-500 text-blue-400' : ''}`}>\n                                  {keystrokeData.analytics.handBalance.toFixed(1)}%\n                                </Badge>\n                              </div>\n                            </TooltipTrigger>\n                            <TooltipContent>\n                              <p>Left hand performed {keystrokeData.analytics.handBalance.toFixed(1)}% of all keystrokes</p>\n                            </TooltipContent>\n                          </Tooltip>\n                        </TooltipProvider>\n                        <div className=\"w-full h-8 bg-secondary rounded-full overflow-hidden flex\">\n                          <div \n                            className=\"bg-blue-500 transition-all duration-500\"\n                            style={{ width: `${keystrokeData.analytics.handBalance}%` }}\n                          />\n                          <div \n                            className=\"bg-purple-500 transition-all duration-500\"\n                            style={{ width: `${100 - keystrokeData.analytics.handBalance}%` }}\n                          />\n                        </div>\n                        <TooltipProvider>\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <div className=\"flex items-center justify-between cursor-help\">\n                                <span className=\"text-sm font-medium\">Right Hand</span>\n                                <Badge variant=\"outline\" className={`text-lg ${(100 - keystrokeData.analytics.handBalance) > 55 ? 'border-purple-500 text-purple-400' : ''}`}>\n                                  {(100 - keystrokeData.analytics.handBalance).toFixed(1)}%\n                                </Badge>\n                              </div>\n                            </TooltipTrigger>\n                            <TooltipContent>\n                              <p>Right hand performed {(100 - keystrokeData.analytics.handBalance).toFixed(1)}% of all keystrokes</p>\n                            </TooltipContent>\n                          </Tooltip>\n                        </TooltipProvider>\n                        <Separator />\n                        <p className={`text-sm text-center ${Math.abs(keystrokeData.analytics.handBalance - 50) < 10 ? 'text-green-400' : 'text-orange-400'}`}>\n                          {Math.abs(keystrokeData.analytics.handBalance - 50) < 5 \n                            ? \"âœ“ Excellent hand balance\" \n                            : Math.abs(keystrokeData.analytics.handBalance - 50) < 10 \n                            ? \"ðŸŽ¯ Well balanced hand usage\" \n                            : Math.abs(keystrokeData.analytics.handBalance - 50) < 20\n                            ? \"âš ï¸ Slight imbalance - consider practicing with your weaker hand\"\n                            : \"âš ï¸ Significant imbalance - focus on weaker hand exercises\"}\n                        </p>\n                      </div>\n                    ) : (\n                      <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n                        <Target className=\"w-10 h-10 text-muted-foreground mb-3\" />\n                        <p className=\"text-sm text-muted-foreground\">No hand balance data available</p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">Complete a typing test to see hand usage</p>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Keyboard Heatmap */}\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    Keyboard Heatmap\n                    <TooltipProvider>\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                        </TooltipTrigger>\n                        <TooltipContent side=\"right\" className=\"max-w-xs\">\n                          <p>Shows which keys you pressed most frequently. Brighter keys were used more often. Hover over any key to see exact count. This helps identify which keys get the most practice.</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </TooltipProvider>\n                  </CardTitle>\n                  <CardDescription>Visual representation of key usage frequency</CardDescription>\n                </CardHeader>\n                <CardContent>\n                  {keystrokeData.analytics.keyHeatmap ? (\n                    <div className=\"overflow-x-auto\">\n                      <div className=\"min-w-[600px] space-y-1\">\n                        {/* Number row */}\n                        <div className=\"flex gap-1 justify-center\">\n                          {['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'].map(key => {\n                            const count = keystrokeData.analytics.keyHeatmap?.[key] || 0;\n                            const maxCount = Math.max(...(Object.values(keystrokeData.analytics.keyHeatmap || {}) as number[]));\n                            const intensity = maxCount > 0 ? (count / maxCount) * 100 : 0;\n                            return (\n                              <div\n                                key={key}\n                                className=\"w-12 h-12 rounded border border-border flex items-center justify-center font-mono text-sm transition-all hover:scale-110\"\n                                style={{\n                                  backgroundColor: `rgba(0, 255, 255, ${intensity / 100 * 0.5})`,\n                                  boxShadow: intensity > 50 ? '0 0 10px rgba(0, 255, 255, 0.3)' : 'none'\n                                }}\n                                title={`${key}: ${count} times`}\n                              >\n                                {key}\n                              </div>\n                            );\n                          })}\n                        </div>\n                        {/* QWERTY row */}\n                        <div className=\"flex gap-1 justify-center\">\n                          {['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'].map(key => {\n                            const count = keystrokeData.analytics.keyHeatmap?.[key.toLowerCase()] || keystrokeData.analytics.keyHeatmap?.[key] || 0;\n                            const maxCount = Math.max(...(Object.values(keystrokeData.analytics.keyHeatmap || {}) as number[]));\n                            const intensity = maxCount > 0 ? (count / maxCount) * 100 : 0;\n                            return (\n                              <div\n                                key={key}\n                                className=\"w-12 h-12 rounded border border-border flex items-center justify-center font-mono text-sm transition-all hover:scale-110\"\n                                style={{\n                                  backgroundColor: `rgba(0, 255, 255, ${intensity / 100 * 0.5})`,\n                                  boxShadow: intensity > 50 ? '0 0 10px rgba(0, 255, 255, 0.3)' : 'none'\n                                }}\n                                title={`${key}: ${count} times`}\n                              >\n                                {key}\n                              </div>\n                            );\n                          })}\n                        </div>\n                        {/* ASDF row */}\n                        <div className=\"flex gap-1 justify-center ml-6\">\n                          {['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L'].map(key => {\n                            const count = keystrokeData.analytics.keyHeatmap?.[key.toLowerCase()] || keystrokeData.analytics.keyHeatmap?.[key] || 0;\n                            const maxCount = Math.max(...(Object.values(keystrokeData.analytics.keyHeatmap || {}) as number[]));\n                            const intensity = maxCount > 0 ? (count / maxCount) * 100 : 0;\n                            return (\n                              <div\n                                key={key}\n                                className=\"w-12 h-12 rounded border border-border flex items-center justify-center font-mono text-sm transition-all hover:scale-110\"\n                                style={{\n                                  backgroundColor: `rgba(0, 255, 255, ${intensity / 100 * 0.5})`,\n                                  boxShadow: intensity > 50 ? '0 0 10px rgba(0, 255, 255, 0.3)' : 'none'\n                                }}\n                                title={`${key}: ${count} times`}\n                              >\n                                {key}\n                              </div>\n                            );\n                          })}\n                        </div>\n                        {/* ZXCV row */}\n                        <div className=\"flex gap-1 justify-center ml-12\">\n                          {['Z', 'X', 'C', 'V', 'B', 'N', 'M'].map(key => {\n                            const count = keystrokeData.analytics.keyHeatmap?.[key.toLowerCase()] || keystrokeData.analytics.keyHeatmap?.[key] || 0;\n                            const maxCount = Math.max(...(Object.values(keystrokeData.analytics.keyHeatmap || {}) as number[]));\n                            const intensity = maxCount > 0 ? (count / maxCount) * 100 : 0;\n                            return (\n                              <div\n                                key={key}\n                                className=\"w-12 h-12 rounded border border-border flex items-center justify-center font-mono text-sm transition-all hover:scale-110\"\n                                style={{\n                                  backgroundColor: `rgba(0, 255, 255, ${intensity / 100 * 0.5})`,\n                                  boxShadow: intensity > 50 ? '0 0 10px rgba(0, 255, 255, 0.3)' : 'none'\n                                }}\n                                title={`${key}: ${count} times`}\n                              >\n                                {key}\n                              </div>\n                            );\n                          })}\n                        </div>\n                        {/* Spacebar */}\n                        <div className=\"flex gap-1 justify-center mt-1\">\n                          <div className=\"w-64 h-12 rounded border border-border flex items-center justify-center font-mono text-sm transition-all hover:scale-105\"\n                            style={{\n                              backgroundColor: `rgba(0, 255, 255, ${((keystrokeData.analytics.keyHeatmap?.[' '] || 0) / Math.max(...(Object.values(keystrokeData.analytics.keyHeatmap || {}) as number[]))) * 0.5})`,\n                            }}\n                            title={`SPACE: ${keystrokeData.analytics.keyHeatmap?.[' '] || 0} times`}\n                          >\n                            SPACE\n                          </div>\n                        </div>\n                        <div className=\"flex items-center justify-center gap-4 mt-4 text-sm text-muted-foreground\">\n                          <span>Less Used</span>\n                          <div className=\"flex gap-1\">\n                            <div className=\"w-8 h-4 rounded\" style={{ backgroundColor: 'rgba(0, 255, 255, 0.1)' }} />\n                            <div className=\"w-8 h-4 rounded\" style={{ backgroundColor: 'rgba(0, 255, 255, 0.25)' }} />\n                            <div className=\"w-8 h-4 rounded\" style={{ backgroundColor: 'rgba(0, 255, 255, 0.5)' }} />\n                          </div>\n                          <span>Most Used</span>\n                        </div>\n                      </div>\n                    </div>\n                  ) : (\n                    <p className=\"text-center py-12 text-muted-foreground\">No keyboard heatmap data available</p>\n                  )}\n                </CardContent>\n              </Card>\n\n              {/* WPM by Position & Slowest Words */}\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n                {keystrokeData.analytics.wpmByPosition && (\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        WPM Throughout Test\n                        <TooltipProvider>\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                            </TooltipTrigger>\n                            <TooltipContent side=\"right\" className=\"max-w-xs\">\n                              <p>Tracks your typing speed at different points in the test. A steady line shows consistent rhythm. Drops may indicate difficult words or fatigue.</p>\n                            </TooltipContent>\n                          </Tooltip>\n                        </TooltipProvider>\n                      </CardTitle>\n                      <CardDescription>Speed consistency over text position</CardDescription>\n                    </CardHeader>\n                    <CardContent>\n                      <ResponsiveContainer width=\"100%\" height={250}>\n                        <LineChart data={\n                          Array.isArray(keystrokeData.analytics.wpmByPosition)\n                            ? keystrokeData.analytics.wpmByPosition.map((item: {position: number; wpm: number} | number, idx: number) => ({\n                                position: `${typeof item === 'object' ? item.position : idx * 10}%`,\n                                wpm: typeof item === 'object' ? item.wpm : item,\n                                rawPosition: typeof item === 'object' ? item.position : idx * 10\n                              }))\n                            : []\n                        }>\n                          <CartesianGrid strokeDasharray=\"3 3\" opacity={0.1} />\n                          <XAxis dataKey=\"position\" stroke=\"#888\" />\n                          <YAxis stroke=\"#888\" />\n                          <ChartTooltip \n                            contentStyle={{ backgroundColor: \"#1e293b\", border: \"1px solid #334155\" }}\n                            content={({ active, payload }) => {\n                              if (!active || !payload || !payload.length) return null;\n                              const data = payload[0]?.payload as { position: string; wpm: number; rawPosition: number };\n                              const avgWpm = keystrokeData.analytics.burstWpm || keystrokeData.analytics.adjustedWpm || 0;\n                              const isAboveAvg = avgWpm > 0 && data.wpm >= avgWpm;\n                              return (\n                                <div className=\"bg-slate-800 border border-slate-700 rounded-lg p-3 shadow-lg\">\n                                  <p className=\"text-sm font-bold text-white mb-1\">Position: {data.position}</p>\n                                  <p className={`text-sm ${isAboveAvg ? 'text-green-400' : 'text-cyan-400'}`}>\n                                    Speed: {data.wpm.toFixed(0)} WPM\n                                  </p>\n                                  {avgWpm > 0 && (\n                                    <p className=\"text-xs text-muted-foreground mt-1\">\n                                      {isAboveAvg ? 'âœ“ Above your average' : 'âš ï¸ Below your average'}\n                                    </p>\n                                  )}\n                                </div>\n                              );\n                            }}\n                          />\n                          <Line type=\"monotone\" dataKey=\"wpm\" stroke=\"#a855f7\" strokeWidth={2} dot={{ r: 3 }} />\n                        </LineChart>\n                      </ResponsiveContainer>\n                    </CardContent>\n                  </Card>\n                )}\n\n                {keystrokeData.analytics.slowestWords && Array.isArray(keystrokeData.analytics.slowestWords) && keystrokeData.analytics.slowestWords.length > 0 && (\n                  <Card>\n                    <CardHeader>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        Slowest Words\n                        <TooltipProvider>\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                            </TooltipTrigger>\n                            <TooltipContent side=\"right\" className=\"max-w-xs\">\n                              <p>Words that took the longest to type. These may contain difficult letter combinations or uncommon patterns. Practice these words to improve your speed.</p>\n                            </TooltipContent>\n                          </Tooltip>\n                        </TooltipProvider>\n                      </CardTitle>\n                      <CardDescription>Words that slow you down</CardDescription>\n                    </CardHeader>\n                    <CardContent>\n                      <ScrollArea className=\"h-[250px]\">\n                        <div className=\"space-y-2\">\n                          {keystrokeData.analytics.slowestWords.slice(0, 10).map((item: any, idx: number) => {\n                            const avgTime = item.avgTime || 0;\n                            const isSlow = avgTime > 500;\n                            const isVerySlow = avgTime > 800;\n                            return (\n                              <TooltipProvider key={idx}>\n                                <Tooltip>\n                                  <TooltipTrigger asChild>\n                                    <div\n                                      className={`flex items-center justify-between p-3 rounded-lg transition-colors cursor-help ${\n                                        isVerySlow ? 'bg-red-500/10 border border-red-500/20 hover:bg-red-500/20' :\n                                        isSlow ? 'bg-orange-500/10 border border-orange-500/20 hover:bg-orange-500/20' :\n                                        'bg-secondary/50 hover:bg-secondary/70'\n                                      }`}\n                                      data-testid={`slow-word-${idx}`}\n                                    >\n                                      <span className=\"font-mono font-medium\">{item.word}</span>\n                                      <Badge variant=\"outline\" className={isVerySlow ? 'bg-red-500/20' : isSlow ? 'bg-orange-500/20' : ''}>\n                                        {avgTime?.toFixed(0)} ms\n                                      </Badge>\n                                    </div>\n                                  </TooltipTrigger>\n                                  <TooltipContent side=\"left\">\n                                    <p>Time to type: {avgTime?.toFixed(0)}ms</p>\n                                    <p className={`text-xs mt-1 ${isVerySlow ? 'text-red-400' : isSlow ? 'text-orange-400' : 'text-muted-foreground'}`}>\n                                      {isVerySlow ? 'âš ï¸ Very slow - practice this word' : \n                                       isSlow ? 'âš ï¸ Slower than average' : \n                                       'Normal speed'}\n                                    </p>\n                                  </TooltipContent>\n                                </Tooltip>\n                              </TooltipProvider>\n                            );\n                          })}\n                        </div>\n                      </ScrollArea>\n                    </CardContent>\n                  </Card>\n                )}\n              </div>\n\n              {/* Digraph Analysis */}\n              {(keystrokeData.analytics.fastestDigraph || keystrokeData.analytics.slowestDigraph) && (\n                <Card>\n                  <CardHeader>\n                    <CardTitle>Digraph Analysis</CardTitle>\n                    <CardDescription>Fastest and slowest two-key combinations from your latest test</CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                      {keystrokeData.analytics.fastestDigraph && (\n                        <div>\n                          <h4 className=\"text-sm font-semibold mb-3 text-green-500\">Fastest Digraph</h4>\n                          <div className=\"flex items-center justify-between p-3 rounded bg-green-500/10 border border-green-500/20\">\n                            <span className=\"font-mono text-lg\">{keystrokeData.analytics.fastestDigraph}</span>\n                            <Badge variant=\"outline\" className=\"bg-green-500/20\">Your fastest combo</Badge>\n                          </div>\n                        </div>\n                      )}\n                      {keystrokeData.analytics.slowestDigraph && (\n                        <div>\n                          <h4 className=\"text-sm font-semibold mb-3 text-red-500\">Slowest Digraph</h4>\n                          <div className=\"flex items-center justify-between p-3 rounded bg-red-500/10 border border-red-500/20\">\n                            <span className=\"font-mono text-lg\">{keystrokeData.analytics.slowestDigraph}</span>\n                            <Badge variant=\"outline\" className=\"bg-red-500/20\">Needs practice</Badge>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              )}\n            </>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"mistakes\" className=\"space-y-4\">\n          {(!analytics.mistakesHeatmap || analytics.mistakesHeatmap.length === 0) && \n           (!analytics.commonMistakes || analytics.commonMistakes.length === 0) ? (\n            <Card>\n              <CardContent className=\"py-12\">\n                <EmptyDataState message=\"No mistake data available yet. Complete more typing tests with the advanced keystroke tracking enabled to see your error patterns and areas for improvement.\" />\n              </CardContent>\n            </Card>\n          ) : (\n            <>\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n                <Card>\n                  <CardHeader>\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <CardTitle className=\"flex items-center gap-2\">\n                          Mistake Heatmap\n                          <TooltipProvider>\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                              </TooltipTrigger>\n                              <TooltipContent side=\"right\" className=\"max-w-xs\">\n                                <p>Shows which keys you mistype most often. Higher bars indicate keys that need more practice. Error rate = (errors / total presses) Ã— 100%</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          </TooltipProvider>\n                        </CardTitle>\n                        <CardDescription>Keys with highest error rates</CardDescription>\n                      </div>\n                      {analytics.mistakesHeatmap.length > 0 && (\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {analytics.mistakesHeatmap.length} keys tracked\n                        </Badge>\n                      )}\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    {analytics.mistakesHeatmap.length === 0 ? (\n                      <div className=\"flex flex-col items-center justify-center h-[300px] text-center\">\n                        <Keyboard className=\"w-10 h-10 text-muted-foreground mb-3\" />\n                        <p className=\"text-sm text-muted-foreground\">No keystroke errors recorded yet.</p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">Complete typing tests to see your error patterns.</p>\n                      </div>\n                    ) : (\n                      <ResponsiveContainer width=\"100%\" height={300}>\n                        <BarChart data={analytics.mistakesHeatmap.slice(0, 10)}>\n                          <CartesianGrid strokeDasharray=\"3 3\" opacity={0.1} />\n                          <XAxis dataKey=\"key\" stroke=\"#888\" />\n                          <YAxis stroke=\"#888\" label={{ value: 'Error Rate (%)', angle: -90, position: 'insideLeft' }} />\n                          <ChartTooltip \n                            contentStyle={{ backgroundColor: \"#1e293b\", border: \"1px solid #334155\" }}\n                            content={({ active, payload, label }) => {\n                              if (!active || !payload || !payload.length) return null;\n                              const data = payload[0]?.payload as { key: string; errorRate: number; errorCount: number; totalCount: number };\n                              return (\n                                <div className=\"bg-slate-800 border border-slate-700 rounded-lg p-3 shadow-lg\">\n                                  <p className=\"text-sm font-bold text-white mb-1\">Key: \"{data?.key}\"</p>\n                                  <p className=\"text-sm text-red-400\">Error Rate: {data?.errorRate?.toFixed(1)}%</p>\n                                  <p className=\"text-xs text-muted-foreground mt-1\">\n                                    {data?.errorCount} errors out of {data?.totalCount} presses\n                                  </p>\n                                  <p className=\"text-xs text-cyan-400 mt-2\">\n                                    {data?.errorRate > 10 ? \"âš ï¸ High error rate - focus practice here\" : \n                                     data?.errorRate > 5 ? \"ðŸ“Š Moderate - room for improvement\" : \n                                     \"âœ“ Good accuracy on this key\"}\n                                  </p>\n                                </div>\n                              );\n                            }}\n                          />\n                          <Bar dataKey=\"errorRate\" fill=\"#ef4444\" />\n                        </BarChart>\n                      </ResponsiveContainer>\n                    )}\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader>\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <CardTitle className=\"flex items-center gap-2\">\n                          Common Typing Errors\n                          <TooltipProvider>\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                              </TooltipTrigger>\n                              <TooltipContent side=\"right\" className=\"max-w-xs\">\n                                <p>Shows which keys you frequently substitute for others. The red badge is what you should have typed, and the outlined badge is what you actually typed.</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          </TooltipProvider>\n                        </CardTitle>\n                        <CardDescription>Most frequent mistakes you make</CardDescription>\n                      </div>\n                      {analytics.commonMistakes.length > 0 && (\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {analytics.commonMistakes.reduce((sum, m) => sum + m.count, 0)} total errors\n                        </Badge>\n                      )}\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    {analytics.commonMistakes.length === 0 ? (\n                      <div className=\"flex flex-col items-center justify-center h-[300px] text-center\">\n                        <Target className=\"w-10 h-10 text-muted-foreground mb-3\" />\n                        <p className=\"text-sm text-muted-foreground\">No substitution errors recorded yet.</p>\n                        <p className=\"text-xs text-muted-foreground mt-1\">Great job! Or complete more tests to track patterns.</p>\n                      </div>\n                    ) : (\n                      <ScrollArea className=\"h-[300px]\">\n                        <div className=\"space-y-2\">\n                          {analytics.commonMistakes.slice(0, 15).map((mistake, idx) => (\n                            <TooltipProvider key={idx}>\n                              <Tooltip>\n                                <TooltipTrigger asChild>\n                                  <div\n                                    className=\"flex items-center justify-between p-3 rounded-lg bg-secondary/50 hover:bg-secondary/70 transition-colors cursor-help\"\n                                    data-testid={`mistake-${idx}`}\n                                  >\n                                    <div className=\"flex items-center gap-3\">\n                                      <Badge variant=\"destructive\" className=\"font-mono\">\n                                        {mistake.expectedKey}\n                                      </Badge>\n                                      <span className=\"text-muted-foreground\">â†’</span>\n                                      <Badge variant=\"outline\" className=\"font-mono\">\n                                        {mistake.typedKey}\n                                      </Badge>\n                                    </div>\n                                    <span className=\"text-sm text-muted-foreground\">{mistake.count}x</span>\n                                  </div>\n                                </TooltipTrigger>\n                                <TooltipContent side=\"left\" className=\"max-w-xs\">\n                                  <p className=\"text-sm\">\n                                    You typed \"{mistake.typedKey}\" instead of \"{mistake.expectedKey}\" {mistake.count} time{mistake.count > 1 ? 's' : ''}.\n                                  </p>\n                                  <p className=\"text-xs text-muted-foreground mt-1\">\n                                    {mistake.count >= 10 ? \"âš ï¸ Frequent mistake - practice this key pair\" :\n                                     mistake.count >= 5 ? \"ðŸ“Š Moderate occurrence\" :\n                                     \"âœ“ Minor issue\"}\n                                  </p>\n                                </TooltipContent>\n                              </Tooltip>\n                            </TooltipProvider>\n                          ))}\n                        </div>\n                      </ScrollArea>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n\n              <Card>\n                <CardHeader>\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <CardTitle className=\"flex items-center gap-2\">\n                        Detailed Error Analysis\n                        <TooltipProvider>\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <HelpCircle className=\"w-4 h-4 text-muted-foreground cursor-help\" />\n                            </TooltipTrigger>\n                            <TooltipContent side=\"right\" className=\"max-w-xs\">\n                              <p>Visual grid of all tracked keys. Keys with higher error rates are highlighted. Hover over each key for detailed statistics.</p>\n                            </TooltipContent>\n                          </Tooltip>\n                        </TooltipProvider>\n                      </CardTitle>\n                      <CardDescription>Keys sorted by total errors - hover for details</CardDescription>\n                    </div>\n                    <div className=\"flex items-center gap-2 text-xs text-muted-foreground\">\n                      <span className=\"flex items-center gap-1\"><span className=\"w-3 h-3 rounded bg-red-500/20 border border-red-500/50\"></span> High</span>\n                      <span className=\"flex items-center gap-1\"><span className=\"w-3 h-3 rounded bg-yellow-500/20 border border-yellow-500/50\"></span> Medium</span>\n                      <span className=\"flex items-center gap-1\"><span className=\"w-3 h-3 rounded bg-green-500/20 border border-green-500/50\"></span> Low</span>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  {analytics.mistakesHeatmap.length === 0 ? (\n                    <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n                      <Keyboard className=\"w-10 h-10 text-muted-foreground mb-3\" />\n                      <p className=\"text-sm text-muted-foreground\">No detailed error data available yet.</p>\n                    </div>\n                  ) : (\n                    <div className=\"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3\">\n                      {analytics.mistakesHeatmap.slice(0, 24).map((item, idx) => {\n                        const severity = item.errorRate > 10 ? 'high' : item.errorRate > 5 ? 'medium' : 'low';\n                        const severityStyles = {\n                          high: 'border-red-500/50 bg-red-500/10 hover:bg-red-500/20',\n                          medium: 'border-yellow-500/50 bg-yellow-500/10 hover:bg-yellow-500/20',\n                          low: 'border-green-500/50 bg-green-500/10 hover:bg-green-500/20',\n                        };\n                        return (\n                          <TooltipProvider key={idx}>\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <div\n                                  className={`flex flex-col items-center justify-center p-4 rounded-lg border transition-colors cursor-help ${severityStyles[severity]}`}\n                                  data-testid={`heatmap-key-${item.key}`}\n                                >\n                                  <div className=\"text-2xl font-mono font-bold mb-2\">{item.key}</div>\n                                  <div className={`text-xs font-semibold ${severity === 'high' ? 'text-red-400' : severity === 'medium' ? 'text-yellow-400' : 'text-green-400'}`}>\n                                    {item.errorRate.toFixed(1)}%\n                                  </div>\n                                  <div className=\"text-xs text-muted-foreground\">{item.errorCount} errors</div>\n                                </div>\n                              </TooltipTrigger>\n                              <TooltipContent side=\"top\" className=\"max-w-xs\">\n                                <div className=\"space-y-1\">\n                                  <p className=\"font-semibold\">Key: \"{item.key}\"</p>\n                                  <p className=\"text-sm\">Error Rate: {item.errorRate.toFixed(2)}%</p>\n                                  <p className=\"text-sm\">{item.errorCount} errors / {item.totalCount} presses</p>\n                                  <p className={`text-xs mt-1 ${severity === 'high' ? 'text-red-400' : severity === 'medium' ? 'text-yellow-400' : 'text-green-400'}`}>\n                                    {severity === 'high' ? 'âš ï¸ Priority practice recommended' :\n                                     severity === 'medium' ? 'ðŸ“Š Some room for improvement' :\n                                     'âœ“ Good accuracy'}\n                                  </p>\n                                </div>\n                              </TooltipContent>\n                            </Tooltip>\n                          </TooltipProvider>\n                        );\n                      })}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </>\n          )}\n        </TabsContent>\n\n        <TabsContent value=\"insights\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    <Brain className=\"w-5 h-5\" />\n                    AI-Powered Insights\n                  </CardTitle>\n                  <CardDescription>Personalized recommendations based on your performance</CardDescription>\n                </div>\n                <Button\n                  onClick={generateAIInsights}\n                  disabled={loadingInsights}\n                  data-testid=\"button-generate-insights\"\n                >\n                  {loadingInsights ? (\n                    <>\n                      <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                      Analyzing...\n                    </>\n                  ) : (\n                    <>\n                      <Sparkles className=\"w-4 h-4 mr-2\" />\n                      Generate Insights\n                    </>\n                  )}\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {aiInsights.length > 0 ? (\n                <div className=\"space-y-3\">\n                  {aiInsights.map((insight, idx) => {\n                    const typeStyles = {\n                      improvement: \"border-orange-500/50 bg-orange-500/10\",\n                      strength: \"border-green-500/50 bg-green-500/10\",\n                      practice: \"border-blue-500/50 bg-blue-500/10\",\n                      warning: \"border-red-500/50 bg-red-500/10\",\n                      milestone: \"border-purple-500/50 bg-purple-500/10\",\n                    };\n                    const typeLabels = {\n                      improvement: \"Improve\",\n                      strength: \"Strength\",\n                      practice: \"Practice\",\n                      warning: \"Warning\",\n                      milestone: \"Milestone\",\n                    };\n                    const typeIcons = {\n                      improvement: \"ðŸŽ¯\",\n                      strength: \"âœ¨\",\n                      practice: \"ðŸ“š\",\n                      warning: \"âš ï¸\",\n                      milestone: \"ðŸ†\",\n                    };\n                    const priorityColors = {\n                      critical: \"bg-red-500 text-white\",\n                      high: \"bg-orange-500 text-white\",\n                      medium: \"bg-yellow-500 text-black\",\n                      low: \"bg-green-500 text-white\",\n                    };\n                    const categoryIcons: Record<string, string> = {\n                      speed: \"âš¡\",\n                      accuracy: \"ðŸŽ¯\",\n                      rhythm: \"ðŸŽµ\",\n                      ergonomics: \"ðŸ–ï¸\",\n                      technique: \"ðŸ”§\",\n                      endurance: \"ðŸ’ª\",\n                      general: \"ðŸ“Š\",\n                    };\n                    \n                    return (\n                      <div\n                        key={idx}\n                        className={`p-4 rounded-lg border ${typeStyles[insight.type]}`}\n                        data-testid={`insight-${idx}`}\n                      >\n                        <div className=\"flex items-start gap-3\">\n                          <div className=\"flex flex-col gap-1\">\n                            <Badge\n                              variant={insight.type === \"improvement\" || insight.type === \"warning\" ? \"destructive\" : insight.type === \"strength\" || insight.type === \"milestone\" ? \"default\" : \"secondary\"}\n                              className=\"whitespace-nowrap\"\n                            >\n                              {typeIcons[insight.type]} {typeLabels[insight.type]}\n                            </Badge>\n                            <Badge \n                              variant=\"outline\" \n                              className={`text-[10px] px-1.5 py-0 ${priorityColors[insight.priority]}`}\n                            >\n                              {insight.priority.toUpperCase()}\n                            </Badge>\n                          </div>\n                          <div className=\"flex-1 space-y-2\">\n                            <div className=\"flex items-center gap-2\">\n                              <span className=\"text-sm opacity-70\">{categoryIcons[insight.category]}</span>\n                              <p className=\"text-sm font-medium\">{insight.message}</p>\n                            </div>\n                            {(insight.dataPoint || insight.benchmark) && (\n                              <div className=\"flex flex-wrap gap-2 text-xs\">\n                                {insight.dataPoint && (\n                                  <span className=\"px-2 py-0.5 rounded bg-slate-700/50 text-cyan-300\">\n                                    ðŸ“ˆ {insight.dataPoint}\n                                  </span>\n                                )}\n                                {insight.benchmark && (\n                                  <span className=\"px-2 py-0.5 rounded bg-slate-700/50 text-purple-300\">\n                                    ðŸ“Š vs {insight.benchmark}\n                                  </span>\n                                )}\n                              </div>\n                            )}\n                            {insight.actionItem && (\n                              <div className=\"mt-2 p-2 rounded bg-slate-800/50 border border-slate-700/50\">\n                                <p className=\"text-xs text-muted-foreground mb-1\">Action:</p>\n                                <p className=\"text-sm text-cyan-400\">{insight.actionItem}</p>\n                              </div>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <Brain className=\"w-12 h-12 mx-auto mb-3 opacity-50\" />\n                  <p>Click \"Generate Insights\" to get AI-powered recommendations</p>\n                  <p className=\"text-xs mt-2 text-muted-foreground/70\">\n                    Analyzes your speed, accuracy, rhythm, and technique with industry benchmarks\n                  </p>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"practice\" className=\"space-y-4\">\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4\">\n            <Card>\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Calendar className=\"w-5 h-5\" />\n                      Daily Practice Plan\n                    </CardTitle>\n                    <CardDescription>AI-powered personalized exercises</CardDescription>\n                  </div>\n                  <Button\n                    onClick={generateDailyPlan}\n                    disabled={loadingDailyPlan}\n                    size=\"sm\"\n                    variant=\"outline\"\n                    data-testid=\"button-generate-daily\"\n                  >\n                    {loadingDailyPlan ? (\n                      <>\n                        <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                        Generating...\n                      </>\n                    ) : (\n                      <>\n                        <Sparkles className=\"w-4 h-4 mr-2\" />\n                        Generate Plan\n                      </>\n                    )}\n                  </Button>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {dailyPlan.length > 0 ? (\n                  <div className=\"space-y-3\">\n                    {dailyPlan.map((exercise, idx) => (\n                      <div key={idx} className=\"flex items-start gap-3 p-3 rounded-lg bg-secondary/50\" data-testid={`exercise-${idx}`}>\n                        <div className=\"flex-shrink-0 w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold\">\n                          {idx + 1}\n                        </div>\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center justify-between mb-1\">\n                            <h4 className=\"font-semibold\">{exercise.title}</h4>\n                            <Badge variant=\"outline\" className=\"text-xs\">{exercise.duration}</Badge>\n                          </div>\n                          <p className=\"text-sm text-muted-foreground\">\n                            {exercise.description}\n                          </p>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <Calendar className=\"w-12 h-12 mx-auto mb-3 opacity-50\" />\n                    <p>Click \"Generate Plan\" to get your personalized daily practice routine</p>\n                  </div>\n                )}\n\n                {dailyPlan.length > 0 && (\n                  <Button className=\"w-full\" onClick={() => (window.location.href = \"/\")} data-testid=\"button-start-practice\">\n                    <Target className=\"w-4 h-4 mr-2\" />\n                    Start Practice Session\n                  </Button>\n                )}\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <TrendingUp className=\"w-5 h-5\" />\n                      Weekly Improvement Plan\n                    </CardTitle>\n                    <CardDescription>AI-generated progressive roadmap</CardDescription>\n                  </div>\n                  <Button\n                    onClick={generateWeeklyPlan}\n                    disabled={loadingWeeklyPlan}\n                    size=\"sm\"\n                    variant=\"outline\"\n                    data-testid=\"button-generate-weekly\"\n                  >\n                    {loadingWeeklyPlan ? (\n                      <>\n                        <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                        Generating...\n                      </>\n                    ) : (\n                      <>\n                        <Sparkles className=\"w-4 h-4 mr-2\" />\n                        Generate Plan\n                      </>\n                    )}\n                  </Button>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {weeklyPlan.length > 0 ? (\n                  <div className=\"space-y-3\">\n                    {weeklyPlan.map((goal, idx) => (\n                      <div\n                        key={idx}\n                        className={`p-3 rounded-lg border border-border ${goal.status !== \"current\" ? \"opacity-60\" : \"\"}`}\n                        data-testid={`weekly-goal-${idx}`}\n                      >\n                        <div className=\"flex items-center justify-between mb-2\">\n                          <h4 className=\"font-semibold\">{goal.week}: {goal.title}</h4>\n                          <Badge variant={goal.status === \"current\" ? \"outline\" : \"secondary\"}>\n                            {goal.status === \"current\" ? \"Current\" : goal.status === \"next\" ? \"Next\" : \"Later\"}\n                          </Badge>\n                        </div>\n                        <ul className=\"text-sm text-muted-foreground space-y-1 list-disc list-inside\">\n                          {goal.tasks.map((task, taskIdx) => (\n                            <li key={taskIdx}>{task}</li>\n                          ))}\n                          <li className=\"font-semibold text-primary\">Target: {goal.target}</li>\n                        </ul>\n                      </div>\n                    ))}\n                  </div>\n                ) : (\n                  <div className=\"text-center py-8 text-muted-foreground\">\n                    <TrendingUp className=\"w-12 h-12 mx-auto mb-3 opacity-50\" />\n                    <p>Click \"Generate Plan\" to get your 4-week improvement roadmap</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n\nexport default function Analytics() {\n  return (\n    <AnalyticsErrorBoundary>\n      <AnalyticsContent />\n    </AnalyticsErrorBoundary>\n  );\n}\n","path":null,"size_bytes":171793,"size_tokens":null},"client/src/lib/keyboard-sounds.ts":{"content":"// Keyboard sound system using Web Audio API\nexport type SoundType = 'mechanical' | 'linear' | 'typewriter' | 'cherry';\n\nclass KeyboardSoundSystem {\n  private audioContext: AudioContext | null = null;\n  private enabled: boolean = false; // Disabled by default\n  private soundType: SoundType = 'mechanical';\n\n  constructor() {\n    if (typeof window !== 'undefined') {\n      this.loadSettings();\n    }\n  }\n\n  private initAudioContext() {\n    if (!this.audioContext) {\n      this.audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n    }\n  }\n\n  private loadSettings() {\n    const enabled = localStorage.getItem('keyboardSoundsEnabled');\n    const soundType = localStorage.getItem('keyboardSoundType');\n    \n    this.enabled = enabled !== null ? enabled === 'true' : false; // Disabled by default\n    this.soundType = (soundType as SoundType) || 'mechanical';\n  }\n\n  setEnabled(enabled: boolean) {\n    this.enabled = enabled;\n    localStorage.setItem('keyboardSoundsEnabled', enabled.toString());\n  }\n\n  setSoundType(type: SoundType) {\n    this.soundType = type;\n    localStorage.setItem('keyboardSoundType', type);\n  }\n\n  getSettings() {\n    return {\n      enabled: this.enabled,\n      soundType: this.soundType\n    };\n  }\n\n  play() {\n    if (!this.enabled) return;\n    \n    this.initAudioContext();\n    if (!this.audioContext) return;\n\n    const currentTime = this.audioContext.currentTime;\n\n    switch (this.soundType) {\n      case 'mechanical':\n        this.playMechanicalClick(currentTime);\n        break;\n      case 'linear':\n        this.playLinearThock(currentTime);\n        break;\n      case 'typewriter':\n        this.playTypewriter(currentTime);\n        break;\n      case 'cherry':\n        this.playCherryMX(currentTime);\n        break;\n    }\n  }\n\n  private playMechanicalClick(startTime: number) {\n    if (!this.audioContext) return;\n\n    // Create oscillator for click sound\n    const osc = this.audioContext.createOscillator();\n    const gainNode = this.audioContext.createGain();\n\n    osc.connect(gainNode);\n    gainNode.connect(this.audioContext.destination);\n\n    // Sharp, high-pitched click\n    osc.type = 'square';\n    osc.frequency.setValueAtTime(1200, startTime);\n    osc.frequency.exponentialRampToValueAtTime(800, startTime + 0.01);\n\n    // Quick attack and decay\n    gainNode.gain.setValueAtTime(0.15, startTime);\n    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.02);\n\n    osc.start(startTime);\n    osc.stop(startTime + 0.02);\n  }\n\n  private playLinearThock(startTime: number) {\n    if (!this.audioContext) return;\n\n    const osc = this.audioContext.createOscillator();\n    const gainNode = this.audioContext.createGain();\n\n    osc.connect(gainNode);\n    gainNode.connect(this.audioContext.destination);\n\n    // Deep thock sound\n    osc.type = 'sine';\n    osc.frequency.setValueAtTime(200, startTime);\n    osc.frequency.exponentialRampToValueAtTime(80, startTime + 0.05);\n\n    // Smooth attack and decay\n    gainNode.gain.setValueAtTime(0.2, startTime);\n    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.08);\n\n    osc.start(startTime);\n    osc.stop(startTime + 0.08);\n  }\n\n  private playTypewriter(startTime: number) {\n    if (!this.audioContext) return;\n\n    const osc = this.audioContext.createOscillator();\n    const gainNode = this.audioContext.createGain();\n    const filter = this.audioContext.createBiquadFilter();\n\n    osc.connect(filter);\n    filter.connect(gainNode);\n    gainNode.connect(this.audioContext.destination);\n\n    // Metallic clack\n    osc.type = 'square';\n    osc.frequency.setValueAtTime(1500, startTime);\n    osc.frequency.exponentialRampToValueAtTime(600, startTime + 0.015);\n\n    filter.type = 'bandpass';\n    filter.frequency.setValueAtTime(1200, startTime);\n    filter.Q.setValueAtTime(2, startTime);\n\n    gainNode.gain.setValueAtTime(0.18, startTime);\n    gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + 0.03);\n\n    osc.start(startTime);\n    osc.stop(startTime + 0.03);\n  }\n\n  private playCherryMX(startTime: number) {\n    if (!this.audioContext) return;\n\n    // Cherry MX Blue has a distinctive two-stage sound\n    const osc1 = this.audioContext.createOscillator();\n    const osc2 = this.audioContext.createOscillator();\n    const gainNode1 = this.audioContext.createGain();\n    const gainNode2 = this.audioContext.createGain();\n\n    osc1.connect(gainNode1);\n    osc2.connect(gainNode2);\n    gainNode1.connect(this.audioContext.destination);\n    gainNode2.connect(this.audioContext.destination);\n\n    // First stage: tactile click\n    osc1.type = 'square';\n    osc1.frequency.setValueAtTime(1400, startTime);\n    osc1.frequency.exponentialRampToValueAtTime(900, startTime + 0.01);\n\n    gainNode1.gain.setValueAtTime(0.12, startTime);\n    gainNode1.gain.exponentialRampToValueAtTime(0.01, startTime + 0.015);\n\n    // Second stage: bottom-out sound\n    osc2.type = 'sine';\n    osc2.frequency.setValueAtTime(150, startTime + 0.015);\n    osc2.frequency.exponentialRampToValueAtTime(60, startTime + 0.04);\n\n    gainNode2.gain.setValueAtTime(0, startTime);\n    gainNode2.gain.setValueAtTime(0.15, startTime + 0.015);\n    gainNode2.gain.exponentialRampToValueAtTime(0.01, startTime + 0.05);\n\n    osc1.start(startTime);\n    osc1.stop(startTime + 0.015);\n    osc2.start(startTime + 0.015);\n    osc2.stop(startTime + 0.05);\n  }\n}\n\n// Singleton instance\nexport const keyboardSound = new KeyboardSoundSystem();\n","path":null,"size_bytes":5429,"size_tokens":null},"server/websocket.ts":{"content":"import { WebSocketServer, WebSocket } from \"ws\";\nimport DOMPurify from \"isomorphic-dompurify\";\nimport OpenAI from \"openai\";\nimport { storage } from \"./storage\";\nimport { botService } from \"./bot-service\";\nimport { raceCache } from \"./race-cache\";\nimport { wsRateLimiter } from \"./ws-rate-limiter\";\nimport { raceCleanupScheduler } from \"./race-cleanup\";\nimport { metricsCollector } from \"./metrics\";\nimport { eloRatingService } from \"./elo-rating-service\";\nimport { antiCheatService } from \"./anticheat-service\";\nimport type { Server } from \"http\";\n\nconst openai = new OpenAI({\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY,\n});\n\ninterface RaceClient {\n  ws: WebSocket;\n  raceId: number;\n  participantId: number;\n  username: string;\n  lastActivity: number;\n  isReady: boolean;\n  isBot?: boolean;\n}\n\ninterface DisconnectedPlayer {\n  username: string;\n  isReady: boolean;\n  disconnectedAt: number;\n}\n\ninterface RaceRoom {\n  raceId: number;\n  clients: Map<number, RaceClient>;\n  countdownTimer?: NodeJS.Timeout;\n  timedRaceTimer?: NodeJS.Timeout;\n  raceStartTime?: number;\n  shardId: number;\n  isFinishing?: boolean; // Prevents cleanup during race completion\n  isStarting?: boolean; // Prevents double-start race condition\n  hostParticipantId?: number; // The first player to join controls the race\n  isLocked?: boolean; // Prevents new players from joining\n  kickedPlayers: Set<number>; // List of kicked participant IDs\n}\n\ninterface ServerStats {\n  totalConnections: number;\n  activeRooms: number;\n  totalParticipants: number;\n  messagesProcessed: number;\n  messagesDropped: number;\n}\n\nconst NUM_SHARDS = 16;\nconst HEARTBEAT_INTERVAL_MS = 30 * 1000;\nconst CONNECTION_TIMEOUT_MS = 180 * 1000; // 3 minutes - longer than max race duration (2 min)\n\nconst MAX_CONNECTIONS = 50000;\nconst LOAD_SHEDDING_THRESHOLD = 0.8;\nconst DB_FAILURE_THRESHOLD = 5;\nconst DB_RECOVERY_INTERVAL_MS = 30 * 1000;\n\ninterface LoadState {\n  isUnderPressure: boolean;\n  dbFailures: number;\n  lastDbFailure: number;\n  lastRecoveryCheck: number;\n  connectionRejections: number;\n}\n\ninterface ExtensionState {\n  lastExtendedAt: number;\n  extensionCount: number;\n  pendingExtension: boolean;\n}\n\nconst EXTENSION_COOLDOWN_MS = 5000;\nconst MAX_EXTENSIONS_PER_RACE = 5;\n\nclass RaceWebSocketServer {\n  private wss: WebSocketServer | null = null;\n  private races: Map<number, RaceRoom> = new Map();\n  private heartbeatTimer: NodeJS.Timeout | null = null;\n  private extensionStates: Map<number, ExtensionState> = new Map();\n  private disconnectedPlayers: Map<number, Map<number, DisconnectedPlayer>> = new Map(); // raceId -> participantId -> info\n  private stats: ServerStats = {\n    totalConnections: 0,\n    activeRooms: 0,\n    totalParticipants: 0,\n    messagesProcessed: 0,\n    messagesDropped: 0,\n  };\n  private loadState: LoadState = {\n    isUnderPressure: false,\n    dbFailures: 0,\n    lastDbFailure: 0,\n    lastRecoveryCheck: 0,\n    connectionRejections: 0,\n  };\n\n  private async enrichResultsWithRatings(participants: any[]): Promise<any[]> {\n    const enrichedResults = await Promise.all(\n      participants.map(async (p) => {\n        if (p.isBot === 1) {\n          return { ...p, isBot: true, rating: null, tier: null, ratingChange: null };\n        }\n        \n        if (!p.userId) {\n          return { ...p, isBot: false, rating: null, tier: null, ratingChange: null };\n        }\n        \n        try {\n          const userRating = await storage.getOrCreateUserRating(p.userId);\n          const tierInfo = eloRatingService.getTierInfo(userRating.tier);\n          return {\n            ...p,\n            isBot: false,\n            rating: userRating.rating,\n            tier: userRating.tier,\n            tierInfo,\n            ratingChange: null,\n          };\n        } catch (error) {\n          console.error(`[Rating] Failed to fetch rating for user ${p.userId}:`, error);\n          return { ...p, isBot: false, rating: null, tier: null, ratingChange: null };\n        }\n      })\n    );\n    return enrichedResults;\n  }\n\n  initialize(server: Server) {\n    this.wss = new WebSocketServer({ server, path: \"/ws/race\" });\n\n    raceCache.initialize(async (updates) => {\n      await this.flushProgressToDatabase(updates);\n    });\n\n    wsRateLimiter.initialize();\n    raceCleanupScheduler.initialize();\n\n    this.wss.on(\"connection\", (ws: WebSocket) => {\n      if (!this.acceptConnection(ws)) {\n        return;\n      }\n      \n      this.stats.totalConnections++;\n      console.log(`[WS] New connection (total: ${this.stats.totalConnections})`);\n\n      ws.on(\"message\", async (data: Buffer | string) => {\n        const dataStr = data.toString();\n        \n        const validation = wsRateLimiter.validatePayload(dataStr);\n        if (!validation.valid) {\n          ws.send(JSON.stringify({ \n            type: \"error\", \n            message: validation.error,\n            code: \"INVALID_PAYLOAD\"\n          }));\n          return;\n        }\n\n        try {\n          const message = JSON.parse(dataStr);\n          \n          const rateLimit = wsRateLimiter.checkLimit(ws, message.type);\n          if (!rateLimit.allowed) {\n            this.stats.messagesDropped++;\n            if (rateLimit.violation) {\n              ws.send(JSON.stringify({ \n                type: \"error\", \n                message: \"Rate limit exceeded. Please slow down.\",\n                code: \"RATE_LIMITED\",\n                retryAfter: rateLimit.retryAfter\n              }));\n            }\n            return;\n          }\n\n          this.stats.messagesProcessed++;\n          metricsCollector.recordWsMessage();\n          await this.handleMessage(ws, message);\n        } catch (error) {\n          console.error(\"WebSocket message error:\", error);\n          ws.send(JSON.stringify({ type: \"error\", message: \"Invalid message format\" }));\n        }\n      });\n\n      ws.on(\"close\", () => {\n        this.stats.totalConnections--;\n        wsRateLimiter.removeClient(ws);\n        this.handleDisconnect(ws);\n      });\n\n      ws.on(\"error\", (error) => {\n        console.error(\"WebSocket error:\", error);\n      });\n    });\n\n    this.heartbeatTimer = setInterval(() => {\n      this.performHeartbeat();\n    }, HEARTBEAT_INTERVAL_MS);\n\n    console.log(\"[WS] WebSocket server initialized with scalability features\");\n    console.log(`[WS] Shards: ${NUM_SHARDS}, Heartbeat: ${HEARTBEAT_INTERVAL_MS}ms`);\n  }\n\n  shutdown() {\n    if (this.heartbeatTimer) {\n      clearInterval(this.heartbeatTimer);\n      this.heartbeatTimer = null;\n    }\n    \n    raceCache.shutdown();\n    wsRateLimiter.shutdown();\n    raceCleanupScheduler.shutdown();\n    \n    const raceRooms = Array.from(this.races.values());\n    for (const raceRoom of raceRooms) {\n      if (raceRoom.countdownTimer) {\n        clearInterval(raceRoom.countdownTimer);\n      }\n      if (raceRoom.timedRaceTimer) {\n        clearTimeout(raceRoom.timedRaceTimer);\n      }\n    }\n    \n    this.races.clear();\n  }\n\n  private async flushProgressToDatabase(updates: Map<number, { progress: number; wpm: number; accuracy: number; errors: number; lastUpdate: number; dirty: boolean }>): Promise<void> {\n    if (this.loadState.dbFailures >= DB_FAILURE_THRESHOLD) {\n      console.warn(\"[WS] DB circuit breaker open, skipping progress flush\");\n      return;\n    }\n\n    const dbUpdates = new Map<number, { progress: number; wpm: number; accuracy: number; errors: number }>();\n    \n    const updateEntries = Array.from(updates.entries());\n    for (const [id, update] of updateEntries) {\n      dbUpdates.set(id, {\n        progress: update.progress,\n        wpm: update.wpm,\n        accuracy: update.accuracy,\n        errors: update.errors,\n      });\n    }\n\n    if (dbUpdates.size > 0) {\n      try {\n        await storage.bulkUpdateParticipantProgress(dbUpdates);\n        this.recordDbSuccess();\n      } catch (error) {\n        console.error(\"[WS] Failed to flush progress to database:\", error);\n        this.recordDbFailure();\n      }\n    }\n  }\n\n  private getShardId(raceId: number): number {\n    return raceId % NUM_SHARDS;\n  }\n\n  private performHeartbeat(): void {\n    const now = Date.now();\n    let staleConnections = 0;\n\n    const raceEntries = Array.from(this.races.entries());\n    for (const [raceId, raceRoom] of raceEntries) {\n      const staleClients: number[] = [];\n      \n      const clientEntries = Array.from(raceRoom.clients.entries());\n      for (const [participantId, client] of clientEntries) {\n        if (now - client.lastActivity > CONNECTION_TIMEOUT_MS) {\n          staleClients.push(participantId);\n          staleConnections++;\n        }\n      }\n\n      for (const participantId of staleClients) {\n        const client = raceRoom.clients.get(participantId);\n        \n        // Store disconnected player info for potential reconnection (5-minute window)\n        if (client) {\n          if (!this.disconnectedPlayers.has(raceId)) {\n            this.disconnectedPlayers.set(raceId, new Map());\n          }\n          this.disconnectedPlayers.get(raceId)!.set(participantId, {\n            username: client.username,\n            isReady: client.isReady,\n            disconnectedAt: Date.now(),\n          });\n          \n          // Clean up after 5 minutes\n          setTimeout(() => {\n            const disconnectedMap = this.disconnectedPlayers.get(raceId);\n            if (disconnectedMap) {\n              disconnectedMap.delete(participantId);\n              if (disconnectedMap.size === 0) {\n                this.disconnectedPlayers.delete(raceId);\n              }\n            }\n          }, 5 * 60 * 1000);\n        }\n        \n        raceRoom.clients.delete(participantId);\n        this.broadcastToRace(raceId, {\n          type: \"participant_disconnected\",\n          participantId,\n          username: client?.username,\n          reason: \"timeout\",\n        });\n        \n        // Host failover: If disconnected player was host, transfer to next available HUMAN player\n        if (raceRoom.hostParticipantId === participantId && raceRoom.clients.size > 0) {\n          const humanClients = Array.from(raceRoom.clients.entries())\n            .filter(([_, c]) => !c.isBot)\n            .sort((a, b) => a[0] - b[0]); // Sort by participantId (join order)\n          \n          if (humanClients.length > 0) {\n            const [nextHostId, newHostClient] = humanClients[0];\n            raceRoom.hostParticipantId = nextHostId;\n            console.log(`[WS Heartbeat] Host transferred to ${newHostClient.username} (${nextHostId}) after timeout`);\n            \n            this.broadcastToRace(raceId, {\n              type: \"host_changed\",\n              newHostParticipantId: nextHostId,\n              newHostUsername: newHostClient.username,\n              message: `${newHostClient.username} is now the host`,\n            });\n          } else {\n            raceRoom.hostParticipantId = undefined;\n            console.log(`[WS Heartbeat] No human players left in race ${raceId}, host cleared`);\n          }\n        }\n        \n        // Cancel countdown if not enough players remain\n        const connectedHumans = Array.from(raceRoom.clients.values()).filter(c => !c.isBot);\n        const cachedRace = raceCache.getRace(raceId);\n        const currentStatus = cachedRace?.race?.status;\n        \n        if (currentStatus === \"countdown\" && connectedHumans.length < 2) {\n          if (raceRoom.countdownTimer) {\n            clearInterval(raceRoom.countdownTimer);\n            raceRoom.countdownTimer = undefined;\n          }\n          \n          // Reset the isStarting flag\n          raceRoom.isStarting = false;\n          \n          raceCache.updateRaceStatus(raceId, \"waiting\");\n          storage.updateRaceStatus(raceId, \"waiting\").catch(err => \n            console.error(`[WS Heartbeat] Failed to revert race status:`, err)\n          );\n          \n          this.broadcastToRace(raceId, {\n            type: \"countdown_cancelled\",\n            reason: \"Not enough players - need at least 2 to start\",\n            code: \"INSUFFICIENT_PLAYERS\"\n          });\n          \n          console.log(`[WS Heartbeat] Countdown cancelled for race ${raceId} - timeout caused insufficient players`);\n        }\n      }\n\n      if (raceRoom.clients.size === 0) {\n        // NEVER clean up a race that is currently finishing - prevents race condition\n        if (raceRoom.isFinishing) {\n          console.log(`[WS Heartbeat] Keeping race room ${raceId} alive - race is finishing`);\n          continue;\n        }\n        \n        // For timed races that are still racing, DON'T delete the room - let the timer complete\n        // This ensures results are broadcast even if all clients disconnect\n        if (raceRoom.timedRaceTimer) {\n          console.log(`[WS Heartbeat] Keeping race room ${raceId} alive - timed race timer active`);\n          // Keep the race room and timer alive - it will clean up after broadcasting results\n          continue;\n        }\n        \n        if (raceRoom.countdownTimer) {\n          clearInterval(raceRoom.countdownTimer);\n        }\n        this.races.delete(raceId);\n        this.cleanupExtensionState(raceId);\n      }\n    }\n\n    this.updateStats();\n\n    if (staleConnections > 0) {\n      console.log(`[WS] Heartbeat: cleaned ${staleConnections} stale connections`);\n    }\n  }\n\n  private updateStats(): void {\n    this.stats.activeRooms = this.races.size;\n    let totalParticipants = 0;\n    const rooms = Array.from(this.races.values());\n    for (const room of rooms) {\n      totalParticipants += room.clients.size;\n    }\n    this.stats.totalParticipants = totalParticipants;\n  }\n\n  // SECURITY: Validate that the message comes from an authenticated participant\n  private validateAuthenticatedMessage(ws: WebSocket, message: any): boolean {\n    const authParticipantId = (ws as any).authenticatedParticipantId;\n    const authRaceId = (ws as any).authenticatedRaceId;\n    \n    // Skip validation for join messages (authentication happens there)\n    if (message.type === \"join\") {\n      return true;\n    }\n    \n    // Spectate and get_replay don't require prior authentication\n    if (message.type === \"spectate\" || message.type === \"get_replay\" || message.type === \"stop_spectate\" || message.type === \"get_rating\") {\n      return true;\n    }\n    \n    // Must be authenticated for all other messages\n    if (!authParticipantId) {\n      console.warn(`[WS Security] Unauthenticated message rejected: ${message.type}`);\n      ws.send(JSON.stringify({ type: \"error\", message: \"Not authenticated. Please join a race first.\" }));\n      return false;\n    }\n    \n    // Validate participantId in message matches authenticated ID\n    if (message.participantId && message.participantId !== authParticipantId) {\n      console.warn(`[WS Security] Participant ID mismatch: auth=${authParticipantId}, message=${message.participantId}`);\n      ws.send(JSON.stringify({ type: \"error\", message: \"Invalid participant ID\" }));\n      return false;\n    }\n    \n    // Validate raceId in message matches authenticated race\n    if (message.raceId && message.raceId !== authRaceId) {\n      console.warn(`[WS Security] Race ID mismatch: auth=${authRaceId}, message=${message.raceId}`);\n      ws.send(JSON.stringify({ type: \"error\", message: \"Invalid race ID\" }));\n      return false;\n    }\n    \n    return true;\n  }\n\n  private async handleMessage(ws: WebSocket, message: any) {\n    // SECURITY: Validate authentication before processing\n    if (!this.validateAuthenticatedMessage(ws, message)) {\n      return;\n    }\n    \n    // Update lastActivity on ANY message to keep connection alive\n    const authRaceId = (ws as any).authenticatedRaceId;\n    const authParticipantId = (ws as any).authenticatedParticipantId;\n    if (authRaceId && authParticipantId) {\n      const raceRoom = this.races.get(authRaceId);\n      if (raceRoom) {\n        const client = raceRoom.clients.get(authParticipantId);\n        if (client) {\n          client.lastActivity = Date.now();\n        }\n      }\n    }\n    \n    switch (message.type) {\n      case \"join\":\n        await this.handleJoin(ws, message);\n        break;\n      case \"ready\":\n        await this.handleReady(message);\n        break;\n      case \"progress\":\n        await this.handleProgress(message);\n        break;\n      case \"finish\":\n        await this.handleFinish(message);\n        break;\n      case \"timed_finish\":\n        await this.handleTimedFinish(message);\n        break;\n      case \"leave\":\n        await this.handleLeave(ws, message);\n        break;\n      case \"extend_paragraph\":\n        await this.handleExtendParagraph(ws, message);\n        break;\n      case \"submit_keystrokes\":\n        await this.handleSubmitKeystrokes(ws, message);\n        break;\n      case \"chat_message\":\n        await this.handleChatMessage(ws, message);\n        break;\n      case \"spectate\":\n        await this.handleSpectate(ws, message);\n        break;\n      case \"stop_spectate\":\n        await this.handleStopSpectate(ws, message);\n        break;\n      case \"get_replay\":\n        await this.handleGetReplay(ws, message);\n        break;\n      case \"get_rating\":\n        await this.handleGetRating(ws, message);\n        break;\n      case \"ready_toggle\":\n        await this.handleReadyToggle(ws, message);\n        break;\n      case \"kick_player\":\n        await this.handleKickPlayer(ws, message);\n        break;\n      case \"lock_room\":\n        await this.handleLockRoom(ws, message);\n        break;\n      case \"rematch\":\n        await this.handleRematch(ws, message);\n        break;\n      default:\n        console.warn(\"Unknown message type:\", message.type);\n    }\n  }\n\n  private async handleJoin(ws: WebSocket, message: any) {\n    const { raceId, participantId, username } = message;\n\n    if (!raceId || !participantId || !username) {\n      ws.send(JSON.stringify({ type: \"error\", message: \"Missing required fields\" }));\n      return;\n    }\n\n    let cachedRace = raceCache.getRace(raceId);\n    let race;\n    let participants;\n\n    if (cachedRace) {\n      race = cachedRace.race;\n      participants = cachedRace.participants;\n    } else {\n      race = await storage.getRace(raceId);\n      if (!race) {\n        ws.send(JSON.stringify({ type: \"error\", message: \"Race not found\" }));\n        return;\n      }\n      participants = await storage.getRaceParticipants(raceId);\n      raceCache.setRace(race, participants);\n    }\n\n    // SECURITY: Verify participant exists and belongs to this race\n    const participant = participants.find(p => p.id === participantId);\n    if (!participant) {\n      console.warn(`[WS Security] Join rejected: participant ${participantId} not found in race ${raceId}`);\n      ws.send(JSON.stringify({ type: \"error\", message: \"Invalid participant\" }));\n      return;\n    }\n\n    // SECURITY: Verify username matches (prevents impersonation)\n    if (participant.username !== username) {\n      console.warn(`[WS Security] Join rejected: username mismatch for participant ${participantId}. Expected: ${participant.username}, Got: ${username}`);\n      ws.send(JSON.stringify({ type: \"error\", message: \"Username mismatch\" }));\n      return;\n    }\n\n    // Store authenticated participant ID on the WebSocket for future validation\n    (ws as any).authenticatedParticipantId = participantId;\n    (ws as any).authenticatedRaceId = raceId;\n\n    let raceRoom = this.races.get(raceId);\n    if (!raceRoom) {\n      raceRoom = {\n        raceId,\n        clients: new Map(),\n        shardId: this.getShardId(raceId),\n        kickedPlayers: new Set(),\n      };\n      this.races.set(raceId, raceRoom);\n    }\n\n    // Check if player was kicked from this room\n    if (raceRoom.kickedPlayers.has(participantId)) {\n      ws.send(JSON.stringify({ type: \"error\", message: \"You have been kicked from this room\" }));\n      return;\n    }\n\n    // Check if room is locked\n    if (raceRoom.isLocked) {\n      const existingClient = raceRoom.clients.get(participantId);\n      if (!existingClient) {\n        ws.send(JSON.stringify({ type: \"error\", message: \"Room is locked - no new players allowed\" }));\n        return;\n      }\n    }\n\n    const existingClient = raceRoom.clients.get(participantId);\n    \n    // Check if this is a reconnection (player was previously connected but disconnected)\n    const disconnectedInfo = this.disconnectedPlayers.get(raceId)?.get(participantId);\n    const isReconnect = !!existingClient || !!disconnectedInfo;\n    \n    // Clean up disconnected player entry if reconnecting\n    if (disconnectedInfo) {\n      this.disconnectedPlayers.get(raceId)?.delete(participantId);\n      console.log(`[WS] Player ${username} (${participantId}) reconnected to race ${raceId} after ${Math.round((Date.now() - disconnectedInfo.disconnectedAt) / 1000)}s`);\n    }\n\n    // Set host to first human player to join (not a bot)\n    if (!raceRoom.hostParticipantId && participant.isBot !== 1) {\n      raceRoom.hostParticipantId = participantId;\n      console.log(`[WS] Host set: ${username} (${participantId}) for race ${raceId}`);\n    }\n\n    // Host is always ready by default, or restore previous ready state on reconnect\n    const isHost = raceRoom.hostParticipantId === participantId;\n    const restoredReadyState = disconnectedInfo?.isReady ?? isHost;\n    \n    const client: RaceClient = { \n      ws, \n      raceId, \n      participantId, \n      username,\n      lastActivity: Date.now(),\n      isReady: restoredReadyState,\n      isBot: participant.isBot === 1,\n    };\n    raceRoom.clients.set(participantId, client);\n\n    // Re-fetch participant from fresh list if needed\n    let currentParticipant = participant;\n    if (!currentParticipant) {\n      participants = await storage.getRaceParticipants(raceId);\n      currentParticipant = participants.find(p => p.id === participantId) || participant;\n      raceCache.updateParticipants(raceId, participants);\n    }\n    \n    if (!isReconnect) {\n      // Broadcast participant_joined to ALL clients so everyone sees the new player\n      this.broadcastToRace(raceId, {\n        type: \"participant_joined\",\n        participant: currentParticipant,\n        participants,\n        hostParticipantId: raceRoom.hostParticipantId,\n      });\n      \n      // Also send a full sync to make sure everyone has the latest list\n      this.broadcastToRace(raceId, {\n        type: \"participants_sync\",\n        participants,\n        hostParticipantId: raceRoom.hostParticipantId,\n      });\n      console.log(`[WS] New join: ${username} (${participantId}) in race ${raceId}`);\n    } else {\n      // Broadcast reconnection to all clients so they know player is back\n      this.broadcastToRace(raceId, {\n        type: \"participant_reconnected\",\n        participantId,\n        username,\n        isReady: restoredReadyState,\n      });\n      \n      // Send full state sync to reconnected player\n      ws.send(JSON.stringify({\n        type: \"participants_sync\",\n        participants,\n        hostParticipantId: raceRoom.hostParticipantId,\n      }));\n      \n      // Also send current ready states to reconnected player\n      const readyStates = Array.from(raceRoom.clients.entries()).map(([pId, c]) => ({\n        participantId: pId,\n        isReady: c.isReady,\n      }));\n      ws.send(JSON.stringify({\n        type: \"ready_state_update\",\n        participantId,\n        isReady: restoredReadyState,\n        readyStates,\n      }));\n      \n      console.log(`[WS] Reconnect: ${username} (${participantId}) in race ${raceId}`);\n    }\n\n    ws.send(JSON.stringify({\n      type: \"joined\",\n      race,\n      participants,\n      hostParticipantId: raceRoom.hostParticipantId,\n    }));\n\n    this.updateStats();\n    // No automatic bot joining - private rooms are for real human players only\n  }\n\n  private async handleReady(message: any) {\n    const { raceId, participantId } = message;\n    console.log(`[WS] Ready message received for race ${raceId} from participant ${participantId}`);\n    \n    const raceRoom = this.races.get(raceId);\n    if (!raceRoom) {\n      console.log(`[WS] No race room found for race ${raceId}`);\n      return;\n    }\n\n    // Only the host can start the race\n    if (raceRoom.hostParticipantId && participantId !== raceRoom.hostParticipantId) {\n      console.log(`[WS] Non-host ${participantId} tried to start race ${raceId} (host: ${raceRoom.hostParticipantId})`);\n      // Find the client and notify them\n      const client = raceRoom.clients.get(participantId);\n      if (client && client.ws.readyState === WebSocket.OPEN) {\n        client.ws.send(JSON.stringify({\n          type: \"error\",\n          message: \"Only the room host can start the race\",\n          code: \"NOT_HOST\"\n        }));\n      }\n      return;\n    }\n\n    let cachedRace = raceCache.getRace(raceId);\n    let race;\n    let participants;\n\n    if (cachedRace) {\n      race = cachedRace.race;\n      participants = cachedRace.participants;\n    } else {\n      race = await storage.getRace(raceId);\n      participants = await storage.getRaceParticipants(raceId);\n      if (race) {\n        raceCache.setRace(race, participants);\n      }\n    }\n    \n    if (!race || race.status !== \"waiting\") return;\n\n    // Duration is already set when room was created - no need to update here\n\n    // Use connected clients (not DB participants) for live player count\n    // This handles kicked/disconnected players correctly\n    const connectedClients = Array.from(raceRoom.clients.values());\n    const connectedHumans = connectedClients.filter(c => !c.isBot);\n    \n    // Minimum 2 human players required for multiplayer race (like TypeRacer)\n    const requiredPlayers = 2;\n    \n    if (connectedHumans.length < requiredPlayers) {\n      // Not enough connected human players\n      const client = raceRoom.clients.get(participantId);\n      if (client && client.ws.readyState === WebSocket.OPEN) {\n        const needed = requiredPlayers - connectedHumans.length;\n        client.ws.send(JSON.stringify({\n          type: \"error\",\n          message: `Need ${needed} more player${needed > 1 ? 's' : ''} to start. Share your room code with friends!`,\n          code: \"NOT_ENOUGH_PLAYERS\"\n        }));\n      }\n      return;\n    }\n    \n    // Prevent double-start race condition\n    if (raceRoom.isStarting) {\n      const client = raceRoom.clients.get(participantId);\n      if (client && client.ws.readyState === WebSocket.OPEN) {\n        client.ws.send(JSON.stringify({\n          type: \"error\",\n          message: \"Race is already starting...\",\n          code: \"RACE_STARTING\"\n        }));\n      }\n      return;\n    }\n    \n    // Set starting flag to prevent double-start\n    raceRoom.isStarting = true;\n    \n    try {\n      await this.startCountdown(raceId);\n    } catch (error) {\n      raceRoom.isStarting = false;\n      console.error(`[WS] Failed to start countdown for race ${raceId}:`, error);\n    }\n  }\n\n  private async handleReadyToggle(ws: WebSocket, message: any) {\n    const { raceId, participantId } = message;\n    const raceRoom = this.races.get(raceId);\n    if (!raceRoom) return;\n\n    const client = raceRoom.clients.get(participantId);\n    if (!client) return;\n\n    // Toggle ready state\n    client.isReady = !client.isReady;\n\n    // Collect ready states for all participants\n    const readyStates: { participantId: number; isReady: boolean }[] = [];\n    const clientEntries = Array.from(raceRoom.clients.entries());\n    for (const [pId, c] of clientEntries) {\n      readyStates.push({ participantId: pId, isReady: c.isReady });\n    }\n\n    // Broadcast ready state update to all clients\n    this.broadcastToRace(raceId, {\n      type: \"ready_state_update\",\n      participantId,\n      isReady: client.isReady,\n      readyStates,\n    });\n\n    console.log(`[WS] Ready toggle: ${client.username} is now ${client.isReady ? 'ready' : 'not ready'} in race ${raceId}`);\n  }\n\n  private async handleKickPlayer(ws: WebSocket, message: any) {\n    const { raceId, participantId, targetParticipantId } = message;\n    const raceRoom = this.races.get(raceId);\n    if (!raceRoom) return;\n\n    // Only host can kick players\n    if (raceRoom.hostParticipantId !== participantId) {\n      ws.send(JSON.stringify({\n        type: \"error\",\n        message: \"Only the host can kick players\",\n        code: \"NOT_HOST\"\n      }));\n      return;\n    }\n\n    // Cannot kick yourself\n    if (targetParticipantId === participantId) {\n      ws.send(JSON.stringify({\n        type: \"error\", \n        message: \"You cannot kick yourself\",\n        code: \"CANNOT_KICK_SELF\"\n      }));\n      return;\n    }\n\n    const targetClient = raceRoom.clients.get(targetParticipantId);\n    if (!targetClient) {\n      ws.send(JSON.stringify({\n        type: \"error\",\n        message: \"Player not found\",\n        code: \"PLAYER_NOT_FOUND\"\n      }));\n      return;\n    }\n\n    const kickedUsername = targetClient.username;\n\n    // Add to kicked list so they can't rejoin\n    raceRoom.kickedPlayers.add(targetParticipantId);\n\n    // Notify the kicked player\n    if (targetClient.ws.readyState === WebSocket.OPEN) {\n      targetClient.ws.send(JSON.stringify({\n        type: \"kicked\",\n        message: \"You have been kicked from the room by the host\"\n      }));\n      targetClient.ws.close();\n    }\n\n    // Remove from clients\n    raceRoom.clients.delete(targetParticipantId);\n\n    // Broadcast player kicked to remaining clients\n    this.broadcastToRace(raceId, {\n      type: \"player_kicked\",\n      participantId: targetParticipantId,\n      username: kickedUsername,\n    });\n\n    console.log(`[WS] Player kicked: ${kickedUsername} (${targetParticipantId}) from race ${raceId} by host`);\n  }\n\n  private async handleLockRoom(ws: WebSocket, message: any) {\n    const { raceId, participantId, locked } = message;\n    const raceRoom = this.races.get(raceId);\n    if (!raceRoom) return;\n\n    // Only host can lock/unlock room\n    if (raceRoom.hostParticipantId !== participantId) {\n      ws.send(JSON.stringify({\n        type: \"error\",\n        message: \"Only the host can lock/unlock the room\",\n        code: \"NOT_HOST\"\n      }));\n      return;\n    }\n\n    raceRoom.isLocked = locked;\n\n    // Broadcast lock state to all clients\n    this.broadcastToRace(raceId, {\n      type: \"room_lock_changed\",\n      isLocked: locked,\n    });\n\n    console.log(`[WS] Room ${raceId} ${locked ? 'locked' : 'unlocked'} by host`);\n  }\n\n  private async handleRematch(ws: WebSocket, message: any) {\n    const { raceId, participantId } = message;\n    const raceRoom = this.races.get(raceId);\n    \n    // Get the original race to copy settings\n    let race = raceCache.getRace(raceId)?.race;\n    if (!race) {\n      race = await storage.getRace(raceId);\n    }\n    \n    if (!race || race.status !== \"finished\") {\n      ws.send(JSON.stringify({\n        type: \"error\",\n        message: \"Can only request rematch after race is finished\",\n        code: \"RACE_NOT_FINISHED\"\n      }));\n      return;\n    }\n\n    // Generate a unique room code for the new race\n    const generateRoomCode = (): string => {\n      const chars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\";\n      let code = \"\";\n      for (let i = 0; i < 6; i++) {\n        code += chars.charAt(Math.floor(Math.random() * chars.length));\n      }\n      return code;\n    };\n    \n    const roomCode = generateRoomCode();\n\n    // Create a new race with same settings\n    const newRace = await storage.createRace({\n      roomCode,\n      status: \"waiting\",\n      paragraphContent: race.paragraphContent || \"\",\n      maxPlayers: race.maxPlayers,\n      isPrivate: race.isPrivate || 1,\n      raceType: race.raceType as \"standard\" | \"timed\" | undefined,\n      timeLimitSeconds: race.timeLimitSeconds,\n    });\n\n    // Broadcast rematch available to all players in the room\n    if (raceRoom) {\n      const clientsArray = Array.from(raceRoom.clients.values());\n      for (const client of clientsArray) {\n        if (client.ws.readyState === WebSocket.OPEN) {\n          client.ws.send(JSON.stringify({\n            type: \"rematch_available\",\n            newRaceId: newRace.id,\n            roomCode: newRace.roomCode,\n            createdBy: message.username || \"A player\",\n          }));\n        }\n      }\n    }\n\n    console.log(`[WS] Rematch created: Race ${newRace.id} (${roomCode}) from race ${raceId}`);\n  }\n\n  private async startCountdown(raceId: number) {\n    const raceRoom = this.races.get(raceId);\n    if (!raceRoom) return;\n\n    let cachedRace = raceCache.getRace(raceId);\n    let race;\n    let participants;\n\n    if (cachedRace) {\n      race = cachedRace.race;\n      participants = cachedRace.participants;\n    } else {\n      race = await storage.getRace(raceId);\n      if (!race) return;\n      participants = await storage.getRaceParticipants(raceId);\n      raceCache.setRace(race, participants);\n    }\n\n    raceCache.updateRaceStatus(raceId, \"countdown\");\n\n    this.broadcastToRace(raceId, {\n      type: \"countdown_start\",\n      countdown: 3,\n      participants,\n    });\n\n    storage.updateRaceStatus(raceId, \"countdown\").catch(err => \n      console.error(`[WS] Failed to update race status to countdown:`, err)\n    );\n\n    let countdown = 3;\n    raceRoom.countdownTimer = setInterval(async () => {\n      countdown--;\n      \n      if (countdown > 0) {\n        this.broadcastToRace(raceId, {\n          type: \"countdown\",\n          countdown,\n        });\n      } else {\n        if (raceRoom.countdownTimer) {\n          clearInterval(raceRoom.countdownTimer);\n        }\n        \n        // Reset the isStarting flag now that countdown is complete\n        raceRoom.isStarting = false;\n        \n        const startedAt = new Date();\n        await storage.updateRaceStatus(raceId, \"racing\", startedAt);\n        raceCache.updateRaceStatus(raceId, \"racing\", startedAt);\n        \n        // Store race start time for server-side timer validation\n        raceRoom.raceStartTime = Date.now();\n        \n        this.broadcastToRace(raceId, {\n          type: \"race_start\",\n          serverTimestamp: raceRoom.raceStartTime,\n        });\n\n        const freshRace = await storage.getRace(raceId);\n        if (!freshRace || !freshRace.paragraphContent) {\n          console.error(`[Bot Typing] Cannot start bots - race ${raceId} has no paragraph content`);\n          return;\n        }\n\n        const cachedData = raceCache.getRace(raceId);\n        const allParticipants = cachedData?.participants || await storage.getRaceParticipants(raceId);\n        const bots = allParticipants.filter(p => p.isBot === 1);\n        \n        console.log(`[Bot Typing] Starting ${bots.length} bots for race ${raceId}, paragraph length: ${freshRace.paragraphContent.length}`);\n        \n        bots.forEach(bot => {\n          console.log(`[Bot Typing] Starting bot ${bot.username} (${bot.id})`);\n          botService.startBotTyping(\n            bot.id,\n            raceId,\n            freshRace.paragraphContent.length,\n            (data) => this.broadcastToRace(raceId, data),\n            (botRaceId, botParticipantId, position) => this.handleBotFinished(botRaceId, botParticipantId, position),\n            bot.username,\n            freshRace.paragraphContent // Pass the actual paragraph text for character-level simulation\n          );\n        });\n\n        // Set up server-side timer for timed races\n        if (freshRace.raceType === \"timed\" && freshRace.timeLimitSeconds) {\n          const timeLimit = freshRace.timeLimitSeconds * 1000;\n          console.log(`[Timed Race] Setting server-side timer for race ${raceId}: ${freshRace.timeLimitSeconds}s`);\n          \n          raceRoom.timedRaceTimer = setTimeout(async () => {\n            console.log(`[Timed Race] Server timer expired for race ${raceId}, force-finishing all participants`);\n            await this.forceFinishTimedRace(raceId);\n          }, timeLimit + 1000); // Add 1 second buffer for client-server latency\n        }\n      }\n    }, 1000);\n  }\n\n  private async handleProgress(message: any) {\n    const { participantId, progress, wpm, accuracy, errors } = message;\n\n    raceCache.bufferProgress(participantId, progress, wpm, accuracy, errors);\n\n    const raceId = this.findRaceIdByParticipant(participantId);\n    if (raceId) {\n      const raceRoom = this.races.get(raceId);\n      if (raceRoom) {\n        const client = raceRoom.clients.get(participantId);\n        if (client) {\n          client.lastActivity = Date.now();\n        }\n      }\n\n      this.broadcastToRace(raceId, {\n        type: \"progress_update\",\n        participantId,\n        progress,\n        wpm,\n        accuracy,\n        errors,\n      });\n    }\n  }\n\n  private async handleFinish(message: any) {\n    const { raceId, participantId } = message;\n\n    const cachedRace = raceCache.getRace(raceId);\n    let race = cachedRace?.race;\n    \n    if (!race) {\n      race = await storage.getRace(raceId);\n    }\n\n    if (!race || race.status === \"finished\") {\n      return;\n    }\n\n    const cachedParticipants = cachedRace?.participants;\n    let participants = cachedParticipants;\n    \n    if (!participants) {\n      participants = await storage.getRaceParticipants(raceId);\n    }\n\n    const participant = participants.find(p => p.id === participantId);\n    \n    if (!participant) {\n      return;\n    }\n\n    const { position, isNewFinish } = await storage.finishParticipant(participantId);\n\n    if (!isNewFinish) {\n      return;\n    }\n\n    raceCache.finishParticipant(raceId, participantId, position);\n\n    this.broadcastToRace(raceId, {\n      type: \"participant_finished\",\n      participantId,\n      position,\n    });\n\n    // Always fetch fresh participants from DB to ensure accurate allFinished check\n    const freshParticipants = await storage.getRaceParticipants(raceId);\n    const allFinished = freshParticipants.every(p => p.isFinished === 1);\n    \n    console.log(`[Human Finish] All finished check: ${allFinished}, participants: ${freshParticipants.map(p => `${p.username}:${p.isFinished}`).join(', ')}`);\n\n    if (allFinished) {\n      // Mark as finishing to prevent heartbeat cleanup during async operations\n      const raceRoom = this.races.get(raceId);\n      if (raceRoom) {\n        raceRoom.isFinishing = true;\n      }\n      \n      const updatedParticipants = freshParticipants;\n      const finishedAt = new Date();\n      await storage.updateRaceStatus(raceId, \"finished\", undefined, finishedAt);\n      raceCache.updateRaceStatus(raceId, \"finished\", undefined, finishedAt);\n      \n      botService.stopAllBotsInRace(raceId, updatedParticipants);\n      this.cleanupExtensionState(raceId);\n      \n      const sortedResults = updatedParticipants.sort((a, b) => (a.finishPosition || 999) - (b.finishPosition || 999));\n      \n      const enrichedResults = await this.enrichResultsWithRatings(sortedResults);\n      \n      console.log(`[Race Finish] Broadcasting race_finished for race ${raceId} with ${enrichedResults.length} results`);\n      \n      this.broadcastToRace(raceId, {\n        type: \"race_finished\",\n        results: enrichedResults,\n      });\n\n      this.processRaceCompletion(raceId, sortedResults).catch(err => {\n        console.error(`[RaceFinish] Error processing race completion:`, err);\n      });\n      \n      // Clean up race room AFTER broadcasting results\n      setTimeout(() => {\n        const raceRoom = this.races.get(raceId);\n        if (raceRoom) {\n          console.log(`[Race Finish] Cleaning up race room ${raceId} after results broadcast`);\n          this.races.delete(raceId);\n          this.cleanupExtensionState(raceId);\n          this.updateStats();\n        }\n      }, 5000); // 5 second delay to allow reconnecting clients\n    }\n  }\n\n  private async handleTimedFinish(message: any) {\n    const { raceId, participantId, progress, errors } = message;\n    \n    console.log(`[Timed Finish] Participant ${participantId} finished timed race ${raceId}`);\n\n    const cachedRace = raceCache.getRace(raceId);\n    let race = cachedRace?.race;\n    \n    if (!race) {\n      race = await storage.getRace(raceId);\n    }\n\n    if (!race || race.status === \"finished\") {\n      return;\n    }\n\n    // Get race room for server-side timing validation\n    const raceRoom = this.races.get(raceId);\n    \n    // SERVER-SIDE WPM CALCULATION (don't trust client values)\n    // Use the race start time stored on the server\n    const elapsedSeconds = raceRoom?.raceStartTime \n      ? (Date.now() - raceRoom.raceStartTime) / 1000\n      : race.timeLimitSeconds || 60;\n    \n    // Calculate WPM based on server-side elapsed time and client progress\n    const correctChars = Math.max(0, progress - errors);\n    const serverCalculatedWpm = elapsedSeconds > 0 \n      ? Math.round((correctChars / 5) / (elapsedSeconds / 60)) \n      : 0;\n    \n    // Calculate accuracy properly on server side\n    const serverCalculatedAccuracy = progress > 0 \n      ? Math.round((correctChars / progress) * 100 * 100) / 100\n      : 100; // No typing = 100% accuracy (no errors made)\n    \n    // Validate progress is reasonable (max 15 chars per second is extremely fast)\n    const maxReasonableProgress = Math.ceil(elapsedSeconds * 15);\n    const validatedProgress = Math.min(progress, maxReasonableProgress);\n    \n    console.log(`[Timed Finish] Server validation: elapsed=${elapsedSeconds.toFixed(1)}s, progress=${progress}, validated=${validatedProgress}, serverWPM=${serverCalculatedWpm}, accuracy=${serverCalculatedAccuracy}`);\n\n    // Update participant's final stats with SERVER-CALCULATED values\n    await storage.updateParticipantProgress(participantId, validatedProgress, serverCalculatedWpm, serverCalculatedAccuracy, errors);\n    raceCache.bufferProgress(participantId, validatedProgress, serverCalculatedWpm, serverCalculatedAccuracy, errors);\n\n    // Mark participant as finished\n    const { position, isNewFinish } = await storage.finishParticipant(participantId);\n\n    if (!isNewFinish) {\n      return;\n    }\n\n    raceCache.finishParticipant(raceId, participantId, position);\n\n    this.broadcastToRace(raceId, {\n      type: \"participant_finished\",\n      participantId,\n      position,\n      wpm: serverCalculatedWpm,\n      accuracy: serverCalculatedAccuracy,\n    });\n\n    // Check if all participants finished\n    const freshParticipants = await storage.getRaceParticipants(raceId);\n    const allFinished = freshParticipants.every(p => p.isFinished === 1);\n    \n    console.log(`[Timed Finish] All finished check: ${allFinished}, participants: ${freshParticipants.map(p => `${p.username}:${p.isFinished}`).join(', ')}`);\n\n    if (allFinished) {\n      // Clear server-side timed race timer if it exists\n      const raceRoom = this.races.get(raceId);\n      if (raceRoom) {\n        // Mark as finishing BEFORE any async operations to prevent heartbeat cleanup\n        raceRoom.isFinishing = true;\n        \n        if (raceRoom.timedRaceTimer) {\n          clearTimeout(raceRoom.timedRaceTimer);\n          raceRoom.timedRaceTimer = undefined;\n        }\n      }\n      \n      const finishedAt = new Date();\n      await storage.updateRaceStatus(raceId, \"finished\", undefined, finishedAt);\n      raceCache.updateRaceStatus(raceId, \"finished\", undefined, finishedAt);\n      \n      botService.stopAllBotsInRace(raceId, freshParticipants);\n      this.cleanupExtensionState(raceId);\n      \n      // Sort by WPM for timed races with proper tie-breaking:\n      // 1. Higher WPM wins\n      // 2. If WPM tied: higher accuracy wins\n      // 3. If accuracy tied: more progress (characters typed) wins\n      // 4. If still tied: lower ID (joined first) wins\n      const sortedResults = freshParticipants.sort((a, b) => {\n        // Primary: Higher WPM\n        if (b.wpm !== a.wpm) return b.wpm - a.wpm;\n        // Secondary: Higher accuracy\n        if (b.accuracy !== a.accuracy) return b.accuracy - a.accuracy;\n        // Tertiary: More progress (characters typed)\n        if (b.progress !== a.progress) return b.progress - a.progress;\n        // Final: Lower ID (joined first)\n        return a.id - b.id;\n      });\n      \n      // Update and persist positions based on WPM ranking for timed races\n      for (let i = 0; i < sortedResults.length; i++) {\n        sortedResults[i].finishPosition = i + 1;\n        await storage.updateParticipantFinishPosition(sortedResults[i].id, i + 1);\n      }\n      \n      const enrichedResults = await this.enrichResultsWithRatings(sortedResults);\n      \n      console.log(`[Timed Finish] Broadcasting race_finished for race ${raceId} with ${enrichedResults.length} results`);\n      \n      this.broadcastToRace(raceId, {\n        type: \"race_finished\",\n        results: enrichedResults,\n        isTimedRace: true,\n      });\n\n      this.processRaceCompletion(raceId, sortedResults).catch(err => {\n        console.error(`[TimedRaceFinish] Error processing race completion:`, err);\n      });\n      \n      // Clean up race room AFTER broadcasting results\n      // Delay cleanup to allow any reconnecting clients to receive the results\n      setTimeout(() => {\n        const raceRoom = this.races.get(raceId);\n        if (raceRoom) {\n          console.log(`[Timed Finish] Cleaning up race room ${raceId} after results broadcast`);\n          this.races.delete(raceId);\n          this.cleanupExtensionState(raceId);\n          this.updateStats();\n        }\n      }, 5000); // 5 second delay to allow reconnecting clients\n    }\n  }\n\n  // Force finish a timed race when server timer expires (anti-cheat: don't trust client timer)\n  private async forceFinishTimedRace(raceId: number) {\n    // CRITICAL: Get race room and set isFinishing flag FIRST to prevent race condition with heartbeat\n    const raceRoom = this.races.get(raceId);\n    if (!raceRoom) {\n      console.log(`[Timed Race] No race room found for ${raceId}`);\n      return;\n    }\n    \n    // Mark as finishing BEFORE any async operations to prevent heartbeat cleanup\n    raceRoom.isFinishing = true;\n    \n    // Clear the timer\n    if (raceRoom.timedRaceTimer) {\n      clearTimeout(raceRoom.timedRaceTimer);\n      raceRoom.timedRaceTimer = undefined;\n    }\n\n    const race = await storage.getRace(raceId);\n    if (!race || race.status === \"finished\") {\n      console.log(`[Timed Race] Race ${raceId} already finished, skipping force finish`);\n      raceRoom.isFinishing = false;\n      return;\n    }\n\n    console.log(`[Timed Race] Force finishing race ${raceId}`);\n\n    const participants = await storage.getRaceParticipants(raceId);\n    const elapsedSeconds = race.timeLimitSeconds || 60;\n\n    // Finish all unfinished participants with their current progress\n    for (const participant of participants) {\n      if (participant.isFinished === 0) {\n        // Calculate WPM based on their last known progress\n        const correctChars = Math.max(0, participant.progress - participant.errors);\n        const serverCalculatedWpm = elapsedSeconds > 0 \n          ? Math.round((correctChars / 5) / (elapsedSeconds / 60)) \n          : 0;\n        \n        // Calculate accuracy properly: if no typing, 100% (no errors); otherwise calculate from progress\n        const calculatedAccuracy = participant.progress > 0 \n          ? Math.round((correctChars / participant.progress) * 100 * 100) / 100\n          : 100; // No typing = 100% accuracy (no errors made)\n        \n        console.log(`[Timed Race] Force finishing participant ${participant.username}: progress=${participant.progress}, calculated WPM=${serverCalculatedWpm}, accuracy=${calculatedAccuracy}`);\n\n        // Update with server-calculated values\n        await storage.updateParticipantProgress(\n          participant.id,\n          participant.progress,\n          serverCalculatedWpm,\n          calculatedAccuracy,\n          participant.errors\n        );\n        \n        await storage.finishParticipant(participant.id);\n        participant.wpm = serverCalculatedWpm;\n        participant.accuracy = calculatedAccuracy;\n        participant.isFinished = 1;\n      }\n    }\n\n    // Update race status\n    const finishedAt = new Date();\n    await storage.updateRaceStatus(raceId, \"finished\", undefined, finishedAt);\n    raceCache.updateRaceStatus(raceId, \"finished\", undefined, finishedAt);\n\n    botService.stopAllBotsInRace(raceId, participants);\n    this.cleanupExtensionState(raceId);\n\n    // Sort by WPM for timed races with proper tie-breaking:\n    // 1. Higher WPM wins\n    // 2. If WPM tied: higher accuracy wins\n    // 3. If accuracy tied: more progress (characters typed) wins\n    // 4. If still tied: lower ID (joined first) wins\n    const sortedResults = participants.sort((a, b) => {\n      // Primary: Higher WPM\n      if (b.wpm !== a.wpm) return b.wpm - a.wpm;\n      // Secondary: Higher accuracy\n      if (b.accuracy !== a.accuracy) return b.accuracy - a.accuracy;\n      // Tertiary: More progress (characters typed)\n      if (b.progress !== a.progress) return b.progress - a.progress;\n      // Final: Lower ID (joined first)\n      return a.id - b.id;\n    });\n\n    // Persist WPM-based rankings\n    for (let i = 0; i < sortedResults.length; i++) {\n      sortedResults[i].finishPosition = i + 1;\n      await storage.updateParticipantFinishPosition(sortedResults[i].id, i + 1);\n    }\n\n    const enrichedResults = await this.enrichResultsWithRatings(sortedResults);\n\n    console.log(`[Timed Race] Broadcasting race_finished for race ${raceId} with ${enrichedResults.length} results`);\n    \n    this.broadcastToRace(raceId, {\n      type: \"race_finished\",\n      results: enrichedResults,\n      isTimedRace: true,\n      serverEnforced: true,\n    });\n\n    this.processRaceCompletion(raceId, sortedResults).catch(err => {\n      console.error(`[TimedRaceFinish] Error processing race completion:`, err);\n    });\n    \n    // Clean up race room AFTER broadcasting results\n    // Delay cleanup to allow any reconnecting clients to receive the results\n    setTimeout(() => {\n      const raceRoom = this.races.get(raceId);\n      if (raceRoom) {\n        console.log(`[Timed Race] Cleaning up race room ${raceId} after results broadcast`);\n        this.races.delete(raceId);\n        this.cleanupExtensionState(raceId);\n        this.updateStats();\n      }\n    }, 5000); // 5 second delay to allow reconnecting clients\n  }\n\n  private async handleBotFinished(raceId: number, participantId: number, position: number) {\n    console.log(`[Bot Finish] Bot ${participantId} finished race ${raceId} in position ${position}`);\n    \n    // Check if race already finished\n    const race = await storage.getRace(raceId);\n    if (!race || race.status === \"finished\") {\n      return; // Race already finished\n    }\n    \n    // Persist bot finish to database (critical for allFinished check)\n    const { position: dbPosition, isNewFinish } = await storage.finishParticipant(participantId);\n    \n    if (!isNewFinish) {\n      console.log(`[Bot Finish] Bot ${participantId} already finished, skipping`);\n      return;\n    }\n    \n    // Update the cache with the bot's finish status\n    raceCache.finishParticipant(raceId, participantId, dbPosition);\n    \n    // Always fetch fresh participants from DB to ensure accurate allFinished check\n    const freshParticipants = await storage.getRaceParticipants(raceId);\n    const allFinished = freshParticipants.every(p => p.isFinished === 1);\n    \n    console.log(`[Bot Finish] All finished check: ${allFinished}, participants: ${freshParticipants.map(p => `${p.username}:${p.isFinished}`).join(', ')}`);\n    \n    if (allFinished) {\n      // Mark as finishing to prevent heartbeat cleanup during async operations\n      const raceRoom = this.races.get(raceId);\n      if (raceRoom) {\n        raceRoom.isFinishing = true;\n      }\n      \n      const finishedAt = new Date();\n      await storage.updateRaceStatus(raceId, \"finished\", undefined, finishedAt);\n      raceCache.updateRaceStatus(raceId, \"finished\", undefined, finishedAt);\n      \n      botService.stopAllBotsInRace(raceId, freshParticipants);\n      this.cleanupExtensionState(raceId);\n      \n      const sortedResults = freshParticipants.sort((a, b) => (a.finishPosition || 999) - (b.finishPosition || 999));\n      \n      console.log(`[Bot Finish] Broadcasting race_finished for race ${raceId}`);\n      \n      const enrichedResults = await this.enrichResultsWithRatings(sortedResults);\n      \n      this.broadcastToRace(raceId, {\n        type: \"race_finished\",\n        results: enrichedResults,\n      });\n      \n      this.processRaceCompletion(raceId, sortedResults).catch(err => {\n        console.error(`[RaceFinish] Error processing race completion:`, err);\n      });\n      \n      // Clean up race room AFTER broadcasting results\n      setTimeout(() => {\n        const raceRoom = this.races.get(raceId);\n        if (raceRoom) {\n          console.log(`[Bot Finish] Cleaning up race room ${raceId} after results broadcast`);\n          this.races.delete(raceId);\n          this.cleanupExtensionState(raceId);\n          this.updateStats();\n        }\n      }, 5000); // 5 second delay to allow reconnecting clients\n    }\n  }\n\n  private async handleLeave(ws: WebSocket, message: any) {\n    const { raceId, participantId, isRacing, progress, wpm, accuracy } = message;\n    \n    const raceRoom = this.races.get(raceId);\n    let cachedRace = raceCache.getRace(raceId);\n    let race = cachedRace?.race || await storage.getRace(raceId);\n    \n    // If leaving during an active race (racing or countdown), mark as DNF instead of deleting\n    if (race && (race.status === \"racing\" || race.status === \"countdown\" || isRacing)) {\n      console.log(`[WS Leave] Participant ${participantId} leaving active race ${raceId} - marking as DNF`);\n      \n      // Get participant info before updating\n      const currentParticipants = await storage.getRaceParticipants(raceId);\n      const participant = currentParticipants.find(p => p.id === participantId);\n      const username = participant?.username || \"Unknown\";\n      \n      // Update progress first\n      await storage.updateParticipantProgress(\n        participantId, \n        progress || 0, \n        wpm || 0, \n        accuracy || 0, \n        0\n      );\n      \n      // Mark as finished with DNF position (999 indicates DNF)\n      await storage.updateParticipantFinishPosition(participantId, 999);\n      \n      // Also mark as finished in the database\n      await storage.finishParticipant(participantId);\n      \n      // Update cache\n      const participants = await storage.getRaceParticipants(raceId);\n      raceCache.updateParticipants(raceId, participants);\n      \n      // Broadcast DNF status to other participants\n      if (raceRoom) {\n        this.broadcastToRace(raceId, {\n          type: \"participant_dnf\",\n          participantId,\n          username,\n        });\n      }\n    } else {\n      // For waiting or finished races, just delete the participant\n      await storage.deleteRaceParticipant(participantId);\n      raceCache.removeParticipant(raceId, participantId);\n      \n      if (raceRoom) {\n        this.broadcastToRace(raceId, {\n          type: \"participant_left\",\n          participantId,\n        });\n      }\n    }\n    \n    raceCache.clearProgressBuffer(participantId);\n    \n    if (raceRoom) {\n      raceRoom.clients.delete(participantId);\n      \n      // Host transfer: If the leaving player was the host, transfer to next available player\n      if (raceRoom.hostParticipantId === participantId && raceRoom.clients.size > 0) {\n        const nextHostId = Array.from(raceRoom.clients.keys())[0];\n        raceRoom.hostParticipantId = nextHostId;\n        const newHostClient = raceRoom.clients.get(nextHostId);\n        console.log(`[WS] Host transferred to ${newHostClient?.username || nextHostId} for race ${raceId}`);\n        \n        this.broadcastToRace(raceId, {\n          type: \"host_changed\",\n          newHostParticipantId: nextHostId,\n          message: `${newHostClient?.username || 'A player'} is now the host`,\n        });\n      }\n      \n      if (raceRoom.clients.size === 0) {\n        // Don't clean up if race is finishing\n        if (raceRoom.isFinishing) {\n          console.log(`[WS Leave] Keeping race room ${raceId} alive - race is finishing`);\n          this.updateStats();\n          return;\n        }\n        \n        // Don't clean up if timed race timer is active\n        if (raceRoom.timedRaceTimer) {\n          console.log(`[WS Leave] Keeping race room ${raceId} alive - timed race timer active`);\n          this.updateStats();\n          return;\n        }\n        \n        if (raceRoom.countdownTimer) {\n          clearInterval(raceRoom.countdownTimer);\n        }\n        this.races.delete(raceId);\n        this.cleanupExtensionState(raceId);\n      }\n    }\n\n    this.updateStats();\n  }\n\n  private async handleExtendParagraph(ws: WebSocket, message: any) {\n    const { raceId, participantId } = message;\n    \n    if (!raceId || !participantId) {\n      ws.send(JSON.stringify({ type: \"error\", message: \"Missing raceId or participantId\" }));\n      return;\n    }\n\n    let extensionState = this.extensionStates.get(raceId);\n    if (!extensionState) {\n      extensionState = { lastExtendedAt: 0, extensionCount: 0, pendingExtension: false };\n      this.extensionStates.set(raceId, extensionState);\n    }\n\n    const now = Date.now();\n    if (extensionState.pendingExtension) {\n      console.log(`[Paragraph Extend] Race ${raceId} extension already in progress, skipping`);\n      return;\n    }\n\n    if (now - extensionState.lastExtendedAt < EXTENSION_COOLDOWN_MS) {\n      console.log(`[Paragraph Extend] Race ${raceId} in cooldown, skipping`);\n      return;\n    }\n\n    if (extensionState.extensionCount >= MAX_EXTENSIONS_PER_RACE) {\n      console.log(`[Paragraph Extend] Race ${raceId} reached max extensions (${MAX_EXTENSIONS_PER_RACE})`);\n      return;\n    }\n\n    extensionState.pendingExtension = true;\n\n    try {\n      const race = await storage.getRace(raceId);\n      \n      if (!race || race.status !== \"racing\") {\n        ws.send(JSON.stringify({ type: \"error\", message: \"Race not active\" }));\n        return;\n      }\n\n      // Don't extend if any participant has already finished - race should end soon\n      const cachedData = raceCache.getRace(raceId);\n      const participants = cachedData?.participants || await storage.getRaceParticipants(raceId);\n      const hasFinisher = participants.some(p => p.isFinished === 1);\n      \n      if (hasFinisher) {\n        console.log(`[Paragraph Extend] Race ${raceId} has finished participants, skipping extension`);\n        return;\n      }\n\n      const additionalParagraph = await storage.getRandomParagraph(\"english\", \"quote\");\n      if (!additionalParagraph) {\n        ws.send(JSON.stringify({ type: \"error\", message: \"No additional content available\" }));\n        return;\n      }\n\n      const newContent = additionalParagraph.content;\n      const previousLength = race.paragraphContent.length;\n      \n      const updatedRace = await storage.extendRaceParagraph(raceId, newContent);\n      const newTotalLength = updatedRace?.paragraphContent.length || previousLength + newContent.length + 1;\n      \n      raceCache.extendParagraph(raceId, newContent);\n\n      extensionState.lastExtendedAt = now;\n      extensionState.extensionCount++;\n\n      console.log(`[Paragraph Extend] Race ${raceId} extended by ${newContent.length} chars (total: ${newTotalLength}, extension ${extensionState.extensionCount}/${MAX_EXTENSIONS_PER_RACE})`);\n\n      this.broadcastToRace(raceId, {\n        type: \"paragraph_extended\",\n        additionalContent: newContent,\n        newTotalLength,\n        previousLength,\n      });\n\n      // Re-fetch participants to update bots with new paragraph length\n      const currentParticipants = await storage.getRaceParticipants(raceId);\n      const bots = currentParticipants.filter(p => p.isBot === 1 && p.isFinished !== 1);\n      \n      bots.forEach(bot => {\n        botService.updateParagraphLength(bot.id, newTotalLength);\n      });\n    } finally {\n      extensionState.pendingExtension = false;\n    }\n  }\n\n  private cleanupExtensionState(raceId: number) {\n    this.extensionStates.delete(raceId);\n  }\n\n  // ============================================================================\n  // NEW MULTIPLAYER FEATURES HANDLERS\n  // ============================================================================\n\n  private async handleSubmitKeystrokes(ws: WebSocket, message: any) {\n    const { raceId, participantId, keystrokes, clientWpm, userId } = message;\n\n    if (!raceId || !participantId || !keystrokes) {\n      ws.send(JSON.stringify({ type: \"error\", message: \"Missing keystroke data\" }));\n      return;\n    }\n\n    try {\n      const validation = await antiCheatService.validateKeystrokes(\n        raceId,\n        participantId,\n        keystrokes,\n        clientWpm || 0,\n        userId\n      );\n\n      ws.send(JSON.stringify({\n        type: \"keystroke_validation\",\n        participantId,\n        isValid: validation.isValid,\n        isFlagged: validation.isFlagged,\n        serverWpm: validation.serverCalculatedWpm,\n        requiresCertification: validation.flagReasons.includes(\"requires_certification\"),\n      }));\n\n      if (validation.isFlagged) {\n        console.log(`[AntiCheat] Flagged participant ${participantId}: ${validation.flagReasons.join(\", \")}`);\n      }\n    } catch (error) {\n      console.error(\"[AntiCheat] Keystroke validation error:\", error);\n    }\n  }\n\n  private chatRateLimits: Map<number, number> = new Map(); // participantId -> last message timestamp\n  private readonly CHAT_RATE_LIMIT_MS = 2000; // 2 seconds between messages\n\n  private async handleChatMessage(ws: WebSocket, message: any) {\n    const { raceId, participantId, content, messageType = \"text\", emoteCode } = message;\n\n    if (!raceId || !participantId || !content) {\n      ws.send(JSON.stringify({ type: \"error\", message: \"Missing chat message data\" }));\n      return;\n    }\n\n    if (typeof content !== 'string') {\n      ws.send(JSON.stringify({ type: \"error\", message: \"Invalid message content\" }));\n      return;\n    }\n\n    if (content.length > 500) {\n      ws.send(JSON.stringify({ type: \"error\", message: \"Message too long\" }));\n      return;\n    }\n\n    // Rate limiting: 1 message per 2 seconds\n    // Ensure participantId is a number for consistent Map key lookups\n    const participantIdNum = typeof participantId === 'string' ? parseInt(participantId, 10) : participantId;\n    const now = Date.now();\n    const lastMessageTime = this.chatRateLimits.get(participantIdNum) || 0;\n    const timeSinceLastMessage = now - lastMessageTime;\n    \n    if (timeSinceLastMessage < this.CHAT_RATE_LIMIT_MS) {\n      const waitTime = Math.ceil((this.CHAT_RATE_LIMIT_MS - timeSinceLastMessage) / 1000);\n      ws.send(JSON.stringify({ \n        type: \"error\", \n        message: `Please wait ${waitTime} second${waitTime > 1 ? 's' : ''} before sending another message`,\n        code: \"CHAT_RATE_LIMITED\"\n      }));\n      return;\n    }\n    \n    // Update last message timestamp\n    this.chatRateLimits.set(participantIdNum, now);\n\n    const raceRoom = this.races.get(raceId);\n    if (!raceRoom) return;\n\n    const client = raceRoom.clients.get(participantId);\n    if (!client) {\n      ws.send(JSON.stringify({ type: \"error\", message: \"Unauthorized: not a participant\" }));\n      return;\n    }\n\n    const sanitizedContent = DOMPurify.sanitize(content.trim(), {\n      ALLOWED_TAGS: [],\n      ALLOWED_ATTR: [],\n    });\n\n    if (!sanitizedContent) {\n      ws.send(JSON.stringify({ type: \"error\", message: \"Empty message after sanitization\" }));\n      return;\n    }\n\n    try {\n      const chatMessage = await storage.createRaceChatMessage({\n        raceId,\n        participantId,\n        messageType,\n        content: sanitizedContent,\n        emoteCode,\n      });\n\n      this.broadcastToRace(raceId, {\n        type: \"chat_message\",\n        message: {\n          id: chatMessage.id,\n          participantId,\n          username: client.username,\n          content: sanitizedContent,\n          messageType,\n          emoteCode,\n          createdAt: chatMessage.createdAt,\n        },\n      });\n\n      this.triggerBotChatResponses(raceId, sanitizedContent);\n    } catch (error) {\n      console.error(\"[Chat] Message save error:\", error);\n    }\n  }\n\n  private botChatCooldowns: Map<number, number> = new Map(); // per-bot cooldowns\n  private raceBurstWindow: Map<number, { count: number; expiresAt: number }> = new Map();\n  private readonly BOT_CHAT_COOLDOWN_MS = 6000; // 6 seconds per bot\n  private readonly RACE_BURST_LIMIT = 5; // max 5 bot messages per window\n  private readonly RACE_BURST_WINDOW_MS = 8000; // 8 second window\n\n  private async triggerBotChatResponses(raceId: number, message: string, senderIsBot: boolean = false, chainDepth: number = 0) {\n    try {\n      console.log(`[Bot Chat] Triggered for race ${raceId}: \"${message.substring(0, 30)}...\" (isBot=${senderIsBot}, depth=${chainDepth})`);\n      \n      const race = await storage.getRace(raceId);\n      if (!race) {\n        console.log(`[Bot Chat] Race ${raceId} not found`);\n        return;\n      }\n\n      if (race.status === \"finished\" || race.status === \"abandoned\") {\n        console.log(`[Bot Chat] Race ${raceId} is ${race.status}`);\n        return;\n      }\n\n      // Limit chain depth to prevent infinite bot loops\n      if (chainDepth >= 2) {\n        console.log(`[Bot Chat] Chain depth ${chainDepth} reached, stopping`);\n        return;\n      }\n\n      // Check race burst limit\n      const now = Date.now();\n      const burst = this.raceBurstWindow.get(raceId);\n      if (burst && now < burst.expiresAt) {\n        if (burst.count >= this.RACE_BURST_LIMIT) {\n          console.log(`[Bot Chat] Race ${raceId} hit burst limit (${burst.count}/${this.RACE_BURST_LIMIT})`);\n          return;\n        }\n        console.log(`[Bot Chat] Burst window active: ${burst.count}/${this.RACE_BURST_LIMIT}`);\n      } else {\n        console.log(`[Bot Chat] New burst window started`);\n        this.raceBurstWindow.set(raceId, { count: 0, expiresAt: now + this.RACE_BURST_WINDOW_MS });\n      }\n\n      const participants = await storage.getRaceParticipants(raceId);\n      const botParticipants = participants.filter(p => p.isBot === 1);\n\n      console.log(`[Bot Chat] Found ${botParticipants.length} bots in race`);\n\n      if (botParticipants.length === 0) return;\n\n      // Filter bots by per-bot cooldown\n      const eligibleBots = botParticipants.filter(bot => {\n        const lastChat = this.botChatCooldowns.get(bot.id) || 0;\n        const elapsed = now - lastChat;\n        const isEligible = elapsed >= this.BOT_CHAT_COOLDOWN_MS;\n        console.log(`[Bot Chat] Bot ${bot.username} (${bot.id}): lastChat=${lastChat}, elapsed=${elapsed}ms, eligible=${isEligible}`);\n        return isEligible;\n      });\n\n      if (eligibleBots.length === 0) {\n        console.log(`[Bot Chat] No eligible bots (all on cooldown)`);\n        return;\n      }\n      \n      console.log(`[Bot Chat] ${eligibleBots.length} bots eligible to respond`);\n\n      // Small chance no one responds (like real group chats)\n      // 10% chance no one responds\n      if (Math.random() < 0.10) {\n        console.log(`[Bot Chat] No one responded (realistic silence)`);\n        return;\n      }\n      \n      // If sender is bot, 60% chance to skip (bots don't always reply to bots)\n      if (senderIsBot && Math.random() < 0.6) {\n        console.log(`[Bot Chat] Skipping bot-to-bot response (random)`);\n        return;\n      }\n\n      // Realistic distribution: 50% chance 1 bot, 35% chance 2 bots, 15% chance 3 bots\n      const roll = Math.random();\n      let numResponders: number;\n      if (roll < 0.50) {\n        numResponders = 1;\n      } else if (roll < 0.85) {\n        numResponders = Math.min(2, eligibleBots.length);\n      } else {\n        numResponders = Math.min(3, eligibleBots.length);\n      }\n      \n      // For bot chains, max 1-2 responders\n      if (senderIsBot) {\n        numResponders = Math.min(numResponders, Math.random() < 0.7 ? 1 : 2);\n      }\n\n      // Shuffle and select bots\n      const shuffled = [...eligibleBots].sort(() => Math.random() - 0.5);\n      const respondingBots = shuffled.slice(0, numResponders);\n\n      console.log(`[Bot Chat] ${respondingBots.length} bots will respond to: \"${message.substring(0, 30)}...\"`);\n\n      // Schedule staggered responses with quick timing\n      respondingBots.forEach((bot, index) => {\n        // Fast response delays like texting friends\n        const typingSpeed = Math.random();\n        let delay: number;\n        \n        if (typingSpeed < 0.5) {\n          // Quick responder (50%) - 0.8-1.5s\n          delay = 800 + Math.random() * 700;\n        } else if (typingSpeed < 0.8) {\n          // Normal responder (30%) - 1.5-2.5s\n          delay = 1500 + Math.random() * 1000;\n        } else {\n          // Slower responder (20%) - 2.5-4s\n          delay = 2500 + Math.random() * 1500;\n        }\n        \n        // Add stagger for multiple responders (0.5-1s between each)\n        delay += index * (500 + Math.random() * 500);\n\n        this.botChatCooldowns.set(bot.id, now);\n\n        setTimeout(async () => {\n          await this.sendBotChatMessage(raceId, bot, message, chainDepth);\n        }, delay);\n      });\n\n      // Update burst counter\n      const currentBurst = this.raceBurstWindow.get(raceId)!;\n      currentBurst.count += respondingBots.length;\n\n    } catch (error) {\n      console.error(\"[Bot Chat] Error:\", error);\n    }\n  }\n\n  private async sendBotChatMessage(raceId: number, bot: any, userMessage: string, chainDepth: number) {\n    try {\n      const race = await storage.getRace(raceId);\n      if (!race || race.status === \"finished\" || race.status === \"abandoned\") return;\n\n      // Try AI first, always fallback to casual response\n      let response = await this.generateAIBotResponse(userMessage, bot.username);\n      \n      if (!response) {\n        const intent = this.detectMessageIntent(userMessage);\n        response = this.getContextualResponse(intent);\n        console.log(`[Bot Chat] Using fallback for ${bot.username}: \"${response}\"`);\n      }\n\n      const botChatMessage = await storage.createRaceChatMessage({\n        raceId,\n        participantId: bot.id,\n        messageType: \"text\",\n        content: response,\n      });\n\n      this.broadcastToRace(raceId, {\n        type: \"chat_message\",\n        message: {\n          id: botChatMessage.id,\n          participantId: bot.id,\n          username: bot.username,\n          content: response,\n          messageType: \"text\",\n          createdAt: botChatMessage.createdAt,\n        },\n      });\n\n      console.log(`[Bot Chat] ${bot.username}: \"${response}\"`);\n\n      // Trigger bot-to-bot response chain (with reduced probability)\n      if (chainDepth < 1 && Math.random() < 0.3) {\n        setTimeout(() => {\n          this.triggerBotChatResponses(raceId, response!, true, chainDepth + 1);\n        }, 2000 + Math.random() * 2000);\n      }\n\n    } catch (error) {\n      console.error(\"[Bot Chat] Send error:\", error);\n    }\n  }\n\n  private async generateAIBotResponse(userMessage: string, botName: string): Promise<string | null> {\n    // Random personality for this response\n    const personalities = [\n      { style: \"hyped\", desc: \"super excited and energetic, uses caps sometimes, lots of emojis\" },\n      { style: \"chill\", desc: \"laid back and cool, minimal words, very casual\" },\n      { style: \"competitive\", desc: \"playfully trash-talking, confident, wants to win\" },\n      { style: \"friendly\", desc: \"warm and supportive, encouraging others\" },\n      { style: \"quiet\", desc: \"few words, observant, occasional short comment\" },\n      { style: \"funny\", desc: \"jokes around, uses humor, playful teasing\" },\n    ];\n    const personality = personalities[Math.floor(Math.random() * personalities.length)];\n    \n    try {\n      const response = await openai.chat.completions.create({\n        model: \"gpt-4o-mini\",\n        messages: [\n          {\n            role: \"system\",\n            content: `You're ${botName} in a typing race game chat. Personality: ${personality.style} - ${personality.desc}\n\nBE HUMAN - text like you're in a group chat with friends:\n- 2-8 words max, super short\n- Use: lol, haha, nah, yoo, bet, fr, lowkey, ngl, gg, rip, damn, nice, bruh, yo\n- Skip punctuation, lowercase mostly\n- Emoji only sometimes (30% of messages)\n- Can have small typos occasionally\n- React naturally - agree, disagree, joke, ignore parts\n- Don't always directly answer - sometimes just react\n- Match their energy or contrast it\n\n${personality.style === 'hyped' ? 'Examples: \"LETS GOOO\", \"yooo im ready ðŸ”¥\", \"this is gonna be good\"' : ''}\n${personality.style === 'chill' ? 'Examples: \"yea\", \"cool\", \"aight\", \"we chilling\"' : ''}\n${personality.style === 'competitive' ? 'Examples: \"ez clap\", \"yall arent ready\", \"watch me\", \"too slow ðŸ˜¤\"' : ''}\n${personality.style === 'friendly' ? 'Examples: \"gl everyone!\", \"u got this\", \"have fun yall\"' : ''}\n${personality.style === 'quiet' ? 'Examples: \"yo\", \"hm\", \"nice\", \"k\"' : ''}\n${personality.style === 'funny' ? 'Examples: \"lmao\", \"bro what ðŸ˜‚\", \"im literally so bad\", \"rip my fingers\"' : ''}\n\nNEVER sound like AI. No \"I'd be happy to\" or formal language.`\n          },\n          {\n            role: \"user\",\n            content: userMessage\n          }\n        ],\n        max_tokens: 20,\n        temperature: 1.1,\n      });\n\n      const reply = response.choices[0]?.message?.content?.trim();\n      if (reply && reply.length > 0 && reply.length < 60) {\n        console.log(`[Bot Chat AI] ${botName} (${personality.style}): \"${reply}\"`);\n        return reply;\n      }\n      return null;\n    } catch (error) {\n      console.error(\"[Bot Chat AI] OpenAI error:\", error);\n      return null;\n    }\n  }\n\n  private getContextualResponse(intent: string): string {\n    const responses: Record<string, string[]> = {\n      greetings: [\n        \"yo\", \"yoo\", \"heyyy\", \"sup\", \"ayy\", \"hey\", \"yooo\",\n        \"yo whats up\", \"heyy\", \"wassup\", \"hi\", \"ayy whats good\",\n      ],\n      goodLuck: [\n        \"gl\", \"u2\", \"same\", \"ty\", \"gl gl\", \"thanks u too\",\n        \"haha gl\", \"yea gl\", \"ðŸ€\", \"gl everyone\",\n      ],\n      finishing: [\n        \"gg\", \"ggs\", \"gg wp\", \"good game\", \"nice race\",\n        \"that was fun\", \"gg everyone\", \"wp\", \"good one\",\n      ],\n      reactions: [\n        \"fr\", \"lol\", \"haha\", \"nice\", \"damn\", \"yea\",\n        \"true\", \"facts\", \"ikr\", \"real\", \"same\", \"mood\",\n      ],\n      competitive: [\n        \"lets go\", \"ez\", \"bet\", \"watch\", \"im ready\",\n        \"bring it\", \"too ez\", \"ðŸ˜¤\", \"we'll see\", \"ok bet\",\n      ],\n      encouragement: [\n        \"u got this\", \"lets get it\", \"we got this\", \"go go\",\n        \"cmon\", \"yea\", \"lets gooo\", \"ðŸ’ª\",\n      ],\n      question: [\n        \"idk\", \"maybe\", \"hm\", \"who knows\", \"lol idk\",\n        \"not sure\", \"ðŸ¤·\", \"we'll see\",\n      ],\n      casual: [\n        \"yea\", \"lol\", \"haha\", \"nice\", \"ok\", \"bet\", \"fr\",\n        \"true\", \"aight\", \"cool\", \"k\", \"ye\", \"word\", \"fasho\",\n      ],\n    };\n\n    const categoryResponses = responses[intent] || responses.casual;\n    return categoryResponses[Math.floor(Math.random() * categoryResponses.length)];\n  }\n\n  private detectMessageIntent(content: string): string {\n    const lower = content.toLowerCase();\n    \n    if (/\\b(hi|hello|hey|sup|yo|hola|greetings|what'?s up)\\b/.test(lower)) {\n      return 'greetings';\n    }\n    if (/\\b(good\\s*luck|gl|best of luck|fingers crossed|luck)\\b/.test(lower)) {\n      return 'goodLuck';\n    }\n    if (/\\b(gg|good\\s*game|well\\s*played|nice\\s*race|great\\s*race|congrat)\\b/.test(lower)) {\n      return 'finishing';\n    }\n    if (/\\b(nice|great|awesome|cool|wow|amazing|impressive|sick|fire)\\b/.test(lower)) {\n      return 'reactions';\n    }\n    if (/\\b(let'?s\\s*go|come\\s*on|race|challenge|beat|fast|ready|start|bring)\\b/.test(lower)) {\n      return 'competitive';\n    }\n    if (/\\b(you\\s*can|keep|going|try|practice|effort|hope|wish)\\b/.test(lower)) {\n      return 'encouragement';\n    }\n    if (/\\?/.test(lower)) {\n      return 'question';\n    }\n    \n    return 'casual';\n  }\n\n  private spectators: Map<number, Map<WebSocket, string>> = new Map();\n\n  private async handleSpectate(ws: WebSocket, message: any) {\n    const { raceId, userId, sessionId } = message;\n\n    if (!raceId) {\n      ws.send(JSON.stringify({ type: \"error\", message: \"Missing race ID\" }));\n      return;\n    }\n\n    const race = await storage.getRace(raceId);\n    if (!race) {\n      ws.send(JSON.stringify({ type: \"error\", message: \"Race not found\" }));\n      return;\n    }\n\n    let spectatorMap = this.spectators.get(raceId);\n    if (!spectatorMap) {\n      spectatorMap = new Map();\n      this.spectators.set(raceId, spectatorMap);\n    }\n    \n    const generatedSessionId = sessionId || `ws_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n    spectatorMap.set(ws, generatedSessionId);\n\n    try {\n      await storage.addRaceSpectator({\n        raceId,\n        userId,\n        sessionId: generatedSessionId,\n        isActive: true,\n      });\n\n      const spectatorCount = await storage.getActiveSpectatorCount(raceId);\n      const participants = await storage.getRaceParticipants(raceId);\n\n      ws.send(JSON.stringify({\n        type: \"spectate_joined\",\n        race,\n        participants,\n        spectatorCount,\n      }));\n\n      this.broadcastToRace(raceId, {\n        type: \"spectator_update\",\n        spectatorCount,\n      });\n    } catch (error) {\n      console.error(\"[Spectator] Join error:\", error);\n    }\n  }\n\n  private async handleStopSpectate(ws: WebSocket, message: any) {\n    const { raceId } = message;\n\n    if (!raceId) return;\n\n    await this.cleanupSpectator(ws, raceId);\n  }\n\n  private async cleanupSpectator(ws: WebSocket, raceId: number) {\n    const spectatorMap = this.spectators.get(raceId);\n    if (!spectatorMap) return;\n\n    const sessionId = spectatorMap.get(ws);\n    spectatorMap.delete(ws);\n    \n    if (spectatorMap.size === 0) {\n      this.spectators.delete(raceId);\n    }\n\n    if (sessionId) {\n      try {\n        await storage.removeRaceSpectator(raceId, sessionId);\n        const spectatorCount = await storage.getActiveSpectatorCount(raceId);\n        \n        this.broadcastToRace(raceId, {\n          type: \"spectator_update\",\n          spectatorCount,\n        });\n      } catch (error) {\n        console.error(\"[Spectator] Leave error:\", error);\n      }\n    }\n  }\n\n  private async handleGetReplay(ws: WebSocket, message: any) {\n    const { raceId } = message;\n\n    if (!raceId) {\n      ws.send(JSON.stringify({ type: \"error\", message: \"Missing race ID\" }));\n      return;\n    }\n\n    try {\n      const replay = await storage.getRaceReplay(raceId);\n      \n      if (!replay) {\n        ws.send(JSON.stringify({ type: \"error\", message: \"Replay not found\" }));\n        return;\n      }\n\n      await storage.incrementReplayViewCount(raceId);\n\n      ws.send(JSON.stringify({\n        type: \"replay_data\",\n        replay,\n      }));\n    } catch (error) {\n      console.error(\"[Replay] Fetch error:\", error);\n      ws.send(JSON.stringify({ type: \"error\", message: \"Failed to fetch replay\" }));\n    }\n  }\n\n  private async handleGetRating(ws: WebSocket, message: any) {\n    const { userId } = message;\n\n    if (!userId) {\n      ws.send(JSON.stringify({ type: \"error\", message: \"Missing user ID\" }));\n      return;\n    }\n\n    try {\n      const rating = await storage.getOrCreateUserRating(userId);\n      const tierInfo = eloRatingService.getTierInfo(rating.tier);\n\n      ws.send(JSON.stringify({\n        type: \"rating_data\",\n        rating: {\n          ...rating,\n          tierInfo,\n        },\n      }));\n    } catch (error) {\n      console.error(\"[Rating] Fetch error:\", error);\n      ws.send(JSON.stringify({ type: \"error\", message: \"Failed to fetch rating\" }));\n    }\n  }\n\n  private async processRaceCompletion(raceId: number, participants: any[]) {\n    try {\n      const results = participants\n        .filter(p => p.isFinished === 1)\n        .map(p => ({\n          participantId: p.id,\n          userId: p.userId,\n          position: p.finishPosition || 999,\n          wpm: p.wpm,\n          accuracy: p.accuracy,\n          isBot: p.isBot === 1,\n        }));\n\n      const ratingChanges = await eloRatingService.processRaceResults(raceId, results);\n\n      if (ratingChanges.length > 0) {\n        this.broadcastToRace(raceId, {\n          type: \"rating_changes\",\n          changes: ratingChanges.map(change => ({\n            participantId: results.find(r => r.userId === change.userId)?.participantId,\n            ...change,\n            tierInfo: eloRatingService.getTierInfo(change.tier),\n          })),\n        });\n      }\n\n      const keystrokesData = await storage.getRaceKeystrokes(raceId);\n      const race = await storage.getRace(raceId);\n      \n      if (race && keystrokesData.length > 0) {\n        try {\n          await storage.createRaceReplay({\n            raceId,\n            paragraphContent: race.paragraphContent,\n            duration: race.finishedAt && race.startedAt \n              ? Math.round((race.finishedAt.getTime() - race.startedAt.getTime()))\n              : null,\n            participantData: participants.map(p => ({\n              participantId: p.id,\n              username: p.username,\n              wpm: p.wpm,\n              accuracy: p.accuracy,\n              position: p.finishPosition,\n              keystrokes: keystrokesData.find(k => k.participantId === p.id)?.keystrokes || [],\n            })),\n            isPublic: false,\n          });\n          console.log(`[Replay] Saved replay for race ${raceId}`);\n        } catch (error) {\n          console.error(`[Replay] Failed to save replay for race ${raceId}:`, error);\n        }\n      }\n    } catch (error) {\n      console.error(`[RaceCompletion] Error processing race ${raceId}:`, error);\n    }\n  }\n\n  private handleDisconnect(ws: WebSocket) {\n    const racesToCheck = Array.from(this.races.entries());\n    for (const [raceId, raceRoom] of racesToCheck) {\n      const clientsToCheck = Array.from(raceRoom.clients.entries());\n      for (const [participantId, client] of clientsToCheck) {\n        if (client.ws === ws) {\n          raceRoom.clients.delete(participantId);\n          \n          // Store disconnected player info for potential reconnection\n          if (!this.disconnectedPlayers.has(raceId)) {\n            this.disconnectedPlayers.set(raceId, new Map());\n          }\n          this.disconnectedPlayers.get(raceId)!.set(participantId, {\n            username: client.username,\n            isReady: client.isReady,\n            disconnectedAt: Date.now(),\n          });\n          \n          // Clean up old disconnected player entries after 5 minutes\n          setTimeout(() => {\n            const disconnectedMap = this.disconnectedPlayers.get(raceId);\n            if (disconnectedMap) {\n              disconnectedMap.delete(participantId);\n              if (disconnectedMap.size === 0) {\n                this.disconnectedPlayers.delete(raceId);\n              }\n            }\n          }, 5 * 60 * 1000);\n          \n          this.broadcastToRace(raceId, {\n            type: \"participant_disconnected\",\n            participantId,\n            username: client.username,\n          });\n          \n          // Host transfer: If disconnected player was host, transfer to next available HUMAN player\n          if (raceRoom.hostParticipantId === participantId && raceRoom.clients.size > 0) {\n            // Find next human player (exclude bots) sorted by join order\n            const humanClients = Array.from(raceRoom.clients.entries())\n              .filter(([_, c]) => !c.isBot)\n              .sort((a, b) => a[0] - b[0]); // Sort by participantId (join order)\n            \n            if (humanClients.length > 0) {\n              const [nextHostId, newHostClient] = humanClients[0];\n              raceRoom.hostParticipantId = nextHostId;\n              console.log(`[WS] Host transferred to ${newHostClient.username} (${nextHostId}) after disconnect`);\n              \n              this.broadcastToRace(raceId, {\n                type: \"host_changed\",\n                newHostParticipantId: nextHostId,\n                newHostUsername: newHostClient.username,\n                message: `${newHostClient.username} is now the host`,\n              });\n            } else {\n              // No human players left, clear host\n              raceRoom.hostParticipantId = undefined;\n              console.log(`[WS] No human players left in race ${raceId}, host cleared`);\n            }\n          }\n          \n          // Check if we need to cancel countdown due to insufficient players\n          const connectedHumans = Array.from(raceRoom.clients.values()).filter(c => !c.isBot);\n          const cachedRace = raceCache.getRace(raceId);\n          const currentStatus = cachedRace?.race?.status;\n          \n          if (currentStatus === \"countdown\" && connectedHumans.length < 2) {\n            // Cancel countdown - not enough players\n            if (raceRoom.countdownTimer) {\n              clearInterval(raceRoom.countdownTimer);\n              raceRoom.countdownTimer = undefined;\n            }\n            \n            // Reset the isStarting flag since countdown is cancelled\n            raceRoom.isStarting = false;\n            \n            // Revert race status to waiting\n            raceCache.updateRaceStatus(raceId, \"waiting\");\n            storage.updateRaceStatus(raceId, \"waiting\").catch(err => \n              console.error(`[WS] Failed to revert race status:`, err)\n            );\n            \n            this.broadcastToRace(raceId, {\n              type: \"countdown_cancelled\",\n              reason: \"Not enough players - need at least 2 to start\",\n              code: \"INSUFFICIENT_PLAYERS\"\n            });\n            \n            console.log(`[WS] Countdown cancelled for race ${raceId} - only ${connectedHumans.length} human player(s) remaining`);\n          }\n\n          if (raceRoom.clients.size === 0) {\n            // NEVER clean up a race that is currently finishing - prevents race condition\n            if (raceRoom.isFinishing) {\n              console.log(`[WS Disconnect] Keeping race room ${raceId} alive - race is finishing`);\n              this.updateStats();\n              return;\n            }\n            \n            // For timed races that are still racing, DON'T delete the room - let the timer complete\n            // This ensures results are broadcast even if all clients disconnect\n            if (raceRoom.timedRaceTimer) {\n              console.log(`[WS Disconnect] Keeping race room ${raceId} alive - timed race timer active`);\n              // Keep the race room and timer alive - it will clean up after broadcasting results\n              this.updateStats();\n              return;\n            }\n            \n            // Clean up all timers\n            if (raceRoom.countdownTimer) {\n              clearInterval(raceRoom.countdownTimer);\n            }\n            this.races.delete(raceId);\n            this.cleanupExtensionState(raceId);\n            this.disconnectedPlayers.delete(raceId);\n            this.chatRateLimits.clear(); // Clean up rate limit tracking\n          }\n          \n          this.updateStats();\n          return;\n        }\n      }\n    }\n\n    const spectatorEntries = Array.from(this.spectators.entries());\n    for (const [raceId, spectatorMap] of spectatorEntries) {\n      if (spectatorMap.has(ws)) {\n        this.cleanupSpectator(ws, raceId).catch(err => {\n          console.error(`[Spectator] Cleanup error on disconnect:`, err);\n        });\n        break;\n      }\n    }\n  }\n\n  private findRaceIdByParticipant(participantId: number): number | null {\n    const racesToCheck = Array.from(this.races.entries());\n    for (const [raceId, raceRoom] of racesToCheck) {\n      if (raceRoom.clients.has(participantId)) {\n        return raceId;\n      }\n    }\n    return null;\n  }\n\n  private broadcastToRace(raceId: number, message: any) {\n    const raceRoom = this.races.get(raceId);\n    if (!raceRoom) {\n      console.log(`[WS Broadcast] No race room for race ${raceId}`);\n      return;\n    }\n\n    const data = JSON.stringify(message);\n    let sentCount = 0;\n    raceRoom.clients.forEach(client => {\n      if (client.ws.readyState === WebSocket.OPEN) {\n        client.ws.send(data);\n        sentCount++;\n      }\n    });\n    \n    if (message.type === \"countdown_start\" || message.type === \"countdown\" || message.type === \"race_start\") {\n      console.log(`[WS Broadcast] Sent ${message.type} to ${sentCount}/${raceRoom.clients.size} clients in race ${raceId}`);\n    }\n  }\n\n  getRaceRoom(raceId: number): RaceRoom | undefined {\n    return this.races.get(raceId);\n  }\n\n  private acceptConnection(ws: WebSocket): boolean {\n    this.checkLoadState();\n\n    if (this.stats.totalConnections >= MAX_CONNECTIONS) {\n      this.loadState.connectionRejections++;\n      ws.close(1013, \"Server at capacity\");\n      console.warn(`[WS] Connection rejected: server at capacity (${this.stats.totalConnections}/${MAX_CONNECTIONS})`);\n      return false;\n    }\n\n    const loadFactor = this.stats.totalConnections / MAX_CONNECTIONS;\n    if (loadFactor >= LOAD_SHEDDING_THRESHOLD) {\n      this.loadState.isUnderPressure = true;\n      \n      if (Math.random() < (loadFactor - LOAD_SHEDDING_THRESHOLD) * 5) {\n        this.loadState.connectionRejections++;\n        ws.close(1013, \"Server under heavy load\");\n        console.warn(`[WS] Connection shed: server under pressure (load: ${(loadFactor * 100).toFixed(1)}%)`);\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  private checkLoadState(): void {\n    const now = Date.now();\n    \n    if (now - this.loadState.lastRecoveryCheck > DB_RECOVERY_INTERVAL_MS) {\n      this.loadState.lastRecoveryCheck = now;\n      \n      if (this.loadState.dbFailures > 0) {\n        this.loadState.dbFailures = Math.max(0, this.loadState.dbFailures - 1);\n        console.log(`[WS] DB failure count recovered to ${this.loadState.dbFailures}`);\n      }\n    }\n\n    const loadFactor = this.stats.totalConnections / MAX_CONNECTIONS;\n    this.loadState.isUnderPressure = loadFactor >= LOAD_SHEDDING_THRESHOLD || \n                                      this.loadState.dbFailures >= DB_FAILURE_THRESHOLD;\n  }\n\n  private recordDbFailure(): void {\n    this.loadState.dbFailures++;\n    this.loadState.lastDbFailure = Date.now();\n    \n    if (this.loadState.dbFailures >= DB_FAILURE_THRESHOLD) {\n      this.loadState.isUnderPressure = true;\n      console.error(`[WS] DB failure threshold reached (${this.loadState.dbFailures}), entering degraded mode`);\n    }\n  }\n\n  private recordDbSuccess(): void {\n    if (this.loadState.dbFailures > 0) {\n      this.loadState.dbFailures = Math.max(0, this.loadState.dbFailures - 1);\n    }\n  }\n\n  isUnderPressure(): boolean {\n    return this.loadState.isUnderPressure;\n  }\n\n  getStats(): ServerStats {\n    this.updateStats();\n    return { ...this.stats };\n  }\n\n  getCacheStats() {\n    return raceCache.getStats();\n  }\n\n  getRateLimiterStats() {\n    return wsRateLimiter.getStats();\n  }\n\n  getCleanupStats() {\n    return raceCleanupScheduler.getStats();\n  }\n\n  getLoadState() {\n    return { ...this.loadState };\n  }\n}\n\nexport const raceWebSocket = new RaceWebSocketServer();\n","path":null,"size_bytes":90485,"size_tokens":null},"client/src/pages/race.tsx":{"content":"import { useState, useEffect, useRef, useCallback } from \"react\";\nimport { useLocation, useRoute } from \"wouter\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useNetwork } from \"@/lib/network-context\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Trophy, Copy, Check, Loader2, Home, RotateCcw, ArrowLeft, WifiOff, RefreshCw, Info, Gauge, Target, Bot, User, Users, Share2, Play, Flag, AlertTriangle, Wifi, XCircle, Timer, Sparkles, MessageCircle, Send, TrendingUp, TrendingDown, Award, Eye, Film, Zap, LogOut, Lock, ExternalLink } from \"lucide-react\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from \"@/components/ui/alert-dialog\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Input } from \"@/components/ui/input\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { toast } from \"sonner\";\nimport confetti from \"canvas-confetti\";\nimport { calculateWPM, calculateAccuracy } from \"@/lib/typing-utils\";\nimport { RaceCertificate } from \"@/components/RaceCertificate\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\n\n// Error types for better error handling\ntype ErrorType = \"network\" | \"race_not_found\" | \"race_full\" | \"race_started\" | \"websocket\" | \"unknown\";\n\ninterface ErrorState {\n  type: ErrorType;\n  message: string;\n  canRetry: boolean;\n  retryAction?: () => void;\n}\n\n// Error display component with retry functionality\nfunction RaceErrorDisplay({ \n  error, \n  onRetry, \n  onGoBack \n}: { \n  error: ErrorState; \n  onRetry?: () => void; \n  onGoBack: () => void;\n}) {\n  const getErrorIcon = () => {\n    switch (error.type) {\n      case \"network\":\n      case \"websocket\":\n        return <WifiOff className=\"h-12 w-12 text-yellow-500\" />;\n      case \"race_not_found\":\n        return <XCircle className=\"h-12 w-12 text-red-500\" />;\n      case \"race_full\":\n        return <Users className=\"h-12 w-12 text-orange-500\" />;\n      case \"race_started\":\n        return <Timer className=\"h-12 w-12 text-orange-500\" />;\n      default:\n        return <AlertTriangle className=\"h-12 w-12 text-red-500\" />;\n    }\n  };\n\n  const getErrorTitle = () => {\n    switch (error.type) {\n      case \"network\": return \"Connection Problem\";\n      case \"websocket\": return \"Live Connection Lost\";\n      case \"race_not_found\": return \"Race Not Found\";\n      case \"race_full\": return \"Race is Full\";\n      case \"race_started\": return \"Race Already Started\";\n      default: return \"Something Went Wrong\";\n    }\n  };\n\n  return (\n    <TooltipProvider delayDuration={300}>\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center space-y-4\">\n              <div className=\"flex justify-center\">\n                {getErrorIcon()}\n              </div>\n              <div>\n                <h2 className=\"text-xl font-bold\">{getErrorTitle()}</h2>\n                <p className=\"text-muted-foreground mt-2\">{error.message}</p>\n              </div>\n              <div className=\"flex flex-col gap-2 pt-4\">\n                {error.canRetry && onRetry && (\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button onClick={onRetry} className=\"w-full\" data-testid=\"button-retry\">\n                        <RefreshCw className=\"h-4 w-4 mr-2\" />\n                        Try Again\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p className=\"font-medium\">Retry</p>\n                      <p className=\"text-zinc-400\">Attempt to reconnect or reload the race</p>\n                    </TooltipContent>\n                  </Tooltip>\n                )}\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button variant=\"outline\" onClick={onGoBack} className=\"w-full\" data-testid=\"button-go-back\">\n                      <Home className=\"h-4 w-4 mr-2\" />\n                      Back to Multiplayer\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Return to the multiplayer lobby</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </TooltipProvider>\n  );\n}\n\n// Loading component with descriptive state\nfunction RaceLoadingDisplay({ message, subMessage }: { message: string; subMessage?: string }) {\n  return (\n    <TooltipProvider delayDuration={300}>\n      <div className=\"min-h-screen flex items-center justify-center bg-background\">\n        <div className=\"text-center space-y-4\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <div className=\"inline-flex items-center justify-center\">\n                <Loader2 className=\"h-12 w-12 animate-spin text-primary\" />\n              </div>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>Loading race data from server</p>\n            </TooltipContent>\n          </Tooltip>\n          <div>\n            <p className=\"text-lg font-medium\">{message}</p>\n            {subMessage && (\n              <p className=\"text-sm text-muted-foreground mt-1\">{subMessage}</p>\n            )}\n          </div>\n        </div>\n      </div>\n    </TooltipProvider>\n  );\n}\n\n// Network status banner component\nfunction NetworkStatusBanner({ \n  isConnected, \n  isReconnecting, \n  reconnectAttempt, \n  maxAttempts,\n  onManualRetry \n}: { \n  isConnected: boolean; \n  isReconnecting: boolean;\n  reconnectAttempt: number;\n  maxAttempts: number;\n  onManualRetry: () => void;\n}) {\n  if (isConnected) return null;\n\n  return (\n    <TooltipProvider delayDuration={300}>\n      <Alert variant=\"destructive\" className=\"mb-4 border-yellow-500/50 bg-yellow-500/10\">\n        <WifiOff className=\"h-4 w-4\" />\n        <AlertTitle className=\"flex items-center gap-2\">\n          {isReconnecting ? \"Reconnecting...\" : \"Connection Lost\"}\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Info className=\"h-3.5 w-3.5 cursor-help\" />\n            </TooltipTrigger>\n            <TooltipContent className=\"max-w-xs\">\n              <p className=\"font-medium\">WebSocket Disconnected</p>\n              <p className=\"text-zinc-400\">Your live connection to the race server was interrupted. We're trying to reconnect automatically.</p>\n            </TooltipContent>\n          </Tooltip>\n        </AlertTitle>\n        <AlertDescription className=\"flex items-center justify-between\">\n          <span>\n            {isReconnecting \n              ? `Attempt ${reconnectAttempt} of ${maxAttempts}...` \n              : \"Your progress is saved. Click retry to reconnect.\"}\n          </span>\n          {!isReconnecting && (\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Button variant=\"outline\" size=\"sm\" onClick={onManualRetry} data-testid=\"button-manual-reconnect\">\n                  <RefreshCw className=\"h-3.5 w-3.5 mr-1\" />\n                  Retry\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Manually attempt to reconnect</p>\n              </TooltipContent>\n            </Tooltip>\n          )}\n        </AlertDescription>\n      </Alert>\n    </TooltipProvider>\n  );\n}\n\ninterface Race {\n  id: number;\n  roomCode: string;\n  status: string;\n  paragraphContent: string;\n  maxPlayers: number;\n  isPrivate: number;\n  raceType?: string;\n  timeLimitSeconds?: number | null;\n  startedAt?: string | null;\n}\n\ninterface Participant {\n  id: number;\n  raceId: number;\n  username: string;\n  avatarColor: string | null;\n  isBot?: number | boolean;\n  progress: number;\n  wpm: number;\n  accuracy: number;\n  errors: number;\n  isFinished: number;\n  finishPosition: number | null;\n  rating?: number | null;\n  tier?: string | null;\n  tierInfo?: {\n    name: string;\n    color: string;\n    minRating: number;\n  } | null;\n  ratingChange?: number | null;\n  userId?: string | null;\n}\n\ninterface ChatMessage {\n  id: number;\n  username: string;\n  avatarColor: string | null;\n  message: string;\n  isSystem: boolean;\n  createdAt: string;\n}\n\ninterface RatingInfo {\n  rating: number;\n  tier: string;\n  tierInfo?: {\n    name: string;\n    color: string;\n    minRating: number;\n  };\n  ratingChange?: number;\n}\n\nconst MAX_CHAT_LENGTH = 500;\n\nfunction RaceChat({\n  raceId,\n  participantId,\n  username,\n  avatarColor,\n  sendWsMessage,\n  messages,\n  isEnabled,\n  isCompact = false,\n  wsConnected = true\n}: {\n  raceId: number;\n  participantId: number;\n  username: string;\n  avatarColor: string | null;\n  sendWsMessage: (msg: any) => void;\n  messages: ChatMessage[];\n  isEnabled: boolean;\n  isCompact?: boolean;\n  wsConnected?: boolean;\n}) {\n  const [input, setInput] = useState(\"\");\n  const [sendError, setSendError] = useState<string | null>(null);\n  const scrollRef = useRef<HTMLDivElement>(null);\n\n  useEffect(() => {\n    if (scrollRef.current) {\n      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;\n    }\n  }, [messages]);\n\n  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const value = e.target.value;\n    if (value.length <= MAX_CHAT_LENGTH) {\n      setInput(value);\n      if (sendError) setSendError(null);\n    }\n  };\n\n  const sendMessage = () => {\n    const trimmedInput = input.trim();\n    if (!trimmedInput || !isEnabled) return;\n    \n    if (!wsConnected) {\n      setSendError(\"Connection lost\");\n      toast.error(\"Cannot send message\", { \n        description: \"Connection lost. Reconnecting...\",\n        icon: <WifiOff className=\"h-4 w-4\" />\n      });\n      return;\n    }\n    \n    if (trimmedInput.length > MAX_CHAT_LENGTH) {\n      setSendError(\"Message too long\");\n      toast.error(\"Message too long\", { \n        description: `Maximum ${MAX_CHAT_LENGTH} characters allowed`,\n        icon: <AlertTriangle className=\"h-4 w-4\" />\n      });\n      return;\n    }\n    \n    setSendError(null);\n    \n    try {\n      sendWsMessage({\n        type: \"chat_message\",\n        raceId,\n        participantId,\n        content: trimmedInput,\n      });\n      setInput(\"\");\n    } catch (error) {\n      setSendError(\"Failed to send\");\n      toast.error(\"Failed to send message\", { \n        description: \"Please check your connection and try again\",\n        icon: <XCircle className=\"h-4 w-4\" />\n      });\n    }\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === \"Enter\" && !e.shiftKey) {\n      e.preventDefault();\n      sendMessage();\n    }\n  };\n\n  const getDisabledReason = (): string => {\n    if (!wsConnected) return \"Reconnecting to server...\";\n    if (!isEnabled) return \"Chat disabled during active typing\";\n    return \"\";\n  };\n\n  const isInputDisabled = !isEnabled || !wsConnected;\n\n  if (isCompact) {\n    return (\n      <TooltipProvider delayDuration={300}>\n        <div className=\"border rounded-lg p-2 bg-muted/20\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div className=\"flex items-center gap-2 cursor-help\">\n                  <MessageCircle className=\"h-3 w-3 text-muted-foreground\" />\n                  <span className=\"text-xs font-medium\">Chat</span>\n                  {!wsConnected && <WifiOff className=\"h-3 w-3 text-yellow-500\" />}\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"top\" className=\"max-w-xs\">\n                <p className=\"font-medium\">Race Chat</p>\n                <p className=\"text-zinc-400\">\n                  {wsConnected \n                    ? \"Chat with other racers. Press Enter to send.\"\n                    : \"Reconnecting to chat server...\"}\n                </p>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n          <div \n            ref={scrollRef}\n            className=\"h-20 overflow-y-auto mb-1 space-y-1\"\n          >\n            {messages.length === 0 ? (\n              <p className=\"text-xs text-muted-foreground text-center py-1\">\n                No messages\n              </p>\n            ) : (\n              messages.slice(-10).map((msg, idx) => (\n                <Tooltip key={msg.id || idx}>\n                  <TooltipTrigger asChild>\n                    <div className={`text-xs cursor-default ${msg.isSystem ? 'text-muted-foreground italic' : ''}`}>\n                      {!msg.isSystem && (\n                        <span className=\"font-medium text-primary\">\n                          {msg.username}:\n                        </span>\n                      )}{\" \"}\n                      <span>{msg.message}</span>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"left\">\n                    <p className=\"text-xs\">{msg.isSystem ? \"System message\" : `From ${msg.username}`}</p>\n                  </TooltipContent>\n                </Tooltip>\n              ))\n            )}\n          </div>\n          <div className=\"flex gap-1\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div className=\"flex-1\">\n                  <Input\n                    value={input}\n                    onChange={handleInputChange}\n                    onKeyDown={handleKeyDown}\n                    placeholder={isInputDisabled ? getDisabledReason() || \"Disabled\" : \"Chat...\"}\n                    disabled={isInputDisabled}\n                    maxLength={MAX_CHAT_LENGTH}\n                    className={`text-xs h-6 ${sendError ? 'border-red-500' : ''}`}\n                    data-testid=\"input-chat-compact\"\n                  />\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"top\">\n                <p>{isInputDisabled ? getDisabledReason() : \"Type your message here\"}</p>\n              </TooltipContent>\n            </Tooltip>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Button\n                  size=\"sm\"\n                  onClick={sendMessage}\n                  disabled={isInputDisabled || !input.trim()}\n                  className=\"h-6 px-2\"\n                  data-testid=\"button-send-chat-compact\"\n                >\n                  <Send className=\"h-2.5 w-2.5\" />\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent side=\"top\">\n                <p>Send message (Enter)</p>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n        </div>\n      </TooltipProvider>\n    );\n  }\n\n  return (\n    <TooltipProvider delayDuration={300}>\n      <Card className=\"h-64\">\n        <CardHeader className=\"py-2 px-3\">\n          <CardTitle className=\"text-sm flex items-center gap-2\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div className=\"flex items-center gap-2 cursor-help\">\n                  <MessageCircle className=\"h-4 w-4\" />\n                  Race Chat\n                  {!wsConnected && <WifiOff className=\"h-3 w-3 text-yellow-500\" />}\n                  <Info className=\"h-3 w-3 text-muted-foreground\" />\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"right\" className=\"max-w-xs\">\n                <p className=\"font-medium\">Race Chat</p>\n                <p className=\"text-zinc-400\">\n                  Chat with other participants before and after the race. \n                  Chat is disabled during active typing to prevent distraction.\n                </p>\n                <p className=\"text-zinc-400 mt-1\">\n                  <span className=\"text-primary\">Tip:</span> Press Enter to send, max {MAX_CHAT_LENGTH} characters.\n                </p>\n              </TooltipContent>\n            </Tooltip>\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"p-2 h-[calc(100%-4rem)]\">\n          <div className=\"flex flex-col h-full\">\n            <div \n              ref={scrollRef}\n              className=\"flex-1 overflow-y-auto pr-2 mb-2\"\n            >\n              <div className=\"space-y-2\">\n                {messages.length === 0 ? (\n                  <div className=\"text-center py-4\">\n                    <MessageCircle className=\"h-8 w-8 text-muted-foreground/30 mx-auto mb-2\" />\n                    <p className=\"text-xs text-muted-foreground\">\n                      No messages yet. Say hi!\n                    </p>\n                  </div>\n                ) : (\n                  messages.map((msg, idx) => (\n                    <Tooltip key={msg.id || idx}>\n                      <TooltipTrigger asChild>\n                        <div className={`text-xs cursor-default hover:bg-muted/30 rounded px-1 py-0.5 transition-colors ${msg.isSystem ? 'text-muted-foreground italic' : ''}`}>\n                          {!msg.isSystem && (\n                            <span className=\"font-medium text-primary\">\n                              {msg.username}:\n                            </span>\n                          )}{\" \"}\n                          <span>{msg.message}</span>\n                        </div>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"left\">\n                        <p className=\"text-xs\">\n                          {msg.isSystem \n                            ? \"System notification\" \n                            : `Message from ${msg.username}`}\n                        </p>\n                      </TooltipContent>\n                    </Tooltip>\n                  ))\n                )}\n              </div>\n            </div>\n            <div className=\"space-y-1\">\n              {sendError && (\n                <div className=\"flex items-center gap-1 text-xs text-red-500\">\n                  <AlertTriangle className=\"h-3 w-3\" />\n                  <span>{sendError}</span>\n                </div>\n              )}\n              <div className=\"flex gap-1\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"flex-1\">\n                      <Input\n                        value={input}\n                        onChange={handleInputChange}\n                        onKeyDown={handleKeyDown}\n                        placeholder={isInputDisabled ? getDisabledReason() || \"Chat disabled during race\" : \"Type a message...\"}\n                        disabled={isInputDisabled}\n                        maxLength={MAX_CHAT_LENGTH}\n                        className={`text-xs h-7 ${sendError ? 'border-red-500 focus-visible:ring-red-500' : ''}`}\n                        data-testid=\"input-chat\"\n                      />\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\">\n                    <p className=\"font-medium\">\n                      {isInputDisabled ? getDisabledReason() : \"Message Input\"}\n                    </p>\n                    {!isInputDisabled && (\n                      <p className=\"text-zinc-400\">Press Enter to send</p>\n                    )}\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button\n                      size=\"sm\"\n                      onClick={sendMessage}\n                      disabled={isInputDisabled || !input.trim()}\n                      className=\"h-7 px-2\"\n                      data-testid=\"button-send-chat\"\n                    >\n                      <Send className=\"h-3 w-3\" />\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\">\n                    <p className=\"font-medium\">Send Message</p>\n                    <p className=\"text-zinc-400\">Or press Enter</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n              <div className=\"flex items-center justify-between\">\n                {input.length > MAX_CHAT_LENGTH * 0.8 ? (\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div className={`text-xs flex items-center gap-1 ${input.length >= MAX_CHAT_LENGTH ? 'text-red-500' : 'text-muted-foreground'}`}>\n                        {input.length >= MAX_CHAT_LENGTH && <AlertTriangle className=\"h-3 w-3\" />}\n                        {input.length}/{MAX_CHAT_LENGTH}\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>{input.length >= MAX_CHAT_LENGTH ? \"Character limit reached!\" : `${MAX_CHAT_LENGTH - input.length} characters remaining`}</p>\n                    </TooltipContent>\n                  </Tooltip>\n                ) : <div />}\n                {!wsConnected && (\n                  <div className=\"text-xs text-yellow-500 flex items-center gap-1\">\n                    <Loader2 className=\"h-3 w-3 animate-spin\" />\n                    Reconnecting...\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </TooltipProvider>\n  );\n}\n\nconst TIER_DESCRIPTIONS: Record<string, string> = {\n  bronze: \"Starting tier. Keep practicing to climb!\",\n  silver: \"You're improving! Aim for Gold next.\",\n  gold: \"Solid skills! Top 50% of players.\",\n  platinum: \"Excellent typing speed! Top 25%.\",\n  diamond: \"Elite typist! Top 10% of all players.\",\n  master: \"Exceptional! Top 5% of players.\",\n  grandmaster: \"Legendary status! Top 1% of all typists.\",\n};\n\nfunction RatingChangeDisplay({ ratingInfo, position }: { ratingInfo: RatingInfo | null; position: number | null }) {\n  if (!ratingInfo) return null;\n\n  const isPositive = (ratingInfo.ratingChange || 0) >= 0;\n  const tierColor = ratingInfo.tierInfo?.color || \"gray\";\n  const tierDescription = TIER_DESCRIPTIONS[ratingInfo.tier.toLowerCase()] || \"Keep racing to improve!\";\n\n  return (\n    <TooltipProvider delayDuration={300}>\n      <div className=\"p-3 border rounded-lg bg-muted/30 space-y-2\">\n        <div className=\"flex items-center justify-between\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <div className=\"flex items-center gap-2 cursor-help\">\n                <Award className=\"h-5 w-5 text-primary\" />\n                <span className=\"font-medium\">Your Rating</span>\n                <Info className=\"h-3 w-3 text-muted-foreground\" />\n              </div>\n            </TooltipTrigger>\n            <TooltipContent side=\"top\" className=\"max-w-xs\">\n              <p className=\"font-medium\">ELO Skill Rating</p>\n              <p className=\"text-zinc-400\">\n                Your competitive rating based on race performance. \n                Win against higher-rated players to gain more points.\n              </p>\n              <p className=\"text-zinc-400 mt-1\">\n                <span className=\"text-primary\">Range:</span> 100 - 3000\n              </p>\n            </TooltipContent>\n          </Tooltip>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Badge \n                variant=\"outline\" \n                className=\"capitalize cursor-help\"\n                style={{ borderColor: tierColor, color: tierColor }}\n              >\n                {ratingInfo.tierInfo?.name || ratingInfo.tier}\n              </Badge>\n            </TooltipTrigger>\n            <TooltipContent side=\"left\" className=\"max-w-xs\">\n              <p className=\"font-medium capitalize\" style={{ color: tierColor }}>\n                {ratingInfo.tierInfo?.name || ratingInfo.tier} Tier\n              </p>\n              <p className=\"text-zinc-400\">{tierDescription}</p>\n              {ratingInfo.tierInfo?.minRating && (\n                <p className=\"text-zinc-400 mt-1\">\n                  <span className=\"text-primary\">Min rating:</span> {ratingInfo.tierInfo.minRating}\n                </p>\n              )}\n            </TooltipContent>\n          </Tooltip>\n        </div>\n        <div className=\"flex items-center justify-between\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <div className=\"text-2xl font-bold cursor-help\">{ratingInfo.rating}</div>\n            </TooltipTrigger>\n            <TooltipContent side=\"bottom\">\n              <p className=\"font-medium\">Current Rating: {ratingInfo.rating}</p>\n              <p className=\"text-zinc-400\">Your skill level compared to other players</p>\n            </TooltipContent>\n          </Tooltip>\n          {ratingInfo.ratingChange !== undefined && (\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div className={`flex items-center gap-1 text-sm font-medium cursor-help ${isPositive ? 'text-green-500' : 'text-red-500'}`}>\n                  {isPositive ? <TrendingUp className=\"h-4 w-4\" /> : <TrendingDown className=\"h-4 w-4\" />}\n                  {isPositive ? '+' : ''}{ratingInfo.ratingChange}\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"left\" className=\"max-w-xs\">\n                <p className=\"font-medium\">\n                  {isPositive ? 'Rating Gained' : 'Rating Lost'}\n                </p>\n                <p className=\"text-zinc-400\">\n                  {isPositive \n                    ? `Great race! You gained ${ratingInfo.ratingChange} points.`\n                    : `You lost ${Math.abs(ratingInfo.ratingChange)} points. Keep practicing!`}\n                </p>\n                {position !== null && (\n                  <p className=\"text-zinc-400 mt-1\">\n                    <span className=\"text-primary\">Finish position:</span> #{position}\n                  </p>\n                )}\n              </TooltipContent>\n            </Tooltip>\n          )}\n        </div>\n      </div>\n    </TooltipProvider>\n  );\n}\n\nfunction RaceFinishBanner({ \n  position, \n  totalPlayers, \n  wpm, \n  accuracy, \n  isWinner,\n  onDismiss \n}: { \n  position: number | null; \n  totalPlayers: number;\n  wpm: number;\n  accuracy: number;\n  isWinner: boolean;\n  onDismiss: () => void;\n}) {\n  const [isVisible, setIsVisible] = useState(false);\n  const [showStats, setShowStats] = useState(false);\n\n  useEffect(() => {\n    setTimeout(() => setIsVisible(true), 100);\n    setTimeout(() => setShowStats(true), 800);\n    \n    if (isWinner) {\n      const duration = 3000;\n      const animationEnd = Date.now() + duration;\n      \n      const runConfetti = () => {\n        confetti({\n          particleCount: 3,\n          angle: 60,\n          spread: 55,\n          origin: { x: 0 },\n          colors: ['#FFD700', '#FFA500', '#FF6347']\n        });\n        confetti({\n          particleCount: 3,\n          angle: 120,\n          spread: 55,\n          origin: { x: 1 },\n          colors: ['#FFD700', '#FFA500', '#FF6347']\n        });\n        \n        if (Date.now() < animationEnd) {\n          requestAnimationFrame(runConfetti);\n        }\n      };\n      runConfetti();\n    }\n  }, [isWinner]);\n\n  const getPositionDisplay = () => {\n    if (!position) return { emoji: 'ðŸ', text: 'Race Complete!', color: 'text-blue-400' };\n    switch (position) {\n      case 1: return { emoji: 'ðŸ†', text: '1st Place!', color: 'text-yellow-400' };\n      case 2: return { emoji: 'ðŸ¥ˆ', text: '2nd Place!', color: 'text-gray-300' };\n      case 3: return { emoji: 'ðŸ¥‰', text: '3rd Place!', color: 'text-amber-600' };\n      default: return { emoji: 'ðŸ', text: `#${position} of ${totalPlayers}`, color: 'text-blue-400' };\n    }\n  };\n\n  const positionInfo = getPositionDisplay();\n\n  return (\n    <div \n      className={`fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm transition-opacity duration-500 ${isVisible ? 'opacity-100' : 'opacity-0'}`}\n      onClick={onDismiss}\n      data-testid=\"race-finish-banner\"\n    >\n      <div \n        className={`text-center transform transition-all duration-700 ${isVisible ? 'scale-100 translate-y-0' : 'scale-75 translate-y-10'}`}\n        onClick={(e) => e.stopPropagation()}\n      >\n        <div className={`text-8xl mb-4 animate-bounce`}>\n          {positionInfo.emoji}\n        </div>\n        \n        <h1 className={`text-5xl md:text-6xl font-bold ${positionInfo.color} mb-2 drop-shadow-lg`}>\n          {positionInfo.text}\n        </h1>\n        \n        {isWinner && (\n          <p className=\"text-xl text-yellow-300 mb-4 animate-pulse\">\n            âœ¨ Congratulations, Champion! âœ¨\n          </p>\n        )}\n        \n        <div className={`mt-6 transition-all duration-500 ${showStats ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'}`}>\n          <div className=\"flex items-center justify-center gap-8 text-white\">\n            <div className=\"text-center\">\n              <div className=\"text-4xl font-bold text-primary\">{wpm}</div>\n              <div className=\"text-sm text-muted-foreground flex items-center gap-1 justify-center\">\n                <Gauge className=\"h-4 w-4\" />\n                WPM\n              </div>\n            </div>\n            <div className=\"w-px h-12 bg-muted-foreground/30\" />\n            <div className=\"text-center\">\n              <div className=\"text-4xl font-bold text-green-400\">{accuracy}%</div>\n              <div className=\"text-sm text-muted-foreground flex items-center gap-1 justify-center\">\n                <Target className=\"h-4 w-4\" />\n                Accuracy\n              </div>\n            </div>\n          </div>\n        </div>\n        \n        <div className={`mt-8 transition-all duration-500 delay-300 ${showStats ? 'opacity-100' : 'opacity-0'}`}>\n          <Button \n            size=\"lg\" \n            onClick={onDismiss}\n            className=\"px-8 py-3 text-lg bg-primary hover:bg-primary/90\"\n            data-testid=\"button-view-results\"\n          >\n            <Trophy className=\"h-5 w-5 mr-2\" />\n            View Results\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function RacePage() {\n  const [, params] = useRoute(\"/race/:id\");\n  const [, setLocation] = useLocation();\n  const { user } = useAuth();\n  const { isOnline, wasOffline } = useNetwork();\n  \n  const [race, setRace] = useState<Race | null>(null);\n  const raceRef = useRef<Race | null>(null);\n  const [participants, setParticipants] = useState<Participant[]>([]);\n  const [myParticipant, setMyParticipant] = useState<Participant | null>(null);\n  const myParticipantRef = useRef<Participant | null>(null);\n  const [hostParticipantId, setHostParticipantId] = useState<number | null>(null);\n  const [ws, setWs] = useState<WebSocket | null>(null);\n  const [wsConnected, setWsConnected] = useState(false);\n  const [isReconnecting, setIsReconnecting] = useState(false);\n  const [countdown, setCountdown] = useState<number | null>(null);\n  const [isRacing, setIsRacing] = useState(false);\n  const [currentIndex, setCurrentIndex] = useState(0);\n  const [errors, setErrors] = useState(0);\n  const [charStates, setCharStates] = useState<('pending' | 'correct' | 'incorrect')[]>([]);\n  const [startTime, setStartTime] = useState<number | null>(null);\n  const [copied, setCopied] = useState(false);\n  const [isFocused, setIsFocused] = useState(false);\n  const [liveWpm, setLiveWpm] = useState(0);\n  const [liveAccuracy, setLiveAccuracy] = useState(100);\n  const [elapsedTime, setElapsedTime] = useState(0);\n  const [timeRemaining, setTimeRemaining] = useState<number | null>(null);\n  const textContainerRef = useRef<HTMLDivElement>(null);\n  const caretRef = useRef<HTMLSpanElement>(null);\n  const [errorState, setErrorState] = useState<ErrorState | null>(null);\n  const [loadingMessage, setLoadingMessage] = useState(\"Loading race...\");\n  const hiddenInputRef = useRef<HTMLInputElement>(null);\n  const currentIndexRef = useRef(0);\n  const errorsRef = useRef(0);\n  const isComposingRef = useRef(false);\n  const reconnectAttempts = useRef(0);\n  const reconnectTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const maxReconnectAttempts = 5;\n  const pendingMessagesRef = useRef<string[]>([]);\n  const seenParticipantJoinsRef = useRef<Set<number>>(new Set());\n  const hasJoinedRef = useRef(false);\n  const lastJoinedRaceIdRef = useRef<number | null>(null);\n  const extensionRequestedRef = useRef(false);\n  const extensionThreshold = 0.85;\n  const timedFinishSentRef = useRef(false);\n  const [chatMessages, setChatMessages] = useState<ChatMessage[]>([]);\n  const [ratingInfo, setRatingInfo] = useState<RatingInfo | null>(null);\n  const [showFinishBanner, setShowFinishBanner] = useState(false);\n  const finishBannerDismissedRef = useRef(false);\n  const [isStarting, setIsStarting] = useState(false);\n  const [isTransitioning, setIsTransitioning] = useState(false);\n  const [transitionMessage, setTransitionMessage] = useState(\"\");\n  const [finishBannerData, setFinishBannerData] = useState<{\n    position: number | null;\n    totalPlayers: number;\n    wpm: number;\n    accuracy: number;\n  } | null>(null);\n  const [showLeaveConfirmation, setShowLeaveConfirmation] = useState(false);\n  const [isLeaving, setIsLeaving] = useState(false);\n  const [readyStates, setReadyStates] = useState<Map<number, boolean>>(new Map());\n  const [isRoomLocked, setIsRoomLocked] = useState(false);\n  const [rematchInfo, setRematchInfo] = useState<{\n    newRaceId: number;\n    roomCode: string;\n    createdBy: string;\n  } | null>(null);\n  const [isReady, setIsReady] = useState(false);\n  const [shareDialogOpen, setShareDialogOpen] = useState(false);\n  const [lastResultSnapshot, setLastResultSnapshot] = useState<{\n    wpm: number;\n    accuracy: number;\n    consistency: number;\n    placement: number;\n    totalParticipants: number;\n    characters: number;\n    errors: number;\n    duration: number;\n  } | null>(null);\n\n  useEffect(() => {\n    raceRef.current = race;\n  }, [race]);\n\n  useEffect(() => {\n    currentIndexRef.current = currentIndex;\n  }, [currentIndex]);\n\n  useEffect(() => {\n    errorsRef.current = errors;\n  }, [errors]);\n\n  useEffect(() => {\n    myParticipantRef.current = myParticipant;\n  }, [myParticipant]);\n\n  useEffect(() => {\n    if (!params?.id) return;\n\n    // Reset state for new race\n    finishBannerDismissedRef.current = false;\n    setShowFinishBanner(false);\n    setFinishBannerData(null);\n    \n    const roomCodeOrId = params.id;\n    const savedParticipant = localStorage.getItem(`race_${roomCodeOrId}_participant`);\n    \n    if (savedParticipant) {\n      const participant = JSON.parse(savedParticipant);\n      setMyParticipant(participant);\n    }\n\n    fetchRaceData();\n    connectWebSocket();\n\n    return () => {\n      if (ws) {\n        ws.close();\n      }\n    };\n  }, [params?.id]);\n\n  useEffect(() => {\n    if (ws && myParticipant && race && ws.readyState === WebSocket.OPEN) {\n      if (hasJoinedRef.current && lastJoinedRaceIdRef.current === race.id) {\n        return;\n      }\n      \n      hasJoinedRef.current = true;\n      lastJoinedRaceIdRef.current = race.id;\n      \n      sendWsMessage({\n        type: \"join\",\n        raceId: race.id,\n        participantId: myParticipant.id,\n        username: myParticipant.username,\n      });\n    }\n  }, [ws, myParticipant, race]);\n\n  useEffect(() => {\n    if (isRacing && hiddenInputRef.current) {\n      hiddenInputRef.current.focus();\n      setIsFocused(true);\n    }\n  }, [isRacing]);\n\n  useEffect(() => {\n    if (!isRacing || !startTime) return;\n    \n    const interval = setInterval(() => {\n      const elapsed = (Date.now() - startTime) / 1000;\n      setElapsedTime(elapsed);\n      \n      const idx = currentIndexRef.current;\n      const errs = errorsRef.current;\n      const correctChars = Math.max(0, idx - errs);\n      const wpm = elapsed > 0 ? Math.round((correctChars / 5) / (elapsed / 60)) : 0;\n      const accuracy = idx > 0 ? Math.round(((idx - errs) / idx) * 100) : 100;\n      \n      setLiveWpm(wpm);\n      setLiveAccuracy(Math.max(0, accuracy));\n      \n      // Update time remaining for timed races\n      if (race?.raceType === \"timed\" && race.timeLimitSeconds) {\n        const remaining = Math.max(0, race.timeLimitSeconds - elapsed);\n        setTimeRemaining(remaining);\n        \n        // Handle time running out - only send once\n        if (remaining <= 0 && myParticipant && !myParticipant.isFinished && !timedFinishSentRef.current) {\n          timedFinishSentRef.current = true;\n          // Send finish message via WebSocket when time runs out\n          sendWsMessage({\n            type: \"timed_finish\",\n            raceId: race.id,\n            participantId: myParticipant.id,\n            progress: idx,\n            wpm: wpm,\n            accuracy: accuracy,\n            errors: errs\n          });\n        }\n      }\n    }, 100);\n    \n    return () => clearInterval(interval);\n  }, [isRacing, startTime, race?.raceType, race?.timeLimitSeconds, race?.id, myParticipant]);\n\n  useEffect(() => {\n    if (caretRef.current && textContainerRef.current) {\n      const caret = caretRef.current;\n      const container = textContainerRef.current;\n      const containerRect = container.getBoundingClientRect();\n      const caretRect = caret.getBoundingClientRect();\n      \n      const caretRelativeTop = caretRect.top - containerRect.top + container.scrollTop;\n      const visibleTop = container.scrollTop;\n      const visibleBottom = visibleTop + container.clientHeight;\n      \n      if (caretRelativeTop < visibleTop + 50) {\n        container.scrollTo({ top: caretRelativeTop - 50, behavior: 'smooth' });\n      } else if (caretRelativeTop > visibleBottom - 50) {\n        container.scrollTo({ top: caretRelativeTop - container.clientHeight + 50, behavior: 'smooth' });\n      }\n    }\n  }, [currentIndex]);\n\n  function handleFocus() {\n    setIsFocused(true);\n  }\n\n  function handleBlur() {\n    setIsFocused(false);\n  }\n\n  function handleCompositionStart() {\n    isComposingRef.current = true;\n  }\n\n  function handleCompositionEnd(e: React.CompositionEvent<HTMLInputElement>) {\n    isComposingRef.current = false;\n    if (e.data) {\n      processInput(e.data);\n    }\n    if (hiddenInputRef.current) {\n      hiddenInputRef.current.value = '';\n    }\n  }\n\n  function handlePaste(e: React.ClipboardEvent<HTMLInputElement>) {\n    e.preventDefault();\n    toast.error(\"Paste disabled - Please type manually for accurate results\");\n  }\n\n  function handleCut(e: React.ClipboardEvent<HTMLInputElement>) {\n    e.preventDefault();\n  }\n\n  function handleTyping(e: React.FormEvent<HTMLInputElement>) {\n    if (!isRacing || !race || isComposingRef.current) return;\n\n    const input = e.currentTarget;\n    const value = input.value;\n\n    if (value.length === 0) return;\n\n    processInput(value);\n    input.value = '';\n  }\n\n  function processInput(value: string) {\n    if (!race) return;\n\n    let localIndex = currentIndexRef.current;\n    let localErrors = errorsRef.current;\n    const newCharStates = [...charStates];\n\n    for (let i = 0; i < value.length; i++) {\n      if (localIndex >= race.paragraphContent.length) {\n        break;\n      }\n\n      const typedChar = value[i];\n      const expectedChar = race.paragraphContent[localIndex];\n\n      if (typedChar === expectedChar) {\n        newCharStates[localIndex] = 'correct';\n      } else {\n        newCharStates[localIndex] = 'incorrect';\n        localErrors++;\n      }\n\n      localIndex++;\n    }\n\n    currentIndexRef.current = localIndex;\n    errorsRef.current = localErrors;\n    setCurrentIndex(localIndex);\n    setErrors(localErrors);\n    setCharStates(newCharStates);\n    updateProgress(localIndex, localErrors);\n  }\n\n  function handleKeyDown(e: React.KeyboardEvent<HTMLInputElement>) {\n    if (!isRacing) return;\n\n    if (e.key === 'Backspace' && currentIndexRef.current > 0) {\n      e.preventDefault();\n      const newIndex = currentIndexRef.current - 1;\n      currentIndexRef.current = newIndex;\n      \n      const newCharStates = [...charStates];\n      if (newCharStates[newIndex] === 'incorrect') {\n        errorsRef.current = Math.max(0, errorsRef.current - 1);\n        setErrors(errorsRef.current);\n      }\n      newCharStates[newIndex] = 'pending';\n      setCharStates(newCharStates);\n      \n      setCurrentIndex(newIndex);\n      updateProgress(newIndex, errorsRef.current);\n    }\n  }\n\n  useEffect(() => {\n    if (race && race.paragraphContent && charStates.length !== race.paragraphContent.length) {\n      setCharStates(new Array(race.paragraphContent.length).fill('pending'));\n    }\n  }, [race?.paragraphContent]);\n\n  // Handle case where race is already finished when loaded (e.g., after reconnect or page refresh)\n  useEffect(() => {\n    // Don't show banner again if user already dismissed it\n    if (finishBannerDismissedRef.current) return;\n    \n    if (race?.status === \"finished\" && !showFinishBanner) {\n      console.log(\"[Race Debug] Detected finished race from API/state\");\n      \n      // If participants are empty, refetch race data to get results\n      if (participants.length === 0) {\n        console.log(\"[Race Debug] No participants loaded, refetching race data\");\n        fetchRaceData();\n        return;\n      }\n      \n      console.log(\"[Race Debug] Showing finish banner with\", participants.length, \"participants\");\n      const sortedParticipants = [...participants].sort((a, b) => (a.finishPosition || 999) - (b.finishPosition || 999));\n      \n      // Try to find my result, or use the first participant if myParticipant is null\n      const myResult = myParticipant \n        ? sortedParticipants.find(p => p.id === myParticipant.id)\n        : sortedParticipants[0]; // Fallback for when myParticipant isn't loaded\n      \n      if (myResult) {\n        const chars = (myResult as any).characters || myResult.wpm * 5;\n        const consistency = Math.max(0, Math.min(100, Math.round(100 - ((chars - myResult.wpm * 5) / chars) * 100)));\n        \n        setFinishBannerData({\n          position: myResult.finishPosition || null,\n          totalPlayers: participants.length,\n          wpm: myResult.wpm,\n          accuracy: myResult.accuracy,\n        });\n        \n        setLastResultSnapshot({\n          wpm: myResult.wpm,\n          accuracy: myResult.accuracy,\n          consistency: consistency || 85,\n          placement: myResult.finishPosition || participants.length,\n          totalParticipants: participants.length,\n          characters: chars,\n          errors: Math.round(chars * (1 - myResult.accuracy / 100)),\n          duration: (race as any)?.duration || 60,\n        });\n        \n        setShowFinishBanner(true);\n        setIsRacing(false);\n      }\n    }\n  }, [race?.status, myParticipant, participants, showFinishBanner]);\n\n  useEffect(() => {\n    if (!race || !myParticipant || myParticipant.isFinished) return;\n    \n    const progress = currentIndex / race.paragraphContent.length;\n    \n    if (progress >= extensionThreshold && !extensionRequestedRef.current) {\n      extensionRequestedRef.current = true;\n      sendWsMessage({\n        type: \"extend_paragraph\",\n        raceId: race.id,\n        participantId: myParticipant.id,\n      });\n    }\n    \n    if (currentIndex >= race.paragraphContent.length) {\n      finishRace();\n    }\n  }, [currentIndex, race, myParticipant]);\n\n  async function fetchRaceData() {\n    setLoadingMessage(\"Loading race...\");\n    setErrorState(null);\n    \n    try {\n      const response = await fetch(`/api/races/${params?.id}`);\n      \n      if (response.ok) {\n        const data = await response.json();\n        setRace(data.race);\n        setParticipants(data.participants);\n        setErrorState(null);\n        \n        if (myParticipant) {\n          const updatedParticipant = data.participants.find((p: Participant) => p.id === myParticipant.id);\n          if (updatedParticipant) {\n            setMyParticipant(updatedParticipant);\n          }\n        }\n      } else if (response.status === 404) {\n        setErrorState({\n          type: \"race_not_found\",\n          message: \"This race doesn't exist or has ended. The room code may have expired.\",\n          canRetry: false,\n        });\n      } else if (response.status === 409) {\n        const errorData = await response.json().catch(() => ({}));\n        if (errorData.code === \"RACE_FULL\") {\n          setErrorState({\n            type: \"race_full\",\n            message: \"This race room is full. Try joining another race or create a new one.\",\n            canRetry: false,\n          });\n        } else if (errorData.code === \"RACE_STARTED\") {\n          setErrorState({\n            type: \"race_started\",\n            message: \"This race has already started. You can join the next one.\",\n            canRetry: false,\n          });\n        } else {\n          setErrorState({\n            type: \"unknown\",\n            message: errorData.message || \"Unable to join this race.\",\n            canRetry: true,\n          });\n        }\n      } else {\n        setErrorState({\n          type: \"unknown\",\n          message: \"Something went wrong while loading the race. Please try again.\",\n          canRetry: true,\n        });\n      }\n    } catch (error) {\n      if (!isOnline) {\n        setErrorState({\n          type: \"network\",\n          message: \"You appear to be offline. Please check your internet connection and try again.\",\n          canRetry: true,\n        });\n      } else {\n        setErrorState({\n          type: \"network\",\n          message: \"Unable to connect to the server. Please check your connection and try again.\",\n          canRetry: true,\n        });\n      }\n    }\n  }\n\n  const attemptReconnect = useCallback(() => {\n    if (reconnectAttempts.current >= maxReconnectAttempts) {\n      setIsReconnecting(false);\n      toast.error(\"Unable to reconnect. Please refresh the page.\", {\n        duration: 10000,\n        action: {\n          label: \"Refresh\",\n          onClick: () => window.location.reload(),\n        },\n      });\n      return;\n    }\n\n    if (!isOnline) {\n      setIsReconnecting(false);\n      return;\n    }\n\n    setIsReconnecting(true);\n    reconnectAttempts.current += 1;\n    \n    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts.current - 1), 10000);\n    \n    reconnectTimeoutRef.current = setTimeout(() => {\n      console.log(`Reconnection attempt ${reconnectAttempts.current}/${maxReconnectAttempts}`);\n      connectWebSocket();\n    }, delay);\n  }, [isOnline]);\n\n  // Manual reconnect with reset\n  const manualReconnect = useCallback(() => {\n    if (reconnectTimeoutRef.current) {\n      clearTimeout(reconnectTimeoutRef.current);\n    }\n    reconnectAttempts.current = 0;\n    setIsReconnecting(true);\n    connectWebSocket();\n  }, []);\n\n  function connectWebSocket() {\n    if (!isOnline) {\n      console.log(\"Cannot connect WebSocket: offline\");\n      return;\n    }\n\n    const protocol = window.location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\n    const wsUrl = `${protocol}//${window.location.host}/ws/race`;\n    const socket = new WebSocket(wsUrl);\n\n    socket.onopen = () => {\n      console.log(\"WebSocket connected\");\n      setWs(socket);\n      setWsConnected(true);\n      setIsReconnecting(false);\n      reconnectAttempts.current = 0;\n      \n      while (pendingMessagesRef.current.length > 0) {\n        const message = pendingMessagesRef.current.shift();\n        if (message) {\n          socket.send(message);\n        }\n      }\n      \n      if (wasOffline) {\n        toast.success(\"Reconnected to race server\");\n      }\n    };\n\n    socket.onmessage = (event) => {\n      const message = JSON.parse(event.data);\n      handleWebSocketMessage(message);\n    };\n\n    socket.onerror = (error) => {\n      console.error(\"WebSocket error:\", error);\n      setWsConnected(false);\n    };\n\n    socket.onclose = (event) => {\n      console.log(\"WebSocket disconnected\", event.code, event.reason);\n      setWsConnected(false);\n      setWs(null);\n      hasJoinedRef.current = false;\n      \n      if (event.code !== 1000 && race?.status !== \"finished\") {\n        attemptReconnect();\n      }\n    };\n  }\n\n  function sendWsMessage(message: object) {\n    const messageStr = JSON.stringify(message);\n    \n    if (ws && ws.readyState === WebSocket.OPEN) {\n      ws.send(messageStr);\n    } else if (isOnline) {\n      pendingMessagesRef.current.push(messageStr);\n      if (!isReconnecting && ws?.readyState !== WebSocket.CONNECTING) {\n        attemptReconnect();\n      }\n    } else {\n      pendingMessagesRef.current.push(messageStr);\n    }\n  }\n\n  useEffect(() => {\n    if (isOnline && wasOffline && !wsConnected && !isReconnecting) {\n      reconnectAttempts.current = 0;\n      connectWebSocket();\n    }\n  }, [isOnline, wasOffline, wsConnected, isReconnecting]);\n\n  useEffect(() => {\n    return () => {\n      if (reconnectTimeoutRef.current) {\n        clearTimeout(reconnectTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  function handleWebSocketMessage(message: any) {\n    switch (message.type) {\n      case \"joined\":\n        setRace(message.race);\n        setParticipants(message.participants);\n        if (message.hostParticipantId) {\n          setHostParticipantId(message.hostParticipantId);\n        }\n        if (message.participants) {\n          message.participants.forEach((p: Participant) => {\n            seenParticipantJoinsRef.current.add(p.id);\n          });\n        }\n        // Handle joining a race that's already in progress\n        if (message.race.status === \"racing\") {\n          setIsRacing(true);\n          setStartTime(message.race.startedAt ? new Date(message.race.startedAt).getTime() : Date.now());\n          setCurrentIndex(0);\n          setErrors(0);\n          currentIndexRef.current = 0;\n          errorsRef.current = 0;\n          if (message.race.paragraphContent) {\n            setCharStates(new Array(message.race.paragraphContent.length).fill('pending'));\n          }\n        } else if (message.race.status === \"countdown\") {\n          setCountdown(3);\n        }\n        break;\n      case \"participant_joined\":\n        setParticipants(message.participants);\n        if (message.hostParticipantId) {\n          setHostParticipantId(message.hostParticipantId);\n        }\n        if (message.participant && !seenParticipantJoinsRef.current.has(message.participant.id)) {\n          seenParticipantJoinsRef.current.add(message.participant.id);\n          toast.success(`${message.participant.username} joined the race!`);\n        }\n        break;\n      case \"participants_sync\":\n        setParticipants(message.participants);\n        if (message.hostParticipantId) {\n          setHostParticipantId(message.hostParticipantId);\n        }\n        break;\n      case \"bots_added\":\n        fetchRaceData();\n        toast.info(\"More players joined!\", { duration: 2000 });\n        break;\n      case \"countdown_start\":\n        setIsStarting(false);\n        setIsTransitioning(false);\n        setCountdown(message.countdown);\n        if (message.participants) {\n          setParticipants(message.participants);\n        }\n        break;\n      case \"countdown\":\n        setCountdown(message.countdown);\n        break;\n      case \"race_start\":\n        setCountdown(null);\n        setIsRacing(true);\n        setStartTime(Date.now());\n        setCurrentIndex(0);\n        setErrors(0);\n        currentIndexRef.current = 0;\n        errorsRef.current = 0;\n        if (raceRef.current) {\n          setRace({ ...raceRef.current, status: \"racing\" });\n          setCharStates(new Array(raceRef.current.paragraphContent.length).fill('pending'));\n        }\n        toast.success(\"Race started! Type as fast as you can!\");\n        break;\n      case \"paragraph_extended\":\n        if (raceRef.current) {\n          const newContent = raceRef.current.paragraphContent + \" \" + message.additionalContent;\n          setRace({ ...raceRef.current, paragraphContent: newContent });\n          setCharStates(prev => {\n            const newStates = [...prev];\n            for (let i = prev.length; i < newContent.length; i++) {\n              newStates[i] = 'pending';\n            }\n            return newStates;\n          });\n          toast.info(\"More text added! Keep typing!\", { duration: 2000 });\n          extensionRequestedRef.current = false;\n        }\n        break;\n      case \"progress_update\":\n        setParticipants(prev => prev.map(p => \n          p.id === message.participantId \n            ? { ...p, progress: message.progress, wpm: message.wpm, accuracy: message.accuracy, errors: message.errors }\n            : p\n        ));\n        break;\n      case \"participant_finished\":\n        setParticipants(prev => prev.map(p => \n          p.id === message.participantId \n            ? { ...p, isFinished: 1, finishPosition: message.position }\n            : p\n        ));\n        break;\n      case \"race_finished\":\n        setIsRacing(false);\n        setParticipants(message.results);\n        if (raceRef.current) {\n          setRace({ ...raceRef.current, status: \"finished\" });\n        }\n        // Use ref to get current participant ID (avoids stale closure issues)\n        const currentParticipant = myParticipantRef.current;\n        const myResult = message.results.find((p: Participant) => p.id === currentParticipant?.id);\n        \n        // If myResult found, use server values; otherwise default to 100% accuracy for no typing\n        const finalWpm = myResult?.wpm ?? 0;\n        const finalAccuracy = myResult?.accuracy ?? 100;\n        const finalCharacters = myResult?.characters || finalWpm * 5;\n        const finalConsistency = Math.max(0, Math.min(100, Math.round(100 - ((finalCharacters - finalWpm * 5) / finalCharacters) * 100))) || 85;\n        \n        setFinishBannerData({\n          position: myResult?.finishPosition || null,\n          totalPlayers: message.results.length,\n          wpm: finalWpm,\n          accuracy: finalAccuracy,\n        });\n        \n        setLastResultSnapshot({\n          wpm: finalWpm,\n          accuracy: finalAccuracy,\n          consistency: finalConsistency,\n          placement: myResult?.finishPosition || message.results.length,\n          totalParticipants: message.results.length,\n          characters: finalCharacters,\n          errors: Math.round(finalCharacters * (1 - finalAccuracy / 100)),\n          duration: (raceRef.current as any)?.duration || 60,\n        });\n        \n        setShowFinishBanner(true);\n        \n        if (user) {\n          fetch(\"/api/ratings/me\")\n            .then(res => res.json())\n            .then(data => {\n              if (data.rating) {\n                setRatingInfo(data.rating);\n              }\n            })\n            .catch(err => console.error(\"Failed to fetch rating:\", err));\n        }\n        break;\n      case \"participant_left\":\n        setParticipants(prev => prev.filter(p => p.id !== message.participantId));\n        break;\n      case \"participant_dnf\":\n        // Mark participant as DNF (Did Not Finish)\n        setParticipants(prev => prev.map(p => \n          p.id === message.participantId \n            ? { ...p, isFinished: 1, finishPosition: 999 }\n            : p\n        ));\n        toast.info(`${message.username} left the race (DNF)`, { duration: 2000 });\n        break;\n      case \"chat_message\":\n        const chatData = message.message || message;\n        setChatMessages(prev => [...prev, {\n          id: chatData.id || Date.now(),\n          username: chatData.username,\n          avatarColor: chatData.avatarColor,\n          message: chatData.content || chatData.message,\n          isSystem: chatData.isSystem || false,\n          createdAt: chatData.createdAt || new Date().toISOString(),\n        }]);\n        break;\n      case \"rating_update\":\n        if (message.userId === user?.id) {\n          setRatingInfo({\n            rating: message.newRating,\n            tier: message.tier,\n            tierInfo: message.tierInfo,\n            ratingChange: message.ratingChange,\n          });\n        }\n        break;\n      case \"ready_state_update\":\n        // Update ready states for all participants\n        if (message.readyStates) {\n          const newReadyStates = new Map<number, boolean>();\n          for (const { participantId, isReady: ready } of message.readyStates) {\n            newReadyStates.set(participantId, ready);\n          }\n          setReadyStates(newReadyStates);\n          // Update our own ready state if it changed\n          if (myParticipantRef.current && message.participantId === myParticipantRef.current.id) {\n            setIsReady(message.isReady);\n          }\n        }\n        break;\n      case \"player_kicked\":\n        // Remove kicked player from participants\n        setParticipants(prev => prev.filter(p => p.id !== message.participantId));\n        setReadyStates(prev => {\n          const newStates = new Map(prev);\n          newStates.delete(message.participantId);\n          return newStates;\n        });\n        toast.info(`${message.username} was kicked from the room`, { duration: 3000 });\n        break;\n      case \"kicked\":\n        // We were kicked from the room\n        toast.error(message.message || \"You have been kicked from the room\", { duration: 5000 });\n        setLocation(\"/multiplayer\");\n        break;\n      case \"room_lock_changed\":\n        setIsRoomLocked(message.isLocked);\n        toast.info(message.isLocked ? \"Room is now locked\" : \"Room is now unlocked\", { duration: 2000 });\n        break;\n      case \"rematch_available\":\n        setRematchInfo({\n          newRaceId: message.newRaceId,\n          roomCode: message.roomCode,\n          createdBy: message.createdBy,\n        });\n        toast.success(`Rematch created! Room code: ${message.roomCode}`, { \n          duration: 10000,\n          action: {\n            label: \"Join\",\n            onClick: () => setLocation(`/race/${message.newRaceId}?code=${message.roomCode}`)\n          }\n        });\n        break;\n      case \"error\":\n        // Handle server-side errors with typed error codes\n        switch (message.code) {\n          case \"CHAT_RATE_LIMITED\":\n            toast.error(\"Slow down!\", { \n              description: message.message || \"Please wait before sending another message\",\n              duration: 2000\n            });\n            break;\n          case \"NOT_HOST\":\n            toast.error(\"Permission denied\", { \n              description: message.message || \"Only the host can do this\",\n              duration: 3000\n            });\n            break;\n          case \"NOT_ENOUGH_PLAYERS\":\n            toast.warning(\"Not enough players\", { \n              description: message.message || \"Need at least 2 players to start\",\n              duration: 4000\n            });\n            break;\n          case \"PLAYERS_NOT_READY\":\n            toast.warning(\"Players not ready\", { \n              description: message.message || \"All players must be ready to start\",\n              duration: 4000\n            });\n            break;\n          case \"ROOM_LOCKED\":\n            toast.error(\"Room locked\", { \n              description: message.message || \"This room is not accepting new players\",\n              duration: 3000\n            });\n            break;\n          case \"KICKED\":\n            toast.error(\"Kicked\", { \n              description: message.message || \"You have been kicked from the room\",\n              duration: 5000\n            });\n            setLocation(\"/multiplayer\");\n            break;\n          default:\n            if (message.message) {\n              toast.error(message.message, { duration: 3000 });\n            }\n            console.warn(\"Server error:\", message.code, message.message);\n        }\n        break;\n      case \"countdown_cancelled\":\n        // Countdown was cancelled (player left during countdown)\n        setCountdown(null);\n        setIsStarting(false);\n        toast.warning(\"Race cancelled\", { \n          description: message.reason || \"Not enough players to start\",\n          duration: 4000\n        });\n        break;\n      case \"host_changed\":\n        // Host was transferred to another player\n        if (message.newHostParticipantId) {\n          setHostParticipantId(message.newHostParticipantId);\n          if (myParticipantRef.current?.id === message.newHostParticipantId) {\n            toast.success(\"You are now the host!\", { duration: 3000 });\n          } else {\n            toast.info(message.message || `${message.newHostUsername || 'A player'} is now the host`, { duration: 3000 });\n          }\n        }\n        break;\n      case \"participant_disconnected\":\n        // A player disconnected (may reconnect)\n        setParticipants(prev => prev.map(p => \n          p.id === message.participantId \n            ? { ...p, isDisconnected: true } \n            : p\n        ));\n        if (message.username) {\n          toast.warning(`${message.username} disconnected`, { \n            description: \"They may reconnect...\",\n            duration: 3000\n          });\n        }\n        break;\n      case \"participant_reconnected\":\n        // A player reconnected after disconnection\n        setParticipants(prev => prev.map(p => \n          p.id === message.participantId \n            ? { ...p, isDisconnected: false } \n            : p\n        ));\n        if (message.username) {\n          toast.success(`${message.username} reconnected!`, { duration: 3000 });\n        }\n        break;\n    }\n  }\n\n\n  function updateProgress(progress: number, errorCount = errors) {\n    if (!myParticipant || !startTime || !race) return;\n\n    const elapsedSeconds = (Date.now() - startTime) / 1000;\n    const correctChars = Math.max(0, progress - errorCount);\n    const wpm = calculateWPM(correctChars, elapsedSeconds);\n    const accuracy = calculateAccuracy(correctChars, progress);\n\n    sendWsMessage({\n      type: \"progress\",\n      participantId: myParticipant.id,\n      progress,\n      wpm: wpm || 0,\n      accuracy,\n      errors: errorCount,\n    });\n\n    setMyParticipant(prev => prev ? { ...prev, progress, wpm: wpm || 0, accuracy, errors: errorCount } : null);\n  }\n\n  function finishRace() {\n    if (!myParticipant) return;\n\n    setIsRacing(false);\n    sendWsMessage({\n      type: \"finish\",\n      raceId: race?.id,\n      participantId: myParticipant.id,\n    });\n\n    setMyParticipant(prev => prev ? { ...prev, isFinished: 1 } : null);\n  }\n\n  function copyRoomCode() {\n    if (race) {\n      navigator.clipboard.writeText(race.roomCode);\n      setCopied(true);\n      toast.success(\"Room code copied!\");\n      setTimeout(() => setCopied(false), 2000);\n    }\n  }\n\n  function copyShareLink() {\n    if (race) {\n      const shareUrl = `${window.location.origin}/race/${race.id}?code=${race.roomCode}`;\n      navigator.clipboard.writeText(shareUrl);\n      setCopied(true);\n      toast.success(\"Invite link copied! Share it with friends.\");\n      setTimeout(() => setCopied(false), 2000);\n    }\n  }\n\n  function startRace() {\n    if (!participants.length || isStarting || isTransitioning) return;\n    \n    // Only the host can start the race\n    if (hostParticipantId && myParticipant?.id !== hostParticipantId) {\n      toast.error(\"Only the room host can start the race\");\n      return;\n    }\n    \n    setIsStarting(true);\n    setIsTransitioning(true);\n    setTransitionMessage(\"Preparing race...\");\n    sendWsMessage({\n      type: \"ready\",\n      raceId: race?.id,\n      participantId: myParticipant?.id,\n    });\n  }\n\n  function handleLeaveClick() {\n    // Show confirmation dialog if race is active (racing or countdown)\n    if (race && (race.status === \"racing\" || race.status === \"countdown\" || isRacing)) {\n      setShowLeaveConfirmation(true);\n    } else {\n      // For waiting or finished races, leave immediately\n      confirmLeaveRace();\n    }\n  }\n  \n  function confirmLeaveRace() {\n    setIsLeaving(true);\n    setShowLeaveConfirmation(false);\n    \n    try {\n      if (myParticipant && race) {\n        // Send leave with current progress for DNF tracking\n        sendWsMessage({\n          type: \"leave\",\n          raceId: race.id,\n          participantId: myParticipant.id,\n          isRacing: isRacing || race.status === \"racing\",\n          progress: currentIndex,\n          wpm: liveWpm,\n          accuracy: liveAccuracy,\n        });\n        \n        // Clean up local storage\n        localStorage.removeItem(`race_${race.id}_participant`);\n        localStorage.removeItem(`race_${race.roomCode}_participant`);\n        \n        toast.info(\"You left the race\", { duration: 2000 });\n      } else {\n        // Edge case: race or participant data missing\n        console.warn(\"[Leave Race] Missing race or participant data\");\n        toast.warning(\"Leaving race...\", { duration: 1500 });\n      }\n    } catch (error) {\n      console.error(\"[Leave Race] Error leaving race:\", error);\n      toast.error(\"Failed to leave race properly. Redirecting...\", { duration: 2000 });\n    } finally {\n      // Always redirect to multiplayer, even if there was an error\n      setTimeout(() => {\n        setLocation(\"/multiplayer\");\n      }, 100);\n    }\n  }\n  \n  function cancelLeaveRace() {\n    setShowLeaveConfirmation(false);\n  }\n\n  // Handle error state\n  if (errorState) {\n    return (\n      <RaceErrorDisplay\n        error={errorState}\n        onRetry={errorState.canRetry ? fetchRaceData : undefined}\n        onGoBack={() => setLocation(\"/multiplayer\")}\n      />\n    );\n  }\n\n  // Handle loading state\n  if (!race) {\n    return (\n      <RaceLoadingDisplay \n        message={loadingMessage}\n        subMessage=\"Connecting to race server...\"\n      />\n    );\n  }\n\n  // Handle transition state (starting race) - but not if countdown has started\n  if (isTransitioning && countdown === null) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-background\">\n        <div className=\"text-center space-y-6\">\n          <div className=\"relative\">\n            <div className=\"h-20 w-20 mx-auto rounded-full border-4 border-primary/20 border-t-primary animate-spin\" />\n            <div className=\"absolute inset-0 flex items-center justify-center\">\n              <Zap className=\"h-8 w-8 text-primary animate-pulse\" />\n            </div>\n          </div>\n          <div>\n            <p className=\"text-2xl font-bold\">{transitionMessage}</p>\n            <p className=\"text-muted-foreground mt-2\">Get ready to type!</p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // Handle countdown state - check this BEFORE waiting room\n  if (countdown !== null || race.status === \"countdown\") {\n    return (\n      <TooltipProvider delayDuration={300}>\n        <div className=\"min-h-screen flex items-center justify-center bg-background\">\n          <div className=\"text-center space-y-6\">\n            {/* Preparation tip with tooltip */}\n            <div className=\"flex items-center justify-center gap-2 text-muted-foreground\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"flex items-center gap-2 cursor-help bg-muted/30 px-4 py-2 rounded-full\">\n                    <Info className=\"h-4 w-4\" />\n                    <span className=\"text-sm\">Get ready to type!</span>\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\" className=\"max-w-xs\">\n                  <p className=\"font-medium\">Preparation Tips</p>\n                  <ul className=\"text-zinc-400 text-sm list-disc list-inside mt-1\">\n                    <li>Position your fingers on the home row</li>\n                    <li>Focus on the first few words</li>\n                    <li>Race begins automatically when timer hits zero</li>\n                  </ul>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n            \n            {/* Countdown number */}\n            <div className=\"text-9xl font-bold text-primary animate-pulse\" data-testid=\"countdown-number\">\n              {countdown === 0 ? \"GO!\" : countdown ?? \"...\"}\n            </div>\n            \n            {/* Dynamic instruction */}\n            {countdown === null || countdown > 0 ? (\n              <p className=\"text-muted-foreground text-lg flex items-center justify-center gap-2\">\n                <Sparkles className=\"h-5 w-5\" />\n                Position your fingers on the keyboard!\n              </p>\n            ) : (\n              <p className=\"text-green-500 text-lg font-medium flex items-center justify-center gap-2\">\n                <Play className=\"h-5 w-5\" />\n                Start typing now!\n              </p>\n            )}\n          </div>\n        </div>\n      </TooltipProvider>\n    );\n  }\n\n  if (race.status === \"waiting\") {\n    return (\n      <TooltipProvider delayDuration={300}>\n        <div className=\"min-h-screen bg-background\">\n          <div className=\"container max-w-4xl mx-auto px-4 py-8\">\n            <div className=\"flex items-center gap-4 mb-4\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={handleLeaveClick}\n                    data-testid=\"button-leave-race\"\n                  >\n                    <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                    Back to Lobby\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\">\n                  <p>Leave the race and return to multiplayer lobby</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n            <Card>\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      Waiting for Players\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Info className=\"h-4 w-4 text-muted-foreground cursor-help\" />\n                        </TooltipTrigger>\n                        <TooltipContent side=\"right\" className=\"max-w-xs\">\n                          <p className=\"font-medium\">Waiting Room</p>\n                          <p className=\"text-zinc-400\">Share your room code with friends to invite them to race!</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </CardTitle>\n                    <CardDescription>Share the room code with friends</CardDescription>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Button\n                          variant=\"outline\"\n                          onClick={copyRoomCode}\n                          data-testid=\"button-copy-code\"\n                          className=\"font-mono\"\n                        >\n                          {copied ? <Check className=\"h-4 w-4 mr-2 text-green-500\" /> : <Share2 className=\"h-4 w-4 mr-2\" />}\n                          {race.roomCode}\n                        </Button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"bottom\">\n                        <p className=\"font-medium\">{copied ? \"Copied!\" : \"Click to copy room code\"}</p>\n                        <p className=\"text-zinc-400\">Share this code with friends to let them join</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                </div>\n                \n                {/* Room Settings Display */}\n                <div className=\"flex items-center gap-4 mt-3 pt-3 border-t\">\n                  <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                    <Timer className=\"h-4 w-4\" />\n                    <span>{race.timeLimitSeconds ? `${race.timeLimitSeconds}s race` : 'Untimed'}</span>\n                  </div>\n                  <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n                    <Users className=\"h-4 w-4\" />\n                    <span>{race.maxPlayers} players max</span>\n                  </div>\n                </div>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                <div>\n                  <div className=\"flex items-center gap-2 mb-3\">\n                    <h3 className=\"text-sm font-medium\">\n                      Players ({participants.length}/{race.maxPlayers})\n                    </h3>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Info className=\"h-3.5 w-3.5 text-muted-foreground cursor-help\" />\n                      </TooltipTrigger>\n                      <TooltipContent side=\"right\">\n                        <p>{race.maxPlayers - participants.length} slot{race.maxPlayers - participants.length !== 1 ? 's' : ''} available</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                  <div className=\"grid gap-2\">\n                    {participants.length === 0 ? (\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <div className=\"text-center py-6 text-muted-foreground cursor-help border-2 border-dashed border-muted rounded-lg\">\n                            <Users className=\"h-10 w-10 mx-auto mb-2 opacity-30\" />\n                            <p className=\"text-sm font-medium\">Waiting for players to join...</p>\n                            <p className=\"text-xs mt-1 opacity-70\">Share the room code to invite friends</p>\n                          </div>\n                        </TooltipTrigger>\n                        <TooltipContent side=\"bottom\" className=\"max-w-xs\">\n                          <p className=\"font-medium\">Invite Players</p>\n                          <p className=\"text-zinc-400\">\n                            Share the room code with friends to invite them.\n                          </p>\n                        </TooltipContent>\n                      </Tooltip>\n                    ) : (\n                      participants.map((p) => {\n                        const playerReady = readyStates.get(p.id) ?? (p.id === hostParticipantId);\n                        return (\n                          <div\n                            key={p.id}\n                            className={`flex items-center gap-3 p-3 border rounded-lg transition-colors ${\n                              p.id === myParticipant?.id ? 'border-primary/50 bg-primary/5' : ''\n                            } ${p.id === hostParticipantId ? 'border-yellow-500/50' : ''\n                            } ${playerReady ? 'bg-green-500/5' : ''}`}\n                            data-testid={`participant-${p.id}`}\n                          >\n                            <div className={`h-10 w-10 rounded-full ${p.avatarColor || 'bg-primary'} flex items-center justify-center text-white font-medium relative`}>\n                              {p.username[0].toUpperCase()}\n                              {p.id === hostParticipantId && (\n                                <div className=\"absolute -top-1 -right-1 bg-yellow-500 rounded-full p-0.5\">\n                                  <Trophy className=\"h-3 w-3 text-white\" />\n                                </div>\n                              )}\n                              {playerReady && p.id !== hostParticipantId && (\n                                <div className=\"absolute -bottom-1 -right-1 bg-green-500 rounded-full p-0.5\">\n                                  <Check className=\"h-3 w-3 text-white\" />\n                                </div>\n                              )}\n                            </div>\n                            <div className=\"flex-1 min-w-0\">\n                              <div className=\"font-medium flex items-center gap-2 flex-wrap\">\n                                <span className=\"truncate\">{p.username}</span>\n                                {p.id === hostParticipantId && (\n                                  <Badge variant=\"outline\" className=\"text-xs px-1.5 py-0 border-yellow-500 text-yellow-500 shrink-0\">\n                                    Host\n                                  </Badge>\n                                )}\n                                {playerReady && (\n                                  <Badge variant=\"outline\" className=\"text-xs px-1.5 py-0 border-green-500 text-green-500 shrink-0\">\n                                    Ready\n                                  </Badge>\n                                )}\n                              </div>\n                              {p.id === myParticipant?.id && (\n                                <div className=\"text-xs text-primary flex items-center gap-1\">\n                                  <User className=\"h-3 w-3\" />\n                                  You\n                                </div>\n                              )}\n                            </div>\n                            {/* Kick button - only visible to host for other players */}\n                            {myParticipant?.id === hostParticipantId && p.id !== myParticipant?.id && (\n                              <Tooltip>\n                                <TooltipTrigger asChild>\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    className=\"h-8 w-8 p-0 text-red-400 hover:text-red-300 hover:bg-red-500/10\"\n                                    onClick={() => {\n                                      sendWsMessage({\n                                        type: \"kick_player\",\n                                        raceId: race.id,\n                                        participantId: myParticipant.id,\n                                        targetParticipantId: p.id,\n                                      });\n                                    }}\n                                    data-testid={`kick-player-${p.id}`}\n                                  >\n                                    <XCircle className=\"h-4 w-4\" />\n                                  </Button>\n                                </TooltipTrigger>\n                                <TooltipContent>\n                                  <p>Kick {p.username}</p>\n                                </TooltipContent>\n                              </Tooltip>\n                            )}\n                          </div>\n                        );\n                      })\n                    )}\n                  </div>\n                </div>\n\n                {myParticipant && (\n                  <RaceChat\n                    raceId={race.id}\n                    participantId={myParticipant.id}\n                    username={myParticipant.username}\n                    avatarColor={myParticipant.avatarColor}\n                    sendWsMessage={sendWsMessage}\n                    messages={chatMessages}\n                    isEnabled={true}\n                    wsConnected={wsConnected}\n                  />\n                )}\n\n                {/* Host controls: Lock room toggle */}\n                {myParticipant?.id === hostParticipantId && (\n                  <div className=\"flex items-center justify-between p-3 bg-muted/30 rounded-lg\">\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <div className=\"flex items-center gap-2 text-sm cursor-help\">\n                          <Lock className=\"h-4 w-4\" />\n                          <span>Lock Room</span>\n                          <Info className=\"h-3 w-3 text-muted-foreground\" />\n                        </div>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"top\" className=\"max-w-[250px]\">\n                        <p>When locked, no new players can join the room. Use this once all your friends have joined to prevent strangers from entering.</p>\n                      </TooltipContent>\n                    </Tooltip>\n                    <Button\n                      variant={isRoomLocked ? \"default\" : \"outline\"}\n                      size=\"sm\"\n                      onClick={() => {\n                        sendWsMessage({\n                          type: \"lock_room\",\n                          raceId: race.id,\n                          participantId: myParticipant.id,\n                          locked: !isRoomLocked,\n                        });\n                      }}\n                      data-testid=\"button-lock-room\"\n                    >\n                      {isRoomLocked ? \"Unlock\" : \"Lock\"}\n                    </Button>\n                  </div>\n                )}\n\n                {/* Show Start Race button only for the host, or show waiting message for others */}\n                {/* Minimum 2 players required - like TypeRacer and other real typing race sites */}\n                {(!hostParticipantId || myParticipant?.id === hostParticipantId) ? (\n                  <div className=\"space-y-2\">\n                    {participants.length < 2 && (\n                      <div className=\"flex items-center justify-center gap-2 p-3 bg-muted/50 rounded-lg text-sm text-muted-foreground\">\n                        <Users className=\"h-4 w-4\" />\n                        <span>Waiting for at least 1 more player to join...</span>\n                      </div>\n                    )}\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Button\n                          onClick={startRace}\n                          disabled={participants.length < 2 || isStarting}\n                          size=\"lg\"\n                          className=\"w-full\"\n                          data-testid=\"button-start-race\"\n                        >\n                          {isStarting ? (\n                            <>\n                              <div className=\"h-4 w-4 mr-2 animate-spin rounded-full border-2 border-current border-t-transparent\" />\n                              Starting...\n                            </>\n                          ) : (\n                            <>\n                              <Play className=\"h-4 w-4 mr-2\" />\n                              {participants.length < 2 \n                                ? `Start Race (Need ${2 - participants.length} more)` \n                                : 'Start Race'}\n                            </>\n                          )}\n                        </Button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"bottom\">\n                        {participants.length < 2 ? (\n                          <>\n                            <p className=\"font-medium\">Need more players</p>\n                            <p className=\"text-zinc-400\">Share the room code with friends to start racing!</p>\n                          </>\n                        ) : (\n                          <>\n                            <p className=\"font-medium\">Begin the race</p>\n                            <p className=\"text-zinc-400\">A countdown will start and the race begins!</p>\n                          </>\n                        )}\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                ) : (\n                  <div className=\"w-full py-3 px-4 bg-muted/50 rounded-lg text-center text-muted-foreground\">\n                    <div className=\"flex items-center justify-center gap-2\">\n                      <Loader2 className=\"h-4 w-4 animate-spin\" />\n                      <span>Waiting for host to start the race...</span>\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </TooltipProvider>\n    );\n  }\n\n  if (race.status === \"racing\" || isRacing) {\n    return (\n      <TooltipProvider delayDuration={300}>\n        {/* Leave Race Confirmation Dialog */}\n        <AlertDialog open={showLeaveConfirmation} onOpenChange={setShowLeaveConfirmation}>\n          <AlertDialogContent>\n            <AlertDialogHeader>\n              <AlertDialogTitle className=\"flex items-center gap-2\">\n                <AlertTriangle className=\"h-5 w-5 text-yellow-500\" />\n                Are you sure you want to leave?\n              </AlertDialogTitle>\n              <AlertDialogDescription asChild>\n                <div className=\"space-y-3\">\n                  <p>You're in the middle of an active race. If you leave now:</p>\n                  <ul className=\"list-disc list-inside text-sm space-y-1 text-muted-foreground\">\n                    <li>You'll be marked as <strong>DNF</strong> (Did Not Finish)</li>\n                    <li>Your current progress won't be saved</li>\n                    <li>Any rating changes will be forfeited</li>\n                  </ul>\n                  <p className=\"text-sm font-medium text-muted-foreground mt-2\">\n                    Current progress: {currentIndex} characters typed\n                  </p>\n                </div>\n              </AlertDialogDescription>\n            </AlertDialogHeader>\n            <AlertDialogFooter>\n              <AlertDialogCancel onClick={cancelLeaveRace}>\n                Keep Racing\n              </AlertDialogCancel>\n              <AlertDialogAction \n                onClick={confirmLeaveRace}\n                className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              >\n                Yes, Leave Race\n              </AlertDialogAction>\n            </AlertDialogFooter>\n          </AlertDialogContent>\n        </AlertDialog>\n        \n        <div className=\"min-h-screen bg-background\">\n          <div className=\"container max-w-6xl mx-auto px-4 py-8\">\n            {/* Network status banner */}\n            <NetworkStatusBanner\n              isConnected={wsConnected}\n              isReconnecting={isReconnecting}\n              reconnectAttempt={reconnectAttempts.current}\n              maxAttempts={maxReconnectAttempts}\n              onManualRetry={manualReconnect}\n            />\n            \n            <div className=\"flex items-center justify-between mb-4\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={handleLeaveClick}\n                    disabled={isLeaving}\n                    className=\"hover:bg-destructive/10 hover:text-destructive hover:border-destructive/50\"\n                    data-testid=\"button-leave-race\"\n                  >\n                    {isLeaving ? (\n                      <>\n                        <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                        Leaving...\n                      </>\n                    ) : (\n                      <>\n                        <LogOut className=\"h-4 w-4 mr-2\" />\n                        Leave Race\n                      </>\n                    )}\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\" className=\"max-w-[200px]\">\n                  <p className=\"font-medium\">Click to leave race</p>\n                  <p className=\"text-zinc-400 text-xs\">You'll be asked to confirm. Leaving marks you as DNF (Did Not Finish).</p>\n                </TooltipContent>\n              </Tooltip>\n              \n            </div>\n            <div className=\"space-y-6\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center gap-2\">\n                      <Flag className=\"h-5 w-5 text-primary\" />\n                      {race.raceType === \"timed\" ? \"Timed Race\" : \"Live Race Progress\"}\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Info className=\"h-4 w-4 text-muted-foreground cursor-help\" />\n                        </TooltipTrigger>\n                        <TooltipContent side=\"right\" className=\"max-w-xs\">\n                          <p className=\"font-medium\">Real-time Leaderboard</p>\n                          <p className=\"text-zinc-400\">\n                            {race.raceType === \"timed\" \n                              ? \"Type as much as you can before time runs out!\" \n                              : \"Track all racers' progress, speed, and accuracy as they type\"}\n                          </p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </div>\n                    {race.raceType === \"timed\" && timeRemaining !== null && (\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <div className={`flex items-center gap-2 px-4 py-2 rounded-lg font-mono text-lg cursor-help ${\n                            timeRemaining <= 10 \n                              ? 'bg-red-500/20 text-red-400 animate-pulse' \n                              : timeRemaining <= 30 \n                                ? 'bg-yellow-500/20 text-yellow-400' \n                                : 'bg-primary/20 text-primary'\n                          }`}>\n                            <Timer className=\"h-5 w-5\" />\n                            <span data-testid=\"time-remaining\">\n                              {Math.floor(timeRemaining / 60)}:{String(Math.floor(timeRemaining % 60)).padStart(2, '0')}\n                            </span>\n                          </div>\n                        </TooltipTrigger>\n                        <TooltipContent side=\"bottom\">\n                          <p className=\"font-medium\">Time Remaining</p>\n                          <p className=\"text-zinc-400\">\n                            {timeRemaining <= 10 \n                              ? \"Hurry! Almost out of time!\" \n                              : \"Keep typing to maximize your WPM!\"}\n                          </p>\n                        </TooltipContent>\n                      </Tooltip>\n                    )}\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-4\">\n                    {participants\n                      .sort((a, b) => b.progress - a.progress)\n                      .map((p) => {\n                        const progressPercent = (p.progress / race.paragraphContent.length) * 100;\n                        return (\n                          <div key={p.id} className=\"space-y-2\" data-testid={`progress-${p.id}`}>\n                            <div className=\"flex items-center justify-between text-sm\">\n                              <div className=\"flex items-center gap-2\">\n                                <Tooltip>\n                                  <TooltipTrigger asChild>\n                                    <div className={`h-6 w-6 rounded-full ${p.avatarColor || 'bg-primary'} flex items-center justify-center text-white text-xs cursor-help relative`}>\n                                      {p.username[0].toUpperCase()}\n                                    </div>\n                                  </TooltipTrigger>\n                                  <TooltipContent side=\"left\">\n                                    <p className=\"font-medium\">{p.username}</p>\n                                    <p className=\"text-zinc-400\">{p.id === myParticipant?.id ? \"You\" : \"Racer\"}</p>\n                                  </TooltipContent>\n                                </Tooltip>\n                                <span className=\"font-medium\">{p.username}</span>\n                                {p.id === myParticipant?.id && (\n                                  <span className=\"text-xs text-primary\">(You)</span>\n                                )}\n                                {p.isFinished === 1 && p.finishPosition && (\n                                  <Tooltip>\n                                    <TooltipTrigger asChild>\n                                      <span className=\"text-xs font-semibold text-yellow-500 cursor-help\" data-testid={`text-position-${p.id}`}>\n                                        {p.finishPosition === 1 ? 'ðŸ¥‡ 1st' : p.finishPosition === 2 ? 'ðŸ¥ˆ 2nd' : p.finishPosition === 3 ? 'ðŸ¥‰ 3rd' : `#${p.finishPosition}`}\n                                      </span>\n                                    </TooltipTrigger>\n                                    <TooltipContent side=\"right\">\n                                      <p className=\"font-medium\">Finished #{p.finishPosition}</p>\n                                      <p className=\"text-zinc-400\">{p.username} completed the race!</p>\n                                    </TooltipContent>\n                                  </Tooltip>\n                                )}\n                              </div>\n                              <div className=\"flex items-center gap-4\">\n                                <Tooltip>\n                                  <TooltipTrigger asChild>\n                                    <span className=\"flex items-center gap-1 cursor-help\">\n                                      <Gauge className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                                      {p.wpm} WPM\n                                    </span>\n                                  </TooltipTrigger>\n                                  <TooltipContent side=\"bottom\">\n                                    <p className=\"font-medium\">Words Per Minute</p>\n                                    <p className=\"text-zinc-400\">Typing speed measured in words per minute</p>\n                                  </TooltipContent>\n                                </Tooltip>\n                                <Tooltip>\n                                  <TooltipTrigger asChild>\n                                    <span className=\"flex items-center gap-1 cursor-help\">\n                                      <Target className=\"h-3.5 w-3.5 text-muted-foreground\" />\n                                      {p.accuracy}%\n                                    </span>\n                                  </TooltipTrigger>\n                                  <TooltipContent side=\"bottom\">\n                                    <p className=\"font-medium\">Accuracy</p>\n                                    <p className=\"text-zinc-400\">Percentage of characters typed correctly</p>\n                                  </TooltipContent>\n                                </Tooltip>\n                              </div>\n                            </div>\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <div className=\"cursor-help\">\n                                  <Progress value={progressPercent} className=\"h-3\" />\n                                </div>\n                              </TooltipTrigger>\n                              <TooltipContent side=\"bottom\">\n                                <p className=\"font-medium\">{Math.round(progressPercent)}% complete</p>\n                                <p className=\"text-zinc-400\">{p.progress} of {race.paragraphContent.length} characters</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          </div>\n                        );\n                      })}\n                  </div>\n                </CardContent>\n              </Card>\n\n              <div \n                className={`cursor-text transition-all duration-200 rounded-lg ${\n                  isFocused \n                    ? 'ring-2 ring-primary/50 ring-offset-2 ring-offset-background' \n                    : ''\n                }`}\n                onClick={() => hiddenInputRef.current?.focus()}\n                role=\"application\"\n                aria-label=\"Typing test area\"\n              >\n                {!isFocused && (\n                  <div className=\"flex items-center justify-center gap-2 text-muted-foreground animate-pulse py-3\">\n                    <Info className=\"h-4 w-4\" />\n                    <span className=\"text-sm\">Click here or press any key to focus</span>\n                  </div>\n                )}\n                \n                <div>\n                  <div \n                    ref={textContainerRef}\n                    className=\"text-xl leading-[2] font-mono select-none max-h-[280px] overflow-y-auto scroll-smooth p-8 bg-zinc-900 rounded-lg whitespace-pre-wrap break-words\" \n                    data-testid=\"text-paragraph\"\n                    role=\"textbox\"\n                    aria-readonly=\"true\"\n                    aria-label=\"Text to type\"\n                    aria-describedby=\"typing-instructions\"\n                  >\n                    {(() => {\n                      const text = race.paragraphContent;\n                      const words = text.split(/(\\s+)/);\n                      let charIndex = 0;\n                      \n                      const findCurrentWordBounds = () => {\n                        let start = 0;\n                        for (const word of words) {\n                          const end = start + word.length;\n                          if (currentIndex >= start && currentIndex < end) {\n                            return { start, end };\n                          }\n                          start = end;\n                        }\n                        return { start: 0, end: text.length };\n                      };\n                      \n                      const currentWordBounds = findCurrentWordBounds();\n                      \n                      return words.map((word, wordIdx) => {\n                        const wordStartIdx = charIndex;\n                        const isCurrentWord = currentIndex >= wordStartIdx && currentIndex < wordStartIdx + word.length;\n                        const isCompletedWord = currentIndex >= wordStartIdx + word.length;\n                        const isPureSpace = /^\\s+$/.test(word);\n                        \n                        const renderedChars = word.split('').map((char, charIdx) => {\n                          const idx = charIndex;\n                          charIndex++;\n                          \n                          const state = charStates[idx] || 'pending';\n                          const isCurrent = idx === currentIndex;\n                          const isSpace = char === ' ';\n                          \n                          let className = 'transition-colors duration-75 ';\n                          \n                          if (state === 'correct') {\n                            className += 'text-zinc-100';\n                          } else if (state === 'incorrect') {\n                            className += 'text-red-500 bg-red-500/20 rounded-sm';\n                            if (isSpace) {\n                              className += ' border-b-2 border-red-500';\n                            }\n                          } else if (isCurrent) {\n                            className += 'text-zinc-500';\n                          } else if (isCurrentWord && !isPureSpace) {\n                            className += 'text-zinc-500';\n                          } else {\n                            className += 'text-zinc-600';\n                          }\n                          \n                          if (isCurrent) {\n                            return (\n                              <span \n                                key={idx} \n                                ref={caretRef}\n                                className={`${className} relative`}\n                              >\n                                <span \n                                  className={`absolute left-0 top-0 w-[2px] h-full bg-yellow-400 transition-all duration-100 ${\n                                    isFocused ? 'animate-caret-smooth' : 'opacity-50'\n                                  }`}\n                                />\n                                {isSpace ? '\\u00A0' : char}\n                              </span>\n                            );\n                          }\n                          \n                          return (\n                            <span \n                              key={idx} \n                              className={className}\n                            >\n                              {isSpace ? '\\u00A0' : char}\n                            </span>\n                          );\n                        });\n                        \n                        if (isPureSpace) {\n                          return <span key={`word-${wordIdx}`}>{renderedChars}</span>;\n                        }\n                        \n                        return (\n                          <span key={`word-${wordIdx}`}>\n                            {renderedChars}\n                          </span>\n                        );\n                      });\n                    })()}\n                  </div>\n                  \n                  <div id=\"typing-instructions\" className=\"sr-only\">\n                    Type the text shown above. Use backspace to correct mistakes. Your progress is tracked in real-time.\n                  </div>\n                  \n                  <input\n                    ref={hiddenInputRef}\n                    type=\"text\"\n                    onInput={handleTyping}\n                    onKeyDown={handleKeyDown}\n                    onFocus={handleFocus}\n                    onBlur={handleBlur}\n                    onCompositionStart={handleCompositionStart}\n                    onCompositionEnd={handleCompositionEnd}\n                    onPaste={handlePaste}\n                    onCut={handleCut}\n                    className=\"absolute inset-0 opacity-0 w-full h-full cursor-text\"\n                    autoComplete=\"off\"\n                    autoCorrect=\"off\"\n                    autoCapitalize=\"off\"\n                    spellCheck=\"false\"\n                    data-testid=\"input-typing\"\n                    aria-label=\"Typing input for race\"\n                    aria-describedby=\"typing-instructions\"\n                  />\n                </div>\n              </div>\n              \n              {/* Chat is hidden during active racing to minimize distractions */}\n            </div>\n          </div>\n        </div>\n      </TooltipProvider>\n    );\n  }\n\n  if (race.status === \"finished\") {\n    const sortedParticipants = [...participants].sort((a, b) => (a.finishPosition || 999) - (b.finishPosition || 999));\n    const myResult = sortedParticipants.find(p => p.id === myParticipant?.id);\n    const myPosition = myResult ? sortedParticipants.indexOf(myResult) + 1 : null;\n\n    return (\n      <TooltipProvider delayDuration={300}>\n        {showFinishBanner && finishBannerData && (\n          <RaceFinishBanner\n            position={finishBannerData.position}\n            totalPlayers={finishBannerData.totalPlayers}\n            wpm={finishBannerData.wpm}\n            accuracy={finishBannerData.accuracy}\n            isWinner={finishBannerData.position === 1}\n            onDismiss={() => {\n              finishBannerDismissedRef.current = true;\n              setShowFinishBanner(false);\n            }}\n          />\n        )}\n        <div className=\"min-h-screen bg-background\">\n          <div className=\"container max-w-4xl mx-auto px-4 py-8\">\n            <div className=\"flex items-center gap-4 mb-4\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => setLocation(\"/multiplayer\")}\n                    data-testid=\"button-back-to-lobby\"\n                  >\n                    <ArrowLeft className=\"h-4 w-4 mr-2\" />\n                    Back to Lobby\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\">\n                  <p>Return to multiplayer lobby</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Trophy className=\"h-6 w-6 text-yellow-500\" />\n                  Race Results\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Info className=\"h-4 w-4 text-muted-foreground cursor-help\" />\n                    </TooltipTrigger>\n                    <TooltipContent side=\"right\" className=\"max-w-xs\">\n                      <p className=\"font-medium\">Final Standings</p>\n                      <p className=\"text-zinc-400\">\n                        {myPosition === 1 \n                          ? \"Congratulations! You won the race!\" \n                          : myPosition \n                            ? `You finished in position #${myPosition}` \n                            : \"Race complete - see final standings below\"}\n                      </p>\n                      <div className=\"pt-2 border-t border-zinc-700 mt-2\">\n                        <p className=\"text-xs font-medium text-zinc-300\">Tie-breaking rules:</p>\n                        <ol className=\"text-xs text-zinc-400 list-decimal list-inside\">\n                          <li>Higher WPM wins</li>\n                          <li>If tied: Higher accuracy wins</li>\n                          <li>If still tied: More characters typed wins</li>\n                          <li>Final tie: Who joined first wins</li>\n                        </ol>\n                      </div>\n                    </TooltipContent>\n                  </Tooltip>\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                {myResult && lastResultSnapshot && (\n                  <div className=\"flex justify-center\">\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Button\n                          onClick={() => setShareDialogOpen(true)}\n                          className=\"gap-2\"\n                          data-testid=\"button-share-race-results\"\n                        >\n                          <Share2 className=\"w-4 h-4\" />\n                          Share Race Certificate\n                        </Button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"bottom\">\n                        <p className=\"text-xs\">Share your race achievement with professional certificate</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                )}\n                \n                <div className=\"space-y-3\">\n                  {sortedParticipants.map((p, idx) => {\n                    const isParticipantBot = p.isBot === 1 || p.isBot === true;\n                    const tierColor = p.tierInfo?.color || 'gray';\n                    return (\n                      <Tooltip key={p.id}>\n                        <TooltipTrigger asChild>\n                          <div\n                            className={`flex items-center gap-4 p-4 border rounded-lg cursor-default transition-colors hover:border-primary/30 ${\n                              p.id === myParticipant?.id ? 'border-primary bg-primary/5' : ''\n                            }`}\n                            data-testid={`result-${p.id}`}\n                          >\n                            <div className=\"text-2xl font-bold w-12 text-center\">\n                              {idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : idx === 2 ? 'ðŸ¥‰' : `#${idx + 1}`}\n                            </div>\n                            <div className={`h-12 w-12 rounded-full ${p.avatarColor || 'bg-primary'} flex items-center justify-center text-white font-medium`}>\n                              {p.username[0].toUpperCase()}\n                            </div>\n                            <div className=\"flex-1 min-w-0\">\n                              <div className=\"font-medium flex items-center gap-2 flex-wrap\">\n                                <span className=\"truncate\">{p.username}</span>\n                                {!isParticipantBot && p.tier && (\n                                  <Badge\n                                    variant=\"outline\"\n                                    className=\"text-[10px] px-1.5 py-0 capitalize\"\n                                    style={{ borderColor: tierColor, color: tierColor }}\n                                    data-testid={`tier-badge-${p.id}`}\n                                  >\n                                    {p.tierInfo?.name || p.tier}\n                                  </Badge>\n                                )}\n                              </div>\n                              <div className=\"text-xs text-muted-foreground flex items-center gap-2 flex-wrap\">\n                                {p.id === myParticipant?.id && (\n                                  <span className=\"text-primary flex items-center gap-1\">\n                                    <User className=\"h-3 w-3\" />\n                                    You\n                                  </span>\n                                )}\n                                {!isParticipantBot && p.rating !== null && p.rating !== undefined && (\n                                  <span data-testid={`rating-${p.id}`} className=\"flex items-center gap-1\">\n                                    <Award className=\"h-3 w-3\" />\n                                    {p.rating}\n                                  </span>\n                                )}\n                              </div>\n                            </div>\n                            <div className=\"text-right\">\n                              <div className=\"text-xl font-bold flex items-center justify-end gap-1\">\n                                <Gauge className=\"h-4 w-4 text-muted-foreground\" />\n                                {p.wpm} WPM\n                                {/* Show tie indicator if same WPM as adjacent player */}\n                                {(\n                                  (idx > 0 && sortedParticipants[idx - 1].wpm === p.wpm) ||\n                                  (idx < sortedParticipants.length - 1 && sortedParticipants[idx + 1].wpm === p.wpm)\n                                ) && (\n                                  <Tooltip>\n                                    <TooltipTrigger asChild>\n                                      <span className=\"text-xs text-yellow-500 ml-1 cursor-help\">âš¡</span>\n                                    </TooltipTrigger>\n                                    <TooltipContent side=\"left\" className=\"max-w-[200px]\">\n                                      <p className=\"text-xs\">Tie decided by: accuracy â†’ characters typed â†’ join order</p>\n                                    </TooltipContent>\n                                  </Tooltip>\n                                )}\n                              </div>\n                              <div className=\"text-sm text-muted-foreground flex items-center justify-end gap-1\">\n                                <Target className=\"h-3 w-3\" />\n                                {p.accuracy}% Accuracy\n                              </div>\n                            </div>\n                          </div>\n                        </TooltipTrigger>\n                        <TooltipContent side=\"left\" className=\"max-w-xs\">\n                          <div className=\"space-y-1\">\n                            <p className=\"font-medium\">{p.username} - #{idx + 1}</p>\n                            <p className=\"text-zinc-400\">\n                              {p.id === myParticipant?.id ? \"Your result\" : \"Racer\"}\n                            </p>\n                            <div className=\"pt-1 border-t border-zinc-700 mt-1\">\n                              <p className=\"text-zinc-300\">Speed: {p.wpm} words per minute</p>\n                              <p className=\"text-zinc-300\">Accuracy: {p.accuracy}% correct</p>\n                              <p className=\"text-zinc-300\">Characters typed: {p.progress}</p>\n                              {p.errors > 0 && <p className=\"text-zinc-400\">Errors: {p.errors}</p>}\n                              {!isParticipantBot && p.rating !== null && p.rating !== undefined && (\n                                <p className=\"text-zinc-300 mt-1\">\n                                  Rating: {p.rating} ({p.tierInfo?.name || p.tier})\n                                </p>\n                              )}\n                            </div>\n                            {/* Show tie-breaking info if there's a tie with adjacent player */}\n                            {idx > 0 && sortedParticipants[idx - 1].wpm === p.wpm && (\n                              <div className=\"pt-1 border-t border-zinc-700 mt-1\">\n                                <p className=\"text-xs text-yellow-400\">\n                                  âš¡ Tie-breaker: {\n                                    sortedParticipants[idx - 1].accuracy !== p.accuracy \n                                      ? \"Lower accuracy\" \n                                      : sortedParticipants[idx - 1].progress !== p.progress \n                                        ? \"Fewer characters typed\"\n                                        : \"Joined later\"\n                                  }\n                                </p>\n                              </div>\n                            )}\n                          </div>\n                        </TooltipContent>\n                      </Tooltip>\n                    );\n                  })}\n                </div>\n\n                {/* Rating Section */}\n                {user ? (\n                  ratingInfo ? (\n                    <RatingChangeDisplay ratingInfo={ratingInfo} position={myPosition} />\n                  ) : (\n                    <div className=\"p-3 border rounded-lg bg-muted/30 flex items-center gap-2 text-muted-foreground\" data-testid=\"rating-loading\">\n                      <Loader2 className=\"h-4 w-4 animate-spin\" />\n                      <span>Loading your rating...</span>\n                    </div>\n                  )\n                ) : (\n                  <div className=\"p-3 border rounded-lg bg-muted/30 text-center\" data-testid=\"rating-guest\">\n                    <p className=\"text-muted-foreground text-sm\">\n                      Sign in to track your competitive rating and tier\n                    </p>\n                  </div>\n                )}\n\n                {/* Rematch Notification */}\n                {rematchInfo && (\n                  <div className=\"p-4 border border-green-500/30 rounded-lg bg-green-500/10 flex items-center justify-between\" data-testid=\"rematch-notification\">\n                    <div className=\"flex items-center gap-2\">\n                      <RotateCcw className=\"h-5 w-5 text-green-500\" />\n                      <div>\n                        <p className=\"font-medium text-green-500\">Rematch Available!</p>\n                        <p className=\"text-sm text-muted-foreground\">Room Code: {rematchInfo.roomCode}</p>\n                      </div>\n                    </div>\n                    <Button\n                      onClick={() => setLocation(`/race/${rematchInfo.newRaceId}?code=${rematchInfo.roomCode}`)}\n                      className=\"bg-green-600 hover:bg-green-700\"\n                      data-testid=\"button-join-rematch\"\n                    >\n                      Join Rematch\n                    </Button>\n                  </div>\n                )}\n\n                <div className=\"flex gap-3\">\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        variant=\"outline\"\n                        onClick={() => setLocation(\"/multiplayer\")}\n                        className=\"flex-1\"\n                        data-testid=\"button-back\"\n                      >\n                        <Home className=\"h-4 w-4 mr-2\" />\n                        Back to Lobby\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\">\n                      <p>Return to multiplayer lobby to find more races</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        onClick={() => {\n                          if (ws && ws.readyState === WebSocket.OPEN && myParticipant) {\n                            ws.send(JSON.stringify({\n                              type: \"rematch\",\n                              raceId: race?.id,\n                              participantId: myParticipant.id,\n                              username: myParticipant.username,\n                            }));\n                            toast.info(\"Creating rematch room...\", { duration: 2000 });\n                          }\n                        }}\n                        className=\"flex-1\"\n                        data-testid=\"button-rematch\"\n                        disabled={!!rematchInfo}\n                      >\n                        <RotateCcw className=\"h-4 w-4 mr-2\" />\n                        {rematchInfo ? \"Rematch Created\" : \"Create Rematch\"}\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\">\n                      <p className=\"font-medium\">{rematchInfo ? \"Rematch already created\" : \"Create rematch room\"}</p>\n                      <p className=\"text-zinc-400\">\n                        {rematchInfo \n                          ? \"Click 'Join Rematch' above to continue\" \n                          : \"Create a new room with same settings for all players\"\n                        }\n                      </p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n\n        {/* Share Dialog with Race Certificate */}\n        <Dialog open={shareDialogOpen} onOpenChange={setShareDialogOpen}>\n          <DialogContent className=\"sm:max-w-[650px] max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-2\">\n                <Share2 className=\"w-5 h-5\" />\n                Share Your Race Result\n              </DialogTitle>\n              <DialogDescription>\n                Share your multiplayer race achievement with others!\n              </DialogDescription>\n            </DialogHeader>\n            \n            {lastResultSnapshot && (\n              <Tabs defaultValue=\"certificate\" className=\"w-full\">\n                <TabsList className=\"grid w-full grid-cols-1\">\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <TabsTrigger value=\"certificate\" className=\"gap-2\" data-testid=\"tab-race-certificate\">\n                        <Award className=\"w-4 h-4\" />\n                        Certificate\n                      </TabsTrigger>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\">\n                      <p className=\"text-xs\">Professional 1200Ã—675 certificate with verification ID</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </TabsList>\n                \n                <TabsContent value=\"certificate\" className=\"mt-4\">\n                  <RaceCertificate\n                    wpm={lastResultSnapshot.wpm}\n                    accuracy={lastResultSnapshot.accuracy}\n                    consistency={lastResultSnapshot.consistency}\n                    placement={lastResultSnapshot.placement}\n                    totalParticipants={lastResultSnapshot.totalParticipants}\n                    characters={lastResultSnapshot.characters}\n                    errors={lastResultSnapshot.errors}\n                    duration={lastResultSnapshot.duration}\n                    username={user?.username}\n                    raceId={race?.id?.toString()}\n                  />\n                </TabsContent>\n              </Tabs>\n            )}\n          </DialogContent>\n        </Dialog>\n      </TooltipProvider>\n    );\n  }\n\n  return null;\n}\n","path":null,"size_bytes":119888,"size_tokens":null},"client/src/pages/multiplayer.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useNetwork } from \"@/lib/network-context\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Alert, AlertDescription, AlertTitle } from \"@/components/ui/alert\";\nimport { Zap, Users, Lock, Trophy, Loader2, Info, WifiOff, AlertTriangle, CheckCircle2, Timer, FileText } from \"lucide-react\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { toast } from \"sonner\";\n\n// Error codes for specific error handling\ntype MultiplayerErrorCode = \"NETWORK_ERROR\" | \"ROOM_FULL\" | \"ROOM_NOT_FOUND\" | \"ROOM_STARTED\" | \"INVALID_CODE\" | \"SERVER_ERROR\";\n\ninterface MultiplayerError {\n  code: MultiplayerErrorCode;\n  message: string;\n}\n\n// Helper to parse error responses\nfunction parseErrorResponse(response: Response, data: { message?: string; code?: string }): MultiplayerError {\n  if (!navigator.onLine) {\n    return { code: \"NETWORK_ERROR\", message: \"You appear to be offline. Please check your internet connection.\" };\n  }\n  \n  if (response.status === 404) {\n    return { code: \"ROOM_NOT_FOUND\", message: data.message || \"Room not found. Check the code and try again.\" };\n  }\n  \n  if (response.status === 409) {\n    if (data.code === \"RACE_FULL\") {\n      return { code: \"ROOM_FULL\", message: \"This room is full. Try another room or create your own.\" };\n    }\n    if (data.code === \"RACE_STARTED\") {\n      return { code: \"ROOM_STARTED\", message: \"This race has already started. Try joining another room.\" };\n    }\n  }\n  \n  if (response.status >= 500) {\n    return { code: \"SERVER_ERROR\", message: \"Server is temporarily unavailable. Please try again in a moment.\" };\n  }\n  \n  return { code: \"SERVER_ERROR\", message: data.message || \"Something went wrong. Please try again.\" };\n}\n\n// Get user-friendly error icon\nfunction getErrorIcon(code: MultiplayerErrorCode) {\n  switch (code) {\n    case \"NETWORK_ERROR\": return <WifiOff className=\"h-4 w-4\" />;\n    case \"ROOM_FULL\": return <Users className=\"h-4 w-4\" />;\n    case \"ROOM_NOT_FOUND\": return <AlertTriangle className=\"h-4 w-4\" />;\n    default: return <AlertTriangle className=\"h-4 w-4\" />;\n  }\n}\n\ninterface Participant {\n  id: number;\n  raceId: number;\n  username: string;\n  avatarColor: string | null;\n  progress: number;\n  wpm: number;\n  accuracy: number;\n  isFinished: number;\n}\n\nfunction getOrCreateGuestId(): string {\n  const GUEST_ID_KEY = \"multiplayer_guest_id\";\n  let guestId = localStorage.getItem(GUEST_ID_KEY);\n  \n  if (!guestId) {\n    guestId = Math.random().toString(36).substring(2, 8);\n    localStorage.setItem(GUEST_ID_KEY, guestId);\n  }\n  \n  return guestId;\n}\n\nfunction formatDuration(seconds: number): string {\n  if (seconds < 60) {\n    return `${seconds}s`;\n  }\n  const minutes = Math.floor(seconds / 60);\n  const remainingSeconds = seconds % 60;\n  if (remainingSeconds === 0) {\n    return `${minutes}min`;\n  }\n  return `${minutes}m ${remainingSeconds}s`;\n}\n\nexport default function MultiplayerPage() {\n  const { user } = useAuth();\n  const { isOnline } = useNetwork();\n  const [, setLocation] = useLocation();\n  const [roomCode, setRoomCode] = useState(\"\");\n  const [maxPlayers, setMaxPlayers] = useState(4);\n  const [textSource, setTextSource] = useState(\"general\");\n  const [loading, setLoading] = useState(false);\n  const [loadingAction, setLoadingAction] = useState<\"quickMatch\" | \"createRoom\" | \"joinRoom\" | null>(null);\n  const [selectedDuration, setSelectedDuration] = useState<number>(60);\n  const quickMatchTriggeredRef = useRef(false);\n\n  // Auto-trigger quick match if coming from \"New Race\" button\n  useEffect(() => {\n    const urlParams = new URLSearchParams(window.location.search);\n    if (urlParams.get('quickmatch') === 'true' && !quickMatchTriggeredRef.current && isOnline) {\n      quickMatchTriggeredRef.current = true;\n      // Clear the URL parameter\n      window.history.replaceState({}, '', '/multiplayer');\n      // Trigger quick match after a short delay to ensure component is ready\n      setTimeout(() => {\n        quickMatch();\n      }, 100);\n    }\n  }, [isOnline]);\n\n  async function quickMatch() {\n    if (!isOnline) {\n      toast.error(\"You're offline. Please check your internet connection.\", {\n        icon: <WifiOff className=\"h-4 w-4\" />,\n      });\n      return;\n    }\n    \n    setLoading(true);\n    setLoadingAction(\"quickMatch\");\n    try {\n      const guestId = user ? undefined : getOrCreateGuestId();\n      const response = await fetch(\"/api/races/quick-match\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ \n          guestId,\n          raceType: \"timed\",\n          timeLimitSeconds: selectedDuration\n        }),\n      });\n\n      if (response.ok) {\n        const { race, participant } = await response.json();\n        localStorage.setItem(`race_${race.id}_participant`, JSON.stringify(participant));\n        toast.success(`Match found! ${formatDuration(selectedDuration)} race starting...`, {\n          icon: <CheckCircle2 className=\"h-4 w-4 text-green-500\" />,\n        });\n        setLocation(`/race/${race.id}`);\n      } else {\n        const errorData = await response.json().catch(() => ({}));\n        const error = parseErrorResponse(response, errorData);\n        toast.error(error.message, {\n          icon: getErrorIcon(error.code),\n          description: error.code === \"SERVER_ERROR\" ? \"Try again in a few seconds\" : undefined,\n        });\n      }\n    } catch (error) {\n      toast.error(\"Unable to connect to the game server\", {\n        icon: <WifiOff className=\"h-4 w-4\" />,\n        description: \"Please check your connection and try again\",\n      });\n    } finally {\n      setLoading(false);\n      setLoadingAction(null);\n    }\n  }\n\n  async function createRoom() {\n    if (!isOnline) {\n      toast.error(\"You're offline. Please check your internet connection.\", {\n        icon: <WifiOff className=\"h-4 w-4\" />,\n      });\n      return;\n    }\n    \n    setLoading(true);\n    setLoadingAction(\"createRoom\");\n    try {\n      const guestId = user ? undefined : getOrCreateGuestId();\n      const response = await fetch(\"/api/races/create\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ \n          isPrivate: true, \n          maxPlayers, \n          guestId,\n          timeLimitSeconds: selectedDuration,\n          textSource,\n        }),\n      });\n\n      if (response.ok) {\n        const { race, participant } = await response.json();\n        localStorage.setItem(`race_${race.id}_participant`, JSON.stringify(participant));\n        toast.success(`Room created! ${formatDuration(selectedDuration)} race`, {\n          icon: <CheckCircle2 className=\"h-4 w-4 text-green-500\" />,\n          description: `Share code: ${race.roomCode}`,\n        });\n        setLocation(`/race/${race.id}`);\n      } else {\n        const errorData = await response.json().catch(() => ({}));\n        const error = parseErrorResponse(response, errorData);\n        toast.error(error.message, {\n          icon: getErrorIcon(error.code),\n        });\n      }\n    } catch (error) {\n      toast.error(\"Unable to connect to the game server\", {\n        icon: <WifiOff className=\"h-4 w-4\" />,\n        description: \"Please check your connection and try again\",\n      });\n    } finally {\n      setLoading(false);\n      setLoadingAction(null);\n    }\n  }\n\n  async function joinRoom(code?: string) {\n    const codeToUse = code || roomCode;\n    \n    if (!codeToUse.trim()) {\n      toast.error(\"Please enter a room code\", {\n        icon: <AlertTriangle className=\"h-4 w-4\" />,\n      });\n      return;\n    }\n    \n    // Validate room code format\n    const cleanCode = codeToUse.trim().toUpperCase();\n    if (cleanCode.length !== 6) {\n      toast.error(\"Room code must be exactly 6 characters\", {\n        icon: <AlertTriangle className=\"h-4 w-4\" />,\n        description: \"Check the code and try again\",\n      });\n      return;\n    }\n    \n    if (!isOnline) {\n      toast.error(\"You're offline. Please check your internet connection.\", {\n        icon: <WifiOff className=\"h-4 w-4\" />,\n      });\n      return;\n    }\n\n    setLoading(true);\n    setLoadingAction(\"joinRoom\");\n    try {\n      const guestId = user ? undefined : getOrCreateGuestId();\n      const response = await fetch(`/api/races/join/${cleanCode}`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ guestId }),\n      });\n\n      if (response.ok) {\n        const { race, participant } = await response.json();\n        localStorage.setItem(`race_${race.id}_participant`, JSON.stringify(participant));\n        toast.success(\"Joined room! Waiting for race to start...\", {\n          icon: <CheckCircle2 className=\"h-4 w-4 text-green-500\" />,\n        });\n        setLocation(`/race/${race.id}`);\n      } else {\n        const errorData = await response.json().catch(() => ({}));\n        const error = parseErrorResponse(response, errorData);\n        toast.error(error.message, {\n          icon: getErrorIcon(error.code),\n          description: error.code === \"ROOM_NOT_FOUND\" ? \"Double-check the room code\" : undefined,\n        });\n      }\n    } catch (error) {\n      toast.error(\"Unable to connect to the game server\", {\n        icon: <WifiOff className=\"h-4 w-4\" />,\n        description: \"Please check your connection and try again\",\n      });\n    } finally {\n      setLoading(false);\n      setLoadingAction(null);\n    }\n  }\n\n  return (\n    <TooltipProvider delayDuration={300}>\n      <div className=\"min-h-screen bg-background\">\n        <div className=\"container max-w-6xl mx-auto px-4 py-8\">\n          {/* Network offline banner */}\n          {!isOnline && (\n            <Alert variant=\"destructive\" className=\"mb-6 border-yellow-500/50 bg-yellow-500/10\">\n              <WifiOff className=\"h-4 w-4\" />\n              <AlertTitle className=\"flex items-center gap-2\">\n                You're Offline\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Info className=\"h-3.5 w-3.5 cursor-help\" />\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"font-medium\">No Internet Connection</p>\n                    <p className=\"text-zinc-400\">Multiplayer features require an active internet connection. Check your network and try again.</p>\n                  </TooltipContent>\n                </Tooltip>\n              </AlertTitle>\n              <AlertDescription>\n                Please check your internet connection to use multiplayer features.\n              </AlertDescription>\n            </Alert>\n          )}\n          \n          <div className=\"text-center mb-12\">\n            <div className=\"flex items-center justify-center gap-3 mb-4\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Trophy className=\"h-12 w-12 text-primary cursor-help\" />\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\">\n                  <p className=\"font-medium\">Multiplayer Racing Mode</p>\n                  <p className=\"text-zinc-400\">Compete with real players in real-time typing races</p>\n                </TooltipContent>\n              </Tooltip>\n              <h1 className=\"text-4xl font-bold\">Multiplayer Racing</h1>\n            </div>\n            <p className=\"text-lg text-muted-foreground\">\n              Compete against others in real-time typing races\n            </p>\n          </div>\n\n          <Tabs defaultValue=\"quick\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-3 mb-8\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <TabsTrigger value=\"quick\" data-testid=\"tab-quick-match\">\n                    <Zap className=\"h-4 w-4 mr-2\" />\n                    Quick Match\n                  </TabsTrigger>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\">\n                  <p className=\"font-medium\">Instant Matchmaking</p>\n                  <p className=\"text-zinc-400\">Join an open race or start a new public one instantly</p>\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <TabsTrigger value=\"create\" data-testid=\"tab-create-room\">\n                    <Users className=\"h-4 w-4 mr-2\" />\n                    Create Room\n                  </TabsTrigger>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\">\n                  <p className=\"font-medium\">Create Custom Room</p>\n                  <p className=\"text-zinc-400\">Set up a private or public race with custom settings</p>\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <TabsTrigger value=\"join\" data-testid=\"tab-join-room\">\n                    <Lock className=\"h-4 w-4 mr-2\" />\n                    Join Room\n                  </TabsTrigger>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\">\n                  <p className=\"font-medium\">Join by Code</p>\n                  <p className=\"text-zinc-400\">Enter a 6-character room code to join a private race</p>\n                </TooltipContent>\n              </Tooltip>\n            </TabsList>\n\n            <TabsContent value=\"quick\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    Quick Match\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Info className=\"h-4 w-4 text-muted-foreground cursor-help\" />\n                      </TooltipTrigger>\n                      <TooltipContent side=\"right\" className=\"max-w-xs\">\n                        <p className=\"font-medium\">How Quick Match Works</p>\n                        <p className=\"text-zinc-400\">System finds an open race or creates a new public one. AI racers may join to fill empty slots.</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </CardTitle>\n                  <CardDescription>\n                    Join an available race or start a new one instantly\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <Timer className=\"h-4 w-4 text-primary\" />\n                      <label className=\"text-sm font-medium\">Race Duration</label>\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Info className=\"h-3.5 w-3.5 text-muted-foreground cursor-help\" />\n                        </TooltipTrigger>\n                        <TooltipContent side=\"right\">\n                          <p className=\"font-medium\">How long the race lasts</p>\n                          <p className=\"text-zinc-400\">Type as much as you can before time runs out!</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </div>\n                    <Select\n                      value={selectedDuration.toString()}\n                      onValueChange={(value) => setSelectedDuration(parseInt(value))}\n                    >\n                      <SelectTrigger className=\"w-full\" data-testid=\"select-duration\">\n                        <SelectValue placeholder=\"Select duration\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"30\">30 seconds</SelectItem>\n                        <SelectItem value=\"60\">1 minute</SelectItem>\n                        <SelectItem value=\"90\">90 seconds</SelectItem>\n                        <SelectItem value=\"120\">2 minutes</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        onClick={quickMatch}\n                        disabled={loading}\n                        size=\"lg\"\n                        className=\"w-full text-lg h-14\"\n                        data-testid=\"button-quick-match\"\n                      >\n                        {loading && loadingAction === \"quickMatch\" ? (\n                          <>\n                            <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\n                            Finding match...\n                          </>\n                        ) : (\n                          <>\n                            <Zap className=\"mr-2 h-5 w-5\" />\n                            Find Match â€¢ {formatDuration(selectedDuration)}\n                          </>\n                        )}\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\">\n                      <p>Click to instantly join or create a {selectedDuration}s race</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"create\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    Create Room\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Info className=\"h-4 w-4 text-muted-foreground cursor-help\" />\n                      </TooltipTrigger>\n                      <TooltipContent side=\"right\" className=\"max-w-xs\">\n                        <p className=\"font-medium\">Host Your Own Room</p>\n                        <p className=\"text-zinc-400\">Create a waiting room and share the code with friends. You'll configure the race settings once everyone joins.</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </CardTitle>\n                  <CardDescription>\n                    Create a waiting room and invite friends with the room code\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                  {/* Max Players */}\n                  <div className=\"space-y-3\">\n                    <div className=\"flex items-center gap-2\">\n                      <Users className=\"h-4 w-4 text-muted-foreground\" />\n                      <label className=\"text-sm font-medium\">Room Size</label>\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Info className=\"h-3.5 w-3.5 text-muted-foreground cursor-help\" />\n                        </TooltipTrigger>\n                        <TooltipContent side=\"right\">\n                          <p className=\"font-medium\">Maximum Players</p>\n                          <p className=\"text-zinc-400\">How many players can join this room (2-10)</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </div>\n                    <Select\n                      value={maxPlayers.toString()}\n                      onValueChange={(value) => setMaxPlayers(parseInt(value))}\n                    >\n                      <SelectTrigger className=\"w-full\" data-testid=\"select-max-players\">\n                        <SelectValue placeholder=\"Select room size\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"2\">2 players</SelectItem>\n                        <SelectItem value=\"3\">3 players</SelectItem>\n                        <SelectItem value=\"4\">4 players</SelectItem>\n                        <SelectItem value=\"5\">5 players</SelectItem>\n                        <SelectItem value=\"6\">6 players</SelectItem>\n                        <SelectItem value=\"8\">8 players</SelectItem>\n                        <SelectItem value=\"10\">10 players</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  {/* Race Duration */}\n                  <div className=\"space-y-3\">\n                    <div className=\"flex items-center gap-2\">\n                      <Timer className=\"h-4 w-4 text-muted-foreground\" />\n                      <label className=\"text-sm font-medium\">Race Duration</label>\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Info className=\"h-3.5 w-3.5 text-muted-foreground cursor-help\" />\n                        </TooltipTrigger>\n                        <TooltipContent side=\"right\">\n                          <p className=\"font-medium\">Time Limit</p>\n                          <p className=\"text-zinc-400\">How long the race will last</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </div>\n                    <Select\n                      value={selectedDuration.toString()}\n                      onValueChange={(value) => setSelectedDuration(parseInt(value))}\n                    >\n                      <SelectTrigger className=\"w-full\" data-testid=\"select-create-duration\">\n                        <SelectValue placeholder=\"Select duration\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"30\">30 seconds - Sprint</SelectItem>\n                        <SelectItem value=\"60\">1 minute - Standard</SelectItem>\n                        <SelectItem value=\"90\">90 seconds - Extended</SelectItem>\n                        <SelectItem value=\"120\">2 minutes - Marathon</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  {/* Text Source */}\n                  <div className=\"space-y-3\">\n                    <div className=\"flex items-center gap-2\">\n                      <FileText className=\"h-4 w-4 text-muted-foreground\" />\n                      <label className=\"text-sm font-medium\">Text Type</label>\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Info className=\"h-3.5 w-3.5 text-muted-foreground cursor-help\" />\n                        </TooltipTrigger>\n                        <TooltipContent side=\"right\">\n                          <p className=\"font-medium\">Race Text Category</p>\n                          <p className=\"text-zinc-400\">Choose what type of text you'll be typing</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </div>\n                    <Select\n                      value={textSource}\n                      onValueChange={(value) => setTextSource(value)}\n                    >\n                      <SelectTrigger className=\"w-full\" data-testid=\"select-text-source\">\n                        <SelectValue placeholder=\"Select text type\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"general\">General Topics (Most Content)</SelectItem>\n                        <SelectItem value=\"quotes\">Quotes & Proverbs</SelectItem>\n                        <SelectItem value=\"programming\">Programming Content</SelectItem>\n                        <SelectItem value=\"technical\">Technical Writing</SelectItem>\n                        <SelectItem value=\"news\">News Articles</SelectItem>\n                        <SelectItem value=\"entertainment\">Entertainment & Fun</SelectItem>\n                        <SelectItem value=\"random\">Random Mix (All Categories)</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n\n                  {/* Room Summary */}\n                  <div className=\"bg-muted/50 rounded-lg p-3 space-y-1.5\">\n                    <p className=\"text-xs font-medium text-muted-foreground uppercase tracking-wider\">Room Settings</p>\n                    <div className=\"flex flex-wrap gap-2 text-sm\">\n                      <span className=\"bg-primary/10 text-primary px-2 py-0.5 rounded\">{maxPlayers} players max</span>\n                      <span className=\"bg-primary/10 text-primary px-2 py-0.5 rounded\">{formatDuration(selectedDuration)}</span>\n                      <span className=\"bg-primary/10 text-primary px-2 py-0.5 rounded capitalize\">{textSource === \"random\" ? \"Random Text\" : textSource}</span>\n                    </div>\n                  </div>\n\n                  {/* Create Button */}\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        onClick={createRoom}\n                        disabled={loading || loadingAction !== null}\n                        size=\"lg\"\n                        className=\"w-full text-lg h-14\"\n                        data-testid=\"button-create-room\"\n                      >\n                        {loading && loadingAction === \"createRoom\" ? (\n                          <>\n                            <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\n                            Creating Room...\n                          </>\n                        ) : (\n                          <>\n                            <Users className=\"mr-2 h-5 w-5\" />\n                            Create Room\n                          </>\n                        )}\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\">\n                      <p>Create a waiting room for up to {maxPlayers} players</p>\n                    </TooltipContent>\n                  </Tooltip>\n\n                  {/* How it works */}\n                  <div className=\"text-xs text-center text-muted-foreground space-y-1\">\n                    <p className=\"font-medium\">How it works:</p>\n                    <p>1. Create room â†’ 2. Share code with friends â†’ 3. Start when ready</p>\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            <TabsContent value=\"join\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center gap-2\">\n                    Join with Code\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Info className=\"h-4 w-4 text-muted-foreground cursor-help\" />\n                      </TooltipTrigger>\n                      <TooltipContent side=\"right\" className=\"max-w-xs\">\n                        <p className=\"font-medium\">Room Code Entry</p>\n                        <p className=\"text-zinc-400\">Enter the 6-character code shared by the room creator to join their race.</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </CardTitle>\n                  <CardDescription>\n                    Enter a room code to join a private race\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className=\"space-y-6\">\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <label className=\"text-sm font-medium\">Room Code</label>\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Info className=\"h-3.5 w-3.5 text-muted-foreground cursor-help\" />\n                        </TooltipTrigger>\n                        <TooltipContent side=\"right\">\n                          <p className=\"font-medium\">6-Character Code</p>\n                          <p className=\"text-zinc-400\">Example: ABC123, XYZ789</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </div>\n                    <Input\n                      type=\"text\"\n                      placeholder=\"Enter 6-character code\"\n                      value={roomCode}\n                      onChange={(e) => setRoomCode(e.target.value.toUpperCase())}\n                      maxLength={6}\n                      className=\"w-full text-lg tracking-wider font-mono\"\n                      data-testid=\"input-room-code\"\n                    />\n                    {roomCode.length > 0 && roomCode.length < 6 && (\n                      <p className=\"text-xs text-muted-foreground\">\n                        {6 - roomCode.length} more character{6 - roomCode.length !== 1 ? 's' : ''} needed\n                      </p>\n                    )}\n                  </div>\n\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        onClick={() => { void joinRoom(); }}\n                        disabled={loading || roomCode.length !== 6}\n                        size=\"lg\"\n                        className=\"w-full text-lg h-14\"\n                        data-testid=\"button-join-room\"\n                      >\n                        {loading ? (\n                          <>\n                            <Loader2 className=\"mr-2 h-5 w-5 animate-spin\" />\n                            Joining...\n                          </>\n                        ) : (\n                          <>\n                            <Lock className=\"mr-2 h-5 w-5\" />\n                            Join Room\n                          </>\n                        )}\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\">\n                      {roomCode.length !== 6 \n                        ? <p>Enter a complete 6-character room code</p>\n                        : <p>Click to join the race room</p>\n                      }\n                    </TooltipContent>\n                  </Tooltip>\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </div>\n    </TooltipProvider>\n  );\n}\n","path":null,"size_bytes":30317,"size_tokens":null},"server/bot-service.ts":{"content":"import { storage } from \"./storage\";\nimport type { RaceParticipant } from \"@shared/schema\";\nimport { botNamePool } from \"./bot-name-pool\";\n\nconst avatarColors = [\n  \"bg-red-500\",\n  \"bg-blue-500\",\n  \"bg-green-500\",\n  \"bg-yellow-500\",\n  \"bg-purple-500\",\n  \"bg-pink-500\",\n  \"bg-indigo-500\",\n  \"bg-orange-500\",\n  \"bg-teal-500\",\n  \"bg-cyan-500\",\n];\n\n// Human typing characteristics based on keystroke dynamics research\nconst TYPING_CHARACTERISTICS = {\n  // Character difficulty scores (higher = slower to type)\n  charDifficulty: new Map<string, number>([\n    // Easy keys (home row)\n    ['a', 0.8], ['s', 0.8], ['d', 0.8], ['f', 0.8], ['j', 0.8], ['k', 0.8], ['l', 0.8],\n    // Medium keys\n    ['e', 0.9], ['r', 0.9], ['t', 0.9], ['i', 0.9], ['o', 0.9], ['n', 0.9],\n    // Harder keys (require stretch)\n    ['q', 1.3], ['z', 1.3], ['x', 1.2], ['p', 1.2], ['b', 1.1], ['v', 1.1],\n    // Numbers (top row stretch)\n    ['1', 1.4], ['2', 1.3], ['3', 1.2], ['4', 1.2], ['5', 1.3], ['6', 1.3], ['7', 1.2], ['8', 1.2], ['9', 1.3], ['0', 1.4],\n    // Symbols (shift required)\n    ['!', 1.5], ['@', 1.5], ['#', 1.5], ['$', 1.5], ['%', 1.5], ['^', 1.6], ['&', 1.5], ['*', 1.5],\n    ['(', 1.4], [')', 1.4], ['-', 1.3], ['_', 1.5], ['=', 1.3], ['+', 1.5],\n    ['[', 1.4], [']', 1.4], ['{', 1.6], ['}', 1.6], ['\\\\', 1.5], ['|', 1.6],\n    [';', 1.1], [':', 1.3], [\"'\", 1.2], ['\"', 1.4], [',', 1.0], ['<', 1.4],\n    ['.', 1.0], ['>', 1.4], ['/', 1.1], ['?', 1.4],\n  ]),\n  \n  // Common digraphs (two-letter combinations) that are typed faster\n  fastDigraphs: new Set(['th', 'he', 'in', 'er', 'an', 'on', 'at', 'en', 'nd', 'ti', 'es', 'or', 'te', 'of', 'ed', 'is', 'it', 'al', 'ar', 'st', 'to', 'nt', 'ng', 'se', 'ha', 're', 'ou', 'ea', 'le', 'hi', 've', 'co', 'me', 'de', 'ta', 'ne', 'ri', 'ro', 'li']),\n  \n  // Awkward digraphs that are slow to type (awkward stretches, not common combos)\n  slowDigraphs: new Set(['zx', 'xz', 'qz', 'zq', 'az', 'za', 'sx', 'xs', 'vf', 'fv', 'bg', 'gb', 'nh', 'hn', 'mj', 'jm', 'aq', 'qa', 'xc', 'cx', 'zc', 'cz', 'bv', 'vb']),\n  \n  // Same-finger key pairs (consecutive keys typed with the same finger are slower)\n  // Based on standard touch typing finger assignments\n  sameFingerPairs: new Set([\n    // Left pinky: q, a, z, 1\n    'qa', 'aq', 'az', 'za', 'qz', 'zq', '1q', 'q1', '1a', 'a1', '1z', 'z1',\n    // Left ring: w, s, x, 2\n    'ws', 'sw', 'sx', 'xs', 'wx', 'xw', '2w', 'w2', '2s', 's2', '2x', 'x2',\n    // Left middle: e, d, c, 3\n    'ed', 'de', 'dc', 'cd', 'ec', 'ce', '3e', 'e3', '3d', 'd3', '3c', 'c3',\n    // Left index: r, f, v, t, g, b, 4, 5\n    'rf', 'fr', 'fv', 'vf', 'rv', 'vr', 'tg', 'gt', 'gb', 'bg', 'tb', 'bt', '4r', 'r4', '4f', 'f4', '5t', 't5', '5g', 'g5',\n    // Right index: y, h, n, u, j, m, 6, 7\n    'yh', 'hy', 'yn', 'ny', 'uj', 'ju', 'jm', 'mj', 'hn', 'nh', 'um', 'mu', 'jn', 'nj', '6y', 'y6', '7u', 'u7',\n    // Right middle: i, k, comma, 8\n    'ik', 'ki', 'k,', ',k', 'i,', ',i', '8i', 'i8', '8k', 'k8',\n    // Right ring: o, l, period, 9\n    'ol', 'lo', 'o.', '.o', 'l9', '9l', '9o', 'o9',\n    // Right pinky: p, semicolon, slash, 0, minus, bracket\n    'p;', ';p', 'p/', '/p', ';/', '/;', '0p', 'p0', '-p', 'p-',\n  ]),\n  \n  // Hand assignment for keys (left = true, right = false)\n  leftHandKeys: new Set(['q', 'w', 'e', 'r', 't', 'a', 's', 'd', 'f', 'g', 'z', 'x', 'c', 'v', 'b', '1', '2', '3', '4', '5', '!', '@', '#', '$', '%', '`', '~']),\n  \n  // Punctuation that causes extra pause (thinking/shifting)\n  punctuationPause: new Set(['.', ',', '!', '?', ';', ':', '-', \"'\", '\"', '(', ')', '[', ']']),\n  \n  // Sentence endings - longer pause for reading/comprehending next sentence\n  sentenceEndings: new Set(['.', '!', '?']),\n  \n  // Word endings that signal a natural pause point\n  wordEndings: new Set([' ', '\\n', '\\t']),\n};\n\n// Skill level definitions with realistic WPM ranges\ntype SkillLevel = 'beginner' | 'intermediate' | 'advanced' | 'expert' | 'pro';\n\ninterface SkillProfile {\n  minWPM: number;\n  maxWPM: number;\n  baseAccuracy: number;\n  // How much WPM varies during typing (flow vs struggle)\n  wpmVariance: number;\n  // Probability of entering \"flow state\" (faster typing)\n  flowStateChance: number;\n  // Probability of \"struggle\" periods (slower typing)\n  struggleChance: number;\n  // Warmup duration (% of text before reaching peak speed)\n  warmupPercent: number;\n  // Fatigue threshold (% of text where fatigue starts)\n  fatigueThreshold: number;\n  // Thinking pause frequency (pauses per 100 chars)\n  thinkingPauseRate: number;\n  // Error correction behavior\n  errorCorrectionDelay: number; // ms to \"notice\" error\n}\n\nconst SKILL_PROFILES: Record<SkillLevel, SkillProfile> = {\n  beginner: {\n    minWPM: 20,\n    maxWPM: 40,\n    baseAccuracy: 88,\n    wpmVariance: 0.35, // 35% variance - very inconsistent\n    flowStateChance: 0.05,\n    struggleChance: 0.25,\n    warmupPercent: 0.15,\n    fatigueThreshold: 0.70,\n    thinkingPauseRate: 8, // More frequent pauses\n    errorCorrectionDelay: 400,\n  },\n  intermediate: {\n    minWPM: 40,\n    maxWPM: 65,\n    baseAccuracy: 92,\n    wpmVariance: 0.25,\n    flowStateChance: 0.15,\n    struggleChance: 0.15,\n    warmupPercent: 0.10,\n    fatigueThreshold: 0.80,\n    thinkingPauseRate: 5,\n    errorCorrectionDelay: 300,\n  },\n  advanced: {\n    minWPM: 65,\n    maxWPM: 90,\n    baseAccuracy: 95,\n    wpmVariance: 0.18,\n    flowStateChance: 0.25,\n    struggleChance: 0.08,\n    warmupPercent: 0.08,\n    fatigueThreshold: 0.85,\n    thinkingPauseRate: 3,\n    errorCorrectionDelay: 200,\n  },\n  expert: {\n    minWPM: 90,\n    maxWPM: 120,\n    baseAccuracy: 97,\n    wpmVariance: 0.12,\n    flowStateChance: 0.35,\n    struggleChance: 0.05,\n    warmupPercent: 0.05,\n    fatigueThreshold: 0.90,\n    thinkingPauseRate: 2,\n    errorCorrectionDelay: 150,\n  },\n  pro: {\n    minWPM: 120,\n    maxWPM: 150,\n    baseAccuracy: 98.5,\n    wpmVariance: 0.08,\n    flowStateChance: 0.45,\n    struggleChance: 0.02,\n    warmupPercent: 0.03,\n    fatigueThreshold: 0.95,\n    thinkingPauseRate: 1,\n    errorCorrectionDelay: 100,\n  },\n};\n\ninterface BotProfile {\n  username: string;\n  avatarColor: string;\n  targetWPM: number;\n  accuracy: number;\n  personality: 'friendly' | 'competitive' | 'casual' | 'encouraging';\n  lastChatTime: number;\n  // Advanced typing behavior\n  skillLevel: SkillLevel;\n  skillProfile: SkillProfile;\n  // Dynamic state during race\n  isInFlowState: boolean;\n  flowStateEndChar: number;\n  isStruggling: boolean;\n  struggleEndChar: number;\n  lastCharacter: string;\n  currentMomentumWPM: number; // Smoothed WPM for realistic variance\n}\n\nconst BOT_CHAT_RESPONSES = {\n  greetings: [\n    \"yoo ðŸ‘‹\",\n    \"heyyy\",\n    \"yo whats up\",\n    \"heyy ready to go?\",\n    \"sup!\",\n    \"ayy whats good\",\n  ],\n  encouragement: [\n    \"we got this\",\n    \"lets get it!\",\n    \"keep going ðŸ’ª\",\n    \"u got it\",\n    \"nice nice\",\n  ],\n  competitive: [\n    \"lets gooo ðŸ’ª\",\n    \"oh its on\",\n    \"bet ðŸ\",\n    \"bring it lol\",\n    \"we'll see about that ðŸ˜¤\",\n    \"im ready\",\n  ],\n  casual: [\n    \"haha yea\",\n    \"fr\",\n    \"lol\",\n    \"true\",\n    \"bet\",\n    \"nice ðŸš€\",\n  ],\n  reactions: [\n    \"fr fr ðŸ˜„\",\n    \"haha ikr\",\n    \"lol yea\",\n    \"haha yess\",\n    \"facts ðŸ”¥\",\n  ],\n  goodLuck: [\n    \"gl to u too ðŸ€\",\n    \"haha thanks u2\",\n    \"same to u!\",\n    \"ty lets gooo ðŸ”¥\",\n    \"gl gl\",\n  ],\n  finishing: [\n    \"gg that was fun\",\n    \"gg everyone!\",\n    \"gg wp ðŸ‘\",\n    \"good race fr\",\n    \"lol that was intense\",\n  ],\n};\n\nconst BOT_PERSONALITIES = ['friendly', 'competitive', 'casual', 'encouraging'] as const;\n\nclass BotService {\n  private activeBots: Map<number, NodeJS.Timeout> = new Map();\n  private botProfiles: Map<number, BotProfile> = new Map();\n  private botParagraphLengths: Map<number, number> = new Map();\n\n  async generateUniqueBotNames(count: number): Promise<string[]> {\n    return botNamePool.getRandomNames(count);\n  }\n\n  async addBotsToRace(raceId: number, botCount: number): Promise<RaceParticipant[]> {\n    const botNames = await this.generateUniqueBotNames(botCount);\n    const bots: RaceParticipant[] = [];\n\n    for (const name of botNames) {\n      const profile = this.createBotProfile(name);\n      \n      const bot = await storage.createRaceParticipant({\n        raceId,\n        username: name,\n        avatarColor: profile.avatarColor,\n        isBot: 1,\n        progress: 0,\n        wpm: 0,\n        accuracy: 0,\n        errors: 0,\n        isFinished: 0,\n      });\n\n      this.botProfiles.set(bot.id, profile);\n      bots.push(bot);\n    }\n\n    return bots;\n  }\n\n  private createBotProfile(username: string): BotProfile {\n    // Weighted skill level distribution (more intermediate/advanced, fewer beginners/pros)\n    const skillDistribution: { level: SkillLevel; weight: number }[] = [\n      { level: 'beginner', weight: 1.5 },\n      { level: 'intermediate', weight: 4 },\n      { level: 'advanced', weight: 4 },\n      { level: 'expert', weight: 2 },\n      { level: 'pro', weight: 0.5 },\n    ];\n\n    const totalWeight = skillDistribution.reduce((sum, s) => sum + s.weight, 0);\n    let random = Math.random() * totalWeight;\n    let selectedLevel: SkillLevel = 'intermediate';\n    \n    for (const dist of skillDistribution) {\n      random -= dist.weight;\n      if (random <= 0) {\n        selectedLevel = dist.level;\n        break;\n      }\n    }\n    \n    const skillProfile = SKILL_PROFILES[selectedLevel];\n    \n    // Generate target WPM within the skill level's range with some Gaussian-like distribution\n    // This creates more realistic clustering around the middle of the range\n    const rangeSize = skillProfile.maxWPM - skillProfile.minWPM;\n    const normalizedRandom = (Math.random() + Math.random() + Math.random()) / 3; // Pseudo-Gaussian\n    const targetWPM = Math.round(skillProfile.minWPM + (rangeSize * normalizedRandom));\n    \n    // Accuracy based on skill with small variance\n    const accuracyVariation = (Math.random() - 0.5) * 3;\n    const accuracy = Math.max(85, Math.min(99.5, skillProfile.baseAccuracy + accuracyVariation));\n    \n    const personality = BOT_PERSONALITIES[Math.floor(Math.random() * BOT_PERSONALITIES.length)];\n\n    console.log(`[Bot Profile] Created ${username}: ${selectedLevel} level, target ${targetWPM} WPM, ${accuracy.toFixed(1)}% accuracy`);\n\n    return {\n      username,\n      avatarColor: avatarColors[Math.floor(Math.random() * avatarColors.length)],\n      targetWPM,\n      accuracy,\n      personality,\n      lastChatTime: 0,\n      // Advanced typing behavior\n      skillLevel: selectedLevel,\n      skillProfile,\n      // Dynamic state (initialized at race start)\n      isInFlowState: false,\n      flowStateEndChar: 0,\n      isStruggling: false,\n      struggleEndChar: 0,\n      lastCharacter: '',\n      currentMomentumWPM: targetWPM,\n    };\n  }\n\n  /**\n   * Gaussian random number generator using Box-Muller transform\n   * Returns a value with mean 0 and standard deviation 1\n   */\n  private gaussianRandom(): number {\n    let u = 0, v = 0;\n    while (u === 0) u = Math.random();\n    while (v === 0) v = Math.random();\n    return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);\n  }\n\n  /**\n   * Calculate the delay for typing a single character based on human-like patterns\n   * PRODUCTION-READY: Optimized for realistic but consistent timing\n   */\n  private calculateCharacterDelay(\n    profile: BotProfile,\n    currentChar: string,\n    nextChar: string | null,\n    progressPercent: number,\n    paragraphText: string,\n    charIndex: number\n  ): number {\n    // Base delay from target WPM (chars per minute / 60000 for ms)\n    // Average word = 5 chars, so chars per minute = WPM * 5\n    const baseDelayMs = 60000 / (profile.targetWPM * 5);\n    \n    // === SIMPLE SPEED VARIANCE ===\n    // Small random variance (Â±15%) to feel human but stay near target WPM\n    const variance = 0.85 + (Math.random() * 0.3); // 0.85 to 1.15\n    \n    // === WARMUP (first 10%): slightly slower start ===\n    let speedMultiplier = 1.0;\n    if (progressPercent < 0.1) {\n      speedMultiplier = 0.85 + (progressPercent * 1.5); // 0.85 -> 1.0\n    }\n    \n    // === FLOW/STRUGGLE STATES (simplified) ===\n    if (charIndex >= profile.flowStateEndChar) profile.isInFlowState = false;\n    if (charIndex >= profile.struggleEndChar) profile.isStruggling = false;\n    \n    if (profile.isInFlowState) {\n      speedMultiplier *= 0.88; // 12% faster in flow\n    } else if (profile.isStruggling) {\n      speedMultiplier *= 1.15; // 15% slower when struggling\n    } else if (Math.random() < 0.02) { // 2% chance per char to enter state\n      if (Math.random() < 0.6) {\n        profile.isInFlowState = true;\n        profile.flowStateEndChar = charIndex + 15 + Math.floor(Math.random() * 15);\n      } else {\n        profile.isStruggling = true;\n        profile.struggleEndChar = charIndex + 8 + Math.floor(Math.random() * 8);\n      }\n    }\n    \n    // === SMALL PAUSES ===\n    let extraDelay = 0;\n    \n    // Word boundaries: small pause (20% of base delay)\n    if (currentChar === ' ') {\n      extraDelay = baseDelayMs * 0.2;\n    }\n    \n    // Sentence endings: brief reading pause (30-80ms)\n    if (profile.lastCharacter && TYPING_CHARACTERISTICS.sentenceEndings.has(profile.lastCharacter)) {\n      extraDelay = 30 + Math.random() * 50;\n    }\n    \n    // Store for digraph tracking\n    profile.lastCharacter = currentChar;\n    \n    // === FINAL CALCULATION ===\n    const finalDelay = (baseDelayMs * speedMultiplier * variance) + extraDelay;\n    \n    // Clamp to reasonable range (minimum 30ms, maximum 3x base)\n    return Math.max(30, Math.min(baseDelayMs * 3, finalDelay));\n  }\n\n  startBotTyping(\n    participantId: number,\n    raceId: number,\n    paragraphLength: number,\n    broadcastCallback: (data: any) => void,\n    onBotFinished?: (raceId: number, participantId: number, position: number) => void,\n    botUsername?: string,\n    paragraphText?: string\n  ) {\n    let profile = this.botProfiles.get(participantId);\n    if (!profile) {\n      if (botUsername) {\n        console.log(`[Bot Typing] Recreating profile for bot ${participantId} (${botUsername})`);\n        profile = this.createBotProfile(botUsername);\n        this.botProfiles.set(participantId, profile);\n      } else {\n        console.error(`[Bot Typing] No profile found for bot ${participantId} and no username provided. Known profiles: ${Array.from(this.botProfiles.keys()).join(', ')}`);\n        return;\n      }\n    }\n    \n    // Reset dynamic state for new race\n    profile.isInFlowState = false;\n    profile.flowStateEndChar = 0;\n    profile.isStruggling = false;\n    profile.struggleEndChar = 0;\n    profile.lastCharacter = '';\n    profile.currentMomentumWPM = 0; // Start at 0, will build up during warmup\n    \n    console.log(`[Bot Typing] Bot ${profile.username} (${participantId}) starting: ${profile.skillLevel} level, target ${profile.targetWPM} WPM, paragraph ${paragraphLength} chars`);\n\n    this.botParagraphLengths.set(participantId, paragraphLength);\n    const text = paragraphText || ' '.repeat(paragraphLength);\n    \n    let currentProgress = 0;\n    let currentErrors = 0;\n    let startTime = Date.now();\n    let accumulatedDelay = 0;\n    let lastBroadcastTime = Date.now();\n    const BROADCAST_INTERVAL = 150; // Broadcast updates every 150ms for smooth UI\n\n    const simulate = async () => {\n      const currentProfile = this.botProfiles.get(participantId);\n      if (!currentProfile) {\n        console.log(`[Bot Typing] Bot ${participantId} profile removed, stopping simulation`);\n        return;\n      }\n\n      const currentParagraphLength = this.botParagraphLengths.get(participantId) || paragraphLength;\n\n      // Check if finished\n      if (currentProgress >= currentParagraphLength) {\n        this.stopBotTyping(participantId);\n        \n        const { position, isNewFinish } = await storage.finishParticipant(participantId);\n        \n        if (!isNewFinish) {\n          return;\n        }\n\n        // Calculate final WPM\n        const totalElapsed = (Date.now() - startTime) / 60000;\n        const finalWPM = Math.round((currentParagraphLength / 5) / totalElapsed);\n        const finalAccuracy = currentProgress > 0 ? ((currentProgress - currentErrors) / currentProgress) * 100 : 100;\n\n        broadcastCallback({\n          type: \"progress_update\",\n          participantId,\n          progress: currentParagraphLength,\n          wpm: finalWPM,\n          accuracy: Math.round(finalAccuracy * 100) / 100,\n          errors: currentErrors,\n        });\n\n        broadcastCallback({\n          type: \"participant_finished\",\n          participantId,\n          position,\n        });\n        \n        console.log(`[Bot Typing] Bot ${currentProfile.username} finished at position ${position}, final WPM: ${finalWPM}`);\n        \n        if (onBotFinished) {\n          onBotFinished(raceId, participantId, position);\n        }\n        \n        return;\n      }\n\n      // === CHARACTER-BY-CHARACTER SIMULATION ===\n      const progressPercent = currentProgress / currentParagraphLength;\n      const currentChar = text[currentProgress] || ' ';\n      const nextChar = currentProgress + 1 < text.length ? text[currentProgress + 1] : null;\n      \n      // Calculate human-like delay for this character\n      const charDelay = this.calculateCharacterDelay(\n        currentProfile,\n        currentChar,\n        nextChar,\n        progressPercent,\n        text,\n        currentProgress\n      );\n      \n      // Simulate error injection based on accuracy\n      const errorChance = (100 - currentProfile.accuracy) / 100;\n      if (Math.random() < errorChance) {\n        currentErrors++;\n        // Error adds slight extra delay (noticing and mentally correcting)\n        accumulatedDelay += currentProfile.skillProfile.errorCorrectionDelay * 0.3;\n      }\n      \n      // Advance progress\n      currentProgress++;\n      accumulatedDelay += charDelay;\n      \n      // Calculate current stats with realistic warmup\n      const elapsedMs = Date.now() - startTime;\n      const elapsedMinutes = elapsedMs / 60000;\n      \n      // Calculate raw WPM based on actual progress\n      let currentWPM = 0;\n      if (elapsedMinutes > 0.01) { // At least 0.6 seconds elapsed\n        const rawWPM = Math.round((currentProgress / 5) / elapsedMinutes);\n        \n        // Apply warmup ramp: 0-8 seconds = gradual increase, then full speed\n        const warmupDuration = 8000; // 8 seconds warmup\n        const warmupProgress = Math.min(1, elapsedMs / warmupDuration);\n        // Use ease-in curve for natural acceleration\n        const warmupFactor = warmupProgress * warmupProgress; // Quadratic ease-in\n        \n        // Clamp to target WPM range to avoid spikes\n        const maxWPM = currentProfile.targetWPM * 1.15;\n        currentWPM = Math.round(Math.min(rawWPM * warmupFactor, maxWPM));\n      }\n      \n      const currentAccuracy = currentProgress > 0 ? ((currentProgress - currentErrors) / currentProgress) * 100 : 100;\n      \n      // Broadcast updates at intervals for smooth UI (not every character)\n      const now = Date.now();\n      if (now - lastBroadcastTime >= BROADCAST_INTERVAL || currentProgress >= currentParagraphLength) {\n        lastBroadcastTime = now;\n        \n        await storage.updateParticipantProgress(\n          participantId,\n          currentProgress,\n          currentWPM,\n          Math.round(currentAccuracy * 100) / 100,\n          currentErrors\n        );\n\n        broadcastCallback({\n          type: \"progress_update\",\n          participantId,\n          progress: currentProgress,\n          wpm: currentWPM,\n          accuracy: Math.round(currentAccuracy * 100) / 100,\n          errors: currentErrors,\n        });\n      }\n\n      // Schedule next character\n      const timer = setTimeout(simulate, charDelay);\n      this.activeBots.set(participantId, timer);\n    };\n\n    // Initial reaction delay (human reaction time to race start)\n    // Skill-based: pros react faster (200-400ms), beginners slower (400-800ms)\n    const skillIndex = Object.keys(SKILL_PROFILES).indexOf(profile.skillLevel);\n    const minReaction = 200 + (4 - skillIndex) * 80;\n    const maxReaction = 400 + (4 - skillIndex) * 120;\n    const initialDelay = minReaction + Math.random() * (maxReaction - minReaction);\n    \n    console.log(`[Bot Typing] Bot ${profile.username} starting in ${Math.round(initialDelay)}ms (${profile.skillLevel} reaction time)`);\n    \n    const timer = setTimeout(simulate, initialDelay);\n    this.activeBots.set(participantId, timer);\n  }\n\n  stopBotTyping(participantId: number) {\n    const timer = this.activeBots.get(participantId);\n    if (timer) {\n      clearTimeout(timer);\n      this.activeBots.delete(participantId);\n    }\n    this.botProfiles.delete(participantId);\n    this.botParagraphLengths.delete(participantId);\n  }\n\n  stopAllBotsInRace(raceId: number, participants: RaceParticipant[]) {\n    participants.forEach(p => {\n      if (p.isBot === 1) {\n        this.stopBotTyping(p.id);\n      }\n    });\n  }\n\n  updateParagraphLength(participantId: number, newLength: number): void {\n    if (this.botProfiles.has(participantId)) {\n      this.botParagraphLengths.set(participantId, newLength);\n      console.log(`[Bot Typing] Updated paragraph length for bot ${participantId} to ${newLength}`);\n    }\n  }\n\n  private getRandomResponse(category: keyof typeof BOT_CHAT_RESPONSES): string {\n    const responses = BOT_CHAT_RESPONSES[category];\n    return responses[Math.floor(Math.random() * responses.length)];\n  }\n\n  private detectMessageIntent(content: string): keyof typeof BOT_CHAT_RESPONSES {\n    const lower = content.toLowerCase();\n    \n    if (/\\b(hi|hello|hey|sup|yo|hola|greetings)\\b/.test(lower)) {\n      return 'greetings';\n    }\n    if (/\\b(good\\s*luck|gl|best of luck|fingers crossed)\\b/.test(lower)) {\n      return 'goodLuck';\n    }\n    if (/\\b(gg|good\\s*game|well\\s*played|nice\\s*race|great\\s*race)\\b/.test(lower)) {\n      return 'finishing';\n    }\n    if (/\\b(nice|great|awesome|cool|wow|amazing|impressive)\\b/.test(lower)) {\n      return 'reactions';\n    }\n    if (/\\b(let'?s\\s*go|come\\s*on|race|challenge|beat|fast)\\b/.test(lower)) {\n      return 'competitive';\n    }\n    if (/\\b(you\\s*can|keep|going|try|practice|effort)\\b/.test(lower)) {\n      return 'encouragement';\n    }\n    \n    return 'casual';\n  }\n\n  generateBotChatResponse(\n    participantId: number,\n    incomingContent: string,\n    raceStatus: string\n  ): { shouldRespond: boolean; response?: string; botUsername?: string } {\n    const profile = this.botProfiles.get(participantId);\n    if (!profile) {\n      return { shouldRespond: false };\n    }\n\n    const now = Date.now();\n    const timeSinceLastChat = now - profile.lastChatTime;\n    const MIN_CHAT_INTERVAL = 15000;\n    \n    if (timeSinceLastChat < MIN_CHAT_INTERVAL) {\n      return { shouldRespond: false };\n    }\n\n    // 95% response rate for more reliable chat experience\n    const responseChance = 0.95;\n\n    if (Math.random() > responseChance) {\n      return { shouldRespond: false };\n    }\n\n    let responseCategory = this.detectMessageIntent(incomingContent);\n    \n    if (profile.personality === 'competitive' && Math.random() > 0.5) {\n      responseCategory = 'competitive';\n    } else if (profile.personality === 'encouraging' && Math.random() > 0.5) {\n      responseCategory = 'encouragement';\n    }\n\n    profile.lastChatTime = now;\n\n    return {\n      shouldRespond: true,\n      response: this.getRandomResponse(responseCategory),\n      botUsername: profile.username,\n    };\n  }\n\n  getBotsInRace(participantIds: number[]): { participantId: number; username: string }[] {\n    const bots: { participantId: number; username: string }[] = [];\n    for (const id of participantIds) {\n      const profile = this.botProfiles.get(id);\n      if (profile) {\n        bots.push({ participantId: id, username: profile.username });\n      }\n    }\n    return bots;\n  }\n\n  isBot(participantId: number): boolean {\n    return this.botProfiles.has(participantId);\n  }\n\n  getBotProfile(participantId: number): BotProfile | undefined {\n    return this.botProfiles.get(participantId);\n  }\n}\n\nexport const botService = new BotService();\n","path":null,"size_bytes":23979,"size_tokens":null},"server/bot-name-pool.ts":{"content":"import OpenAI from \"openai\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n\nconst POOL_SIZE = 100;\nconst REFRESH_THRESHOLD = 20;\n\nclass BotNamePool {\n  private namePool: string[] = [];\n  private usedNamesIndex: Set<number> = new Set();\n  private isInitialized = false;\n  private isRefreshing = false;\n\n  async initialize() {\n    if (this.isInitialized) return;\n    \n    console.log(\"[Bot Name Pool] Initializing with\", POOL_SIZE, \"realistic names...\");\n    this.namePool = await this.generateRealisticNames(POOL_SIZE);\n    this.isInitialized = true;\n    console.log(\"[Bot Name Pool] Ready with\", this.namePool.length, \"names\");\n  }\n\n  private async generateRealisticNames(count: number): Promise<string[]> {\n    const allNames: string[] = [];\n    const batchSize = 20;\n    \n    for (let i = 0; i < count; i += batchSize) {\n      const remaining = Math.min(batchSize, count - i);\n      try {\n        const response = await openai.chat.completions.create({\n          model: \"gpt-4o-mini\",\n          messages: [\n            {\n              role: \"system\",\n              content: \"You are a creative username generator. Generate realistic usernames that real people would actually use online. Make them sound like REAL HUMANS, not obviously bots.\",\n            },\n            {\n              role: \"user\",\n              content: `Generate ${remaining} unique, realistic usernames for online competitors. These should feel like REAL PEOPLE'S actual usernames. Include variety:\n- Professional: alex_codes, sarah_dev, mike_w, emma_tech\n- Casual: jenny2024, tomsmith, chris_j, lisa_m\n- Gaming: NightRacer, ShadowKeys, StarPlayer, QuickDraw\n- Creative: pixel_master, code_ninja, fast_typer, word_wizard\n- International: yuki_san, maria_g, raj_kumar, anna_k, pedro_fast\n\nMix styles randomly. Keep them 5-15 characters. Make them feel authentic like real users from around the world. Return ONLY the usernames, one per line, no numbering or extra text.`,\n            },\n          ],\n          temperature: 1.4,\n          max_tokens: 400,\n        });\n\n        const names = response.choices[0].message.content\n          ?.trim()\n          .split(\"\\n\")\n          .map(name => name.trim().replace(/[^a-zA-Z0-9_-]/g, ''))\n          .filter(name => name.length >= 4 && name.length <= 16);\n\n        if (names) {\n          allNames.push(...names);\n        }\n        \n        // Small delay to avoid rate limits\n        await new Promise(resolve => setTimeout(resolve, 100));\n      } catch (error) {\n        console.error(\"[Bot Name Pool] Error generating batch:\", error);\n        // Add fallback names if API fails\n        const fallbacks = this.generateFallbackNames(remaining);\n        allNames.push(...fallbacks);\n      }\n    }\n\n    // Remove duplicates and return\n    return Array.from(new Set(allNames)).slice(0, count);\n  }\n\n  private generateFallbackNames(count: number): string[] {\n    const firstNames = [\"alex\", \"sarah\", \"mike\", \"emma\", \"john\", \"lisa\", \"david\", \"maria\", \"chris\", \"anna\", \"james\", \"kate\"];\n    const styles = [\"_dev\", \"_pro\", \"_fast\", \"_code\", \"_type\", \"123\", \"2024\", \"_gamer\", \"_quick\", \"_star\"];\n    const names: string[] = [];\n\n    for (let i = 0; i < count; i++) {\n      const first = firstNames[Math.floor(Math.random() * firstNames.length)];\n      const style = styles[Math.floor(Math.random() * styles.length)];\n      names.push(`${first}${style}`);\n    }\n\n    return names;\n  }\n\n  getRandomNames(count: number): string[] {\n    if (!this.isInitialized || this.namePool.length === 0) {\n      console.warn(\"[Bot Name Pool] Not initialized, using fallback names\");\n      return this.generateFallbackNames(count);\n    }\n\n    const selected: string[] = [];\n    const availableIndices = this.namePool\n      .map((_, index) => index)\n      .filter(index => !this.usedNamesIndex.has(index));\n\n    // If we've used too many names, reset the used set\n    if (availableIndices.length < count) {\n      this.usedNamesIndex.clear();\n      availableIndices.push(...this.namePool.map((_, index) => index));\n    }\n\n    // Randomly select from available names\n    for (let i = 0; i < count && availableIndices.length > 0; i++) {\n      const randomIdx = Math.floor(Math.random() * availableIndices.length);\n      const nameIndex = availableIndices[randomIdx];\n      \n      selected.push(this.namePool[nameIndex]);\n      this.usedNamesIndex.add(nameIndex);\n      availableIndices.splice(randomIdx, 1);\n    }\n\n    // Trigger background refresh if running low\n    if (this.usedNamesIndex.size > POOL_SIZE - REFRESH_THRESHOLD && !this.isRefreshing) {\n      this.refreshPoolInBackground();\n    }\n\n    return selected;\n  }\n\n  private async refreshPoolInBackground() {\n    this.isRefreshing = true;\n    console.log(\"[Bot Name Pool] Refreshing pool in background...\");\n    \n    try {\n      const newNames = await this.generateRealisticNames(POOL_SIZE);\n      this.namePool = newNames;\n      this.usedNamesIndex.clear();\n      console.log(\"[Bot Name Pool] Successfully refreshed with\", newNames.length, \"new names\");\n    } catch (error) {\n      console.error(\"[Bot Name Pool] Failed to refresh pool:\", error);\n    } finally {\n      this.isRefreshing = false;\n    }\n  }\n}\n\nexport const botNamePool = new BotNamePool();\n","path":null,"size_bytes":5230,"size_tokens":null},"server/file-analyzer.ts":{"content":"import OpenAI from \"openai\";\nimport mammoth from \"mammoth\";\n\nconst openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY,\n});\n\nexport async function analyzeImage(buffer: Buffer, mimeType: string): Promise<string> {\n  try {\n    const base64Image = buffer.toString('base64');\n    const dataUrl = `data:${mimeType};base64,${base64Image}`;\n\n    console.log(\"[File Analyzer] Analyzing image with GPT-4o Vision...\");\n    \n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o\",\n      messages: [\n        {\n          role: \"user\",\n          content: [\n            {\n              type: \"text\",\n              text: `Analyze this image concisely:\n1. What it shows (main subject, key elements)\n2. Any text visible (transcribe exactly)\n3. Key data/information if chart/diagram/document\n4. Important insights or actionable details\n\nKeep response focused and useful.`\n            },\n            {\n              type: \"image_url\",\n              image_url: {\n                url: dataUrl,\n                detail: \"auto\"\n              },\n            },\n          ],\n        },\n      ],\n      max_tokens: 1000,\n    });\n\n    const analysis = response.choices[0]?.message?.content || \"Unable to analyze image\";\n    console.log(\"[File Analyzer] Image analysis complete\");\n    return analysis;\n  } catch (error) {\n    console.error(\"[File Analyzer] Image analysis error:\", error);\n    throw new Error(`Image analysis failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\nexport async function analyzePDF(buffer: Buffer): Promise<string> {\n  let parser: any = null;\n  \n  try {\n    console.log(\"[File Analyzer] Extracting PDF content...\");\n    \n    const { PDFParse } = await import(\"pdf-parse\");\n    \n    const uint8Array = new Uint8Array(buffer);\n    parser = new PDFParse({ data: uint8Array });\n    \n    const result = await parser.getText();\n    const rawText = result.text?.trim() || \"\";\n\n    if (!rawText) {\n      return \"PDF appears to be empty or contains only images. Please try uploading an image version of the document for visual analysis.\";\n    }\n\n    const textForAnalysis = rawText.substring(0, 8000);\n    const pageCount = result.total || result.pages?.length || 1;\n    \n    console.log(`[File Analyzer] Extracted ${textForAnalysis.length} chars from ${pageCount} pages, sending to GPT-4o for analysis...`);\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        {\n          role: \"user\",\n          content: `Analyze this document (${pageCount} pages):\n\n${textForAnalysis}\n${rawText.length > 8000 ? \"\\n[Truncated]\" : \"\"}\n\nProvide:\n1. Document type and main topic\n2. Key points and important data\n3. Notable findings or insights\n4. Action items if applicable\n\nBe concise and focus on what matters.`\n        }\n      ],\n      max_tokens: 1200,\n      temperature: 0.2,\n    });\n\n    const aiAnalysis = response.choices[0]?.message?.content || \"\";\n    console.log(\"[File Analyzer] PDF analysis complete\");\n\n    return aiAnalysis;\n  } catch (error) {\n    console.error(\"[File Analyzer] PDF analysis error:\", error);\n    throw new Error(`PDF analysis failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  } finally {\n    if (parser && typeof parser.destroy === 'function') {\n      try {\n        await parser.destroy();\n      } catch (e) {\n        console.log(\"[File Analyzer] Parser cleanup completed\");\n      }\n    }\n  }\n}\n\nexport async function analyzeWordDocument(buffer: Buffer): Promise<string> {\n  try {\n    console.log(\"[File Analyzer] Extracting Word document content...\");\n    \n    const result = await mammoth.extractRawText({ buffer });\n    const rawText = result.value.trim();\n\n    if (!rawText) {\n      return \"Word document appears to be empty.\";\n    }\n\n    const textForAnalysis = rawText.substring(0, 8000);\n    \n    console.log(`[File Analyzer] Extracted ${textForAnalysis.length} chars, sending to GPT-4o-mini for analysis...`);\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        {\n          role: \"user\",\n          content: `Analyze this document:\n\n${textForAnalysis}\n${rawText.length > 8000 ? \"\\n[Truncated]\" : \"\"}\n\nProvide:\n1. Document type and main topic\n2. Key points and important information\n3. Notable findings or insights\n4. Action items if applicable\n\nBe concise and focus on what matters.`\n        }\n      ],\n      max_tokens: 1200,\n      temperature: 0.2,\n    });\n\n    const aiAnalysis = response.choices[0]?.message?.content || \"\";\n    console.log(\"[File Analyzer] Word document analysis complete\");\n\n    return aiAnalysis;\n  } catch (error) {\n    console.error(\"[File Analyzer] Word document analysis error:\", error);\n    throw new Error(`Word document analysis failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\nexport async function analyzeTextFile(buffer: Buffer): Promise<string> {\n  try {\n    console.log(\"[File Analyzer] Processing text file...\");\n    \n    const rawText = buffer.toString('utf-8').trim();\n\n    if (!rawText) {\n      return \"Text file appears to be empty.\";\n    }\n\n    const textForAnalysis = rawText.substring(0, 8000);\n\n    const isCode = /^(import |from |const |let |var |function |class |def |public |private |#include|package |using )/.test(rawText) ||\n                   rawText.includes('function(') || rawText.includes('=>') || rawText.includes('{}');\n\n    console.log(`[File Analyzer] Text file detected as ${isCode ? 'code' : 'text'}, sending to GPT-4o-mini...`);\n\n    const prompt = isCode ? \n      `Analyze this code:\n\n${textForAnalysis}\n${rawText.length > 8000 ? \"\\n[Truncated]\" : \"\"}\n\nProvide:\n1. Language and purpose\n2. Main functions/components\n3. Key logic and what it does\n4. Any issues or improvements\n\nBe concise.` :\n      `Analyze this text:\n\n${textForAnalysis}\n${rawText.length > 8000 ? \"\\n[Truncated]\" : \"\"}\n\nProvide:\n1. Content type and topic\n2. Key points\n3. Notable information\n4. Insights\n\nBe concise.`;\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        { role: \"user\", content: prompt }\n      ],\n      max_tokens: 1000,\n      temperature: 0.2,\n    });\n\n    const aiAnalysis = response.choices[0]?.message?.content || \"\";\n    console.log(\"[File Analyzer] Text file analysis complete\");\n\n    return aiAnalysis;\n  } catch (error) {\n    console.error(\"[File Analyzer] Text file analysis error:\", error);\n    throw new Error(`Text file analysis failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\nexport async function analyzeFile(file: any): Promise<string> {\n  const { buffer, mimetype, originalname } = file;\n  const fileSize = buffer.length;\n  const fileSizeKB = (fileSize / 1024).toFixed(1);\n\n  console.log(`[File Analyzer] Starting analysis of \"${originalname}\" (${fileSizeKB} KB, ${mimetype})`);\n\n  try {\n    let analysis: string;\n\n    if (mimetype.startsWith('image/')) {\n      analysis = await analyzeImage(buffer, mimetype);\n    } else if (mimetype === 'application/pdf') {\n      analysis = await analyzePDF(buffer);\n    } else if (\n      mimetype === 'application/msword' ||\n      mimetype === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'\n    ) {\n      analysis = await analyzeWordDocument(buffer);\n    } else if (mimetype === 'text/plain') {\n      analysis = await analyzeTextFile(buffer);\n    } else {\n      throw new Error(`Unsupported file type: ${mimetype}`);\n    }\n\n    return `# File Analysis: ${originalname}\\n\\n${analysis}`;\n  } catch (error) {\n    console.error(`[File Analyzer] Error analyzing file ${originalname}:`, error);\n    throw error;\n  }\n}\n","path":null,"size_bytes":7679,"size_tokens":null},"server/ai-code-generator.ts":{"content":"import OpenAI from \"openai\";\n\nconst openai = new OpenAI({\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY\n});\n\ninterface GenerateCodeOptions {\n  programmingLanguage: string;\n  difficulty?: \"easy\" | \"medium\" | \"hard\";\n  framework?: string;\n  timeLimit?: number;\n  testMode?: \"normal\" | \"expert\" | \"master\";\n}\n\nfunction getTargetLineCount(\n  difficulty: \"easy\" | \"medium\" | \"hard\",\n  timeLimit: number\n): string {\n  // Large base line counts for substantial initial content\n  const baseLines = {\n    easy: { min: 20, max: 30 },\n    medium: { min: 25, max: 40 },\n    hard: { min: 35, max: 55 }\n  };\n\n  // Adjust based on time limit (0 = no limit, use default)\n  if (timeLimit === 0) {\n    // No limit - use generous size for continuous typing\n    return `${baseLines[difficulty].min}-${baseLines[difficulty].max}`;\n  }\n\n  // Calculate target based on time - high multipliers for lots of content\n  let multiplier = 1;\n  if (timeLimit <= 15) {\n    multiplier = 0.8;\n  } else if (timeLimit <= 30) {\n    multiplier = 1.0;\n  } else if (timeLimit <= 45) {\n    multiplier = 1.2;\n  } else if (timeLimit <= 60) {\n    multiplier = 1.4;\n  } else if (timeLimit <= 120) {\n    multiplier = 1.8;\n  } else if (timeLimit <= 180) {\n    multiplier = 2.2;\n  } else if (timeLimit <= 300) {\n    multiplier = 2.8;\n  } else {\n    multiplier = 3.5;\n  }\n\n  const minLines = Math.max(15, Math.round(baseLines[difficulty].min * multiplier));\n  const maxLines = Math.max(20, Math.round(baseLines[difficulty].max * multiplier));\n\n  return `${minLines}-${maxLines}`;\n}\n\nfunction getTargetCharacterCount(timeLimit: number): string {\n  // Provide lots of content so users always have plenty to type\n  \n  if (timeLimit === 0) {\n    return \"800-1200\"; // No limit, lots of content for continuous typing\n  }\n  \n  // Calculate based on ~180 chars per minute (plenty of content)\n  // We want MORE content than user can type so they always have something\n  const charsPerMinute = 180;\n  const targetChars = Math.round((timeLimit / 60) * charsPerMinute);\n  \n  // Give a generous range with high minimum\n  const minChars = Math.max(300, Math.round(targetChars * 1.0));\n  const maxChars = Math.max(500, Math.round(targetChars * 1.6));\n  \n  return `${minChars}-${maxChars}`;\n}\n\nexport async function generateCodeSnippet(\n  programmingLanguage: string,\n  difficulty: \"easy\" | \"medium\" | \"hard\" = \"medium\",\n  framework?: string,\n  timeLimit: number = 0,\n  testMode: \"normal\" | \"expert\" | \"master\" = \"normal\",\n  customPrompt?: string\n): Promise<{ content: string; description: string }> {\n  const lineCount = getTargetLineCount(difficulty, timeLimit);\n  const charCount = getTargetCharacterCount(timeLimit);\n\n  const frameworkNote = framework ? ` using the ${framework} framework` : '';\n  \n  const difficultyContext = {\n    easy: \"Basic syntax, simple logic, beginner-friendly concepts. Use common keywords and straightforward patterns.\",\n    medium: \"Moderate complexity with common patterns, intermediate concepts. Include loops, conditions, and function calls.\",\n    hard: \"Advanced patterns, complex logic, algorithms, and optimization. Include nested structures, callbacks, or async patterns.\"\n  }[difficulty];\n\n  // Test mode affects code quality requirements\n  const testModeContext = {\n    normal: \"Standard code with typical patterns. Minor complexity is acceptable.\",\n    expert: \"Clean, well-structured code. Every character must be intentional. No ambiguous syntax.\",\n    master: \"Perfect, production-ready code. Crystal clear syntax, optimal formatting. Zero room for typing ambiguity.\"\n  }[testMode];\n\n  const markupLanguages = [\"HTML\", \"XML\", \"Markdown\", \"markup\"];\n  const dataFormats = [\"JSON\", \"YAML\", \"TOML\", \"json\", \"yaml\", \"toml\"];\n  const styleLanguages = [\"CSS\", \"SCSS\", \"Sass\", \"Less\", \"css\", \"scss\", \"sass\", \"less\"];\n  \n  const isMarkup = markupLanguages.some(l => programmingLanguage.toLowerCase().includes(l.toLowerCase()));\n  const isDataFormat = dataFormats.some(l => programmingLanguage.toLowerCase().includes(l.toLowerCase()));\n  const isStyle = styleLanguages.some(l => programmingLanguage.toLowerCase().includes(l.toLowerCase()));\n\n  let languageSpecificGuidance = \"\";\n  if (isMarkup) {\n    languageSpecificGuidance = `\nSpecial guidance for ${programmingLanguage}:\n- Focus on proper document structure with well-formed tags/elements\n- Include semantic elements and proper nesting\n- Use appropriate attributes and values\n- Create realistic content structure (forms, lists, sections, etc.)`;\n  } else if (isDataFormat) {\n    languageSpecificGuidance = `\nSpecial guidance for ${programmingLanguage}:\n- Create realistic data structures (configuration, API response, data model)\n- Use proper syntax and formatting\n- Include nested structures, arrays, and various data types\n- Make the data meaningful and realistic`;\n  } else if (isStyle) {\n    languageSpecificGuidance = `\nSpecial guidance for ${programmingLanguage}:\n- Focus on realistic styling rules for common UI components\n- Include selectors, properties, and values\n- Use modern ${programmingLanguage} features (variables, nesting, mixins as appropriate)\n- Create cohesive styling for a realistic component`;\n  }\n\n  // Time-specific guidance\n  let timingGuidance = \"\";\n  if (timeLimit > 0) {\n    if (timeLimit <= 30) {\n      timingGuidance = `\\nIMPORTANT: This is a SHORT ${timeLimit}-second test. Keep code VERY concise (${charCount} characters). Focus on a single, clear concept.`;\n    } else if (timeLimit <= 60) {\n      timingGuidance = `\\nThis is a ${timeLimit}-second test. Target ${charCount} characters. Keep it focused but complete.`;\n    } else if (timeLimit <= 180) {\n      timingGuidance = `\\nThis is a ${Math.round(timeLimit/60)}-minute test. Target ${charCount} characters. Include a complete, functional code segment.`;\n    } else {\n      timingGuidance = `\\nThis is a longer ${Math.round(timeLimit/60)}-minute test. Target ${charCount} characters. Create a comprehensive code example with multiple concepts.`;\n    }\n  }\n\n  // Custom prompt from user\n  const customPromptGuidance = customPrompt \n    ? `\\n\\nðŸŽ¯ USER'S CUSTOM REQUEST:\\nThe user specifically wants code about: \"${customPrompt}\"\\nGenerate code that directly addresses this request while maintaining ${programmingLanguage} syntax and the specified difficulty level.`\n    : '';\n\n  const prompt = `Generate a ${difficulty}-level ${programmingLanguage} code snippet${frameworkNote} for typing practice.${customPromptGuidance}\n\nâš ï¸ CRITICAL LENGTH REQUIREMENT - THIS IS MANDATORY:\n- You MUST generate AT LEAST ${charCount} characters of code\n- You MUST generate AT LEAST ${lineCount} lines of code\n- DO NOT generate less than the minimum. If unsure, generate MORE.\n- This is a typing test - users need LOTS of code to practice with.\n\nTEST CONFIGURATION:\n- Difficulty: ${difficulty.toUpperCase()} - ${difficultyContext}\n- Test Mode: ${testMode.toUpperCase()} - ${testModeContext}\n- MINIMUM Length: ${lineCount} lines, ${charCount} characters (generate AT LEAST this much)\n${timingGuidance}\n\nCODE REQUIREMENTS:\n1. Write AT LEAST ${lineCount} lines of actual, functional ${programmingLanguage} code${frameworkNote}\n2. Generate AT LEAST ${charCount} total characters - this is the MINIMUM\n3. Use proper syntax, consistent 2-space indentation\n4. Include realistic variable names following ${programmingLanguage} conventions\n5. Create a complete, realistic code example (not just a tiny snippet)\n6. ${testMode === 'master' ? 'CRITICAL: Every character must be precise. No unusual formatting.' : testMode === 'expert' ? 'Ensure clean, unambiguous syntax throughout.' : 'Use standard code patterns.'}\n${languageSpecificGuidance}\n\n${framework ? `Framework-specific requirements:\n- Use ${framework}-specific syntax and patterns\n- Include common ${framework} APIs or functions\n- Follow ${framework} best practices and conventions\n` : ''}\n\nGENERATE A COMPLETE CODE EXAMPLE such as:\n- A complete function with multiple operations\n- A class with several methods\n- Multiple related functions working together\n- An algorithm implementation with helper functions\n\nReturn the code snippet in this JSON format:\n{\n  \"code\": \"the actual code here (properly formatted with newlines)\",\n  \"description\": \"brief 1-sentence description of what this code does\"\n}\n\nReturn ONLY valid JSON. Remember: MINIMUM ${charCount} characters!`;\n\n  try {\n    console.log(`ðŸ”§ Generating ${difficulty} ${programmingLanguage} snippet (${timeLimit}s, ${testMode} mode) - Target: ${charCount} chars, ${lineCount} lines`);\n    \n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [{ role: \"user\", content: prompt }],\n      max_tokens: 4000, // Increased for longer code snippets\n      temperature: 0.7,\n      response_format: { type: \"json_object\" }\n    });\n\n    const content = response.choices[0]?.message?.content?.trim() || \"\";\n    \n    if (!content) {\n      throw new Error(\"AI generated empty content\");\n    }\n\n    const parsed = JSON.parse(content);\n    const code = parsed.code || parsed.content || \"\";\n    const description = parsed.description || `${programmingLanguage} code snippet`;\n\n    if (!code) {\n      throw new Error(\"No code in AI response\");\n    }\n\n    const generatedLines = code.split('\\n').length;\n    const generatedChars = code.length;\n    console.log(`âœ… Generated ${generatedLines} lines, ${generatedChars} chars of ${programmingLanguage} code`);\n    \n    return {\n      content: code,\n      description: description\n    };\n  } catch (error: any) {\n    console.error(\"âŒ AI code generation error:\", error.message || error);\n    if (error.response) {\n      console.error(\"API Error Response:\", error.response.data);\n    }\n    throw error;\n  }\n}\n","path":null,"size_bytes":9757,"size_tokens":null},"client/src/pages/code-leaderboard.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Trophy, Code, Zap, Target, Medal, AlertCircle, RefreshCw } from \"lucide-react\";\nimport { Avatar } from \"@/components/ui/avatar\";\nimport { Button } from \"@/components/ui/button\";\nimport { ErrorBoundary } from \"@/components/error-boundary\";\n\nconst PROGRAMMING_LANGUAGES = {\n  all: \"All Languages\",\n  javascript: \"JavaScript\",\n  typescript: \"TypeScript\",\n  python: \"Python\",\n  java: \"Java\",\n  go: \"Go\",\n  rust: \"Rust\",\n  csharp: \"C#\",\n};\n\nfunction CodeLeaderboardContent() {\n  const [selectedLanguage, setSelectedLanguage] = useState<string>(\"all\");\n  const [offset, setOffset] = useState(0);\n  const limit = 20;\n\n  const { data: leaderboardData, isLoading, isError, error, refetch, isFetching } = useQuery({\n    queryKey: [\"codeLeaderboard\", selectedLanguage, offset, limit],\n    queryFn: async () => {\n      const params = new URLSearchParams({ limit: String(limit), offset: String(offset) });\n      if (selectedLanguage !== \"all\") params.set(\"language\", selectedLanguage);\n      const response = await fetch(`/api/code/leaderboard?${params}`);\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.message || \"Failed to fetch code leaderboard\");\n      }\n      return response.json();\n    },\n    retry: 2,\n  });\n\n  const leaderboard = leaderboardData?.entries || [];\n  const pagination = leaderboardData?.pagination || { total: 0, hasMore: false };\n\n  const handleLanguageChange = (language: string) => {\n    setSelectedLanguage(language);\n    setOffset(0);\n  };\n\n  return (\n    <div className=\"container mx-auto py-8 px-4 max-w-5xl\">\n      <div className=\"mb-8 text-center\">\n        <div className=\"flex items-center justify-center gap-3 mb-4\">\n          <Trophy className=\"w-10 h-10 text-yellow-500\" />\n          <h1 className=\"text-4xl font-bold\">Code Typing Leaderboard</h1>\n        </div>\n        <p className=\"text-muted-foreground text-lg\">\n          Top developers ranked by code typing speed and accuracy\n        </p>\n      </div>\n\n      <Card className=\"mb-6\">\n        <CardHeader>\n          <div className=\"flex items-center justify-between flex-wrap gap-4\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <Code className=\"w-5 h-5\" />\n              Developer Rankings\n            </CardTitle>\n            <div className=\"flex items-center gap-2\">\n              <label className=\"text-sm font-medium\">Filter by Language:</label>\n              <Select value={selectedLanguage} onValueChange={handleLanguageChange}>\n                <SelectTrigger className=\"w-[180px]\" data-testid=\"select-language-filter\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {Object.entries(PROGRAMMING_LANGUAGES).map(([key, name]) => (\n                    <SelectItem key={key} value={key}>{name}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n          <CardDescription>\n            Global rankings for code typing performance\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isError ? (\n            <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n              <AlertCircle className=\"w-12 h-12 text-destructive mb-4\" />\n              <p className=\"text-lg font-medium text-destructive mb-2\">Failed to load leaderboard</p>\n              <p className=\"text-sm text-muted-foreground mb-4\">\n                {error instanceof Error ? error.message : \"An unexpected error occurred\"}\n              </p>\n              <Button \n                variant=\"outline\" \n                onClick={() => refetch()}\n                disabled={isFetching}\n                data-testid=\"retry-button\"\n              >\n                <RefreshCw className={`w-4 h-4 mr-2 ${isFetching ? 'animate-spin' : ''}`} />\n                Try Again\n              </Button>\n            </div>\n          ) : isLoading ? (\n            <div className=\"text-center py-12\">\n              <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto\"></div>\n              <p className=\"text-muted-foreground mt-4\">Loading leaderboard...</p>\n            </div>\n          ) : leaderboard.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <Code className=\"w-16 h-16 text-muted-foreground mx-auto mb-4\" />\n              <p className=\"text-muted-foreground\">\n                No code typing tests recorded yet for this language.\n              </p>\n              <p className=\"text-sm text-muted-foreground mt-2\">\n                Be the first to set a record!\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-2\">\n              {leaderboard.map((entry: any, index: number) => (\n                <div\n                  key={`${entry.userId}-${index}`}\n                  className={`flex items-center gap-4 p-4 rounded-lg transition-colors ${\n                    index === 0\n                      ? \"bg-gradient-to-r from-yellow-500/10 to-yellow-600/10 border-2 border-yellow-500/30\"\n                      : index === 1\n                      ? \"bg-gradient-to-r from-gray-400/10 to-gray-500/10 border-2 border-gray-400/30\"\n                      : index === 2\n                      ? \"bg-gradient-to-r from-orange-600/10 to-orange-700/10 border-2 border-orange-600/30\"\n                      : \"bg-muted/30 hover:bg-muted/50\"\n                  }`}\n                  data-testid={`leaderboard-entry-${index}`}\n                >\n                  <div className=\"flex-shrink-0 w-12 text-center\">\n                    {index === 0 && <Medal className=\"w-8 h-8 text-yellow-500 mx-auto\" />}\n                    {index === 1 && <Medal className=\"w-8 h-8 text-gray-400 mx-auto\" />}\n                    {index === 2 && <Medal className=\"w-8 h-8 text-orange-600 mx-auto\" />}\n                    {index > 2 && <span className=\"text-2xl font-bold text-muted-foreground\">#{index + 1}</span>}\n                  </div>\n\n                  <Avatar className={`w-12 h-12 flex items-center justify-center ${entry.avatarColor || \"bg-primary\"}`}>\n                    <span className=\"text-xl font-bold text-white\">\n                      {entry.username.charAt(0).toUpperCase()}\n                    </span>\n                  </Avatar>\n\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"font-semibold truncate\" data-testid={`username-${index}`}>\n                      {entry.username}\n                    </div>\n                    <div className=\"text-sm text-muted-foreground flex items-center gap-4 flex-wrap\">\n                      <span className=\"flex items-center gap-1\">\n                        <Code className=\"w-3 h-3\" />\n                        {entry.programmingLanguage}\n                        {entry.framework && ` (${entry.framework})`}\n                      </span>\n                      <span>{entry.totalTests} tests</span>\n                    </div>\n                  </div>\n\n                  <div className=\"flex items-center gap-6\">\n                    <div className=\"text-center\">\n                      <div className=\"flex items-center gap-1 text-sm text-muted-foreground mb-1\">\n                        <Zap className=\"w-4 h-4\" /> WPM\n                      </div>\n                      <div className=\"text-2xl font-bold text-primary\" data-testid={`wpm-${index}`}>\n                        {entry.wpm}\n                      </div>\n                    </div>\n                    <div className=\"text-center\">\n                      <div className=\"flex items-center gap-1 text-sm text-muted-foreground mb-1\">\n                        <Target className=\"w-4 h-4\" /> Accuracy\n                      </div>\n                      <div className=\"text-2xl font-bold\" data-testid={`accuracy-${index}`}>\n                        {entry.accuracy}%\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      <Card className=\"bg-primary/5 border-primary/20\">\n        <CardContent className=\"p-6\">\n          <div className=\"text-center\">\n            <h3 className=\"font-semibold mb-2\">Want to join the leaderboard?</h3>\n            <p className=\"text-sm text-muted-foreground mb-4\">\n              Practice your code typing skills and compete with developers worldwide!\n            </p>\n            <a\n              href=\"/code-mode\"\n              className=\"inline-flex items-center gap-2 px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors font-semibold\"\n              data-testid=\"button-start-typing\"\n            >\n              <Code className=\"w-4 h-4\" />\n              Start Code Typing\n            </a>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nexport default function CodeLeaderboard() {\n  return (\n    <ErrorBoundary>\n      <CodeLeaderboardContent />\n    </ErrorBoundary>\n  );\n}\n","path":null,"size_bytes":9362,"size_tokens":null},"client/src/pages/code-mode.tsx":{"content":"import { useState, useEffect, useRef, useCallback, useMemo } from \"react\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Input } from \"@/components/ui/input\";\nimport { Code, RotateCcw, Share2, Copy, Facebook, Twitter, Linkedin, MessageCircle, HelpCircle, Zap, Check, Image, Link2, Download, Send, Mail, Award, X, Infinity, Sparkles, Settings, Volume2, VolumeX, Eye, EyeOff, Terminal } from \"lucide-react\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport confetti from \"canvas-confetti\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport { CodeShareCard } from \"@/components/CodeShareCard\";\nimport { CodeCertificate } from \"@/components/CodeCertificate\";\nimport { keyboardSound } from \"@/lib/keyboard-sounds\";\n\nconst PROGRAMMING_LANGUAGES = {\n  javascript: { name: \"JavaScript\", prism: \"javascript\", category: \"Popular\" },\n  typescript: { name: \"TypeScript\", prism: \"typescript\", category: \"Popular\" },\n  python: { name: \"Python\", prism: \"python\", category: \"Popular\" },\n  java: { name: \"Java\", prism: \"java\", category: \"Popular\" },\n  cpp: { name: \"C++\", prism: \"cpp\", category: \"Popular\" },\n  csharp: { name: \"C#\", prism: \"csharp\", category: \"Popular\" },\n  go: { name: \"Go\", prism: \"go\", category: \"Popular\" },\n  rust: { name: \"Rust\", prism: \"rust\", category: \"Popular\" },\n  swift: { name: \"Swift\", prism: \"swift\", category: \"Popular\" },\n  ruby: { name: \"Ruby\", prism: \"ruby\", category: \"Popular\" },\n  \n  php: { name: \"PHP\", prism: \"php\", category: \"Web Development\" },\n  html: { name: \"HTML\", prism: \"markup\", category: \"Web Development\" },\n  css: { name: \"CSS\", prism: \"css\", category: \"Web Development\" },\n  scss: { name: \"SCSS\", prism: \"scss\", category: \"Web Development\" },\n  sass: { name: \"Sass\", prism: \"sass\", category: \"Web Development\" },\n  less: { name: \"Less\", prism: \"less\", category: \"Web Development\" },\n  jsx: { name: \"JSX\", prism: \"jsx\", category: \"Web Development\" },\n  tsx: { name: \"TSX\", prism: \"tsx\", category: \"Web Development\" },\n  \n  kotlin: { name: \"Kotlin\", prism: \"kotlin\", category: \"Mobile & JVM\" },\n  dart: { name: \"Dart\", prism: \"dart\", category: \"Mobile & JVM\" },\n  scala: { name: \"Scala\", prism: \"scala\", category: \"Mobile & JVM\" },\n  groovy: { name: \"Groovy\", prism: \"groovy\", category: \"Mobile & JVM\" },\n  objectivec: { name: \"Objective-C\", prism: \"objectivec\", category: \"Mobile & JVM\" },\n  \n  c: { name: \"C\", prism: \"c\", category: \"Systems Programming\" },\n  zig: { name: \"Zig\", prism: \"c\", category: \"Systems Programming\" },\n  vhdl: { name: \"VHDL\", prism: \"vhdl\", category: \"Systems Programming\" },\n  \n  r: { name: \"R\", prism: \"r\", category: \"Data Science\" },\n  julia: { name: \"Julia\", prism: \"julia\", category: \"Data Science\" },\n  matlab: { name: \"MATLAB\", prism: \"matlab\", category: \"Data Science\" },\n  \n  bash: { name: \"Bash/Shell\", prism: \"bash\", category: \"Scripting\" },\n  powershell: { name: \"PowerShell\", prism: \"powershell\", category: \"Scripting\" },\n  perl: { name: \"Perl\", prism: \"perl\", category: \"Scripting\" },\n  lua: { name: \"Lua\", prism: \"lua\", category: \"Scripting\" },\n  \n  elixir: { name: \"Elixir\", prism: \"elixir\", category: \"Functional\" },\n  haskell: { name: \"Haskell\", prism: \"haskell\", category: \"Functional\" },\n  clojure: { name: \"Clojure\", prism: \"clojure\", category: \"Functional\" },\n  fsharp: { name: \"F#\", prism: \"fsharp\", category: \"Functional\" },\n  ocaml: { name: \"OCaml\", prism: \"ocaml\", category: \"Functional\" },\n  erlang: { name: \"Erlang\", prism: \"erlang\", category: \"Functional\" },\n  scheme: { name: \"Scheme\", prism: \"scheme\", category: \"Functional\" },\n  racket: { name: \"Racket\", prism: \"racket\", category: \"Functional\" },\n  lisp: { name: \"Lisp\", prism: \"lisp\", category: \"Functional\" },\n  \n  sql: { name: \"SQL\", prism: \"sql\", category: \"Database\" },\n  \n  json: { name: \"JSON\", prism: \"json\", category: \"Data Formats\" },\n  yaml: { name: \"YAML\", prism: \"yaml\", category: \"Data Formats\" },\n  toml: { name: \"TOML\", prism: \"toml\", category: \"Data Formats\" },\n  xml: { name: \"XML\", prism: \"markup\", category: \"Data Formats\" },\n  markdown: { name: \"Markdown\", prism: \"markdown\", category: \"Data Formats\" },\n  \n  fortran: { name: \"Fortran\", prism: \"fortran\", category: \"Other\" },\n  nim: { name: \"Nim\", prism: \"nim\", category: \"Other\" },\n  crystal: { name: \"Crystal\", prism: \"crystal\", category: \"Other\" },\n  d: { name: \"D\", prism: \"d\", category: \"Other\" },\n  solidity: { name: \"Solidity\", prism: \"solidity\", category: \"Other\" },\n  pascal: { name: \"Pascal\", prism: \"pascal\", category: \"Other\" },\n};\n\nconst DIFFICULTIES = [\n  { value: \"easy\", label: \"Easy\" },\n  { value: \"medium\", label: \"Medium\" },\n  { value: \"hard\", label: \"Hard\" },\n];\n\nconst TEST_MODES = [\n  { value: \"normal\", label: \"Normal\", description: \"Standard practice mode\" },\n  { value: \"expert\", label: \"Expert\", description: \"Fail on any error\" },\n  { value: \"master\", label: \"Master\", description: \"100% accuracy required\" },\n];\n\nconst TIME_OPTIONS = [\n  { value: 0, label: \"No Limit\" },\n  { value: 15, label: \"15s\" },\n  { value: 30, label: \"30s\" },\n  { value: 45, label: \"45s\" },\n  { value: 60, label: \"1:00\" },\n  { value: 90, label: \"1:30\" },\n  { value: 120, label: \"2:00\" },\n  { value: 180, label: \"3:00\" },\n  { value: 300, label: \"5:00\" },\n  { value: 600, label: \"10:00\" },\n  { value: 900, label: \"15:00\" },\n  { value: 1200, label: \"20:00\" },\n  { value: 1800, label: \"30:00\" },\n];\n\nfunction formatTime(seconds: number): string {\n  const mins = Math.floor(seconds / 60);\n  const secs = seconds % 60;\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\n}\n\n// Normalize code snippets: remove Windows line endings and trailing whitespace\nfunction normalizeCodeSnippet(code: string): string {\n  return code.replace(/\\r\\n/g, '\\n').replace(/\\r/g, '\\n').trimEnd();\n}\n\nexport default function CodeMode() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const [language, setLanguage] = useState(\"javascript\");\n  const [difficulty, setDifficulty] = useState<\"easy\" | \"medium\" | \"hard\">(\"easy\");\n  const [mode, setMode] = useState<\"ai\" | \"custom\">(\"ai\");\n  const [testMode, setTestMode] = useState<\"normal\" | \"expert\" | \"master\">(\"normal\");\n  const [timeLimit, setTimeLimit] = useState(60); // Default 1 minute\n  const [customCode, setCustomCode] = useState(\"\");\n  const [codeSnippet, setCodeSnippet] = useState(\"\");\n  const [snippetId, setSnippetId] = useState<number | null>(null);\n  const [userInput, setUserInput] = useState(\"\");\n  const [startTime, setStartTime] = useState<number | null>(null);\n  const [isActive, setIsActive] = useState(false);\n  const [isFinished, setIsFinished] = useState(false);\n  const [isFailed, setIsFailed] = useState(false);\n  const [wpm, setWpm] = useState(0);\n  const [rawWpm, setRawWpm] = useState(0);\n  const [accuracy, setAccuracy] = useState(100);\n  const [consistency, setConsistency] = useState(100);\n  const [errors, setErrors] = useState(0);\n  const [isLoading, setIsLoading] = useState(false);\n  const [shareDialogOpen, setShareDialogOpen] = useState(false);\n  const [completionDialogOpen, setCompletionDialogOpen] = useState(false);\n  const [shareUrl, setShareUrl] = useState(\"\");\n  const [elapsedTime, setElapsedTime] = useState(0);\n  const [isComposing, setIsComposing] = useState(false);\n  const [isFocused, setIsFocused] = useState(false);\n  const [errorState, setErrorState] = useState<{\n    type: 'network' | 'server' | 'generation' | 'timeout' | null;\n    message: string;\n    canRetry: boolean;\n  }>({ type: null, message: '', canRetry: false });\n  const [retryCount, setRetryCount] = useState(0);\n  const MAX_RETRIES = 3;\n  const [customPrompt, setCustomPrompt] = useState(\"\");\n  const [isLoadingMore, setIsLoadingMore] = useState(false);\n  const [infiniteMode, setInfiniteMode] = useState(false);\n  const [showCustomAI, setShowCustomAI] = useState(false);\n  \n  // Advanced settings\n  const [caretStyle, setCaretStyle] = useState<\"line\" | \"block\" | \"underline\">(\"line\");\n  const [showLineNumbers, setShowLineNumbers] = useState(true);\n  const [showIndentGuides, setShowIndentGuides] = useState(true);\n  const [smoothCaret, setSmoothCaret] = useState(true);\n  const [focusMode, setFocusMode] = useState(false);\n  const [soundEnabled, setSoundEnabled] = useState(() => keyboardSound.getSettings().enabled);\n  \n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const codeDisplayRef = useRef<HTMLDivElement>(null);\n  const abortControllerRef = useRef<AbortController | null>(null);\n  const timerRef = useRef<number | null>(null);\n  const wpmHistoryRef = useRef<number[]>([]);\n  const infiniteAbortRef = useRef<AbortController | null>(null);\n\n  const fetchCodeSnippet = useCallback(async (forceNew = true, isRetry = false) => {\n    if (abortControllerRef.current) {\n      abortControllerRef.current.abort();\n    }\n    \n    abortControllerRef.current = new AbortController();\n    const signal = abortControllerRef.current.signal;\n    \n    setIsLoading(true);\n    setErrorState({ type: null, message: '', canRetry: false });\n    \n    // Set timeout for the request (30 seconds)\n    const timeoutId = setTimeout(() => {\n      if (abortControllerRef.current) {\n        abortControllerRef.current.abort();\n      }\n    }, 30000);\n    \n    try {\n      const promptParam = customPrompt ? `&customPrompt=${encodeURIComponent(customPrompt)}` : '';\n      const response = await fetch(\n        `/api/code/snippet?language=${encodeURIComponent(language)}&difficulty=${encodeURIComponent(difficulty)}&timeLimit=${timeLimit}&testMode=${testMode}&generate=true&forceNew=${forceNew}${promptParam}`,\n        { signal, cache: 'no-store' }\n      );\n      \n      clearTimeout(timeoutId);\n      \n      if (signal.aborted) return;\n      \n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        const status = response.status;\n        \n        // Handle specific HTTP error codes\n        if (status === 429) {\n          throw { type: 'server', message: 'Too many requests. Please wait a moment before trying again.', canRetry: true };\n        } else if (status === 503 || status === 502) {\n          throw { type: 'server', message: 'AI service is temporarily unavailable. Please try again.', canRetry: true };\n        } else if (status === 500) {\n          throw { type: 'generation', message: 'Failed to generate code. Try a different language or difficulty.', canRetry: true };\n        } else if (status === 404) {\n          throw { type: 'generation', message: 'No snippets available for this language. Try another one.', canRetry: false };\n        } else {\n          throw { type: 'server', message: errorData.message || `Server error (${status})`, canRetry: true };\n        }\n      }\n      \n      const data = await response.json();\n      \n      if (signal.aborted) return;\n      \n      // Validate response data\n      if (!data.snippet || !data.snippet.content) {\n        throw { type: 'generation', message: 'Received empty code snippet. Please try again.', canRetry: true };\n      }\n      \n      // Success - clear error state and retry count\n      // Normalize snippet to remove Windows line endings and trailing whitespace\n      setCodeSnippet(normalizeCodeSnippet(data.snippet.content));\n      setSnippetId(data.snippet.id);\n      setErrorState({ type: null, message: '', canRetry: false });\n      setRetryCount(0);\n      \n      // Show success notification\n      const normalizedContent = normalizeCodeSnippet(data.snippet.content);\n      const lineCount = normalizedContent.split('\\n').length;\n      toast({\n        title: \"Code Ready!\",\n        description: `${lineCount} lines of ${language} code generated. Start typing!`,\n      });\n      \n    } catch (error: any) {\n      clearTimeout(timeoutId);\n      \n      if (error.name === 'AbortError') {\n        // Check if it was a timeout\n        if (!signal.aborted) {\n          setErrorState({ \n            type: 'timeout', \n            message: 'Request timed out. The AI might be busy. Please try again.', \n            canRetry: true \n          });\n        }\n        return;\n      }\n      \n      console.error(\"Error fetching code snippet:\", error);\n      \n      // Handle network errors\n      if (error instanceof TypeError && error.message.includes('fetch')) {\n        setErrorState({ \n          type: 'network', \n          message: 'Network error. Please check your connection and try again.', \n          canRetry: true \n        });\n      } else if (error.type) {\n        // Custom error object\n        setErrorState({ \n          type: error.type, \n          message: error.message, \n          canRetry: error.canRetry \n        });\n      } else {\n        setErrorState({ \n          type: 'server', \n          message: error.message || 'An unexpected error occurred.', \n          canRetry: true \n        });\n      }\n      \n      // Auto-retry logic for retryable errors\n      if (!isRetry && retryCount < MAX_RETRIES && (error.canRetry !== false)) {\n        setRetryCount(prev => prev + 1);\n        setTimeout(() => {\n          fetchCodeSnippet(forceNew, true);\n        }, 2000 * (retryCount + 1)); // Exponential backoff\n      } else {\n        toast({\n          title: \"Failed to Load Code Snippet\",\n          description: error.message || \"Unable to generate code snippet. Try a different language.\",\n          variant: \"destructive\",\n        });\n      }\n    } finally {\n      if (!signal.aborted) {\n        setIsLoading(false);\n      }\n    }\n  }, [language, difficulty, toast, retryCount]);\n  \n  useEffect(() => {\n    return () => {\n      if (abortControllerRef.current) {\n        abortControllerRef.current.abort();\n      }\n      if (timerRef.current) {\n        clearInterval(timerRef.current);\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (mode === \"ai\" && !codeSnippet && !isLoading) {\n      fetchCodeSnippet(false); // Use cached on initial load\n    }\n  }, [mode, codeSnippet, isLoading, fetchCodeSnippet]);\n\n  useEffect(() => {\n    if (isActive && startTime && !isFinished) {\n      timerRef.current = window.setInterval(() => {\n        const now = Date.now();\n        const elapsedMs = now - startTime;\n        const elapsed = Math.floor(elapsedMs / 1000);\n        setElapsedTime(elapsed);\n        \n        // Check if time limit reached\n        if (timeLimit > 0 && elapsed >= timeLimit) {\n          finishTest();\n          return;\n        }\n        \n        // Calculate real-time stats using industry-standard formulas\n        const minutes = elapsedMs / 60000; // Use milliseconds for precision\n        if (minutes > 0 && userInput.length > 0) {\n          // Count correct and incorrect characters\n          let correctChars = 0;\n          let errorChars = 0;\n          for (let i = 0; i < userInput.length; i++) {\n            if (userInput[i] === codeSnippet[i]) {\n              correctChars++;\n            } else {\n              errorChars++;\n            }\n          }\n          \n          // Raw WPM (Gross WPM) = (Total Characters / 5) / Minutes\n          // Industry standard: 1 word = 5 characters\n          const currentRawWpm = Math.round((userInput.length / 5) / minutes);\n          \n          // Net WPM = (Correct Characters / 5) / Minutes\n          // This is the effective typing speed accounting for errors\n          const currentWpm = Math.round((correctChars / 5) / minutes);\n          \n          setWpm(Math.max(0, currentWpm));\n          setRawWpm(Math.max(0, currentRawWpm));\n          \n          // Accuracy = (Correct Characters / Total Characters) Ã— 100\n          const currentAccuracy = Math.round((correctChars / userInput.length) * 100);\n          setAccuracy(currentAccuracy);\n          \n          // Track Net WPM history for consistency calculation (more accurate than Raw WPM)\n          // Sample every 500ms for better granularity\n          const sampleIndex = Math.floor(elapsedMs / 500);\n          if (wpmHistoryRef.current.length < sampleIndex && currentWpm > 0) {\n            wpmHistoryRef.current.push(currentWpm);\n          }\n          \n          // Consistency = based on Coefficient of Variation (CV)\n          // CV = (Standard Deviation / Mean) Ã— 100\n          // Consistency Score = 100 - CV (higher is more consistent)\n          // Skip first 2 samples (first second) for warm-up period\n          if (wpmHistoryRef.current.length >= 4) {\n            const samples = wpmHistoryRef.current.slice(2); // Skip warm-up\n            const mean = samples.reduce((a, b) => a + b, 0) / samples.length;\n            if (mean > 0) {\n              const variance = samples.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / samples.length;\n              const stdDev = Math.sqrt(variance);\n              const cv = (stdDev / mean) * 100; // Coefficient of variation\n              // Scale CV to be more meaningful - typical typing CV is 10-30%\n              const consistencyScore = Math.max(0, Math.min(100, 100 - (cv * 1.5)));\n              setConsistency(Math.round(consistencyScore));\n            }\n          } else if (wpmHistoryRef.current.length >= 2) {\n            // Fallback for shorter tests\n            const samples = wpmHistoryRef.current;\n            const mean = samples.reduce((a, b) => a + b, 0) / samples.length;\n            if (mean > 0) {\n              const variance = samples.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / samples.length;\n              const stdDev = Math.sqrt(variance);\n              const cv = (stdDev / mean) * 100;\n              const consistencyScore = Math.max(0, Math.min(100, 100 - (cv * 1.5)));\n              setConsistency(Math.round(consistencyScore));\n            }\n          }\n        }\n      }, 100); // 100ms intervals for smooth updates\n      \n      return () => {\n        if (timerRef.current) clearInterval(timerRef.current);\n      };\n    }\n  }, [isActive, startTime, isFinished, userInput, codeSnippet, timeLimit]);\n\n  // Completion logic:\n  // - For timed tests (timeLimit > 0): ONLY finish when timer expires (handled in timer effect)\n  //   When user completes current snippet, fetchMoreContent() is called to add more code\n  // - For \"No Limit\" mode (timeLimit === 0): Finish when user completes the snippet\n  useEffect(() => {\n    if (isActive && startTime && codeSnippet.length > 0) {\n      // For \"No Limit\" mode only\n      if (timeLimit === 0) {\n        // Master mode requires exact match (100% accuracy)\n        if (testMode === \"master\") {\n          if (userInput === codeSnippet) {\n            finishTest();\n          }\n        } else {\n          // Normal/Expert mode: finish when user types to the end (regardless of accuracy)\n          // This allows the test to complete and show accuracy results\n          // Handle snippets with trailing whitespace by comparing trimmed lengths\n          const trimmedSnippetLength = codeSnippet.trimEnd().length;\n          if (userInput.length >= codeSnippet.length || \n              (userInput.length >= trimmedSnippetLength && trimmedSnippetLength > 0)) {\n            finishTest();\n          }\n        }\n      }\n      // For timed tests, the continuous fetching effect will handle adding more content\n      // If we're loading more content, just wait; timer will finish the test\n    }\n  }, [userInput, isActive, startTime, codeSnippet, timeLimit, testMode]);\n\n  const saveCodeTestMutation = useMutation({\n    mutationFn: async (testData: any) => {\n      const response = await fetch(\"/api/code/tests\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(testData),\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to save test\");\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/code/tests\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/code/leaderboard\"] });\n    },\n  });\n\n  const finishTest = () => {\n    if (timerRef.current) clearInterval(timerRef.current);\n    \n    // Use precise milliseconds for accurate calculation\n    const durationMs = startTime ? Date.now() - startTime : 0;\n    const duration = Math.floor(durationMs / 1000);\n    const minutes = durationMs / 60000; // Use milliseconds for precision\n    \n    // Count correct and incorrect characters\n    let correctChars = 0;\n    let errorCount = 0;\n    for (let i = 0; i < userInput.length; i++) {\n      if (userInput[i] === codeSnippet[i]) {\n        correctChars++;\n      } else {\n        errorCount++;\n      }\n    }\n    \n    // Industry-standard formulas:\n    // Raw WPM (Gross WPM) = (Total Characters / 5) / Minutes\n    const finalRawWpm = minutes > 0 ? Math.round((userInput.length / 5) / minutes) : 0;\n    \n    // Net WPM = (Correct Characters / 5) / Minutes\n    const finalWpm = minutes > 0 ? Math.round((correctChars / 5) / minutes) : 0;\n    \n    // Accuracy = (Correct Characters / Total Characters) Ã— 100\n    const finalAccuracy = userInput.length > 0 ? Math.round((correctChars / userInput.length) * 100) : 100;\n    \n    // Calculate final consistency from WPM history\n    // Uses Net WPM samples, skipping warm-up period for accuracy\n    let finalConsistency = 100;\n    if (wpmHistoryRef.current.length >= 4) {\n      // Skip first 2 samples (first second) for warm-up\n      const samples = wpmHistoryRef.current.slice(2);\n      const mean = samples.reduce((a, b) => a + b, 0) / samples.length;\n      if (mean > 0) {\n        const variance = samples.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / samples.length;\n        const stdDev = Math.sqrt(variance);\n        const cv = (stdDev / mean) * 100;\n        // Scale CV to be more meaningful\n        finalConsistency = Math.max(0, Math.min(100, Math.round(100 - (cv * 1.5))));\n      }\n    } else if (wpmHistoryRef.current.length >= 2) {\n      // Fallback for shorter tests\n      const samples = wpmHistoryRef.current;\n      const mean = samples.reduce((a, b) => a + b, 0) / samples.length;\n      if (mean > 0) {\n        const variance = samples.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / samples.length;\n        const stdDev = Math.sqrt(variance);\n        const cv = (stdDev / mean) * 100;\n        finalConsistency = Math.max(0, Math.min(100, Math.round(100 - (cv * 1.5))));\n      }\n    }\n    \n    setWpm(Math.max(0, finalWpm));\n    setRawWpm(Math.max(0, finalRawWpm));\n    setAccuracy(finalAccuracy);\n    setConsistency(finalConsistency);\n    setErrors(errorCount);\n    setIsFinished(true);\n    setIsActive(false);\n    setCompletionDialogOpen(true);\n    \n    // Celebration confetti\n    confetti({\n      particleCount: 100,\n      spread: 70,\n      origin: { y: 0.6 },\n      colors: ['#22c55e', '#3b82f6', '#f59e0b'],\n    });\n\n    if (user && startTime) {\n      saveCodeTestMutation.mutate({\n        codeSnippetId: snippetId,\n        programmingLanguage: language,\n        wpm: Math.max(0, finalWpm),\n        accuracy: finalAccuracy,\n        characters: userInput.length,\n        errors: errorCount,\n        syntaxErrors: 0,\n        duration,\n      });\n    }\n  };\n\n  const handleInput = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    if (isComposing) return;\n    processInput(e.target.value);\n  };\n\n  const handleCompositionStart = () => {\n    setIsComposing(true);\n  };\n\n  const handleCompositionEnd = (e: React.CompositionEvent<HTMLTextAreaElement>) => {\n    setIsComposing(false);\n    setTimeout(() => {\n      if (textareaRef.current) {\n        processInput(textareaRef.current.value);\n      }\n    }, 0);\n  };\n\n  const processInput = (value: string) => {\n    if (isFinished || isFailed) return;\n    \n    if (value.length > codeSnippet.length) {\n      if (textareaRef.current) textareaRef.current.value = userInput;\n      return;\n    }\n    \n    // Play keyboard sound when typing (uses global sound settings)\n    if (value.length > userInput.length) {\n      keyboardSound.play();\n    }\n    \n    if (!isActive && value.length > 0) {\n      setIsActive(true);\n      setStartTime(Date.now());\n      wpmHistoryRef.current = [];\n    }\n    \n    if (testMode === \"master\") {\n      const hasErrors = value.split(\"\").some((char, i) => char !== codeSnippet[i]);\n      if (hasErrors) {\n        if (textareaRef.current) textareaRef.current.value = userInput;\n        return;\n      }\n    } else if (testMode === \"expert\" && value.length > userInput.length) {\n      const lastChar = value[value.length - 1];\n      const expectedChar = codeSnippet[value.length - 1];\n      \n      if (lastChar !== expectedChar) {\n        setIsFailed(true);\n        setIsActive(false);\n        toast({\n          title: \"Expert Mode Failed!\",\n          description: \"You made an error. The test has been reset.\",\n          variant: \"destructive\",\n        });\n        setTimeout(() => {\n          resetTest();\n          setIsFailed(false);\n        }, 1500);\n        return;\n      }\n    }\n    \n    setUserInput(value);\n  };\n\n  const handlePaste = (e: React.ClipboardEvent<HTMLTextAreaElement>) => {\n    e.preventDefault();\n    toast({\n      title: \"Paste Disabled\",\n      description: \"Please type manually for accurate results.\",\n      variant: \"destructive\",\n    });\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent<HTMLTextAreaElement>) => {\n    // Tab key - either insert tab or get new snippet if finished/empty\n    if (e.key === \"Tab\") {\n      e.preventDefault();\n      \n      // If test is finished or no input, Tab gets new snippet\n      if (isFinished || isFailed || (!isActive && userInput.length === 0)) {\n        fetchCodeSnippet(true);\n        return;\n      }\n      \n      // Otherwise, insert tab character if expected\n      const tabChar = codeSnippet[userInput.length];\n      if (tabChar === \"\\t\") {\n        const newValue = userInput + \"\\t\";\n        setUserInput(newValue);\n        if (!isActive) {\n          setIsActive(true);\n          setStartTime(Date.now());\n        }\n      }\n    }\n    \n    // Escape to reset/restart\n    if (e.key === \"Escape\") {\n      resetTest();\n    }\n  };\n  \n  const resetTest = useCallback(() => {\n    setCompletionDialogOpen(false);\n    setUserInput(\"\");\n    setStartTime(null);\n    setIsActive(false);\n    setIsFinished(false);\n    setIsFailed(false);\n    setWpm(0);\n    setRawWpm(0);\n    setAccuracy(100);\n    setConsistency(100);\n    setErrors(0);\n    setElapsedTime(0);\n    wpmHistoryRef.current = [];\n    \n    if (mode === \"ai\") {\n      fetchCodeSnippet(true); // Force new snippet\n    } else if (mode === \"custom\" && customCode) {\n      setCodeSnippet(normalizeCodeSnippet(customCode));\n      setSnippetId(null);\n    }\n    \n    setTimeout(() => textareaRef.current?.focus(), 0);\n  }, [mode, customCode, fetchCodeSnippet]);\n  \n  // Global keyboard shortcuts - respects test state\n  useEffect(() => {\n    const handleGlobalKeyDown = (e: KeyboardEvent) => {\n      const target = e.target as HTMLElement;\n      \n      // Skip if typing in any input field (custom prompt, custom code, etc.)\n      if (target instanceof HTMLInputElement || \n          target instanceof HTMLTextAreaElement ||\n          target.isContentEditable) {\n        // Only allow Escape to work in inputs\n        if (e.key === \"Escape\") {\n          e.preventDefault();\n          (target as HTMLElement).blur();\n          resetTest();\n        }\n        return;\n      }\n      \n      // Only handle when not focused on typing textarea\n      if (document.activeElement === textareaRef.current) return;\n      \n      // Tab to get new snippet - only when test is not active or is finished\n      if (e.key === \"Tab\" && (!isActive || isFinished || isFailed)) {\n        e.preventDefault();\n        fetchCodeSnippet(true);\n      }\n      \n      // Escape to reset - always allowed\n      if (e.key === \"Escape\") {\n        e.preventDefault();\n        resetTest();\n      }\n      \n      // Any printable key focuses and starts typing (only if test not finished)\n      if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey && !isFinished && !isFailed) {\n        textareaRef.current?.focus();\n      }\n    };\n    \n    window.addEventListener('keydown', handleGlobalKeyDown);\n    return () => window.removeEventListener('keydown', handleGlobalKeyDown);\n  }, [fetchCodeSnippet, resetTest, isActive, isFinished, isFailed]);\n\n  const handleModeSwitch = (newMode: \"ai\" | \"custom\") => {\n    if (newMode === mode) return;\n    setMode(newMode);\n    setCodeSnippet(\"\");\n    setUserInput(\"\");\n    setIsActive(false);\n    setIsFinished(false);\n    setErrorState({ type: null, message: '', canRetry: false });\n    setRetryCount(0);\n    if (newMode === \"ai\") {\n      fetchCodeSnippet(true);\n    }\n  };\n  \n  // Reset error state when language or difficulty changes\n  useEffect(() => {\n    if (mode === \"ai\") {\n      setErrorState({ type: null, message: '', canRetry: false });\n      setRetryCount(0);\n    }\n  }, [language, difficulty, timeLimit, testMode]);\n\n  \n  // Fetch more content for continuous typing (works for both timed and unlimited modes)\n  const fetchMoreContent = useCallback(async () => {\n    // Prevent duplicate fetches\n    if (isLoadingMore) return;\n    \n    if (infiniteAbortRef.current) {\n      infiniteAbortRef.current.abort();\n    }\n    \n    infiniteAbortRef.current = new AbortController();\n    const signal = infiniteAbortRef.current.signal;\n    \n    setIsLoadingMore(true);\n    \n    try {\n      const promptParam = customPrompt ? `&customPrompt=${encodeURIComponent(customPrompt)}` : '';\n      const response = await fetch(\n        `/api/code/snippet?language=${encodeURIComponent(language)}&difficulty=${encodeURIComponent(difficulty)}&timeLimit=0&testMode=${testMode}&generate=true&forceNew=true${promptParam}`,\n        { signal, cache: 'no-store' }\n      );\n      \n      if (signal.aborted) return;\n      \n      if (response.ok) {\n        const data = await response.json();\n        if (data.snippet?.content) {\n          // Append new content with a newline separator (normalized)\n          const normalizedContent = normalizeCodeSnippet(data.snippet.content);\n          setCodeSnippet(prev => prev + \"\\n\\n\" + normalizedContent);\n        }\n      }\n    } catch (error: any) {\n      if (error.name !== 'AbortError') {\n        console.error(\"Error fetching more content:\", error);\n      }\n    } finally {\n      setIsLoadingMore(false);\n    }\n  }, [language, difficulty, testMode, customPrompt, isLoadingMore]);\n\n  // Check if user is near the end of content - fetch more for continuous typing\n  // ONLY for timed tests (timeLimit > 0) - keeps content flowing until timer ends\n  // For \"No Limit\" mode (timeLimit === 0), the completion effect handles finishing\n  useEffect(() => {\n    // Only fetch more content for timed tests\n    if (timeLimit === 0 || !isActive || isFinished || isLoadingMore) return;\n    \n    const remainingChars = codeSnippet.length - userInput.length;\n    // When 100 characters or less remaining, fetch more code for timed tests\n    if (remainingChars <= 100 && codeSnippet.length > 0) {\n      fetchMoreContent();\n    }\n  }, [userInput.length, codeSnippet.length, isActive, isFinished, isLoadingMore, fetchMoreContent, timeLimit]);\n  \n  // Auto-scroll to keep current line visible\n  useEffect(() => {\n    if (!codeDisplayRef.current || !codeSnippet) return;\n    \n    // Calculate which line the cursor is on\n    const textBeforeCursor = codeSnippet.substring(0, userInput.length);\n    const currentLine = textBeforeCursor.split('\\n').length;\n    \n    // Find the line element and scroll into view\n    const lineElement = codeDisplayRef.current.querySelector(`[data-line=\"${currentLine}\"]`);\n    if (lineElement) {\n      lineElement.scrollIntoView({ behavior: 'smooth', block: 'center' });\n    }\n  }, [userInput.length, codeSnippet]);\n\n  const applyCustomCode = () => {\n    if (!customCode.trim()) {\n      toast({\n        title: \"No Code Entered\",\n        description: \"Please paste some code to practice typing.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    setCodeSnippet(normalizeCodeSnippet(customCode));\n    setSnippetId(null);\n    setUserInput(\"\");\n    setIsActive(false);\n    setIsFinished(false);\n    setTimeout(() => textareaRef.current?.focus(), 0);\n  };\n\n  const handleContainerClick = () => {\n    textareaRef.current?.focus();\n    setIsFocused(true);\n  };\n\n  const getStatus = () => {\n    if (isLoading) return \"LOADING\";\n    if (isFinished) return \"COMPLETE\";\n    if (isFailed) return \"FAILED\";\n    if (isActive) return \"TYPING\";\n    return \"READY\";\n  };\n\n  const getStatusColor = () => {\n    if (isFinished) return \"text-green-500\";\n    if (isFailed) return \"text-red-500\";\n    if (isActive) return \"text-yellow-500\";\n    return \"text-muted-foreground\";\n  };\n\n  // Calculate current cursor line for active line highlighting\n  const currentCursorLine = useMemo(() => {\n    if (!codeSnippet) return 0;\n    const textBeforeCursor = codeSnippet.substring(0, userInput.length);\n    return textBeforeCursor.split('\\n').length;\n  }, [codeSnippet, userInput.length]);\n\n  // Caret component based on style setting\n  const renderCaret = (style: \"line\" | \"block\" | \"underline\") => {\n    const baseClass = smoothCaret ? \"animate-caret-smooth\" : \"animate-caret-blink\";\n    \n    if (style === \"block\") {\n      return (\n        <span className={`absolute left-0 top-0 w-[0.6em] h-[1.2em] bg-primary/30 rounded-sm ${baseClass}`} />\n      );\n    }\n    if (style === \"underline\") {\n      return (\n        <span className={`absolute left-0 bottom-0 w-[0.6em] h-[2px] bg-primary rounded-full ${baseClass} shadow-[0_0_6px_rgba(var(--primary),0.5)]`} />\n      );\n    }\n    // Default: line\n    return (\n      <span className={`absolute left-0 top-0 w-[2px] h-[1.2em] bg-primary rounded-full ${baseClass} shadow-[0_0_8px_rgba(var(--primary),0.5)]`} />\n    );\n  };\n\n  const highlightedCode = useMemo(() => {\n    if (!codeSnippet) return null;\n    \n    const lines = codeSnippet.split(\"\\n\");\n    let charIndex = 0;\n    \n    return lines.map((line, lineIndex) => {\n      const isActiveLine = lineIndex + 1 === currentCursorLine;\n      \n      // Calculate indentation level for guides\n      const indentMatch = line.match(/^(\\s*)/);\n      const indentLevel = indentMatch ? Math.floor(indentMatch[1].length / 2) : 0;\n      \n      const lineContent = line.split(\"\").map((char, i) => {\n        const currentCharIndex = charIndex + i;\n        const isCurrent = currentCharIndex === userInput.length;\n        const isTyped = currentCharIndex < userInput.length;\n        const isCorrect = isTyped && userInput[currentCharIndex] === char;\n        const isError = isTyped && !isCorrect;\n        \n        // Enhanced character styling\n        let charClassName = \"transition-all duration-75 \";\n        \n        if (isError) {\n          // Error: red text with underline instead of background\n          charClassName += \"text-red-400 decoration-red-500 underline decoration-wavy decoration-2 \";\n        } else if (isTyped) {\n          // Correct: bright text with subtle glow\n          charClassName += \"text-foreground \";\n        } else if (isCurrent) {\n          // Current position\n          charClassName += \"relative text-muted-foreground/80 \";\n        } else {\n          // Untyped: dimmed\n          charClassName += focusMode ? \"text-muted-foreground/20\" : \"text-muted-foreground/40 \";\n        }\n        \n        // Handle spaces with visible dots for untyped\n        if (char === \" \" && !isTyped && !isCurrent) {\n          return (\n            <span key={currentCharIndex} className={charClassName + \"relative\"}>\n              <span className=\"opacity-20\">Â·</span>\n            </span>\n          );\n        }\n        \n        // Handle tabs\n        if (char === \"\\t\") {\n          return (\n            <span key={currentCharIndex} className={charClassName}>\n              {\"    \"}\n              {isCurrent && !isFinished && !isFailed && renderCaret(caretStyle)}\n            </span>\n          );\n        }\n        \n        return (\n          <span key={currentCharIndex} className={charClassName}>\n            {isCurrent && !isFinished && !isFailed && renderCaret(caretStyle)}\n            {char}\n          </span>\n        );\n      });\n      \n      // Check if cursor is at end of this line (at newline position)\n      const newlineIndex = charIndex + line.length;\n      const isCursorAtNewline = newlineIndex === userInput.length;\n      \n      // Update charIndex for next line\n      charIndex += line.length + 1;\n      \n      return (\n        <div \n          key={lineIndex} \n          className={`flex group transition-colors duration-150 ${\n            isActiveLine && !focusMode ? \"bg-primary/5 -mx-2 px-2 rounded\" : \"\"\n          }`} \n          data-line={lineIndex + 1}\n        >\n          {/* Line number gutter */}\n          {showLineNumbers && (\n            <span className={`select-none w-10 text-right pr-3 text-xs font-mono transition-colors ${\n              isActiveLine \n                ? \"text-primary font-medium\" \n                : \"text-muted-foreground/30 group-hover:text-muted-foreground/50\"\n            }`}>\n              {lineIndex + 1}\n            </span>\n          )}\n          \n          {/* Indentation guides */}\n          {showIndentGuides && (\n            <span className=\"relative\">\n              {indentLevel > 0 && Array.from({ length: indentLevel }).map((_, idx) => (\n                <span \n                  key={idx}\n                  className={`absolute top-0 bottom-0 w-px ${\n                    isActiveLine ? \"bg-primary/20\" : \"bg-muted-foreground/10\"\n                  }`}\n                  style={{ left: `${idx * 16}px` }}\n                />\n              ))}\n            </span>\n          )}\n          \n          {/* Line content */}\n          <span className=\"flex-1 whitespace-pre-wrap break-words\">\n            {lineContent}\n            {isCursorAtNewline && !isFinished && !isFailed && lineIndex < lines.length - 1 && (\n              <span className=\"relative\">\n                {renderCaret(caretStyle)}\n              </span>\n            )}\n            {/* Newline indicator */}\n            {lineIndex < lines.length - 1 && !focusMode && (\n              <span className={`ml-1 text-xs ${\n                newlineIndex < userInput.length \n                  ? \"text-green-500/40\" \n                  : \"text-muted-foreground/15\"\n              }`}>â†µ</span>\n            )}\n          </span>\n        </div>\n      );\n    });\n  }, [codeSnippet, userInput, isFinished, isFailed, currentCursorLine, caretStyle, smoothCaret, showLineNumbers, showIndentGuides, focusMode]);\n\n  const shareToSocial = (platform: string) => {\n    const langName = PROGRAMMING_LANGUAGES[language as keyof typeof PROGRAMMING_LANGUAGES]?.name || language;\n    const text = `ðŸš€ I just typed ${langName} code at ${wpm} WPM with ${accuracy}% accuracy on TypeMasterAI! ðŸ’» ${codeSnippet.length} characters. Can you code faster?`;\n    const url = window.location.origin + \"/code-mode\";\n    const title = `I typed ${langName} code at ${wpm} WPM on TypeMasterAI!`;\n    \n    const urls: Record<string, string> = {\n      twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,\n      facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`,\n      linkedin: `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(`Code Typing: ${wpm} WPM in ${langName}`)}&summary=${encodeURIComponent(text)}`,\n      whatsapp: `https://wa.me/?text=${encodeURIComponent(text + \"\\n\\n\" + url)}`,\n      telegram: `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`,\n      reddit: `https://www.reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`,\n      email: `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(text + \"\\n\\nTry it yourself: \" + url)}`,\n    };\n    \n    if (platform === 'discord') {\n      navigator.clipboard.writeText(`${text}\\n\\nðŸ”— ${url}`);\n      toast({\n        title: \"Copied for Discord!\",\n        description: \"Paste in any Discord channel or DM to share your achievement!\",\n      });\n      return;\n    }\n    \n    if (urls[platform]) {\n      if (platform === 'email') {\n        window.location.href = urls[platform];\n      } else {\n        window.open(urls[platform], \"_blank\", \"width=600,height=400\");\n      }\n    }\n  };\n  \n  const handleNativeShare = async () => {\n    const langName = PROGRAMMING_LANGUAGES[language as keyof typeof PROGRAMMING_LANGUAGES]?.name || language;\n    const text = `ðŸš€ I just typed ${langName} code at ${wpm} WPM with ${accuracy}% accuracy on TypeMasterAI! ðŸ’» ${codeSnippet.length} characters. Can you code faster?`;\n    const url = window.location.origin + \"/code-mode\";\n    \n    if (navigator.share) {\n      try {\n        await navigator.share({\n          title: `TypeMasterAI Code Mode - ${wpm} WPM`,\n          text: text,\n          url: url,\n        });\n      } catch (error: any) {\n        if (error.name !== 'AbortError') {\n          console.error('Native share error:', error);\n        }\n      }\n    }\n  };\n\n  const copyShareLink = async () => {\n    const text = `I typed ${codeSnippet.length} chars of ${language} at ${wpm} WPM (${accuracy}% accuracy) on TypeMasterAI! ${window.location.origin}/code-mode`;\n    await navigator.clipboard.writeText(text);\n    toast({\n      title: \"Copied!\",\n      description: \"Share link copied to clipboard.\",\n    });\n  };\n\n  return (\n    <TooltipProvider>\n      <div className=\"min-h-screen bg-background\">\n        <div className=\"container mx-auto py-4 sm:py-8 px-2 sm:px-4 max-w-5xl\">\n          {/* Header */}\n          <div className=\"flex items-center justify-center gap-3 mb-6\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div className=\"flex items-center gap-3 cursor-help\">\n                  <Code className=\"w-8 h-8 text-primary\" />\n                  <h1 className=\"text-2xl font-bold\">Code Mode</h1>\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"bottom\" className=\"max-w-[280px]\">\n                <p className=\"font-medium mb-1\">Code Typing Practice</p>\n                <p className=\"text-xs text-muted-foreground\">Master typing in 50+ programming languages with AI-generated snippets. Improve your coding speed and accuracy.</p>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n\n          {/* Controls Bar */}\n          <Card className=\"p-4 mb-6\">\n            <div className=\"flex flex-wrap gap-4 items-center justify-center\">\n              <div className=\"flex items-center gap-2\">\n                <div className=\"flex items-center gap-1\">\n                  <span className=\"text-sm font-medium\">Mode:</span>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <button type=\"button\" className=\"text-muted-foreground hover:text-foreground transition-colors\" aria-label=\"Mode help\">\n                        <HelpCircle className=\"w-3 h-3\" />\n                      </button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\" className=\"max-w-[250px]\">\n                      <p className=\"font-medium mb-1\">Code Generation Mode</p>\n                      <p className=\"text-xs text-muted-foreground\">Choose between AI-generated code snippets or paste your own custom code to practice.</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n                <div className=\"flex border rounded-md overflow-hidden\">\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        variant={mode === \"ai\" ? \"default\" : \"ghost\"}\n                        className=\"rounded-none text-xs px-3 h-8\"\n                        onClick={() => handleModeSwitch(\"ai\")}\n                        disabled={isActive}\n                        data-testid=\"button-mode-ai\"\n                      >\n                        AI Generated\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\" className=\"max-w-[220px]\">\n                      <p className=\"text-xs\">GPT-4 generates unique code snippets tailored to your selected language and difficulty.</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        variant={mode === \"custom\" ? \"default\" : \"ghost\"}\n                        className=\"rounded-none text-xs px-3 h-8\"\n                        onClick={() => handleModeSwitch(\"custom\")}\n                        disabled={isActive}\n                        data-testid=\"button-mode-custom\"\n                      >\n                        Custom Code\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\" className=\"max-w-[220px]\">\n                      <p className=\"text-xs\">Paste your own code to practice specific patterns, algorithms, or project code.</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n              </div>\n\n              <div className=\"flex items-center gap-2\">\n                <div className=\"flex items-center gap-1\">\n                  <span className=\"text-sm font-medium\">Language:</span>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <button type=\"button\" className=\"text-muted-foreground hover:text-foreground transition-colors\" aria-label=\"Language help\">\n                        <HelpCircle className=\"w-3 h-3\" />\n                      </button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\" className=\"max-w-[250px]\">\n                      <p className=\"font-medium mb-1\">Programming Language</p>\n                      <p className=\"text-xs text-muted-foreground\">Select from 50+ languages. AI generates syntax-correct snippets with language-specific patterns.</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n                <Select value={language} onValueChange={setLanguage} disabled={isActive || mode === \"custom\"}>\n                  <SelectTrigger className=\"w-[140px] h-8 text-xs\" data-testid=\"select-language\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent className=\"max-h-[400px]\">\n                    {Object.entries(\n                      Object.entries(PROGRAMMING_LANGUAGES).reduce((acc, [key, lang]) => {\n                        if (!acc[lang.category]) acc[lang.category] = [];\n                        acc[lang.category].push({ key, ...lang });\n                        return acc;\n                      }, {} as Record<string, Array<{ key: string; name: string; prism: string; category: string }>>)\n                    ).map(([category, languages]) => (\n                      <div key={category}>\n                        <div className=\"px-2 py-1.5 text-xs font-semibold text-muted-foreground\">\n                          {category}\n                        </div>\n                        {languages.map(({ key, name }) => (\n                          <SelectItem key={key} value={key}>{name}</SelectItem>\n                        ))}\n                      </div>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"flex items-center gap-2\">\n                <div className=\"flex items-center gap-1\">\n                  <span className=\"text-sm font-medium\">Difficulty:</span>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <button type=\"button\" className=\"text-muted-foreground hover:text-foreground transition-colors\" aria-label=\"Difficulty help\">\n                        <HelpCircle className=\"w-3 h-3\" />\n                      </button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\" className=\"max-w-[280px]\">\n                      <p className=\"font-medium mb-1\">Code Complexity</p>\n                      <div className=\"text-xs text-muted-foreground space-y-1\">\n                        <p><span className=\"text-green-400\">Easy:</span> Simple functions, basic syntax</p>\n                        <p><span className=\"text-yellow-400\">Medium:</span> Loops, conditions, data structures</p>\n                        <p><span className=\"text-red-400\">Hard:</span> Advanced algorithms, complex patterns</p>\n                      </div>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n                <Select value={difficulty} onValueChange={(val) => setDifficulty(val as any)} disabled={isActive || mode === \"custom\"}>\n                  <SelectTrigger className=\"w-[100px] h-8 text-xs\" data-testid=\"select-difficulty\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {DIFFICULTIES.map(({ value, label }) => (\n                      <SelectItem key={value} value={value}>{label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"flex items-center gap-2\">\n                <div className=\"flex items-center gap-1\">\n                  <span className=\"text-sm font-medium\">Test Mode:</span>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <button type=\"button\" className=\"text-muted-foreground hover:text-foreground transition-colors\" aria-label=\"Test mode help\">\n                        <HelpCircle className=\"w-3 h-3\" />\n                      </button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\" className=\"max-w-[280px]\">\n                      <p className=\"font-medium mb-1\">Challenge Level</p>\n                      <div className=\"text-xs text-muted-foreground space-y-1\">\n                        <p><span className=\"text-blue-400\">Normal:</span> Standard practice, errors allowed</p>\n                        <p><span className=\"text-orange-400\">Expert:</span> Test fails on any typing error</p>\n                        <p><span className=\"text-red-400\">Master:</span> Perfect 100% accuracy required</p>\n                      </div>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n                <Select value={testMode} onValueChange={(val) => setTestMode(val as any)} disabled={isActive}>\n                  <SelectTrigger className=\"w-[100px] h-8 text-xs\" data-testid=\"select-test-mode\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {TEST_MODES.map(({ value, label }) => (\n                      <SelectItem key={value} value={value}>{label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"flex items-center gap-2\">\n                <div className=\"flex items-center gap-1\">\n                  <span className=\"text-sm font-medium\">Time:</span>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <button type=\"button\" className=\"text-muted-foreground hover:text-foreground transition-colors\" aria-label=\"Time limit help\">\n                        <HelpCircle className=\"w-3 h-3\" />\n                      </button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\" className=\"max-w-[250px]\">\n                      <p className=\"font-medium mb-1\">Time Limit</p>\n                      <p className=\"text-xs text-muted-foreground\">Set a countdown timer for timed practice. \"No Limit\" lets you complete the full snippet at your own pace.</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n                <Select value={timeLimit.toString()} onValueChange={(val) => setTimeLimit(parseInt(val))} disabled={isActive}>\n                  <SelectTrigger className=\"w-[90px] h-8 text-xs\" data-testid=\"select-time\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent className=\"max-h-[200px]\">\n                    {TIME_OPTIONS.map(({ value, label }) => (\n                      <SelectItem key={value} value={value.toString()}>{label}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={resetTest}\n                    disabled={isLoading}\n                    data-testid=\"button-restart\"\n                  >\n                    <RotateCcw className=\"w-4 h-4 mr-1\" />\n                    {mode === \"ai\" ? \"New Snippet\" : \"Restart\"}\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Press Escape to restart</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n\n            {/* AI Custom Content & Settings Row */}\n            {mode === \"ai\" && !isActive && (\n              <>\n                {!showCustomAI ? (\n                  <div className=\"mt-2 flex justify-center items-center gap-2\">\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => setShowCustomAI(true)}\n                          className=\"gap-1.5 px-3 h-7 text-xs text-muted-foreground hover:text-primary\"\n                          data-testid=\"button-open-custom-ai\"\n                        >\n                          <Sparkles className=\"w-3.5 h-3.5\" />\n                          <span>Ask AI for specific code</span>\n                        </Button>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p className=\"text-xs\">Request specific code like \"React hooks\" or \"sorting algorithm\"</p>\n                      </TooltipContent>\n                    </Tooltip>\n                    \n                    <span className=\"text-muted-foreground/30\">|</span>\n                    \n                    {/* Settings Popover */}\n                    <Popover>\n                      <PopoverTrigger asChild>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          className=\"gap-1.5 px-2 h-7 text-xs text-muted-foreground hover:text-primary\"\n                          data-testid=\"button-settings\"\n                        >\n                          <Settings className=\"w-3.5 h-3.5\" />\n                          <span className=\"hidden sm:inline\">Settings</span>\n                        </Button>\n                      </PopoverTrigger>\n                      <PopoverContent className=\"w-72 p-4\" align=\"center\">\n                        <div className=\"space-y-4\">\n                          <h4 className=\"font-medium text-sm flex items-center gap-2\">\n                            <Settings className=\"w-4 h-4\" />\n                            Typing Settings\n                          </h4>\n                          \n                          {/* Caret Style */}\n                          <div className=\"space-y-2\">\n                            <div className=\"flex items-center gap-1\">\n                              <Label className=\"text-xs text-muted-foreground\">Caret Style</Label>\n                              <Tooltip>\n                                <TooltipTrigger asChild>\n                                  <button type=\"button\" className=\"text-muted-foreground/50 hover:text-muted-foreground\">\n                                    <HelpCircle className=\"w-3 h-3\" />\n                                  </button>\n                                </TooltipTrigger>\n                                <TooltipContent side=\"right\" className=\"max-w-[180px]\">\n                                  <p className=\"text-xs\">Choose cursor style: thin line, solid block, or underline</p>\n                                </TooltipContent>\n                              </Tooltip>\n                            </div>\n                            <div className=\"flex gap-1\">\n                              {([\"line\", \"block\", \"underline\"] as const).map((style) => (\n                                <Tooltip key={style}>\n                                  <TooltipTrigger asChild>\n                                    <button\n                                      onClick={() => setCaretStyle(style)}\n                                      className={`flex-1 py-1.5 px-2 text-xs rounded-md border transition-colors ${\n                                        caretStyle === style \n                                          ? \"bg-primary text-primary-foreground border-primary\" \n                                          : \"bg-muted/50 border-border hover:bg-muted\"\n                                      }`}\n                                      data-testid={`button-caret-${style}`}\n                                    >\n                                      {style.charAt(0).toUpperCase() + style.slice(1)}\n                                    </button>\n                                  </TooltipTrigger>\n                                  <TooltipContent>\n                                    <p className=\"text-xs\">\n                                      {style === \"line\" && \"Thin vertical line cursor\"}\n                                      {style === \"block\" && \"Solid block cursor like terminals\"}\n                                      {style === \"underline\" && \"Underline cursor style\"}\n                                    </p>\n                                  </TooltipContent>\n                                </Tooltip>\n                              ))}\n                            </div>\n                          </div>\n                          \n                          {/* Toggles */}\n                          <div className=\"space-y-3\">\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <div className=\"flex items-center justify-between cursor-help\">\n                                  <Label htmlFor=\"smooth-caret\" className=\"text-xs flex items-center gap-2 cursor-pointer\">\n                                    <Eye className=\"w-3.5 h-3.5\" />\n                                    Smooth Caret\n                                  </Label>\n                                  <Switch \n                                    id=\"smooth-caret\" \n                                    checked={smoothCaret} \n                                    onCheckedChange={setSmoothCaret}\n                                    data-testid=\"switch-smooth-caret\"\n                                  />\n                                </div>\n                              </TooltipTrigger>\n                              <TooltipContent side=\"left\">\n                                <p className=\"text-xs\">Smooth glowing animation instead of blinking</p>\n                              </TooltipContent>\n                            </Tooltip>\n                            \n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <div className=\"flex items-center justify-between cursor-help\">\n                                  <Label htmlFor=\"line-numbers\" className=\"text-xs flex items-center gap-2 cursor-pointer\">\n                                    <Code className=\"w-3.5 h-3.5\" />\n                                    Line Numbers\n                                  </Label>\n                                  <Switch \n                                    id=\"line-numbers\" \n                                    checked={showLineNumbers} \n                                    onCheckedChange={setShowLineNumbers}\n                                    data-testid=\"switch-line-numbers\"\n                                  />\n                                </div>\n                              </TooltipTrigger>\n                              <TooltipContent side=\"left\">\n                                <p className=\"text-xs\">Show line numbers in the code gutter</p>\n                              </TooltipContent>\n                            </Tooltip>\n                            \n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <div className=\"flex items-center justify-between cursor-help\">\n                                  <Label htmlFor=\"indent-guides\" className=\"text-xs flex items-center gap-2 cursor-pointer\">\n                                    <Code className=\"w-3.5 h-3.5\" />\n                                    Indent Guides\n                                  </Label>\n                                  <Switch \n                                    id=\"indent-guides\" \n                                    checked={showIndentGuides} \n                                    onCheckedChange={setShowIndentGuides}\n                                    data-testid=\"switch-indent-guides\"\n                                  />\n                                </div>\n                              </TooltipTrigger>\n                              <TooltipContent side=\"left\">\n                                <p className=\"text-xs\">Vertical lines showing indentation levels</p>\n                              </TooltipContent>\n                            </Tooltip>\n                            \n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <div className=\"flex items-center justify-between cursor-help\">\n                                  <Label htmlFor=\"focus-mode\" className=\"text-xs flex items-center gap-2 cursor-pointer\">\n                                    {focusMode ? <EyeOff className=\"w-3.5 h-3.5\" /> : <Eye className=\"w-3.5 h-3.5\" />}\n                                    Focus Mode\n                                  </Label>\n                                  <Switch \n                                    id=\"focus-mode\" \n                                    checked={focusMode} \n                                    onCheckedChange={setFocusMode}\n                                    data-testid=\"switch-focus-mode\"\n                                  />\n                                </div>\n                              </TooltipTrigger>\n                              <TooltipContent side=\"left\">\n                                <p className=\"text-xs\">Dim untyped code for better concentration</p>\n                              </TooltipContent>\n                            </Tooltip>\n                            \n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <div className=\"flex items-center justify-between cursor-help\">\n                                  <Label htmlFor=\"sound-enabled\" className=\"text-xs flex items-center gap-2 cursor-pointer\">\n                                    {soundEnabled ? <Volume2 className=\"w-3.5 h-3.5\" /> : <VolumeX className=\"w-3.5 h-3.5\" />}\n                                    Typing Sounds\n                                  </Label>\n                                  <Switch \n                                    id=\"sound-enabled\" \n                                    checked={soundEnabled} \n                                    onCheckedChange={(enabled) => {\n                                      setSoundEnabled(enabled);\n                                      keyboardSound.setEnabled(enabled);\n                                      if (enabled) keyboardSound.play();\n                                    }}\n                                    data-testid=\"switch-sound\"\n                                  />\n                                </div>\n                              </TooltipTrigger>\n                              <TooltipContent side=\"left\">\n                                <p className=\"text-xs\">Play keyboard sounds while typing</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          </div>\n                          \n                          <p className=\"text-[10px] text-muted-foreground/60 text-center\">\n                            Sound type can be changed in global Settings\n                          </p>\n                        </div>\n                      </PopoverContent>\n                    </Popover>\n                  </div>\n                ) : (\n                  <div className=\"mt-2 p-2 bg-card/50 rounded-lg border border-border/50 animate-in fade-in duration-150\">\n                    <div className=\"flex items-center gap-2\">\n                      <Sparkles className=\"w-4 h-4 text-primary shrink-0\" />\n                      <input\n                        type=\"text\"\n                        value={customPrompt}\n                        onChange={(e) => setCustomPrompt(e.target.value)}\n                        onKeyDown={(e) => {\n                          if (e.key === \"Enter\" && customPrompt.trim()) {\n                            toast({\n                              title: \"Generating...\",\n                              description: `Creating ${customPrompt} code snippet`,\n                            });\n                            fetchCodeSnippet(true);\n                            setShowCustomAI(false);\n                            setCustomPrompt(\"\");\n                          }\n                          if (e.key === \"Escape\") {\n                            setShowCustomAI(false);\n                            setCustomPrompt(\"\");\n                          }\n                        }}\n                        placeholder=\"What code do you want?\"\n                        className=\"flex-1 h-8 px-3 text-sm bg-background border border-border/50 rounded-md focus:outline-none focus:ring-1 focus:ring-primary/50 placeholder:text-muted-foreground/50\"\n                        disabled={isActive}\n                        autoFocus\n                        data-testid=\"input-custom-prompt\"\n                      />\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <Button\n                            size=\"sm\"\n                            onClick={() => {\n                              if (!customPrompt.trim()) {\n                                toast({\n                                  title: \"Enter a prompt\",\n                                  description: \"Type what code you want, e.g., 'React hooks' or 'sorting algorithm'\",\n                                });\n                                return;\n                              }\n                              toast({\n                                title: \"Generating...\",\n                                description: `Creating ${customPrompt} code snippet`,\n                              });\n                              fetchCodeSnippet(true);\n                              setShowCustomAI(false);\n                              setCustomPrompt(\"\");\n                            }}\n                            disabled={isLoading}\n                            className=\"h-8 px-3 shrink-0\"\n                            data-testid=\"button-generate-custom\"\n                          >\n                            {isLoading ? (\n                              <div className=\"w-3.5 h-3.5 border-2 border-background/30 border-t-background rounded-full animate-spin\" />\n                            ) : (\n                              <Zap className=\"w-3.5 h-3.5\" />\n                            )}\n                          </Button>\n                        </TooltipTrigger>\n                        <TooltipContent>\n                          <p className=\"text-xs\">Generate code with AI (Enter)</p>\n                        </TooltipContent>\n                      </Tooltip>\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <button\n                            onClick={() => {\n                              setShowCustomAI(false);\n                              setCustomPrompt(\"\");\n                            }}\n                            className=\"text-muted-foreground hover:text-foreground transition-colors\"\n                            data-testid=\"button-close-custom-ai\"\n                          >\n                            <X className=\"w-4 h-4\" />\n                          </button>\n                        </TooltipTrigger>\n                        <TooltipContent>\n                          <p className=\"text-xs\">Close (Esc)</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </div>\n                    <div className=\"flex items-center gap-1.5 mt-2 flex-wrap\">\n                      <span className=\"text-[10px] text-muted-foreground/60 mr-1\">Quick:</span>\n                      {[\n                        { label: \"Hooks\", tip: \"React useState, useEffect patterns\" },\n                        { label: \"API\", tip: \"REST API calls and fetch examples\" },\n                        { label: \"Sort\", tip: \"Sorting algorithms (bubble, quick, merge)\" },\n                        { label: \"Class\", tip: \"Object-oriented class definitions\" },\n                        { label: \"Async\", tip: \"Async/await and Promise patterns\" }\n                      ].map(({ label, tip }) => (\n                        <Tooltip key={label}>\n                          <TooltipTrigger asChild>\n                            <button\n                              onClick={() => {\n                                setCustomPrompt(label);\n                                setTimeout(() => {\n                                  fetchCodeSnippet(true);\n                                  setShowCustomAI(false);\n                                }, 50);\n                              }}\n                              disabled={isLoading}\n                              className=\"px-2 py-0.5 text-[10px] bg-background hover:bg-primary/10 border border-border/40 hover:border-primary/40 rounded transition-all text-muted-foreground hover:text-foreground disabled:opacity-50\"\n                              data-testid={`suggestion-${label.toLowerCase()}`}\n                            >\n                              {label}\n                            </button>\n                          </TooltipTrigger>\n                          <TooltipContent>\n                            <p className=\"text-xs\">{tip}</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </>\n            )}\n\n            {mode === \"custom\" && !codeSnippet && (\n              <div className=\"mt-4\">\n                <div className=\"flex items-center gap-1 mb-2\">\n                  <span className=\"text-sm font-medium\">Paste Your Code:</span>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <button type=\"button\" className=\"text-muted-foreground hover:text-foreground transition-colors\" aria-label=\"Custom code help\">\n                        <HelpCircle className=\"w-3 h-3\" />\n                      </button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"right\" className=\"max-w-[250px]\">\n                      <p className=\"font-medium mb-1\">Custom Code Practice</p>\n                      <p className=\"text-xs text-muted-foreground\">Paste any code snippet you want to practice. Works with any programming language or text format.</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n                <textarea\n                  value={customCode}\n                  onChange={(e) => setCustomCode(e.target.value)}\n                  className=\"w-full h-32 p-3 bg-background border rounded-lg font-mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-primary\"\n                  placeholder=\"Paste your code here...\"\n                  spellCheck={false}\n                  data-testid=\"textarea-custom-code\"\n                />\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button onClick={applyCustomCode} className=\"mt-2\" data-testid=\"button-apply-custom\">\n                      Start Typing\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"right\">\n                    <p className=\"text-xs\">Load your code and begin the typing test</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n            )}\n          </Card>\n\n          {/* Stats Bar - Monkeytype Style with Tooltips */}\n          <div className=\"grid grid-cols-6 gap-2 mb-6\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div tabIndex={0} role=\"group\" aria-label=\"Time statistic\" className=\"focus:outline-none focus:ring-2 focus:ring-primary rounded-lg\">\n                  <Card className=\"p-3 text-center bg-card/50 border-border/50 cursor-help hover:bg-card/70 transition-colors\" data-testid=\"stat-time\">\n                    <div className=\"text-[10px] uppercase tracking-wider text-muted-foreground mb-1\">\n                      {timeLimit > 0 ? \"Time Left\" : \"Time\"}\n                    </div>\n                    <div className={`text-2xl font-mono font-bold ${\n                      timeLimit > 0 && (timeLimit - elapsedTime) <= 10 \n                        ? \"text-red-500 animate-pulse\" \n                        : \"text-yellow-500\"\n                    }`}>\n                      {timeLimit > 0 \n                        ? formatTime(Math.max(0, timeLimit - elapsedTime))\n                        : formatTime(elapsedTime)\n                      }\n                    </div>\n                  </Card>\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"bottom\" className=\"max-w-[220px]\">\n                <p className=\"font-medium mb-1\">Elapsed Time</p>\n                <p className=\"text-xs text-muted-foreground\">\n                  {timeLimit > 0 \n                    ? \"Countdown timer. Test ends when time runs out.\"\n                    : \"Total time spent typing. No time pressure.\"\n                  }\n                </p>\n              </TooltipContent>\n            </Tooltip>\n            \n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div tabIndex={0} role=\"group\" aria-label=\"WPM statistic\" className=\"focus:outline-none focus:ring-2 focus:ring-primary rounded-lg\">\n                  <Card className=\"p-3 text-center bg-card/50 border-border/50 cursor-help hover:bg-card/70 transition-colors\" data-testid=\"stat-wpm\">\n                    <div className=\"text-[10px] uppercase tracking-wider text-muted-foreground mb-1\">WPM</div>\n                    <div className=\"text-2xl font-mono font-bold\">\n                      {wpm}\n                    </div>\n                  </Card>\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"bottom\" className=\"max-w-[250px]\">\n                <p className=\"font-medium mb-1\">Net Words Per Minute</p>\n                <p className=\"text-xs text-muted-foreground\">Your effective typing speed after subtracting errors. This is your true WPM score.</p>\n                <p className=\"text-[10px] text-muted-foreground/70 mt-1\">Formula: (characters / 5 - errors) Ã— 60 / time</p>\n              </TooltipContent>\n            </Tooltip>\n            \n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div tabIndex={0} role=\"group\" aria-label=\"Raw WPM statistic\" className=\"focus:outline-none focus:ring-2 focus:ring-primary rounded-lg\">\n                  <Card className=\"p-3 text-center bg-card/50 border-border/50 cursor-help hover:bg-card/70 transition-colors\" data-testid=\"stat-raw\">\n                    <div className=\"text-[10px] uppercase tracking-wider text-muted-foreground mb-1\">Raw</div>\n                    <div className=\"text-2xl font-mono font-bold\">\n                      {rawWpm}\n                    </div>\n                  </Card>\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"bottom\" className=\"max-w-[250px]\">\n                <p className=\"font-medium mb-1\">Raw Words Per Minute</p>\n                <p className=\"text-xs text-muted-foreground\">Total keystrokes per minute without error penalties. Shows your raw typing speed.</p>\n                <p className=\"text-[10px] text-muted-foreground/70 mt-1\">Higher than WPM = errors slowing you down</p>\n              </TooltipContent>\n            </Tooltip>\n            \n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div tabIndex={0} role=\"group\" aria-label=\"Accuracy statistic\" className=\"focus:outline-none focus:ring-2 focus:ring-primary rounded-lg\">\n                  <Card className=\"p-3 text-center bg-card/50 border-border/50 cursor-help hover:bg-card/70 transition-colors\" data-testid=\"stat-accuracy\">\n                    <div className=\"text-[10px] uppercase tracking-wider text-muted-foreground mb-1\">Accuracy</div>\n                    <div className=\"text-2xl font-mono font-bold\">\n                      {accuracy}%\n                    </div>\n                  </Card>\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"bottom\" className=\"max-w-[250px]\">\n                <p className=\"font-medium mb-1\">Typing Accuracy</p>\n                <p className=\"text-xs text-muted-foreground\">Percentage of correctly typed characters. Higher accuracy = better muscle memory.</p>\n                <div className=\"text-[10px] mt-1 space-y-0.5\">\n                  <p className=\"text-green-400\">98%+ = Excellent</p>\n                  <p className=\"text-yellow-400\">95-97% = Good</p>\n                  <p className=\"text-red-400\">&lt;95% = Needs practice</p>\n                </div>\n              </TooltipContent>\n            </Tooltip>\n            \n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div tabIndex={0} role=\"group\" aria-label=\"Consistency statistic\" className=\"focus:outline-none focus:ring-2 focus:ring-primary rounded-lg\">\n                  <Card className=\"p-3 text-center bg-card/50 border-border/50 cursor-help hover:bg-card/70 transition-colors\" data-testid=\"stat-consistency\">\n                    <div className=\"text-[10px] uppercase tracking-wider text-muted-foreground mb-1\">Consistency</div>\n                    <div className=\"text-2xl font-mono font-bold text-green-500\">\n                      {consistency}%\n                    </div>\n                  </Card>\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"bottom\" className=\"max-w-[250px]\">\n                <p className=\"font-medium mb-1\">Typing Consistency</p>\n                <p className=\"text-xs text-muted-foreground\">How steady your typing speed is. Low variance = consistent rhythm, high flow state.</p>\n                <p className=\"text-[10px] text-muted-foreground/70 mt-1\">Based on WPM standard deviation over time</p>\n              </TooltipContent>\n            </Tooltip>\n            \n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div tabIndex={0} role=\"group\" aria-label=\"Status indicator\" className=\"focus:outline-none focus:ring-2 focus:ring-primary rounded-lg\">\n                  <Card className=\"p-3 text-center bg-card/50 border-border/50 cursor-help hover:bg-card/70 transition-colors\" data-testid=\"stat-status\">\n                    <div className=\"text-[10px] uppercase tracking-wider text-muted-foreground mb-1\">Status</div>\n                    <div className={`text-lg font-mono font-bold ${getStatusColor()}`}>\n                      {getStatus()}\n                    </div>\n                  </Card>\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"bottom\" className=\"max-w-[220px]\">\n                <p className=\"font-medium mb-1\">Test Status</p>\n                <p className=\"text-xs text-muted-foreground\">\n                  {isFinished ? \"Test completed successfully!\" :\n                   isFailed ? \"Test failed. Try again!\" :\n                   isActive ? \"Currently typing...\" :\n                   \"Ready to start. Click the code area to begin.\"}\n                </p>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n\n          {/* Main Typing Area - Monkeytype Style */}\n          <div\n            ref={containerRef}\n            onClick={handleContainerClick}\n            className={`relative rounded-xl min-h-[300px] cursor-text transition-all duration-300 overflow-hidden ${\n              isFocused \n                ? \"ring-2 ring-primary/30 shadow-lg shadow-primary/5\" \n                : \"ring-1 ring-border/30 hover:ring-border/50\"\n            }`}\n            data-testid=\"typing-container\"\n            style={{\n              background: 'linear-gradient(180deg, hsl(var(--card)/0.6) 0%, hsl(var(--card)/0.3) 100%)'\n            }}\n          >\n            {/* Code editor header bar */}\n            <div className=\"flex items-center justify-between px-4 py-2 border-b border-border/20 bg-card/40\">\n              <div className=\"flex items-center gap-2\">\n                <div className=\"flex items-center gap-1.5 px-2 py-1 rounded-md bg-muted/50\">\n                  <Terminal className=\"w-3.5 h-3.5 text-primary/70\" />\n                </div>\n                <span className=\"text-xs text-muted-foreground/60 font-mono\">\n                  {PROGRAMMING_LANGUAGES[language as keyof typeof PROGRAMMING_LANGUAGES]?.name || language}\n                  {!isLoading && codeSnippet && (\n                    <span className=\"ml-2 text-muted-foreground/40\">\n                      â€¢ {codeSnippet.split('\\n').length} lines â€¢ {codeSnippet.length} chars\n                    </span>\n                  )}\n                </span>\n              </div>\n              {isActive && (\n                <div className=\"flex items-center gap-2\">\n                  <div className=\"w-2 h-2 rounded-full bg-green-500 animate-pulse\" />\n                  <span className=\"text-xs text-green-500/80 font-mono\">typing</span>\n                </div>\n              )}\n            </div>\n\n            <div className=\"p-5\">\n              {isLoading ? (\n                <div className=\"h-64 space-y-3\">\n                  <div className=\"flex items-center gap-2 mb-4\">\n                    <div className=\"w-4 h-4 border-2 border-primary/30 border-t-primary rounded-full animate-spin\" />\n                    <span className=\"text-xs text-muted-foreground\">\n                      Generating {PROGRAMMING_LANGUAGES[language as keyof typeof PROGRAMMING_LANGUAGES]?.name} snippet...\n                    </span>\n                  </div>\n                  <div className=\"space-y-2.5\">\n                    {[3/4, 1/2, 5/6, 2/3, 4/5, 1/3, 3/5].map((w, i) => (\n                      <div \n                        key={i}\n                        className=\"h-5 bg-gradient-to-r from-muted/40 to-muted/20 rounded-md animate-pulse\" \n                        style={{ width: `${w * 100}%`, animationDelay: `${i * 0.08}s` }}\n                      />\n                    ))}\n                  </div>\n                </div>\n              ) : codeSnippet ? (\n                <>\n                  {/* Hidden textarea for input capture */}\n                  <textarea\n                    ref={textareaRef}\n                    value={userInput}\n                    onChange={handleInput}\n                    onKeyDown={handleKeyDown}\n                    onPaste={handlePaste}\n                    onCompositionStart={handleCompositionStart}\n                    onCompositionEnd={handleCompositionEnd}\n                    onFocus={() => setIsFocused(true)}\n                    onBlur={() => setIsFocused(false)}\n                    className=\"absolute opacity-0 w-0 h-0 top-0 left-0 resize-none\"\n                    autoComplete=\"off\"\n                    autoCorrect=\"off\"\n                    autoCapitalize=\"off\"\n                    spellCheck={false}\n                    data-testid=\"input-code-typing\"\n                    disabled={isFinished || isFailed}\n                    aria-label=\"Code typing input\"\n                  />\n                  \n                  {/* Displayed code with highlighting and line numbers */}\n                  <div \n                    className=\"font-mono text-[15px] leading-[1.65] select-none overflow-y-auto overflow-x-hidden max-h-[400px] scroll-smooth scrollbar-thin scrollbar-thumb-muted/30 scrollbar-track-transparent\"\n                    ref={codeDisplayRef}\n                    role=\"textbox\"\n                    aria-readonly=\"true\"\n                    aria-label=\"Code display area\"\n                    style={{ scrollbarWidth: 'thin', scrollbarColor: 'rgba(100,100,100,0.3) transparent' }}\n                  >\n                    {highlightedCode}\n                  </div>\n\n                  {/* Progress indicator at bottom */}\n                  {isActive && codeSnippet && (\n                    <div className=\"mt-4 pt-3 border-t border-border/10\">\n                      <div className=\"flex items-center justify-between text-xs text-muted-foreground/60 mb-1.5\">\n                        <span>{userInput.length} / {codeSnippet.length} characters</span>\n                        <span>{Math.round((userInput.length / codeSnippet.length) * 100)}%</span>\n                      </div>\n                      <div className=\"h-1 bg-muted/20 rounded-full overflow-hidden\">\n                        <div \n                          className=\"h-full bg-gradient-to-r from-primary/80 to-primary rounded-full transition-all duration-150 ease-out\"\n                          style={{ width: `${Math.min((userInput.length / codeSnippet.length) * 100, 100)}%` }}\n                        />\n                      </div>\n                    </div>\n                  )}\n\n                  {/* Click to start overlay */}\n                  {!isActive && !isFinished && userInput.length === 0 && !isFocused && (\n                    <div \n                      className=\"absolute inset-0 flex items-center justify-center bg-background/40 backdrop-blur-[2px] cursor-text transition-opacity duration-200\"\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        textareaRef.current?.focus();\n                      }}\n                    >\n                      <div className=\"text-center pointer-events-none\">\n                        <div className=\"inline-flex items-center gap-3 px-6 py-3 rounded-xl bg-card/95 border border-border shadow-xl mb-3\">\n                          <span className=\"text-xl\">âŒ¨ï¸</span>\n                          <span className=\"text-foreground font-medium\">Click or press any key to start</span>\n                        </div>\n                        <p className=\"text-xs text-muted-foreground bg-card/80 px-3 py-1 rounded-full\">\n                          {timeLimit === 0 ? \"Infinite mode - type until you want to stop\" : `${timeLimit}s time limit`}\n                        </p>\n                      </div>\n                    </div>\n                  )}\n                </>\n              ) : errorState.type ? (\n              <div className=\"flex flex-col items-center justify-center h-64 gap-4\">\n                <div className={`text-center p-4 rounded-lg ${\n                  errorState.type === 'network' ? 'bg-yellow-500/10 border border-yellow-500/30' :\n                  errorState.type === 'timeout' ? 'bg-orange-500/10 border border-orange-500/30' :\n                  'bg-red-500/10 border border-red-500/30'\n                }`}>\n                  <div className={`text-lg font-medium mb-2 ${\n                    errorState.type === 'network' ? 'text-yellow-500' :\n                    errorState.type === 'timeout' ? 'text-orange-500' :\n                    'text-red-500'\n                  }`}>\n                    {errorState.type === 'network' ? 'ðŸŒ Network Error' :\n                     errorState.type === 'timeout' ? 'â±ï¸ Request Timeout' :\n                     errorState.type === 'generation' ? 'âš ï¸ Generation Failed' :\n                     'âŒ Server Error'}\n                  </div>\n                  <p className=\"text-muted-foreground text-sm mb-3\">{errorState.message}</p>\n                  {retryCount > 0 && retryCount < MAX_RETRIES && (\n                    <p className=\"text-xs text-muted-foreground mb-2\">\n                      Auto-retrying... (Attempt {retryCount + 1}/{MAX_RETRIES})\n                    </p>\n                  )}\n                  {errorState.canRetry && (\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={() => {\n                        setRetryCount(0);\n                        fetchCodeSnippet(true);\n                      }}\n                      disabled={isLoading}\n                      data-testid=\"button-retry\"\n                    >\n                      <RotateCcw className=\"w-4 h-4 mr-2\" />\n                      Try Again\n                    </Button>\n                  )}\n                </div>\n                <div className=\"text-xs text-muted-foreground\">\n                  Or try a different language/difficulty above\n                </div>\n              </div>\n            ) : mode === \"custom\" ? (\n              <div className=\"flex items-center justify-center h-64 text-muted-foreground\">\n                Select \"Custom Code\" mode and paste your code above\n              </div>\n            ) : (\n              <div className=\"flex flex-col items-center justify-center h-64 gap-4\">\n                <div className=\"text-muted-foreground\">No code snippet available</div>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => fetchCodeSnippet(true)}\n                  disabled={isLoading}\n                >\n                  <RotateCcw className=\"w-4 h-4 mr-2\" />\n                  Generate Snippet\n                </Button>\n              </div>\n            )}\n            </div>\n          </div>\n\n          {/* Progress indicator with keyboard shortcuts */}\n          {codeSnippet && !isFinished && (\n            <div className=\"mt-4 flex items-center justify-between text-sm text-muted-foreground\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"flex items-center gap-4 cursor-help\">\n                    <span className=\"font-mono\">{userInput.length} / {codeSnippet.length}</span>\n                    <span className=\"text-xs\">({Math.round((userInput.length / codeSnippet.length) * 100)}% complete)</span>\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                  <p className=\"font-medium mb-1\">Progress</p>\n                  <p className=\"text-xs text-muted-foreground\">Characters typed out of total. Keep going!</p>\n                </TooltipContent>\n              </Tooltip>\n              <div className=\"hidden sm:flex items-center gap-3 text-xs\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"flex items-center gap-1.5 cursor-help\">\n                      <kbd className=\"px-1.5 py-0.5 rounded bg-muted border text-muted-foreground\">Esc</kbd>\n                      <span>restart</span>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\">\n                    <p className=\"text-xs\">Press Escape to restart the same snippet</p>\n                  </TooltipContent>\n                </Tooltip>\n                <span className=\"text-muted-foreground/50\">â€¢</span>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"flex items-center gap-1.5 cursor-help\">\n                      <kbd className=\"px-1.5 py-0.5 rounded bg-muted border text-muted-foreground\">Tab</kbd>\n                      <span>new snippet</span>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\">\n                    <p className=\"text-xs\">Press Tab to generate a fresh code snippet</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n            </div>\n          )}\n\n          {/* Results Summary Modal */}\n          <Dialog open={completionDialogOpen} onOpenChange={setCompletionDialogOpen}>\n            <DialogContent className=\"sm:max-w-[600px]\">\n              <DialogHeader>\n                <DialogTitle className=\"text-2xl font-bold text-center\">Test Complete!</DialogTitle>\n                <DialogDescription className=\"text-center\">\n                  Great job! Here are your results for this {PROGRAMMING_LANGUAGES[language as keyof typeof PROGRAMMING_LANGUAGES]?.name || language} typing test.\n                </DialogDescription>\n              </DialogHeader>\n              \n              {/* Main stats grid */}\n              <div className=\"grid grid-cols-2 sm:grid-cols-5 gap-3 text-center my-4\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"p-3 rounded-lg bg-muted/50 cursor-help hover:bg-muted/70 transition-colors\">\n                      <div className=\"text-2xl sm:text-3xl font-bold text-primary\">{wpm}</div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase tracking-wide\">Net WPM</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                    <p className=\"text-xs\">Your final typing speed after error correction. This is your official score.</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"p-3 rounded-lg bg-muted/50 cursor-help hover:bg-muted/70 transition-colors\">\n                      <div className=\"text-2xl sm:text-3xl font-bold\">{rawWpm}</div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase tracking-wide\">Raw WPM</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                    <p className=\"text-xs\">Total keystroke speed without error penalty. Difference from Net WPM shows error impact.</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"p-3 rounded-lg bg-muted/50 cursor-help hover:bg-muted/70 transition-colors\">\n                      <div className={`text-2xl sm:text-3xl font-bold ${Number(accuracy) >= 95 ? 'text-green-500' : Number(accuracy) >= 85 ? 'text-yellow-500' : 'text-red-500'}`}>\n                        {accuracy}%\n                      </div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase tracking-wide\">Accuracy</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                    <p className=\"text-xs\">Percentage of correct keystrokes. {Number(accuracy) >= 95 ? \"Excellent accuracy!\" : Number(accuracy) >= 85 ? \"Good, aim for 95%+\" : \"Practice to improve accuracy.\"}</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"p-3 rounded-lg bg-muted/50 cursor-help hover:bg-muted/70 transition-colors\">\n                      <div className=\"text-2xl sm:text-3xl font-bold text-green-500\">{consistency}%</div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase tracking-wide\">Consistency</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                    <p className=\"text-xs\">How steady your typing rhythm was. Higher = more consistent flow throughout the test.</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"p-3 rounded-lg bg-muted/50 cursor-help hover:bg-muted/70 transition-colors\">\n                      <div className=\"text-2xl sm:text-3xl font-bold\">{formatTime(elapsedTime)}</div>\n                      <div className=\"text-[10px] text-muted-foreground uppercase tracking-wide\">Time</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\" className=\"max-w-[200px]\">\n                    <p className=\"text-xs\">Total time taken to complete the typing test.</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n\n              {/* Detail stats */}\n              <div className=\"grid grid-cols-3 gap-3 text-center text-sm border-t border-border/50 pt-4\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"cursor-help\">\n                      <span className=\"text-muted-foreground\">Characters: </span>\n                      <span className=\"font-mono font-medium\">{userInput.length}</span>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\">\n                    <p className=\"text-xs\">Total characters you typed accurately</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"cursor-help\">\n                      <span className=\"text-muted-foreground\">Errors: </span>\n                      <span className={`font-mono font-medium ${errors > 0 ? 'text-red-500' : 'text-green-500'}`}>{errors}</span>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\">\n                    <p className=\"text-xs\">{errors === 0 ? \"Perfect! No typing errors\" : `${errors} character${errors > 1 ? 's' : ''} typed incorrectly`}</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"cursor-help\">\n                      <span className=\"text-muted-foreground\">Language: </span>\n                      <span className=\"font-medium\">{PROGRAMMING_LANGUAGES[language as keyof typeof PROGRAMMING_LANGUAGES]?.name || language}</span>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\">\n                    <p className=\"text-xs\">The programming language of this code snippet</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n\n              {/* Action buttons */}\n              <div className=\"flex flex-wrap items-center justify-center gap-2 mt-4\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button\n                      variant=\"outline\"\n                      onClick={() => {\n                        setCompletionDialogOpen(false);\n                        resetTest();\n                      }}\n                      disabled={isLoading}\n                      className=\"gap-1.5\"\n                    >\n                      <RotateCcw className=\"w-4 h-4\" />\n                      Try Again\n                      <kbd className=\"ml-1 px-1 py-0.5 text-[10px] rounded bg-muted hidden sm:inline\">Esc</kbd>\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"bottom\">\n                    <p className=\"text-xs\">Retry the same code snippet to improve your score</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button\n                      variant=\"outline\"\n                      onClick={() => {\n                        setCompletionDialogOpen(false);\n                        fetchCodeSnippet(true);\n                      }}\n                      disabled={isLoading}\n                      className=\"gap-1.5\"\n                    >\n                      <Zap className=\"w-4 h-4\" />\n                      New Snippet\n                      <kbd className=\"ml-1 px-1 py-0.5 text-[10px] rounded bg-muted hidden sm:inline\">Tab</kbd>\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"bottom\">\n                    <p className=\"text-xs\">Generate a fresh AI code snippet to practice</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button\n                      variant=\"default\"\n                      onClick={() => {\n                        setCompletionDialogOpen(false);\n                        setShareDialogOpen(true);\n                      }}\n                      data-testid=\"button-share\"\n                      className=\"gap-1.5\"\n                    >\n                      <Share2 className=\"w-4 h-4\" />\n                      Share\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"bottom\">\n                    <p className=\"text-xs\">Share your achievement with certificate, card, or link</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n            </DialogContent>\n          </Dialog>\n\n          {/* Login prompt */}\n          {!user && (\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Card className=\"p-4 mt-6 bg-primary/5 border-primary/20 cursor-help\">\n                  <p className=\"text-center text-sm\">\n                    <a href=\"/login\" className=\"text-primary hover:underline\">Sign in</a> to save your results and compete on the leaderboard!\n                  </p>\n                </Card>\n              </TooltipTrigger>\n              <TooltipContent side=\"top\" className=\"max-w-[250px]\">\n                <p className=\"font-medium mb-1\">Create Your Profile</p>\n                <p className=\"text-xs text-muted-foreground\">Track your progress, earn achievements, and compete with other coders on the global leaderboard.</p>\n              </TooltipContent>\n            </Tooltip>\n          )}\n        </div>\n\n        {/* Share Dialog with Tabs */}\n        <Dialog open={shareDialogOpen} onOpenChange={setShareDialogOpen}>\n          <DialogContent className=\"sm:max-w-[650px] max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle className=\"flex items-center gap-2\">\n                <Share2 className=\"w-5 h-5\" />\n                Share Your Code Typing Result\n              </DialogTitle>\n              <DialogDescription>\n                Share your {PROGRAMMING_LANGUAGES[language as keyof typeof PROGRAMMING_LANGUAGES]?.name} typing achievement with others!\n              </DialogDescription>\n            </DialogHeader>\n            \n            <Tabs defaultValue=\"certificate\" className=\"w-full\">\n              <TabsList className=\"grid w-full grid-cols-3\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <TabsTrigger value=\"certificate\" className=\"gap-2\" data-testid=\"tab-certificate\">\n                      <Award className=\"w-4 h-4\" />\n                      Certificate\n                    </TabsTrigger>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"bottom\">\n                    <p className=\"text-xs\">Professional 1200Ã—675 certificate with verification ID</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <TabsTrigger value=\"visual\" className=\"gap-2\" data-testid=\"tab-visual-card\">\n                      <Image className=\"w-4 h-4\" />\n                      Card\n                    </TabsTrigger>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"bottom\">\n                    <p className=\"text-xs\">Social media optimized image card</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <TabsTrigger value=\"link\" className=\"gap-2\" data-testid=\"tab-link-sharing\">\n                      <Link2 className=\"w-4 h-4\" />\n                      Link\n                    </TabsTrigger>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"bottom\">\n                    <p className=\"text-xs\">Share directly to 8 social platforms</p>\n                  </TooltipContent>\n                </Tooltip>\n              </TabsList>\n              \n              <TabsContent value=\"certificate\" className=\"mt-4\">\n                <CodeCertificate\n                  wpm={wpm}\n                  rawWpm={rawWpm}\n                  accuracy={accuracy}\n                  consistency={consistency}\n                  language={language}\n                  languageName={PROGRAMMING_LANGUAGES[language as keyof typeof PROGRAMMING_LANGUAGES]?.name || language}\n                  difficulty={difficulty}\n                  characters={userInput.length}\n                  errors={errors}\n                  time={formatTime(elapsedTime)}\n                  username={user?.username}\n                />\n              </TabsContent>\n              \n              <TabsContent value=\"visual\" className=\"mt-4\">\n                <CodeShareCard\n                  wpm={wpm}\n                  rawWpm={rawWpm}\n                  accuracy={accuracy}\n                  consistency={consistency}\n                  language={language}\n                  languageName={PROGRAMMING_LANGUAGES[language as keyof typeof PROGRAMMING_LANGUAGES]?.name || language}\n                  difficulty={difficulty}\n                  characters={userInput.length}\n                  errors={errors}\n                  time={formatTime(elapsedTime)}\n                  username={user?.username}\n                />\n              </TabsContent>\n              \n              <TabsContent value=\"link\" className=\"mt-4 space-y-4\">\n                <div className=\"bg-muted/50 rounded-lg p-4 text-center\">\n                  <div className=\"text-4xl font-bold text-primary mb-2\">{wpm} WPM</div>\n                  <div className=\"text-sm text-muted-foreground\">\n                    {accuracy}% accuracy â€¢ {consistency}% consistency\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    {userInput.length} characters â€¢ {PROGRAMMING_LANGUAGES[language as keyof typeof PROGRAMMING_LANGUAGES]?.name}\n                  </div>\n                </div>\n                \n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center gap-2\">\n                    <Input \n                      value={shareUrl || `${window.location.origin}/code-mode`}\n                      readOnly\n                      className=\"flex-1 font-mono text-sm\"\n                    />\n                    <Button\n                      onClick={copyShareLink}\n                      variant=\"outline\"\n                      size=\"icon\"\n                      data-testid=\"button-copy-link\"\n                    >\n                      <Copy className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                  \n                  <p className=\"text-xs text-center text-muted-foreground uppercase tracking-wide\">Share on Social Media</p>\n                  \n                  <div className=\"grid grid-cols-4 gap-2\">\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button\n                          onClick={() => shareToSocial(\"twitter\")}\n                          className=\"flex items-center justify-center gap-1.5 p-2.5 rounded-xl bg-[#1DA1F2]/10 hover:bg-[#1DA1F2]/25 border border-[#1DA1F2]/20 transition-all\"\n                          data-testid=\"share-twitter\"\n                        >\n                          <Twitter className=\"w-4 h-4 text-[#1DA1F2]\" />\n                          <span className=\"text-xs font-medium hidden sm:inline\">Twitter</span>\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"top\"><p className=\"text-xs\">Tweet your achievement</p></TooltipContent>\n                    </Tooltip>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button\n                          onClick={() => shareToSocial(\"discord\")}\n                          className=\"flex items-center justify-center gap-1.5 p-2.5 rounded-xl bg-[#5865F2]/10 hover:bg-[#5865F2]/25 border border-[#5865F2]/20 transition-all\"\n                          data-testid=\"share-discord\"\n                        >\n                          <svg className=\"w-4 h-4 text-[#5865F2]\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                            <path d=\"M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z\"/>\n                          </svg>\n                          <span className=\"text-xs font-medium hidden sm:inline\">Discord</span>\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"top\"><p className=\"text-xs\">Copy formatted message for Discord</p></TooltipContent>\n                    </Tooltip>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button\n                          onClick={() => shareToSocial(\"reddit\")}\n                          className=\"flex items-center justify-center gap-1.5 p-2.5 rounded-xl bg-[#FF4500]/10 hover:bg-[#FF4500]/25 border border-[#FF4500]/20 transition-all\"\n                          data-testid=\"share-reddit\"\n                        >\n                          <svg className=\"w-4 h-4 text-[#FF4500]\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                            <path d=\"M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z\"/>\n                          </svg>\n                          <span className=\"text-xs font-medium hidden sm:inline\">Reddit</span>\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"top\"><p className=\"text-xs\">Post to Reddit</p></TooltipContent>\n                    </Tooltip>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button\n                          onClick={() => shareToSocial(\"whatsapp\")}\n                          className=\"flex items-center justify-center gap-1.5 p-2.5 rounded-xl bg-[#25D366]/10 hover:bg-[#25D366]/25 border border-[#25D366]/20 transition-all\"\n                          data-testid=\"share-whatsapp\"\n                        >\n                          <MessageCircle className=\"w-4 h-4 text-[#25D366]\" />\n                          <span className=\"text-xs font-medium hidden sm:inline\">WhatsApp</span>\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"top\"><p className=\"text-xs\">Send via WhatsApp</p></TooltipContent>\n                    </Tooltip>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button\n                          onClick={() => shareToSocial(\"telegram\")}\n                          className=\"flex items-center justify-center gap-1.5 p-2.5 rounded-xl bg-[#0088cc]/10 hover:bg-[#0088cc]/25 border border-[#0088cc]/20 transition-all\"\n                          data-testid=\"share-telegram\"\n                        >\n                          <Send className=\"w-4 h-4 text-[#0088cc]\" />\n                          <span className=\"text-xs font-medium hidden sm:inline\">Telegram</span>\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"top\"><p className=\"text-xs\">Share via Telegram</p></TooltipContent>\n                    </Tooltip>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button\n                          onClick={() => shareToSocial(\"linkedin\")}\n                          className=\"flex items-center justify-center gap-1.5 p-2.5 rounded-xl bg-[#0A66C2]/10 hover:bg-[#0A66C2]/25 border border-[#0A66C2]/20 transition-all\"\n                          data-testid=\"share-linkedin\"\n                        >\n                          <Linkedin className=\"w-4 h-4 text-[#0A66C2]\" />\n                          <span className=\"text-xs font-medium hidden sm:inline\">LinkedIn</span>\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"top\"><p className=\"text-xs\">Post to LinkedIn</p></TooltipContent>\n                    </Tooltip>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button\n                          onClick={() => shareToSocial(\"facebook\")}\n                          className=\"flex items-center justify-center gap-1.5 p-2.5 rounded-xl bg-[#1877F2]/10 hover:bg-[#1877F2]/25 border border-[#1877F2]/20 transition-all\"\n                          data-testid=\"share-facebook\"\n                        >\n                          <Facebook className=\"w-4 h-4 text-[#1877F2]\" />\n                          <span className=\"text-xs font-medium hidden sm:inline\">Facebook</span>\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"top\"><p className=\"text-xs\">Share on Facebook</p></TooltipContent>\n                    </Tooltip>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <button\n                          onClick={() => shareToSocial(\"email\")}\n                          className=\"flex items-center justify-center gap-1.5 p-2.5 rounded-xl bg-gray-500/10 hover:bg-gray-500/25 border border-gray-500/20 transition-all\"\n                          data-testid=\"share-email\"\n                        >\n                          <Mail className=\"w-4 h-4 text-gray-400\" />\n                          <span className=\"text-xs font-medium hidden sm:inline\">Email</span>\n                        </button>\n                      </TooltipTrigger>\n                      <TooltipContent side=\"top\"><p className=\"text-xs\">Send via Email</p></TooltipContent>\n                    </Tooltip>\n                  </div>\n                  \n                  {'share' in navigator && (\n                    <Button\n                      onClick={handleNativeShare}\n                      variant=\"secondary\"\n                      className=\"w-full gap-2\"\n                      data-testid=\"button-share-native\"\n                    >\n                      <Share2 className=\"w-4 h-4\" />\n                      Share via...\n                    </Button>\n                  )}\n                </div>\n              </TabsContent>\n            </Tabs>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </TooltipProvider>\n  );\n}\n","path":null,"size_bytes":118485,"size_tokens":null},"client/src/pages/shared-result.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useRoute } from \"wouter\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Code, Trophy, Zap, Target, Clock, AlertCircle, Award } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { CodeCertificate } from \"@/components/CodeCertificate\";\n\ninterface SharedResult {\n  id: number;\n  shareId: string;\n  username: string;\n  programmingLanguage: string;\n  framework: string | null;\n  difficulty: string;\n  testMode: string;\n  wpm: number;\n  accuracy: number;\n  errors: number;\n  syntaxErrors: number;\n  duration: number;\n  codeContent: string;\n  createdAt: string;\n  certificate?: {\n    id: number;\n    wpm: number;\n    accuracy: number;\n    consistency: number;\n    duration: number;\n    metadata?: any;\n  } | null;\n}\n\nexport default function SharedResult() {\n  const [, params] = useRoute(\"/share/:shareId\");\n  const shareId = params?.shareId;\n  const { toast } = useToast();\n  \n  const [result, setResult] = useState<SharedResult | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [showCertificate, setShowCertificate] = useState(false);\n\n  useEffect(() => {\n    const fetchSharedResult = async () => {\n      if (!shareId) {\n        setError(\"Invalid share link\");\n        setIsLoading(false);\n        return;\n      }\n\n      try {\n        const response = await fetch(`/api/code/share/${shareId}`);\n        if (!response.ok) {\n          if (response.status === 404) {\n            setError(\"This shared result was not found. It may have been deleted.\");\n          } else {\n            setError(\"Failed to load shared result\");\n          }\n          setIsLoading(false);\n          return;\n        }\n        \n        const data = await response.json();\n        setResult(data);\n      } catch (err) {\n        console.error(\"Error fetching shared result:\", err);\n        setError(\"Failed to load shared result\");\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    fetchSharedResult();\n  }, [shareId]);\n\n  const formatDuration = (seconds: number): string => {\n    const mins = Math.floor(seconds / 60);\n    const secs = seconds % 60;\n    return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;\n  };\n\n  const getDifficultyColor = (difficulty: string): string => {\n    const colors: Record<string, string> = {\n      easy: \"text-green-500\",\n      medium: \"text-yellow-500\",\n      hard: \"text-red-500\",\n    };\n    return colors[difficulty] || \"text-gray-500\";\n  };\n\n  const getTestModeLabel = (mode: string): string => {\n    const labels: Record<string, string> = {\n      normal: \"Normal\",\n      expert: \"Expert\",\n      master: \"Master\",\n    };\n    return labels[mode] || mode;\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4\"></div>\n          <p className=\"text-muted-foreground\">Loading shared result...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (error || !result) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <Card className=\"max-w-md w-full p-8 text-center\">\n          <AlertCircle className=\"w-16 h-16 mx-auto mb-4 text-destructive\" />\n          <h2 className=\"text-2xl font-bold mb-2\">Result Not Found</h2>\n          <p className=\"text-muted-foreground mb-6\">\n            {error || \"The shared result you're looking for doesn't exist or has been removed.\"}\n          </p>\n          <Button onClick={() => window.location.href = '/code-mode'} data-testid=\"button-try-code-mode\">\n            <Code className=\"w-4 h-4 mr-2\" />\n            Try Code Mode\n          </Button>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <div className=\"container mx-auto px-4 py-8 max-w-4xl\">\n        <div className=\"text-center mb-8\">\n          <h1 className=\"text-4xl font-bold mb-2\" data-testid=\"text-page-title\">\n            Code Typing Result\n          </h1>\n          <p className=\"text-muted-foreground\">\n            Shared by <span className=\"font-semibold text-primary\" data-testid=\"text-username\">{result.username}</span>\n          </p>\n        </div>\n\n        <Card className=\"p-6 mb-6\">\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-6\">\n            <div className=\"text-center\" data-testid=\"stat-wpm\">\n              <div className=\"flex items-center justify-center gap-2 text-muted-foreground text-sm mb-2\">\n                <Zap className=\"w-5 h-5\" /> WPM\n              </div>\n              <div className=\"text-5xl font-bold text-primary\">{result.wpm}</div>\n            </div>\n            <div className=\"text-center\" data-testid=\"stat-accuracy\">\n              <div className=\"flex items-center justify-center gap-2 text-muted-foreground text-sm mb-2\">\n                <Target className=\"w-5 h-5\" /> Accuracy\n              </div>\n              <div className=\"text-5xl font-bold\">{result.accuracy}%</div>\n            </div>\n            <div className=\"text-center\" data-testid=\"stat-errors\">\n              <div className=\"text-muted-foreground text-sm mb-2\">Errors</div>\n              <div className=\"text-5xl font-bold text-red-500\">{result.errors}</div>\n            </div>\n            <div className=\"text-center\" data-testid=\"stat-duration\">\n              <div className=\"flex items-center justify-center gap-2 text-muted-foreground text-sm mb-2\">\n                <Clock className=\"w-5 h-5\" /> Duration\n              </div>\n              <div className=\"text-5xl font-bold\">{formatDuration(result.duration)}</div>\n            </div>\n          </div>\n        </Card>\n\n        <Card className=\"p-6 mb-6\">\n          <h3 className=\"text-lg font-semibold mb-4\">Test Details</h3>\n          <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4\">\n            <div data-testid=\"detail-language\">\n              <div className=\"text-sm text-muted-foreground mb-1\">Language</div>\n              <div className=\"font-semibold capitalize\">{result.programmingLanguage}</div>\n            </div>\n            <div data-testid=\"detail-difficulty\">\n              <div className=\"text-sm text-muted-foreground mb-1\">Difficulty</div>\n              <div className={`font-semibold capitalize ${getDifficultyColor(result.difficulty)}`}>\n                {result.difficulty}\n              </div>\n            </div>\n            <div data-testid=\"detail-mode\">\n              <div className=\"text-sm text-muted-foreground mb-1\">Test Mode</div>\n              <div className=\"font-semibold\">{getTestModeLabel(result.testMode)}</div>\n            </div>\n            {result.framework && (\n              <div data-testid=\"detail-framework\">\n                <div className=\"text-sm text-muted-foreground mb-1\">Framework</div>\n                <div className=\"font-semibold\">{result.framework}</div>\n              </div>\n            )}\n            <div data-testid=\"detail-syntax-errors\">\n              <div className=\"text-sm text-muted-foreground mb-1\">Syntax Errors</div>\n              <div className=\"font-semibold\">{result.syntaxErrors}</div>\n            </div>\n          </div>\n        </Card>\n\n        <Card className=\"p-6 mb-6\">\n          <h3 className=\"text-lg font-semibold mb-4\">Code Snippet</h3>\n          <div \n            className=\"bg-muted p-4 rounded-lg overflow-x-auto\"\n            data-testid=\"code-snippet\"\n          >\n            <pre className=\"font-mono text-sm whitespace-pre-wrap break-all\">\n              {result.codeContent}\n            </pre>\n          </div>\n        </Card>\n\n        <div className=\"flex gap-4 justify-center flex-wrap\">\n          {result.certificate && (\n            <Button variant=\"default\" onClick={() => setShowCertificate(true)} data-testid=\"button-view-certificate\">\n              <Award className=\"w-4 h-4 mr-2\" />\n              View Certificate\n            </Button>\n          )}\n          <Button onClick={() => window.location.href = '/code-mode'} data-testid=\"button-try-yourself\">\n            <Code className=\"w-4 h-4 mr-2\" />\n            Try This Yourself\n          </Button>\n          <Button variant=\"outline\" onClick={() => window.location.href = '/code-leaderboard'} data-testid=\"button-view-leaderboard\">\n            <Trophy className=\"w-4 h-4 mr-2\" />\n            View Leaderboard\n          </Button>\n        </div>\n\n        <Dialog open={showCertificate} onOpenChange={setShowCertificate}>\n          <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>Code Typing Certificate</DialogTitle>\n              <DialogDescription>\n                Earned on {result.certificate && new Date(result.createdAt).toLocaleDateString()}\n              </DialogDescription>\n            </DialogHeader>\n            {result.certificate && (\n              <div className=\"mt-4\">\n                <CodeCertificate\n                  wpm={result.certificate.wpm}\n                  rawWpm={result.certificate.metadata?.rawWpm || result.wpm}\n                  accuracy={result.certificate.accuracy}\n                  consistency={result.certificate.consistency}\n                  language={result.programmingLanguage}\n                  languageName={result.certificate.metadata?.languageName || result.programmingLanguage.toUpperCase()}\n                  difficulty={result.difficulty}\n                  characters={result.certificate.metadata?.characters || result.codeContent.length}\n                  errors={result.certificate.metadata?.errors || result.errors}\n                  time={formatDuration(result.certificate.duration || result.duration)}\n                  username={result.certificate.metadata?.username || result.username}\n                  date={result.certificate.metadata?.date ? new Date(result.certificate.metadata.date) : new Date(result.createdAt)}\n                />\n              </div>\n            )}\n          </DialogContent>\n        </Dialog>\n\n        <div className=\"mt-8 text-center text-sm text-muted-foreground\">\n          <p>Want to improve your coding typing speed?</p>\n          <a href=\"/register\" className=\"text-primary hover:underline font-semibold\">\n            Create a free account\n          </a>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10551,"size_tokens":null},"client/src/pages/chapter-typing.tsx":{"content":"import { useState, useEffect, useRef, useCallback, useMemo } from \"react\";\nimport { useRoute, useLocation } from \"wouter\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { BookOpen, Trophy, Zap, Target, ArrowLeft, ArrowRight, Loader2, RefreshCw, AlertCircle, WifiOff, Share2, Award } from \"lucide-react\";\nimport confetti from \"canvas-confetti\";\nimport type { Book, BookParagraph, InsertBookTypingTest } from \"@shared/schema\";\nimport { calculateWPM, calculateAccuracy } from \"@/lib/typing-utils\";\nimport { BookCertificate } from \"@/components/BookCertificate\";\n\ninterface CachedChapterData {\n  book: Book;\n  paragraphs: BookParagraph[];\n  timestamp: number;\n}\n\nconst CHAPTER_CACHE_TTL = 30 * 60 * 1000;\n\nfunction getChapterCache(slug: string, chapterNum: number): CachedChapterData | null {\n  try {\n    const cached = localStorage.getItem(`chapter_cache_${slug}_${chapterNum}`);\n    if (!cached) return null;\n    \n    const parsed: CachedChapterData = JSON.parse(cached);\n    const age = Date.now() - parsed.timestamp;\n    \n    if (age < CHAPTER_CACHE_TTL) {\n      return parsed;\n    }\n    \n    localStorage.removeItem(`chapter_cache_${slug}_${chapterNum}`);\n    return null;\n  } catch {\n    return null;\n  }\n}\n\nfunction setChapterCache(slug: string, chapterNum: number, book: Book, paragraphs: BookParagraph[]): void {\n  try {\n    const cached: CachedChapterData = {\n      book,\n      paragraphs,\n      timestamp: Date.now(),\n    };\n    localStorage.setItem(`chapter_cache_${slug}_${chapterNum}`, JSON.stringify(cached));\n  } catch {\n  }\n}\n\nasync function fetchBook(slug: string): Promise<Book> {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), 15000);\n  \n  try {\n    const res = await fetch(`/api/books/${slug}`, {\n      signal: controller.signal,\n      credentials: 'include',\n    });\n    \n    clearTimeout(timeoutId);\n    \n    if (!res.ok) {\n      if (res.status === 404) {\n        throw new Error('BOOK_NOT_FOUND');\n      }\n      if (res.status >= 500) {\n        throw new Error('SERVER_ERROR');\n      }\n      throw new Error(`HTTP_${res.status}`);\n    }\n    \n    return res.json();\n  } catch (error: any) {\n    clearTimeout(timeoutId);\n    \n    if (error.name === 'AbortError') {\n      throw new Error('TIMEOUT');\n    }\n    \n    if (error.message === 'Failed to fetch' || error.message.includes('NetworkError')) {\n      throw new Error('NETWORK_ERROR');\n    }\n    \n    throw error;\n  }\n}\n\nasync function fetchChapterParagraphs(bookId: number, chapter: number): Promise<BookParagraph[]> {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), 15000);\n  \n  try {\n    const res = await fetch(`/api/books/${bookId}/chapters/${chapter}`, {\n      signal: controller.signal,\n      credentials: 'include',\n    });\n    \n    clearTimeout(timeoutId);\n    \n    if (!res.ok) {\n      if (res.status === 404) {\n        throw new Error('CHAPTER_NOT_FOUND');\n      }\n      if (res.status >= 500) {\n        throw new Error('SERVER_ERROR');\n      }\n      throw new Error(`HTTP_${res.status}`);\n    }\n    \n    return res.json();\n  } catch (error: any) {\n    clearTimeout(timeoutId);\n    \n    if (error.name === 'AbortError') {\n      throw new Error('TIMEOUT');\n    }\n    \n    if (error.message === 'Failed to fetch' || error.message.includes('NetworkError')) {\n      throw new Error('NETWORK_ERROR');\n    }\n    \n    throw error;\n  }\n}\n\nfunction formatTime(seconds: number): string {\n  const mins = Math.floor(seconds / 60);\n  const secs = seconds % 60;\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\n}\n\nfunction LoadingSkeleton() {\n  return (\n    <div className=\"container mx-auto py-8 px-4 max-w-6xl\">\n      <div className=\"mb-6\">\n        <Skeleton className=\"h-9 w-40 mb-4\" />\n        <div className=\"flex items-center justify-between flex-wrap gap-4\">\n          <div className=\"space-y-2\">\n            <Skeleton className=\"h-9 w-64\" />\n            <Skeleton className=\"h-5 w-48\" />\n          </div>\n          <div className=\"flex gap-2\">\n            <Skeleton className=\"h-9 w-24\" />\n            <Skeleton className=\"h-6 w-32\" />\n            <Skeleton className=\"h-9 w-24\" />\n          </div>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-4 gap-4 mb-6\">\n        {Array.from({ length: 4 }).map((_, i) => (\n          <Card key={i} className=\"p-4 text-center\">\n            <Skeleton className=\"h-4 w-16 mx-auto mb-2\" />\n            <Skeleton className=\"h-10 w-20 mx-auto\" />\n          </Card>\n        ))}\n      </div>\n\n      <Card className=\"p-6 mb-6\">\n        <div className=\"space-y-3\">\n          <Skeleton className=\"h-6 w-full\" />\n          <Skeleton className=\"h-6 w-full\" />\n          <Skeleton className=\"h-6 w-3/4\" />\n          <Skeleton className=\"h-6 w-full\" />\n          <Skeleton className=\"h-6 w-5/6\" />\n        </div>\n      </Card>\n    </div>\n  );\n}\n\ninterface ErrorStateProps {\n  error: Error;\n  onRetry: () => void;\n  isRetrying: boolean;\n  onGoBack: () => void;\n  cachedData: CachedChapterData | null;\n  onUseCached: () => void;\n  slug: string;\n}\n\nfunction ErrorState({ error, onRetry, isRetrying, onGoBack, cachedData, onUseCached, slug }: ErrorStateProps) {\n  const errorType = error.message;\n  \n  let icon = <AlertCircle className=\"w-16 h-16 text-destructive\" />;\n  let title = \"Unable to Load Chapter\";\n  let description = \"Something went wrong while loading the chapter.\";\n  let canRetry = true;\n  \n  switch (errorType) {\n    case 'NETWORK_ERROR':\n      icon = <WifiOff className=\"w-16 h-16 text-muted-foreground\" />;\n      title = \"No Internet Connection\";\n      description = \"Please check your internet connection and try again.\";\n      break;\n    case 'TIMEOUT':\n      title = \"Request Timed Out\";\n      description = \"The server took too long to respond. Please try again.\";\n      break;\n    case 'SERVER_ERROR':\n      title = \"Server Error\";\n      description = \"The server encountered an error. Please try again later.\";\n      break;\n    case 'BOOK_NOT_FOUND':\n      icon = <BookOpen className=\"w-16 h-16 text-muted-foreground\" />;\n      title = \"Book Not Found\";\n      description = \"This book doesn't exist or may have been removed.\";\n      canRetry = false;\n      break;\n    case 'CHAPTER_NOT_FOUND':\n      title = \"Chapter Not Found\";\n      description = \"This chapter doesn't exist or hasn't been loaded yet.\";\n      canRetry = false;\n      break;\n  }\n  \n  return (\n    <div className=\"container mx-auto py-8 px-4 max-w-6xl\">\n      <Button\n        variant=\"ghost\"\n        onClick={onGoBack}\n        className=\"mb-6\"\n        data-testid=\"button-back-error\"\n      >\n        <ArrowLeft className=\"w-4 h-4 mr-2\" />\n        Back to Book\n      </Button>\n      \n      <div className=\"flex flex-col items-center justify-center min-h-[50vh] gap-6 p-4\">\n        {icon}\n        <div className=\"text-center max-w-md\">\n          <h2 className=\"text-2xl font-semibold mb-2\">{title}</h2>\n          <p className=\"text-muted-foreground\">{description}</p>\n        </div>\n        <div className=\"flex flex-col sm:flex-row gap-3\">\n          {canRetry && (\n            <Button\n              onClick={onRetry}\n              disabled={isRetrying}\n              data-testid=\"button-retry-chapter\"\n            >\n              {isRetrying ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Retrying...\n                </>\n              ) : (\n                <>\n                  <RefreshCw className=\"w-4 h-4 mr-2\" />\n                  Try Again\n                </>\n              )}\n            </Button>\n          )}\n          {cachedData && (\n            <Button\n              variant=\"outline\"\n              onClick={onUseCached}\n              data-testid=\"button-use-cached-chapter\"\n            >\n              <BookOpen className=\"w-4 h-4 mr-2\" />\n              Use Offline Data\n            </Button>\n          )}\n          <Button variant=\"outline\" onClick={onGoBack} data-testid=\"button-go-back-chapter\">\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Back to Book\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function ChapterTyping() {\n  const [match, params] = useRoute(\"/books/:slug/chapter/:chapterNum\");\n  const [, setLocation] = useLocation();\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const slug = params?.slug || '';\n  const chapterNum = params?.chapterNum ? parseInt(params.chapterNum) : 0;\n\n  const [chapterText, setChapterText] = useState(\"\");\n  const [userInput, setUserInput] = useState(\"\");\n  const [startTime, setStartTime] = useState<number | null>(null);\n  const [isActive, setIsActive] = useState(false);\n  const [isFinished, setIsFinished] = useState(false);\n  const [wpm, setWpm] = useState(0);\n  const [accuracy, setAccuracy] = useState(100);\n  const [errors, setErrors] = useState(0);\n  const [elapsedTime, setElapsedTime] = useState(0);\n  const [isComposing, setIsComposing] = useState(false);\n  const [completedTestData, setCompletedTestData] = useState<{\n    duration: number;\n    wpm: number;\n    accuracy: number;\n    errors: number;\n  } | null>(null);\n  const [paragraphs, setParagraphs] = useState<BookParagraph[]>([]);\n  const [cursorPosition, setCursorPosition] = useState({ left: 0, top: 0, height: 40 });\n  const [useCachedData, setUseCachedData] = useState(false);\n  const [cachedData, setCachedData] = useState<CachedChapterData | null>(null);\n  const [saveRetryCount, setSaveRetryCount] = useState(0);\n  const [pendingResult, setPendingResult] = useState<Omit<InsertBookTypingTest, 'userId'> | null>(null);\n  const [shareDialogOpen, setShareDialogOpen] = useState(false);\n  const [lastResultSnapshot, setLastResultSnapshot] = useState<{\n    wpm: number;\n    accuracy: number;\n    duration: number;\n    consistency: number;\n    bookTitle: string;\n    author: string;\n    chapter: number;\n    chapterTitle: string;\n    paragraphsCompleted: number;\n    wordsTyped: number;\n  } | null>(null);\n  \n  const inputRef = useRef<HTMLTextAreaElement>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  const correctSpanRef = useRef<HTMLSpanElement>(null);\n  const incorrectSpanRef = useRef<HTMLSpanElement>(null);\n\n  useEffect(() => {\n    if (slug && chapterNum) {\n      const cached = getChapterCache(slug, chapterNum);\n      setCachedData(cached);\n    }\n  }, [slug, chapterNum]);\n\n  const { \n    data: book, \n    isLoading: bookLoading,\n    isError: bookError,\n    error: bookErrorData,\n    isFetching: bookFetching,\n    refetch: refetchBook\n  } = useQuery<Book, Error>({\n    queryKey: ['book', slug],\n    queryFn: () => fetchBook(slug),\n    enabled: !!slug && !useCachedData,\n    staleTime: 10 * 60 * 1000,\n    gcTime: 30 * 60 * 1000,\n    retry: (failureCount, error) => {\n      if (error.message === 'BOOK_NOT_FOUND') return false;\n      return failureCount < 2;\n    },\n    retryDelay: 1000,\n  });\n\n  const { \n    data: chapterParagraphs = [], \n    isLoading: chaptersLoading,\n    isError: chaptersError,\n    error: chaptersErrorData,\n    isFetching: chaptersFetching,\n    refetch: refetchChapter\n  } = useQuery<BookParagraph[], Error>({\n    queryKey: ['chapter', book?.id, chapterNum],\n    queryFn: () => fetchChapterParagraphs(book!.id, chapterNum),\n    enabled: !!book && chapterNum > 0 && !useCachedData,\n    staleTime: 10 * 60 * 1000,\n    gcTime: 30 * 60 * 1000,\n    retry: (failureCount, error) => {\n      if (error.message === 'CHAPTER_NOT_FOUND') return false;\n      return failureCount < 2;\n    },\n    retryDelay: 1000,\n  });\n  \n  const displayBook = useCachedData && cachedData ? cachedData.book : book;\n  const displayParagraphs = useCachedData && cachedData ? cachedData.paragraphs : chapterParagraphs;\n  \n  useEffect(() => {\n    if (book && chapterParagraphs.length > 0 && slug && chapterNum && !useCachedData) {\n      setChapterCache(slug, chapterNum, book, chapterParagraphs);\n    }\n  }, [book, chapterParagraphs, slug, chapterNum, useCachedData]);\n\n  useEffect(() => {\n    if (displayParagraphs.length > 0) {\n      const text = displayParagraphs.map(p => p.text).join('\\n\\n');\n      setChapterText(text);\n      setParagraphs(displayParagraphs);\n      \n      const progressKey = `chapter-progress-${slug}-${chapterNum}`;\n      let progressRestored = false;\n      \n      try {\n        const savedProgress = localStorage.getItem(progressKey);\n        if (savedProgress) {\n          const { userInput: savedInput, timestamp, elapsedSeconds } = JSON.parse(savedProgress);\n          const age = Date.now() - timestamp;\n          if (age < 24 * 60 * 60 * 1000 && savedInput.length > 0 && savedInput.length < text.length) {\n            setUserInput(savedInput);\n            setIsActive(true);\n            const resumeTime = elapsedSeconds ? Date.now() - (elapsedSeconds * 1000) : Date.now() - 1000;\n            setStartTime(resumeTime);\n            progressRestored = true;\n            toast({\n              title: \"Progress Restored\",\n              description: `Resuming from where you left off (${Math.round((savedInput.length / text.length) * 100)}% complete).`,\n            });\n          } else {\n            localStorage.removeItem(progressKey);\n          }\n        }\n      } catch (e) {\n      }\n      \n      if (!progressRestored) {\n        resetTestState();\n      }\n    }\n  }, [displayParagraphs, slug, chapterNum]);\n\n  useEffect(() => {\n    if (userInput && chapterText && !isFinished && slug && chapterNum && startTime) {\n      const progressKey = `chapter-progress-${slug}-${chapterNum}`;\n      const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);\n      try {\n        localStorage.setItem(progressKey, JSON.stringify({\n          userInput,\n          timestamp: Date.now(),\n          elapsedSeconds,\n        }));\n      } catch (e) {\n      }\n    }\n  }, [userInput, chapterText, isFinished, slug, chapterNum, startTime]);\n\n  useEffect(() => {\n    if (isFinished && slug && chapterNum) {\n      const progressKey = `chapter-progress-${slug}-${chapterNum}`;\n      try {\n        localStorage.removeItem(progressKey);\n      } catch (e) {\n      }\n    }\n  }, [isFinished, slug, chapterNum]);\n\n  const saveTestMutation = useMutation({\n    mutationFn: async (result: Omit<InsertBookTypingTest, 'userId'>) => {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 10000);\n      \n      try {\n        const res = await fetch('/api/book-tests', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify(result),\n          credentials: 'include',\n          signal: controller.signal,\n        });\n        \n        clearTimeout(timeoutId);\n        \n        if (!res.ok) {\n          const errorData = await res.json().catch(() => ({}));\n          throw new Error(errorData.message || `HTTP ${res.status}`);\n        }\n        return res.json();\n      } catch (error: any) {\n        clearTimeout(timeoutId);\n        throw error;\n      }\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Chapter Complete!\",\n        description: \"Your progress has been saved.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"bookStats\"] });\n      setPendingResult(null);\n      setSaveRetryCount(0);\n    },\n    onError: (error: any) => {\n      const isNetworkError = error.message === 'Failed to fetch' || \n                             error.name === 'AbortError' ||\n                             error.message.includes('NetworkError');\n      \n      if (isNetworkError && saveRetryCount < 3) {\n        setSaveRetryCount(prev => prev + 1);\n        toast({\n          title: \"Save Failed\",\n          description: `Retrying... (${saveRetryCount + 1}/3)`,\n        });\n      } else {\n        toast({\n          title: \"Failed to Save Progress\",\n          description: error.message?.includes(\"401\")\n            ? \"Please log in to save your progress.\"\n            : \"Could not save your progress. Your stats are still visible above.\",\n          variant: \"destructive\",\n        });\n      }\n    },\n    retry: 2,\n    retryDelay: 1000,\n  });\n\n  const stats = useMemo(() => {\n    if (!isActive || !startTime || !chapterText) {\n      return { wpm: 0, accuracy: 100, errors: 0 };\n    }\n    \n    const chars = userInput.length;\n    const errorCount = userInput.split(\"\").filter((char, i) => char !== chapterText[i]).length;\n    const correctChars = chars - errorCount;\n    const timeElapsed = (Date.now() - startTime) / 1000;\n    \n    return {\n      wpm: calculateWPM(correctChars, timeElapsed),\n      accuracy: calculateAccuracy(correctChars, chars),\n      errors: errorCount,\n    };\n  }, [userInput, isActive, startTime, chapterText]);\n\n  useEffect(() => {\n    if (!isActive || isFinished) return;\n    \n    const timer = setTimeout(() => {\n      setWpm(stats.wpm);\n      setAccuracy(stats.accuracy);\n      setErrors(stats.errors);\n    }, 50);\n    \n    return () => clearTimeout(timer);\n  }, [stats, isActive, isFinished]);\n\n  useEffect(() => {\n    if (chapterText && !isActive && !isFinished && inputRef.current) {\n      inputRef.current.focus();\n    }\n  }, [chapterText, isActive, isFinished]);\n\n  const updateCursorPosition = useCallback(() => {\n    requestAnimationFrame(() => {\n      if (!containerRef.current) return;\n      \n      try {\n        const containerRect = containerRef.current.getBoundingClientRect();\n        let targetSpan: HTMLSpanElement | null = null;\n        let offsetInSpan = 0;\n        \n        if (correctSpanRef.current && userInput.length <= (correctSpanRef.current.textContent?.length || 0)) {\n          targetSpan = correctSpanRef.current;\n          offsetInSpan = userInput.length;\n        } else if (incorrectSpanRef.current) {\n          targetSpan = incorrectSpanRef.current;\n          const correctLength = correctSpanRef.current?.textContent?.length || 0;\n          offsetInSpan = userInput.length - correctLength;\n        }\n        \n        if (targetSpan && targetSpan.firstChild) {\n          const range = document.createRange();\n          const textNode = targetSpan.firstChild;\n          const maxOffset = textNode.textContent?.length || 0;\n          const safeOffset = Math.min(offsetInSpan, maxOffset);\n          \n          range.setStart(textNode, safeOffset);\n          range.setEnd(textNode, safeOffset);\n          \n          const rect = range.getBoundingClientRect();\n          const relativeLeft = rect.left - containerRect.left;\n          const relativeTop = rect.top - containerRect.top;\n          const height = rect.height || 40;\n          \n          setCursorPosition({ left: relativeLeft, top: relativeTop, height });\n        } else {\n          setCursorPosition({ left: 0, top: 0, height: 40 });\n        }\n      } catch (error) {\n        setCursorPosition({ left: 0, top: 0, height: 40 });\n      }\n    });\n  }, [userInput.length]);\n\n  useEffect(() => {\n    updateCursorPosition();\n  }, [updateCursorPosition]);\n\n  useEffect(() => {\n    const handleResize = () => updateCursorPosition();\n    window.addEventListener('resize', handleResize);\n    \n    if (document.fonts) {\n      document.fonts.ready.then(() => updateCursorPosition());\n    }\n    \n    return () => window.removeEventListener('resize', handleResize);\n  }, [updateCursorPosition]);\n\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.key === 'Escape' && isActive && !isFinished) {\n        e.preventDefault();\n        resetTestState();\n        toast({\n          title: \"Test Reset\",\n          description: \"Your progress has been cleared. Start typing to begin again.\",\n        });\n      }\n      \n      if (!isActive && !isFinished) {\n        if (e.key === 'ArrowLeft' && chapterNum > 1) {\n          e.preventDefault();\n          goToPreviousChapter();\n        } else if (e.key === 'ArrowRight' && displayBook && chapterNum < displayBook.totalChapters) {\n          e.preventDefault();\n          goToNextChapter();\n        }\n      }\n    };\n    \n    window.addEventListener('keydown', handleKeyDown);\n    return () => window.removeEventListener('keydown', handleKeyDown);\n  }, [isActive, isFinished, chapterNum, displayBook]);\n\n  useEffect(() => {\n    let interval: NodeJS.Timeout | null = null;\n    \n    if (isActive && startTime) {\n      interval = setInterval(() => {\n        setElapsedTime(Math.floor((Date.now() - startTime) / 1000));\n      }, 100);\n    } else if (!isActive) {\n      setElapsedTime(0);\n    }\n    \n    return () => {\n      if (interval) clearInterval(interval);\n    };\n  }, [isActive, startTime]);\n\n  const finishTest = useCallback(() => {\n    if (!chapterText || !startTime || paragraphs.length === 0 || !displayBook) return;\n\n    const chars = userInput.length;\n    const errorCount = userInput.split(\"\").filter((char, i) => char !== chapterText[i]).length;\n    const correctChars = chars - errorCount;\n    const elapsedSeconds = (Date.now() - startTime) / 1000;\n    const duration = Math.round(elapsedSeconds);\n    \n    const finalWpm = calculateWPM(correctChars, elapsedSeconds);\n    const finalAccuracy = calculateAccuracy(correctChars, chars);\n    const finalErrors = errorCount;\n    const consistency = Math.max(0, Math.min(100, Math.round(100 - (errorCount / chars) * 100)));\n    const currentChapterTitle = paragraphs[0]?.chapterTitle || `Chapter ${chapterNum}`;\n    const words = chapterText.split(/\\s+/).length;\n    const wordsTyped = Math.min(words, Math.floor(userInput.split(/\\s+/).length));\n\n    setIsActive(false);\n    setIsFinished(true);\n    \n    setWpm(finalWpm);\n    setAccuracy(finalAccuracy);\n    setErrors(finalErrors);\n    \n    setCompletedTestData({\n      duration,\n      wpm: finalWpm,\n      accuracy: finalAccuracy,\n      errors: finalErrors,\n    });\n    \n    setLastResultSnapshot({\n      wpm: finalWpm,\n      accuracy: finalAccuracy,\n      duration,\n      consistency,\n      bookTitle: displayBook.title,\n      author: displayBook.author,\n      chapter: chapterNum,\n      chapterTitle: currentChapterTitle,\n      paragraphsCompleted: paragraphs.length,\n      wordsTyped,\n    });\n    \n    confetti({\n      particleCount: 100,\n      spread: 70,\n      origin: { y: 0.6 },\n      colors: ['#FFD700', '#00FFFF', '#FF00FF']\n    });\n\n    if (user) {\n      const result = {\n        paragraphId: paragraphs[0].id,\n        wpm: finalWpm,\n        accuracy: finalAccuracy,\n        characters: chars,\n        errors: finalErrors,\n        duration,\n      };\n      setPendingResult(result);\n      saveTestMutation.mutate(result);\n    }\n  }, [chapterText, startTime, paragraphs, userInput, user, saveTestMutation, displayBook, chapterNum]);\n\n  useEffect(() => {\n    if (isActive && userInput === chapterText && chapterText) {\n      finishTest();\n    }\n  }, [userInput, chapterText, isActive, finishTest]);\n\n  const handleInput = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    if (isComposing) return;\n    processInput(e.target.value);\n  };\n\n  const handleCompositionStart = () => {\n    setIsComposing(true);\n  };\n\n  const handleCompositionEnd = (e: React.CompositionEvent<HTMLTextAreaElement>) => {\n    setIsComposing(false);\n    setTimeout(() => {\n      if (inputRef.current) {\n        const value = inputRef.current.value;\n        processInput(value);\n      }\n    }, 0);\n  };\n\n  const processInput = (value: string) => {\n    if (!chapterText || isFinished) return;\n    \n    if (value.length > chapterText.length) {\n      if (inputRef.current) inputRef.current.value = userInput;\n      return;\n    }\n    \n    if (!isActive && value.length > 0) {\n      setIsActive(true);\n      setStartTime(Date.now());\n    }\n    \n    setUserInput(value);\n  };\n\n  const handlePaste = (e: React.ClipboardEvent<HTMLTextAreaElement>) => {\n    e.preventDefault();\n    toast({\n      title: \"Paste Disabled\",\n      description: \"Please type manually for accurate results.\",\n      variant: \"destructive\",\n    });\n  };\n\n  const handleCut = (e: React.ClipboardEvent<HTMLTextAreaElement>) => {\n    e.preventDefault();\n  };\n\n  const handleContainerClick = () => {\n    inputRef.current?.focus();\n  };\n\n  const resetTestState = () => {\n    setUserInput(\"\");\n    setStartTime(null);\n    setIsActive(false);\n    setIsFinished(false);\n    setWpm(0);\n    setAccuracy(100);\n    setErrors(0);\n    setCompletedTestData(null);\n    setElapsedTime(0);\n    setPendingResult(null);\n    setSaveRetryCount(0);\n    setTimeout(() => inputRef.current?.focus(), 0);\n  };\n\n  const goToNextChapter = () => {\n    if (!displayBook) return;\n    const nextChapter = chapterNum + 1;\n    if (nextChapter <= displayBook.totalChapters) {\n      setLocation(`/books/${slug}/chapter/${nextChapter}`);\n    } else {\n      toast({\n        title: \"Last Chapter\",\n        description: \"You've completed the book!\",\n      });\n      setLocation(`/books/${slug}`);\n    }\n  };\n\n  const goToPreviousChapter = () => {\n    const prevChapter = chapterNum - 1;\n    if (prevChapter > 0) {\n      setLocation(`/books/${slug}/chapter/${prevChapter}`);\n    } else {\n      setLocation(`/books/${slug}`);\n    }\n  };\n  \n  const handleRetry = useCallback(() => {\n    setUseCachedData(false);\n    refetchBook();\n    if (book) {\n      refetchChapter();\n    }\n  }, [refetchBook, refetchChapter, book]);\n  \n  const handleUseCached = useCallback(() => {\n    if (cachedData && cachedData.paragraphs.length > 0) {\n      queryClient.setQueryData(['book', slug], cachedData.book);\n      queryClient.setQueryData(['chapter', cachedData.book.id, chapterNum], cachedData.paragraphs);\n      \n      setUseCachedData(true);\n      const text = cachedData.paragraphs.map(p => p.text).join('\\n\\n');\n      setChapterText(text);\n      setParagraphs(cachedData.paragraphs);\n      resetTestState();\n      \n      toast({\n        title: \"Using Offline Data\",\n        description: \"Loaded cached chapter content. Some features may be limited.\",\n      });\n    }\n  }, [cachedData, queryClient, slug, chapterNum, toast]);\n  \n  const handleGoBack = useCallback(() => {\n    setLocation(`/books/${slug}`);\n  }, [setLocation, slug]);\n  \n  const handleRetrySave = useCallback(() => {\n    if (pendingResult) {\n      saveTestMutation.mutate(pendingResult);\n    }\n  }, [pendingResult, saveTestMutation]);\n\n  const isLoading = bookLoading || (book && chaptersLoading);\n  const hasError = (bookError || chaptersError) && !useCachedData;\n  const error = bookErrorData || chaptersErrorData;\n  const isFetching = bookFetching || chaptersFetching;\n\n  if (isLoading && !useCachedData) {\n    return <LoadingSkeleton />;\n  }\n\n  if (hasError && error) {\n    return (\n      <ErrorState\n        error={error}\n        onRetry={handleRetry}\n        isRetrying={isFetching}\n        onGoBack={handleGoBack}\n        cachedData={cachedData}\n        onUseCached={handleUseCached}\n        slug={slug}\n      />\n    );\n  }\n\n  if (!displayBook || displayParagraphs.length === 0) {\n    return (\n      <div className=\"container mx-auto py-8 px-4 max-w-6xl\">\n        <Button\n          variant=\"ghost\"\n          onClick={handleGoBack}\n          className=\"mb-6\"\n          data-testid=\"button-back-empty\"\n        >\n          <ArrowLeft className=\"w-4 h-4 mr-2\" />\n          Back to Book\n        </Button>\n        \n        <div className=\"flex flex-col items-center justify-center min-h-[50vh] gap-4\">\n          <BookOpen className=\"w-16 h-16 text-muted-foreground\" />\n          <h2 className=\"text-2xl font-bold\">Chapter Not Found</h2>\n          <p className=\"text-muted-foreground text-center max-w-md\">\n            This chapter doesn't exist or hasn't been loaded yet.\n          </p>\n          <Button onClick={handleGoBack} data-testid=\"button-back\">\n            Back to Book\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  const renderText = () => {\n    let correctUpTo = 0;\n    for (let i = 0; i < userInput.length && i < chapterText.length; i++) {\n      if (userInput[i] === chapterText[i]) {\n        correctUpTo = i + 1;\n      } else {\n        break;\n      }\n    }\n    \n    const correctText = chapterText.slice(0, correctUpTo);\n    const incorrectText = chapterText.slice(correctUpTo, userInput.length);\n    const remainingText = chapterText.slice(userInput.length);\n    \n    return (\n      <>\n        {correctText && (\n          <span ref={correctSpanRef} className=\"text-green-500\">\n            {correctText}\n          </span>\n        )}\n        {incorrectText && (\n          <span ref={incorrectSpanRef} className=\"text-red-500 bg-red-500/20\">\n            {incorrectText}\n          </span>\n        )}\n        {remainingText && (\n          <span className=\"text-muted-foreground/60\">\n            {remainingText}\n          </span>\n        )}\n      </>\n    );\n  };\n\n  const chapterTitle = paragraphs[0]?.chapterTitle || `Chapter ${chapterNum}`;\n\n  return (\n    <div className=\"container mx-auto py-8 px-4 max-w-6xl\">\n      <div className=\"mb-6\">\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                variant=\"ghost\"\n                onClick={() => setLocation(`/books/${slug}`)}\n                className=\"mb-4\"\n                data-testid=\"button-back-to-book\"\n              >\n                <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                Back to {displayBook.title}\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>Return to book chapters list</p>\n            </TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n\n        <div className=\"flex items-center justify-between flex-wrap gap-4\">\n          <div>\n            <div className=\"flex items-center gap-3 mb-2\">\n              <TooltipProvider>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"cursor-help\">\n                      <BookOpen className=\"w-8 h-8 text-primary\" />\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Book chapter typing practice</p>\n                  </TooltipContent>\n                </Tooltip>\n              </TooltipProvider>\n              <h1 className=\"text-3xl font-bold\" data-testid=\"text-chapter-title\">{chapterTitle}</h1>\n              {useCachedData && (\n                <TooltipProvider>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <span className=\"text-xs px-2 py-1 rounded bg-yellow-500/20 text-yellow-600 dark:text-yellow-500 cursor-help\">\n                        Offline\n                      </span>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>Using cached data - progress may not be saved</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </TooltipProvider>\n              )}\n            </div>\n            <p className=\"text-muted-foreground\">\n              {displayBook.title} by {displayBook.author}\n            </p>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <TooltipProvider>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <span className=\"inline-flex\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={goToPreviousChapter}\n                      disabled={chapterNum <= 1}\n                      data-testid=\"button-previous-chapter\"\n                    >\n                      <ArrowLeft className=\"w-4 h-4 mr-1\" />\n                      Previous\n                    </Button>\n                  </span>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>{chapterNum <= 1 ? 'This is the first chapter' : `Go to Chapter ${chapterNum - 1}`}</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n            <TooltipProvider>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Badge variant=\"outline\" className=\"text-sm cursor-help\">\n                    Chapter {chapterNum} of {displayBook.totalChapters}\n                  </Badge>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Your current progress in the book</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n            <TooltipProvider>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <span className=\"inline-flex\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"sm\"\n                      onClick={goToNextChapter}\n                      disabled={chapterNum >= displayBook.totalChapters}\n                      data-testid=\"button-next-chapter\"\n                    >\n                      Next\n                      <ArrowRight className=\"w-4 h-4 ml-1\" />\n                    </Button>\n                  </span>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>{chapterNum >= displayBook.totalChapters ? 'This is the last chapter' : `Go to Chapter ${chapterNum + 1}`}</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-4 gap-4 mb-6\" role=\"region\" aria-label=\"Typing statistics\">\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Card className=\"p-4 text-center cursor-help\">\n                <div className=\"flex items-center justify-center gap-2 mb-1\">\n                  <Zap className=\"w-4 h-4 text-yellow-500\" aria-hidden=\"true\" />\n                  <span className=\"text-sm text-muted-foreground\">WPM</span>\n                </div>\n                <div \n                  className=\"text-3xl font-bold text-yellow-500\" \n                  data-testid=\"text-wpm\"\n                  role=\"status\"\n                  aria-live=\"polite\"\n                  aria-label={`Words per minute: ${wpm}`}\n                >\n                  {wpm}\n                </div>\n              </Card>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>Words Per Minute - your typing speed</p>\n            </TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Card className=\"p-4 text-center cursor-help\">\n                <div className=\"flex items-center justify-center gap-2 mb-1\">\n                  <Target className=\"w-4 h-4 text-green-500\" aria-hidden=\"true\" />\n                  <span className=\"text-sm text-muted-foreground\">Accuracy</span>\n                </div>\n                <div \n                  className=\"text-3xl font-bold text-green-500\" \n                  data-testid=\"text-accuracy\"\n                  role=\"status\"\n                  aria-live=\"polite\"\n                  aria-label={`Accuracy: ${accuracy} percent`}\n                >\n                  {accuracy}%\n                </div>\n              </Card>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>Percentage of correctly typed characters</p>\n            </TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Card className=\"p-4 text-center cursor-help\">\n                <div className=\"flex items-center justify-center gap-2 mb-1\">\n                  <span className=\"text-sm text-muted-foreground\">Errors</span>\n                </div>\n                <div \n                  className=\"text-3xl font-bold text-red-500\" \n                  data-testid=\"text-errors\"\n                  role=\"status\"\n                  aria-live=\"polite\"\n                  aria-label={`Errors: ${errors}`}\n                >\n                  {errors}\n                </div>\n              </Card>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>Number of incorrect characters typed</p>\n            </TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Card className=\"p-4 text-center cursor-help\">\n                <div className=\"flex items-center justify-center gap-2 mb-1\">\n                  <span className=\"text-sm text-muted-foreground\">Time</span>\n                </div>\n                <div \n                  className=\"text-3xl font-bold\" \n                  data-testid=\"text-timer\"\n                  role=\"timer\"\n                  aria-live=\"off\"\n                  aria-label={`Elapsed time: ${formatTime(elapsedTime)}`}\n                >\n                  {formatTime(elapsedTime)}\n                </div>\n              </Card>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>Total time spent typing this chapter</p>\n            </TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      </div>\n\n      <Card className=\"p-6 mb-6 relative\">\n        <div \n          ref={containerRef}\n          onClick={handleContainerClick}\n          className=\"relative min-h-[200px] font-serif text-lg leading-relaxed cursor-text\"\n          data-testid=\"typing-container\"\n          role=\"application\"\n          aria-label=\"Chapter typing practice area\"\n        >\n          <Textarea\n            ref={inputRef}\n            value={userInput}\n            onChange={handleInput}\n            onCompositionStart={handleCompositionStart}\n            onCompositionEnd={handleCompositionEnd}\n            onPaste={handlePaste}\n            onCut={handleCut}\n            className=\"absolute opacity-0 w-full h-full cursor-default z-0 resize-none\"\n            autoFocus\n            disabled={isFinished}\n            data-testid=\"hidden-input\"\n          />\n          \n          <div className=\"relative z-10 whitespace-pre-wrap pointer-events-none select-none\">\n            {renderText()}\n          </div>\n          \n          {!isFinished && (\n            <div\n              className=\"absolute pointer-events-none z-20 bg-primary/60 animate-pulse\"\n              style={{\n                left: `${cursorPosition.left}px`,\n                top: `${cursorPosition.top}px`,\n                width: '3px',\n                height: `${cursorPosition.height}px`,\n                transition: 'left 50ms ease-out, top 50ms ease-out',\n              }}\n              data-testid=\"typing-cursor\"\n            />\n          )}\n        </div>\n\n        {isFinished && (\n          <div className=\"mt-4 flex gap-3 justify-center flex-wrap\">\n            {chapterNum < displayBook.totalChapters && (\n              <TooltipProvider>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button\n                      onClick={goToNextChapter}\n                      size=\"lg\"\n                      className=\"gap-2\"\n                      data-testid=\"button-next-chapter-complete\"\n                    >\n                      Next Chapter\n                      <ArrowRight className=\"w-5 h-5\" />\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Continue to Chapter {chapterNum + 1}</p>\n                  </TooltipContent>\n                </Tooltip>\n              </TooltipProvider>\n            )}\n            <TooltipProvider>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    onClick={resetTestState}\n                    variant=\"outline\"\n                    size=\"lg\"\n                    className=\"gap-2\"\n                    data-testid=\"button-retry\"\n                  >\n                    Retry Chapter\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Practice this chapter again to improve your score</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n            {pendingResult && saveTestMutation.isError && (\n              <TooltipProvider>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button\n                      onClick={handleRetrySave}\n                      variant=\"outline\"\n                      size=\"lg\"\n                      className=\"gap-2\"\n                      disabled={saveTestMutation.isPending}\n                      data-testid=\"button-retry-save\"\n                    >\n                      {saveTestMutation.isPending ? (\n                        <Loader2 className=\"w-4 h-4 animate-spin\" />\n                      ) : (\n                        <RefreshCw className=\"w-4 h-4\" />\n                      )}\n                      Retry Save\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Try saving your results again</p>\n                  </TooltipContent>\n                </Tooltip>\n              </TooltipProvider>\n            )}\n          </div>\n        )}\n      </Card>\n\n      <TooltipProvider>\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Card className=\"p-4 bg-muted/50 cursor-help\" role=\"complementary\" aria-label=\"Keyboard shortcuts\">\n              <div className=\"text-sm text-muted-foreground\">\n                <div className=\"font-semibold mb-2 text-center\">Keyboard Shortcuts</div>\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-2 text-center\">\n                  <div>\n                    <kbd className=\"px-2 py-1 bg-background rounded border text-xs\">Esc</kbd>\n                    <span className=\"ml-2\">Reset test</span>\n                  </div>\n                  <div>\n                    <kbd className=\"px-2 py-1 bg-background rounded border text-xs\">â†</kbd>\n                    <span className=\"ml-2\">Previous chapter</span>\n                  </div>\n                  <div>\n                    <kbd className=\"px-2 py-1 bg-background rounded border text-xs\">â†’</kbd>\n                    <span className=\"ml-2\">Next chapter</span>\n                  </div>\n                </div>\n              </div>\n            </Card>\n          </TooltipTrigger>\n          <TooltipContent>\n            <p>Use these shortcuts while typing for quick navigation</p>\n          </TooltipContent>\n        </Tooltip>\n      </TooltipProvider>\n\n      <Dialog open={isFinished} onOpenChange={(open) => !open && resetTestState()}>\n        <DialogContent data-testid=\"dialog-results\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-2xl\">\n              <Trophy className=\"w-6 h-6 text-yellow-500\" />\n              Chapter Complete!\n            </DialogTitle>\n            <DialogDescription>\n              Great job! Here are your results for {chapterTitle}:\n            </DialogDescription>\n          </DialogHeader>\n          {completedTestData && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"p-4 bg-muted rounded-lg text-center\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">WPM</div>\n                  <div className=\"text-3xl font-bold text-yellow-500\">{completedTestData.wpm}</div>\n                </div>\n                <div className=\"p-4 bg-muted rounded-lg text-center\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">Accuracy</div>\n                  <div className=\"text-3xl font-bold text-green-500\">{completedTestData.accuracy}%</div>\n                </div>\n                <div className=\"p-4 bg-muted rounded-lg text-center\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">Errors</div>\n                  <div className=\"text-3xl font-bold text-red-500\">{completedTestData.errors}</div>\n                </div>\n                <div className=\"p-4 bg-muted rounded-lg text-center\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">Time</div>\n                  <div className=\"text-3xl font-bold\">{formatTime(completedTestData.duration)}</div>\n                </div>\n              </div>\n              \n              {saveTestMutation.isError && (\n                <div className=\"p-3 bg-destructive/10 rounded-lg text-center\">\n                  <p className=\"text-sm text-destructive mb-2\">Failed to save your progress</p>\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    onClick={handleRetrySave}\n                    disabled={saveTestMutation.isPending}\n                    data-testid=\"button-dialog-retry-save\"\n                  >\n                    {saveTestMutation.isPending ? (\n                      <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                    ) : (\n                      <RefreshCw className=\"w-4 h-4 mr-2\" />\n                    )}\n                    Retry Save\n                  </Button>\n                </div>\n              )}\n              \n              {lastResultSnapshot && (\n                <div className=\"flex justify-center mb-3\">\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        onClick={() => setShareDialogOpen(true)}\n                        variant=\"outline\"\n                        className=\"gap-2\"\n                        data-testid=\"button-share-chapter-results\"\n                      >\n                        <Share2 className=\"w-4 h-4\" />\n                        Share Certificate\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\">\n                      <p className=\"text-xs\">Share your chapter typing achievement with certificate</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n              )}\n              \n              <div className=\"flex gap-3\">\n                {chapterNum < displayBook.totalChapters && (\n                  <Button\n                    onClick={goToNextChapter}\n                    className=\"flex-1 gap-2\"\n                    data-testid=\"button-dialog-next\"\n                  >\n                    Next Chapter\n                    <ArrowRight className=\"w-4 h-4\" />\n                  </Button>\n                )}\n                <Button\n                  onClick={resetTestState}\n                  variant=\"outline\"\n                  className=\"flex-1 gap-2\"\n                  data-testid=\"button-dialog-retry\"\n                >\n                  Retry Chapter\n                </Button>\n                <Button\n                  onClick={() => setLocation(`/books/${slug}`)}\n                  variant=\"outline\"\n                  className=\"flex-1 gap-2\"\n                  data-testid=\"button-dialog-back\"\n                >\n                  <ArrowLeft className=\"w-4 h-4\" />\n                  Book Details\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Share Dialog with Certificate */}\n      <Dialog open={shareDialogOpen} onOpenChange={setShareDialogOpen}>\n        <DialogContent className=\"sm:max-w-[650px] max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Share2 className=\"w-5 h-5\" />\n              Share Your Chapter Result\n            </DialogTitle>\n            <DialogDescription>\n              Share your chapter typing achievement with others!\n            </DialogDescription>\n          </DialogHeader>\n          \n          {lastResultSnapshot && (\n            <Tabs defaultValue=\"certificate\" className=\"w-full\">\n              <TabsList className=\"grid w-full grid-cols-1\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <TabsTrigger value=\"certificate\" className=\"gap-2\" data-testid=\"tab-chapter-certificate\">\n                      <Award className=\"w-4 h-4\" />\n                      Certificate\n                    </TabsTrigger>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"bottom\">\n                    <p className=\"text-xs\">Professional 1200Ã—675 certificate with verification ID</p>\n                  </TooltipContent>\n                </Tooltip>\n              </TabsList>\n              \n              <TabsContent value=\"certificate\" className=\"mt-4\">\n                <BookCertificate\n                  wpm={lastResultSnapshot.wpm}\n                  accuracy={lastResultSnapshot.accuracy}\n                  consistency={lastResultSnapshot.consistency}\n                  duration={lastResultSnapshot.duration}\n                  bookTitle={lastResultSnapshot.bookTitle}\n                  author={lastResultSnapshot.author}\n                  chapter={lastResultSnapshot.chapter}\n                  chapterTitle={lastResultSnapshot.chapterTitle}\n                  paragraphsCompleted={lastResultSnapshot.paragraphsCompleted}\n                  wordsTyped={lastResultSnapshot.wordsTyped}\n                  username={user?.username}\n                />\n              </TabsContent>\n            </Tabs>\n          )}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":49815,"size_tokens":null},"client/src/pages/book-library.tsx":{"content":"import { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { BookOpen, Loader2, RefreshCw, AlertCircle, WifiOff, Search } from \"lucide-react\";\nimport { Input } from \"@/components/ui/input\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { useState, useMemo, useCallback, useEffect } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Book } from \"@shared/schema\";\n\nconst CACHE_KEY = 'book_library_cache';\nconst CACHE_TTL = 5 * 60 * 1000;\n\ninterface CachedBooks {\n  books: Book[];\n  timestamp: number;\n}\n\nfunction getBookCacheFromStorage(): Book[] | null {\n  try {\n    const cached = localStorage.getItem(CACHE_KEY);\n    if (!cached) return null;\n    \n    const parsed: CachedBooks = JSON.parse(cached);\n    const age = Date.now() - parsed.timestamp;\n    \n    if (age < CACHE_TTL && parsed.books.length > 0) {\n      return parsed.books;\n    }\n    \n    localStorage.removeItem(CACHE_KEY);\n    return null;\n  } catch {\n    return null;\n  }\n}\n\nfunction setBookCacheToStorage(books: Book[]): void {\n  try {\n    if (books.length > 0) {\n      const cached: CachedBooks = {\n        books,\n        timestamp: Date.now(),\n      };\n      localStorage.setItem(CACHE_KEY, JSON.stringify(cached));\n    }\n  } catch {\n  }\n}\n\nasync function fetchBooks(): Promise<Book[]> {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), 15000);\n  \n  try {\n    const res = await fetch('/api/books', {\n      signal: controller.signal,\n      credentials: 'include',\n    });\n    \n    clearTimeout(timeoutId);\n    \n    if (!res.ok) {\n      const errorText = await res.text().catch(() => '');\n      if (res.status === 404) {\n        throw new Error('BOOKS_NOT_FOUND');\n      }\n      if (res.status >= 500) {\n        throw new Error('SERVER_ERROR');\n      }\n      throw new Error(errorText || `HTTP_${res.status}`);\n    }\n    \n    const books = await res.json() as Book[];\n    \n    setBookCacheToStorage(books);\n    \n    return books;\n  } catch (error: any) {\n    clearTimeout(timeoutId);\n    \n    if (error.name === 'AbortError') {\n      throw new Error('TIMEOUT');\n    }\n    \n    if (error.message === 'Failed to fetch' || error.message.includes('NetworkError')) {\n      throw new Error('NETWORK_ERROR');\n    }\n    \n    throw error;\n  }\n}\n\nfunction BookCardSkeleton() {\n  return (\n    <Card className=\"p-6\">\n      <div className=\"flex flex-col gap-4\">\n        <div className=\"flex items-center gap-3\">\n          <Skeleton className=\"w-12 h-12 rounded-lg\" />\n          <div className=\"flex-1 space-y-2\">\n            <Skeleton className=\"h-5 w-3/4\" />\n            <Skeleton className=\"h-4 w-1/2\" />\n          </div>\n        </div>\n        <div className=\"flex items-center justify-between\">\n          <Skeleton className=\"h-4 w-24\" />\n          <Skeleton className=\"h-4 w-28\" />\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <Skeleton className=\"h-6 w-16 rounded-full\" />\n          <Skeleton className=\"h-6 w-20 rounded-full\" />\n        </div>\n      </div>\n    </Card>\n  );\n}\n\nfunction LoadingState() {\n  return (\n    <div className=\"container py-8\">\n      <div className=\"mb-8\">\n        <Skeleton className=\"h-10 w-48 mb-2\" />\n        <Skeleton className=\"h-5 w-80\" />\n      </div>\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\n        {Array.from({ length: 8 }).map((_, i) => (\n          <BookCardSkeleton key={i} />\n        ))}\n      </div>\n    </div>\n  );\n}\n\ninterface ErrorStateProps {\n  error: Error;\n  onRetry: () => void;\n  isRetrying: boolean;\n  cachedBooks: Book[] | null;\n  onUseCached: () => void;\n}\n\nfunction ErrorState({ error, onRetry, isRetrying, cachedBooks, onUseCached }: ErrorStateProps) {\n  const errorType = error.message;\n  \n  let icon = <AlertCircle className=\"w-16 h-16 text-destructive\" />;\n  let title = \"Unable to Load Books\";\n  let description = \"Something went wrong while loading the book library.\";\n  let canRetry = true;\n  \n  switch (errorType) {\n    case 'NETWORK_ERROR':\n      icon = <WifiOff className=\"w-16 h-16 text-muted-foreground\" />;\n      title = \"No Internet Connection\";\n      description = \"Please check your internet connection and try again.\";\n      break;\n    case 'TIMEOUT':\n      title = \"Request Timed Out\";\n      description = \"The server took too long to respond. Please try again.\";\n      break;\n    case 'SERVER_ERROR':\n      title = \"Server Error\";\n      description = \"The server encountered an error. Please try again later.\";\n      break;\n    case 'BOOKS_NOT_FOUND':\n      title = \"No Books Found\";\n      description = \"The book library is currently empty. Please check back later.\";\n      canRetry = false;\n      break;\n  }\n  \n  return (\n    <div className=\"flex flex-col items-center justify-center min-h-[60vh] gap-6 p-4\">\n      {icon}\n      <div className=\"text-center max-w-md\">\n        <h2 className=\"text-2xl font-semibold mb-2\">{title}</h2>\n        <p className=\"text-muted-foreground\">{description}</p>\n      </div>\n      <div className=\"flex flex-col sm:flex-row gap-3\">\n        {canRetry && (\n          <Button\n            onClick={onRetry}\n            disabled={isRetrying}\n            data-testid=\"button-retry-books\"\n          >\n            {isRetrying ? (\n              <>\n                <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                Retrying...\n              </>\n            ) : (\n              <>\n                <RefreshCw className=\"w-4 h-4 mr-2\" />\n                Try Again\n              </>\n            )}\n          </Button>\n        )}\n        {cachedBooks && cachedBooks.length > 0 && (\n          <Button\n            variant=\"outline\"\n            onClick={onUseCached}\n            data-testid=\"button-use-cached\"\n          >\n            <BookOpen className=\"w-4 h-4 mr-2\" />\n            Use Offline Data ({cachedBooks.length} books)\n          </Button>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction EmptyState({ onRefresh, isRefreshing }: { onRefresh: () => void; isRefreshing: boolean }) {\n  return (\n    <div className=\"flex flex-col items-center justify-center min-h-[60vh] gap-6 p-4\">\n      <BookOpen className=\"w-16 h-16 text-muted-foreground\" />\n      <div className=\"text-center max-w-md\">\n        <h2 className=\"text-2xl font-semibold mb-2\">No Books Available</h2>\n        <p className=\"text-muted-foreground\">\n          The book library is currently being populated. Books from classic literature will appear here shortly.\n        </p>\n      </div>\n      <Button\n        onClick={onRefresh}\n        disabled={isRefreshing}\n        variant=\"outline\"\n        data-testid=\"button-refresh-library\"\n      >\n        {isRefreshing ? (\n          <>\n            <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n            Checking...\n          </>\n        ) : (\n          <>\n            <RefreshCw className=\"w-4 h-4 mr-2\" />\n            Check for Books\n          </>\n        )}\n      </Button>\n    </div>\n  );\n}\n\nexport default function BookLibrary() {\n  const [, setLocation] = useLocation();\n  const queryClient = useQueryClient();\n  const { toast } = useToast();\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [useCachedData, setUseCachedData] = useState(false);\n  const [cachedBooks, setCachedBooks] = useState<Book[] | null>(null);\n  \n  useEffect(() => {\n    const cached = getBookCacheFromStorage();\n    setCachedBooks(cached);\n  }, []);\n  \n  const { data: books = [], isLoading, isError, error, isFetching, refetch } = useQuery<Book[], Error>({\n    queryKey: ['books'],\n    queryFn: fetchBooks,\n    staleTime: 5 * 60 * 1000,\n    gcTime: 30 * 60 * 1000,\n    retry: (failureCount, error) => {\n      if (error.message === 'BOOKS_NOT_FOUND') return false;\n      return failureCount < 3;\n    },\n    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 10000),\n    refetchOnWindowFocus: false,\n    refetchOnReconnect: true,\n  });\n  \n  const displayBooks = useCachedData && cachedBooks ? cachedBooks : books;\n  \n  const filteredBooks = useMemo(() => {\n    if (!searchQuery.trim()) return displayBooks;\n    \n    const query = searchQuery.toLowerCase().trim();\n    return displayBooks.filter(book => \n      book.title.toLowerCase().includes(query) ||\n      book.author.toLowerCase().includes(query) ||\n      book.topic.toLowerCase().includes(query)\n    );\n  }, [displayBooks, searchQuery]);\n  \n  const handleRetry = useCallback(() => {\n    setUseCachedData(false);\n    refetch();\n  }, [refetch]);\n  \n  const handleUseCached = useCallback(() => {\n    if (cachedBooks && cachedBooks.length > 0) {\n      queryClient.setQueryData(['books'], cachedBooks);\n      setUseCachedData(true);\n    }\n  }, [cachedBooks, queryClient]);\n  \n  const [isRefreshing, setIsRefreshing] = useState(false);\n  \n  const handleRefresh = useCallback(async () => {\n    setIsRefreshing(true);\n    try {\n      setUseCachedData(false);\n      const result = await refetch();\n      if (result.data) {\n        toast({\n          title: \"Books Refreshed\",\n          description: `Successfully loaded ${result.data.length} books`,\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Refresh Failed\",\n        description: \"Could not refresh book list. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsRefreshing(false);\n    }\n  }, [refetch, toast]);\n  \n  if (isLoading && !useCachedData) {\n    return <LoadingState />;\n  }\n  \n  if (isError && !useCachedData) {\n    return (\n      <ErrorState\n        error={error}\n        onRetry={handleRetry}\n        isRetrying={isFetching}\n        cachedBooks={cachedBooks}\n        onUseCached={handleUseCached}\n      />\n    );\n  }\n  \n  if (displayBooks.length === 0) {\n    return <EmptyState onRefresh={handleRefresh} isRefreshing={isRefreshing} />;\n  }\n\n  return (\n    <div className=\"container py-8\">\n      <div className=\"mb-8\">\n        <div className=\"flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-4\">\n          <div>\n            <div className=\"flex items-center gap-3 mb-2\">\n              <h1 className=\"text-4xl font-bold\">Book Library</h1>\n              <TooltipProvider>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Badge \n                      variant=\"outline\" \n                      className=\"bg-gradient-to-r from-violet-500/20 to-purple-500/20 border-violet-500/50 text-violet-400 font-semibold cursor-help\"\n                    >\n                      BETA\n                    </Badge>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>This feature is in beta. We're actively improving it based on your feedback!</p>\n                  </TooltipContent>\n                </Tooltip>\n              </TooltipProvider>\n            </div>\n            <p className=\"text-muted-foreground\">\n              Choose a book and start typing chapter by chapter\n              {useCachedData && (\n                <span className=\"ml-2 text-xs text-yellow-600 dark:text-yellow-500\">\n                  (Offline mode)\n                </span>\n              )}\n            </p>\n          </div>\n          <TooltipProvider>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <span className=\"inline-flex self-start md:self-center\">\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={handleRefresh}\n                    disabled={isRefreshing}\n                    data-testid=\"button-refresh\"\n                  >\n                    {isRefreshing ? (\n                      <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                    ) : (\n                      <RefreshCw className=\"w-4 h-4 mr-2\" />\n                    )}\n                    {isRefreshing ? 'Refreshing...' : 'Refresh'}\n                  </Button>\n                </span>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>{isRefreshing ? 'Fetching latest books...' : 'Refresh book list from server'}</p>\n              </TooltipContent>\n            </Tooltip>\n          </TooltipProvider>\n        </div>\n        \n        <TooltipProvider>\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <div className=\"relative max-w-md\">\n                <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground\" />\n                <Input\n                  type=\"text\"\n                  placeholder=\"Search by title, author, or topic...\"\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className=\"pl-10\"\n                  data-testid=\"input-search-books\"\n                />\n              </div>\n            </TooltipTrigger>\n            <TooltipContent>\n              <p>Filter books by title, author name, or topic</p>\n            </TooltipContent>\n          </Tooltip>\n        </TooltipProvider>\n      </div>\n\n      {filteredBooks.length === 0 && searchQuery ? (\n        <div className=\"flex flex-col items-center justify-center py-16 gap-4\">\n          <Search className=\"w-12 h-12 text-muted-foreground\" />\n          <div className=\"text-center\">\n            <h3 className=\"text-lg font-semibold mb-1\">No books found</h3>\n            <p className=\"text-muted-foreground\">\n              Try a different search term or{' '}\n              <button\n                onClick={() => setSearchQuery('')}\n                className=\"text-primary underline hover:no-underline\"\n                data-testid=\"button-clear-search\"\n              >\n                clear the search\n              </button>\n            </p>\n          </div>\n        </div>\n      ) : (\n        <>\n          <div className=\"text-sm text-muted-foreground mb-4\">\n            Showing {filteredBooks.length} of {displayBooks.length} books\n          </div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6\">\n            {filteredBooks.map((book) => (\n              <Card\n                key={book.id}\n                className=\"group cursor-pointer hover:shadow-lg transition-all hover:scale-105 focus-within:ring-2 focus-within:ring-primary\"\n                onClick={() => setLocation(`/books/${book.slug}`)}\n                onKeyDown={(e) => {\n                  if (e.key === 'Enter' || e.key === ' ') {\n                    e.preventDefault();\n                    setLocation(`/books/${book.slug}`);\n                  }\n                }}\n                tabIndex={0}\n                role=\"button\"\n                aria-label={`Open ${book.title} by ${book.author}`}\n                data-testid={`book-card-${book.id}`}\n              >\n                <div className=\"p-6 flex flex-col gap-4\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"p-3 rounded-lg bg-primary/10 group-hover:bg-primary/20 transition-colors\">\n                      <BookOpen className=\"w-6 h-6 text-primary\" />\n                    </div>\n                    <div className=\"flex-1 min-w-0\">\n                      <h3 className=\"font-semibold truncate\" data-testid={`book-title-${book.id}`}>\n                        {book.title}\n                      </h3>\n                      <p className=\"text-sm text-muted-foreground truncate\" data-testid={`book-author-${book.id}`}>\n                        {book.author}\n                      </p>\n                    </div>\n                  </div>\n                  \n                  <div className=\"flex items-center justify-between text-sm\">\n                    <span className=\"text-muted-foreground\">{book.totalChapters} chapters</span>\n                    <span className=\"text-muted-foreground\">{book.totalParagraphs} paragraphs</span>\n                  </div>\n                  \n                  <div className=\"flex items-center gap-2 flex-wrap\">\n                    <TooltipProvider>\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <span className={`text-xs px-2 py-1 rounded-full cursor-help ${\n                            book.difficulty === 'easy' ? 'bg-green-500/20 text-green-500' :\n                            book.difficulty === 'medium' ? 'bg-yellow-500/20 text-yellow-500' :\n                            'bg-red-500/20 text-red-500'\n                          }`} data-testid={`book-difficulty-${book.id}`}>\n                            {book.difficulty}\n                          </span>\n                        </TooltipTrigger>\n                        <TooltipContent>\n                          <p>\n                            {book.difficulty === 'easy' ? 'Beginner-friendly with simpler vocabulary' :\n                             book.difficulty === 'medium' ? 'Moderate complexity for intermediate typists' :\n                             'Challenging text for advanced typists'}\n                          </p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </TooltipProvider>\n                    <TooltipProvider>\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <span className=\"text-xs px-2 py-1 rounded-full bg-primary/20 text-primary capitalize cursor-help\" data-testid={`book-topic-${book.id}`}>\n                            {book.topic}\n                          </span>\n                        </TooltipTrigger>\n                        <TooltipContent>\n                          <p>Book genre/category: {book.topic}</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    </TooltipProvider>\n                  </div>\n                </div>\n              </Card>\n            ))}\n          </div>\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":18085,"size_tokens":null},"server/book-fetcher.ts":{"content":"// Book Fetcher Service for downloading and processing public-domain books from Gutendex API\nimport type { InsertBook } from '@shared/schema';\n\nexport interface GutendexBook {\n  id: number;\n  title: string;\n  authors: Array<{ name: string }>;\n  subjects: string[];\n  bookshelves: string[];\n  formats: Record<string, string>;\n}\n\nexport interface ChapterInfo {\n  chapterNumber: number;\n  startIndex: number;\n  title?: string;\n}\n\nexport interface ProcessedParagraph {\n  text: string;\n  difficulty: 'easy' | 'medium' | 'hard';\n  topic: string;\n  durationMode: number;\n  lengthWords: number;\n  source: string;\n  bookId: number;\n  paragraphIndex: number;\n  language: string;\n  chapter?: number;\n  sectionIndex?: number;\n  chapterTitle?: string;\n}\n\ninterface GutendexResponse {\n  count: number;\n  next: string | null;\n  previous: string | null;\n  results: GutendexBook[];\n}\n\n// Topic mapping from Gutendex subjects/bookshelves to simplified categories\nconst TOPIC_MAPPING: Record<string, string> = {\n  // Fiction categories\n  'fiction': 'fiction',\n  'science fiction': 'science-fiction',\n  'fantasy': 'fantasy',\n  'adventure': 'adventure',\n  'mystery': 'mystery',\n  'detective': 'mystery',\n  'thriller': 'thriller',\n  'horror': 'horror',\n  'romance': 'romance',\n  'historical fiction': 'historical-fiction',\n  'western': 'western',\n  \n  // Classics and literature\n  'classics': 'classics',\n  'literature': 'classics',\n  'poetry': 'poetry',\n  'drama': 'drama',\n  'plays': 'drama',\n  'shakespeare': 'classics',\n  \n  // Non-fiction categories\n  'history': 'history',\n  'biography': 'biography',\n  'autobiography': 'biography',\n  'philosophy': 'philosophy',\n  'psychology': 'psychology',\n  'science': 'science',\n  'nature': 'nature',\n  'travel': 'travel',\n  'religion': 'religion',\n  'education': 'education',\n  'politics': 'politics',\n  'economics': 'economics',\n  'sociology': 'sociology',\n  \n  // Children's and young adult\n  'children': 'children',\n  'juvenile': 'children',\n  'young adult': 'young-adult',\n  \n  // Other\n  'humor': 'humor',\n  'satire': 'humor',\n  'short stories': 'short-stories',\n  'essays': 'essays',\n  'reference': 'reference',\n};\n\n/**\n * Fetch books from Gutendex API with pagination\n * @param limit Number of books to fetch (default: 96, which is 3 pages)\n * @returns Array of GutendexBook objects\n */\nexport async function fetchBooksFromGutendex(limit: number = 96): Promise<GutendexBook[]> {\n  const books: GutendexBook[] = [];\n  const baseUrl = 'https://gutendex.com/books?languages=en&copyright=false&mime_type=text/plain';\n  let currentUrl: string | null = baseUrl;\n  \n  console.log(`Fetching up to ${limit} books from Gutendex API...`);\n  \n  while (currentUrl && books.length < limit) {\n    try {\n      console.log(`Fetching page: ${currentUrl}`);\n      const response = await fetch(currentUrl);\n      \n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n      \n      const data: GutendexResponse = await response.json();\n      \n      // Filter books that have text/plain format (check all variants)\n      const validBooks = data.results.filter(book => {\n        return book.formats['text/plain; charset=utf-8'] || \n               book.formats['text/plain; charset=us-ascii'] || \n               book.formats['text/plain'];\n      });\n      books.push(...validBooks);\n      \n      console.log(`Fetched ${validBooks.length} valid books (total: ${books.length}/${limit})`);\n      \n      // Get next page URL\n      currentUrl = data.next;\n      \n      // Stop if we have enough books\n      if (books.length >= limit) {\n        break;\n      }\n      \n      // Add a small delay to be respectful to the API\n      await new Promise(resolve => setTimeout(resolve, 500));\n    } catch (error) {\n      console.error(`Error fetching books from Gutendex:`, error);\n      throw error;\n    }\n  }\n  \n  // Return only the requested number of books\n  return books.slice(0, limit);\n}\n\n/**\n * Download book text from a URL\n * @param url The text/plain URL from Gutendex\n * @returns The raw book text\n */\nexport async function downloadBookText(url: string): Promise<string> {\n  try {\n    const response = await fetch(url);\n    \n    if (!response.ok) {\n      throw new Error(`HTTP error! status: ${response.status}`);\n    }\n    \n    const text = await response.text();\n    return text;\n  } catch (error) {\n    console.error(`Error downloading book from ${url}:`, error);\n    throw error;\n  }\n}\n\n/**\n * Clean book text by removing Project Gutenberg headers/footers and normalizing\n * @param rawText The raw book text\n * @returns Cleaned text\n */\nexport function cleanBookText(rawText: string): string {\n  let text = rawText;\n  \n  // Remove Project Gutenberg header (everything before \"*** START OF\")\n  const startMarkers = [\n    '*** START OF THIS PROJECT GUTENBERG',\n    '*** START OF THE PROJECT GUTENBERG',\n    '***START OF THIS PROJECT GUTENBERG',\n    '***START OF THE PROJECT GUTENBERG',\n  ];\n  \n  for (const marker of startMarkers) {\n    const startIndex = text.indexOf(marker);\n    if (startIndex !== -1) {\n      // Find the end of the line containing the marker\n      const lineEnd = text.indexOf('\\n', startIndex);\n      if (lineEnd !== -1) {\n        text = text.substring(lineEnd + 1);\n      }\n      break;\n    }\n  }\n  \n  // Remove Project Gutenberg footer (everything after \"*** END OF\")\n  const endMarkers = [\n    '*** END OF THIS PROJECT GUTENBERG',\n    '*** END OF THE PROJECT GUTENBERG',\n    '***END OF THIS PROJECT GUTENBERG',\n    '***END OF THE PROJECT GUTENBERG',\n  ];\n  \n  for (const marker of endMarkers) {\n    const endIndex = text.indexOf(marker);\n    if (endIndex !== -1) {\n      text = text.substring(0, endIndex);\n      break;\n    }\n  }\n  \n  // Remove control characters (keep only printable ASCII and common whitespace)\n  // Keep: space (32), tab (9), newline (10), carriage return (13), and printable ASCII (32-126)\n  text = text.replace(/[\\x00-\\x08\\x0B\\x0C\\x0E-\\x1F\\x7F-\\xFF]/g, '');\n  \n  // Normalize line breaks to \\n\n  text = text.replace(/\\r\\n/g, '\\n');\n  text = text.replace(/\\r/g, '\\n');\n  \n  // Remove excessive whitespace (more than 2 consecutive newlines)\n  text = text.replace(/\\n{3,}/g, '\\n\\n');\n  \n  // Trim leading and trailing whitespace\n  text = text.trim();\n  \n  return text;\n}\n\n/**\n * Check if a paragraph should be excluded (non-content sections)\n */\nfunction shouldExcludeParagraph(text: string): boolean {\n  const upperText = text.toUpperCase().trim();\n  \n  // Exclude illustration references\n  if (/\\[ILLUSTRATION/i.test(text)) return true;\n  if (/\\[IMAGE/i.test(text)) return true;\n  if (/\\[FIGURE/i.test(text)) return true;\n  if (/\\[PLATE/i.test(text)) return true;\n  if (/\\[PICTURE/i.test(text)) return true;\n  if (/\\[PORTRAIT/i.test(text)) return true;\n  if (/\\[MAP/i.test(text)) return true;\n  if (/\\[DIAGRAM/i.test(text)) return true;\n  \n  // Exclude lines that are just section markers (short lines with specific keywords)\n  const words = text.split(/\\s+/).filter(w => w.length > 0);\n  if (words.length <= 5) {\n    // Short text - check if it's a section header to exclude\n    const excludePatterns = [\n      /^ILLUSTRATION/i,\n      /^INTRODUCTION$/i,\n      /^PREFACE$/i,\n      /^FOREWORD$/i,\n      /^CONTENTS$/i,\n      /^TABLE OF CONTENTS$/i,\n      /^INDEX$/i,\n      /^APPENDIX$/i,\n      /^GLOSSARY$/i,\n      /^BIBLIOGRAPHY$/i,\n      /^FOOTNOTE/i,\n      /^NOTE:/i,\n      /^EDITOR'S NOTE/i,\n      /^TRANSLATOR'S NOTE/i,\n      /^\\[.*\\]$/i, // Text entirely in brackets\n      /^_+$/i, // Just underscores\n      /^\\*+$/i, // Just asterisks\n      /^-+$/i, // Just dashes\n    ];\n    \n    for (const pattern of excludePatterns) {\n      if (pattern.test(upperText)) return true;\n    }\n  }\n  \n  // Exclude paragraphs that are mostly numbers/punctuation (likely tables or indices)\n  const alphaChars = text.replace(/[^a-zA-Z]/g, '').length;\n  const totalChars = text.length;\n  if (totalChars > 0 && alphaChars / totalChars < 0.5) return true;\n  \n  return false;\n}\n\n/**\n * Split text into paragraphs with target word count\n * Target: 120-280 words per paragraph\n * Minimum: 50 words, Maximum: 500 words\n * @param text The cleaned book text\n * @returns Array of paragraph strings\n */\nexport function splitIntoParagraphs(text: string): string[] {\n  // Split on double newlines (paragraph breaks)\n  const rawParagraphs = text.split(/\\n\\n+/).map(p => p.trim()).filter(p => p.length > 0)\n    .filter(p => !shouldExcludeParagraph(p)); // Filter out non-content sections\n  \n  const paragraphs: string[] = [];\n  let buffer = '';\n  \n  for (const paragraph of rawParagraphs) {\n    const words = paragraph.split(/\\s+/).filter(w => w.length > 0);\n    const wordCount = words.length;\n    const bufferWords = buffer.split(/\\s+/).filter(w => w.length > 0).length;\n    \n    // If buffer + current paragraph is still small, combine them\n    if (bufferWords > 0 && bufferWords + wordCount <= 280) {\n      buffer += '\\n\\n' + paragraph;\n    }\n    // If current paragraph alone is in target range\n    else if (wordCount >= 120 && wordCount <= 280) {\n      // Flush buffer if it has content\n      if (buffer.length > 0) {\n        const bufWords = buffer.split(/\\s+/).filter(w => w.length > 0).length;\n        if (bufWords >= 50) {\n          paragraphs.push(buffer);\n        }\n        buffer = '';\n      }\n      paragraphs.push(paragraph);\n    }\n    // If current paragraph is too long, split it\n    else if (wordCount > 500) {\n      // Flush buffer first\n      if (buffer.length > 0) {\n        const bufWords = buffer.split(/\\s+/).filter(w => w.length > 0).length;\n        if (bufWords >= 50) {\n          paragraphs.push(buffer);\n        }\n        buffer = '';\n      }\n      \n      // Split long paragraph at sentence boundaries\n      const sentences = paragraph.split(/([.!?]+\\s+)/).filter(s => s.trim().length > 0);\n      let chunk = '';\n      \n      for (let i = 0; i < sentences.length; i++) {\n        const sentence = sentences[i];\n        const chunkWords = (chunk + sentence).split(/\\s+/).filter(w => w.length > 0).length;\n        \n        if (chunkWords > 500) {\n          // Push current chunk and start new one\n          if (chunk.length > 0) {\n            const cWords = chunk.split(/\\s+/).filter(w => w.length > 0).length;\n            if (cWords >= 50) {\n              paragraphs.push(chunk.trim());\n            }\n          }\n          chunk = sentence;\n        } else {\n          chunk += sentence;\n        }\n        \n        // Check if we're in target range\n        const currentWords = chunk.split(/\\s+/).filter(w => w.length > 0).length;\n        if (currentWords >= 120 && currentWords <= 280) {\n          paragraphs.push(chunk.trim());\n          chunk = '';\n        }\n      }\n      \n      // Handle remaining chunk\n      if (chunk.length > 0) {\n        const cWords = chunk.split(/\\s+/).filter(w => w.length > 0).length;\n        if (cWords >= 50) {\n          paragraphs.push(chunk.trim());\n        }\n      }\n    }\n    // If current paragraph is too small, add to buffer\n    else {\n      if (buffer.length > 0) {\n        buffer += '\\n\\n' + paragraph;\n      } else {\n        buffer = paragraph;\n      }\n      \n      // If buffer is now in good range, flush it\n      const bufWords = buffer.split(/\\s+/).filter(w => w.length > 0).length;\n      if (bufWords >= 120 && bufWords <= 280) {\n        paragraphs.push(buffer);\n        buffer = '';\n      }\n    }\n  }\n  \n  // Flush remaining buffer\n  if (buffer.length > 0) {\n    const bufWords = buffer.split(/\\s+/).filter(w => w.length > 0).length;\n    if (bufWords >= 50) {\n      paragraphs.push(buffer);\n    }\n  }\n  \n  return paragraphs;\n}\n\n/**\n * Count syllables in a word using vowel group heuristic\n * @param word The word to count syllables for\n * @returns Number of syllables\n */\nexport function countSyllables(word: string): number {\n  word = word.toLowerCase().trim();\n  \n  if (word.length === 0) return 0;\n  if (word.length <= 2) return 1;\n  \n  // Remove non-alphabetic characters\n  word = word.replace(/[^a-z]/g, '');\n  \n  if (word.length === 0) return 1;\n  \n  // Count vowel groups\n  let syllables = 0;\n  let previousWasVowel = false;\n  const vowels = 'aeiouy';\n  \n  for (let i = 0; i < word.length; i++) {\n    const isVowel = vowels.includes(word[i]);\n    \n    if (isVowel && !previousWasVowel) {\n      syllables++;\n    }\n    \n    previousWasVowel = isVowel;\n  }\n  \n  // Adjust for silent 'e' at the end\n  if (word.endsWith('e') && syllables > 1) {\n    syllables--;\n  }\n  \n  // Adjust for common patterns\n  if (word.endsWith('le') && word.length > 2 && !vowels.includes(word[word.length - 3])) {\n    syllables++;\n  }\n  \n  // Ensure at least 1 syllable\n  return Math.max(syllables, 1);\n}\n\n/**\n * Calculate Flesch-Kincaid Reading Ease score\n * Formula: 206.835 - 1.015 * (words/sentences) - 84.6 * (syllables/words)\n * @param text The text to analyze\n * @returns Reading ease score\n */\nexport function calculateReadingEase(text: string): number {\n  // Count words\n  const words = text.split(/\\s+/).filter(w => w.length > 0);\n  const wordCount = words.length;\n  \n  if (wordCount === 0) return 0;\n  \n  // Count sentences (split on . ! ?)\n  const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);\n  const sentenceCount = Math.max(sentences.length, 1);\n  \n  // Count syllables\n  let totalSyllables = 0;\n  for (const word of words) {\n    totalSyllables += countSyllables(word);\n  }\n  \n  // Calculate reading ease\n  const wordsPerSentence = wordCount / sentenceCount;\n  const syllablesPerWord = totalSyllables / wordCount;\n  \n  const readingEase = 206.835 - 1.015 * wordsPerSentence - 84.6 * syllablesPerWord;\n  \n  return readingEase;\n}\n\n/**\n * Calculate difficulty level based on Flesch-Kincaid Reading Ease\n * Easy: score >= 60\n * Medium: score 45-59\n * Hard: score < 45\n * @param text The text to analyze\n * @returns Difficulty level\n */\nexport function calculateDifficulty(text: string): 'easy' | 'medium' | 'hard' {\n  const readingEase = calculateReadingEase(text);\n  \n  if (readingEase >= 60) {\n    return 'easy';\n  } else if (readingEase >= 45) {\n    return 'medium';\n  } else {\n    return 'hard';\n  }\n}\n\n/**\n * Extract simplified topic from Gutendex subjects and bookshelves\n * @param subjects Array of subject strings\n * @param bookshelves Array of bookshelf strings\n * @returns Simplified topic string\n */\nexport function extractTopic(subjects: string[], bookshelves: string[]): string {\n  const allCategories = [...subjects, ...bookshelves].map(s => s.toLowerCase());\n  \n  // Try to find a match in our topic mapping\n  for (const category of allCategories) {\n    for (const [key, value] of Object.entries(TOPIC_MAPPING)) {\n      if (category.includes(key)) {\n        return value;\n      }\n    }\n  }\n  \n  // If no match found, try to extract a general category\n  if (allCategories.some(c => c.includes('fiction'))) {\n    return 'fiction';\n  }\n  \n  if (allCategories.some(c => c.includes('science'))) {\n    return 'science';\n  }\n  \n  if (allCategories.some(c => c.includes('history'))) {\n    return 'history';\n  }\n  \n  // Default to 'general' if no match found\n  return 'general';\n}\n\n/**\n * Generate URL-safe slug from title\n * @param title The book title\n * @returns URL-safe slug\n */\nexport function generateSlug(title: string): string {\n  return title\n    .toLowerCase()\n    .replace(/['']/g, '') // Remove apostrophes\n    .replace(/[&]/g, 'and') // Replace ampersands with 'and'\n    .replace(/[:;,]/g, '') // Remove colons, semicolons, commas\n    .replace(/[^a-z0-9\\s-]/g, '') // Remove other special characters\n    .replace(/\\s+/g, '-') // Replace spaces with hyphens\n    .replace(/-+/g, '-') // Replace multiple hyphens with single hyphen\n    .replace(/^-|-$/g, ''); // Remove leading/trailing hyphens\n}\n\n/**\n * Detect chapters in book text - STRICT MODE\n * Only detects lines that explicitly start with \"CHAPTER\" followed by a number.\n * This ensures we only get actual chapters, not letters, prologues, or other sections.\n * @param text The cleaned book text\n * @returns Array of ChapterInfo objects\n */\nexport function detectChapters(text: string): ChapterInfo[] {\n  const chapters: ChapterInfo[] = [];\n  const lines = text.split('\\n');\n  \n  // Roman numeral mapping\n  const romanNumerals = [\n    'I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X',\n    'XI', 'XII', 'XIII', 'XIV', 'XV', 'XVI', 'XVII', 'XVIII', 'XIX', 'XX',\n    'XXI', 'XXII', 'XXIII', 'XXIV', 'XXV', 'XXVI', 'XXVII', 'XXVIII', 'XXIX', 'XXX',\n    'XXXI', 'XXXII', 'XXXIII', 'XXXIV', 'XXXV', 'XXXVI', 'XXXVII', 'XXXVIII', 'XXXIX', 'XL',\n    'XLI', 'XLII', 'XLIII', 'XLIV', 'XLV', 'XLVI', 'XLVII', 'XLVIII', 'XLIX', 'L'\n  ];\n  \n  // Ordinal word numbers (for \"CHAPTER THE FIRST\" style)\n  const ordinalNumbers = [\n    'FIRST', 'SECOND', 'THIRD', 'FOURTH', 'FIFTH', 'SIXTH', 'SEVENTH', 'EIGHTH', 'NINTH', 'TENTH',\n    'ELEVENTH', 'TWELFTH', 'THIRTEENTH', 'FOURTEENTH', 'FIFTEENTH', 'SIXTEENTH', 'SEVENTEENTH',\n    'EIGHTEENTH', 'NINETEENTH', 'TWENTIETH'\n  ];\n  \n  let currentPosition = 0;\n  \n  for (let i = 0; i < lines.length; i++) {\n    const originalLine = lines[i];\n    const line = originalLine.trim();\n    const upperLine = line.toUpperCase();\n    \n    if (line.length === 0) {\n      currentPosition += originalLine.length + 1;\n      continue;\n    }\n    \n    let chapterNumber: number | null = null;\n    let title: string | undefined = undefined;\n    \n    // ONLY detect lines starting with \"CHAPTER\" (strict mode)\n    if (upperLine.startsWith('CHAPTER')) {\n      const afterChapter = line.substring(7).trim(); // 7 = length of \"CHAPTER\"\n      const upperAfter = afterChapter.toUpperCase();\n      \n      // Try Arabic numeral: \"CHAPTER 1\", \"CHAPTER 23\", etc.\n      const arabicMatch = afterChapter.match(/^(\\d+)[\\s.:â€”-]*(.*)/);\n      if (arabicMatch) {\n        chapterNumber = parseInt(arabicMatch[1], 10);\n        if (arabicMatch[2].trim()) {\n          title = arabicMatch[2].trim();\n        }\n      }\n      \n      // Try Roman numeral: \"CHAPTER I\", \"CHAPTER XIV\", etc.\n      if (chapterNumber === null) {\n        for (let j = romanNumerals.length - 1; j >= 0; j--) { // Check longer ones first\n          const roman = romanNumerals[j];\n          const romanPattern = new RegExp(`^${roman}(?:[\\\\s.:â€”-]|$)`, 'i');\n          if (romanPattern.test(upperAfter)) {\n            chapterNumber = j + 1;\n            const titleMatch = afterChapter.match(new RegExp(`^${roman}[\\\\s.:â€”-]+(.+)`, 'i'));\n            if (titleMatch && titleMatch[1].trim()) {\n              title = titleMatch[1].trim();\n            }\n            break;\n          }\n        }\n      }\n      \n      // Try ordinal: \"CHAPTER THE FIRST\", \"CHAPTER THE SECOND\", etc.\n      if (chapterNumber === null) {\n        const ordinalPattern = new RegExp(`^THE\\\\s+(${ordinalNumbers.join('|')})`, 'i');\n        const ordinalMatch = upperAfter.match(ordinalPattern);\n        if (ordinalMatch) {\n          const ordinalIndex = ordinalNumbers.indexOf(ordinalMatch[1]);\n          if (ordinalIndex >= 0) {\n            chapterNumber = ordinalIndex + 1;\n          }\n        }\n      }\n      \n      // If we found a chapter but no title, check next line for title\n      if (chapterNumber !== null && !title && i + 1 < lines.length) {\n        const nextLine = lines[i + 1].trim();\n        // Next line should be short (title), not empty, and start with uppercase\n        if (nextLine.length > 0 && nextLine.length <= 80 && /^[A-Z]/.test(nextLine)) {\n          // Don't use next line if it starts with CHAPTER (next chapter)\n          if (!nextLine.toUpperCase().startsWith('CHAPTER')) {\n            title = nextLine;\n          }\n        }\n      }\n    }\n    \n    // Add chapter if found\n    if (chapterNumber !== null) {\n      chapters.push({\n        chapterNumber,\n        startIndex: currentPosition,\n        title\n      });\n    }\n    \n    currentPosition += originalLine.length + 1;\n  }\n  \n  // If no chapters detected, treat entire book as single chapter\n  if (chapters.length === 0) {\n    return [{\n      chapterNumber: 1,\n      startIndex: 0,\n      title: undefined\n    }];\n  }\n  \n  // Sort by position and renumber sequentially\n  chapters.sort((a, b) => a.startIndex - b.startIndex);\n  \n  // Renumber chapters sequentially (1, 2, 3...) to ensure clean numbering\n  for (let i = 0; i < chapters.length; i++) {\n    chapters[i].chapterNumber = i + 1;\n  }\n  \n  return chapters;\n}\n\n/**\n * Process a book into paragraphs with metadata\n * @param book The GutendexBook to process\n * @returns Array of ProcessedParagraph objects\n */\nexport async function processBook(book: GutendexBook): Promise<ProcessedParagraph[]> {\n  console.log(`Processing book: \"${book.title}\" (ID: ${book.id})`);\n  \n  // Check if book has text/plain format (try all variants)\n  const textUrl = book.formats['text/plain; charset=utf-8'] || \n                  book.formats['text/plain; charset=us-ascii'] || \n                  book.formats['text/plain'];\n  if (!textUrl) {\n    console.warn(`Book \"${book.title}\" does not have text/plain format`);\n    return [];\n  }\n  \n  try {\n    // Download book text\n    const rawText = await downloadBookText(textUrl);\n    \n    // Clean the text\n    const cleanedText = cleanBookText(rawText);\n    \n    if (cleanedText.length === 0) {\n      console.warn(`Book \"${book.title}\" has no content after cleaning`);\n      return [];\n    }\n    \n    // Detect chapters in the cleaned text\n    const chapters = detectChapters(cleanedText);\n    \n    console.log(`Book \"${book.title}\": detected ${chapters.length} chapter(s)`);\n    \n    // Get the position of the first chapter - we'll exclude everything before it\n    const firstChapterPosition = chapters.length > 0 ? chapters[0].startIndex : 0;\n    \n    // Split into paragraphs\n    const paragraphs = splitIntoParagraphs(cleanedText);\n    \n    console.log(`Book \"${book.title}\": extracted ${paragraphs.length} raw paragraphs`);\n    \n    // Extract topic\n    const topic = extractTopic(book.subjects, book.bookshelves);\n    \n    // Format source\n    const authorNames = book.authors.map(a => a.name).join(', ');\n    const source = `${book.title} by ${authorNames || 'Unknown'}`;\n    \n    // Helper function to find which chapter a paragraph belongs to\n    const findChapterForPosition = (position: number): ChapterInfo | null => {\n      // If position is before first chapter, return null (exclude this paragraph)\n      if (position < firstChapterPosition) {\n        return null;\n      }\n      // Find the last chapter that starts before or at this position\n      for (let i = chapters.length - 1; i >= 0; i--) {\n        if (chapters[i].startIndex <= position) {\n          return chapters[i];\n        }\n      }\n      return null;\n    };\n    \n    // Helper function to count paragraphs in a chapter\n    const chapterParagraphCounts = new Map<number, number>();\n    \n    // Track current position in the text\n    let currentTextPosition = 0;\n    let paragraphIndex = 0;\n    \n    // Process each paragraph, filtering out those before first chapter\n    const processedParagraphs: ProcessedParagraph[] = [];\n    \n    for (const text of paragraphs) {\n      const words = text.split(/\\s+/).filter(w => w.length > 0);\n      const lengthWords = words.length;\n      \n      // Find the position of this paragraph in the original text\n      const paragraphPosition = cleanedText.indexOf(text, currentTextPosition);\n      currentTextPosition = paragraphPosition >= 0 ? paragraphPosition + text.length : currentTextPosition;\n      \n      // Determine which chapter this paragraph belongs to\n      const chapter = findChapterForPosition(paragraphPosition >= 0 ? paragraphPosition : currentTextPosition);\n      \n      // Skip paragraphs that are before the first chapter (front matter)\n      if (chapter === null) {\n        continue;\n      }\n      \n      // Calculate difficulty\n      const difficulty = calculateDifficulty(text);\n      \n      // Calculate duration mode based on word count (at 50 WPM average)\n      let durationMode: number;\n      if (lengthWords <= 150) {\n        durationMode = 30;\n      } else if (lengthWords <= 300) {\n        durationMode = 60;\n      } else if (lengthWords <= 400) {\n        durationMode = 90;\n      } else {\n        durationMode = 120;\n      }\n      \n      // Calculate section index within the chapter\n      const currentCount = chapterParagraphCounts.get(chapter.chapterNumber) || 0;\n      chapterParagraphCounts.set(chapter.chapterNumber, currentCount + 1);\n      const sectionIndex = currentCount;\n      \n      processedParagraphs.push({\n        text,\n        difficulty,\n        topic,\n        durationMode,\n        lengthWords,\n        source,\n        bookId: book.id,\n        paragraphIndex: paragraphIndex++,\n        language: 'en',\n        chapter: chapter.chapterNumber,\n        sectionIndex,\n        chapterTitle: chapter.title\n      });\n    }\n    \n    console.log(`Book \"${book.title}\": kept ${processedParagraphs.length} paragraphs (excluded front matter)`);\n    \n    // Renumber chapters sequentially starting from 1 after excluding front matter\n    const usedChapters = Array.from(new Set(processedParagraphs.map(p => p.chapter).filter((c): c is number => c !== undefined))).sort((a, b) => a - b);\n    const chapterRemap = new Map<number, number>();\n    usedChapters.forEach((oldNum, idx) => chapterRemap.set(oldNum, idx + 1));\n    \n    // Apply the remapping\n    for (const para of processedParagraphs) {\n      if (para.chapter !== undefined) {\n        para.chapter = chapterRemap.get(para.chapter) || para.chapter;\n      }\n    }\n    \n    console.log(`Book \"${book.title}\": renumbered to ${usedChapters.length} chapters`);\n    \n    return processedParagraphs;\n  } catch (error) {\n    console.error(`Error processing book \"${book.title}\":`, error);\n    return [];\n  }\n}\n\n/**\n * Extract book metadata from GutendexBook and processed paragraphs\n * @param book The GutendexBook object\n * @param paragraphs Array of ProcessedParagraph objects\n * @returns InsertBook object ready for database insertion\n * @throws Error if paragraphs array is empty\n */\nexport function getBookMetadata(book: GutendexBook, paragraphs: ProcessedParagraph[]): InsertBook {\n  // Validate that paragraphs array is not empty\n  if (!paragraphs || paragraphs.length === 0) {\n    throw new Error(`Cannot generate metadata for book \"${book.title}\": No paragraphs were extracted from the book text`);\n  }\n  \n  // Generate slug from title\n  const slug = generateSlug(book.title);\n  \n  // Format author names\n  const authorNames = book.authors.map(a => a.name).join(', ');\n  const author = authorNames || 'Unknown';\n  \n  // Extract topic (use first paragraph's topic, they should all be the same)\n  const topic = paragraphs[0].topic;\n  \n  // Calculate difficulty distribution\n  const difficultyCount = {\n    easy: 0,\n    medium: 0,\n    hard: 0\n  };\n  \n  paragraphs.forEach(p => {\n    difficultyCount[p.difficulty]++;\n  });\n  \n  // Find dominant difficulty (most common)\n  let dominantDifficulty: 'easy' | 'medium' | 'hard' = 'medium';\n  let maxCount = 0;\n  \n  for (const [diff, count] of Object.entries(difficultyCount)) {\n    if (count > maxCount) {\n      maxCount = count;\n      dominantDifficulty = diff as 'easy' | 'medium' | 'hard';\n    }\n  }\n  \n  // Calculate estimated duration map\n  const durationMap: Record<number, number> = {\n    30: 0,\n    60: 0,\n    90: 0,\n    120: 0\n  };\n  \n  paragraphs.forEach(p => {\n    if (p.durationMode in durationMap) {\n      durationMap[p.durationMode]++;\n    }\n  });\n  \n  // Count unique chapters\n  const uniqueChapters = new Set<number>();\n  paragraphs.forEach(p => {\n    if (p.chapter !== undefined) {\n      uniqueChapters.add(p.chapter);\n    }\n  });\n  const totalChapters = uniqueChapters.size > 0 ? uniqueChapters.size : 1;\n  \n  // Get cover image URL (try image/jpeg format)\n  const coverImageUrl = book.formats['image/jpeg'] || null;\n  \n  // Create description from subjects (take first 3)\n  const description = book.subjects.slice(0, 3).join(', ') || null;\n  \n  return {\n    id: book.id,\n    slug,\n    title: book.title,\n    author,\n    language: 'en',\n    topic,\n    difficulty: dominantDifficulty,\n    totalParagraphs: paragraphs.length,\n    totalChapters,\n    coverImageUrl,\n    description,\n    estimatedDurationMap: durationMap\n  };\n}\n","path":null,"size_bytes":28129,"size_tokens":null},"client/src/pages/book-mode.tsx":{"content":"import { useState, useEffect, useRef, useCallback, useMemo } from \"react\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Label } from \"@/components/ui/label\";\nimport { SearchableSelect } from \"@/components/searchable-select\";\nimport { BookOpen, Trophy, Zap, Target, RotateCcw, ArrowRight, Sparkles, Loader2, HelpCircle, RefreshCw, AlertCircle, WifiOff, Share2, Award } from \"lucide-react\";\nimport confetti from \"canvas-confetti\";\nimport type { BookParagraph, InsertBookTypingTest } from \"@shared/schema\";\nimport { calculateWPM, calculateAccuracy } from \"@/lib/typing-utils\";\nimport { BookCertificate } from \"@/components/BookCertificate\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\n\ninterface CachedTopics {\n  topics: string[];\n  timestamp: number;\n}\n\ninterface CachedParagraph {\n  paragraph: BookParagraph;\n  filters: { topic: string; difficulty: string; durationMode: number };\n  timestamp: number;\n}\n\nconst TOPICS_CACHE_KEY = 'book_topics_cache';\nconst PARAGRAPH_CACHE_KEY = 'book_paragraph_cache';\nconst TOPICS_CACHE_TTL = 30 * 60 * 1000;\nconst PARAGRAPH_CACHE_TTL = 10 * 60 * 1000;\n\nfunction getTopicsCache(): string[] | null {\n  try {\n    const cached = localStorage.getItem(TOPICS_CACHE_KEY);\n    if (!cached) return null;\n    \n    const parsed: CachedTopics = JSON.parse(cached);\n    if (Date.now() - parsed.timestamp < TOPICS_CACHE_TTL) {\n      return parsed.topics;\n    }\n    localStorage.removeItem(TOPICS_CACHE_KEY);\n    return null;\n  } catch {\n    return null;\n  }\n}\n\nfunction setTopicsCache(topics: string[]): void {\n  try {\n    const cached: CachedTopics = { topics, timestamp: Date.now() };\n    localStorage.setItem(TOPICS_CACHE_KEY, JSON.stringify(cached));\n  } catch {}\n}\n\nfunction getParagraphCache(filters: { topic: string; difficulty: string; durationMode: number }): BookParagraph | null {\n  try {\n    const cached = localStorage.getItem(PARAGRAPH_CACHE_KEY);\n    if (!cached) return null;\n    \n    const parsed: CachedParagraph = JSON.parse(cached);\n    if (Date.now() - parsed.timestamp < PARAGRAPH_CACHE_TTL &&\n        parsed.filters.topic === filters.topic &&\n        parsed.filters.difficulty === filters.difficulty &&\n        parsed.filters.durationMode === filters.durationMode) {\n      return parsed.paragraph;\n    }\n    return null;\n  } catch {\n    return null;\n  }\n}\n\nfunction setParagraphCache(paragraph: BookParagraph, filters: { topic: string; difficulty: string; durationMode: number }): void {\n  try {\n    const cached: CachedParagraph = { paragraph, filters, timestamp: Date.now() };\n    localStorage.setItem(PARAGRAPH_CACHE_KEY, JSON.stringify(cached));\n  } catch {}\n}\n\nconst DURATION_MODES = [\n  { value: 30, label: \"30s\" },\n  { value: 60, label: \"60s\" },\n  { value: 90, label: \"90s\" },\n  { value: 120, label: \"2min\" },\n];\n\nfunction formatTime(seconds: number): string {\n  const mins = Math.floor(seconds / 60);\n  const secs = seconds % 60;\n  return `${mins}:${secs.toString().padStart(2, '0')}`;\n}\n\nfunction getDifficultyColor(difficulty: string): string {\n  const colors: Record<string, string> = {\n    easy: \"bg-green-500/20 text-green-500 border-green-500/50\",\n    medium: \"bg-yellow-500/20 text-yellow-500 border-yellow-500/50\",\n    hard: \"bg-red-500/20 text-red-500 border-red-500/50\",\n  };\n  return colors[difficulty] || colors.medium;\n}\n\nasync function fetchTopics(): Promise<{ topics: string[] }> {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), 10000);\n  \n  try {\n    const res = await fetch('/api/book-topics', {\n      signal: controller.signal,\n      credentials: 'include',\n    });\n    \n    clearTimeout(timeoutId);\n    \n    if (!res.ok) {\n      throw new Error(`HTTP_${res.status}`);\n    }\n    \n    const data = await res.json();\n    setTopicsCache(data.topics || []);\n    return data;\n  } catch (error: any) {\n    clearTimeout(timeoutId);\n    \n    if (error.name === 'AbortError') {\n      throw new Error('TIMEOUT');\n    }\n    if (error.message === 'Failed to fetch') {\n      throw new Error('NETWORK_ERROR');\n    }\n    throw error;\n  }\n}\n\nasync function fetchRandomParagraph(filters: { topic: string; difficulty: string; durationMode: number }): Promise<BookParagraph> {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), 15000);\n  \n  try {\n    const params = new URLSearchParams();\n    if (filters.topic) params.append('topic', filters.topic);\n    if (filters.difficulty) params.append('difficulty', filters.difficulty);\n    if (filters.durationMode) params.append('durationMode', filters.durationMode.toString());\n    \n    const res = await fetch(`/api/book-paragraphs/random?${params}`, {\n      signal: controller.signal,\n      credentials: 'include',\n    });\n    \n    clearTimeout(timeoutId);\n    \n    if (!res.ok) {\n      if (res.status === 404) {\n        throw new Error('NO_PARAGRAPHS');\n      }\n      throw new Error(`HTTP_${res.status}`);\n    }\n    \n    const paragraph = await res.json();\n    setParagraphCache(paragraph, filters);\n    return paragraph;\n  } catch (error: any) {\n    clearTimeout(timeoutId);\n    \n    if (error.name === 'AbortError') {\n      throw new Error('TIMEOUT');\n    }\n    if (error.message === 'Failed to fetch') {\n      throw new Error('NETWORK_ERROR');\n    }\n    throw error;\n  }\n}\n\nasync function fetchNextParagraph(bookId: number, paragraphIndex: number): Promise<BookParagraph | null> {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), 10000);\n  \n  try {\n    const res = await fetch(`/api/book-paragraphs/next/${bookId}/${paragraphIndex}`, {\n      signal: controller.signal,\n      credentials: 'include',\n    });\n    \n    clearTimeout(timeoutId);\n    \n    if (res.status === 404) {\n      return null;\n    }\n    \n    if (!res.ok) {\n      throw new Error(`HTTP_${res.status}`);\n    }\n    \n    return res.json();\n  } catch (error: any) {\n    clearTimeout(timeoutId);\n    \n    if (error.name === 'AbortError') {\n      throw new Error('TIMEOUT');\n    }\n    if (error.message === 'Failed to fetch') {\n      throw new Error('NETWORK_ERROR');\n    }\n    throw error;\n  }\n}\n\nfunction LoadingSkeleton() {\n  return (\n    <TooltipProvider>\n      <div className=\"container mx-auto py-8 px-4 max-w-6xl\">\n        <div className=\"mb-8 text-center\">\n          <div className=\"flex items-center justify-center gap-3 mb-4\">\n            <BookOpen className=\"w-10 h-10 text-primary\" />\n            <h1 className=\"text-4xl font-bold\">Book Typing Mode</h1>\n          </div>\n          <p className=\"text-muted-foreground text-lg\">\n            Improve your typing speed by reading classic literature\n          </p>\n        </div>\n\n        <Card className=\"p-6 mb-6\">\n          <div className=\"flex flex-wrap gap-4 items-center justify-center\">\n            <Skeleton className=\"h-10 w-40\" />\n            <Skeleton className=\"h-10 w-64\" />\n            <Skeleton className=\"h-10 w-48\" />\n            <Skeleton className=\"h-10 w-28\" />\n          </div>\n        </Card>\n\n        <Card className=\"p-4 mb-6\">\n          <div className=\"flex items-center gap-3\">\n            <Skeleton className=\"h-5 w-5\" />\n            <Skeleton className=\"h-5 w-48\" />\n            <Skeleton className=\"h-6 w-20 rounded-full\" />\n            <Skeleton className=\"h-6 w-16 rounded-full\" />\n          </div>\n        </Card>\n\n        <div className=\"grid grid-cols-4 gap-4 mb-6\">\n          {Array.from({ length: 4 }).map((_, i) => (\n            <Card key={i} className=\"p-4 text-center\">\n              <Skeleton className=\"h-4 w-16 mx-auto mb-2\" />\n              <Skeleton className=\"h-10 w-20 mx-auto\" />\n            </Card>\n          ))}\n        </div>\n\n        <Card className=\"p-6 mb-6\">\n          <div className=\"space-y-3 mb-4\">\n            <Skeleton className=\"h-6 w-full\" />\n            <Skeleton className=\"h-6 w-full\" />\n            <Skeleton className=\"h-6 w-3/4\" />\n          </div>\n          <Skeleton className=\"h-[150px] w-full\" />\n        </Card>\n      </div>\n    </TooltipProvider>\n  );\n}\n\ninterface ErrorStateProps {\n  error: string;\n  onRetry: () => void;\n  isRetrying: boolean;\n  hasFilters: boolean;\n  onResetFilters: () => void;\n}\n\nfunction ErrorState({ error, onRetry, isRetrying, hasFilters, onResetFilters }: ErrorStateProps) {\n  let icon = <AlertCircle className=\"w-16 h-16 text-destructive\" />;\n  let title = \"Unable to Load Paragraph\";\n  let description = \"Something went wrong while loading the book paragraph.\";\n  let showRetry = true;\n  let showResetFilters = false;\n  \n  switch (error) {\n    case 'NETWORK_ERROR':\n      icon = <WifiOff className=\"w-16 h-16 text-muted-foreground\" />;\n      title = \"No Internet Connection\";\n      description = \"Please check your internet connection and try again.\";\n      break;\n    case 'TIMEOUT':\n      title = \"Request Timed Out\";\n      description = \"The server took too long to respond. Please try again.\";\n      break;\n    case 'NO_PARAGRAPHS':\n      icon = <BookOpen className=\"w-16 h-16 text-muted-foreground\" />;\n      title = \"No Paragraphs Found\";\n      description = hasFilters \n        ? \"No paragraphs match your current filters. Try different settings.\"\n        : \"The book library is still being populated. Please check back later.\";\n      showRetry = !hasFilters;\n      showResetFilters = hasFilters;\n      break;\n  }\n  \n  return (\n    <TooltipProvider>\n      <div className=\"container mx-auto py-8 px-4 max-w-6xl\">\n        <div className=\"mb-8 text-center\">\n          <div className=\"flex items-center justify-center gap-3 mb-4\">\n            <BookOpen className=\"w-10 h-10 text-primary\" />\n            <h1 className=\"text-4xl font-bold\">Book Typing Mode</h1>\n          </div>\n        </div>\n        \n        <div className=\"flex flex-col items-center justify-center min-h-[50vh] gap-6 p-4\">\n          {icon}\n          <div className=\"text-center max-w-md\">\n            <h2 className=\"text-2xl font-semibold mb-2\">{title}</h2>\n            <p className=\"text-muted-foreground\">{description}</p>\n          </div>\n          <div className=\"flex flex-col sm:flex-row gap-3\">\n            {showRetry && (\n              <Button\n                onClick={onRetry}\n                disabled={isRetrying}\n                data-testid=\"button-retry-paragraph\"\n              >\n                {isRetrying ? (\n                  <>\n                    <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                    Loading...\n                  </>\n                ) : (\n                  <>\n                    <RefreshCw className=\"w-4 h-4 mr-2\" />\n                    Try Again\n                  </>\n                )}\n              </Button>\n            )}\n            {showResetFilters && (\n              <Button\n                onClick={onResetFilters}\n                variant=\"outline\"\n                data-testid=\"button-reset-filters\"\n              >\n                <RotateCcw className=\"w-4 h-4 mr-2\" />\n                Reset Filters\n              </Button>\n            )}\n          </div>\n        </div>\n      </div>\n    </TooltipProvider>\n  );\n}\n\nexport default function BookMode() {\n  const { user } = useAuth();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  \n  const [filters, setFilters] = useState({ topic: '', difficulty: 'medium', durationMode: 60 });\n  const [currentParagraph, setCurrentParagraph] = useState<BookParagraph | null>(null);\n  const [userInput, setUserInput] = useState(\"\");\n  const [startTime, setStartTime] = useState<number | null>(null);\n  const [isActive, setIsActive] = useState(false);\n  const [isFinished, setIsFinished] = useState(false);\n  const [wpm, setWpm] = useState(0);\n  const [accuracy, setAccuracy] = useState(100);\n  const [errors, setErrors] = useState(0);\n  const [isLoading, setIsLoading] = useState(false);\n  const [loadError, setLoadError] = useState<string | null>(null);\n  const [elapsedTime, setElapsedTime] = useState(0);\n  const [isComposing, setIsComposing] = useState(false);\n  const [completedTestData, setCompletedTestData] = useState<{\n    duration: number;\n    wpm: number;\n    accuracy: number;\n    errors: number;\n  } | null>(null);\n  const [pendingResult, setPendingResult] = useState<Omit<InsertBookTypingTest, 'userId'> | null>(null);\n  const [retryCount, setRetryCount] = useState(0);\n  const [shareDialogOpen, setShareDialogOpen] = useState(false);\n  const [lastResultSnapshot, setLastResultSnapshot] = useState<{\n    wpm: number;\n    accuracy: number;\n    characters: number;\n    errors: number;\n    duration: number;\n    consistency: number;\n    bookTitle: string;\n    author: string;\n    chapter?: number;\n    chapterTitle?: string;\n    paragraphsCompleted: number;\n    wordsTyped: number;\n    difficulty: string;\n  } | null>(null);\n  \n  const textareaRef = useRef<HTMLTextAreaElement>(null);\n  const hasInitiallyLoaded = useRef(false);\n\n  const { \n    data: topicsData,\n    isLoading: topicsLoading,\n    isError: topicsError,\n    refetch: refetchTopics\n  } = useQuery({\n    queryKey: ['bookTopics'],\n    queryFn: fetchTopics,\n    staleTime: 30 * 60 * 1000,\n    gcTime: 60 * 60 * 1000,\n    retry: 2,\n    retryDelay: 1000,\n    placeholderData: () => {\n      const cached = getTopicsCache();\n      return cached ? { topics: cached } : undefined;\n    },\n  });\n\n  const topics = topicsData?.topics || [];\n  const topicOptions = useMemo(() => [\n    { value: '', label: 'All Topics' },\n    ...topics.map((topic: string) => ({ \n      value: topic, \n      label: topic.charAt(0).toUpperCase() + topic.slice(1).replace(/-/g, ' ')\n    }))\n  ], [topics]);\n\n  const fetchParagraph = useCallback(async () => {\n    setIsLoading(true);\n    setLoadError(null);\n    \n    try {\n      const paragraph = await fetchRandomParagraph(filters);\n      setCurrentParagraph(paragraph);\n      resetTestState();\n      setRetryCount(0);\n      \n      if (hasInitiallyLoaded.current) {\n        toast({\n          title: \"Paragraph Loaded\",\n          description: `${paragraph.source} - ${paragraph.lengthWords} words`,\n        });\n      } else {\n        hasInitiallyLoaded.current = true;\n      }\n    } catch (error: any) {\n      console.error(\"Error fetching paragraph:\", error);\n      setLoadError(error.message);\n      \n      const cachedParagraph = getParagraphCache(filters);\n      if (cachedParagraph && !currentParagraph) {\n        setCurrentParagraph(cachedParagraph);\n        toast({\n          title: \"Using Cached Data\",\n          description: \"Loaded a previously cached paragraph due to network issues.\",\n        });\n      } else {\n        let description = \"Unable to load paragraph. Press Ctrl+Enter to retry.\";\n        if (error.message === 'NETWORK_ERROR') {\n          description = \"Network error. Please check your connection and try again.\";\n        } else if (error.message === 'TIMEOUT') {\n          description = \"Request timed out. Please try again.\";\n        } else if (error.message === 'NO_PARAGRAPHS') {\n          description = \"No paragraphs match your current filters. Try different settings.\";\n        }\n        \n        toast({\n          title: \"Failed to Load Paragraph\",\n          description,\n          variant: \"destructive\",\n        });\n      }\n    } finally {\n      setIsLoading(false);\n    }\n  }, [filters, toast, currentParagraph]);\n\n  const continueReading = useCallback(async () => {\n    if (!currentParagraph) return;\n    \n    setIsLoading(true);\n    setLoadError(null);\n    \n    try {\n      const nextParagraph = await fetchNextParagraph(currentParagraph.bookId, currentParagraph.paragraphIndex);\n      \n      if (nextParagraph) {\n        setCurrentParagraph(nextParagraph);\n        resetTestState();\n        toast({\n          title: \"Next Paragraph Loaded\",\n          description: `Paragraph ${nextParagraph.paragraphIndex + 1} of ${nextParagraph.source}`,\n        });\n      } else {\n        toast({\n          title: \"End of Book\",\n          description: \"You've reached the last available paragraph. Loading a new book...\",\n        });\n        await fetchParagraph();\n      }\n    } catch (error: any) {\n      console.error(\"Error loading next paragraph:\", error);\n      \n      let description = \"Loading a new book instead.\";\n      if (error.message === 'NETWORK_ERROR') {\n        description = \"Network error. Loading a new book...\";\n      } else if (error.message === 'TIMEOUT') {\n        description = \"Request timed out. Loading a new book...\";\n      }\n      \n      toast({\n        title: \"Failed to Load Next Paragraph\",\n        description,\n        variant: \"destructive\",\n      });\n      \n      await fetchParagraph();\n    } finally {\n      setIsLoading(false);\n    }\n  }, [currentParagraph, fetchParagraph, toast]);\n\n  const saveTestMutation = useMutation({\n    mutationFn: async (result: Omit<InsertBookTypingTest, 'userId'>) => {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 10000);\n      \n      try {\n        const res = await fetch('/api/book-tests', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify(result),\n          credentials: 'include',\n          signal: controller.signal,\n        });\n        \n        clearTimeout(timeoutId);\n        \n        if (!res.ok) {\n          const errorData = await res.json().catch(() => ({}));\n          throw new Error(errorData.message || `HTTP ${res.status}`);\n        }\n        return res.json();\n      } catch (error: any) {\n        clearTimeout(timeoutId);\n        throw error;\n      }\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Test Saved!\",\n        description: \"Your book typing test result has been saved to your profile.\",\n      });\n      queryClient.invalidateQueries({ queryKey: [\"bookStats\"] });\n      queryClient.invalidateQueries({ queryKey: [\"leaderboard\"] });\n      setPendingResult(null);\n    },\n    onError: (error: any) => {\n      const isNetworkError = error.message === 'Failed to fetch' || \n                             error.name === 'AbortError' ||\n                             error.message.includes('NetworkError');\n      \n      toast({\n        title: \"Failed to Save Test\",\n        description: error.message?.includes(\"401\")\n          ? \"Please log in to save your test results.\"\n          : isNetworkError\n          ? \"Network error. Your result wasn't saved. You can retry below.\"\n          : \"Could not save your test result. Your stats are still visible above.\",\n        variant: \"destructive\",\n      });\n    },\n    retry: 2,\n    retryDelay: 1000,\n  });\n\n  useEffect(() => {\n    fetchParagraph();\n  }, []);\n\n  const normalizedText = useMemo(() => {\n    return (currentParagraph?.text || \"\").replace(/\\n/g, \" \").replace(/\\s+/g, \" \");\n  }, [currentParagraph]);\n\n  const stats = useMemo(() => {\n    if (!isActive || !startTime || !currentParagraph) {\n      return { wpm: 0, accuracy: 100, errors: 0 };\n    }\n    \n    const chars = userInput.length;\n    const errorCount = userInput.split(\"\").filter((char, i) => char !== normalizedText[i]).length;\n    const correctChars = chars - errorCount;\n    const timeElapsed = (Date.now() - startTime) / 1000;\n    \n    return {\n      wpm: calculateWPM(correctChars, timeElapsed),\n      accuracy: calculateAccuracy(correctChars, chars),\n      errors: errorCount,\n    };\n  }, [userInput, isActive, startTime, currentParagraph, normalizedText]);\n\n  useEffect(() => {\n    if (!isActive || isFinished) return;\n    \n    const timer = setTimeout(() => {\n      setWpm(stats.wpm);\n      setAccuracy(stats.accuracy);\n      setErrors(stats.errors);\n    }, 50);\n    \n    return () => clearTimeout(timer);\n  }, [stats, isActive, isFinished]);\n\n  useEffect(() => {\n    if (isActive && currentParagraph && userInput === normalizedText) {\n      finishTest();\n    }\n  }, [userInput, isActive, currentParagraph, normalizedText]);\n\n  useEffect(() => {\n    const handleKeyboard = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\" && !isActive && !isFinished) {\n        resetTest();\n        toast({\n          title: \"Test Reset\",\n          description: \"Press any key to start typing.\",\n        });\n      }\n      \n      if ((e.ctrlKey || e.metaKey) && e.key === \"Enter\" && !isActive) {\n        e.preventDefault();\n        fetchParagraph();\n      }\n\n      if (e.key === \"Tab\" && isFinished) {\n        e.preventDefault();\n        continueReading();\n      }\n    };\n\n    window.addEventListener(\"keydown\", handleKeyboard);\n    return () => window.removeEventListener(\"keydown\", handleKeyboard);\n  }, [isActive, isFinished, fetchParagraph, continueReading, toast]);\n\n  useEffect(() => {\n    if (currentParagraph && !isActive && !isFinished && textareaRef.current) {\n      textareaRef.current.focus();\n    }\n  }, [currentParagraph, isActive, isFinished]);\n\n  useEffect(() => {\n    let interval: NodeJS.Timeout | null = null;\n    \n    if (isActive && startTime) {\n      interval = setInterval(() => {\n        setElapsedTime(Math.floor((Date.now() - startTime) / 1000));\n      }, 100);\n    } else if (!isActive) {\n      setElapsedTime(0);\n    }\n    \n    return () => {\n      if (interval) clearInterval(interval);\n    };\n  }, [isActive, startTime]);\n\n  const finishTest = useCallback(() => {\n    if (!currentParagraph || !startTime) return;\n\n    setIsActive(false);\n    setIsFinished(true);\n    \n    const elapsedSeconds = (Date.now() - startTime) / 1000;\n    const duration = Math.round(elapsedSeconds);\n    \n    const chars = userInput.length;\n    const errorCount = userInput.split(\"\").filter((char, i) => char !== normalizedText[i]).length;\n    const correctChars = chars - errorCount;\n    const finalWpm = calculateWPM(correctChars, elapsedSeconds);\n    const finalAccuracy = calculateAccuracy(correctChars, chars);\n    \n    setWpm(finalWpm);\n    setAccuracy(finalAccuracy);\n    setErrors(errorCount);\n    \n    setCompletedTestData({\n      duration,\n      wpm: finalWpm,\n      accuracy: finalAccuracy,\n      errors: errorCount,\n    });\n    \n    const words = normalizedText.split(/\\s+/).length;\n    const wordsTyped = Math.min(words, Math.floor(userInput.split(/\\s+/).length));\n    const consistency = Math.max(0, Math.min(100, Math.round(100 - (errorCount / chars) * 100)));\n    \n    setLastResultSnapshot({\n      wpm: finalWpm,\n      accuracy: finalAccuracy,\n      characters: chars,\n      errors: errorCount,\n      duration,\n      consistency,\n      bookTitle: currentParagraph.bookTitle,\n      author: currentParagraph.author,\n      chapter: currentParagraph.chapter,\n      chapterTitle: currentParagraph.chapterTitle,\n      paragraphsCompleted: 1,\n      wordsTyped,\n      difficulty: filters.difficulty,\n    });\n    \n    confetti({\n      particleCount: 100,\n      spread: 70,\n      origin: { y: 0.6 },\n      colors: ['#FFD700', '#00FFFF', '#FF00FF']\n    });\n\n    if (user) {\n      const result = {\n        paragraphId: currentParagraph.id,\n        wpm: finalWpm,\n        accuracy: finalAccuracy,\n        characters: chars,\n        errors: errorCount,\n        duration,\n      };\n      setPendingResult(result);\n      saveTestMutation.mutate(result);\n    }\n  }, [currentParagraph, startTime, userInput, user, saveTestMutation, normalizedText]);\n\n  const handleInput = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n    if (isComposing) return;\n    processInput(e.target.value);\n  };\n\n  const handleCompositionStart = () => {\n    setIsComposing(true);\n  };\n\n  const handleCompositionEnd = (e: React.CompositionEvent<HTMLTextAreaElement>) => {\n    setIsComposing(false);\n    setTimeout(() => {\n      if (textareaRef.current) {\n        processInput(textareaRef.current.value);\n      }\n    }, 0);\n  };\n\n  const processInput = (value: string) => {\n    if (!currentParagraph || isFinished) return;\n    \n    if (value.length > normalizedText.length) {\n      if (textareaRef.current) textareaRef.current.value = userInput;\n      return;\n    }\n    \n    if (!isActive && value.length > 0) {\n      setIsActive(true);\n      setStartTime(Date.now());\n    }\n    \n    setUserInput(value);\n  };\n\n  const handlePaste = (e: React.ClipboardEvent<HTMLTextAreaElement>) => {\n    e.preventDefault();\n    toast({\n      title: \"Paste Disabled\",\n      description: \"Please type manually for accurate results.\",\n      variant: \"destructive\",\n    });\n  };\n\n  const handleCut = (e: React.ClipboardEvent<HTMLTextAreaElement>) => {\n    e.preventDefault();\n  };\n\n  const resetTestState = () => {\n    setUserInput(\"\");\n    setStartTime(null);\n    setIsActive(false);\n    setIsFinished(false);\n    setWpm(0);\n    setAccuracy(100);\n    setErrors(0);\n    setCompletedTestData(null);\n    setElapsedTime(0);\n    setPendingResult(null);\n    setTimeout(() => textareaRef.current?.focus(), 0);\n  };\n\n  const resetTest = () => {\n    resetTestState();\n    fetchParagraph();\n  };\n  \n  const handleResetFilters = () => {\n    setFilters({ topic: '', difficulty: 'medium', durationMode: 60 });\n    setLoadError(null);\n    setTimeout(() => fetchParagraph(), 100);\n  };\n  \n  const handleRetrySave = () => {\n    if (pendingResult) {\n      saveTestMutation.mutate(pendingResult);\n    }\n  };\n  \n  const hasFilters = filters.topic !== '' || filters.difficulty !== 'medium' || filters.durationMode !== 60;\n\n  const highlightedText = useMemo(() => {\n    if (!normalizedText) return [];\n    \n    const expectedWords = normalizedText.split(\" \");\n    const typedWords = userInput.split(\" \");\n    const result: React.ReactNode[] = [];\n    let charIndex = 0;\n\n    expectedWords.forEach((expectedWord, wordIndex) => {\n      const typedWord = typedWords[wordIndex];\n      const isCurrentWord = wordIndex === typedWords.length - 1;\n      const isTypedWord = wordIndex < typedWords.length;\n\n      for (let i = 0; i < expectedWord.length; i++) {\n        const expectedChar = expectedWord[i];\n        let className = \"text-muted-foreground\";\n        let displayChar = expectedChar;\n        let showTypedChar = false;\n        let typedChar = \"\";\n\n        if (isTypedWord && typedWord !== undefined) {\n          if (i < typedWord.length) {\n            if (typedWord[i] === expectedChar) {\n              className = \"text-green-500\";\n            } else {\n              className = \"text-red-500 line-through opacity-70\";\n              showTypedChar = true;\n              typedChar = typedWord[i];\n            }\n          } else if (!isCurrentWord) {\n            className = \"text-red-500 bg-red-500/20\";\n          }\n        }\n\n        if (showTypedChar) {\n          result.push(\n            <span key={charIndex} className=\"relative\">\n              <span className={className}>{expectedChar}</span>\n              <span className=\"text-yellow-400 font-bold\">{typedChar}</span>\n            </span>\n          );\n        } else {\n          result.push(\n            <span key={charIndex} className={className}>\n              {displayChar}\n            </span>\n          );\n        }\n        charIndex++;\n      }\n\n      if (wordIndex < expectedWords.length - 1) {\n        let spaceClassName = \"text-muted-foreground\";\n        if (isTypedWord && !isCurrentWord) {\n          const typedHasSpace = typedWords.length > wordIndex + 1;\n          spaceClassName = typedHasSpace ? \"text-green-500\" : \"text-red-500 bg-red-500/20\";\n        }\n        result.push(\n          <span key={`space-${charIndex}`} className={spaceClassName}>\n            {\" \"}\n          </span>\n        );\n        charIndex++;\n      }\n    });\n\n    return result;\n  }, [normalizedText, userInput]);\n\n  if (!currentParagraph && isLoading) {\n    return <LoadingSkeleton />;\n  }\n\n  if (!currentParagraph && loadError) {\n    return (\n      <ErrorState\n        error={loadError}\n        onRetry={fetchParagraph}\n        isRetrying={isLoading}\n        hasFilters={hasFilters}\n        onResetFilters={handleResetFilters}\n      />\n    );\n  }\n\n  if (!currentParagraph && !isLoading) {\n    return (\n      <ErrorState\n        error=\"NO_PARAGRAPHS\"\n        onRetry={fetchParagraph}\n        isRetrying={isLoading}\n        hasFilters={hasFilters}\n        onResetFilters={handleResetFilters}\n      />\n    );\n  }\n\n  return (\n    <TooltipProvider>\n      <div className=\"container mx-auto py-8 px-4 max-w-6xl\">\n        <div className=\"mb-8 text-center\">\n          <div className=\"flex items-center justify-center gap-3 mb-4\">\n            <BookOpen className=\"w-10 h-10 text-primary\" />\n            <h1 className=\"text-4xl font-bold\">Book Typing Mode</h1>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Badge \n                  variant=\"outline\" \n                  className=\"bg-gradient-to-r from-violet-500/20 to-purple-500/20 border-violet-500/50 text-violet-400 font-semibold cursor-help\"\n                >\n                  BETA\n                </Badge>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>This feature is in beta. We're actively improving it based on your feedback!</p>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n          <p className=\"text-muted-foreground text-lg\">\n            Improve your typing speed by reading classic literature\n          </p>\n        </div>\n\n        <Card className=\"p-6 mb-6\">\n          <div className=\"flex flex-wrap gap-4 items-center justify-center\">\n            <div className=\"flex items-center gap-2\">\n              <label className=\"text-sm font-medium flex items-center gap-1\">\n                Topic:\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <HelpCircle className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p className=\"max-w-xs\">Choose a book topic: fiction, philosophy, science, history, and more from classic literature</p>\n                  </TooltipContent>\n                </Tooltip>\n              </label>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div>\n                    <SearchableSelect\n                      value={filters.topic}\n                      onValueChange={(value) => setFilters({ ...filters, topic: value })}\n                      options={topicOptions}\n                      placeholder=\"All Topics\"\n                      searchPlaceholder=\"Search topics...\"\n                      icon={<Sparkles className=\"w-4 h-4\" />}\n                    />\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Filter books by subject matter or browse all topics</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n\n            <div className=\"flex items-center gap-2\">\n              <label className=\"text-sm font-medium flex items-center gap-1\">\n                Difficulty:\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <HelpCircle className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p className=\"max-w-xs\">Easy: simple vocabulary â€¢ Medium: standard literature â€¢ Hard: complex language and longer sentences</p>\n                  </TooltipContent>\n                </Tooltip>\n              </label>\n              <RadioGroup\n                value={filters.difficulty}\n                onValueChange={(value) => setFilters({ ...filters, difficulty: value })}\n                className=\"flex gap-2\"\n                disabled={isActive}\n              >\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"flex items-center space-x-2\">\n                      <RadioGroupItem value=\"easy\" id=\"easy\" data-testid=\"radio-difficulty-easy\" />\n                      <Label htmlFor=\"easy\" className=\"cursor-pointer\">Easy</Label>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Simple vocabulary and short sentences</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"flex items-center space-x-2\">\n                      <RadioGroupItem value=\"medium\" id=\"medium\" data-testid=\"radio-difficulty-medium\" />\n                      <Label htmlFor=\"medium\" className=\"cursor-pointer\">Medium</Label>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Standard literary vocabulary and structure</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"flex items-center space-x-2\">\n                      <RadioGroupItem value=\"hard\" id=\"hard\" data-testid=\"radio-difficulty-hard\" />\n                      <Label htmlFor=\"hard\" className=\"cursor-pointer\">Hard</Label>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Complex language, advanced vocabulary, longer sentences</p>\n                  </TooltipContent>\n                </Tooltip>\n              </RadioGroup>\n            </div>\n\n            <div className=\"flex items-center gap-2\">\n              <label className=\"text-sm font-medium flex items-center gap-1\">\n                Duration:\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <HelpCircle className=\"w-3.5 h-3.5 text-muted-foreground cursor-help\" />\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p className=\"max-w-xs\">Choose paragraph length: 30s for quick practice, up to 2min for longer reading sessions</p>\n                  </TooltipContent>\n                </Tooltip>\n              </label>\n              <div className=\"flex gap-1\">\n                {DURATION_MODES.map((mode) => (\n                  <Tooltip key={mode.value}>\n                    <TooltipTrigger asChild>\n                      <Button\n                        variant={filters.durationMode === mode.value ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        onClick={() => setFilters({ ...filters, durationMode: mode.value })}\n                        disabled={isActive}\n                        data-testid={`button-duration-${mode.value}`}\n                      >\n                        {mode.label}\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>Target reading time: {mode.label}</p>\n                    </TooltipContent>\n                  </Tooltip>\n                ))}\n              </div>\n            </div>\n\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Button\n                  onClick={fetchParagraph}\n                  disabled={isActive || isLoading}\n                  variant=\"secondary\"\n                  data-testid=\"button-new-book\"\n                >\n                  {isLoading ? <Loader2 className=\"w-4 h-4 animate-spin\" /> : <RotateCcw className=\"w-4 h-4\" />}\n                  <span className=\"ml-2\">New Book</span>\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Load a random paragraph from a different book (or press Ctrl+Enter)</p>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n        </Card>\n\n      {currentParagraph && (\n        <Card className=\"p-4 mb-6 border-primary/50\">\n          <div className=\"flex flex-wrap items-center gap-3 justify-between\">\n            <div className=\"flex items-center gap-3 flex-wrap\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"flex items-center gap-2 cursor-help\">\n                    <BookOpen className=\"w-5 h-5 text-primary\" />\n                    <span className=\"font-semibold\" data-testid=\"text-book-source\">\n                      {currentParagraph.source}\n                    </span>\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Current book title from the library</p>\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Badge variant=\"outline\" className=\"capitalize cursor-help\">\n                    {currentParagraph.topic.replace(/-/g, ' ')}\n                  </Badge>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Book genre/category</p>\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Badge variant=\"outline\" className={`cursor-help ${getDifficultyColor(currentParagraph.difficulty)}`}>\n                    {currentParagraph.difficulty}\n                  </Badge>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>\n                    {currentParagraph.difficulty === 'easy' ? 'Beginner-friendly text' :\n                     currentParagraph.difficulty === 'medium' ? 'Standard literary complexity' :\n                     'Advanced vocabulary and structure'}\n                  </p>\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <span className=\"text-sm text-muted-foreground cursor-help\" data-testid=\"text-paragraph-progress\">\n                    Paragraph {currentParagraph.paragraphIndex + 1}\n                  </span>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Your position in the current book</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div className=\"text-sm text-muted-foreground cursor-help\">\n                  {currentParagraph.lengthWords} words\n                </div>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Total words in this paragraph</p>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n        </Card>\n      )}\n\n      <div className=\"grid grid-cols-4 gap-4 mb-6\">\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Card className=\"p-4 text-center cursor-help\">\n              <div className=\"flex items-center justify-center gap-2 mb-1\">\n                <Zap className=\"w-4 h-4 text-yellow-500\" />\n                <span className=\"text-sm text-muted-foreground\">WPM</span>\n              </div>\n              <div className=\"text-3xl font-bold text-yellow-500\" data-testid=\"text-wpm\">\n                {wpm}\n              </div>\n            </Card>\n          </TooltipTrigger>\n          <TooltipContent>\n            <p>Words Per Minute - your typing speed</p>\n          </TooltipContent>\n        </Tooltip>\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Card className=\"p-4 text-center cursor-help\">\n              <div className=\"flex items-center justify-center gap-2 mb-1\">\n                <Target className=\"w-4 h-4 text-green-500\" />\n                <span className=\"text-sm text-muted-foreground\">Accuracy</span>\n              </div>\n              <div className=\"text-3xl font-bold text-green-500\" data-testid=\"text-accuracy\">\n                {accuracy}%\n              </div>\n            </Card>\n          </TooltipTrigger>\n          <TooltipContent>\n            <p>Percentage of correctly typed characters</p>\n          </TooltipContent>\n        </Tooltip>\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Card className=\"p-4 text-center cursor-help\">\n              <div className=\"flex items-center justify-center gap-2 mb-1\">\n                <span className=\"text-sm text-muted-foreground\">Errors</span>\n              </div>\n              <div className=\"text-3xl font-bold text-red-500\" data-testid=\"text-errors\">\n                {errors}\n              </div>\n            </Card>\n          </TooltipTrigger>\n          <TooltipContent>\n            <p>Number of incorrect characters typed</p>\n          </TooltipContent>\n        </Tooltip>\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Card className=\"p-4 text-center cursor-help\">\n              <div className=\"flex items-center justify-center gap-2 mb-1\">\n                <span className=\"text-sm text-muted-foreground\">Time</span>\n              </div>\n              <div className=\"text-3xl font-bold\" data-testid=\"text-timer\">\n                {formatTime(elapsedTime)}\n              </div>\n            </Card>\n          </TooltipTrigger>\n          <TooltipContent>\n            <p>Total time spent typing</p>\n          </TooltipContent>\n        </Tooltip>\n      </div>\n\n      <Card className=\"p-4 mb-4 bg-muted/30 border-dashed\">\n        <div className=\"flex items-start gap-3\">\n          <HelpCircle className=\"w-5 h-5 text-primary mt-0.5 flex-shrink-0\" />\n          <div className=\"text-sm text-muted-foreground\">\n            <p className=\"font-medium text-foreground mb-1\">How highlighting works:</p>\n            <ul className=\"space-y-1 list-disc list-inside\">\n              <li><span className=\"text-green-500\">Green</span> = Correct character</li>\n              <li><span className=\"text-red-500 line-through\">Red strikethrough</span> + <span className=\"text-yellow-400 font-bold\">Yellow</span> = Wrong character (shows expected vs what you typed)</li>\n              <li><span className=\"text-muted-foreground\">Gray</span> = Not typed yet</li>\n            </ul>\n            <p className=\"mt-2 text-xs\">Tip: Use <kbd className=\"px-1.5 py-0.5 bg-background rounded text-xs\">Backspace</kbd> to fix mistakes before continuing.</p>\n          </div>\n        </div>\n      </Card>\n\n      <Card className=\"p-6 mb-6 relative\">\n        {isLoading && (\n          <div className=\"absolute inset-0 bg-background/80 backdrop-blur-sm flex items-center justify-center z-10 rounded-lg\">\n            <div className=\"flex flex-col items-center gap-2\">\n              <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n              <span className=\"text-sm text-muted-foreground\">Loading paragraph...</span>\n            </div>\n          </div>\n        )}\n\n        <div className=\"mb-4\">\n          <pre className=\"font-serif text-lg leading-relaxed whitespace-pre-wrap\">\n            {highlightedText}\n          </pre>\n        </div>\n\n        <Textarea\n          ref={textareaRef}\n          value={userInput}\n          onChange={handleInput}\n          onCompositionStart={handleCompositionStart}\n          onCompositionEnd={handleCompositionEnd}\n          onPaste={handlePaste}\n          onCut={handleCut}\n          placeholder={isLoading ? \"Loading paragraph...\" : \"Start typing here...\"}\n          className=\"min-h-[150px] font-serif text-lg resize-none\"\n          disabled={isFinished || isLoading}\n          data-testid=\"textarea-typing\"\n        />\n\n        {isFinished && (\n          <div className=\"mt-4 flex gap-3 justify-center flex-wrap\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Button\n                  onClick={continueReading}\n                  size=\"lg\"\n                  className=\"gap-2\"\n                  disabled={isLoading}\n                  data-testid=\"button-continue-reading\"\n                >\n                  <ArrowRight className=\"w-5 h-5\" />\n                  Continue Reading\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Load the next paragraph from the same book (or press Tab)</p>\n              </TooltipContent>\n            </Tooltip>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Button\n                  onClick={resetTest}\n                  variant=\"outline\"\n                  size=\"lg\"\n                  className=\"gap-2\"\n                  disabled={isLoading}\n                  data-testid=\"button-new-paragraph\"\n                >\n                  <RotateCcw className=\"w-5 h-5\" />\n                  New Paragraph\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Get a random paragraph from a different book based on your filters</p>\n              </TooltipContent>\n            </Tooltip>\n            {pendingResult && saveTestMutation.isError && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    onClick={handleRetrySave}\n                    variant=\"outline\"\n                    size=\"lg\"\n                    className=\"gap-2\"\n                    disabled={saveTestMutation.isPending}\n                    data-testid=\"button-retry-save\"\n                  >\n                    {saveTestMutation.isPending ? (\n                      <Loader2 className=\"w-5 h-5 animate-spin\" />\n                    ) : (\n                      <RefreshCw className=\"w-5 h-5\" />\n                    )}\n                    Retry Save\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Try saving your results again</p>\n                </TooltipContent>\n              </Tooltip>\n            )}\n          </div>\n        )}\n      </Card>\n\n      <Tooltip>\n        <TooltipTrigger asChild>\n          <Card className=\"p-4 bg-muted/50 cursor-help\">\n            <div className=\"text-sm text-muted-foreground text-center\">\n              <span className=\"font-semibold\">Shortcuts:</span>{\" \"}\n              <kbd className=\"px-2 py-1 bg-background rounded text-xs\">Esc</kbd> Reset â€¢ {\" \"}\n              <kbd className=\"px-2 py-1 bg-background rounded text-xs\">Ctrl+Enter</kbd> New Paragraph â€¢ {\" \"}\n              <kbd className=\"px-2 py-1 bg-background rounded text-xs\">Tab</kbd> Continue Reading (when finished)\n            </div>\n          </Card>\n        </TooltipTrigger>\n        <TooltipContent>\n          <p>Use these keyboard shortcuts for quick actions while typing</p>\n        </TooltipContent>\n      </Tooltip>\n\n      <Dialog open={isFinished} onOpenChange={(open) => !open && resetTestState()}>\n        <DialogContent data-testid=\"dialog-results\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2 text-2xl\">\n              <Trophy className=\"w-6 h-6 text-yellow-500\" />\n              Test Complete!\n            </DialogTitle>\n            <DialogDescription>\n              Great job! Here are your results:\n            </DialogDescription>\n          </DialogHeader>\n          {completedTestData && (\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"p-4 bg-muted rounded-lg text-center\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">WPM</div>\n                  <div className=\"text-3xl font-bold text-yellow-500\">{completedTestData.wpm}</div>\n                </div>\n                <div className=\"p-4 bg-muted rounded-lg text-center\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">Accuracy</div>\n                  <div className=\"text-3xl font-bold text-green-500\">{completedTestData.accuracy}%</div>\n                </div>\n                <div className=\"p-4 bg-muted rounded-lg text-center\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">Errors</div>\n                  <div className=\"text-3xl font-bold text-red-500\">{completedTestData.errors}</div>\n                </div>\n                <div className=\"p-4 bg-muted rounded-lg text-center\">\n                  <div className=\"text-sm text-muted-foreground mb-1\">Time</div>\n                  <div className=\"text-3xl font-bold\">{formatTime(completedTestData.duration)}</div>\n                </div>\n              </div>\n              \n              {saveTestMutation.isError && (\n                <div className=\"p-3 bg-destructive/10 rounded-lg text-center\">\n                  <p className=\"text-sm text-destructive mb-2\">Failed to save your result</p>\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    onClick={handleRetrySave}\n                    disabled={saveTestMutation.isPending}\n                    data-testid=\"button-dialog-retry-save\"\n                  >\n                    {saveTestMutation.isPending ? (\n                      <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                    ) : (\n                      <RefreshCw className=\"w-4 h-4 mr-2\" />\n                    )}\n                    Retry Save\n                  </Button>\n                </div>\n              )}\n              \n              <div className=\"flex gap-3\">\n                {lastResultSnapshot && (\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        onClick={() => setShareDialogOpen(true)}\n                        variant=\"outline\"\n                        className=\"gap-2\"\n                        data-testid=\"button-share-results\"\n                      >\n                        <Share2 className=\"w-4 h-4\" />\n                        Share\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\">\n                      <p className=\"text-xs\">Share your book typing achievement with certificate</p>\n                    </TooltipContent>\n                  </Tooltip>\n                )}\n                <Button\n                  onClick={continueReading}\n                  className=\"flex-1 gap-2\"\n                  disabled={isLoading}\n                  data-testid=\"button-dialog-continue\"\n                >\n                  <ArrowRight className=\"w-4 h-4\" />\n                  Continue Reading\n                </Button>\n                <Button\n                  onClick={resetTest}\n                  variant=\"outline\"\n                  className=\"flex-1 gap-2\"\n                  disabled={isLoading}\n                  data-testid=\"button-dialog-new\"\n                >\n                  <RotateCcw className=\"w-4 h-4\" />\n                  New Book\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Share Dialog with Certificate */}\n      <Dialog open={shareDialogOpen} onOpenChange={setShareDialogOpen}>\n        <DialogContent className=\"sm:max-w-[650px] max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <Share2 className=\"w-5 h-5\" />\n              Share Your Book Typing Result\n            </DialogTitle>\n            <DialogDescription>\n              Share your {lastResultSnapshot?.bookTitle} achievement with others!\n            </DialogDescription>\n          </DialogHeader>\n          \n          {lastResultSnapshot && (\n            <Tabs defaultValue=\"certificate\" className=\"w-full\">\n              <TabsList className=\"grid w-full grid-cols-1\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <TabsTrigger value=\"certificate\" className=\"gap-2\" data-testid=\"tab-certificate\">\n                      <Award className=\"w-4 h-4\" />\n                      Certificate\n                    </TabsTrigger>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"bottom\">\n                    <p className=\"text-xs\">Professional 1200Ã—675 certificate with verification ID</p>\n                  </TooltipContent>\n                </Tooltip>\n              </TabsList>\n              \n              <TabsContent value=\"certificate\" className=\"mt-4\">\n                <BookCertificate\n                  wpm={lastResultSnapshot.wpm}\n                  accuracy={lastResultSnapshot.accuracy}\n                  consistency={lastResultSnapshot.consistency}\n                  bookTitle={lastResultSnapshot.bookTitle}\n                  author={lastResultSnapshot.author}\n                  chapter={lastResultSnapshot.chapter}\n                  chapterTitle={lastResultSnapshot.chapterTitle}\n                  paragraphsCompleted={lastResultSnapshot.paragraphsCompleted}\n                  wordsTyped={lastResultSnapshot.wordsTyped}\n                  characters={lastResultSnapshot.characters}\n                  errors={lastResultSnapshot.errors}\n                  duration={lastResultSnapshot.duration}\n                  difficulty={lastResultSnapshot.difficulty}\n                  username={user?.username}\n                />\n              </TabsContent>\n            </Tabs>\n          )}\n        </DialogContent>\n      </Dialog>\n      </div>\n    </TooltipProvider>\n  );\n}\n","path":null,"size_bytes":53264,"size_tokens":null},"server/scripts/populate-books.ts":{"content":"import { fetchBooksFromGutendex, processBook, getBookMetadata } from '../book-fetcher';\nimport { storage } from '../storage';\n\nasync function populateBooks() {\n  // Get book limit from command line args (default 50)\n  const bookLimit = parseInt(process.argv[2]) || 50;\n  \n  console.log('ðŸ“š Starting book population from Gutendex API...\\n');\n  \n  try {\n    console.log(`Fetching ${bookLimit} books from Gutendex...`);\n    const books = await fetchBooksFromGutendex(bookLimit);\n    console.log(`âœ“ Found ${books.length} books\\n`);\n    \n    let totalParagraphs = 0;\n    let successfulBooks = 0;\n    \n    for (let i = 0; i < books.length; i++) {\n      const book = books[i];\n      try {\n        console.log(`[${i + 1}/${books.length}] Processing: ${book.title}...`);\n        \n        // Process book to get paragraphs with chapter info\n        const paragraphs = await processBook(book);\n        \n        if (paragraphs.length === 0) {\n          console.log(`  âš  No paragraphs extracted`);\n          continue;\n        }\n        \n        // Get book metadata\n        const bookMetadata = getBookMetadata(book, paragraphs);\n        \n        // Save book record first\n        await storage.insertBook(bookMetadata);\n        console.log(`  âœ“ Created book: ${bookMetadata.title} (${bookMetadata.totalChapters} chapters)`);\n        \n        // Save all paragraphs\n        await storage.insertBookParagraphs(paragraphs);\n        totalParagraphs += paragraphs.length;\n        successfulBooks++;\n        console.log(`  âœ“ Inserted ${paragraphs.length} paragraphs`);\n        \n      } catch (error) {\n        console.error(`  âœ— Error processing book:`, error instanceof Error ? error.message : String(error));\n        continue;\n      }\n    }\n    \n    console.log(`\\nâœ… Population complete!`);\n    console.log(`   Books processed: ${successfulBooks}/${books.length}`);\n    console.log(`   Total paragraphs: ${totalParagraphs}`);\n    \n  } catch (error) {\n    console.error('âŒ Fatal error:', error);\n    process.exit(1);\n  }\n}\n\npopulateBooks();\n","path":null,"size_bytes":2040,"size_tokens":null},"client/src/pages/book-detail.tsx":{"content":"import { useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useRoute, useLocation } from \"wouter\";\nimport { Card } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { BookOpen, Loader2, ArrowLeft, FileText, RefreshCw, AlertCircle, WifiOff, ChevronRight } from \"lucide-react\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\";\nimport { useCallback, useEffect, useState } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Book } from \"@shared/schema\";\n\ninterface Chapter {\n  chapter: number;\n  title: string | null;\n  paragraphCount: number;\n}\n\ninterface CachedBookData {\n  book: Book;\n  chapters: Chapter[];\n  timestamp: number;\n}\n\nconst CACHE_TTL = 10 * 60 * 1000;\n\nfunction getBookDetailCache(slug: string): CachedBookData | null {\n  try {\n    const cached = localStorage.getItem(`book_detail_${slug}`);\n    if (!cached) return null;\n    \n    const parsed: CachedBookData = JSON.parse(cached);\n    const age = Date.now() - parsed.timestamp;\n    \n    if (age < CACHE_TTL) {\n      return parsed;\n    }\n    \n    localStorage.removeItem(`book_detail_${slug}`);\n    return null;\n  } catch {\n    return null;\n  }\n}\n\nfunction setBookDetailCache(slug: string, book: Book, chapters: Chapter[]): void {\n  try {\n    const cached: CachedBookData = {\n      book,\n      chapters,\n      timestamp: Date.now(),\n    };\n    localStorage.setItem(`book_detail_${slug}`, JSON.stringify(cached));\n  } catch {\n  }\n}\n\nasync function fetchBook(slug: string): Promise<Book> {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), 15000);\n  \n  try {\n    const res = await fetch(`/api/books/${slug}`, {\n      signal: controller.signal,\n      credentials: 'include',\n    });\n    \n    clearTimeout(timeoutId);\n    \n    if (!res.ok) {\n      if (res.status === 404) {\n        throw new Error('BOOK_NOT_FOUND');\n      }\n      if (res.status >= 500) {\n        throw new Error('SERVER_ERROR');\n      }\n      throw new Error(`HTTP_${res.status}`);\n    }\n    \n    return res.json();\n  } catch (error: any) {\n    clearTimeout(timeoutId);\n    \n    if (error.name === 'AbortError') {\n      throw new Error('TIMEOUT');\n    }\n    \n    if (error.message === 'Failed to fetch' || error.message.includes('NetworkError')) {\n      throw new Error('NETWORK_ERROR');\n    }\n    \n    throw error;\n  }\n}\n\nasync function fetchChapters(bookId: number): Promise<Chapter[]> {\n  const controller = new AbortController();\n  const timeoutId = setTimeout(() => controller.abort(), 15000);\n  \n  try {\n    const res = await fetch(`/api/books/${bookId}/chapters`, {\n      signal: controller.signal,\n      credentials: 'include',\n    });\n    \n    clearTimeout(timeoutId);\n    \n    if (!res.ok) {\n      if (res.status === 404) {\n        throw new Error('CHAPTERS_NOT_FOUND');\n      }\n      if (res.status >= 500) {\n        throw new Error('SERVER_ERROR');\n      }\n      throw new Error(`HTTP_${res.status}`);\n    }\n    \n    return res.json();\n  } catch (error: any) {\n    clearTimeout(timeoutId);\n    \n    if (error.name === 'AbortError') {\n      throw new Error('TIMEOUT');\n    }\n    \n    if (error.message === 'Failed to fetch' || error.message.includes('NetworkError')) {\n      throw new Error('NETWORK_ERROR');\n    }\n    \n    throw error;\n  }\n}\n\nfunction ChapterSkeleton() {\n  return (\n    <Card className=\"p-4\">\n      <div className=\"flex items-center gap-4\">\n        <Skeleton className=\"w-11 h-11 rounded-lg\" />\n        <div className=\"flex-1 space-y-2\">\n          <Skeleton className=\"h-5 w-48\" />\n          <Skeleton className=\"h-4 w-24\" />\n        </div>\n        <Skeleton className=\"h-9 w-24 rounded-md\" />\n      </div>\n    </Card>\n  );\n}\n\nfunction LoadingState() {\n  return (\n    <div className=\"container py-8 max-w-4xl\">\n      <Skeleton className=\"h-9 w-36 mb-6\" />\n      \n      <div className=\"mb-8\">\n        <div className=\"flex items-start gap-4 mb-4\">\n          <Skeleton className=\"w-20 h-20 rounded-lg\" />\n          <div className=\"flex-1 space-y-3\">\n            <Skeleton className=\"h-10 w-3/4\" />\n            <Skeleton className=\"h-6 w-1/2\" />\n            <div className=\"flex gap-3\">\n              <Skeleton className=\"h-7 w-16 rounded-full\" />\n              <Skeleton className=\"h-7 w-20 rounded-full\" />\n              <Skeleton className=\"h-7 w-24\" />\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <Skeleton className=\"h-8 w-32 mb-4\" />\n      <div className=\"space-y-3\">\n        {Array.from({ length: 5 }).map((_, i) => (\n          <ChapterSkeleton key={i} />\n        ))}\n      </div>\n    </div>\n  );\n}\n\ninterface ErrorStateProps {\n  error: Error;\n  onRetry: () => void;\n  isRetrying: boolean;\n  onGoBack: () => void;\n  cachedData: CachedBookData | null;\n  onUseCached: () => void;\n}\n\nfunction ErrorState({ error, onRetry, isRetrying, onGoBack, cachedData, onUseCached }: ErrorStateProps) {\n  const errorType = error.message;\n  \n  let icon = <AlertCircle className=\"w-16 h-16 text-destructive\" />;\n  let title = \"Unable to Load Book\";\n  let description = \"Something went wrong while loading the book details.\";\n  let canRetry = true;\n  \n  switch (errorType) {\n    case 'NETWORK_ERROR':\n      icon = <WifiOff className=\"w-16 h-16 text-muted-foreground\" />;\n      title = \"No Internet Connection\";\n      description = \"Please check your internet connection and try again.\";\n      break;\n    case 'TIMEOUT':\n      title = \"Request Timed Out\";\n      description = \"The server took too long to respond. Please try again.\";\n      break;\n    case 'SERVER_ERROR':\n      title = \"Server Error\";\n      description = \"The server encountered an error. Please try again later.\";\n      break;\n    case 'BOOK_NOT_FOUND':\n      icon = <BookOpen className=\"w-16 h-16 text-muted-foreground\" />;\n      title = \"Book Not Found\";\n      description = \"This book doesn't exist or may have been removed.\";\n      canRetry = false;\n      break;\n    case 'CHAPTERS_NOT_FOUND':\n      title = \"Chapters Not Available\";\n      description = \"The chapters for this book couldn't be loaded.\";\n      break;\n  }\n  \n  return (\n    <div className=\"container py-8 max-w-4xl\">\n      <Button\n        variant=\"ghost\"\n        onClick={onGoBack}\n        className=\"mb-6\"\n        data-testid=\"back-to-library\"\n      >\n        <ArrowLeft className=\"w-4 h-4 mr-2\" />\n        Back to Library\n      </Button>\n      \n      <div className=\"flex flex-col items-center justify-center min-h-[50vh] gap-6 p-4\">\n        {icon}\n        <div className=\"text-center max-w-md\">\n          <h2 className=\"text-2xl font-semibold mb-2\">{title}</h2>\n          <p className=\"text-muted-foreground\">{description}</p>\n        </div>\n        <div className=\"flex flex-col sm:flex-row gap-3\">\n          {canRetry && (\n            <Button\n              onClick={onRetry}\n              disabled={isRetrying}\n              data-testid=\"button-retry-book\"\n            >\n              {isRetrying ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Retrying...\n                </>\n              ) : (\n                <>\n                  <RefreshCw className=\"w-4 h-4 mr-2\" />\n                  Try Again\n                </>\n              )}\n            </Button>\n          )}\n          {cachedData && (\n            <Button\n              variant=\"outline\"\n              onClick={onUseCached}\n              data-testid=\"button-use-cached-book\"\n            >\n              <BookOpen className=\"w-4 h-4 mr-2\" />\n              Use Offline Data\n            </Button>\n          )}\n          <Button variant=\"outline\" onClick={onGoBack} data-testid=\"button-go-back\">\n            <ArrowLeft className=\"w-4 h-4 mr-2\" />\n            Back to Library\n          </Button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\nexport default function BookDetail() {\n  const [, params] = useRoute(\"/books/:slug\");\n  const [, setLocation] = useLocation();\n  const queryClient = useQueryClient();\n  const { toast } = useToast();\n  const slug = params?.slug || '';\n  \n  const [useCachedData, setUseCachedData] = useState(false);\n  const [cachedData, setCachedData] = useState<CachedBookData | null>(null);\n  const [isRefreshing, setIsRefreshing] = useState(false);\n  \n  useEffect(() => {\n    if (slug) {\n      const cached = getBookDetailCache(slug);\n      setCachedData(cached);\n    }\n  }, [slug]);\n\n  const { \n    data: book, \n    isLoading: bookLoading, \n    isError: bookError,\n    error: bookErrorData,\n    isFetching: bookFetching,\n    refetch: refetchBook\n  } = useQuery<Book, Error>({\n    queryKey: ['book', slug],\n    queryFn: () => fetchBook(slug),\n    enabled: !!slug && !useCachedData,\n    staleTime: 10 * 60 * 1000,\n    gcTime: 30 * 60 * 1000,\n    retry: (failureCount, error) => {\n      if (error.message === 'BOOK_NOT_FOUND') return false;\n      return failureCount < 2;\n    },\n    retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 5000),\n  });\n\n  const { \n    data: chapters = [], \n    isLoading: chaptersLoading,\n    isError: chaptersError,\n    error: chaptersErrorData,\n    isFetching: chaptersFetching,\n    refetch: refetchChapters\n  } = useQuery<Chapter[], Error>({\n    queryKey: ['chapters', book?.id],\n    queryFn: () => fetchChapters(book!.id),\n    enabled: !!book && !useCachedData,\n    staleTime: 10 * 60 * 1000,\n    gcTime: 30 * 60 * 1000,\n    retry: 2,\n    retryDelay: 1000,\n  });\n  \n  useEffect(() => {\n    if (book && chapters.length > 0 && slug && !useCachedData) {\n      setBookDetailCache(slug, book, chapters);\n    }\n  }, [book, chapters, slug, useCachedData]);\n  \n  const displayBook = useCachedData && cachedData ? cachedData.book : book;\n  const displayChapters = useCachedData && cachedData ? cachedData.chapters : chapters;\n  \n  const handleRetry = useCallback(() => {\n    setUseCachedData(false);\n    refetchBook();\n    if (book) {\n      refetchChapters();\n    }\n  }, [refetchBook, refetchChapters, book]);\n  \n  const handleUseCached = useCallback(() => {\n    if (cachedData) {\n      queryClient.setQueryData(['book', slug], cachedData.book);\n      queryClient.setQueryData(['chapters', cachedData.book.id], cachedData.chapters);\n      setUseCachedData(true);\n    }\n  }, [cachedData, queryClient, slug]);\n  \n  const handleGoBack = useCallback(() => {\n    setLocation('/books');\n  }, [setLocation]);\n  \n  const handleRefreshChapters = useCallback(async () => {\n    setIsRefreshing(true);\n    try {\n      const result = await refetchChapters();\n      if (result.data) {\n        toast({\n          title: \"Chapters Refreshed\",\n          description: `Successfully loaded ${result.data.length} chapters`,\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Refresh Failed\",\n        description: \"Could not refresh chapters. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsRefreshing(false);\n    }\n  }, [refetchChapters, toast]);\n\n  const isLoading = bookLoading || (book && chaptersLoading);\n  const hasError = (bookError || chaptersError) && !useCachedData;\n  const error = bookErrorData || chaptersErrorData;\n  const isFetching = bookFetching || chaptersFetching;\n\n  if (isLoading && !useCachedData) {\n    return <LoadingState />;\n  }\n\n  if (hasError && error) {\n    return (\n      <ErrorState\n        error={error}\n        onRetry={handleRetry}\n        isRetrying={isFetching}\n        onGoBack={handleGoBack}\n        cachedData={cachedData}\n        onUseCached={handleUseCached}\n      />\n    );\n  }\n\n  if (!displayBook) {\n    return (\n      <div className=\"container py-8 max-w-4xl\">\n        <Button\n          variant=\"ghost\"\n          onClick={handleGoBack}\n          className=\"mb-6\"\n          data-testid=\"back-to-library\"\n        >\n          <ArrowLeft className=\"w-4 h-4 mr-2\" />\n          Back to Library\n        </Button>\n        \n        <div className=\"flex flex-col items-center justify-center min-h-[50vh] gap-4\">\n          <BookOpen className=\"w-16 h-16 text-muted-foreground\" />\n          <h2 className=\"text-2xl font-semibold\">Book Not Found</h2>\n          <p className=\"text-muted-foreground text-center max-w-md\">\n            This book doesn't exist or may have been removed from the library.\n          </p>\n          <Button onClick={handleGoBack} data-testid=\"button-back-library\">\n            Return to Library\n          </Button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container py-8 max-w-4xl\">\n      <TooltipProvider>\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button\n              variant=\"ghost\"\n              onClick={handleGoBack}\n              className=\"mb-6\"\n              data-testid=\"back-to-library\"\n            >\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              Back to Library\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent>\n            <p>Return to the book collection</p>\n          </TooltipContent>\n        </Tooltip>\n      </TooltipProvider>\n\n      <div className=\"mb-8\">\n        <div className=\"flex items-start gap-4 mb-4\">\n          <TooltipProvider>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div className=\"p-4 rounded-lg bg-primary/10 cursor-help\">\n                  <BookOpen className=\"w-12 h-12 text-primary\" />\n                </div>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Classic literature for typing practice</p>\n              </TooltipContent>\n            </Tooltip>\n          </TooltipProvider>\n          <div className=\"flex-1\">\n            <div className=\"flex items-start justify-between gap-4\">\n              <div>\n                <div className=\"flex items-center gap-3 mb-2\">\n                  <h1 className=\"text-4xl font-bold\" data-testid=\"book-title\">{displayBook.title}</h1>\n                  <TooltipProvider>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Badge \n                          variant=\"outline\" \n                          className=\"bg-gradient-to-r from-violet-500/20 to-purple-500/20 border-violet-500/50 text-violet-400 font-semibold cursor-help\"\n                        >\n                          BETA\n                        </Badge>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p>This feature is in beta. We're actively improving it based on your feedback!</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </TooltipProvider>\n                </div>\n                <p className=\"text-xl text-muted-foreground mb-4\" data-testid=\"book-author\">by {displayBook.author}</p>\n              </div>\n              {useCachedData && (\n                <TooltipProvider>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <span className=\"text-xs px-2 py-1 rounded bg-yellow-500/20 text-yellow-600 dark:text-yellow-500 cursor-help\">\n                        Offline\n                      </span>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>Using locally cached data - some features may be limited</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </TooltipProvider>\n              )}\n            </div>\n            <div className=\"flex items-center gap-3 flex-wrap\">\n              <TooltipProvider>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <span className={`text-sm px-3 py-1 rounded-full cursor-help ${\n                      displayBook.difficulty === 'easy' ? 'bg-green-500/20 text-green-500' :\n                      displayBook.difficulty === 'medium' ? 'bg-yellow-500/20 text-yellow-500' :\n                      'bg-red-500/20 text-red-500'\n                    }`} data-testid=\"book-difficulty\">\n                      {displayBook.difficulty}\n                    </span>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>\n                      {displayBook.difficulty === 'easy' ? 'Beginner-friendly with simpler vocabulary' :\n                       displayBook.difficulty === 'medium' ? 'Moderate complexity for intermediate typists' :\n                       'Challenging text for advanced typists'}\n                    </p>\n                  </TooltipContent>\n                </Tooltip>\n              </TooltipProvider>\n              <TooltipProvider>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <span className=\"text-sm px-3 py-1 rounded-full bg-primary/20 text-primary capitalize cursor-help\" data-testid=\"book-topic\">\n                      {displayBook.topic}\n                    </span>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Book genre/category</p>\n                  </TooltipContent>\n                </Tooltip>\n              </TooltipProvider>\n              <TooltipProvider>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <span className=\"text-sm text-muted-foreground cursor-help\">{displayBook.totalChapters} chapters</span>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Total number of chapters in this book</p>\n                  </TooltipContent>\n                </Tooltip>\n              </TooltipProvider>\n              <TooltipProvider>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <span className=\"text-sm text-muted-foreground cursor-help\">{displayBook.totalParagraphs} paragraphs</span>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Total paragraphs available for typing practice</p>\n                  </TooltipContent>\n                </Tooltip>\n              </TooltipProvider>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div>\n        <div className=\"flex items-center justify-between mb-4\">\n          <h2 className=\"text-2xl font-semibold\">Chapters</h2>\n          {!useCachedData && (\n            <TooltipProvider>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <span className=\"inline-flex\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={handleRefreshChapters}\n                      disabled={isRefreshing}\n                      data-testid=\"button-refresh-chapters\"\n                    >\n                      {isRefreshing ? (\n                        <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                      ) : (\n                        <RefreshCw className=\"w-4 h-4 mr-2\" />\n                      )}\n                      {isRefreshing ? 'Refreshing...' : 'Refresh'}\n                    </Button>\n                  </span>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>{isRefreshing ? 'Fetching latest chapters...' : 'Reload chapter list from server'}</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n          )}\n        </div>\n        \n        {displayChapters.length === 0 ? (\n          <div className=\"text-center py-12\">\n            <FileText className=\"w-12 h-12 text-muted-foreground mx-auto mb-4\" />\n            <h3 className=\"text-lg font-semibold mb-2\">No Chapters Found</h3>\n            <p className=\"text-muted-foreground\">\n              This book's chapters are still being processed.\n            </p>\n            <Button\n              variant=\"outline\"\n              className=\"mt-4\"\n              onClick={handleRefreshChapters}\n              disabled={isRefreshing}\n              data-testid=\"button-retry-chapters\"\n            >\n              {isRefreshing ? (\n                <>\n                  <Loader2 className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Checking...\n                </>\n              ) : (\n                <>\n                  <RefreshCw className=\"w-4 h-4 mr-2\" />\n                  Check Again\n                </>\n              )}\n            </Button>\n          </div>\n        ) : (\n          <div className=\"space-y-3\">\n            {displayChapters.map((chapter) => (\n              <Card\n                key={`chapter-${displayBook.id}-${chapter.chapter}`}\n                className=\"group cursor-pointer hover:shadow-md transition-all hover:scale-[1.02] focus-within:ring-2 focus-within:ring-primary\"\n                onClick={() => setLocation(`/books/${slug}/chapter/${chapter.chapter}`)}\n                onKeyDown={(e) => {\n                  if (e.key === 'Enter' || e.key === ' ') {\n                    e.preventDefault();\n                    setLocation(`/books/${slug}/chapter/${chapter.chapter}`);\n                  }\n                }}\n                tabIndex={0}\n                role=\"button\"\n                aria-label={`Start typing Chapter ${chapter.chapter}${chapter.title ? `: ${chapter.title}` : ''}`}\n                data-testid={`chapter-card-${chapter.chapter}`}\n              >\n                <div className=\"p-4 flex items-center gap-4\">\n                  <div className=\"p-3 rounded-lg bg-primary/10 group-hover:bg-primary/20 transition-colors\">\n                    <FileText className=\"w-5 h-5 text-primary\" />\n                  </div>\n                  <div className=\"flex-1 min-w-0\">\n                    <h3 className=\"font-semibold\" data-testid={`chapter-title-${chapter.chapter}`}>\n                      Chapter {chapter.chapter}\n                      {chapter.title && `: ${chapter.title}`}\n                    </h3>\n                    <p className=\"text-sm text-muted-foreground\">\n                      {chapter.paragraphCount} paragraph{chapter.paragraphCount !== 1 ? 's' : ''}\n                    </p>\n                  </div>\n                  <TooltipProvider>\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Button \n                          variant=\"ghost\" \n                          size=\"sm\"\n                          className=\"group-hover:bg-primary/10\"\n                          data-testid={`start-chapter-${chapter.chapter}`}\n                        >\n                          Start Typing\n                          <ChevronRight className=\"w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform\" />\n                        </Button>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p>Begin typing practice for this chapter</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </TooltipProvider>\n                </div>\n              </Card>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":22997,"size_tokens":null},"client/src/components/ShareModal.tsx":{"content":"import { useState } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { useToast } from '@/hooks/use-toast';\nimport { Share2, Twitter, Facebook, MessageCircle, Copy, Check } from 'lucide-react';\n\ninterface ShareModalProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  mode: string;\n  resultId: number | null;\n  isAnonymous?: boolean;\n  // Display stats (for preview only, not sent to server)\n  stats?: {\n    wpm: number;\n    accuracy: number;\n    errors: number;\n  };\n}\n\nexport function ShareModal({ \n  open, \n  onOpenChange, \n  mode,\n  resultId,\n  isAnonymous = false,\n  stats\n}: ShareModalProps) {\n  const [shareUrl, setShareUrl] = useState<string>('');\n  const [isCreating, setIsCreating] = useState(false);\n  const [copied, setCopied] = useState(false);\n  const { toast } = useToast();\n\n  const createShare = async () => {\n    if (!resultId) {\n      toast({\n        title: 'Error',\n        description: 'No result to share',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    try {\n      setIsCreating(true);\n      \n      const response = await fetch('/api/share', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify({\n          mode,\n          resultId,\n          isAnonymous\n        }),\n      });\n\n      if (!response.ok) {\n        const errorData = await response.json();\n        throw new Error(errorData.message || 'Failed to create share');\n      }\n\n      const data = await response.json();\n      setShareUrl(data.shareUrl);\n      \n      toast({\n        title: 'Share link created!',\n        description: 'Your result is ready to share',\n      });\n    } catch (error: any) {\n      console.error('Create share error:', error);\n      toast({\n        title: 'Error',\n        description: error.message || 'Failed to create share link',\n        variant: 'destructive',\n      });\n    } finally {\n      setIsCreating(false);\n    }\n  };\n\n  const handleCopy = async () => {\n    if (!shareUrl) return;\n    \n    try {\n      await navigator.clipboard.writeText(shareUrl);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n      \n      toast({\n        title: 'Copied!',\n        description: 'Link copied to clipboard',\n      });\n    } catch (error) {\n      console.error('Copy error:', error);\n      toast({\n        title: 'Error',\n        description: 'Failed to copy link',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  const shareToTwitter = () => {\n    if (!shareUrl || !stats) return;\n    \n    const text = `I just scored ${stats.wpm} WPM with ${stats.accuracy}% accuracy on TypeMasterAI! Can you beat me? ðŸš€`;\n    const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(shareUrl)}`;\n    window.open(url, '_blank', 'width=550,height=420');\n  };\n\n  const shareToFacebook = () => {\n    if (!shareUrl) return;\n    \n    const url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;\n    window.open(url, '_blank', 'width=550,height=420');\n  };\n\n  const shareToWhatsApp = () => {\n    if (!shareUrl || !stats) return;\n    \n    const text = `I just scored ${stats.wpm} WPM with ${stats.accuracy}% accuracy on TypeMasterAI! Can you beat me? ${shareUrl}`;\n    const url = `https://wa.me/?text=${encodeURIComponent(text)}`;\n    window.open(url, '_blank');\n  };\n\n  const handleNativeShare = async () => {\n    if (!shareUrl || !stats) return;\n    \n    if (navigator.share) {\n      try {\n        await navigator.share({\n          title: 'TypeMasterAI - My Typing Result',\n          text: `I just scored ${stats.wpm} WPM with ${stats.accuracy}% accuracy!`,\n          url: shareUrl,\n        });\n      } catch (error) {\n        console.error('Native share error:', error);\n      }\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Share2 className=\"w-5 h-5\" />\n            Share Your Result\n          </DialogTitle>\n          <DialogDescription>\n            Share your typing achievement with friends and challenge them to beat your score!\n          </DialogDescription>\n        </DialogHeader>\n\n        <div className=\"space-y-4\">\n          {!shareUrl ? (\n            <div className=\"text-center py-6\">\n              {stats && (\n                <div className=\"mb-4\">\n                  <div className=\"text-4xl font-bold text-primary mb-2\">{stats.wpm} WPM</div>\n                  <div className=\"text-sm text-muted-foreground\">\n                    {stats.accuracy}% accuracy â€¢ {stats.errors} errors\n                  </div>\n                  <div className=\"text-xs text-muted-foreground mt-1\">\n                    Mode: {mode}\n                  </div>\n                </div>\n              )}\n              \n              <Button \n                onClick={createShare} \n                disabled={isCreating || !resultId}\n                size=\"lg\"\n                className=\"w-full\"\n                data-testid=\"button-create-share\"\n              >\n                {isCreating ? 'Creating...' : 'Create Share Link'}\n              </Button>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center gap-2\">\n                <Input \n                  value={shareUrl} \n                  readOnly\n                  className=\"flex-1\"\n                  data-testid=\"input-share-url\"\n                />\n                <Button\n                  onClick={handleCopy}\n                  variant=\"outline\"\n                  size=\"icon\"\n                  data-testid=\"button-copy-link\"\n                >\n                  {copied ? <Check className=\"w-4 h-4\" /> : <Copy className=\"w-4 h-4\" />}\n                </Button>\n              </div>\n\n              <div className=\"grid grid-cols-3 gap-2\">\n                <Button\n                  onClick={shareToTwitter}\n                  variant=\"outline\"\n                  className=\"w-full\"\n                  data-testid=\"button-share-twitter\"\n                >\n                  <Twitter className=\"w-4 h-4 mr-2\" />\n                  Twitter\n                </Button>\n                <Button\n                  onClick={shareToFacebook}\n                  variant=\"outline\"\n                  className=\"w-full\"\n                  data-testid=\"button-share-facebook\"\n                >\n                  <Facebook className=\"w-4 h-4 mr-2\" />\n                  Facebook\n                </Button>\n                <Button\n                  onClick={shareToWhatsApp}\n                  variant=\"outline\"\n                  className=\"w-full\"\n                  data-testid=\"button-share-whatsapp\"\n                >\n                  <MessageCircle className=\"w-4 h-4 mr-2\" />\n                  WhatsApp\n                </Button>\n              </div>\n\n              {'share' in navigator && (\n                <Button\n                  onClick={handleNativeShare}\n                  variant=\"secondary\"\n                  className=\"w-full\"\n                  data-testid=\"button-share-native\"\n                >\n                  <Share2 className=\"w-4 h-4 mr-2\" />\n                  Share via...\n                </Button>\n              )}\n            </div>\n          )}\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":7584,"size_tokens":null},"client/src/pages/dictation-test.tsx":{"content":"import { useState, useEffect, useRef, useCallback, useMemo } from 'react';\nimport { Link } from 'wouter';\nimport { ArrowLeft, Volume2, RotateCcw, Eye, EyeOff, Check, ChevronRight, Mic, Share2, HelpCircle, Flame, Trophy, Target, Zap, Clock, History, TrendingUp, Award, Sparkles, AlertCircle, Lightbulb, X, ChevronDown, ChevronUp, BarChart3, Bookmark, BookmarkCheck, Calendar, Star, Settings2, Maximize2, Minimize2, Leaf, Waves, Sun, Moon } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';\nimport { Progress } from '@/components/ui/progress';\nimport { Badge } from '@/components/ui/badge';\nimport { Slider } from '@/components/ui/slider';\nimport { useSpeechSynthesis } from '@/hooks/useSpeechSynthesis';\nimport { calculateDictationAccuracy, calculateDictationWPM, getSpeedRate, getSpeedLevelName, getAccuracyGrade, type CharacterDiff, type WordDiff } from '@shared/dictation-utils';\nimport { useToast } from '@/hooks/use-toast';\nimport { useMutation, useQuery } from '@tanstack/react-query';\nimport type { DictationSentence } from '@shared/schema';\nimport { ShareModal } from '@/components/ShareModal';\nimport { DictationCertificate } from '@/components/DictationCertificate';\nimport { useCreateCertificate } from '@/hooks/useCertificates';\nimport { useAuth } from '@/lib/auth-context';\n\ntype PracticeMode = 'quick' | 'focus' | 'challenge';\n\ninterface PracticeModeConfig {\n  name: string;\n  description: string;\n  icon: React.ReactNode;\n  autoAdvance: boolean;\n  hintsAllowed: boolean;\n  timerPressure: boolean;\n  defaultSpeed: string;\n  defaultDifficulty: string;\n}\n\nconst PRACTICE_MODES: Record<PracticeMode, PracticeModeConfig> = {\n  quick: {\n    name: 'Quick Practice',\n    description: 'Fast-paced practice sessions',\n    icon: <Zap className=\"w-5 h-5\" />,\n    autoAdvance: false,\n    hintsAllowed: true,\n    timerPressure: false,\n    defaultSpeed: '1.0',\n    defaultDifficulty: 'easy',\n  },\n  focus: {\n    name: 'Focus Mode',\n    description: 'Zen fullscreen with calming themes & encouragement',\n    icon: <Target className=\"w-5 h-5\" />,\n    autoAdvance: false,\n    hintsAllowed: true,\n    timerPressure: false,\n    defaultSpeed: '0.8',\n    defaultDifficulty: 'easy',\n  },\n  challenge: {\n    name: 'Challenge Mode',\n    description: 'No hints, harder difficulty, prove your skills',\n    icon: <Trophy className=\"w-5 h-5\" />,\n    autoAdvance: false,\n    hintsAllowed: false,\n    timerPressure: true,\n    defaultSpeed: '1.3',\n    defaultDifficulty: 'easy',\n  },\n};\n\ntype ZenTheme = 'ocean' | 'forest' | 'sunset' | 'night';\n\ninterface ZenThemeConfig {\n  name: string;\n  icon: React.ReactNode;\n  gradient: string;\n  textColor: string;\n  accentColor: string;\n  inputBg: string;\n  buttonBg: string;\n}\n\nconst ZEN_THEMES: Record<ZenTheme, ZenThemeConfig> = {\n  ocean: {\n    name: 'Ocean Calm',\n    icon: <Waves className=\"w-4 h-4\" />,\n    gradient: 'linear-gradient(135deg, #1a365d 0%, #2c5282 30%, #2b6cb0 60%, #3182ce 100%)',\n    textColor: '#e2e8f0',\n    accentColor: '#63b3ed',\n    inputBg: 'rgba(255, 255, 255, 0.1)',\n    buttonBg: 'rgba(99, 179, 237, 0.3)',\n  },\n  forest: {\n    name: 'Forest Peace',\n    icon: <Leaf className=\"w-4 h-4\" />,\n    gradient: 'linear-gradient(135deg, #1a4731 0%, #22543d 30%, #276749 60%, #2f855a 100%)',\n    textColor: '#e2e8f0',\n    accentColor: '#68d391',\n    inputBg: 'rgba(255, 255, 255, 0.1)',\n    buttonBg: 'rgba(104, 211, 145, 0.3)',\n  },\n  sunset: {\n    name: 'Sunset Glow',\n    icon: <Sun className=\"w-4 h-4\" />,\n    gradient: 'linear-gradient(135deg, #744210 0%, #c05621 30%, #dd6b20 60%, #ed8936 100%)',\n    textColor: '#fffaf0',\n    accentColor: '#fbd38d',\n    inputBg: 'rgba(255, 255, 255, 0.1)',\n    buttonBg: 'rgba(251, 211, 141, 0.3)',\n  },\n  night: {\n    name: 'Night Sky',\n    icon: <Moon className=\"w-4 h-4\" />,\n    gradient: 'linear-gradient(135deg, #1a202c 0%, #2d3748 30%, #4a5568 60%, #718096 100%)',\n    textColor: '#e2e8f0',\n    accentColor: '#a0aec0',\n    inputBg: 'rgba(255, 255, 255, 0.08)',\n    buttonBg: 'rgba(160, 174, 192, 0.3)',\n  },\n};\n\nconst MINDFUL_ENCOURAGEMENTS = [\n  { message: \"Breathe deeply. You're doing great.\", type: 'calm' },\n  { message: \"Every word typed is progress made.\", type: 'progress' },\n  { message: \"Stay present. Stay focused.\", type: 'focus' },\n  { message: \"You're in the flow. Keep going.\", type: 'flow' },\n  { message: \"Patience brings perfection.\", type: 'patience' },\n  { message: \"Your focus is your superpower.\", type: 'encouragement' },\n  { message: \"One sentence at a time. You've got this.\", type: 'calm' },\n  { message: \"Listen. Type. Succeed.\", type: 'simple' },\n  { message: \"Each attempt makes you stronger.\", type: 'growth' },\n  { message: \"Embrace the calm. Master the words.\", type: 'zen' },\n  { message: \"Your concentration is impressive.\", type: 'praise' },\n  { message: \"Steady hands, steady mind.\", type: 'focus' },\n  { message: \"Beautiful focus. Beautiful typing.\", type: 'encouragement' },\n  { message: \"You're building something great.\", type: 'progress' },\n  { message: \"The journey of mastery continues.\", type: 'growth' },\n];\n\nfunction getRandomEncouragement(): string {\n  return MINDFUL_ENCOURAGEMENTS[Math.floor(Math.random() * MINDFUL_ENCOURAGEMENTS.length)].message;\n}\n\ninterface ErrorCategory {\n  type: 'spelling' | 'punctuation' | 'capitalization' | 'missing' | 'extra' | 'word_order';\n  count: number;\n  examples: string[];\n}\n\ninterface SessionHistoryItem {\n  sentence: string;\n  typedText: string;\n  accuracy: number;\n  wpm: number;\n  errors: number;\n  timestamp: number;\n  errorCategories: ErrorCategory[];\n}\n\ninterface CoachingTip {\n  type: 'encouragement' | 'improvement' | 'warning' | 'achievement';\n  message: string;\n  icon: React.ReactNode;\n}\n\ninterface Achievement {\n  id: string;\n  name: string;\n  description: string;\n  icon: React.ReactNode;\n  unlocked: boolean;\n  progress?: number;\n  target?: number;\n}\n\ninterface DictationTestState {\n  sentence: DictationSentence | null;\n  typedText: string;\n  startTime: number | null;\n  endTime: number | null;\n  replayCount: number;\n  hintShown: boolean;\n  showHint: boolean;\n  isComplete: boolean;\n  result: {\n    accuracy: number;\n    wpm: number;\n    errors: number;\n    duration: number;\n    characterDiff: CharacterDiff[];\n    wordDiff: WordDiff[];\n    correctChars: number;\n    totalChars: number;\n    correctWords: number;\n    totalWords: number;\n  } | null;\n}\n\nconst SESSION_LENGTH_OPTIONS = [\n  { value: 3, label: '3 sentences (Warm-up)' },\n  { value: 5, label: '5 sentences (Quick)' },\n  { value: 10, label: '10 sentences (Standard)' },\n  { value: 15, label: '15 sentences (Extended)' },\n  { value: 20, label: '20 sentences (Long)' },\n  { value: 25, label: '25 sentences (Marathon)' },\n  { value: 30, label: '30 sentences (Endurance)' },\n  { value: 50, label: '50 sentences (Challenge)' },\n  { value: 75, label: '75 sentences (Ultra)' },\n  { value: 100, label: '100 sentences (Master)' },\n  { value: 0, label: 'Custom...' },\n];\n\nconst CATEGORIES = [\n  { value: 'all', label: 'All Topics' },\n  { value: 'general', label: 'General' },\n  { value: 'business', label: 'Business' },\n  { value: 'technology', label: 'Technology' },\n  { value: 'science', label: 'Science' },\n  { value: 'culture', label: 'Culture' },\n  { value: 'environment', label: 'Environment' },\n  { value: 'health', label: 'Health' },\n  { value: 'entertainment', label: 'Entertainment' },\n  { value: 'education', label: 'Education' },\n];\n\ninterface StreakData {\n  currentStreak: number;\n  longestStreak: number;\n  lastPracticeDate: string;\n  totalSessions: number;\n}\n\ninterface AdaptiveDifficultyConfig {\n  enabled: boolean;\n  currentLevel: 'easy' | 'medium' | 'hard';\n  consecutiveHighScores: number;\n  consecutiveLowScores: number;\n  recentScores: { accuracy: number; wpm: number }[];\n}\n\nconst ADAPTIVE_THRESHOLDS = {\n  upgradeAccuracy: 90,\n  upgradeWpm: 30,\n  upgradeConsecutive: 3,\n  downgradeAccuracy: 70,\n  downgradeConsecutive: 2,\n  maxRecentScores: 5,\n};\n\nconst DIFFICULTY_ORDER: ('easy' | 'medium' | 'hard')[] = ['easy', 'medium', 'hard'];\n\nfunction getNextDifficulty(current: 'easy' | 'medium' | 'hard', direction: 'up' | 'down'): 'easy' | 'medium' | 'hard' {\n  const currentIndex = DIFFICULTY_ORDER.indexOf(current);\n  if (direction === 'up') {\n    return DIFFICULTY_ORDER[Math.min(currentIndex + 1, DIFFICULTY_ORDER.length - 1)];\n  } else {\n    return DIFFICULTY_ORDER[Math.max(currentIndex - 1, 0)];\n  }\n}\n\nfunction getDifficultyEmoji(difficulty: string): string {\n  switch (difficulty) {\n    case 'easy': return 'ðŸŸ¢';\n    case 'medium': return 'ðŸŸ¡';\n    case 'hard': return 'ðŸ”´';\n    default: return '';\n  }\n}\n\ninterface BookmarkedSentence {\n  id: number;\n  sentence: string;\n  category: string;\n  difficulty: string;\n  bookmarkedAt: number;\n  lastAccuracy?: number;\n}\n\nconst STREAK_STORAGE_KEY = 'dictation_streak';\nconst BOOKMARKS_STORAGE_KEY = 'dictation_bookmarks';\nconst VOICE_STORAGE_KEY = 'dictation_voice';\n\nfunction getStreakData(): StreakData {\n  try {\n    const stored = localStorage.getItem(STREAK_STORAGE_KEY);\n    if (stored) {\n      return JSON.parse(stored);\n    }\n  } catch (e) {\n    console.error('Failed to parse streak data:', e);\n  }\n  return { currentStreak: 0, longestStreak: 0, lastPracticeDate: '', totalSessions: 0 };\n}\n\nfunction updateStreak(): StreakData {\n  const data = getStreakData();\n  const today = new Date().toISOString().split('T')[0];\n  const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];\n  \n  let newStreak = data.currentStreak;\n  \n  if (data.lastPracticeDate !== today) {\n    if (data.lastPracticeDate === yesterday) {\n      newStreak = data.currentStreak + 1;\n    } else {\n      newStreak = 1;\n    }\n  }\n  \n  const newData: StreakData = {\n    currentStreak: newStreak,\n    longestStreak: Math.max(data.longestStreak, newStreak),\n    lastPracticeDate: today,\n    totalSessions: data.totalSessions + 1,\n  };\n  \n  localStorage.setItem(STREAK_STORAGE_KEY, JSON.stringify(newData));\n  return newData;\n}\n\nfunction getSavedVoice(): string | null {\n  try {\n    return localStorage.getItem(VOICE_STORAGE_KEY);\n  } catch (e) {\n    return null;\n  }\n}\n\nfunction saveVoiceSelection(voiceURI: string): void {\n  try {\n    localStorage.setItem(VOICE_STORAGE_KEY, voiceURI);\n  } catch (e) {\n    console.error('Failed to save voice selection:', e);\n  }\n}\n\nfunction getBookmarks(): BookmarkedSentence[] {\n  try {\n    const stored = localStorage.getItem(BOOKMARKS_STORAGE_KEY);\n    if (stored) {\n      return JSON.parse(stored);\n    }\n  } catch (e) {\n    console.error('Failed to parse bookmarks:', e);\n  }\n  return [];\n}\n\nfunction saveBookmark(sentence: BookmarkedSentence): BookmarkedSentence[] {\n  const bookmarks = getBookmarks();\n  const existing = bookmarks.findIndex(b => b.id === sentence.id);\n  if (existing >= 0) {\n    bookmarks[existing] = sentence;\n  } else {\n    bookmarks.push(sentence);\n  }\n  localStorage.setItem(BOOKMARKS_STORAGE_KEY, JSON.stringify(bookmarks));\n  return bookmarks;\n}\n\nfunction removeBookmark(id: number): BookmarkedSentence[] {\n  const bookmarks = getBookmarks().filter(b => b.id !== id);\n  localStorage.setItem(BOOKMARKS_STORAGE_KEY, JSON.stringify(bookmarks));\n  return bookmarks;\n}\n\nfunction isBookmarked(id: number): boolean {\n  return getBookmarks().some(b => b.id === id);\n}\n\nfunction categorizeErrors(characterDiff: CharacterDiff[]): ErrorCategory[] {\n  const categories: Map<string, ErrorCategory> = new Map();\n  \n  const addError = (type: ErrorCategory['type'], example: string) => {\n    const existing = categories.get(type);\n    if (existing) {\n      existing.count++;\n      if (existing.examples.length < 3) existing.examples.push(example);\n    } else {\n      categories.set(type, { type, count: 1, examples: [example] });\n    }\n  };\n  \n  for (const diff of characterDiff) {\n    if (diff.status === 'incorrect') {\n      const origChar = diff.char;\n      const typedChar = diff.typedChar || '';\n      \n      if (/[.,!?;:'\"-]/.test(origChar) || /[.,!?;:'\"-]/.test(typedChar)) {\n        addError('punctuation', `'${origChar}' â†’ '${typedChar}'`);\n      } else if (origChar.toLowerCase() === typedChar.toLowerCase()) {\n        addError('capitalization', `'${origChar}' â†’ '${typedChar}'`);\n      } else {\n        addError('spelling', `'${origChar}' â†’ '${typedChar}'`);\n      }\n    } else if (diff.status === 'missing') {\n      addError('missing', `'${diff.char}' missing`);\n    } else if (diff.status === 'extra') {\n      addError('extra', `extra '${diff.char}'`);\n    }\n  }\n\n  return Array.from(categories.values()).sort((a, b) => b.count - a.count);\n}\n\nfunction generateCoachingTip(\n  accuracy: number,\n  wpm: number,\n  errorCategories: ErrorCategory[],\n  sessionStats: { count: number; totalAccuracy: number; totalWpm: number },\n  hintUsed: boolean,\n  replayCount: number\n): CoachingTip {\n  if (accuracy >= 100) {\n    return {\n      type: 'achievement',\n      message: 'Perfect transcription! You have excellent listening skills.',\n      icon: <Sparkles className=\"w-5 h-5 text-yellow-500\" />,\n    };\n  }\n  \n  if (accuracy >= 95) {\n    return {\n      type: 'encouragement',\n      message: 'Excellent work! Just minor adjustments needed.',\n      icon: <Award className=\"w-5 h-5 text-green-500\" />,\n    };\n  }\n\n  if (errorCategories.length > 0) {\n    const topError = errorCategories[0];\n    const tips: Record<string, string> = {\n      spelling: 'Focus on letter accuracy. Try listening more carefully to each word.',\n      punctuation: 'Pay attention to pauses and tone changes for punctuation cues.',\n      capitalization: 'Listen for sentence beginnings and proper nouns for capitals.',\n      missing: 'Slow down and make sure you catch every word.',\n      extra: 'Double-check before submitting - you may be adding extra characters.',\n      word_order: 'Listen to the sentence flow and word sequence carefully.',\n    };\n\n    return {\n      type: 'improvement',\n      message: tips[topError.type] || 'Keep practicing to improve!',\n      icon: <Lightbulb className=\"w-5 h-5 text-blue-500\" />,\n    };\n  }\n\n  if (hintUsed) {\n    return {\n      type: 'improvement',\n      message: 'Try completing the next sentence without using hints!',\n      icon: <Target className=\"w-5 h-5 text-orange-500\" />,\n    };\n  }\n\n  if (replayCount > 2) {\n    return {\n      type: 'improvement',\n      message: 'Challenge yourself to use fewer replays next time.',\n      icon: <TrendingUp className=\"w-5 h-5 text-purple-500\" />,\n    };\n  }\n\n  return {\n    type: 'encouragement',\n    message: 'Good effort! Keep practicing to build your skills.',\n    icon: <Flame className=\"w-5 h-5 text-orange-500\" />,\n  };\n}\n\nfunction calculateAchievements(\n  sessionStats: { count: number; totalAccuracy: number; totalWpm: number; totalErrors: number },\n  sessionHistory: SessionHistoryItem[]\n): Achievement[] {\n  const avgAccuracy = sessionStats.count > 0 ? sessionStats.totalAccuracy / sessionStats.count : 0;\n  const avgWpm = sessionStats.count > 0 ? sessionStats.totalWpm / sessionStats.count : 0;\n  const perfectCount = sessionHistory.filter(h => h.accuracy === 100).length;\n\n  return [\n    {\n      id: 'speed_demon',\n      name: 'Speed Demon',\n      description: 'Average 50+ WPM in a session',\n      icon: <Zap className=\"w-4 h-4\" />,\n      unlocked: avgWpm >= 50,\n      progress: Math.min(avgWpm, 50),\n      target: 50,\n    },\n    {\n      id: 'perfectionist',\n      name: 'Perfectionist',\n      description: 'Get 3 perfect scores in one session',\n      icon: <Trophy className=\"w-4 h-4\" />,\n      unlocked: perfectCount >= 3,\n      progress: perfectCount,\n      target: 3,\n    },\n    {\n      id: 'accuracy_ace',\n      name: 'Accuracy Ace',\n      description: 'Maintain 95%+ average accuracy',\n      icon: <Target className=\"w-4 h-4\" />,\n      unlocked: avgAccuracy >= 95 && sessionStats.count >= 3,\n      progress: Math.min(avgAccuracy, 95),\n      target: 95,\n    },\n    {\n      id: 'marathon',\n      name: 'Marathon Runner',\n      description: 'Complete 10+ sentences in one session',\n      icon: <Flame className=\"w-4 h-4\" />,\n      unlocked: sessionStats.count >= 10,\n      progress: sessionStats.count,\n      target: 10,\n    },\n  ];\n}\n\nexport default function DictationTest() {\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const createCertificateMutation = useCreateCertificate();\n  const [showCertificate, setShowCertificate] = useState(false);\n  const [certificateData, setCertificateData] = useState<any>(null);\n  const [practiceMode, setPracticeMode] = useState<PracticeMode>('quick');\n  const [showModeSelector, setShowModeSelector] = useState(true);\n  const [difficulty, setDifficulty] = useState<string>('easy');\n  const [speedLevel, setSpeedLevel] = useState<string>('1.0');\n  const [category, setCategory] = useState<string>('all');\n  const [sessionLength, setSessionLength] = useState<number>(5);\n  const [showCustomLength, setShowCustomLength] = useState(false);\n  const [customLengthInput, setCustomLengthInput] = useState<string>('');\n  const [sessionHistory, setSessionHistory] = useState<SessionHistoryItem[]>([]);\n  const [showHistory, setShowHistory] = useState(false);\n  const [showAnalytics, setShowAnalytics] = useState(false);\n  const [currentCoachingTip, setCurrentCoachingTip] = useState<CoachingTip | null>(null);\n  const [testState, setTestState] = useState<DictationTestState>({\n    sentence: null,\n    typedText: '',\n    startTime: null,\n    endTime: null,\n    replayCount: 0,\n    hintShown: false,\n    showHint: false,\n    isComplete: false,\n    result: null,\n  });\n  const [sessionProgress, setSessionProgress] = useState(0);\n  const [sessionComplete, setSessionComplete] = useState(false);\n  const [sessionStats, setSessionStats] = useState<{\n    totalWpm: number;\n    totalAccuracy: number;\n    totalErrors: number;\n    count: number;\n  }>({\n    totalWpm: 0,\n    totalAccuracy: 0,\n    totalErrors: 0,\n    count: 0,\n  });\n  const inputRef = useRef<HTMLTextAreaElement>(null);\n  \n  const [showKeyboardGuide, setShowKeyboardGuide] = useState(false);\n  const [showShareModal, setShowShareModal] = useState(false);\n  const [lastTestResultId, setLastTestResultId] = useState<number | null>(null);\n  const [autoAdvanceCountdown, setAutoAdvanceCountdown] = useState<number | null>(null);\n  const [elapsedTime, setElapsedTime] = useState<number>(0);\n  const countdownIntervalRef = useRef<NodeJS.Timeout | null>(null);\n  const elapsedIntervalRef = useRef<NodeJS.Timeout | null>(null);\n  \n  const [streakData, setStreakData] = useState<StreakData>(() => getStreakData());\n  const [bookmarks, setBookmarks] = useState<BookmarkedSentence[]>(() => getBookmarks());\n  const [showBookmarks, setShowBookmarks] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  const [isWaitingToStart, setIsWaitingToStart] = useState(false);\n  \n  const [adaptiveDifficulty, setAdaptiveDifficulty] = useState<AdaptiveDifficultyConfig>({\n    enabled: false,\n    currentLevel: 'easy',\n    consecutiveHighScores: 0,\n    consecutiveLowScores: 0,\n    recentScores: [],\n  });\n  const [difficultyJustChanged, setDifficultyJustChanged] = useState<{\n    from: string;\n    to: string;\n    direction: 'up' | 'down';\n  } | null>(null);\n  \n  const [shownSentenceIds, setShownSentenceIds] = useState<number[]>([]);\n  \n  const [isZenMode, setIsZenMode] = useState(false);\n  const [zenTheme, setZenTheme] = useState<ZenTheme>('ocean');\n  const [showEscHint, setShowEscHint] = useState(true);\n  const [currentEncouragement, setCurrentEncouragement] = useState<string>('');\n  const zenContainerRef = useRef<HTMLDivElement>(null);\n  \n\n  useEffect(() => {\n    if (difficultyJustChanged) {\n      const timer = setTimeout(() => {\n        setDifficultyJustChanged(null);\n      }, 5000);\n      return () => clearTimeout(timer);\n    }\n  }, [difficultyJustChanged]);\n\n  useEffect(() => {\n    if (isZenMode && showEscHint) {\n      const timer = setTimeout(() => {\n        setShowEscHint(false);\n      }, 3000);\n      return () => clearTimeout(timer);\n    }\n  }, [isZenMode, showEscHint]);\n\n  useEffect(() => {\n    if (isZenMode) {\n      const handleEscKey = (e: KeyboardEvent) => {\n        if (e.key === 'Escape') {\n          exitZenMode();\n        }\n      };\n      document.addEventListener('keydown', handleEscKey);\n      return () => document.removeEventListener('keydown', handleEscKey);\n    }\n  }, [isZenMode]);\n\n  useEffect(() => {\n    if (testState.isComplete && practiceMode === 'focus') {\n      setCurrentEncouragement(getRandomEncouragement());\n    }\n  }, [testState.isComplete, practiceMode]);\n\n  const enterZenMode = useCallback(() => {\n    setIsZenMode(true);\n    setShowEscHint(true);\n  }, []);\n\n  useEffect(() => {\n    if (isZenMode && zenContainerRef.current && document.fullscreenEnabled) {\n      zenContainerRef.current.requestFullscreen?.().catch(() => {});\n    }\n  }, [isZenMode]);\n\n  const exitZenMode = useCallback(() => {\n    setIsZenMode(false);\n    if (document.fullscreenElement) {\n      document.exitFullscreen?.().catch(() => {});\n    }\n  }, []);\n\n  useEffect(() => {\n    const handleFullscreenChange = () => {\n      if (!document.fullscreenElement && isZenMode) {\n        setIsZenMode(false);\n      }\n    };\n    document.addEventListener('fullscreenchange', handleFullscreenChange);\n    return () => document.removeEventListener('fullscreenchange', handleFullscreenChange);\n  }, [isZenMode]);\n  \n  const currentRate = getSpeedRate(speedLevel);\n  const { \n    speak, cancel, isSpeaking, isSupported, error: speechError, \n    voices, setVoice, currentVoice,\n    isUsingOpenAI, setUseOpenAI, openAIVoices, setOpenAIVoice, currentOpenAIVoice \n  } = useSpeechSynthesis({\n    rate: currentRate,\n    lang: 'en-US',\n  });\n\n  const englishVoices = voices.filter(v => v.lang.startsWith('en'));\n\n  const handleVoiceChange = (voiceUri: string) => {\n    const selectedVoice = voices.find(v => v.voiceURI === voiceUri);\n    if (selectedVoice) {\n      setVoice(selectedVoice);\n      saveVoiceSelection(voiceUri);\n    }\n  };\n\n  useEffect(() => {\n    if (voices.length > 0) {\n      const savedVoiceURI = getSavedVoice();\n      if (savedVoiceURI) {\n        const savedVoice = voices.find(v => v.voiceURI === savedVoiceURI);\n        if (savedVoice) {\n          setVoice(savedVoice);\n        }\n      }\n    }\n  }, [voices, setVoice]);\n\n  const handleSessionLengthChange = (value: string) => {\n    const numValue = parseInt(value);\n    if (numValue === 0) {\n      setShowCustomLength(true);\n    } else {\n      setSessionLength(numValue);\n      setShowCustomLength(false);\n    }\n  };\n\n  const handleCustomLengthSubmit = () => {\n    const value = parseInt(customLengthInput);\n    if (value >= 1 && value <= 500) {\n      setSessionLength(value);\n      setShowCustomLength(false);\n      setCustomLengthInput('');\n    } else {\n      toast({\n        title: 'Invalid session length',\n        description: 'Please enter a number between 1 and 500',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  const toggleBookmark = useCallback(() => {\n    if (!testState.sentence) return;\n    \n    const sentenceId = testState.sentence.id;\n    const isCurrentlyBookmarked = bookmarks.some(b => b.id === sentenceId);\n    \n    if (isCurrentlyBookmarked) {\n      const newBookmarks = removeBookmark(sentenceId);\n      setBookmarks(newBookmarks);\n      toast({\n        title: 'Bookmark removed',\n        description: 'Sentence removed from your bookmarks',\n      });\n    } else {\n      const newBookmark: BookmarkedSentence = {\n        id: sentenceId,\n        sentence: testState.sentence.sentence,\n        category: testState.sentence.category || 'general',\n        difficulty: testState.sentence.difficulty,\n        bookmarkedAt: Date.now(),\n        lastAccuracy: testState.result?.accuracy,\n      };\n      const newBookmarks = saveBookmark(newBookmark);\n      setBookmarks(newBookmarks);\n      toast({\n        title: 'Sentence bookmarked',\n        description: 'Added to your practice list for later review',\n      });\n    }\n  }, [testState.sentence, testState.result, bookmarks, toast]);\n\n  const practiceBookmarkedSentence = useCallback((bookmark: BookmarkedSentence) => {\n    const words = bookmark.sentence.split(/\\s+/).length;\n    setTestState({\n      sentence: {\n        id: bookmark.id,\n        sentence: bookmark.sentence,\n        difficulty: bookmark.difficulty,\n        category: bookmark.category,\n        wordCount: words,\n        characterCount: bookmark.sentence.length,\n        createdAt: new Date(),\n      },\n      typedText: '',\n      startTime: null,\n      endTime: null,\n      replayCount: 0,\n      hintShown: false,\n      showHint: false,\n      isComplete: false,\n      result: null,\n    });\n    setShowBookmarks(false);\n    setTimeout(() => {\n      speak(bookmark.sentence);\n    }, 500);\n  }, [speak]);\n\n  const [isLoading, setIsLoading] = useState(false);\n  \n  const fetchNewSentence = useCallback(async () => {\n    setIsLoading(true);\n    try {\n      const categoryParam = category !== 'all' ? `&category=${category}` : '';\n      const excludeParam = shownSentenceIds.length > 0 ? `&excludeIds=${shownSentenceIds.join(',')}` : '';\n      const res = await fetch(`/api/dictation/sentence?difficulty=${difficulty}${categoryParam}${excludeParam}`);\n      if (!res.ok) throw new Error('Failed to fetch sentence');\n      const data = await res.json();\n      const sentence = data.sentence as DictationSentence;\n      \n      if (sentence) {\n        setShownSentenceIds(prev => [...prev, sentence.id]);\n      }\n      \n      return { data: sentence };\n    } catch (error) {\n      console.error('Failed to fetch sentence:', error);\n      return { data: null };\n    } finally {\n      setIsLoading(false);\n    }\n  }, [difficulty, category, shownSentenceIds]);\n\n  const saveTestMutation = useMutation({\n    mutationFn: async (testData: {\n      sentenceId: number;\n      speedLevel: string;\n      actualSpeed: number;\n      actualSentence: string;\n      typedText: string;\n      wpm: number;\n      accuracy: number;\n      errors: number;\n      replayCount: number;\n      hintUsed: number;\n      duration: number;\n    }) => {\n      const res = await fetch('/api/dictation/test', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify(testData),\n      });\n      if (!res.ok) {\n        if (res.status === 401) {\n          toast({\n            title: 'Please log in',\n            description: 'You need to be logged in to save your progress',\n            variant: 'destructive',\n          });\n          return null;\n        }\n        throw new Error('Failed to save test');\n      }\n      return res.json();\n    },\n  });\n\n  const startNewTest = useCallback(async (forceStart: boolean = false) => {\n    if (!forceStart && sessionProgress >= sessionLength) {\n      setSessionComplete(true);\n      return;\n    }\n\n    cancel();\n    setAutoAdvanceCountdown(null);\n    setElapsedTime(0);\n    \n    if (countdownIntervalRef.current) {\n      clearInterval(countdownIntervalRef.current);\n      countdownIntervalRef.current = null;\n    }\n    if (elapsedIntervalRef.current) {\n      clearInterval(elapsedIntervalRef.current);\n      elapsedIntervalRef.current = null;\n    }\n    \n    try {\n      const result = await fetchNewSentence();\n      if (result.data) {\n        setTestState({\n          sentence: result.data,\n          typedText: '',\n          startTime: null,\n          endTime: null,\n          replayCount: 0,\n          hintShown: false,\n          showHint: false,\n          isComplete: false,\n          result: null,\n        });\n        \n        setTimeout(() => {\n          speak(result.data.sentence);\n        }, 800);\n      } else {\n        toast({\n          title: 'Failed to load sentence',\n          description: 'Could not fetch a new sentence. Please try again.',\n          variant: 'destructive',\n        });\n      }\n    } catch (error) {\n      console.error('Error fetching sentence:', error);\n      toast({\n        title: 'Error',\n        description: 'Failed to load next sentence. Please refresh the page.',\n        variant: 'destructive',\n      });\n    }\n  }, [cancel, fetchNewSentence, speak, sessionProgress, sessionLength, toast]);\n\n  \n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      const activeElement = document.activeElement;\n      const isTyping = activeElement?.tagName === 'TEXTAREA' || \n                       activeElement?.tagName === 'INPUT' ||\n                       activeElement?.getAttribute('contenteditable') === 'true';\n      \n      const key = e.key.toLowerCase();\n      \n      if (testState.isComplete && key === 'n' && !isTyping) {\n        e.preventDefault();\n        handleNextManual();\n        return;\n      }\n      \n      if (testState.isComplete || !testState.sentence) return;\n      \n      if (isTyping) return;\n      \n      if (key === 'r' && !isSpeaking && testState.sentence) {\n        e.preventDefault();\n        cancel();\n        setTestState(prev => ({ ...prev, replayCount: prev.replayCount + 1 }));\n        setTimeout(() => {\n          if (testState.sentence) {\n            speak(testState.sentence.sentence);\n          }\n        }, 200);\n      }\n      \n      if (key === 'h' && !isSpeaking && testState.sentence && PRACTICE_MODES[practiceMode].hintsAllowed) {\n        e.preventDefault();\n        setTestState(prev => ({\n          ...prev,\n          showHint: !prev.showHint,\n          hintShown: !prev.showHint ? true : prev.hintShown,\n        }));\n      }\n    };\n\n    window.addEventListener('keydown', handleKeyDown);\n    return () => window.removeEventListener('keydown', handleKeyDown);\n  }, [testState.isComplete, testState.sentence, isSpeaking, cancel, speak, practiceMode]);\n\n  useEffect(() => {\n    if (!isSpeaking && testState.sentence && !testState.startTime && !testState.isComplete) {\n      setTestState(prev => ({ ...prev, startTime: Date.now() }));\n      setElapsedTime(0);\n      \n      if (elapsedIntervalRef.current) {\n        clearInterval(elapsedIntervalRef.current);\n      }\n      elapsedIntervalRef.current = setInterval(() => {\n        setElapsedTime(prev => prev + 1);\n      }, 1000);\n      \n      setTimeout(() => {\n        inputRef.current?.focus();\n      }, 100);\n    }\n  }, [isSpeaking, testState.sentence, testState.startTime, testState.isComplete]);\n  \n  useEffect(() => {\n    return () => {\n      if (elapsedIntervalRef.current) {\n        clearInterval(elapsedIntervalRef.current);\n        elapsedIntervalRef.current = null;\n      }\n    };\n  }, []);\n\n  const handleReplay = () => {\n    if (testState.sentence && !isSpeaking) {\n      cancel();\n      setTestState(prev => ({ ...prev, replayCount: prev.replayCount + 1 }));\n      setTimeout(() => {\n        speak(testState.sentence!.sentence);\n      }, 200);\n    }\n  };\n\n  const toggleHint = () => {\n    setTestState(prev => {\n      const newShowHint = !prev.showHint;\n      return {\n        ...prev,\n        showHint: newShowHint,\n        hintShown: newShowHint ? true : prev.hintShown,\n      };\n    });\n  };\n\n  const handleSubmit = async () => {\n    if (!testState.sentence || !testState.startTime || testState.isComplete || !testState.typedText.trim()) return;\n\n    const currentSentence = testState.sentence;\n    const currentTypedText = testState.typedText;\n    const currentReplayCount = testState.replayCount;\n    const currentHintShown = testState.hintShown;\n    const currentStartTime = testState.startTime;\n    \n    const endTime = Date.now();\n    // Use raw seconds for WPM calculation, rounded for display/storage\n    const elapsedSeconds = (endTime - currentStartTime) / 1000;\n    const duration = Math.round(elapsedSeconds);\n    \n    if (elapsedSeconds < 1) {\n      toast({\n        title: 'Too fast!',\n        description: 'Please take your time to type the sentence.',\n      });\n      return;\n    }\n    \n    const accuracyResult = calculateDictationAccuracy(\n      currentTypedText,\n      currentSentence.sentence\n    );\n    \n    const wpm = calculateDictationWPM(\n      currentTypedText.length,\n      elapsedSeconds\n    );\n\n    const wordErrors = accuracyResult.wordDiff.filter(d => d.status !== 'correct').length;\n    \n    const result = {\n      accuracy: accuracyResult.accuracy,\n      wpm,\n      errors: wordErrors,\n      duration,\n      characterDiff: accuracyResult.characterDiff,\n      wordDiff: accuracyResult.wordDiff,\n      correctChars: accuracyResult.correctChars,\n      totalChars: accuracyResult.totalChars,\n      correctWords: accuracyResult.correctWords,\n      totalWords: accuracyResult.totalWords,\n    };\n\n    setTestState(prev => ({\n      ...prev,\n      endTime,\n      isComplete: true,\n      result,\n    }));\n\n    const errorCategories = categorizeErrors(accuracyResult.characterDiff);\n\n    setSessionHistory(prev => [...prev, {\n      sentence: currentSentence.sentence,\n      typedText: currentTypedText,\n      accuracy: result.accuracy,\n      wpm: result.wpm,\n      errors: result.errors,\n      timestamp: Date.now(),\n      errorCategories,\n    }]);\n\n    const newSessionStats = {\n      totalWpm: sessionStats.totalWpm + result.wpm,\n      totalAccuracy: sessionStats.totalAccuracy + result.accuracy,\n      totalErrors: sessionStats.totalErrors + result.errors,\n      count: sessionStats.count + 1,\n    };\n\n    setSessionStats(newSessionStats);\n\n    if (adaptiveDifficulty.enabled) {\n      const isHighScore = result.accuracy >= ADAPTIVE_THRESHOLDS.upgradeAccuracy && \n                          result.wpm >= ADAPTIVE_THRESHOLDS.upgradeWpm;\n      const isLowScore = result.accuracy < ADAPTIVE_THRESHOLDS.downgradeAccuracy;\n      \n      setAdaptiveDifficulty(prev => {\n        const newRecentScores = [...prev.recentScores, { accuracy: result.accuracy, wpm: result.wpm }]\n          .slice(-ADAPTIVE_THRESHOLDS.maxRecentScores);\n        \n        let newConsecutiveHigh = isHighScore ? prev.consecutiveHighScores + 1 : 0;\n        let newConsecutiveLow = isLowScore ? prev.consecutiveLowScores + 1 : 0;\n        let newLevel = prev.currentLevel;\n        \n        if (newConsecutiveHigh >= ADAPTIVE_THRESHOLDS.upgradeConsecutive && prev.currentLevel !== 'hard') {\n          const nextLevel = getNextDifficulty(prev.currentLevel, 'up');\n          setDifficulty(nextLevel);\n          setDifficultyJustChanged({ from: prev.currentLevel, to: nextLevel, direction: 'up' });\n          toast({\n            title: `${getDifficultyEmoji(nextLevel)} Difficulty Increased!`,\n            description: `Great job! Moving to ${nextLevel} difficulty.`,\n          });\n          newLevel = nextLevel;\n          newConsecutiveHigh = 0;\n          newConsecutiveLow = 0;\n        } else if (newConsecutiveLow >= ADAPTIVE_THRESHOLDS.downgradeConsecutive && prev.currentLevel !== 'easy') {\n          const nextLevel = getNextDifficulty(prev.currentLevel, 'down');\n          setDifficulty(nextLevel);\n          setDifficultyJustChanged({ from: prev.currentLevel, to: nextLevel, direction: 'down' });\n          toast({\n            title: `${getDifficultyEmoji(nextLevel)} Difficulty Adjusted`,\n            description: `Switching to ${nextLevel} for better practice.`,\n          });\n          newLevel = nextLevel;\n          newConsecutiveHigh = 0;\n          newConsecutiveLow = 0;\n        }\n        \n        return {\n          ...prev,\n          currentLevel: newLevel,\n          consecutiveHighScores: newConsecutiveHigh,\n          consecutiveLowScores: newConsecutiveLow,\n          recentScores: newRecentScores,\n        };\n      });\n    }\n\n    const tip = generateCoachingTip(\n      result.accuracy,\n      result.wpm,\n      errorCategories,\n      newSessionStats,\n      currentHintShown,\n      currentReplayCount\n    );\n    setCurrentCoachingTip(tip);\n\n    setSessionProgress(prev => prev + 1);\n    \n    const newStreakData = updateStreak();\n    setStreakData(newStreakData);\n    \n\n    if (elapsedIntervalRef.current) {\n      clearInterval(elapsedIntervalRef.current);\n      elapsedIntervalRef.current = null;\n    }\n\n    try {\n      const saveResult = await saveTestMutation.mutateAsync({\n        sentenceId: currentSentence.id,\n        speedLevel,\n        actualSpeed: currentRate,\n        actualSentence: currentSentence.sentence,\n        typedText: currentTypedText,\n        wpm: result.wpm,\n        accuracy: result.accuracy,\n        errors: result.errors,\n        replayCount: currentReplayCount,\n        hintUsed: currentHintShown ? 1 : 0,\n        duration: result.duration,\n      });\n      \n      if (saveResult && saveResult.result && saveResult.result.id) {\n        setLastTestResultId(saveResult.result.id);\n      }\n    } catch (error) {\n      console.error('Failed to save test:', error);\n      toast({\n        title: 'Warning',\n        description: 'Could not save your test result. Your progress may not be saved.',\n      });\n    }\n\n    const modeConfig = PRACTICE_MODES[practiceMode];\n    if (modeConfig.autoAdvance) {\n      const AUTO_ADVANCE_SECONDS = modeConfig.timerPressure ? 2 : 3;\n      setAutoAdvanceCountdown(AUTO_ADVANCE_SECONDS);\n      \n      countdownIntervalRef.current = setInterval(() => {\n        setAutoAdvanceCountdown(prev => {\n          if (prev === null || prev <= 1) {\n            if (countdownIntervalRef.current) {\n              clearInterval(countdownIntervalRef.current);\n              countdownIntervalRef.current = null;\n            }\n            startNewTest();\n            return null;\n          }\n          return prev - 1;\n        });\n      }, 1000);\n    }\n  };\n\n  const handleNextManual = () => {\n    if (countdownIntervalRef.current) {\n      clearInterval(countdownIntervalRef.current);\n      countdownIntervalRef.current = null;\n    }\n    setAutoAdvanceCountdown(null);\n    startNewTest();\n  };\n\n  const resetSession = () => {\n    setSessionProgress(0);\n    setSessionComplete(false);\n    setSessionStats({\n      totalWpm: 0,\n      totalAccuracy: 0,\n      totalErrors: 0,\n      count: 0,\n    });\n    setSessionHistory([]);\n    setCurrentCoachingTip(null);\n    setShowModeSelector(true);\n    setIsWaitingToStart(false);\n    setShownSentenceIds([]);\n  };\n\n  const restartCurrentSession = () => {\n    cancel();\n    if (countdownIntervalRef.current) {\n      clearInterval(countdownIntervalRef.current);\n      countdownIntervalRef.current = null;\n    }\n    if (elapsedIntervalRef.current) {\n      clearInterval(elapsedIntervalRef.current);\n      elapsedIntervalRef.current = null;\n    }\n    setSessionProgress(0);\n    setSessionComplete(false);\n    setSessionStats({\n      totalWpm: 0,\n      totalAccuracy: 0,\n      totalErrors: 0,\n      count: 0,\n    });\n    setSessionHistory([]);\n    setCurrentCoachingTip(null);\n    setAutoAdvanceCountdown(null);\n    setElapsedTime(0);\n    setShownSentenceIds([]);\n    setTestState({\n      sentence: null,\n      typedText: '',\n      startTime: null,\n      endTime: null,\n      replayCount: 0,\n      hintShown: false,\n      showHint: false,\n      isComplete: false,\n      result: null,\n    });\n    setTimeout(() => {\n      startNewTest(true);\n    }, 100);\n  };\n\n  const startPracticeMode = (mode: PracticeMode) => {\n    const config = PRACTICE_MODES[mode];\n    setPracticeMode(mode);\n    setDifficulty(config.defaultDifficulty);\n    setSpeedLevel(config.defaultSpeed);\n    setShownSentenceIds([]);\n    setTestState({\n      sentence: null,\n      typedText: '',\n      startTime: null,\n      endTime: null,\n      replayCount: 0,\n      hintShown: false,\n      showHint: false,\n      isComplete: false,\n      result: null,\n    });\n    setShowModeSelector(false);\n    setIsWaitingToStart(true);\n  };\n\n  const beginSession = () => {\n    setIsWaitingToStart(false);\n    startNewTest();\n  };\n\n  const achievements = useMemo(() => \n    calculateAchievements(sessionStats, sessionHistory),\n    [sessionStats, sessionHistory]\n  );\n\n  useEffect(() => {\n    if (sessionComplete && user && sessionStats.count > 0 && !certificateData && lastTestResultId) {\n      const avgWpm = Math.round(sessionStats.totalWpm / sessionStats.count);\n      const avgAccuracy = sessionStats.totalAccuracy / sessionStats.count;\n      const consistency = Math.round(Math.random() * 20 + 75);\n      const estimatedDuration = Math.round((sessionStats.count * 60 * 5) / avgWpm);\n\n      const totalWords = sessionHistory.reduce((sum, h) => {\n        const words = h.sentence.split(' ').length;\n        return sum + words;\n      }, 0);\n\n      const certData = {\n        wpm: avgWpm,\n        accuracy: avgAccuracy,\n        consistency,\n        speedLevel: getSpeedLevelName(parseFloat(speedLevel)),\n        sentencesCompleted: sessionStats.count,\n        totalWords,\n        duration: estimatedDuration,\n        username: user.username || 'Typing Expert',\n      };\n\n      setCertificateData(certData);\n\n      createCertificateMutation.mutate({\n        certificateType: \"dictation\",\n        dictationTestId: lastTestResultId,\n        wpm: avgWpm,\n        accuracy: avgAccuracy,\n        consistency,\n        duration: estimatedDuration,\n        metadata: {\n          speedLevel: getSpeedLevelName(parseFloat(speedLevel)),\n          sentencesCompleted: sessionStats.count,\n          totalWords,\n          username: user.username || 'Typing Expert',\n        },\n      });\n    }\n  }, [sessionComplete, user, sessionStats, lastTestResultId, certificateData, sessionHistory, speedLevel, createCertificateMutation]);\n\n  if (!isSupported) {\n    return (\n      <div className=\"container max-w-4xl mx-auto p-6\">\n        <Card className=\"border-destructive\">\n          <CardContent className=\"pt-6\">\n            <h2 className=\"text-2xl font-bold mb-4\">Browser Not Supported</h2>\n            <p className=\"text-muted-foreground\">\n              Your browser doesn't support speech synthesis. Please use a modern browser like Chrome, Edge, or Safari to use Dictation Mode.\n            </p>\n            <Link href=\"/\">\n              <Button className=\"mt-4\" data-testid=\"button-back-home\">\n                <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                Back to Home\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (sessionComplete) {\n    const avgWpm = sessionStats.count > 0 ? Math.round(sessionStats.totalWpm / sessionStats.count) : 0;\n    const avgAccuracy = sessionStats.count > 0 ? Math.round(sessionStats.totalAccuracy / sessionStats.count) : 0;\n\n    return (\n      <TooltipProvider delayDuration={300}>\n        <div className=\"container max-w-4xl mx-auto p-6\">\n          <div className=\"mb-6\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Link href=\"/\">\n                  <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-back\">\n                    <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                    Back\n                  </Button>\n                </Link>\n              </TooltipTrigger>\n              <TooltipContent side=\"right\">\n                <p>Return to home page</p>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n\n          <Card>\n            <CardContent className=\"pt-8 pb-8\">\n              <div className=\"text-center mb-6\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <h2 \n                      className=\"text-3xl font-bold mb-2 cursor-default focus:outline-none focus:ring-2 focus:ring-primary/50 rounded-lg px-2 inline-block\"\n                      tabIndex={0}\n                      role=\"heading\"\n                      aria-label=\"Session complete - congratulations\"\n                    >\n                      Session Complete! ðŸŽ‰\n                    </h2>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Congratulations! You've finished all {sessionLength} dictation exercises</p>\n                  </TooltipContent>\n                </Tooltip>\n                <p className=\"text-muted-foreground\">You've completed {sessionLength} dictation tests</p>\n              </div>\n\n              <div className=\"grid grid-cols-2 md:grid-cols-3 gap-4 mb-8\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div \n                      className=\"text-center p-4 bg-primary/10 rounded-lg cursor-help transition-transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-primary/50\"\n                      tabIndex={0}\n                      role=\"group\"\n                      aria-label=\"Average words per minute statistic\"\n                    >\n                      <div className=\"text-3xl font-bold text-primary\" data-testid=\"text-session-avg-wpm\">{avgWpm}</div>\n                      <div className=\"text-sm text-muted-foreground\">Avg WPM</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"font-medium mb-1\">Average Words Per Minute</p>\n                    <p className=\"text-xs opacity-90\">Your average typing speed across all {sessionStats.count} sentences. Higher is better!</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div \n                      className=\"text-center p-4 bg-green-500/10 rounded-lg cursor-help transition-transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500/50\"\n                      tabIndex={0}\n                      role=\"group\"\n                      aria-label=\"Average accuracy statistic\"\n                    >\n                      <div className=\"text-3xl font-bold text-green-600\" data-testid=\"text-session-avg-accuracy\">{avgAccuracy}%</div>\n                      <div className=\"text-sm text-muted-foreground\">Avg Accuracy</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"font-medium mb-1\">Average Accuracy Score</p>\n                    <p className=\"text-xs opacity-90\">How closely your typing matched the spoken sentences. 100% means perfect transcription.</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div \n                      className=\"text-center p-4 bg-orange-500/10 rounded-lg cursor-help transition-transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-orange-500/50\"\n                      tabIndex={0}\n                      role=\"group\"\n                      aria-label=\"Total errors statistic\"\n                    >\n                      <div className=\"text-3xl font-bold text-orange-600\" data-testid=\"text-session-total-errors\">{sessionStats.totalErrors}</div>\n                      <div className=\"text-sm text-muted-foreground\">Total Errors</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"font-medium mb-1\">Total Character Errors</p>\n                    <p className=\"text-xs opacity-90\">Sum of all incorrect, missing, or extra characters across the session. Lower is better!</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n\n              {achievements.filter(a => a.unlocked).length > 0 && (\n                <div className=\"mb-6\">\n                  <h3 className=\"text-sm font-medium mb-3 text-center flex items-center justify-center gap-2\">\n                    <Award className=\"w-4 h-4 text-yellow-500\" />\n                    Achievements Unlocked!\n                  </h3>\n                  <div className=\"flex flex-wrap gap-2 justify-center\">\n                    {achievements.filter(a => a.unlocked).map((achievement) => (\n                      <Tooltip key={achievement.id}>\n                        <TooltipTrigger asChild>\n                          <Badge variant=\"default\" className=\"bg-yellow-500/20 text-yellow-600 border-yellow-500/50 px-3 py-1.5\">\n                            <span className=\"mr-1\">{achievement.icon}</span>\n                            {achievement.name}\n                          </Badge>\n                        </TooltipTrigger>\n                        <TooltipContent>\n                          <p className=\"font-medium\">{achievement.name}</p>\n                          <p className=\"text-xs opacity-90\">{achievement.description}</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {achievements.filter(a => !a.unlocked).length > 0 && (\n                <div className=\"mb-6\">\n                  <h3 className=\"text-sm font-medium mb-3 text-center text-muted-foreground\">Almost there...</h3>\n                  <div className=\"flex flex-wrap gap-2 justify-center\">\n                    {achievements.filter(a => !a.unlocked).map((achievement) => (\n                      <Tooltip key={achievement.id}>\n                        <TooltipTrigger asChild>\n                          <div className=\"flex items-center gap-2 px-3 py-1.5 bg-muted/50 rounded-full text-sm text-muted-foreground\">\n                            <span className=\"opacity-50\">{achievement.icon}</span>\n                            <span>{achievement.name}</span>\n                            {achievement.progress !== undefined && achievement.target && (\n                              <span className=\"text-xs\">({Math.round(achievement.progress)}/{achievement.target})</span>\n                            )}\n                          </div>\n                        </TooltipTrigger>\n                        <TooltipContent>\n                          <p className=\"font-medium\">{achievement.name}</p>\n                          <p className=\"text-xs opacity-90\">{achievement.description}</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {certificateData && !showCertificate && (\n                <div className=\"mb-6\">\n                  <Button \n                    onClick={() => setShowCertificate(true)} \n                    className=\"w-full gap-2\"\n                    size=\"lg\"\n                    variant=\"outline\"\n                    data-testid=\"button-view-certificate\"\n                  >\n                    <Award className=\"w-5 h-5\" />\n                    View Your Certificate\n                  </Button>\n                </div>\n              )}\n\n              {showCertificate && certificateData && (\n                <div className=\"mb-6 space-y-4\">\n                  <div className=\"flex justify-between items-center\">\n                    <h3 className=\"text-xl font-bold\">Your Achievement Certificate</h3>\n                    <Button \n                      onClick={() => setShowCertificate(false)} \n                      variant=\"ghost\" \n                      size=\"sm\"\n                      data-testid=\"button-hide-certificate\"\n                    >\n                      <X className=\"w-4 h-4 mr-2\" />\n                      Hide\n                    </Button>\n                  </div>\n                  <DictationCertificate {...certificateData} />\n                </div>\n              )}\n\n              <div className=\"flex gap-4 justify-center items-center mb-4 flex-wrap\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"flex items-center gap-2\">\n                      <span className=\"text-sm text-muted-foreground\">Session Length:</span>\n                      {showCustomLength ? (\n                        <div className=\"flex items-center gap-2\">\n                          <input\n                            type=\"number\"\n                            min=\"1\"\n                            max=\"500\"\n                            value={customLengthInput}\n                            onChange={(e) => setCustomLengthInput(e.target.value)}\n                            onKeyDown={(e) => e.key === 'Enter' && handleCustomLengthSubmit()}\n                            placeholder=\"1-500\"\n                            className=\"w-20 px-3 py-2 text-sm border rounded-md bg-background\"\n                            data-testid=\"input-custom-session-length\"\n                            autoFocus\n                          />\n                          <Button size=\"sm\" onClick={handleCustomLengthSubmit} data-testid=\"button-confirm-custom-length\">\n                            Set\n                          </Button>\n                          <Button size=\"sm\" variant=\"ghost\" onClick={() => setShowCustomLength(false)} data-testid=\"button-cancel-custom-length\">\n                            Cancel\n                          </Button>\n                        </div>\n                      ) : (\n                        <Select \n                          value={SESSION_LENGTH_OPTIONS.find(o => o.value === sessionLength) ? sessionLength.toString() : '0'} \n                          onValueChange={handleSessionLengthChange}\n                        >\n                          <SelectTrigger className=\"w-[200px]\" data-testid=\"select-session-length\">\n                            <SelectValue>\n                              {SESSION_LENGTH_OPTIONS.find(o => o.value === sessionLength)?.label || `${sessionLength} sentences (Custom)`}\n                            </SelectValue>\n                          </SelectTrigger>\n                          <SelectContent>\n                            {SESSION_LENGTH_OPTIONS.map((opt) => (\n                              <SelectItem key={opt.value} value={opt.value.toString()}>\n                                {opt.label}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      )}\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p>Choose how many sentences to practice in your next session (1-500)</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n\n              <div className=\"flex gap-3 justify-center flex-wrap\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button onClick={resetSession} size=\"lg\" data-testid=\"button-new-session\">\n                      Start New Session\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Begin a fresh session with {sessionLength} new sentences</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button \n                      onClick={() => setShowShareModal(true)} \n                      variant=\"secondary\" \n                      size=\"lg\"\n                      data-testid=\"button-share-result\"\n                    >\n                      <Share2 className=\"w-4 h-4 mr-2\" />\n                      Share Result\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Share your session results with friends or on social media</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Link href=\"/\">\n                      <Button variant=\"outline\" size=\"lg\" data-testid=\"button-home\">\n                        Back to Home\n                      </Button>\n                    </Link>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Return to the main menu</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </TooltipProvider>\n    );\n  }\n\n  if (showModeSelector) {\n    return (\n      <TooltipProvider delayDuration={300}>\n        <div className=\"container max-w-4xl mx-auto p-6\">\n          <div className=\"mb-6 flex items-center justify-between\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Link href=\"/\">\n                  <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-back\">\n                    <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                    Back\n                  </Button>\n                </Link>\n              </TooltipTrigger>\n              <TooltipContent side=\"right\">\n                <p>Return to home page</p>\n              </TooltipContent>\n            </Tooltip>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <h1 \n                  className=\"text-3xl font-bold cursor-default focus:outline-none focus:ring-2 focus:ring-primary/50 rounded-lg px-2\"\n                  tabIndex={0}\n                  role=\"heading\"\n                  aria-label=\"Choose your practice mode\"\n                >\n                  Dictation Mode ðŸŽ§\n                </h1>\n              </TooltipTrigger>\n              <TooltipContent className=\"max-w-sm\">\n                <p>Select how you want to practice today</p>\n              </TooltipContent>\n            </Tooltip>\n            <div className=\"w-20\" />\n          </div>\n\n          <Card className=\"mb-6\">\n            <CardHeader>\n              <CardTitle className=\"text-center\">Choose Your Practice Mode</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                {(Object.entries(PRACTICE_MODES) as [PracticeMode, PracticeModeConfig][]).map(([mode, config]) => (\n                  <Tooltip key={mode}>\n                    <TooltipTrigger asChild>\n                      <Card \n                        className={`cursor-pointer transition-all hover:shadow-lg hover:scale-[1.02] border-2 ${\n                          practiceMode === mode ? 'border-primary' : 'border-transparent'\n                        }`}\n                        onClick={() => startPracticeMode(mode)}\n                        tabIndex={0}\n                        role=\"button\"\n                        aria-label={`Select ${config.name}`}\n                        onKeyDown={(e) => e.key === 'Enter' && startPracticeMode(mode)}\n                        data-testid={`button-mode-${mode}`}\n                      >\n                        <CardContent className=\"pt-6 text-center\">\n                          <div className={`mx-auto w-12 h-12 rounded-full flex items-center justify-center mb-3 ${\n                            mode === 'quick' ? 'bg-blue-500/10 text-blue-500' :\n                            mode === 'focus' ? 'bg-green-500/10 text-green-500' :\n                            'bg-yellow-500/10 text-yellow-500'\n                          }`}>\n                            {config.icon}\n                          </div>\n                          <h3 className=\"font-semibold text-lg mb-2\">{config.name}</h3>\n                          <p className=\"text-sm text-muted-foreground mb-4\">{config.description}</p>\n                          <div className=\"flex flex-wrap gap-1 justify-center\">\n                            {mode === 'focus' && (\n                              <>\n                                <Badge variant=\"secondary\" className=\"text-xs bg-gradient-to-r from-blue-500/20 to-green-500/20\">Zen Mode</Badge>\n                                <Badge variant=\"secondary\" className=\"text-xs\">Calming Themes</Badge>\n                              </>\n                            )}\n                            {config.autoAdvance && (\n                              <Badge variant=\"secondary\" className=\"text-xs\">Auto-advance</Badge>\n                            )}\n                            {!config.hintsAllowed && (\n                              <Badge variant=\"secondary\" className=\"text-xs\">No hints</Badge>\n                            )}\n                            {config.timerPressure && (\n                              <Badge variant=\"secondary\" className=\"text-xs\">Timed</Badge>\n                            )}\n                          </div>\n                        </CardContent>\n                      </Card>\n                    </TooltipTrigger>\n                    <TooltipContent className=\"max-w-xs\">\n                      <p className=\"font-medium mb-1\">{config.name}</p>\n                      <p className=\"text-xs opacity-90\">{config.description}</p>\n                      <p className=\"text-xs mt-1\">Default: {config.defaultDifficulty} difficulty, {config.defaultSpeed} speed</p>\n                    </TooltipContent>\n                  </Tooltip>\n                ))}\n              </div>\n\n              <div className=\"mt-6 p-4 bg-muted/50 rounded-lg\">\n                <h4 className=\"font-medium mb-3 flex items-center gap-2\">\n                  <Clock className=\"w-4 h-4\" />\n                  Session Settings\n                </h4>\n                <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                  <div>\n                    <label className=\"text-sm text-muted-foreground mb-1 block\">Session Length</label>\n                    {showCustomLength ? (\n                      <div className=\"flex items-center gap-2\">\n                        <input\n                          type=\"number\"\n                          min=\"1\"\n                          max=\"500\"\n                          value={customLengthInput}\n                          onChange={(e) => setCustomLengthInput(e.target.value)}\n                          onKeyDown={(e) => e.key === 'Enter' && handleCustomLengthSubmit()}\n                          placeholder=\"1-500\"\n                          className=\"flex-1 px-3 py-2 text-sm border rounded-md bg-background\"\n                          data-testid=\"input-custom-session-length-mode\"\n                          autoFocus\n                        />\n                        <Button size=\"sm\" onClick={handleCustomLengthSubmit} data-testid=\"button-confirm-custom-length-mode\">\n                          Set\n                        </Button>\n                        <Button size=\"sm\" variant=\"ghost\" onClick={() => setShowCustomLength(false)} data-testid=\"button-cancel-custom-length-mode\">\n                          <X className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    ) : (\n                      <Select \n                        value={SESSION_LENGTH_OPTIONS.find(o => o.value === sessionLength) ? sessionLength.toString() : '0'} \n                        onValueChange={handleSessionLengthChange}\n                      >\n                        <SelectTrigger data-testid=\"select-session-length-mode\">\n                          <SelectValue>\n                            {SESSION_LENGTH_OPTIONS.find(o => o.value === sessionLength)?.label || `${sessionLength} sentences (Custom)`}\n                          </SelectValue>\n                        </SelectTrigger>\n                        <SelectContent>\n                          {SESSION_LENGTH_OPTIONS.map((opt) => (\n                            <SelectItem key={opt.value} value={opt.value.toString()}>\n                              {opt.label}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    )}\n                  </div>\n                  <div>\n                    <label className=\"text-sm text-muted-foreground mb-1 block\">Topic</label>\n                    <Select value={category} onValueChange={setCategory}>\n                      <SelectTrigger data-testid=\"select-category-mode\">\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {CATEGORIES.map((cat) => (\n                          <SelectItem key={cat.value} value={cat.value}>\n                            {cat.label}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </TooltipProvider>\n    );\n  }\n\n  if (isWaitingToStart) {\n    const modeConfig = PRACTICE_MODES[practiceMode];\n    return (\n      <TooltipProvider delayDuration={300}>\n        <div className=\"container max-w-4xl mx-auto p-6\">\n          <div className=\"mb-6 flex items-center justify-between\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Button \n                  variant=\"ghost\" \n                  size=\"sm\" \n                  onClick={() => {\n                    setShowModeSelector(true);\n                    setIsWaitingToStart(false);\n                  }}\n                  data-testid=\"button-back-to-modes\"\n                >\n                  <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                  Back to Modes\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent side=\"right\">\n                <p>Choose a different practice mode</p>\n              </TooltipContent>\n            </Tooltip>\n            <h1 className=\"text-2xl font-bold\">{modeConfig.name}</h1>\n            <div className=\"w-24\" />\n          </div>\n\n          <Card className=\"mb-6\">\n            <CardContent className=\"pt-6\">\n              <div className=\"flex items-center gap-4 mb-6 pb-6 border-b\">\n                <div className={`w-14 h-14 rounded-full flex items-center justify-center ${\n                  practiceMode === 'quick' ? 'bg-blue-500/10 text-blue-500' :\n                  practiceMode === 'focus' ? 'bg-green-500/10 text-green-500' :\n                  'bg-yellow-500/10 text-yellow-500'\n                }`}>\n                  {modeConfig.icon}\n                </div>\n                <div>\n                  <p className=\"text-muted-foreground\">{modeConfig.description}</p>\n                  <div className=\"flex gap-2 mt-2\">\n                    {modeConfig.autoAdvance && (\n                      <Badge variant=\"secondary\" className=\"text-xs\">Auto-advance</Badge>\n                    )}\n                    {!modeConfig.hintsAllowed && (\n                      <Badge variant=\"secondary\" className=\"text-xs\">No hints</Badge>\n                    )}\n                    {modeConfig.timerPressure && (\n                      <Badge variant=\"secondary\" className=\"text-xs\">Timed</Badge>\n                    )}\n                  </div>\n                </div>\n              </div>\n\n              <h3 className=\"font-medium mb-4 flex items-center gap-2\">\n                <Settings2 className=\"w-4 h-4\" />\n                Session Settings\n              </h3>\n              \n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6\">\n                <div>\n                  <label className=\"text-sm text-muted-foreground mb-1 block\">Session Length</label>\n                  {showCustomLength ? (\n                    <div className=\"flex items-center gap-2\">\n                      <input\n                        type=\"number\"\n                        min=\"1\"\n                        max=\"500\"\n                        value={customLengthInput}\n                        onChange={(e) => setCustomLengthInput(e.target.value)}\n                        onKeyDown={(e) => e.key === 'Enter' && handleCustomLengthSubmit()}\n                        placeholder=\"1-500\"\n                        className=\"flex-1 px-3 py-2 text-sm border rounded-md bg-background\"\n                        data-testid=\"input-custom-session-length-ready\"\n                        autoFocus\n                      />\n                      <Button size=\"sm\" onClick={handleCustomLengthSubmit}>Set</Button>\n                      <Button size=\"sm\" variant=\"ghost\" onClick={() => setShowCustomLength(false)}>\n                        <X className=\"w-4 h-4\" />\n                      </Button>\n                    </div>\n                  ) : (\n                    <Select \n                      value={SESSION_LENGTH_OPTIONS.find(o => o.value === sessionLength) ? sessionLength.toString() : '0'} \n                      onValueChange={handleSessionLengthChange}\n                    >\n                      <SelectTrigger data-testid=\"select-session-length-ready\">\n                        <SelectValue>\n                          {SESSION_LENGTH_OPTIONS.find(o => o.value === sessionLength)?.label || `${sessionLength} sentences (Custom)`}\n                        </SelectValue>\n                      </SelectTrigger>\n                      <SelectContent>\n                        {SESSION_LENGTH_OPTIONS.map((opt) => (\n                          <SelectItem key={opt.value} value={opt.value.toString()}>\n                            {opt.label}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  )}\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-muted-foreground mb-1 block\">Topic</label>\n                  <Select value={category} onValueChange={setCategory}>\n                    <SelectTrigger data-testid=\"select-category-ready\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {CATEGORIES.map((cat) => (\n                        <SelectItem key={cat.value} value={cat.value}>\n                          {cat.label}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-muted-foreground mb-1 block\">Difficulty</label>\n                  <Select value={difficulty} onValueChange={setDifficulty}>\n                    <SelectTrigger data-testid=\"select-difficulty-ready\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"easy\">Easy</SelectItem>\n                      <SelectItem value=\"medium\">Medium</SelectItem>\n                      <SelectItem value=\"hard\">Hard</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div>\n                  <label className=\"text-sm text-muted-foreground mb-1 block\">\n                    Speech Speed: {getSpeedLevelName(parseFloat(speedLevel))}\n                  </label>\n                  <Slider\n                    value={[parseFloat(speedLevel)]}\n                    onValueChange={([val]) => setSpeedLevel(val.toString())}\n                    min={0.5}\n                    max={2.0}\n                    step={0.1}\n                    className=\"mt-2\"\n                    data-testid=\"slider-speed-ready\"\n                  />\n                  <div className=\"flex justify-between text-xs text-muted-foreground mt-1\">\n                    <span>0.5x</span>\n                    <span>2.0x</span>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"pt-6 border-t\">\n                <div className=\"flex flex-col items-center gap-4\">\n                  <Button \n                    size=\"lg\" \n                    onClick={beginSession}\n                    className=\"px-12 py-6 text-lg w-full sm:w-auto\"\n                    data-testid=\"button-start-session\"\n                  >\n                    <Volume2 className=\"w-5 h-5 mr-2\" />\n                    Start Session\n                  </Button>\n                  <p className=\"text-sm text-muted-foreground text-center\">\n                    Configure your settings above, then press Start when ready\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </TooltipProvider>\n    );\n  }\n\n  if (isZenMode && practiceMode === 'focus') {\n    const theme = ZEN_THEMES[zenTheme];\n    return (\n      <div \n        ref={zenContainerRef}\n        className=\"fixed inset-0 z-50 flex flex-col items-center justify-center overflow-hidden\"\n        style={{ background: theme.gradient }}\n        data-testid=\"zen-mode-container\"\n      >\n        {showEscHint && (\n          <div \n            className=\"absolute top-4 left-1/2 -translate-x-1/2 px-4 py-2 rounded-full text-sm font-medium animate-in fade-in slide-in-from-top-2 duration-300\"\n            style={{ \n              backgroundColor: 'rgba(0, 0, 0, 0.3)',\n              color: theme.textColor,\n            }}\n          >\n            Press <kbd className=\"px-1.5 py-0.5 mx-1 rounded bg-black/20 font-mono text-xs\">ESC</kbd> to exit Zen Mode\n          </div>\n        )}\n\n        <div className=\"absolute top-4 right-4 flex items-center gap-2\">\n          {Object.entries(ZEN_THEMES).map(([key, t]) => (\n            <button\n              key={key}\n              onClick={() => setZenTheme(key as ZenTheme)}\n              className={`p-2 rounded-full transition-all duration-200 ${\n                zenTheme === key \n                  ? 'ring-2 ring-white/50 scale-110' \n                  : 'opacity-60 hover:opacity-100'\n              }`}\n              style={{ backgroundColor: theme.buttonBg }}\n              title={t.name}\n              data-testid={`zen-theme-${key}`}\n            >\n              {t.icon}\n            </button>\n          ))}\n          <button\n            onClick={exitZenMode}\n            className=\"p-2 rounded-full transition-all ml-2\"\n            style={{ backgroundColor: theme.buttonBg }}\n            title=\"Exit Zen Mode\"\n            data-testid=\"button-exit-zen\"\n          >\n            <Minimize2 className=\"w-4 h-4\" style={{ color: theme.textColor }} />\n          </button>\n        </div>\n\n        <div className=\"w-full max-w-2xl px-8\">\n          <div className=\"text-center mb-8\">\n            <p \n              className=\"text-lg font-medium mb-2 opacity-80\"\n              style={{ color: theme.textColor }}\n            >\n              Sentence {sessionProgress + 1} of {sessionLength}\n            </p>\n            <div \n              className=\"h-1 w-full rounded-full overflow-hidden\"\n              style={{ backgroundColor: 'rgba(255,255,255,0.2)' }}\n            >\n              <div \n                className=\"h-full transition-all duration-500\"\n                style={{ \n                  width: `${(sessionProgress / sessionLength) * 100}%`,\n                  backgroundColor: theme.accentColor,\n                }}\n              />\n            </div>\n          </div>\n\n          <div className=\"flex justify-center gap-4 mb-8\">\n            <button\n              onClick={() => testState.sentence && speak(testState.sentence.sentence)}\n              disabled={isSpeaking || !testState.sentence}\n              className=\"p-4 rounded-full transition-all duration-200 hover:scale-105 disabled:opacity-50\"\n              style={{ backgroundColor: theme.buttonBg }}\n              data-testid=\"zen-button-play\"\n            >\n              <Volume2 \n                className={`w-8 h-8 ${isSpeaking ? 'animate-pulse' : ''}`} \n                style={{ color: theme.accentColor }} \n              />\n            </button>\n            {PRACTICE_MODES[practiceMode].hintsAllowed && (\n              <button\n                onClick={() => setTestState(prev => ({ ...prev, showHint: !prev.showHint, hintShown: true }))}\n                className=\"p-4 rounded-full transition-all duration-200 hover:scale-105\"\n                style={{ backgroundColor: theme.buttonBg }}\n                data-testid=\"zen-button-hint\"\n              >\n                {testState.showHint ? (\n                  <EyeOff className=\"w-8 h-8\" style={{ color: theme.accentColor }} />\n                ) : (\n                  <Eye className=\"w-8 h-8\" style={{ color: theme.accentColor }} />\n                )}\n              </button>\n            )}\n          </div>\n\n          {testState.showHint && testState.sentence && (\n            <div \n              className=\"text-center mb-6 p-4 rounded-xl animate-in fade-in duration-300\"\n              style={{ backgroundColor: 'rgba(255,255,255,0.1)' }}\n            >\n              <p \n                className=\"text-lg leading-relaxed\"\n                style={{ color: theme.textColor }}\n              >\n                {testState.sentence.sentence}\n              </p>\n            </div>\n          )}\n\n          {!testState.isComplete ? (\n            <div className=\"space-y-4\">\n              <Textarea\n                ref={inputRef}\n                value={testState.typedText}\n                onChange={(e) => {\n                  const text = e.target.value;\n                  setTestState(prev => ({\n                    ...prev,\n                    typedText: text,\n                    startTime: prev.startTime || Date.now(),\n                  }));\n                }}\n                onKeyDown={(e) => {\n                  if (e.key === 'Enter' && e.ctrlKey) {\n                    e.preventDefault();\n                    handleSubmit();\n                  }\n                }}\n                placeholder=\"Listen and type what you hear...\"\n                className=\"min-h-[120px] text-lg leading-relaxed resize-none border-0 focus-visible:ring-2 transition-all\"\n                style={{ \n                  backgroundColor: theme.inputBg,\n                  color: theme.textColor,\n                }}\n                disabled={!testState.sentence || isLoading}\n                data-testid=\"zen-textarea-input\"\n              />\n              <div className=\"flex justify-center\">\n                <Button\n                  onClick={handleSubmit}\n                  disabled={!testState.typedText.trim() || isLoading}\n                  className=\"px-8 py-3 text-lg font-medium rounded-full transition-all hover:scale-105\"\n                  style={{ \n                    backgroundColor: theme.accentColor,\n                    color: '#1a202c',\n                  }}\n                  data-testid=\"zen-button-submit\"\n                >\n                  <Check className=\"w-5 h-5 mr-2\" />\n                  Submit\n                </Button>\n              </div>\n              <p \n                className=\"text-center text-sm opacity-60\"\n                style={{ color: theme.textColor }}\n              >\n                Press <kbd className=\"px-1.5 py-0.5 mx-1 rounded bg-white/10 font-mono text-xs\">Ctrl + Enter</kbd> to submit\n              </p>\n            </div>\n          ) : (\n            <div className=\"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500\">\n              <div \n                className=\"text-center p-6 rounded-2xl\"\n                style={{ backgroundColor: 'rgba(255,255,255,0.1)' }}\n              >\n                <div className=\"flex justify-center gap-8 mb-6\">\n                  <div className=\"text-center\">\n                    <div \n                      className=\"text-4xl font-bold mb-1\"\n                      style={{ color: theme.accentColor }}\n                    >\n                      {testState.result?.accuracy}%\n                    </div>\n                    <div \n                      className=\"text-sm opacity-70\"\n                      style={{ color: theme.textColor }}\n                    >\n                      Accuracy\n                    </div>\n                  </div>\n                  <div className=\"text-center\">\n                    <div \n                      className=\"text-4xl font-bold mb-1\"\n                      style={{ color: theme.accentColor }}\n                    >\n                      {testState.result?.wpm}\n                    </div>\n                    <div \n                      className=\"text-sm opacity-70\"\n                      style={{ color: theme.textColor }}\n                    >\n                      WPM\n                    </div>\n                  </div>\n                </div>\n\n                {currentEncouragement && (\n                  <div \n                    className=\"py-4 px-6 rounded-xl mb-4 animate-in fade-in duration-700\"\n                    style={{ backgroundColor: 'rgba(255,255,255,0.1)' }}\n                  >\n                    <Sparkles className=\"w-5 h-5 mx-auto mb-2\" style={{ color: theme.accentColor }} />\n                    <p \n                      className=\"text-lg font-medium italic\"\n                      style={{ color: theme.textColor }}\n                    >\n                      \"{currentEncouragement}\"\n                    </p>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"flex justify-center gap-4\">\n                <Button\n                  onClick={() => startNewTest()}\n                  className=\"px-8 py-3 text-lg font-medium rounded-full transition-all hover:scale-105\"\n                  style={{ \n                    backgroundColor: theme.accentColor,\n                    color: '#1a202c',\n                  }}\n                  data-testid=\"zen-button-next\"\n                >\n                  <ChevronRight className=\"w-5 h-5 mr-2\" />\n                  Next Sentence\n                </Button>\n              </div>\n            </div>\n          )}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <TooltipProvider delayDuration={300}>\n      <div className=\"container max-w-4xl mx-auto p-6\">\n        <div className=\"mb-6\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Link href=\"/\">\n                  <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-back\">\n                    <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                    Back\n                  </Button>\n                </Link>\n              </TooltipTrigger>\n              <TooltipContent side=\"right\">\n                <p>Return to home page</p>\n              </TooltipContent>\n            </Tooltip>\n            <div className=\"flex items-center gap-2\">\n              {streakData.currentStreak > 0 && (\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"flex items-center gap-1 px-2 py-1 bg-orange-500/10 text-orange-500 rounded-full text-sm font-medium\">\n                      <Flame className=\"w-4 h-4 animate-pulse\" />\n                      <span>{streakData.currentStreak}</span>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p className=\"font-medium\">{streakData.currentStreak} day streak!</p>\n                    <p className=\"text-xs opacity-80\">Best: {streakData.longestStreak} days | Total: {streakData.totalSessions} sessions</p>\n                  </TooltipContent>\n                </Tooltip>\n              )}\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button \n                    variant={showHistory ? \"secondary\" : \"ghost\"}\n                    size=\"sm\"\n                    onClick={() => setShowHistory(!showHistory)}\n                    data-testid=\"button-toggle-history\"\n                    className=\"gap-2\"\n                  >\n                    <History className=\"w-4 h-4\" />\n                    <span className=\"hidden sm:inline\">History</span>\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>View session history ({sessionHistory.length} items)</p>\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button \n                    variant={showAnalytics ? \"secondary\" : \"ghost\"}\n                    size=\"sm\"\n                    onClick={() => setShowAnalytics(!showAnalytics)}\n                    data-testid=\"button-toggle-analytics\"\n                    className=\"gap-2\"\n                  >\n                    <BarChart3 className=\"w-4 h-4\" />\n                    <span className=\"hidden sm:inline\">Stats</span>\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>View session analytics</p>\n                </TooltipContent>\n              </Tooltip>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button \n                    variant={showBookmarks ? \"secondary\" : \"ghost\"}\n                    size=\"sm\"\n                    onClick={() => setShowBookmarks(!showBookmarks)}\n                    data-testid=\"button-toggle-bookmarks\"\n                    className=\"gap-2\"\n                  >\n                    <Bookmark className=\"w-4 h-4\" />\n                    {bookmarks.length > 0 && (\n                      <span className=\"bg-primary text-primary-foreground text-xs rounded-full px-1.5 py-0.5 min-w-[1.25rem] text-center\">\n                        {bookmarks.length}\n                      </span>\n                    )}\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>View bookmarked sentences ({bookmarks.length})</p>\n                </TooltipContent>\n              </Tooltip>\n              {practiceMode === 'focus' && (\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button \n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={enterZenMode}\n                      data-testid=\"button-enter-zen\"\n                      className=\"gap-2 bg-gradient-to-r from-blue-500/10 to-green-500/10 hover:from-blue-500/20 hover:to-green-500/20\"\n                    >\n                      <Maximize2 className=\"w-4 h-4\" />\n                      <span className=\"hidden sm:inline\">Zen</span>\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Enter distraction-free Zen Mode</p>\n                  </TooltipContent>\n                </Tooltip>\n              )}\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button \n                    variant={showSettings ? \"secondary\" : \"ghost\"}\n                    size=\"sm\"\n                    onClick={() => setShowSettings(!showSettings)}\n                    data-testid=\"button-toggle-settings\"\n                  >\n                    <Settings2 className=\"w-4 h-4\" />\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>Voice & display settings</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </div>\n          \n          <div className=\"text-center\">\n            <div className=\"flex items-center justify-center gap-3 mb-2\">\n              <div className=\"bg-primary/10 p-2 rounded-full\">\n                <Mic className=\"w-6 h-6 text-primary\" />\n              </div>\n              <h1 className=\"text-2xl md:text-3xl font-bold\">\n                Dictation Mode\n              </h1>\n            </div>\n            <Badge variant=\"outline\" className=\"text-sm px-3 py-1\">\n              {PRACTICE_MODES[practiceMode].icon}\n              <span className=\"ml-2\">{PRACTICE_MODES[practiceMode].name}</span>\n            </Badge>\n          </div>\n        </div>\n\n        {showHistory && (\n          <Card className=\"mb-6 animate-in slide-in-from-top-2\">\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"text-lg flex items-center gap-2\">\n                  <History className=\"w-5 h-5\" />\n                  Session History\n                  {sessionHistory.length > 0 && (\n                    <Badge variant=\"secondary\" className=\"ml-2\">\n                      {sessionHistory.length} completed\n                    </Badge>\n                  )}\n                </CardTitle>\n                <Button variant=\"ghost\" size=\"sm\" onClick={() => setShowHistory(false)}>\n                  <X className=\"w-4 h-4\" />\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent className=\"max-h-64 overflow-y-auto\">\n              {sessionHistory.length === 0 ? (\n                <div className=\"text-center py-8\">\n                  <div className=\"bg-muted/50 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center\">\n                    <History className=\"w-8 h-8 text-muted-foreground\" />\n                  </div>\n                  <h4 className=\"font-medium text-muted-foreground mb-2\">No History Yet</h4>\n                  <p className=\"text-sm text-muted-foreground/70 max-w-xs mx-auto\">\n                    Complete a dictation test to see your history here. Your performance for each sentence will be tracked.\n                  </p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {sessionHistory.map((item, index) => (\n                    <div key={index} className=\"p-3 bg-muted/50 rounded-lg\">\n                      <div className=\"flex items-center justify-between mb-2\">\n                        <span className=\"text-sm font-medium\">Sentence {index + 1}</span>\n                        <div className=\"flex items-center gap-2\">\n                          <Badge variant={item.accuracy >= 95 ? 'default' : item.accuracy >= 80 ? 'secondary' : 'destructive'}>\n                            {item.accuracy}%\n                          </Badge>\n                          <span className=\"text-xs text-muted-foreground\">{item.wpm} WPM</span>\n                        </div>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground truncate\">{item.sentence}</p>\n                      {item.errorCategories.length > 0 && (\n                        <div className=\"flex gap-1 mt-2 flex-wrap\">\n                          {item.errorCategories.slice(0, 3).map((cat, i) => (\n                            <Badge key={i} variant=\"outline\" className=\"text-xs\">\n                              {cat.type}: {cat.count}\n                            </Badge>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {showAnalytics && (\n          <Card className=\"mb-6 animate-in slide-in-from-top-2\">\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"text-lg flex items-center gap-2\">\n                  <BarChart3 className=\"w-5 h-5\" />\n                  Session Analytics\n                </CardTitle>\n                <Button variant=\"ghost\" size=\"sm\" onClick={() => setShowAnalytics(false)}>\n                  <X className=\"w-4 h-4\" />\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {sessionStats.count === 0 ? (\n                <div className=\"text-center py-8\">\n                  <div className=\"bg-muted/50 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center\">\n                    <BarChart3 className=\"w-8 h-8 text-muted-foreground\" />\n                  </div>\n                  <h4 className=\"font-medium text-muted-foreground mb-2\">No Stats Yet</h4>\n                  <p className=\"text-sm text-muted-foreground/70 max-w-xs mx-auto\">\n                    Complete dictation tests to see your analytics. Track your WPM, accuracy, and achievements here.\n                  </p>\n                  \n                  <div className=\"mt-6\">\n                    <h5 className=\"text-sm font-medium mb-3\">Available Achievements</h5>\n                    <div className=\"grid grid-cols-2 md:grid-cols-4 gap-2\">\n                      {achievements.map((achievement) => (\n                        <Tooltip key={achievement.id}>\n                          <TooltipTrigger asChild>\n                            <div className=\"p-2 rounded-lg text-center bg-muted/30 opacity-60\">\n                              <div className=\"mx-auto w-8 h-8 rounded-full flex items-center justify-center mb-1 bg-muted\">\n                                {achievement.icon}\n                              </div>\n                              <p className=\"text-xs font-medium truncate\">{achievement.name}</p>\n                            </div>\n                          </TooltipTrigger>\n                          <TooltipContent>\n                            <p className=\"font-medium\">{achievement.name}</p>\n                            <p className=\"text-xs opacity-90\">{achievement.description}</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      ))}\n                    </div>\n                  </div>\n                </div>\n              ) : (\n                <>\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-4\">\n                    <div className=\"text-center p-3 bg-primary/10 rounded-lg\">\n                      <div className=\"text-2xl font-bold text-primary\">\n                        {Math.round(sessionStats.totalWpm / sessionStats.count)}\n                      </div>\n                      <div className=\"text-xs text-muted-foreground\">Avg WPM</div>\n                    </div>\n                    <div className=\"text-center p-3 bg-green-500/10 rounded-lg\">\n                      <div className=\"text-2xl font-bold text-green-600\">\n                        {Math.round(sessionStats.totalAccuracy / sessionStats.count)}%\n                      </div>\n                      <div className=\"text-xs text-muted-foreground\">Avg Accuracy</div>\n                    </div>\n                    <div className=\"text-center p-3 bg-orange-500/10 rounded-lg\">\n                      <div className=\"text-2xl font-bold text-orange-600\">\n                        {sessionStats.totalErrors}\n                      </div>\n                      <div className=\"text-xs text-muted-foreground\">Total Errors</div>\n                    </div>\n                    <div className=\"text-center p-3 bg-purple-500/10 rounded-lg\">\n                      <div className=\"text-2xl font-bold text-purple-600\">\n                        {sessionHistory.filter(h => h.accuracy === 100).length}\n                      </div>\n                      <div className=\"text-xs text-muted-foreground\">Perfect Scores</div>\n                    </div>\n                  </div>\n\n                  {(() => {\n                    const errorBreakdown = sessionHistory.reduce((acc, item) => {\n                      item.errorCategories.forEach(cat => {\n                        if (!acc[cat.type]) {\n                          acc[cat.type] = { count: 0, examples: [] };\n                        }\n                        acc[cat.type].count += cat.count;\n                        acc[cat.type].examples = Array.from(new Set([...acc[cat.type].examples, ...cat.examples])).slice(0, 5);\n                      });\n                      return acc;\n                    }, {} as Record<string, { count: number; examples: string[] }>);\n\n                    const sortedErrors = Object.entries(errorBreakdown).sort((a, b) => b[1].count - a[1].count);\n                    const weakestArea = sortedErrors[0];\n\n                    if (sortedErrors.length > 0) {\n                      return (\n                        <div className=\"mb-4\">\n                          <h4 className=\"text-sm font-medium mb-3 flex items-center gap-2\">\n                            <AlertCircle className=\"w-4 h-4 text-orange-500\" />\n                            Error Breakdown\n                          </h4>\n                          <div className=\"grid grid-cols-2 md:grid-cols-3 gap-2 mb-3\">\n                            {sortedErrors.map(([type, data]) => (\n                              <Tooltip key={type}>\n                                <TooltipTrigger asChild>\n                                  <div className={`p-2 rounded-lg text-center cursor-help ${\n                                    type === weakestArea?.[0] ? 'bg-red-500/20 border border-red-500/30' : 'bg-muted/50'\n                                  }`}>\n                                    <div className={`text-lg font-bold ${type === weakestArea?.[0] ? 'text-red-500' : 'text-foreground'}`}>\n                                      {data.count}\n                                    </div>\n                                    <div className=\"text-xs text-muted-foreground capitalize\">\n                                      {type.replace('_', ' ')}\n                                    </div>\n                                  </div>\n                                </TooltipTrigger>\n                                <TooltipContent className=\"max-w-xs\">\n                                  <p className=\"font-medium capitalize mb-1\">{type.replace('_', ' ')} Errors</p>\n                                  {data.examples.length > 0 && (\n                                    <p className=\"text-xs opacity-90\">Examples: {data.examples.join(', ')}</p>\n                                  )}\n                                </TooltipContent>\n                              </Tooltip>\n                            ))}\n                          </div>\n                          {weakestArea && (\n                            <div className=\"p-3 bg-orange-500/10 rounded-lg border border-orange-500/20\">\n                              <div className=\"flex items-center justify-between\">\n                                <div className=\"flex items-center gap-2\">\n                                  <Lightbulb className=\"w-4 h-4 text-orange-500\" />\n                                  <span className=\"text-sm\">\n                                    <span className=\"font-medium\">Focus area:</span>{' '}\n                                    <span className=\"capitalize\">{weakestArea[0].replace('_', ' ')}</span>\n                                    <span className=\"text-muted-foreground\"> ({weakestArea[1].count} errors)</span>\n                                  </span>\n                                </div>\n                              </div>\n                              <p className=\"text-xs text-muted-foreground mt-1\">\n                                {weakestArea[0] === 'spelling' && 'Practice similar words to improve spelling accuracy.'}\n                                {weakestArea[0] === 'punctuation' && 'Pay attention to commas, periods, and other punctuation marks.'}\n                                {weakestArea[0] === 'capitalization' && 'Remember to capitalize proper nouns and sentence beginnings.'}\n                                {weakestArea[0] === 'missing' && 'Listen more carefully and make sure not to skip words.'}\n                                {weakestArea[0] === 'extra' && 'Avoid adding words that weren\\'t in the original sentence.'}\n                                {weakestArea[0] === 'word_order' && 'Pay attention to the order of words as you hear them.'}\n                              </p>\n                            </div>\n                          )}\n                        </div>\n                      );\n                    }\n                    return null;\n                  })()}\n\n                  <h4 className=\"text-sm font-medium mb-3\">Achievements</h4>\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-2\">\n                    {achievements.map((achievement) => (\n                      <Tooltip key={achievement.id}>\n                        <TooltipTrigger asChild>\n                          <div className={`p-2 rounded-lg text-center transition-all ${\n                            achievement.unlocked \n                              ? 'bg-yellow-500/20 border border-yellow-500/50' \n                              : 'bg-muted/50 opacity-50'\n                          }`}>\n                            <div className={`mx-auto w-8 h-8 rounded-full flex items-center justify-center mb-1 ${\n                              achievement.unlocked ? 'bg-yellow-500/30' : 'bg-muted'\n                            }`}>\n                              {achievement.icon}\n                            </div>\n                            <p className=\"text-xs font-medium truncate\">{achievement.name}</p>\n                            {achievement.progress !== undefined && achievement.target && (\n                              <Progress \n                                value={(achievement.progress / achievement.target) * 100} \n                                className=\"h-1 mt-1\"\n                              />\n                            )}\n                          </div>\n                        </TooltipTrigger>\n                        <TooltipContent>\n                          <p className=\"font-medium\">{achievement.name}</p>\n                          <p className=\"text-xs opacity-90\">{achievement.description}</p>\n                          {achievement.progress !== undefined && achievement.target && (\n                            <p className=\"text-xs mt-1\">Progress: {Math.round(achievement.progress)}/{achievement.target}</p>\n                          )}\n                        </TooltipContent>\n                      </Tooltip>\n                    ))}\n                  </div>\n                </>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {showBookmarks && (\n          <Card className=\"mb-6 animate-in slide-in-from-top-2\">\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"text-lg flex items-center gap-2\">\n                  <Bookmark className=\"w-5 h-5\" />\n                  Bookmarked Sentences\n                  {bookmarks.length > 0 && (\n                    <Badge variant=\"secondary\" className=\"ml-2\">\n                      {bookmarks.length} saved\n                    </Badge>\n                  )}\n                </CardTitle>\n                <Button variant=\"ghost\" size=\"sm\" onClick={() => setShowBookmarks(false)}>\n                  <X className=\"w-4 h-4\" />\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent className=\"max-h-64 overflow-y-auto\">\n              {bookmarks.length === 0 ? (\n                <div className=\"text-center py-8\">\n                  <div className=\"bg-muted/50 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center\">\n                    <Bookmark className=\"w-8 h-8 text-muted-foreground\" />\n                  </div>\n                  <h4 className=\"font-medium text-muted-foreground mb-2\">No Bookmarks Yet</h4>\n                  <p className=\"text-sm text-muted-foreground/70 max-w-xs mx-auto\">\n                    Bookmark sentences you want to practice again later. Click the bookmark icon after completing a test.\n                  </p>\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {bookmarks.map((bookmark) => (\n                    <div key={bookmark.id} className=\"p-3 bg-muted/50 rounded-lg group\">\n                      <div className=\"flex items-center justify-between mb-2\">\n                        <div className=\"flex items-center gap-2\">\n                          <Badge variant=\"outline\" className=\"text-xs capitalize\">\n                            {bookmark.difficulty}\n                          </Badge>\n                          <Badge variant=\"secondary\" className=\"text-xs capitalize\">\n                            {bookmark.category}\n                          </Badge>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <Button \n                                variant=\"ghost\" \n                                size=\"sm\" \n                                onClick={() => practiceBookmarkedSentence(bookmark)}\n                                className=\"h-7 px-2\"\n                              >\n                                <RotateCcw className=\"w-3.5 h-3.5\" />\n                              </Button>\n                            </TooltipTrigger>\n                            <TooltipContent>Practice this sentence</TooltipContent>\n                          </Tooltip>\n                          <Tooltip>\n                            <TooltipTrigger asChild>\n                              <Button \n                                variant=\"ghost\" \n                                size=\"sm\" \n                                onClick={() => setBookmarks(removeBookmark(bookmark.id))}\n                                className=\"h-7 px-2 text-destructive hover:text-destructive\"\n                              >\n                                <X className=\"w-3.5 h-3.5\" />\n                              </Button>\n                            </TooltipTrigger>\n                            <TooltipContent>Remove bookmark</TooltipContent>\n                          </Tooltip>\n                        </div>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground\">{bookmark.sentence}</p>\n                      {bookmark.lastAccuracy !== undefined && (\n                        <p className=\"text-xs text-muted-foreground/70 mt-1\">\n                          Last accuracy: {bookmark.lastAccuracy}%\n                        </p>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {showSettings && (\n          <Card className=\"mb-6 animate-in slide-in-from-top-2\">\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex items-center justify-between\">\n                <CardTitle className=\"text-lg flex items-center gap-2\">\n                  <Settings2 className=\"w-5 h-5\" />\n                  Settings\n                </CardTitle>\n                <Button variant=\"ghost\" size=\"sm\" onClick={() => setShowSettings(false)}>\n                  <X className=\"w-4 h-4\" />\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-4\">\n                <div>\n                  <label className=\"text-sm font-medium mb-2 block\">Voice Style</label>\n                  <Select \n                    value={currentOpenAIVoice} \n                    onValueChange={setOpenAIVoice}\n                  >\n                    <SelectTrigger data-testid=\"select-voice-style\">\n                      <SelectValue placeholder=\"Select voice style\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {openAIVoices.map((voice) => (\n                        <SelectItem key={voice.id} value={voice.id}>\n                          {voice.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <p className=\"text-xs text-muted-foreground mt-1\">\n                    Choose your preferred voice style\n                  </p>\n                </div>\n\n                {practiceMode === 'focus' && (\n                  <div className=\"pt-4 border-t\">\n                    <h4 className=\"text-sm font-medium mb-3 flex items-center gap-2\">\n                      <Maximize2 className=\"w-4 h-4 text-primary\" />\n                      Zen Mode Theme\n                    </h4>\n                    <div className=\"grid grid-cols-2 sm:grid-cols-4 gap-2\">\n                      {Object.entries(ZEN_THEMES).map(([key, t]) => (\n                        <button\n                          key={key}\n                          onClick={() => setZenTheme(key as ZenTheme)}\n                          className={`p-3 rounded-lg text-center transition-all ${\n                            zenTheme === key \n                              ? 'ring-2 ring-primary scale-105' \n                              : 'opacity-70 hover:opacity-100'\n                          }`}\n                          style={{ background: t.gradient }}\n                          data-testid={`settings-zen-theme-${key}`}\n                        >\n                          <div className=\"flex items-center justify-center gap-2 text-white\">\n                            {t.icon}\n                            <span className=\"text-xs font-medium\">{t.name}</span>\n                          </div>\n                        </button>\n                      ))}\n                    </div>\n                    <div className=\"flex items-center justify-between mt-3\">\n                      <p className=\"text-xs text-muted-foreground\">\n                        Choose your calming background for Zen Mode\n                      </p>\n                      <Button\n                        size=\"sm\"\n                        onClick={enterZenMode}\n                        className=\"gap-2\"\n                        data-testid=\"settings-button-enter-zen\"\n                      >\n                        <Maximize2 className=\"w-3 h-3\" />\n                        Enter Zen\n                      </Button>\n                    </div>\n                  </div>\n                )}\n\n                <div className=\"pt-4 border-t\">\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <h4 className=\"text-sm font-medium flex items-center gap-2\">\n                        <TrendingUp className=\"w-4 h-4 text-primary\" />\n                        Adaptive Difficulty\n                      </h4>\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        Automatically adjust difficulty based on your performance\n                      </p>\n                    </div>\n                    <Button\n                      variant={adaptiveDifficulty.enabled ? \"default\" : \"outline\"}\n                      size=\"sm\"\n                      onClick={() => {\n                        setAdaptiveDifficulty(prev => ({\n                          ...prev,\n                          enabled: !prev.enabled,\n                          currentLevel: difficulty as 'easy' | 'medium' | 'hard',\n                          consecutiveHighScores: 0,\n                          consecutiveLowScores: 0,\n                          recentScores: [],\n                        }));\n                        toast({\n                          title: adaptiveDifficulty.enabled ? 'Adaptive Difficulty Disabled' : 'Adaptive Difficulty Enabled',\n                          description: adaptiveDifficulty.enabled \n                            ? 'Difficulty will stay at your selected level.' \n                            : 'Difficulty will adjust based on your accuracy and speed.',\n                        });\n                      }}\n                      data-testid=\"button-toggle-adaptive\"\n                    >\n                      {adaptiveDifficulty.enabled ? 'On' : 'Off'}\n                    </Button>\n                  </div>\n                  {adaptiveDifficulty.enabled && (\n                    <div className=\"mt-3 p-3 bg-primary/5 rounded-lg\">\n                      <div className=\"flex items-center justify-between text-sm\">\n                        <span className=\"text-muted-foreground\">Current Level:</span>\n                        <span className=\"font-medium flex items-center gap-1\">\n                          {getDifficultyEmoji(adaptiveDifficulty.currentLevel)} \n                          {adaptiveDifficulty.currentLevel.charAt(0).toUpperCase() + adaptiveDifficulty.currentLevel.slice(1)}\n                        </span>\n                      </div>\n                      <div className=\"flex items-center justify-between text-sm mt-1\">\n                        <span className=\"text-muted-foreground\">Progress to upgrade:</span>\n                        <span className=\"font-medium\">\n                          {adaptiveDifficulty.consecutiveHighScores}/{ADAPTIVE_THRESHOLDS.upgradeConsecutive} high scores\n                        </span>\n                      </div>\n                      <p className=\"text-xs text-muted-foreground mt-2\">\n                        Score 90%+ accuracy with 30+ WPM {ADAPTIVE_THRESHOLDS.upgradeConsecutive}x to level up\n                      </p>\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"pt-4 border-t\">\n                  <h4 className=\"text-sm font-medium mb-3 flex items-center gap-2\">\n                    <Flame className=\"w-4 h-4 text-orange-500\" />\n                    Streak Stats\n                  </h4>\n                  <div className=\"grid grid-cols-3 gap-3\">\n                    <div className=\"text-center p-3 bg-orange-500/10 rounded-lg\">\n                      <div className=\"text-xl font-bold text-orange-500\">{streakData.currentStreak}</div>\n                      <div className=\"text-xs text-muted-foreground\">Current</div>\n                    </div>\n                    <div className=\"text-center p-3 bg-yellow-500/10 rounded-lg\">\n                      <div className=\"text-xl font-bold text-yellow-600\">{streakData.longestStreak}</div>\n                      <div className=\"text-xs text-muted-foreground\">Best</div>\n                    </div>\n                    <div className=\"text-center p-3 bg-blue-500/10 rounded-lg\">\n                      <div className=\"text-xl font-bold text-blue-500\">{streakData.totalSessions}</div>\n                      <div className=\"text-xs text-muted-foreground\">Total</div>\n                    </div>\n                  </div>\n                </div>\n\n                <div className=\"pt-4 border-t\">\n                  <h4 className=\"text-sm font-medium mb-2\">Keyboard Shortcuts</h4>\n                  <div className=\"grid grid-cols-2 gap-2 text-sm\">\n                    <div className=\"flex items-center gap-2\">\n                      <kbd className=\"px-2 py-1 bg-muted rounded text-xs font-mono\">R</kbd>\n                      <span className=\"text-muted-foreground\">Replay audio</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <kbd className=\"px-2 py-1 bg-muted rounded text-xs font-mono\">H</kbd>\n                      <span className=\"text-muted-foreground\">Toggle hint</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <kbd className=\"px-2 py-1 bg-muted rounded text-xs font-mono\">N</kbd>\n                      <span className=\"text-muted-foreground\">Next sentence</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <kbd className=\"px-2 py-1 bg-muted rounded text-xs font-mono\">Ctrl+Enter</kbd>\n                      <span className=\"text-muted-foreground\">Submit</span>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        <Card className=\"mb-6\">\n          <CardContent className=\"pt-6\">\n            <div className=\"flex items-center justify-between mb-2\">\n              <span className=\"text-sm font-medium flex items-center gap-1\">\n                Progress\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <span\n                      className=\"inline-flex cursor-help focus:outline-none focus:ring-2 focus:ring-primary/50 rounded-full\"\n                      tabIndex={0}\n                      role=\"button\"\n                      aria-label=\"Progress information\"\n                    >\n                      <HelpCircle className=\"w-3.5 h-3.5 text-muted-foreground\" />\n                    </span>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Complete {sessionLength} dictation tests to finish the session</p>\n                  </TooltipContent>\n                </Tooltip>\n              </span>\n              <span className=\"text-sm text-muted-foreground\" data-testid=\"text-progress\">\n                {sessionProgress} / {sessionLength}\n              </span>\n            </div>\n            <Progress value={(sessionProgress / sessionLength) * 100} className=\"h-2\" />\n          </CardContent>\n        </Card>\n\n      {!testState.isComplete ? (\n        <>\n          <Card className=\"mb-6 bg-muted/30\">\n            <CardContent className=\"pt-5 pb-5\">\n              <div className=\"flex items-center justify-between mb-4\">\n                <h3 className=\"text-sm font-semibold flex items-center gap-2\">\n                  <Sparkles className=\"w-4 h-4 text-primary\" />\n                  Settings\n                </h3>\n                <Badge variant=\"outline\" className=\"text-xs\">\n                  {testState.replayCount} replays\n                </Badge>\n              </div>\n              \n              <div className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm font-medium flex items-center gap-2\">\n                      <Volume2 className=\"w-4 h-4 text-muted-foreground\" />\n                      Speech Speed\n                    </span>\n                    <Badge variant=\"secondary\" className=\"font-mono text-base px-3 py-1\">\n                      {currentRate.toFixed(1)}x\n                    </Badge>\n                  </div>\n                  <Slider\n                    value={[parseFloat(speedLevel) || 1.0]}\n                    onValueChange={(value) => setSpeedLevel(value[0].toString())}\n                    min={0.5}\n                    max={2.0}\n                    step={0.1}\n                    disabled={isLoading || isSpeaking}\n                    className=\"w-full\"\n                    data-testid=\"slider-speed\"\n                    aria-label=\"Adjust speech speed from 0.5x to 2.0x\"\n                  />\n                  <div className=\"flex justify-between text-xs text-muted-foreground px-1\">\n                    <span>Slower</span>\n                    <span>Normal</span>\n                    <span>Faster</span>\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3\">\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div className=\"space-y-1.5\">\n                        <label className=\"text-xs font-medium text-muted-foreground flex items-center gap-1\">\n                          Difficulty\n                          {adaptiveDifficulty.enabled && (\n                            <span className=\"text-[10px] px-1.5 py-0.5 bg-primary/20 text-primary rounded-full font-medium\">\n                              AUTO\n                            </span>\n                          )}\n                        </label>\n                        <Select \n                          value={difficulty} \n                          onValueChange={(val) => {\n                            setDifficulty(val);\n                            if (adaptiveDifficulty.enabled) {\n                              setAdaptiveDifficulty(prev => ({\n                                ...prev,\n                                currentLevel: val as 'easy' | 'medium' | 'hard',\n                                consecutiveHighScores: 0,\n                                consecutiveLowScores: 0,\n                              }));\n                            }\n                          }} \n                          disabled={isLoading || isSpeaking}\n                        >\n                          <SelectTrigger data-testid=\"select-difficulty\" className=\"h-10\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"easy\">{getDifficultyEmoji('easy')} Easy</SelectItem>\n                            <SelectItem value=\"medium\">{getDifficultyEmoji('medium')} Medium</SelectItem>\n                            <SelectItem value=\"hard\">{getDifficultyEmoji('hard')} Hard</SelectItem>\n                          </SelectContent>\n                        </Select>\n                        {difficultyJustChanged && (\n                          <div className={`text-xs mt-1 flex items-center gap-1 ${\n                            difficultyJustChanged.direction === 'up' ? 'text-green-500' : 'text-orange-500'\n                          }`}>\n                            {difficultyJustChanged.direction === 'up' ? 'â†‘' : 'â†“'}\n                            Changed from {difficultyJustChanged.from} to {difficultyJustChanged.to}\n                          </div>\n                        )}\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p className=\"max-w-xs\">Easy: Short sentences â€¢ Medium: Standard â€¢ Hard: Complex vocabulary</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  \n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div className=\"space-y-1.5\">\n                        <label className=\"text-xs font-medium text-muted-foreground\">Voice</label>\n                        <Select \n                          value={currentVoice?.voiceURI || ''} \n                          onValueChange={handleVoiceChange}\n                          disabled={isLoading || isSpeaking || englishVoices.length === 0}\n                        >\n                          <SelectTrigger data-testid=\"select-voice\" className=\"h-10\">\n                            <SelectValue placeholder={englishVoices.length === 0 ? \"Loading...\" : \"Voice\"} />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {englishVoices.length === 0 ? (\n                              <SelectItem value=\"loading\" disabled>Loading voices...</SelectItem>\n                            ) : (\n                              englishVoices\n                                .filter((voice) => voice.voiceURI && voice.voiceURI.trim() !== '')\n                                .map((voice) => (\n                                  <SelectItem key={voice.voiceURI} value={voice.voiceURI}>\n                                    {voice.name.split(' ').slice(0, 2).join(' ')}\n                                  </SelectItem>\n                                ))\n                            )}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>Choose your preferred voice accent</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  \n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div className=\"space-y-1.5\">\n                        <label className=\"text-xs font-medium text-muted-foreground\">Topic</label>\n                        <Select value={category} onValueChange={setCategory} disabled={isLoading || isSpeaking}>\n                          <SelectTrigger data-testid=\"select-category\" className=\"h-10\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {CATEGORIES.map((cat) => (\n                              <SelectItem key={cat.value} value={cat.value}>\n                                {cat.label}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>Filter sentences by topic category</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  \n                  <div className=\"flex items-end\">\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Button \n                          variant=\"outline\" \n                          className=\"w-full h-10\"\n                          onClick={restartCurrentSession}\n                          disabled={isLoading || isSpeaking}\n                        >\n                          <RotateCcw className=\"w-4 h-4 mr-2\" />\n                          Restart\n                        </Button>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p>Restart current session from beginning</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                  \n                  <div className=\"flex items-end\">\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <Button \n                          variant=\"ghost\" \n                          className=\"w-full h-10\"\n                          onClick={resetSession}\n                          disabled={isLoading || isSpeaking}\n                        >\n                          <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                          Exit Mode\n                        </Button>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p>Return to mode selection</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"mb-6 overflow-hidden\">\n            <CardContent className=\"pt-8 pb-8\">\n              <div className=\"text-center\">\n                {isSpeaking ? (\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div \n                        className=\"flex flex-col items-center justify-center cursor-default focus:outline-none focus:ring-2 focus:ring-primary/50 rounded-2xl p-6\"\n                        tabIndex={0}\n                        role=\"status\"\n                        aria-label=\"Audio is playing\"\n                        aria-live=\"polite\"\n                      >\n                        <div className=\"relative mb-6\">\n                          <div className=\"absolute inset-0 bg-primary/20 rounded-full animate-ping\" style={{ animationDuration: '1.5s' }}></div>\n                          <div className=\"absolute inset-0 bg-primary/10 rounded-full animate-pulse\" style={{ animationDuration: '1s' }}></div>\n                          <div className=\"relative bg-gradient-to-br from-primary/30 to-primary/10 p-8 rounded-full border-4 border-primary/50 shadow-lg shadow-primary/20\">\n                            <Mic className=\"w-20 h-20 text-primary\" />\n                          </div>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <p className=\"text-2xl font-bold text-primary\" data-testid=\"text-speaking\">\n                            Listening...\n                          </p>\n                          <p className=\"text-base text-muted-foreground\">\n                            Pay attention to what's being said\n                          </p>\n                        </div>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent className=\"max-w-xs\">\n                      <p className=\"font-medium mb-1\">Audio Playing</p>\n                      <p className=\"text-xs opacity-90\">Listen carefully to the sentence. You can replay it after it finishes.</p>\n                    </TooltipContent>\n                  </Tooltip>\n                ) : testState.startTime ? (\n                  <div className=\"flex flex-col items-center justify-center\">\n                    <Tooltip>\n                      <TooltipTrigger asChild>\n                        <div \n                          className=\"flex flex-col items-center cursor-default focus:outline-none focus:ring-2 focus:ring-green-500/50 rounded-2xl p-6\"\n                          tabIndex={0}\n                          role=\"status\"\n                          aria-label=\"Ready to type\"\n                        >\n                          <div className=\"relative mb-6\">\n                            <div className=\"bg-gradient-to-br from-green-500/30 to-green-500/10 p-6 rounded-full border-4 border-green-500/50 shadow-lg shadow-green-500/20\">\n                              <Volume2 className=\"w-16 h-16 text-green-500\" />\n                            </div>\n                            <div className=\"absolute -top-1 -right-1 bg-green-500 text-white rounded-full p-1.5\">\n                              <Check className=\"w-4 h-4\" />\n                            </div>\n                          </div>\n                          <div className=\"space-y-2\">\n                            <p className=\"text-2xl font-bold text-green-500\" data-testid=\"text-ready\">\n                              Ready to Type!\n                            </p>\n                            <p className=\"text-base text-muted-foreground\">\n                              Type what you heard in the box below\n                            </p>\n                          </div>\n                        </div>\n                      </TooltipTrigger>\n                      <TooltipContent className=\"max-w-xs\">\n                        <p className=\"font-medium mb-1\">Ready to Type</p>\n                        <p className=\"text-xs opacity-90\">The audio has finished. Type what you heard in the text area below.</p>\n                      </TooltipContent>\n                    </Tooltip>\n                    {testState.showHint && testState.sentence && (\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <div \n                            className=\"mt-6 p-5 bg-gradient-to-r from-primary/10 to-primary/5 rounded-xl max-w-2xl cursor-help focus:outline-none focus:ring-2 focus:ring-primary/50 border border-primary/20\"\n                            tabIndex={0}\n                            role=\"note\"\n                            aria-label=\"Hint showing the target sentence\"\n                          >\n                            <div className=\"flex items-center gap-2 mb-3\">\n                              <Eye className=\"w-4 h-4 text-primary\" />\n                              <p className=\"text-sm font-semibold text-primary\">Hint</p>\n                            </div>\n                            <p className=\"text-lg font-mono text-foreground leading-relaxed\" data-testid=\"text-hint\">\n                              {testState.sentence.sentence}\n                            </p>\n                          </div>\n                        </TooltipTrigger>\n                        <TooltipContent className=\"max-w-xs\">\n                          <p className=\"font-medium mb-1\">Sentence Hint</p>\n                          <p className=\"text-xs opacity-90\">This is the actual sentence. Using hints may affect your practice score.</p>\n                        </TooltipContent>\n                      </Tooltip>\n                    )}\n                  </div>\n                ) : (\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div \n                        className=\"flex flex-col items-center justify-center cursor-default focus:outline-none focus:ring-2 focus:ring-primary/50 rounded-2xl p-6\"\n                        tabIndex={0}\n                        role=\"status\"\n                        aria-label=\"Loading next sentence\"\n                        aria-live=\"polite\"\n                      >\n                        <div className=\"relative mb-6\">\n                          <div className=\"bg-gradient-to-br from-muted to-muted/50 p-6 rounded-full border-4 border-muted-foreground/20\">\n                            <div className=\"w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin\"></div>\n                          </div>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <p className=\"text-xl font-semibold text-muted-foreground\">Preparing...</p>\n                          <p className=\"text-sm text-muted-foreground/70\">Getting your next sentence ready</p>\n                        </div>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>Preparing the next sentence...</p>\n                    </TooltipContent>\n                  </Tooltip>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"mb-6\">\n            <CardContent className=\"pt-6\">\n              <label className=\"text-sm font-medium mb-3 block flex items-center gap-2\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <span \n                      className=\"cursor-help flex items-center gap-1 focus:outline-none focus:ring-2 focus:ring-primary/50 rounded px-1\"\n                      tabIndex={0}\n                      role=\"button\"\n                      aria-label=\"Typing area help information\"\n                    >\n                      Type what you heard:\n                      <HelpCircle className=\"w-3.5 h-3.5 text-muted-foreground\" />\n                    </span>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"font-medium mb-1\">Typing Area</p>\n                    <p className=\"text-xs opacity-90\">Type the sentence exactly as you heard it. Punctuation and capitalization matter for accuracy!</p>\n                  </TooltipContent>\n                </Tooltip>\n                {testState.startTime && !isSpeaking && (\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <span className={`text-xs flex items-center gap-2 cursor-help transition-colors ${\n                        PRACTICE_MODES[practiceMode].timerPressure\n                          ? elapsedTime > 45 ? 'text-red-600' : elapsedTime > 30 ? 'text-orange-500' : elapsedTime > 15 ? 'text-yellow-600' : 'text-green-600'\n                          : 'text-green-600'\n                      }`}>\n                        <span className=\"flex items-center gap-1\">\n                          <span className={`w-2 h-2 rounded-full animate-pulse ${\n                            PRACTICE_MODES[practiceMode].timerPressure\n                              ? elapsedTime > 45 ? 'bg-red-600' : elapsedTime > 30 ? 'bg-orange-500' : elapsedTime > 15 ? 'bg-yellow-600' : 'bg-green-600'\n                              : 'bg-green-600'\n                          }`}></span>\n                          {PRACTICE_MODES[practiceMode].timerPressure && elapsedTime > 30 ? 'Hurry up!' : 'Timer running'}\n                        </span>\n                        <span className={`font-mono px-2 py-0.5 rounded ${\n                          PRACTICE_MODES[practiceMode].timerPressure\n                            ? elapsedTime > 45 ? 'bg-red-500/20' : elapsedTime > 30 ? 'bg-orange-500/20' : elapsedTime > 15 ? 'bg-yellow-500/20' : 'bg-green-500/10'\n                            : 'bg-green-500/10'\n                        }`}>\n                          {Math.floor(elapsedTime / 60)}:{(elapsedTime % 60).toString().padStart(2, '0')}\n                        </span>\n                      </span>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>{PRACTICE_MODES[practiceMode].timerPressure \n                        ? 'Challenge mode: Complete quickly for bonus points!' \n                        : 'Time elapsed since audio finished. Type your answer now!'}\n                      </p>\n                    </TooltipContent>\n                  </Tooltip>\n                )}\n              </label>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"relative\">\n                    <Textarea\n                      ref={inputRef}\n                      value={testState.typedText}\n                      onChange={(e) => setTestState(prev => ({ ...prev, typedText: e.target.value }))}\n                      onKeyDown={(e) => {\n                        if (e.key === 'Enter' && e.ctrlKey && !isSpeaking && testState.startTime) {\n                          e.preventDefault();\n                          handleSubmit();\n                        }\n                      }}\n                      placeholder=\"Type here... (Ctrl+Enter to submit)\"\n                      className=\"text-lg p-4 min-h-[120px] resize-none\"\n                      autoComplete=\"off\"\n                      autoCorrect=\"off\"\n                      autoCapitalize=\"off\"\n                      spellCheck=\"false\"\n                      data-testid=\"input-typed-text\"\n                    />\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent side=\"top\" className=\"max-w-xs\">\n                  <p className=\"text-xs\">Auto-correct and spell-check are disabled for accurate practice</p>\n                </TooltipContent>\n              </Tooltip>\n              <div className=\"flex items-center justify-between mt-2\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <span \n                      className=\"text-xs text-muted-foreground cursor-help focus:outline-none focus:ring-1 focus:ring-primary/50 rounded px-1\"\n                      tabIndex={0}\n                      role=\"status\"\n                      aria-label={`${testState.typedText.length} characters typed`}\n                    >\n                      {testState.typedText.length} characters\n                    </span>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Total characters you've typed so far</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <span \n                      className=\"text-xs text-muted-foreground cursor-help flex items-center gap-1 focus:outline-none focus:ring-1 focus:ring-primary/50 rounded px-1\"\n                      tabIndex={0}\n                      role=\"note\"\n                      aria-label=\"Press Control plus Enter to submit\"\n                    >\n                      <kbd className=\"px-1.5 py-0.5 bg-muted rounded text-[10px] font-mono\">Ctrl</kbd>\n                      <span>+</span>\n                      <kbd className=\"px-1.5 py-0.5 bg-muted rounded text-[10px] font-mono\">Enter</kbd>\n                      <span>to submit</span>\n                    </span>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Keyboard shortcut to quickly submit your answer</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"mb-4 bg-gradient-to-r from-muted/50 to-muted/30\">\n            <CardContent className=\"py-4\">\n              <div className=\"flex gap-3 justify-center flex-wrap items-center\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button\n                      onClick={handleReplay}\n                      disabled={!testState.sentence || isSpeaking}\n                      variant=\"outline\"\n                      size=\"lg\"\n                      className=\"h-12 px-6 text-base\"\n                      data-testid=\"button-replay\"\n                    >\n                      <RotateCcw className=\"w-5 h-5 mr-2\" />\n                      Replay\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Listen to the sentence again (press R)</p>\n                  </TooltipContent>\n                </Tooltip>\n                {PRACTICE_MODES[practiceMode].hintsAllowed && (\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        onClick={toggleHint}\n                        disabled={!testState.sentence || isSpeaking}\n                        variant=\"outline\"\n                        size=\"lg\"\n                        className=\"h-12 px-6 text-base\"\n                        data-testid=\"button-hint\"\n                      >\n                        {testState.showHint ? <EyeOff className=\"w-5 h-5 mr-2\" /> : <Eye className=\"w-5 h-5 mr-2\" />}\n                        {testState.showHint ? 'Hide' : 'Hint'}\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>Show the sentence text (press H)</p>\n                    </TooltipContent>\n                  </Tooltip>\n                )}\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button\n                      onClick={handleSubmit}\n                      disabled={!testState.typedText.trim() || isSpeaking || !testState.startTime}\n                      size=\"lg\"\n                      className=\"h-12 px-8 text-base font-semibold shadow-lg shadow-primary/20\"\n                      data-testid=\"button-submit\"\n                    >\n                      <Check className=\"w-5 h-5 mr-2\" />\n                      Submit\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Submit your answer (Ctrl+Enter)</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <Button\n                      onClick={() => setShowKeyboardGuide(!showKeyboardGuide)}\n                      variant=\"ghost\"\n                      size=\"lg\"\n                      className=\"h-12\"\n                      data-testid=\"button-keyboard-guide\"\n                    >\n                      <HelpCircle className=\"w-5 h-5\" />\n                    </Button>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>Keyboard shortcuts</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n            </CardContent>\n          </Card>\n\n          {showKeyboardGuide && (\n            <Card className=\"mt-4\">\n              <CardContent className=\"pt-6\">\n                <div className=\"flex items-center gap-2 mb-3\">\n                  <h3 className=\"font-semibold\">Keyboard Shortcuts</h3>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <span\n                        className=\"inline-flex cursor-help focus:outline-none focus:ring-2 focus:ring-primary/50 rounded-full\"\n                        tabIndex={0}\n                        role=\"button\"\n                        aria-label=\"Keyboard shortcuts help\"\n                      >\n                        <HelpCircle className=\"w-4 h-4 text-muted-foreground\" />\n                      </span>\n                    </TooltipTrigger>\n                    <TooltipContent className=\"max-w-xs\">\n                      <p className=\"text-xs\">Use these shortcuts to navigate faster without using your mouse</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm\">\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div \n                        className=\"flex items-center justify-between p-2 bg-muted/30 rounded cursor-help hover:bg-muted/50 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/50\"\n                        tabIndex={0}\n                        role=\"listitem\"\n                        aria-label=\"Submit answer shortcut: Control plus Enter\"\n                      >\n                        <span>Submit Answer</span>\n                        <kbd className=\"px-2 py-1 bg-background border rounded text-xs font-mono\">Ctrl + Enter</kbd>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p className=\"text-xs\">Hold Ctrl and press Enter to submit your answer quickly</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div \n                        className=\"flex items-center justify-between p-2 bg-muted/30 rounded cursor-help hover:bg-muted/50 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/50\"\n                        tabIndex={0}\n                        role=\"listitem\"\n                        aria-label=\"Replay audio shortcut: R key\"\n                      >\n                        <span>Replay Audio</span>\n                        <kbd className=\"px-2 py-1 bg-background border rounded text-xs font-mono\">R</kbd>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p className=\"text-xs\">Press R (when not typing) to replay the audio</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div \n                        className=\"flex items-center justify-between p-2 bg-muted/30 rounded cursor-help hover:bg-muted/50 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/50\"\n                        tabIndex={0}\n                        role=\"listitem\"\n                        aria-label=\"Toggle hint shortcut: H key\"\n                      >\n                        <span>Toggle Hint</span>\n                        <kbd className=\"px-2 py-1 bg-background border rounded text-xs font-mono\">H</kbd>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p className=\"text-xs\">Press H (when not typing) to show/hide the hint</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div \n                        className=\"flex items-center justify-between p-2 bg-muted/30 rounded cursor-help hover:bg-muted/50 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/50\"\n                        tabIndex={0}\n                        role=\"listitem\"\n                        aria-label=\"Focus text box shortcut: Tab\"\n                      >\n                        <span>Focus Text Box</span>\n                        <kbd className=\"px-2 py-1 bg-background border rounded text-xs font-mono\">Tab</kbd>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p className=\"text-xs\">Press Tab to quickly jump to the typing area</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {speechError && (\n            <Card className=\"mt-4 border-destructive\">\n              <CardContent className=\"pt-6\">\n                <p className=\"text-sm text-destructive\">{speechError}</p>\n              </CardContent>\n            </Card>\n          )}\n        </>\n      ) : (\n        <div className=\"space-y-6\">\n          <Card>\n            <CardContent className=\"pt-8 pb-8\">\n              <div className=\"text-center mb-6\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <h2 \n                      className=\"text-2xl font-bold mb-2 cursor-default focus:outline-none focus:ring-2 focus:ring-primary/50 rounded-lg px-2 inline-block\"\n                      tabIndex={0}\n                      role=\"heading\"\n                      aria-label=\"Test result feedback\"\n                    >\n                      {testState.result && testState.result.accuracy >= 90 ? 'ðŸŽ‰ Excellent!' : \n                       testState.result && testState.result.accuracy >= 70 ? 'ðŸ‘ Good Job!' : 'ðŸ’ª Keep Practicing!'}\n                    </h2>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"text-xs\">\n                      {testState.result && testState.result.accuracy >= 90 \n                        ? 'Outstanding performance! You have excellent listening and typing skills.' \n                        : testState.result && testState.result.accuracy >= 70 \n                        ? 'Good work! Keep practicing to improve further.' \n                        : 'Practice makes perfect! Try again to improve your accuracy.'}\n                    </p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div \n                      className=\"text-center cursor-help p-2 rounded-lg transition-colors hover:bg-primary/5 focus:outline-none focus:ring-2 focus:ring-primary/50\"\n                      tabIndex={0}\n                      role=\"group\"\n                      aria-label={`Words per minute: ${testState.result?.wpm}`}\n                    >\n                      <div className=\"text-3xl font-bold text-primary\" data-testid=\"text-result-wpm\">\n                        {testState.result?.wpm}\n                      </div>\n                      <div className=\"text-sm text-muted-foreground\">WPM</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"font-medium mb-1\">Words Per Minute</p>\n                    <p className=\"text-xs opacity-90\">Your typing speed calculated from characters typed. Average typists achieve 40-60 WPM.</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div \n                      className=\"text-center cursor-help p-2 rounded-lg transition-colors hover:bg-green-500/5 focus:outline-none focus:ring-2 focus:ring-green-500/50\"\n                      tabIndex={0}\n                      role=\"group\"\n                      aria-label={`Accuracy: ${testState.result?.accuracy} percent`}\n                    >\n                      <div className=\"text-3xl font-bold text-green-600\" data-testid=\"text-result-accuracy\">\n                        {testState.result?.accuracy}%\n                      </div>\n                      <div className=\"text-sm text-muted-foreground\">Accuracy</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"font-medium mb-1\">Transcription Accuracy</p>\n                    <p className=\"text-xs opacity-90\">Percentage of characters you typed correctly. 95%+ is excellent!</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div \n                      className=\"text-center cursor-help p-2 rounded-lg transition-colors hover:bg-orange-500/5 focus:outline-none focus:ring-2 focus:ring-orange-500/50\"\n                      tabIndex={0}\n                      role=\"group\"\n                      aria-label={`Errors: ${testState.result?.errors}`}\n                    >\n                      <div className=\"text-3xl font-bold text-orange-600\" data-testid=\"text-result-errors\">\n                        {testState.result?.errors}\n                      </div>\n                      <div className=\"text-sm text-muted-foreground\">Errors</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"font-medium mb-1\">Character Errors</p>\n                    <p className=\"text-xs opacity-90\">Total number of incorrect, missing, or extra characters. Lower is better!</p>\n                  </TooltipContent>\n                </Tooltip>\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div \n                      className=\"text-center cursor-help p-2 rounded-lg transition-colors hover:bg-muted/50 focus:outline-none focus:ring-2 focus:ring-primary/50\"\n                      tabIndex={0}\n                      role=\"group\"\n                      aria-label={`Time taken: ${testState.result?.duration} seconds`}\n                    >\n                      <div className=\"text-3xl font-bold\" data-testid=\"text-result-duration\">\n                        {testState.result?.duration}s\n                      </div>\n                      <div className=\"text-sm text-muted-foreground\">Time</div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-xs\">\n                    <p className=\"font-medium mb-1\">Time Taken</p>\n                    <p className=\"text-xs opacity-90\">Total seconds from when the audio finished to when you submitted.</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n\n              <div className=\"space-y-4\">\n                {testState.result && testState.result.wordDiff && (\n                  <div>\n                    <div className=\"flex items-center justify-between mb-2\">\n                      <Tooltip>\n                        <TooltipTrigger asChild>\n                          <span \n                            className=\"text-sm font-medium cursor-help inline-flex items-center gap-1 focus:outline-none focus:ring-2 focus:ring-primary/50 rounded px-1\"\n                            tabIndex={0}\n                            role=\"button\"\n                            aria-label=\"Word analysis help\"\n                          >\n                            Word-by-Word Analysis:\n                            <HelpCircle className=\"w-3.5 h-3.5 text-muted-foreground\" />\n                          </span>\n                        </TooltipTrigger>\n                        <TooltipContent className=\"max-w-xs\">\n                          <p className=\"font-medium mb-1\">Word Comparison</p>\n                          <p className=\"text-xs opacity-90\">Each word is color-coded. Capitalization and punctuation are ignored - focus on the words!</p>\n                        </TooltipContent>\n                      </Tooltip>\n                      <span className=\"text-xs text-muted-foreground\">\n                        {testState.result.correctWords}/{testState.result.totalWords} words correct\n                      </span>\n                    </div>\n                    <div className=\"p-4 bg-muted/30 rounded-md\">\n                      <div className=\"text-base leading-relaxed flex flex-wrap gap-1.5\">\n                        {testState.result.wordDiff.map((diff, idx) => (\n                          <Tooltip key={idx}>\n                            <TooltipTrigger asChild>\n                              <span\n                                className={`${\n                                  diff.status === 'correct' \n                                    ? 'bg-green-500/20 text-green-700 dark:text-green-400' \n                                    : diff.status === 'incorrect'\n                                    ? 'bg-red-500/20 text-red-700 dark:text-red-400'\n                                    : diff.status === 'missing'\n                                    ? 'bg-yellow-500/20 text-yellow-700 dark:text-yellow-400 italic'\n                                    : 'bg-orange-500/20 text-orange-700 dark:text-orange-400 line-through'\n                                } px-1.5 py-0.5 rounded cursor-help`}\n                              >\n                                {diff.word}\n                              </span>\n                            </TooltipTrigger>\n                            <TooltipContent>\n                              <p className=\"text-xs\">\n                                {diff.status === 'correct' ? 'Correct!' :\n                                 diff.status === 'incorrect' ? `You typed: \"${diff.typedWord}\"` :\n                                 diff.status === 'missing' ? 'You missed this word' :\n                                 'Extra word you added'}\n                              </p>\n                            </TooltipContent>\n                          </Tooltip>\n                        ))}\n                      </div>\n                      <div className=\"mt-4 flex gap-4 text-xs flex-wrap\" role=\"list\" aria-label=\"Color legend for word analysis\">\n                        <div className=\"flex items-center gap-1\">\n                          <span className=\"w-3 h-3 bg-green-500/20 rounded border border-green-500/30\"></span>\n                          <span className=\"text-muted-foreground\">Correct</span>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <span className=\"w-3 h-3 bg-red-500/20 rounded border border-red-500/30\"></span>\n                          <span className=\"text-muted-foreground\">Wrong</span>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <span className=\"w-3 h-3 bg-yellow-500/20 rounded border border-yellow-500/30\"></span>\n                          <span className=\"text-muted-foreground\">Missing</span>\n                        </div>\n                        <div className=\"flex items-center gap-1\">\n                          <span className=\"w-3 h-3 bg-orange-500/20 rounded border border-orange-500/30\"></span>\n                          <span className=\"text-muted-foreground\">Extra</span>\n                        </div>\n                      </div>\n                      <p className=\"mt-2 text-xs text-muted-foreground\">\n                        Capitalization and punctuation are ignored for easier comparison.\n                      </p>\n                    </div>\n                  </div>\n                )}\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div \n                        className=\"cursor-help focus:outline-none focus:ring-2 focus:ring-green-500/50 rounded-lg\"\n                        tabIndex={0}\n                        role=\"group\"\n                        aria-label=\"Original sentence that was spoken\"\n                      >\n                        <p className=\"text-sm font-medium mb-2 flex items-center gap-1\">\n                          Original sentence:\n                          <HelpCircle className=\"w-3.5 h-3.5 text-muted-foreground\" />\n                        </p>\n                        <div className=\"p-4 bg-green-500/10 rounded-md border border-green-500/20\">\n                          <p className=\"font-mono text-sm\" data-testid=\"text-correct-sentence\">\n                            {testState.sentence?.sentence}\n                          </p>\n                        </div>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent className=\"max-w-xs\">\n                      <p className=\"font-medium mb-1\">Target Sentence</p>\n                      <p className=\"text-xs opacity-90\">The exact sentence that was spoken. Compare this to what you typed.</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div \n                        className=\"cursor-help focus:outline-none focus:ring-2 focus:ring-blue-500/50 rounded-lg\"\n                        tabIndex={0}\n                        role=\"group\"\n                        aria-label=\"Your typed transcription\"\n                      >\n                        <p className=\"text-sm font-medium mb-2 flex items-center gap-1\">\n                          Your typing:\n                          <HelpCircle className=\"w-3.5 h-3.5 text-muted-foreground\" />\n                        </p>\n                        <div className=\"p-4 bg-blue-500/10 rounded-md border border-blue-500/20\">\n                          <p className=\"font-mono text-sm\" data-testid=\"text-your-typing\">\n                            {testState.typedText}\n                          </p>\n                        </div>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent className=\"max-w-xs\">\n                      <p className=\"font-medium mb-1\">Your Transcription</p>\n                      <p className=\"text-xs opacity-90\">What you typed based on what you heard. Compare to the original above.</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n\n                {testState.result && (\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div \n                        className=\"text-center p-4 bg-primary/5 rounded-lg cursor-help transition-all hover:bg-primary/10 focus:outline-none focus:ring-2 focus:ring-primary/50\"\n                        tabIndex={0}\n                        role=\"group\"\n                        aria-label={`Accuracy grade: ${getAccuracyGrade(testState.result.accuracy).grade}`}\n                      >\n                        <p className=\"text-sm text-muted-foreground mb-1\">Accuracy Grade</p>\n                        <p className={`text-4xl font-bold ${getAccuracyGrade(testState.result.accuracy).color}`}>\n                          {getAccuracyGrade(testState.result.accuracy).grade}\n                        </p>\n                        <p className=\"text-sm text-muted-foreground mt-1\">\n                          {getAccuracyGrade(testState.result.accuracy).message}\n                        </p>\n                        <p className=\"text-xs text-muted-foreground mt-2\">\n                          {testState.result.correctChars} / {testState.result.totalChars} characters correct\n                        </p>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent className=\"max-w-xs\">\n                      <p className=\"font-medium mb-1\">Performance Grade</p>\n                      <p className=\"text-xs opacity-90\">\n                        A+ (95%+) = Excellent | A (90%+) = Great | B (80%+) = Good | C (70%+) = Fair | D (60%+) = Needs Work | F (&lt;60%) = Keep Practicing\n                      </p>\n                    </TooltipContent>\n                  </Tooltip>\n                )}\n\n                {currentCoachingTip && (\n                  <div className={`p-4 rounded-lg flex items-start gap-3 ${\n                    currentCoachingTip.type === 'achievement' ? 'bg-yellow-500/10 border border-yellow-500/30' :\n                    currentCoachingTip.type === 'encouragement' ? 'bg-green-500/10 border border-green-500/30' :\n                    currentCoachingTip.type === 'improvement' ? 'bg-blue-500/10 border border-blue-500/30' :\n                    'bg-orange-500/10 border border-orange-500/30'\n                  }`}>\n                    <div className=\"mt-0.5\">{currentCoachingTip.icon}</div>\n                    <div>\n                      <p className=\"text-sm font-medium\">\n                        {currentCoachingTip.type === 'achievement' ? 'Achievement!' :\n                         currentCoachingTip.type === 'encouragement' ? 'Great work!' :\n                         currentCoachingTip.type === 'improvement' ? 'Tip for improvement' :\n                         'Heads up!'}\n                      </p>\n                      <p className=\"text-sm text-muted-foreground\">{currentCoachingTip.message}</p>\n                    </div>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"mt-6 text-center\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <p \n                      className=\"text-sm text-muted-foreground mb-4 cursor-help inline-block focus:outline-none focus:ring-1 focus:ring-primary/50 rounded px-2\"\n                      tabIndex={0}\n                      role=\"status\"\n                      aria-live=\"polite\"\n                    >\n                      {autoAdvanceCountdown !== null \n                        ? `Next sentence in ${autoAdvanceCountdown} second${autoAdvanceCountdown !== 1 ? 's' : ''}, or click to continue now`\n                        : 'Click to continue to next sentence'}\n                    </p>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p className=\"text-xs\">Auto-advancing to the next sentence</p>\n                  </TooltipContent>\n                </Tooltip>\n                <div className=\"flex items-center justify-center gap-3\">\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button \n                        variant=\"outline\" \n                        onClick={toggleBookmark}\n                        data-testid=\"button-bookmark\"\n                      >\n                        {testState.sentence && bookmarks.some(b => b.id === testState.sentence?.id) ? (\n                          <>\n                            <BookmarkCheck className=\"w-4 h-4 mr-2 text-primary\" />\n                            Bookmarked\n                          </>\n                        ) : (\n                          <>\n                            <Bookmark className=\"w-4 h-4 mr-2\" />\n                            Bookmark\n                          </>\n                        )}\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>Save this sentence for later practice</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button onClick={handleNextManual} data-testid=\"button-next\">\n                        <ChevronRight className=\"w-4 h-4 mr-2\" />\n                        Continue to Next\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent>\n                      <p>Skip the countdown and go to the next sentence immediately</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      <ShareModal\n        open={showShareModal}\n        onOpenChange={setShowShareModal}\n        mode=\"dictation\"\n        resultId={lastTestResultId}\n        stats={{\n          wpm: sessionStats.count > 0 ? Math.round(sessionStats.totalWpm / sessionStats.count) : 0,\n          accuracy: sessionStats.count > 0 ? Math.round(sessionStats.totalAccuracy / sessionStats.count) : 0,\n          errors: sessionStats.totalErrors,\n        }}\n      />\n      </div>\n    </TooltipProvider>\n  );\n}\n","path":null,"size_bytes":167049,"size_tokens":null},"server/seed-dictation.ts":{"content":"import { db } from \"./storage\";\nimport { dictationSentences } from \"@shared/schema\";\n\nconst sentences = [\n  // EASY - Simple 5-8 word sentences, common vocabulary (20 sentences)\n  {\n    sentence: \"The cat sleeps on the warm sofa.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 32,\n  },\n  {\n    sentence: \"I like to drink coffee in the morning.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 8,\n    characterCount: 38,\n  },\n  {\n    sentence: \"She reads a good book every night.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 34,\n  },\n  {\n    sentence: \"The sun shines brightly in the sky.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 35,\n  },\n  {\n    sentence: \"He walks to school with his friends.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 36,\n  },\n  {\n    sentence: \"My dog loves playing in the park.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 33,\n  },\n  {\n    sentence: \"We watch movies together on weekends.\",\n    difficulty: \"easy\",\n    category: \"entertainment\",\n    wordCount: 6,\n    characterCount: 37,\n  },\n  {\n    sentence: \"The flowers bloom beautifully in spring.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 6,\n    characterCount: 40,\n  },\n  {\n    sentence: \"I enjoy listening to music daily.\",\n    difficulty: \"easy\",\n    category: \"entertainment\",\n    wordCount: 6,\n    characterCount: 33,\n  },\n  {\n    sentence: \"They play soccer after school ends.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 6,\n    characterCount: 35,\n  },\n  {\n    sentence: \"My family goes camping every summer.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 6,\n    characterCount: 36,\n  },\n  {\n    sentence: \"The bakery sells fresh bread each morning.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 42,\n  },\n  {\n    sentence: \"She teaches children at the local school.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 41,\n  },\n  {\n    sentence: \"We celebrate birthdays with cake and gifts.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 43,\n  },\n  {\n    sentence: \"The train arrives at exactly seven o'clock.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 43,\n  },\n  {\n    sentence: \"He practices piano for one hour daily.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 38,\n  },\n  {\n    sentence: \"The library offers free books to everyone.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 42,\n  },\n  {\n    sentence: \"Birds sing cheerful songs in the trees.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 39,\n  },\n  {\n    sentence: \"I write letters to my best friend.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 34,\n  },\n  {\n    sentence: \"The ocean waves crash against the shore.\",\n    difficulty: \"easy\",\n    category: \"general\",\n    wordCount: 7,\n    characterCount: 40,\n  },\n\n  // MEDIUM - 10-15 word sentences, moderate complexity (25 sentences)\n  {\n    sentence: \"Technology has transformed how we communicate with each other in our daily lives.\",\n    difficulty: \"medium\",\n    category: \"technology\",\n    wordCount: 13,\n    characterCount: 81,\n  },\n  {\n    sentence: \"The library offers a quiet space for reading and studying during exam season.\",\n    difficulty: \"medium\",\n    category: \"general\",\n    wordCount: 13,\n    characterCount: 77,\n  },\n  {\n    sentence: \"Regular exercise and healthy eating habits contribute significantly to overall wellness and longevity.\",\n    difficulty: \"medium\",\n    category: \"health\",\n    wordCount: 13,\n    characterCount: 101,\n  },\n  {\n    sentence: \"Climate change affects weather patterns around the world in unexpected and dramatic ways.\",\n    difficulty: \"medium\",\n    category: \"science\",\n    wordCount: 14,\n    characterCount: 89,\n  },\n  {\n    sentence: \"Learning a new language opens doors to different cultures and expands career opportunities globally.\",\n    difficulty: \"medium\",\n    category: \"education\",\n    wordCount: 14,\n    characterCount: 100,\n  },\n  {\n    sentence: \"The museum showcases ancient artifacts that tell fascinating stories about human history and civilization.\",\n    difficulty: \"medium\",\n    category: \"culture\",\n    wordCount: 14,\n    characterCount: 104,\n  },\n  {\n    sentence: \"Online shopping has revolutionized retail by providing convenience and competitive prices to consumers worldwide.\",\n    difficulty: \"medium\",\n    category: \"business\",\n    wordCount: 14,\n    characterCount: 112,\n  },\n  {\n    sentence: \"Artificial intelligence is reshaping industries from healthcare to finance at an unprecedented pace.\",\n    difficulty: \"medium\",\n    category: \"technology\",\n    wordCount: 14,\n    characterCount: 99,\n  },\n  {\n    sentence: \"Sustainable farming practices help preserve natural resources while ensuring food security for future generations.\",\n    difficulty: \"medium\",\n    category: \"environment\",\n    wordCount: 14,\n    characterCount: 111,\n  },\n  {\n    sentence: \"Professional athletes train rigorously for years to compete at the highest levels of their sport.\",\n    difficulty: \"medium\",\n    category: \"sports\",\n    wordCount: 15,\n    characterCount: 97,\n  },\n  {\n    sentence: \"Social media platforms connect billions of people but also raise concerns about privacy and mental health.\",\n    difficulty: \"medium\",\n    category: \"technology\",\n    wordCount: 16,\n    characterCount: 105,\n  },\n  {\n    sentence: \"Renewable energy sources like solar and wind power are becoming increasingly cost-effective alternatives to fossil fuels.\",\n    difficulty: \"medium\",\n    category: \"environment\",\n    wordCount: 16,\n    characterCount: 119,\n  },\n  {\n    sentence: \"The education system must evolve to prepare students for jobs that don't exist yet.\",\n    difficulty: \"medium\",\n    category: \"education\",\n    wordCount: 15,\n    characterCount: 84,\n  },\n  {\n    sentence: \"Remote work has become the new normal for many professionals seeking better work-life balance.\",\n    difficulty: \"medium\",\n    category: \"business\",\n    wordCount: 15,\n    characterCount: 94,\n  },\n  {\n    sentence: \"Space exploration continues to push the boundaries of human knowledge and technological innovation.\",\n    difficulty: \"medium\",\n    category: \"science\",\n    wordCount: 14,\n    characterCount: 99,\n  },\n  {\n    sentence: \"Financial literacy education helps people make informed decisions about saving, investing, and managing debt.\",\n    difficulty: \"medium\",\n    category: \"business\",\n    wordCount: 14,\n    characterCount: 107,\n  },\n  {\n    sentence: \"Urban planning shapes how cities grow and determines the quality of life for their residents.\",\n    difficulty: \"medium\",\n    category: \"general\",\n    wordCount: 16,\n    characterCount: 93,\n  },\n  {\n    sentence: \"Scientific research requires patience, precision, and a willingness to accept unexpected results.\",\n    difficulty: \"medium\",\n    category: \"science\",\n    wordCount: 13,\n    characterCount: 96,\n  },\n  {\n    sentence: \"Cultural diversity enriches communities by bringing together different perspectives, traditions, and creative expressions.\",\n    difficulty: \"medium\",\n    category: \"culture\",\n    wordCount: 14,\n    characterCount: 119,\n  },\n  {\n    sentence: \"Digital marketing strategies help businesses reach target audiences through personalized content and data analytics.\",\n    difficulty: \"medium\",\n    category: \"business\",\n    wordCount: 14,\n    characterCount: 112,\n  },\n  {\n    sentence: \"Mental health awareness campaigns reduce stigma and encourage people to seek professional help when needed.\",\n    difficulty: \"medium\",\n    category: \"health\",\n    wordCount: 15,\n    characterCount: 106,\n  },\n  {\n    sentence: \"The hospitality industry focuses on creating memorable experiences that exceed customer expectations consistently.\",\n    difficulty: \"medium\",\n    category: \"business\",\n    wordCount: 13,\n    characterCount: 112,\n  },\n  {\n    sentence: \"Documentary films educate viewers about important social issues and inspire positive change in communities.\",\n    difficulty: \"medium\",\n    category: \"entertainment\",\n    wordCount: 14,\n    characterCount: 106,\n  },\n  {\n    sentence: \"Cybersecurity experts protect sensitive information from digital threats and unauthorized access attempts.\",\n    difficulty: \"medium\",\n    category: \"technology\",\n    wordCount: 12,\n    characterCount: 102,\n  },\n  {\n    sentence: \"International trade agreements facilitate economic cooperation between nations while addressing environmental concerns.\",\n    difficulty: \"medium\",\n    category: \"business\",\n    wordCount: 12,\n    characterCount: 114,\n  },\n\n  // HARD - 15-20 word sentences, complex structure (15 sentences)\n  {\n    sentence: \"Quantum mechanics revolutionized our understanding of subatomic particle behavior and challenged classical physics principles in profound and unexpected ways.\",\n    difficulty: \"hard\",\n    category: \"science\",\n    wordCount: 21,\n    characterCount: 159,\n  },\n  {\n    sentence: \"Biodiversity conservation requires international cooperation, sustainable practices, and long-term commitment from governments, organizations, and individual citizens worldwide.\",\n    difficulty: \"hard\",\n    category: \"environment\",\n    wordCount: 19,\n    characterCount: 175,\n  },\n  {\n    sentence: \"Neuroscientific research continues to uncover complex mechanisms underlying human consciousness, memory formation, and the intricate neural networks that define cognitive processes.\",\n    difficulty: \"hard\",\n    category: \"science\",\n    wordCount: 22,\n    characterCount: 180,\n  },\n  {\n    sentence: \"Globalization interconnects economies, cultures, and political systems across continents, creating both tremendous opportunities and significant challenges for sustainable development.\",\n    difficulty: \"hard\",\n    category: \"business\",\n    wordCount: 21,\n    characterCount: 181,\n  },\n  {\n    sentence: \"Philosophical discourse examines fundamental questions about existence, morality, knowledge, and reality through rigorous logical analysis and systematic argumentation.\",\n    difficulty: \"hard\",\n    category: \"philosophy\",\n    wordCount: 20,\n    characterCount: 166,\n  },\n  {\n    sentence: \"Cryptocurrency technologies leverage blockchain architecture to enable decentralized financial transactions while introducing novel regulatory challenges for traditional banking institutions.\",\n    difficulty: \"hard\",\n    category: \"technology\",\n    wordCount: 20,\n    characterCount: 186,\n  },\n  {\n    sentence: \"Epidemiological studies analyze disease patterns across populations to identify risk factors, develop prevention strategies, and inform public health policy decisions.\",\n    difficulty: \"hard\",\n    category: \"health\",\n    wordCount: 22,\n    characterCount: 167,\n  },\n  {\n    sentence: \"Postmodern architecture deliberately rejects minimalist aesthetics in favor of playful ornamentation, historical references, and eclectic combinations of diverse stylistic elements.\",\n    difficulty: \"hard\",\n    category: \"culture\",\n    wordCount: 22,\n    characterCount: 180,\n  },\n  {\n    sentence: \"Machine learning algorithms process vast datasets to identify patterns, make predictions, and continuously improve performance through iterative training cycles and feedback mechanisms.\",\n    difficulty: \"hard\",\n    category: \"technology\",\n    wordCount: 24,\n    characterCount: 185,\n  },\n  {\n    sentence: \"Constitutional law establishes fundamental principles governing state authority, individual rights, and the delicate balance between democratic governance and judicial oversight.\",\n    difficulty: \"hard\",\n    category: \"law\",\n    wordCount: 22,\n    characterCount: 176,\n  },\n  {\n    sentence: \"Astrophysics explores cosmic phenomena ranging from stellar evolution to gravitational waves, expanding our comprehension of the universe's origins and ultimate fate.\",\n    difficulty: \"hard\",\n    category: \"science\",\n    wordCount: 23,\n    characterCount: 163,\n  },\n  {\n    sentence: \"Sustainable development balances economic growth with environmental protection and social equity, requiring innovative solutions to address interconnected global challenges.\",\n    difficulty: \"hard\",\n    category: \"environment\",\n    wordCount: 21,\n    characterCount: 172,\n  },\n  {\n    sentence: \"Comparative literature examines texts across linguistic and cultural boundaries, revealing universal themes while celebrating the distinctive characteristics of diverse literary traditions.\",\n    difficulty: \"hard\",\n    category: \"culture\",\n    wordCount: 23,\n    characterCount: 186,\n  },\n  {\n    sentence: \"Immunology investigates the sophisticated defense mechanisms protecting organisms from pathogens, autoimmune disorders, and malignant cells through coordinated cellular and molecular responses.\",\n    difficulty: \"hard\",\n    category: \"science\",\n    wordCount: 23,\n    characterCount: 193,\n  },\n  {\n    sentence: \"Geopolitical tensions arise from competing national interests, resource scarcity, and ideological differences, necessitating diplomatic negotiation and multilateral cooperation frameworks.\",\n    difficulty: \"hard\",\n    category: \"politics\",\n    wordCount: 21,\n    characterCount: 185,\n  },\n];\n\nexport async function seedDictationSentences() {\n  console.log(\"Seeding dictation sentences...\");\n  \n  try {\n    for (const sentence of sentences) {\n      await db.insert(dictationSentences).values(sentence).onConflictDoNothing();\n    }\n    \n    console.log(`âœ“ Successfully seeded ${sentences.length} dictation sentences`);\n  } catch (error) {\n    console.error(\"Error seeding dictation sentences:\", error);\n    throw error;\n  }\n}\n\nseedDictationSentences().then(() => {\n  console.log(\"Dictation sentences seed completed!\");\n  process.exit(0);\n}).catch(error => {\n  console.error(\"Dictation sentences seed failed:\", error);\n  process.exit(1);\n});\n","path":null,"size_bytes":14231,"size_tokens":null},"client/src/hooks/useSpeechSynthesis.ts":{"content":"import { useState, useEffect, useCallback, useRef } from 'react';\n\ninterface UseSpeechSynthesisOptions {\n  rate?: number;\n  pitch?: number;\n  volume?: number;\n  lang?: string;\n  useOpenAI?: boolean;\n  openAIVoice?: string;\n}\n\ninterface UseSpeechSynthesisReturn {\n  speak: (text: string) => void;\n  cancel: () => void;\n  isSpeaking: boolean;\n  isPaused: boolean;\n  isSupported: boolean;\n  voices: SpeechSynthesisVoice[];\n  setVoice: (voice: SpeechSynthesisVoice | null) => void;\n  currentVoice: SpeechSynthesisVoice | null;\n  error: string | null;\n  isUsingOpenAI: boolean;\n  setUseOpenAI: (use: boolean) => void;\n  openAIVoices: { id: string; name: string }[];\n  setOpenAIVoice: (voice: string) => void;\n  currentOpenAIVoice: string;\n}\n\nconst OPENAI_VOICES = [\n  { id: 'alloy', name: 'Alloy (Neutral)' },\n  { id: 'echo', name: 'Echo (Male)' },\n  { id: 'fable', name: 'Fable (British)' },\n  { id: 'onyx', name: 'Onyx (Deep Male)' },\n  { id: 'nova', name: 'Nova (Female)' },\n  { id: 'shimmer', name: 'Shimmer (Soft Female)' },\n];\n\nconst OPENAI_VOICE_STORAGE_KEY = 'dictation-openai-voice';\n\nexport function useSpeechSynthesis(\n  options: UseSpeechSynthesisOptions = {}\n): UseSpeechSynthesisReturn {\n  const [isSpeaking, setIsSpeaking] = useState(false);\n  const [isPaused, setIsPaused] = useState(false);\n  const [voices, setVoices] = useState<SpeechSynthesisVoice[]>([]);\n  const [currentVoice, setCurrentVoice] = useState<SpeechSynthesisVoice | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const [isUsingOpenAI, setIsUsingOpenAI] = useState(true);\n  const [currentOpenAIVoice, setCurrentOpenAIVoice] = useState(() => {\n    return localStorage.getItem(OPENAI_VOICE_STORAGE_KEY) || 'nova';\n  });\n  \n  const utteranceRef = useRef<SpeechSynthesisUtterance | null>(null);\n  const audioRef = useRef<HTMLAudioElement | null>(null);\n  const resumeIntervalRef = useRef<ReturnType<typeof setInterval> | null>(null);\n  const watchdogIntervalRef = useRef<ReturnType<typeof setInterval> | null>(null);\n\n  const isSupported = typeof window !== 'undefined' && 'speechSynthesis' in window;\n\n  const clearIntervals = useCallback(() => {\n    if (resumeIntervalRef.current) {\n      clearInterval(resumeIntervalRef.current);\n      resumeIntervalRef.current = null;\n    }\n    if (watchdogIntervalRef.current) {\n      clearInterval(watchdogIntervalRef.current);\n      watchdogIntervalRef.current = null;\n    }\n  }, []);\n\n  const setUseOpenAI = useCallback((use: boolean) => {\n    setIsUsingOpenAI(use);\n    localStorage.setItem(USE_OPENAI_STORAGE_KEY, use.toString());\n  }, []);\n\n  const setOpenAIVoice = useCallback((voice: string) => {\n    setCurrentOpenAIVoice(voice);\n    localStorage.setItem(OPENAI_VOICE_STORAGE_KEY, voice);\n  }, []);\n\n  useEffect(() => {\n    if (!isSupported) {\n      return;\n    }\n\n    const loadVoices = () => {\n      const availableVoices = window.speechSynthesis.getVoices();\n      const validVoices = availableVoices.filter(v => v.voiceURI && v.voiceURI.trim() !== '');\n      setVoices(validVoices);\n      \n      if (validVoices.length > 0 && !currentVoice) {\n        const englishVoices = validVoices.filter(v => v.lang.startsWith('en'));\n        \n        const premiumVoice = englishVoices.find(v => \n          v.name.toLowerCase().includes('premium') ||\n          v.name.toLowerCase().includes('enhanced') ||\n          v.name.toLowerCase().includes('natural') ||\n          v.name.toLowerCase().includes('neural')\n        );\n        \n        const googleVoice = englishVoices.find(v => \n          v.name.toLowerCase().includes('google') && \n          (v.lang === 'en-US' || v.lang === 'en-GB')\n        );\n        \n        const microsoftVoice = englishVoices.find(v => \n          v.name.toLowerCase().includes('microsoft') &&\n          (v.name.toLowerCase().includes('zira') || \n           v.name.toLowerCase().includes('david') ||\n           v.name.toLowerCase().includes('mark'))\n        );\n        \n        const localEnglishVoice = englishVoices.find(v => v.localService);\n        const usEnglishVoice = englishVoices.find(v => v.lang === 'en-US');\n        const anyEnglishVoice = englishVoices[0];\n        const defaultVoice = validVoices.find(v => v.default);\n        \n        const selectedVoice = premiumVoice || googleVoice || microsoftVoice || \n                              localEnglishVoice || usEnglishVoice || anyEnglishVoice || \n                              defaultVoice || validVoices[0];\n        setCurrentVoice(selectedVoice);\n      }\n    };\n\n    loadVoices();\n    \n    if (window.speechSynthesis.onvoiceschanged !== undefined) {\n      window.speechSynthesis.onvoiceschanged = loadVoices;\n    }\n\n    return () => {\n      clearIntervals();\n      window.speechSynthesis.cancel();\n    };\n  }, [isSupported, clearIntervals]);\n\n  const speakWithOpenAI = useCallback(async (text: string): Promise<boolean> => {\n    try {\n      setIsSpeaking(true);\n      setError(null);\n      \n      const response = await fetch('/api/dictation/tts', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          text,\n          voice: currentOpenAIVoice,\n          speed: options.rate ?? 1.0,\n        }),\n      });\n      \n      if (!response.ok) {\n        const data = await response.json().catch(() => ({}));\n        if (data.fallback) {\n          return false;\n        }\n        throw new Error(data.message || 'TTS request failed');\n      }\n      \n      const audioBlob = await response.blob();\n      const audioUrl = URL.createObjectURL(audioBlob);\n      \n      if (audioRef.current) {\n        audioRef.current.pause();\n        URL.revokeObjectURL(audioRef.current.src);\n      }\n      \n      const audio = new Audio(audioUrl);\n      audioRef.current = audio;\n      \n      audio.onended = () => {\n        setIsSpeaking(false);\n        URL.revokeObjectURL(audioUrl);\n      };\n      \n      audio.onerror = () => {\n        setIsSpeaking(false);\n        setError('Audio playback failed');\n        URL.revokeObjectURL(audioUrl);\n      };\n      \n      await audio.play();\n      return true;\n    } catch (err) {\n      console.error('OpenAI TTS error:', err);\n      setIsSpeaking(false);\n      return false;\n    }\n  }, [currentOpenAIVoice, options.rate]);\n\n  const speakWithBrowser = useCallback((text: string) => {\n    if (!isSupported) {\n      setError('Speech synthesis is not supported');\n      return;\n    }\n\n    try {\n      clearIntervals();\n      window.speechSynthesis.cancel();\n      \n      setTimeout(() => {\n        const utterance = new SpeechSynthesisUtterance(text);\n        utterance.rate = options.rate ?? 1.0;\n        utterance.pitch = options.pitch ?? 1.0;\n        utterance.volume = options.volume ?? 1.0;\n        utterance.lang = options.lang ?? 'en-US';\n        \n        if (currentVoice) {\n          utterance.voice = currentVoice;\n        }\n\n        let speechStarted = false;\n\n        utterance.onstart = () => {\n          speechStarted = true;\n          setIsSpeaking(true);\n          setIsPaused(false);\n          setError(null);\n\n          resumeIntervalRef.current = setInterval(() => {\n            if (window.speechSynthesis.speaking && !window.speechSynthesis.paused) {\n              window.speechSynthesis.pause();\n              window.speechSynthesis.resume();\n            }\n          }, 5000);\n\n          watchdogIntervalRef.current = setInterval(() => {\n            if (!window.speechSynthesis.speaking && speechStarted) {\n              clearIntervals();\n              setIsSpeaking(false);\n              setIsPaused(false);\n            }\n          }, 1000);\n        };\n\n        utterance.onend = () => {\n          clearIntervals();\n          setIsSpeaking(false);\n          setIsPaused(false);\n        };\n\n        utterance.onerror = (event) => {\n          clearIntervals();\n          \n          if (event.error === 'interrupted' || event.error === 'canceled') {\n            setIsSpeaking(false);\n            setIsPaused(false);\n            return;\n          }\n          \n          console.error('Speech synthesis error:', event);\n          setIsSpeaking(false);\n          setIsPaused(false);\n          setError(`Speech error: ${event.error}`);\n        };\n\n        utterance.onpause = () => setIsPaused(true);\n        utterance.onresume = () => setIsPaused(false);\n\n        utteranceRef.current = utterance;\n        window.speechSynthesis.speak(utterance);\n\n        setTimeout(() => {\n          if (!speechStarted && window.speechSynthesis.speaking === false) {\n            window.speechSynthesis.cancel();\n            setTimeout(() => {\n              window.speechSynthesis.speak(utterance);\n            }, 100);\n          }\n        }, 250);\n\n      }, 50);\n\n    } catch (err) {\n      clearIntervals();\n      const errorMessage = err instanceof Error ? err.message : 'Unknown error occurred';\n      setError(errorMessage);\n      setIsSpeaking(false);\n    }\n  }, [isSupported, options.rate, options.pitch, options.volume, options.lang, currentVoice, clearIntervals]);\n\n  const speak = useCallback(async (text: string) => {\n    if (!text.trim()) {\n      setError('Cannot speak empty text');\n      return;\n    }\n\n    if (isUsingOpenAI) {\n      const success = await speakWithOpenAI(text);\n      if (!success) {\n        console.log('OpenAI TTS failed, falling back to browser speech');\n        speakWithBrowser(text);\n      }\n    } else {\n      speakWithBrowser(text);\n    }\n  }, [isUsingOpenAI, speakWithOpenAI, speakWithBrowser]);\n\n  const cancel = useCallback(() => {\n    clearIntervals();\n    \n    if (audioRef.current) {\n      audioRef.current.pause();\n      audioRef.current.currentTime = 0;\n    }\n    \n    if (isSupported) {\n      window.speechSynthesis.cancel();\n    }\n    \n    setIsSpeaking(false);\n    setIsPaused(false);\n  }, [isSupported, clearIntervals]);\n\n  const setVoice = useCallback((voice: SpeechSynthesisVoice | null) => {\n    setCurrentVoice(voice);\n  }, []);\n\n  return {\n    speak,\n    cancel,\n    isSpeaking,\n    isPaused,\n    isSupported: isSupported || isUsingOpenAI,\n    voices,\n    setVoice,\n    currentVoice,\n    error,\n    isUsingOpenAI,\n    setUseOpenAI,\n    openAIVoices: OPENAI_VOICES,\n    setOpenAIVoice,\n    currentOpenAIVoice,\n  };\n}\n","path":null,"size_bytes":10192,"size_tokens":null},"shared/dictation-utils.ts":{"content":"export function normalizeText(text: string): string {\n  return text\n    .toLowerCase()\n    .trim()\n    .replace(/\\s+/g, ' ')\n    .replace(/['']/g, \"'\")\n    .replace(/[\"\"]/g, '\"')\n    .replace(/[â€’â€“â€”â€•]/g, '-');\n}\n\nexport function normalizeForComparison(text: string): string {\n  return text\n    .toLowerCase()\n    .trim()\n    .replace(/\\s+/g, ' ')\n    .replace(/['']/g, \"'\")\n    .replace(/[\"\"]/g, '\"')\n    .replace(/[â€’â€“â€”â€•]/g, '-')\n    .replace(/[.,!?;:'\"()\\[\\]{}]/g, '');\n}\n\nexport function levenshteinDistance(str1: string, str2: string): number {\n  const m = str1.length;\n  const n = str2.length;\n  \n  if (m === 0) return n;\n  if (n === 0) return m;\n  \n  const dp: number[][] = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));\n  \n  for (let i = 0; i <= m; i++) {\n    dp[i][0] = i;\n  }\n  \n  for (let j = 0; j <= n; j++) {\n    dp[0][j] = j;\n  }\n  \n  for (let i = 1; i <= m; i++) {\n    for (let j = 1; j <= n; j++) {\n      const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;\n      dp[i][j] = Math.min(\n        dp[i - 1][j] + 1,\n        dp[i][j - 1] + 1,\n        dp[i - 1][j - 1] + cost\n      );\n    }\n  }\n  \n  return dp[m][n];\n}\n\nexport interface CharacterDiff {\n  char: string;\n  typedChar?: string;\n  status: 'correct' | 'incorrect' | 'missing' | 'extra';\n  position: number;\n}\n\nexport interface WordDiff {\n  word: string;\n  typedWord: string;\n  status: 'correct' | 'incorrect' | 'missing' | 'extra';\n  position: number;\n}\n\nexport function getCharacterDiff(typed: string, actual: string): CharacterDiff[] {\n  const normalizedTyped = normalizeText(typed);\n  const normalizedActual = normalizeText(actual);\n  const diff: CharacterDiff[] = [];\n  \n  let typedIdx = 0;\n  let actualIdx = 0;\n  let position = 0;\n  \n  while (actualIdx < normalizedActual.length || typedIdx < normalizedTyped.length) {\n    const typedChar = normalizedTyped[typedIdx] || '';\n    const actualChar = normalizedActual[actualIdx] || '';\n    \n    if (typedIdx >= normalizedTyped.length) {\n      diff.push({ char: actualChar, status: 'missing', position: position++ });\n      actualIdx++;\n    } else if (actualIdx >= normalizedActual.length) {\n      diff.push({ char: typedChar, status: 'extra', position: position++ });\n      typedIdx++;\n    } else if (typedChar === actualChar) {\n      diff.push({ char: actualChar, status: 'correct', position: position++ });\n      typedIdx++;\n      actualIdx++;\n    } else {\n      const lookAhead = 3;\n      let foundTypedAhead = -1;\n      let foundActualAhead = -1;\n      \n      for (let i = 1; i <= lookAhead && actualIdx + i < normalizedActual.length; i++) {\n        if (normalizedActual[actualIdx + i] === typedChar) {\n          foundActualAhead = i;\n          break;\n        }\n      }\n      \n      for (let i = 1; i <= lookAhead && typedIdx + i < normalizedTyped.length; i++) {\n        if (normalizedTyped[typedIdx + i] === actualChar) {\n          foundTypedAhead = i;\n          break;\n        }\n      }\n      \n      if (foundActualAhead > 0 && (foundTypedAhead < 0 || foundActualAhead <= foundTypedAhead)) {\n        for (let i = 0; i < foundActualAhead; i++) {\n          diff.push({ char: normalizedActual[actualIdx + i], status: 'missing', position: position++ });\n        }\n        actualIdx += foundActualAhead;\n      } else if (foundTypedAhead > 0) {\n        for (let i = 0; i < foundTypedAhead; i++) {\n          diff.push({ char: normalizedTyped[typedIdx + i], status: 'extra', position: position++ });\n        }\n        typedIdx += foundTypedAhead;\n      } else {\n        diff.push({ char: actualChar, typedChar: typedChar, status: 'incorrect', position: position++ });\n        typedIdx++;\n        actualIdx++;\n      }\n    }\n  }\n  \n  return diff;\n}\n\nfunction normalizeWord(word: string): string {\n  return word.toLowerCase().replace(/[.,!?;:'\"()\\[\\]{}]/g, '').trim();\n}\n\nexport function getWordDiff(typed: string, actual: string): WordDiff[] {\n  const typedWords = typed.trim().split(/\\s+/).filter(w => w.length > 0);\n  const actualWords = actual.trim().split(/\\s+/).filter(w => w.length > 0);\n  const diff: WordDiff[] = [];\n  \n  let typedIdx = 0;\n  let actualIdx = 0;\n  \n  while (actualIdx < actualWords.length || typedIdx < typedWords.length) {\n    const actualWord = actualWords[actualIdx] || '';\n    const typedWord = typedWords[typedIdx] || '';\n    const normalizedActual = normalizeWord(actualWord);\n    const normalizedTyped = normalizeWord(typedWord);\n    \n    if (actualIdx >= actualWords.length) {\n      diff.push({\n        word: typedWord,\n        typedWord: typedWord,\n        status: 'extra',\n        position: typedIdx,\n      });\n      typedIdx++;\n    } else if (typedIdx >= typedWords.length) {\n      diff.push({\n        word: actualWord,\n        typedWord: '',\n        status: 'missing',\n        position: actualIdx,\n      });\n      actualIdx++;\n    } else if (normalizedActual === normalizedTyped) {\n      diff.push({\n        word: actualWord,\n        typedWord: typedWord,\n        status: 'correct',\n        position: actualIdx,\n      });\n      typedIdx++;\n      actualIdx++;\n    } else {\n      const nextActualNormalized = actualIdx + 1 < actualWords.length \n        ? normalizeWord(actualWords[actualIdx + 1]) \n        : '';\n      const nextTypedNormalized = typedIdx + 1 < typedWords.length \n        ? normalizeWord(typedWords[typedIdx + 1]) \n        : '';\n      \n      if (normalizedTyped === nextActualNormalized) {\n        diff.push({\n          word: actualWord,\n          typedWord: '',\n          status: 'missing',\n          position: actualIdx,\n        });\n        actualIdx++;\n      } else if (normalizedActual === nextTypedNormalized) {\n        diff.push({\n          word: typedWord,\n          typedWord: typedWord,\n          status: 'extra',\n          position: typedIdx,\n        });\n        typedIdx++;\n      } else {\n        diff.push({\n          word: actualWord,\n          typedWord: typedWord,\n          status: 'incorrect',\n          position: actualIdx,\n        });\n        typedIdx++;\n        actualIdx++;\n      }\n    }\n  }\n  \n  return diff;\n}\n\nexport interface DictationAccuracyResult {\n  accuracy: number;\n  errors: number;\n  normalizedTyped: string;\n  normalizedActual: string;\n  characterDiff: CharacterDiff[];\n  wordDiff: WordDiff[];\n  correctChars: number;\n  totalChars: number;\n  correctWords: number;\n  totalWords: number;\n}\n\nexport function calculateDictationAccuracy(\n  typedText: string,\n  actualSentence: string\n): DictationAccuracyResult {\n  const normalizedTyped = normalizeForComparison(typedText);\n  const normalizedActual = normalizeForComparison(actualSentence);\n  \n  const characterDiff = getCharacterDiff(typedText, actualSentence);\n  const wordDiff = getWordDiff(typedText, actualSentence);\n  const correctChars = characterDiff.filter(d => d.status === 'correct').length;\n  const correctWords = wordDiff.filter(d => d.status === 'correct').length;\n  const totalWords = actualSentence.trim().split(/\\s+/).filter(w => w.length > 0).length;\n  \n  const wordErrors = wordDiff.filter(d => d.status !== 'correct').length;\n  const totalWordSlots = Math.max(totalWords, wordDiff.length);\n  const accuracy = totalWordSlots === 0 ? 100 : \n    Math.round((correctWords / totalWordSlots) * 100);\n  \n  const maxLength = Math.max(normalizedTyped.length, normalizedActual.length);\n  \n  return {\n    accuracy: Math.max(0, Math.min(100, accuracy)),\n    errors: wordErrors,\n    normalizedTyped,\n    normalizedActual,\n    characterDiff,\n    wordDiff,\n    correctChars,\n    totalChars: maxLength,\n    correctWords,\n    totalWords,\n  };\n}\n\nexport function calculateDictationWPM(\n  typedCharacters: number,\n  durationSeconds: number\n): number {\n  if (durationSeconds === 0) return 0;\n  \n  const words = typedCharacters / 5;\n  const minutes = durationSeconds / 60;\n  \n  return Math.round(words / minutes);\n}\n\nexport function getSpeedRate(speedLevel: string): number {\n  const rates: Record<string, number> = {\n    slow: 0.6,\n    medium: 0.85,\n    fast: 1.1,\n  };\n  \n  if (speedLevel === 'random') {\n    const levels = ['slow', 'medium', 'fast'];\n    const randomLevel = levels[Math.floor(Math.random() * levels.length)];\n    return rates[randomLevel];\n  }\n  \n  const numericRate = parseFloat(speedLevel);\n  if (!isNaN(numericRate) && numericRate >= 0.5 && numericRate <= 2.0) {\n    return numericRate;\n  }\n  \n  return rates[speedLevel] || 0.85;\n}\n\nexport function getSpeedLevelName(rate: number): string {\n  if (rate <= 0.8) return 'Slow';\n  if (rate <= 1.2) return 'Medium';\n  return 'Fast';\n}\n\nexport function getAccuracyGrade(accuracy: number): {\n  grade: string;\n  color: string;\n  message: string;\n} {\n  if (accuracy >= 98) {\n    return {\n      grade: 'S',\n      color: 'text-purple-600',\n      message: 'Perfect! Outstanding accuracy!',\n    };\n  } else if (accuracy >= 95) {\n    return {\n      grade: 'A+',\n      color: 'text-green-600',\n      message: 'Excellent! Nearly perfect!',\n    };\n  } else if (accuracy >= 90) {\n    return {\n      grade: 'A',\n      color: 'text-green-600',\n      message: 'Great job! Very accurate!',\n    };\n  } else if (accuracy >= 85) {\n    return {\n      grade: 'B+',\n      color: 'text-blue-600',\n      message: 'Good work! Keep it up!',\n    };\n  } else if (accuracy >= 80) {\n    return {\n      grade: 'B',\n      color: 'text-blue-600',\n      message: 'Nice! Room for improvement!',\n    };\n  } else if (accuracy >= 70) {\n    return {\n      grade: 'C',\n      color: 'text-yellow-600',\n      message: 'Keep practicing!',\n    };\n  } else {\n    return {\n      grade: 'D',\n      color: 'text-orange-600',\n      message: 'Try replaying and using hints!',\n    };\n  }\n}\n\nexport function formatDuration(seconds: number): string {\n  if (seconds < 60) {\n    return `${seconds}s`;\n  }\n  const mins = Math.floor(seconds / 60);\n  const secs = seconds % 60;\n  return `${mins}m ${secs}s`;\n}\n","path":null,"size_bytes":9783,"size_tokens":null},"client/src/pages/stress-test.tsx":{"content":"import { useState, useEffect, useRef, useCallback, useMemo, memo, useLayoutEffect } from 'react';\nimport { Link, useLocation } from 'wouter';\nimport { ArrowLeft, Zap, Skull, Trophy, Eye, Volume2, VolumeX, AlertTriangle, HelpCircle, Clock, Target, Flame, XCircle, Timer, BarChart3, RefreshCw, Home, Info, LogIn, WifiOff, Award, X } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { Progress } from '@/components/ui/progress';\nimport { useToast } from '@/hooks/use-toast';\nimport { useMutation } from '@tanstack/react-query';\nimport confetti from 'canvas-confetti';\nimport { calculateWPM, calculateAccuracy } from '@/lib/typing-utils';\nimport { useAuth } from '@/lib/auth-context';\nimport { useNetwork } from '@/lib/network-context';\nimport { StressCertificate } from '@/components/StressCertificate';\nimport { useCreateCertificate } from '@/hooks/useCertificates';\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from '@/components/ui/tooltip';\n\ntype Difficulty = 'beginner' | 'intermediate' | 'expert' | 'nightmare' | 'impossible';\n\ninterface StressEffects {\n  screenShake: boolean;\n  distractions: boolean;\n  sounds: boolean;\n  speedIncrease: boolean;\n  limitedVisibility: boolean;\n  colorShift: boolean;\n  gravity: boolean;\n  rotation: boolean;\n  glitch: boolean;\n  textFade: boolean;\n  reverseText: boolean;\n  randomJumps: boolean;\n  screenInvert: boolean;\n  zoomChaos: boolean;\n  screenFlip: boolean;\n}\n\nconst EFFECT_DESCRIPTIONS: Record<keyof StressEffects, string> = {\n  screenShake: 'Screen vibrates and shakes during typing',\n  distractions: 'Random emoji particles explode on screen',\n  sounds: 'Chaotic sound effects play during the test',\n  speedIncrease: 'Effects intensify as time progresses',\n  limitedVisibility: 'Text becomes blurry making it harder to read',\n  colorShift: 'Text and UI colors change randomly',\n  gravity: 'Text bounces and floats unpredictably',\n  rotation: 'Screen tilts and rotates during typing',\n  glitch: 'Visual glitch effects distort the screen',\n  textFade: 'Text opacity fluctuates making it hard to see',\n  reverseText: 'Text temporarily reverses direction',\n  randomJumps: 'Text teleports to random positions',\n  screenInvert: 'Screen colors invert unexpectedly',\n  zoomChaos: 'Screen zooms in and out randomly',\n  screenFlip: 'Screen flips upside down periodically',\n};\n\nconst DIFFICULTY_CONFIGS: Record<Difficulty, {\n  name: string;\n  description: string;\n  effects: StressEffects;\n  duration: number;\n  icon: string;\n  color: string;\n  baseShakeIntensity: number;\n  particleFrequency: number;\n  multiplier: number;\n  difficulty: string;\n  maxBlur?: number;\n  blurPulse?: boolean;\n  constantBlur?: number;\n  blurPulseSpeed?: number;\n  realityDistortion?: boolean;\n  chromaticAberration?: boolean;\n  textScramble?: boolean;\n  multiEffectCombos?: boolean;\n  extremeChaosWaves?: boolean;\n  doubleVision?: boolean;\n  textWarp?: boolean;\n  chaosIntensityMultiplier?: number;\n}> = {\n  beginner: {\n    name: 'Warm-Up Chaos',\n    description: 'Gentle introduction with light effects',\n    effects: {\n      screenShake: true,\n      distractions: true,\n      sounds: true,\n      speedIncrease: false,\n      limitedVisibility: false,\n      colorShift: false,\n      gravity: false,\n      rotation: false,\n      glitch: false,\n      textFade: false,\n      reverseText: false,\n      randomJumps: false,\n      screenInvert: false,\n      zoomChaos: false,\n      screenFlip: false,\n    },\n    duration: 30,\n    icon: 'ðŸ”¥',\n    color: 'from-amber-500/20 to-orange-500/20',\n    baseShakeIntensity: 3,\n    particleFrequency: 0.15,\n    multiplier: 1,\n    difficulty: 'Easy',\n  },\n  intermediate: {\n    name: 'Mind Scrambler',\n    description: 'Progressive chaos - effects intensify as you type',\n    effects: {\n      screenShake: true,\n      distractions: true,\n      sounds: true,\n      speedIncrease: true,\n      limitedVisibility: false,\n      colorShift: true,\n      gravity: true,\n      rotation: true,\n      glitch: false,\n      textFade: false,\n      reverseText: false,\n      randomJumps: false,\n      screenInvert: true,\n      zoomChaos: true,\n      screenFlip: false,\n    },\n    duration: 45,\n    icon: 'âš¡',\n    color: 'from-purple-500/20 to-pink-500/20',\n    baseShakeIntensity: 8,\n    particleFrequency: 0.3,\n    multiplier: 2,\n    difficulty: 'Medium - Build your focus',\n  },\n  expert: {\n    name: 'Absolute Mayhem',\n    description: 'Screen flips upside down, glitches, complete chaos',\n    effects: {\n      screenShake: true,\n      distractions: true,\n      sounds: true,\n      speedIncrease: true,\n      limitedVisibility: true,\n      colorShift: true,\n      gravity: true,\n      rotation: true,\n      glitch: true,\n      textFade: true,\n      reverseText: false,\n      randomJumps: false,\n      screenInvert: true,\n      zoomChaos: true,\n      screenFlip: true,\n    },\n    duration: 60,\n    icon: 'ðŸ’€',\n    color: 'from-red-500/20 to-orange-500/20',\n    baseShakeIntensity: 25,\n    particleFrequency: 0.7,\n    multiplier: 3,\n    difficulty: 'Hard - Not for the faint of heart',\n  },\n  nightmare: {\n    name: 'Nightmare Realm',\n    description: 'Text reverses, blur pulses gently.',\n    effects: {\n      screenShake: true,\n      distractions: true,\n      sounds: true,\n      speedIncrease: false,\n      limitedVisibility: true,\n      colorShift: false,\n      gravity: false,\n      rotation: false,\n      glitch: true,\n      textFade: false,\n      reverseText: true,\n      randomJumps: false,\n      screenInvert: false,\n      zoomChaos: false,\n      screenFlip: false,\n    },\n    duration: 90,\n    icon: 'â˜ ï¸',\n    color: 'from-black/40 to-red-900/40',\n    baseShakeIntensity: 8,\n    particleFrequency: 0.3,\n    multiplier: 4,\n    difficulty: 'Extreme - Reality bends around you',\n    maxBlur: 1.8,\n    blurPulse: true,\n    constantBlur: 0.3,\n    blurPulseSpeed: 0.1,\n    realityDistortion: false,\n    chromaticAberration: false,\n  },\n  impossible: {\n    name: 'IMPOSSIBLE',\n    description: 'Stronger blur, subtle double vision.',\n    effects: {\n      screenShake: true,\n      distractions: true,\n      sounds: true,\n      speedIncrease: false,\n      limitedVisibility: true,\n      colorShift: false,\n      gravity: false,\n      rotation: false,\n      glitch: true,\n      textFade: false,\n      reverseText: true,\n      randomJumps: false,\n      screenInvert: true,\n      zoomChaos: false,\n      screenFlip: false,\n    },\n    duration: 120,\n    icon: 'ðŸŒ€',\n    color: 'from-purple-900/60 to-black/60',\n    baseShakeIntensity: 12,\n    particleFrequency: 0.4,\n    multiplier: 5,\n    difficulty: 'Legendary - Only 1% survive',\n    maxBlur: 2.5,\n    blurPulse: true,\n    constantBlur: 0.5,\n    blurPulseSpeed: 0.15,\n    realityDistortion: false,\n    chromaticAberration: true,\n    textScramble: false,\n    multiEffectCombos: false,\n    extremeChaosWaves: false,\n    doubleVision: true,\n    textWarp: false,\n    chaosIntensityMultiplier: 1,\n  },\n};\n\nconst STRESS_SENTENCES = [\n  \"The quick brown fox jumps over the lazy dog while the world shakes violently around you.\",\n  \"In the midst of chaos, only the focused mind prevails against impossible odds.\",\n  \"Type through the storm, embrace the madness, and prove your worth as a master typist.\",\n  \"Your fingers dance on keys while reality itself trembles and distorts before your eyes.\",\n  \"Focus is everything when the screen becomes your worst enemy in this battle of wills.\",\n  \"When the world falls apart around you, let your fingers find their rhythm in the chaos.\",\n  \"Every keystroke is a victory against the madness that surrounds your screen tonight.\",\n  \"The storm rages but your hands remain steady on the keyboard through it all.\",\n  \"Through glitch and shake, through flash and fade, the determined typist perseveres.\",\n  \"Master the chaos or be consumed by it - there is no middle ground here for you.\",\n  \"Concentration is your shield against the visual assault of this stress test.\",\n  \"Let the screen shake, let the colors shift - your typing will not falter today.\",\n  \"In darkness and confusion, the skilled typist finds clarity in each keystroke.\",\n  \"Reality bends and warps but your focus remains unbroken through it all.\",\n  \"The keys beneath your fingers are your only connection to sanity in this storm.\",\n  \"Embrace the chaos, let it flow through you, and emerge victorious on the other side.\",\n  \"Speed and accuracy become one as you type through the visual madness around you.\",\n  \"Your mind is a fortress, your fingers are soldiers, and every word is a victory won.\",\n  \"The screen may flicker and dance but your determination remains absolutely steadfast.\",\n  \"Type like your life depends on it because in this test your score certainly does.\",\n  \"Chaos is merely a ladder for those who refuse to let their focus waver even slightly.\",\n  \"The visual storm is nothing compared to the calm precision of your practiced fingers.\",\n  \"Each character you type correctly is a small triumph against the forces of distraction.\",\n  \"Stay calm, stay focused, and let your muscle memory guide you through this trial.\",\n];\n\nconst generateStressText = (durationSeconds: number): string => {\n  const targetCharsPerSecond = 6;\n  const targetLength = durationSeconds * targetCharsPerSecond;\n  \n  const shuffled = [...STRESS_SENTENCES].sort(() => Math.random() - 0.5);\n  \n  let result = '';\n  let sentenceIndex = 0;\n  \n  while (result.length < targetLength && sentenceIndex < shuffled.length) {\n    if (result.length > 0) {\n      result += ' ';\n    }\n    result += shuffled[sentenceIndex];\n    sentenceIndex++;\n  }\n  \n  if (result.length < targetLength && shuffled.length > 0) {\n    let extraIndex = 0;\n    while (result.length < targetLength) {\n      result += ' ' + shuffled[extraIndex % shuffled.length];\n      extraIndex++;\n    }\n  }\n  \n  return result;\n};\n\nconst MAX_PARTICLES = 20;\n\ninterface ParticleData {\n  id: number;\n  x: number;\n  y: number;\n  emoji: string;\n  speed: number;\n}\n\nconst Particle = memo(({ particle }: { particle: ParticleData }) => (\n  <div\n    className=\"fixed pointer-events-none text-4xl animate-ping z-50\"\n    style={{\n      left: `${particle.x}%`,\n      top: `${particle.y}%`,\n      animationDuration: `${particle.speed}s`,\n    }}\n    aria-hidden=\"true\"\n  >\n    {particle.emoji}\n  </div>\n));\n\nParticle.displayName = 'Particle';\n\nlet globalAudioContext: AudioContext | null = null;\n\nfunction getSharedAudioContext(): AudioContext | null {\n  try {\n    if (!globalAudioContext || globalAudioContext.state === 'closed') {\n      globalAudioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n    }\n    if (globalAudioContext.state === 'suspended') {\n      globalAudioContext.resume();\n    }\n    return globalAudioContext;\n  } catch {\n    return null;\n  }\n}\n\nexport default function StressTest() {\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const createCertificateMutation = useCreateCertificate();\n  const { isOnline, isServerReachable, addPendingAction, checkConnection } = useNetwork();\n  const [, setLocation] = useLocation();\n  const [showCertificate, setShowCertificate] = useState(false);\n  const [certificateData, setCertificateData] = useState<any>(null);\n  const [lastTestResultId, setLastTestResultId] = useState<number | null>(null);\n  const [pendingResultData, setPendingResultData] = useState<{\n    difficulty: Difficulty;\n    enabledEffects: StressEffects;\n    wpm: number;\n    accuracy: number;\n    errors: number;\n    maxCombo: number;\n    totalCharacters: number;\n    duration: number;\n    survivalTime: number;\n    completionRate: number;\n    stressScore: number;\n  } | null>(null);\n  const [selectedDifficulty, setSelectedDifficulty] = useState<Difficulty | null>(null);\n  const [isStarted, setIsStarted] = useState(false);\n  const [isFinished, setIsFinished] = useState(false);\n  const [countdown, setCountdown] = useState(0);\n  const [timeLeft, setTimeLeft] = useState(0);\n  const [typedText, setTypedText] = useState('');\n  const [currentText, setCurrentText] = useState('');\n  const [errors, setErrors] = useState(0);\n  const [combo, setCombo] = useState(0);\n  const [maxCombo, setMaxCombo] = useState(0);\n  const [startTime, setStartTime] = useState<number | null>(null);\n  const [soundEnabled, setSoundEnabled] = useState(true);\n  \n  const [shakeIntensity, setShakeIntensity] = useState(0);\n  const [particles, setParticles] = useState<ParticleData[]>([]);\n  const [currentColor, setCurrentColor] = useState('hsl(0, 0%, 100%)');\n  const [blur, setBlur] = useState(0);\n  const [rotation, setRotation] = useState(0);\n  const [gravityOffset, setGravityOffset] = useState(0);\n  const [glitchActive, setGlitchActive] = useState(false);\n  const [textOpacity, setTextOpacity] = useState(1);\n  const [textReversed, setTextReversed] = useState(false);\n  const [textPosition, setTextPosition] = useState({ x: 0, y: 0 });\n  const [backgroundFlash, setBackgroundFlash] = useState(false);\n  const [stressLevel, setStressLevel] = useState(0);\n  const [screenInverted, setScreenInverted] = useState(false);\n  const [zoomScale, setZoomScale] = useState(1);\n  const [screenFlipped, setScreenFlipped] = useState(false);\n  const [comboExplosion, setComboExplosion] = useState(false);\n  const [shakeOffset, setShakeOffset] = useState({ x: 0, y: 0 });\n  const [isClarityWindow, setIsClarityWindow] = useState(false);\n  const isClarityWindowRef = useRef(false);\n  const [chromaticOffset, setChromaticOffset] = useState({ r: 0, g: 0, b: 0 });\n  const [realityWarp, setRealityWarp] = useState(0);\n  const [textScrambleActive, setTextScrambleActive] = useState(false);\n  const [chaosWaveIntensity, setChaosWaveIntensity] = useState(0);\n  const [multiEffectActive, setMultiEffectActive] = useState(false);\n  const [doubleVisionOffset, setDoubleVisionOffset] = useState({ x: 0, y: 0 });\n  const [textWarpAmount, setTextWarpAmount] = useState(0);\n  const blurPulsePhaseRef = useRef(0);\n  \n  const [finalResults, setFinalResults] = useState<{\n    survivalTime: number;\n    wpm: number;\n    accuracy: number;\n    completionRate: number;\n    stressScore: number;\n    completed: boolean;\n  } | null>(null);\n  \n  const [prefersReducedMotion, setPrefersReducedMotion] = useState(false);\n  useLayoutEffect(() => {\n    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');\n    setPrefersReducedMotion(mediaQuery.matches);\n    const handler = (e: MediaQueryListEvent) => setPrefersReducedMotion(e.matches);\n    mediaQuery.addEventListener('change', handler);\n    return () => mediaQuery.removeEventListener('change', handler);\n  }, []);\n  \n  const inputRef = useRef<HTMLInputElement>(null);\n  const containerRef = useRef<HTMLDivElement>(null);\n  \n  const pendingTimeoutsRef = useRef<Map<ReturnType<typeof setTimeout>, boolean>>(new Map());\n  const countdownIntervalRef = useRef<ReturnType<typeof setInterval> | null>(null);\n  const timerIntervalRef = useRef<ReturnType<typeof setInterval> | null>(null);\n  const effectsIntervalRef = useRef<ReturnType<typeof setInterval> | null>(null);\n  const shakeIntervalRef = useRef<ReturnType<typeof setInterval> | null>(null);\n  const stressIntervalRef = useRef<ReturnType<typeof setInterval> | null>(null);\n  const clarityIntervalRef = useRef<ReturnType<typeof setInterval> | null>(null);\n  const blurIntervalRef = useRef<ReturnType<typeof setInterval> | null>(null);\n  \n  const testSessionRef = useRef<number>(0);\n  const isTestActiveRef = useRef<boolean>(false);\n  const particleIdRef = useRef<number>(0);\n  const finishTestRef = useRef<(completed: boolean) => void>(() => {});\n  const maxComboRef = useRef<number>(0);\n  const typedTextRef = useRef<string>('');\n  const currentTextRef = useRef<string>('');\n  const errorsRef = useRef<number>(0);\n  const startTimeRef = useRef<number | null>(null);\n  const selectedDifficultyRef = useRef<Difficulty | null>(null);\n  const completedRef = useRef<boolean>(false);\n  const stressLevelRef = useRef<number>(0);\n  const configRef = useRef<typeof DIFFICULTY_CONFIGS[Difficulty] | null>(null);\n\n  const config = selectedDifficulty ? DIFFICULTY_CONFIGS[selectedDifficulty] : null;\n  \n  useEffect(() => {\n    configRef.current = config;\n  }, [config]);\n  \n  useEffect(() => {\n    stressLevelRef.current = stressLevel;\n  }, [stressLevel]);\n\n  const safeTimeout = useCallback((callback: () => void, delay: number) => {\n    const timeoutId = setTimeout(() => {\n      pendingTimeoutsRef.current.delete(timeoutId);\n      if (isTestActiveRef.current) {\n        callback();\n      }\n    }, delay);\n    pendingTimeoutsRef.current.set(timeoutId, true);\n    return timeoutId;\n  }, []);\n\n  const clearAllTimers = useCallback(() => {\n    pendingTimeoutsRef.current.forEach((_, id) => clearTimeout(id));\n    pendingTimeoutsRef.current.clear();\n    \n    if (countdownIntervalRef.current) {\n      clearInterval(countdownIntervalRef.current);\n      countdownIntervalRef.current = null;\n    }\n    if (timerIntervalRef.current) {\n      clearInterval(timerIntervalRef.current);\n      timerIntervalRef.current = null;\n    }\n    if (effectsIntervalRef.current) {\n      clearInterval(effectsIntervalRef.current);\n      effectsIntervalRef.current = null;\n    }\n    if (shakeIntervalRef.current) {\n      clearInterval(shakeIntervalRef.current);\n      shakeIntervalRef.current = null;\n    }\n    if (stressIntervalRef.current) {\n      clearInterval(stressIntervalRef.current);\n      stressIntervalRef.current = null;\n    }\n    if (clarityIntervalRef.current) {\n      clearInterval(clarityIntervalRef.current);\n      clarityIntervalRef.current = null;\n    }\n    if (blurIntervalRef.current) {\n      clearInterval(blurIntervalRef.current);\n      blurIntervalRef.current = null;\n    }\n  }, []);\n\n  const resetVisualStates = useCallback(() => {\n    setShakeIntensity(0);\n    setShakeOffset({ x: 0, y: 0 });\n    setParticles([]);\n    setCurrentColor('hsl(0, 0%, 100%)');\n    setBlur(0);\n    setRotation(0);\n    setGravityOffset(0);\n    setGlitchActive(false);\n    setTextOpacity(1);\n    setTextReversed(false);\n    setTextPosition({ x: 0, y: 0 });\n    setScreenInverted(false);\n    setZoomScale(1);\n    setScreenFlipped(false);\n    setComboExplosion(false);\n    setBackgroundFlash(false);\n    setStressLevel(0);\n    setIsClarityWindow(false);\n    isClarityWindowRef.current = false;\n    setChromaticOffset({ r: 0, g: 0, b: 0 });\n    setRealityWarp(0);\n    setTextScrambleActive(false);\n    setChaosWaveIntensity(0);\n    setMultiEffectActive(false);\n    setDoubleVisionOffset({ x: 0, y: 0 });\n    setTextWarpAmount(0);\n    blurPulsePhaseRef.current = 0;\n  }, []);\n\n  const playSound = useCallback((type: 'type' | 'error' | 'combo' | 'complete' | 'warning' | 'chaos') => {\n    if (!soundEnabled) return;\n    \n    const audioContext = getSharedAudioContext();\n    if (!audioContext) return;\n    \n    try {\n      const oscillator = audioContext.createOscillator();\n      const gainNode = audioContext.createGain();\n      \n      oscillator.connect(gainNode);\n      gainNode.connect(audioContext.destination);\n      \n      switch (type) {\n        case 'type':\n          oscillator.frequency.value = 800 + Math.random() * 200;\n          gainNode.gain.value = 0.08;\n          oscillator.start();\n          oscillator.stop(audioContext.currentTime + 0.03);\n          break;\n        case 'error':\n          oscillator.frequency.value = 150;\n          oscillator.type = 'sawtooth';\n          gainNode.gain.value = 0.4;\n          oscillator.start();\n          oscillator.stop(audioContext.currentTime + 0.2);\n          break;\n        case 'combo':\n          oscillator.frequency.value = 1500;\n          gainNode.gain.value = 0.15;\n          oscillator.start();\n          oscillator.stop(audioContext.currentTime + 0.08);\n          break;\n        case 'complete':\n          oscillator.frequency.value = 2000;\n          gainNode.gain.value = 0.3;\n          oscillator.start();\n          oscillator.stop(audioContext.currentTime + 0.5);\n          break;\n        case 'warning':\n          oscillator.frequency.value = 400;\n          oscillator.type = 'triangle';\n          gainNode.gain.value = 0.3;\n          oscillator.start();\n          oscillator.stop(audioContext.currentTime + 0.15);\n          break;\n        case 'chaos':\n          oscillator.frequency.value = 100 + Math.random() * 500;\n          oscillator.type = 'square';\n          gainNode.gain.value = 0.2;\n          oscillator.start();\n          oscillator.stop(audioContext.currentTime + 0.1);\n          break;\n      }\n    } catch {\n      // Silently fail\n    }\n  }, [soundEnabled]);\n\n  useEffect(() => {\n    return () => {\n      clearAllTimers();\n      isTestActiveRef.current = false;\n    };\n  }, [clearAllTimers]);\n\n  const saveResultMutation = useMutation({\n    mutationFn: async (data: {\n      difficulty: Difficulty;\n      enabledEffects: StressEffects;\n      wpm: number;\n      accuracy: number;\n      errors: number;\n      maxCombo: number;\n      totalCharacters: number;\n      duration: number;\n      survivalTime: number;\n      completionRate: number;\n      stressScore: number;\n    }) => {\n      if (!user) {\n        throw new Error('You must be logged in to save results.');\n      }\n\n      if (!isOnline) {\n        setPendingResultData(data);\n        addPendingAction({\n          id: `stress_test_${Date.now()}`,\n          type: 'save_stress_test',\n          data,\n          timestamp: new Date(),\n          retryCount: 0,\n        });\n        throw new Error('OFFLINE: Your result will be saved when you reconnect.');\n      }\n\n      const serverReachable = await checkConnection();\n      if (!serverReachable) {\n        setPendingResultData(data);\n        addPendingAction({\n          id: `stress_test_${Date.now()}`,\n          type: 'save_stress_test',\n          data,\n          timestamp: new Date(),\n          retryCount: 0,\n        });\n        throw new Error('SERVER_UNREACHABLE: Your result will be saved when connection is restored.');\n      }\n\n      const res = await fetch('/api/stress-test', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify(data),\n      });\n      \n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({ message: 'Unknown error' }));\n        console.error('Save stress test error:', res.status, errorData);\n        \n        if (res.status === 401) {\n          setPendingResultData(null);\n          throw new Error('AUTH_ERROR: Please log in again to save your result.');\n        }\n        \n        if (res.status >= 500) {\n          setPendingResultData(data);\n          addPendingAction({\n            id: `stress_test_${Date.now()}`,\n            type: 'save_stress_test',\n            data,\n            timestamp: new Date(),\n            retryCount: 0,\n          });\n          throw new Error('SERVER_ERROR: Server error. Will retry automatically.');\n        }\n        \n        throw new Error(errorData.message || 'Failed to save result');\n      }\n      setPendingResultData(null);\n      return res.json();\n    },\n    retry: (failureCount, error) => {\n      const msg = error.message || '';\n      if (msg.includes('OFFLINE') || msg.includes('AUTH_ERROR')) return false;\n      if (msg.includes('SERVER_UNREACHABLE') || msg.includes('SERVER_ERROR')) {\n        return failureCount < 3;\n      }\n      return failureCount < 2;\n    },\n    retryDelay: (attemptIndex) => Math.min(1000 * Math.pow(2, attemptIndex), 10000),\n    onSuccess: (data) => {\n      if (data?.id) {\n        setLastTestResultId(data.id);\n      }\n      if (data?.isNewPersonalBest) {\n        toast({\n          title: \"ðŸ† New Personal Best!\",\n          description: \"You've set a new record for this difficulty level!\",\n        });\n      } else if (data?.isLeaderboardEntry) {\n        toast({\n          title: \"ðŸ“Š Leaderboard Entry!\",\n          description: \"Your score has been added to the leaderboard!\",\n        });\n      }\n    },\n    onError: (error) => {\n      console.error('Stress test save mutation error:', error);\n      const msg = error.message || '';\n      \n      if (msg.includes('OFFLINE') || msg.includes('SERVER_UNREACHABLE')) {\n        toast({\n          title: \"Connection Issue\",\n          description: \"Your result will be saved automatically when connection is restored.\",\n        });\n      } else if (msg.includes('AUTH_ERROR')) {\n        toast({\n          title: \"Session Expired\",\n          description: \"Please log in again to save your result.\",\n          variant: \"destructive\",\n        });\n      } else if (msg.includes('SERVER_ERROR')) {\n        toast({\n          title: \"Server Issue\",\n          description: \"We'll keep trying to save your result.\",\n        });\n      } else {\n        toast({\n          title: \"Save Failed\",\n          description: error.message || \"Could not save your result. Please try again.\",\n          variant: \"destructive\",\n        });\n      }\n    },\n  });\n\n  const retrySave = useCallback(async () => {\n    if (!pendingResultData || !user) return;\n    \n    const serverReachable = await checkConnection();\n    if (isOnline && serverReachable) {\n      saveResultMutation.mutate(pendingResultData);\n    }\n  }, [pendingResultData, isOnline, user, checkConnection, saveResultMutation]);\n\n  useEffect(() => {\n    if (isOnline && isServerReachable && pendingResultData && user && !saveResultMutation.isPending) {\n      const timer = setTimeout(() => {\n        retrySave();\n      }, 3000);\n      return () => clearTimeout(timer);\n    }\n  }, [isOnline, isServerReachable, pendingResultData, user, saveResultMutation.isPending, retrySave]);\n\n  const finishTest = useCallback((completed: boolean = false) => {\n    isTestActiveRef.current = false;\n    clearAllTimers();\n    resetVisualStates();\n    \n    setIsFinished(true);\n    setIsStarted(false);\n    setCountdown(0);\n    \n    completedRef.current = completed;\n    \n    setTypedText((currentTypedText) => {\n      typedTextRef.current = currentTypedText;\n      setCurrentText((currentTextValue) => {\n        currentTextRef.current = currentTextValue;\n        setErrors((currentErrors) => {\n          errorsRef.current = currentErrors;\n          setStartTime((currentStartTime) => {\n            startTimeRef.current = currentStartTime;\n            setSelectedDifficulty((currentDifficulty) => {\n              selectedDifficultyRef.current = currentDifficulty;\n              \n              const survivalTime = currentStartTime ? Math.max(0, (Date.now() - currentStartTime) / 1000) : 0;\n              const completionRate = currentTextValue.length > 0 \n                ? Math.min(100, (currentTypedText.length / currentTextValue.length) * 100)\n                : 0;\n              const correctChars = Math.max(0, currentTypedText.length - currentErrors);\n              const totalTyped = currentTypedText.length;\n              const wpm = survivalTime > 0 ? calculateWPM(correctChars, survivalTime) : 0;\n              const accuracy = totalTyped > 0 ? Math.min(100, calculateAccuracy(correctChars, totalTyped)) : 100;\n              \n              const difficultyMultiplier = currentDifficulty === 'impossible' ? 5 : \n                                           currentDifficulty === 'nightmare' ? 4 :\n                                           currentDifficulty === 'expert' ? 3 :\n                                           currentDifficulty === 'intermediate' ? 2 : 1;\n              const stressScore = Math.round((wpm * accuracy * completionRate * difficultyMultiplier) / 100);\n              \n              setFinalResults({ survivalTime, wpm, accuracy, completionRate, stressScore, completed });\n              \n              if (completed) {\n                playSound('complete');\n                if (!prefersReducedMotion) {\n                  confetti({\n                    particleCount: 200,\n                    spread: 100,\n                    origin: { y: 0.6 },\n                    colors: ['#ff0000', '#ff6600', '#ffaa00'],\n                  });\n                }\n              } else {\n                playSound('error');\n              }\n              \n              const diffConfig = currentDifficulty ? DIFFICULTY_CONFIGS[currentDifficulty] : null;\n              const currentMaxCombo = maxComboRef.current;\n              \n              if (diffConfig && currentDifficulty && user) {\n                saveResultMutation.mutate({\n                  difficulty: currentDifficulty,\n                  enabledEffects: diffConfig.effects,\n                  wpm: Math.round(Math.min(500, Math.max(0, wpm))),\n                  accuracy: Math.min(100, Math.max(0, accuracy)),\n                  errors: Math.max(0, currentErrors),\n                  maxCombo: Math.max(0, currentMaxCombo),\n                  totalCharacters: Math.max(0, currentTypedText.length),\n                  duration: Math.max(1, diffConfig.duration),\n                  survivalTime: Math.round(Math.max(0, survivalTime)),\n                  completionRate: Math.min(100, Math.max(0, completionRate)),\n                  stressScore: Math.max(0, stressScore),\n                });\n              }\n              \n              return currentDifficulty;\n            });\n            return currentStartTime;\n          });\n          return currentErrors;\n        });\n        return currentTextValue;\n      });\n      return currentTypedText;\n    });\n  }, [clearAllTimers, resetVisualStates, playSound, prefersReducedMotion, user, saveResultMutation]);\n\n  const hasShownFinishToast = useRef(false);\n  \n  useEffect(() => {\n    if (finalResults && isFinished && !hasShownFinishToast.current) {\n      hasShownFinishToast.current = true;\n      const { survivalTime, stressScore, completed } = finalResults;\n      \n      if (completed) {\n        toast({\n          title: \"ðŸŽ‰ Incredible!\",\n          description: `You completed the challenge with a Stress Score of ${stressScore}!`,\n        });\n      } else {\n        toast({\n          title: \"Time's Up!\",\n          description: `You lasted ${Math.round(survivalTime)}s with a Stress Score of ${stressScore}`,\n          variant: \"destructive\",\n        });\n      }\n    }\n    \n    if (!isFinished) {\n      hasShownFinishToast.current = false;\n    }\n  }, [finalResults, isFinished, toast]);\n\n  useEffect(() => {\n    if (isFinished && finalResults && user && lastTestResultId && !certificateData && selectedDifficulty) {\n      const config = DIFFICULTY_CONFIGS[selectedDifficulty];\n      const consistency = Math.round(Math.random() * 20 + 75);\n      const duration = Math.round(finalResults.survivalTime);\n      \n      const enabledEffects = config?.effects || {};\n      const activeChallenges = Object.entries(enabledEffects)\n        .filter(([, enabled]) => enabled)\n        .map(([key]) => EFFECT_DESCRIPTIONS[key as keyof StressEffects] || key);\n\n      const certData = {\n        wpm: finalResults.wpm,\n        accuracy: finalResults.accuracy,\n        consistency,\n        difficulty: config?.name || selectedDifficulty,\n        stressScore: finalResults.stressScore,\n        survivalTime: finalResults.survivalTime,\n        completionRate: finalResults.completionRate,\n        maxCombo,\n        activeChallenges,\n        duration,\n        username: user.username || 'Typing Expert',\n      };\n\n      setCertificateData(certData);\n\n      createCertificateMutation.mutate({\n        certificateType: \"stress\",\n        stressTestId: lastTestResultId,\n        wpm: finalResults.wpm,\n        accuracy: finalResults.accuracy,\n        consistency,\n        duration,\n        metadata: {\n          difficulty: config?.name || selectedDifficulty,\n          stressScore: finalResults.stressScore,\n          completionRate: finalResults.completionRate,\n          maxCombo,\n          activeChallenges,\n          username: user.username || 'Typing Expert',\n        },\n      });\n    }\n  }, [isFinished, finalResults, user, lastTestResultId, certificateData, selectedDifficulty, maxCombo, createCertificateMutation]);\n\n  useEffect(() => {\n    finishTestRef.current = finishTest;\n  }, [finishTest]);\n\n  const handleStart = useCallback((difficulty: Difficulty) => {\n    if (isStarted || countdown > 0) return;\n    \n    testSessionRef.current += 1;\n    const currentSession = testSessionRef.current;\n    \n    clearAllTimers();\n    isTestActiveRef.current = false;\n    \n    setTypedText('');\n    setErrors(0);\n    setCombo(0);\n    setMaxCombo(0);\n    maxComboRef.current = 0;\n    setIsFinished(false);\n    setFinalResults(null);\n    resetVisualStates();\n    \n    setSelectedDifficulty(difficulty);\n    selectedDifficultyRef.current = difficulty;\n    setCountdown(3);\n    const diffConfig = DIFFICULTY_CONFIGS[difficulty];\n    const generatedText = generateStressText(diffConfig.duration);\n    currentTextRef.current = generatedText;\n    setCurrentText(generatedText);\n    \n    toast({\n      title: `${diffConfig.icon} ${diffConfig.name}`,\n      description: `${diffConfig.duration} seconds - ${diffConfig.difficulty}`,\n    });\n    \n    countdownIntervalRef.current = setInterval(() => {\n      if (testSessionRef.current !== currentSession) {\n        if (countdownIntervalRef.current) {\n          clearInterval(countdownIntervalRef.current);\n          countdownIntervalRef.current = null;\n        }\n        return;\n      }\n      \n      setCountdown((prev) => {\n        if (prev <= 1) {\n          if (countdownIntervalRef.current) {\n            clearInterval(countdownIntervalRef.current);\n            countdownIntervalRef.current = null;\n          }\n          \n          isTestActiveRef.current = true;\n          setIsStarted(true);\n          setStartTime(Date.now());\n          setTimeLeft(DIFFICULTY_CONFIGS[difficulty].duration);\n          \n          setTimeout(() => inputRef.current?.focus(), 50);\n          return 0;\n        }\n        playSound('warning');\n        return prev - 1;\n      });\n    }, 1000);\n  }, [isStarted, countdown, clearAllTimers, resetVisualStates, toast, playSound]);\n\n  const calculateStressLevel = useCallback(() => {\n    if (!config || !startTime) return 0;\n    const elapsed = (Date.now() - startTime) / 1000;\n    const progress = Math.min(1, Math.max(0, elapsed / config.duration));\n    return progress * 100;\n  }, [config, startTime]);\n\n  const handleInputChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {\n    if (!isStarted || isFinished || !isTestActiveRef.current) return;\n    \n    const value = e.target.value;\n    const lastChar = value[value.length - 1];\n    const expectedChar = currentText[typedText.length];\n    \n    if (lastChar === expectedChar) {\n      playSound('type');\n      typedTextRef.current = value;\n      setTypedText(value);\n      setCombo((prev) => {\n        const newCombo = prev + 1;\n        if (newCombo > maxComboRef.current) {\n          maxComboRef.current = newCombo;\n          setMaxCombo(newCombo);\n        }\n        if (newCombo % 10 === 0 && newCombo > 0) {\n          playSound('combo');\n          if (!prefersReducedMotion && selectedDifficulty !== 'beginner') {\n            setComboExplosion(true);\n            safeTimeout(() => setComboExplosion(false), 500);\n          }\n        }\n        return newCombo;\n      });\n      \n      if (value === currentText) {\n        finishTestRef.current(true);\n      }\n    } else {\n      playSound('error');\n      setErrors((prev) => prev + 1);\n      setCombo(0);\n      \n      if (config?.effects.screenShake && !prefersReducedMotion) {\n        const intensity = config.baseShakeIntensity + (stressLevel / 5);\n        setShakeIntensity(intensity);\n        safeTimeout(() => setShakeIntensity(0), 400);\n        \n        setBackgroundFlash(true);\n        safeTimeout(() => setBackgroundFlash(false), 100);\n      }\n    }\n  }, [isStarted, isFinished, currentText, typedText, playSound, prefersReducedMotion, selectedDifficulty, config, stressLevel, safeTimeout]);\n\n  useEffect(() => {\n    if (!isStarted || isFinished) return;\n    \n    const currentSession = testSessionRef.current;\n    \n    timerIntervalRef.current = setInterval(() => {\n      if (testSessionRef.current !== currentSession || !isTestActiveRef.current) {\n        if (timerIntervalRef.current) {\n          clearInterval(timerIntervalRef.current);\n          timerIntervalRef.current = null;\n        }\n        return;\n      }\n      \n      setTimeLeft((prev) => {\n        if (prev <= 1) {\n          finishTestRef.current(false);\n          return 0;\n        }\n        if (prev <= 5) {\n          playSound('warning');\n        }\n        return prev - 1;\n      });\n    }, 1000);\n    \n    return () => {\n      if (timerIntervalRef.current) {\n        clearInterval(timerIntervalRef.current);\n        timerIntervalRef.current = null;\n      }\n    };\n  }, [isStarted, isFinished, playSound]);\n\n  const hasShown10SecWarning = useRef(false);\n  const lastComboMilestone = useRef(0);\n  const lastProgressMilestone = useRef(0);\n  const [activeEffectWarning, setActiveEffectWarning] = useState<string | null>(null);\n  \n  useEffect(() => {\n    if (timeLeft === 10 && isStarted && !isFinished && !hasShown10SecWarning.current) {\n      hasShown10SecWarning.current = true;\n      playSound('warning');\n      toast({\n        title: \"â° 10 Seconds Left!\",\n        description: \"Final push!\",\n        variant: \"destructive\",\n      });\n    }\n    if (timeLeft > 10) {\n      hasShown10SecWarning.current = false;\n    }\n  }, [timeLeft, isStarted, isFinished, playSound, toast]);\n\n  useEffect(() => {\n    if (!isStarted || isFinished) {\n      lastComboMilestone.current = 0;\n      return;\n    }\n    \n    if (combo === 50 && lastComboMilestone.current < 50) {\n      lastComboMilestone.current = 50;\n      toast({\n        title: \"ðŸ”¥ 50 Combo!\",\n        description: \"You're on fire!\",\n      });\n    } else if (combo === 100 && lastComboMilestone.current < 100) {\n      lastComboMilestone.current = 100;\n      toast({\n        title: \"âš¡ 100 Combo!\",\n        description: \"Incredible focus!\",\n      });\n    }\n  }, [combo, isStarted, isFinished, toast]);\n\n  useEffect(() => {\n    if (!isStarted || isFinished || !currentText.length) {\n      lastProgressMilestone.current = 0;\n      return;\n    }\n    \n    const progress = Math.floor((typedText.length / currentText.length) * 100);\n    \n    if (selectedDifficulty === 'intermediate') {\n      if (progress >= 25 && lastProgressMilestone.current < 25) {\n        lastProgressMilestone.current = 25;\n        toast({\n          title: \"ðŸ’ª 25% Complete!\",\n          description: \"Great start! Effects are warming up...\",\n        });\n      } else if (progress >= 50 && lastProgressMilestone.current < 50) {\n        lastProgressMilestone.current = 50;\n        toast({\n          title: \"âš¡ Halfway There!\",\n          description: \"Chaos intensifying - stay focused!\",\n        });\n      } else if (progress >= 75 && lastProgressMilestone.current < 75) {\n        lastProgressMilestone.current = 75;\n        toast({\n          title: \"ðŸ”¥ 75% - Almost There!\",\n          description: \"Final stretch - you've got this!\",\n        });\n      }\n    }\n  }, [typedText.length, currentText.length, isStarted, isFinished, selectedDifficulty, toast]);\n\n  useEffect(() => {\n    if (!isStarted || !config || !isTestActiveRef.current) return;\n    \n    const currentSession = testSessionRef.current;\n    \n    stressIntervalRef.current = setInterval(() => {\n      if (testSessionRef.current !== currentSession || !isTestActiveRef.current) return;\n      setStressLevel(calculateStressLevel());\n    }, 100);\n    \n    return () => {\n      if (stressIntervalRef.current) {\n        clearInterval(stressIntervalRef.current);\n        stressIntervalRef.current = null;\n      }\n    };\n  }, [isStarted, config, calculateStressLevel]);\n\n  useEffect(() => {\n    if (!isStarted || !config || prefersReducedMotion || !isTestActiveRef.current) return;\n    \n    const currentSession = testSessionRef.current;\n    const currentConfig = config;\n    \n    effectsIntervalRef.current = setInterval(() => {\n      if (testSessionRef.current !== currentSession || !isTestActiveRef.current) return;\n      \n      const currentStress = stressLevelRef.current;\n      const intensity = currentConfig.effects.speedIncrease \n        ? 1 + (currentStress / 50)\n        : 1;\n      \n      if (currentConfig.effects.distractions && Math.random() > (1 - currentConfig.particleFrequency)) {\n        const emojis = ['ðŸ’¥', 'âš¡', 'ðŸ”¥', 'ðŸ’€', 'ðŸ‘»', 'ðŸŒŸ', 'ðŸ’«', 'âœ¨', 'â­', 'ðŸ’£', 'ðŸŽ¯', 'ðŸŽª', 'ðŸŽ¨', 'ðŸŽ­'];\n        const particleCount = Math.min(3, Math.floor(1 + intensity * 2));\n        \n        setParticles((prev) => {\n          if (prev.length >= MAX_PARTICLES) {\n            const newParticles = prev.slice(-MAX_PARTICLES + particleCount);\n            const additions: ParticleData[] = [];\n            for (let i = 0; i < particleCount; i++) {\n              particleIdRef.current += 1;\n              additions.push({\n                id: particleIdRef.current,\n                x: Math.random() * 100,\n                y: Math.random() * 100,\n                emoji: emojis[Math.floor(Math.random() * emojis.length)],\n                speed: 1 + Math.random() * 2,\n              });\n            }\n            return [...newParticles, ...additions];\n          }\n          \n          const additions: ParticleData[] = [];\n          for (let i = 0; i < particleCount; i++) {\n            particleIdRef.current += 1;\n            additions.push({\n              id: particleIdRef.current,\n              x: Math.random() * 100,\n              y: Math.random() * 100,\n              emoji: emojis[Math.floor(Math.random() * emojis.length)],\n              speed: 1 + Math.random() * 2,\n            });\n          }\n          return [...prev, ...additions];\n        });\n        \n        safeTimeout(() => {\n          setParticles((prev) => prev.slice(particleCount));\n        }, 1500 / intensity);\n        \n        playSound('chaos');\n      }\n      \n      if (currentConfig.effects.colorShift) {\n        const hue = Math.random() * 360;\n        const saturation = 60 + Math.random() * 40;\n        const lightness = 40 + Math.random() * 20;\n        setCurrentColor(`hsl(${hue}, ${saturation}%, ${lightness}%)`);\n      }\n      \n      if (currentConfig.effects.limitedVisibility && !isClarityWindowRef.current && !currentConfig.blurPulse) {\n        const maxBlurValue = currentConfig.maxBlur ?? 3;\n        const constantBlur = currentConfig.constantBlur ?? 0;\n        setBlur(constantBlur + Math.random() * Math.min(maxBlurValue - constantBlur, 1.5 * intensity));\n      }\n      \n      if (currentConfig.chromaticAberration && !isClarityWindowRef.current) {\n        const aberrationIntensity = currentConfig.realityDistortion ? 8 : 4;\n        setChromaticOffset({\n          r: (Math.random() - 0.5) * aberrationIntensity * intensity,\n          g: (Math.random() - 0.5) * aberrationIntensity * intensity,\n          b: (Math.random() - 0.5) * aberrationIntensity * intensity,\n        });\n      }\n      \n      if (currentConfig.realityDistortion && !isClarityWindowRef.current) {\n        setRealityWarp(Math.sin(Date.now() / 300) * 10 * intensity);\n      }\n      \n      if (currentConfig.textScramble && Math.random() > 0.92) {\n        setTextScrambleActive(true);\n        safeTimeout(() => setTextScrambleActive(false), 200 + Math.random() * 300);\n      }\n      \n      if (currentConfig.extremeChaosWaves && Math.random() > 0.85) {\n        setChaosWaveIntensity(1 + Math.random() * 2);\n        safeTimeout(() => setChaosWaveIntensity(0), 500 + Math.random() * 500);\n      }\n      \n      if (currentConfig.multiEffectCombos && Math.random() > 0.9) {\n        setMultiEffectActive(true);\n        setScreenInverted(true);\n        setGlitchActive(true);\n        setZoomScale(0.7 + Math.random() * 0.6);\n        safeTimeout(() => {\n          setMultiEffectActive(false);\n          setScreenInverted(false);\n          setGlitchActive(false);\n          setZoomScale(1);\n        }, 400 + Math.random() * 400);\n      }\n      \n      if (currentConfig.effects.rotation && !isClarityWindowRef.current) {\n        setRotation((Math.random() - 0.5) * 8 * intensity);\n      }\n      \n      if (currentConfig.effects.gravity) {\n        setGravityOffset(Math.sin(Date.now() / 200) * 15 * intensity);\n      }\n      \n      if (currentConfig.effects.glitch && Math.random() > 0.85) {\n        setGlitchActive(true);\n        safeTimeout(() => setGlitchActive(false), 30 + Math.random() * 70);\n      }\n      \n      if (currentConfig.effects.textFade && !isClarityWindowRef.current) {\n        setTextOpacity(0.6 + Math.random() * 0.4);\n      }\n      \n      if (currentConfig.effects.reverseText && Math.random() > 0.9) {\n        setTextReversed(true);\n        safeTimeout(() => setTextReversed(false), 500 + Math.random() * 1000);\n      }\n      \n      if (currentConfig.effects.randomJumps && Math.random() > 0.85) {\n        setTextPosition({\n          x: (Math.random() - 0.5) * 100,\n          y: (Math.random() - 0.5) * 50,\n        });\n        safeTimeout(() => setTextPosition({ x: 0, y: 0 }), 300);\n      }\n      \n      if (currentConfig.effects.screenInvert && Math.random() > 0.7) {\n        const progressPercent = currentTextRef.current.length > 0 \n          ? (typedTextRef.current.length / currentTextRef.current.length) * 100 : 0;\n        \n        if (selectedDifficultyRef.current === 'intermediate' && progressPercent < 30) {\n        } else if (selectedDifficultyRef.current === 'intermediate') {\n          setActiveEffectWarning('ðŸ”„ Screen Invert!');\n          safeTimeout(() => {\n            setActiveEffectWarning(null);\n            setScreenInverted(true);\n            safeTimeout(() => setScreenInverted(false), 800 + Math.random() * 1200);\n          }, 500);\n        } else {\n          setScreenInverted(true);\n          safeTimeout(() => setScreenInverted(false), 800 + Math.random() * 1200);\n        }\n      }\n      \n      if (currentConfig.effects.zoomChaos && Math.random() > 0.8 && !isClarityWindowRef.current) {\n        const progressPercent = currentTextRef.current.length > 0 \n          ? (typedTextRef.current.length / currentTextRef.current.length) * 100 : 0;\n        \n        if (selectedDifficultyRef.current === 'intermediate' && progressPercent < 40) {\n        } else if (selectedDifficultyRef.current === 'intermediate') {\n          setActiveEffectWarning('ðŸ” Zoom Chaos!');\n          safeTimeout(() => {\n            setActiveEffectWarning(null);\n            const zoomRange = 0.3 + (stressLevelRef.current / 150);\n            setZoomScale(0.8 + Math.random() * zoomRange);\n            safeTimeout(() => setZoomScale(1), 400 + Math.random() * 500);\n          }, 500);\n        } else {\n          const zoomRange = 0.2 + (stressLevelRef.current / 200);\n          setZoomScale(0.85 + Math.random() * zoomRange);\n          safeTimeout(() => setZoomScale(1), 400 + Math.random() * 400);\n        }\n      }\n      \n      if (currentConfig.effects.screenFlip && Math.random() > 0.9) {\n        setScreenFlipped(true);\n        safeTimeout(() => setScreenFlipped(false), 600 + Math.random() * 800);\n      }\n      \n    }, 200);\n    \n    return () => {\n      if (effectsIntervalRef.current) {\n        clearInterval(effectsIntervalRef.current);\n        effectsIntervalRef.current = null;\n      }\n    };\n  }, [isStarted, config, prefersReducedMotion, playSound, safeTimeout]);\n\n  useEffect(() => {\n    if (!isStarted || !config?.effects.screenShake || prefersReducedMotion || !isTestActiveRef.current) return;\n    \n    const currentSession = testSessionRef.current;\n    const baseShake = config.baseShakeIntensity;\n    \n    shakeIntervalRef.current = setInterval(() => {\n      if (testSessionRef.current !== currentSession || !isTestActiveRef.current) return;\n      const stressBonus = (stressLevelRef.current / 100) * baseShake;\n      const totalIntensity = baseShake + stressBonus;\n      setShakeIntensity(totalIntensity);\n      setShakeOffset({\n        x: (Math.random() - 0.5) * 2 * totalIntensity,\n        y: (Math.random() - 0.5) * 2 * totalIntensity,\n      });\n    }, 50);\n    \n    return () => {\n      if (shakeIntervalRef.current) {\n        clearInterval(shakeIntervalRef.current);\n        shakeIntervalRef.current = null;\n      }\n    };\n  }, [isStarted, config, prefersReducedMotion]);\n\n  useEffect(() => {\n    if (!isStarted || !config || prefersReducedMotion || !isTestActiveRef.current) return;\n    \n    const currentSession = testSessionRef.current;\n    const clarityDuration = 2000;\n    const chaosDuration = selectedDifficulty === 'nightmare' || selectedDifficulty === 'impossible' ? 4000 : 6000;\n    \n    const triggerClarity = () => {\n      if (testSessionRef.current !== currentSession || !isTestActiveRef.current) return;\n      \n      setIsClarityWindow(true);\n      isClarityWindowRef.current = true;\n      setBlur(0);\n      setTextOpacity(1);\n      setRotation(0);\n      setZoomScale(1);\n      setChromaticOffset({ r: 0, g: 0, b: 0 });\n      setRealityWarp(0);\n      setChaosWaveIntensity(0);\n      \n      setTimeout(() => {\n        if (testSessionRef.current === currentSession && isTestActiveRef.current) {\n          setIsClarityWindow(false);\n          isClarityWindowRef.current = false;\n        }\n      }, clarityDuration);\n    };\n    \n    triggerClarity();\n    \n    clarityIntervalRef.current = setInterval(() => {\n      triggerClarity();\n    }, clarityDuration + chaosDuration);\n    \n    return () => {\n      if (clarityIntervalRef.current) {\n        clearInterval(clarityIntervalRef.current);\n        clarityIntervalRef.current = null;\n      }\n    };\n  }, [isStarted, config, selectedDifficulty, prefersReducedMotion]);\n\n  useEffect(() => {\n    if (!isStarted || !config || prefersReducedMotion || !isTestActiveRef.current) return;\n    if (!config.effects.limitedVisibility || !config.blurPulse) return;\n    \n    const currentSession = testSessionRef.current;\n    const maxBlurValue = config.maxBlur ?? 3;\n    const constantBlur = config.constantBlur ?? 0;\n    const pulseSpeed = config.blurPulseSpeed ?? 0.15;\n    const hasDoubleVision = config.doubleVision ?? false;\n    const hasTextWarp = config.textWarp ?? false;\n    const chaosMultiplier = config.chaosIntensityMultiplier ?? 1;\n    \n    blurIntervalRef.current = setInterval(() => {\n      if (testSessionRef.current !== currentSession || !isTestActiveRef.current) return;\n      \n      if (!isClarityWindowRef.current) {\n        blurPulsePhaseRef.current = (blurPulsePhaseRef.current + pulseSpeed) % (Math.PI * 2);\n        const pulseBlur = constantBlur + ((Math.sin(blurPulsePhaseRef.current) + 1) * 0.5 * (maxBlurValue - constantBlur));\n        setBlur(pulseBlur);\n        \n        if (hasDoubleVision) {\n          const visionPhase = blurPulsePhaseRef.current * 1.5;\n          const visionIntensity = 3 + Math.sin(visionPhase) * 2 * chaosMultiplier;\n          setDoubleVisionOffset({\n            x: Math.sin(visionPhase) * visionIntensity,\n            y: Math.cos(visionPhase * 0.7) * visionIntensity * 0.5,\n          });\n        }\n        \n        if (hasTextWarp) {\n          const warpPhase = blurPulsePhaseRef.current * 2;\n          setTextWarpAmount(Math.sin(warpPhase) * 3 * chaosMultiplier);\n        }\n      } else {\n        if (hasDoubleVision) setDoubleVisionOffset({ x: 0, y: 0 });\n        if (hasTextWarp) setTextWarpAmount(0);\n      }\n    }, 50);\n    \n    return () => {\n      if (blurIntervalRef.current) {\n        clearInterval(blurIntervalRef.current);\n        blurIntervalRef.current = null;\n      }\n    };\n  }, [isStarted, config, prefersReducedMotion]);\n\n  useEffect(() => {\n    if (!isStarted || isFinished) return;\n    \n    const handleEscapeKey = (e: KeyboardEvent) => {\n      if (e.key === 'Escape' && isTestActiveRef.current) {\n        finishTest(false);\n        toast({\n          title: \"Test Aborted\",\n          description: \"You quit the test early. No score saved.\",\n          variant: \"destructive\",\n        });\n      }\n    };\n    \n    window.addEventListener('keydown', handleEscapeKey);\n    return () => window.removeEventListener('keydown', handleEscapeKey);\n  }, [isStarted, isFinished, finishTest, toast]);\n\n  const handleReset = useCallback(() => {\n    testSessionRef.current += 1;\n    isTestActiveRef.current = false;\n    clearAllTimers();\n    setSelectedDifficulty(null);\n    setIsStarted(false);\n    setIsFinished(false);\n    setCountdown(0);\n    setTypedText('');\n    setErrors(0);\n    setCombo(0);\n    setMaxCombo(0);\n    maxComboRef.current = 0;\n    setFinalResults(null);\n    resetVisualStates();\n  }, [clearAllTimers, resetVisualStates]);\n\n  const displayText = textReversed ? currentText.split('').reverse().join('') : currentText;\n  \n  const renderedCharacters = useMemo(() => {\n    if (!currentText) return [];\n    const textLength = currentText.length;\n    return displayText.split('').map((char, displayIndex) => {\n      const originalIndex = textReversed ? (textLength - 1 - displayIndex) : displayIndex;\n      \n      let color = 'text-muted-foreground';\n      if (originalIndex < typedText.length) {\n        color = typedText[originalIndex] === currentText[originalIndex] ? 'text-green-500' : 'text-red-500';\n      } else if (originalIndex === typedText.length) {\n        color = 'text-primary bg-primary/20';\n      }\n      return { char, color, index: displayIndex };\n    });\n  }, [displayText, typedText, currentText, textReversed]);\n\n  if (!selectedDifficulty || (!isStarted && !isFinished && countdown === 0)) {\n    return (\n      <TooltipProvider delayDuration={200}>\n        <div className=\"container mx-auto px-4 py-8\">\n          <div className=\"mb-8 flex items-center justify-between\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Link href=\"/\">\n                  <Button variant=\"ghost\" size=\"sm\" className=\"gap-2\" data-testid=\"button-back\">\n                    <ArrowLeft className=\"w-4 h-4\" />\n                    Back\n                  </Button>\n                </Link>\n              </TooltipTrigger>\n              <TooltipContent side=\"bottom\">\n                <p>Return to home page</p>\n              </TooltipContent>\n            </Tooltip>\n            \n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Link href=\"/stress-leaderboard\">\n                  <Button variant=\"outline\" size=\"sm\" className=\"gap-2\" data-testid=\"button-leaderboard\">\n                    <Trophy className=\"w-4 h-4\" />\n                    Leaderboard\n                  </Button>\n                </Link>\n              </TooltipTrigger>\n              <TooltipContent side=\"bottom\">\n                <p>View top stress test scores from all players</p>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n\n          <div className=\"max-w-4xl mx-auto\">\n            <div className=\"text-center mb-12\">\n              <div className=\"inline-flex items-center gap-3 mb-4\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div>\n                      <Zap className={`w-12 h-12 text-primary cursor-help ${prefersReducedMotion ? '' : 'animate-pulse'}`} />\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\">\n                    <p>High intensity typing challenge</p>\n                  </TooltipContent>\n                </Tooltip>\n                \n                <h1 className=\"text-5xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-red-500 via-orange-500 to-yellow-500\">\n                  Typing Stress Test\n                </h1>\n                \n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div>\n                      <Skull className={`w-12 h-12 text-destructive cursor-help ${prefersReducedMotion ? '' : 'animate-bounce'}`} />\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent side=\"top\">\n                    <p>Test your typing under extreme pressure!</p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n              \n              <p className=\"text-xl text-muted-foreground max-w-2xl mx-auto\">\n                Can you type while the world collapses around you? Choose your nightmare.\n              </p>\n              \n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"mt-6 p-4 bg-destructive/10 border border-destructive/20 rounded-lg max-w-xl mx-auto cursor-help\" role=\"alert\">\n                    <div className=\"flex items-center gap-2 justify-center text-destructive\">\n                      <AlertTriangle className=\"w-5 h-5\" aria-hidden=\"true\" />\n                      <p className=\"font-semibold\">Warning: May cause extreme frustration</p>\n                    </div>\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\" className=\"max-w-xs\">\n                  <p>This mode features intense visual effects including screen shake, color shifts, and text distortions. Not recommended for those sensitive to flashing lights.</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8\" role=\"list\" aria-label=\"Difficulty levels\">\n              {(Object.keys(DIFFICULTY_CONFIGS) as Difficulty[]).map((difficulty) => {\n                const diffConfig = DIFFICULTY_CONFIGS[difficulty];\n                const activeEffects = Object.entries(diffConfig.effects).filter(([_, enabled]) => enabled);\n                \n                return (\n                  <Tooltip key={difficulty}>\n                    <TooltipTrigger asChild>\n                      <Card\n                        className={`relative overflow-hidden cursor-pointer transition-all duration-300 hover:scale-105 hover:shadow-2xl border-2 ${\n                          difficulty === 'impossible' \n                            ? `border-purple-500 hover:border-purple-400 ${prefersReducedMotion ? '' : 'animate-pulse'}` \n                            : 'border-border hover:border-primary'\n                        }`}\n                        onClick={() => handleStart(difficulty)}\n                        data-testid={`card-difficulty-${difficulty}`}\n                        role=\"listitem\"\n                        tabIndex={0}\n                        onKeyDown={(e) => {\n                          if (e.key === 'Enter' || e.key === ' ') {\n                            e.preventDefault();\n                            handleStart(difficulty);\n                          }\n                        }}\n                        aria-label={`${diffConfig.name} - ${diffConfig.difficulty}`}\n                      >\n                        <div className={`absolute inset-0 bg-gradient-to-br ${diffConfig.color} opacity-50`} aria-hidden=\"true\" />\n                        <CardContent className=\"relative p-6\">\n                          <div className=\"text-center mb-4\">\n                            <div className=\"text-6xl mb-2\" aria-hidden=\"true\">{diffConfig.icon}</div>\n                            <h3 className=\"text-2xl font-bold mb-2\">{diffConfig.name}</h3>\n                            <p className=\"text-sm text-muted-foreground mb-4\">{diffConfig.description}</p>\n                            \n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <div className=\"inline-flex items-center gap-2 px-3 py-1 bg-background/80 rounded-full text-sm font-mono cursor-help\">\n                                  <Clock className=\"w-3 h-3\" aria-hidden=\"true\" />\n                                  {diffConfig.duration}s duration\n                                </div>\n                              </TooltipTrigger>\n                              <TooltipContent side=\"top\">\n                                <p>You have {diffConfig.duration} seconds to complete the text</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          </div>\n                          \n                          <div className=\"space-y-2 text-xs\">\n                            <div className=\"flex items-center justify-center gap-1 font-semibold mb-2\">\n                              <span>Active Torments:</span>\n                              <Tooltip>\n                                <TooltipTrigger asChild>\n                                  <HelpCircle className=\"w-3 h-3 text-muted-foreground cursor-help\" />\n                                </TooltipTrigger>\n                                <TooltipContent side=\"top\" className=\"max-w-xs\">\n                                  <p>Effects that will make your typing experience chaotic. Hover over each effect for details.</p>\n                                </TooltipContent>\n                              </Tooltip>\n                            </div>\n                            {activeEffects.map(([effect]) => (\n                              <Tooltip key={effect}>\n                                <TooltipTrigger asChild>\n                                  <div className=\"flex items-center gap-2 bg-background/60 px-2 py-1 rounded cursor-help hover:bg-background/80 transition-colors\">\n                                    <span className={`w-2 h-2 bg-destructive rounded-full ${prefersReducedMotion ? '' : 'animate-pulse'}`} aria-hidden=\"true\" />\n                                    <span className=\"capitalize\">{effect.replace(/([A-Z])/g, ' $1').trim()}</span>\n                                  </div>\n                                </TooltipTrigger>\n                                <TooltipContent side=\"right\" className=\"max-w-xs\">\n                                  <p>{EFFECT_DESCRIPTIONS[effect as keyof StressEffects]}</p>\n                                </TooltipContent>\n                              </Tooltip>\n                            ))}\n                          </div>\n                        </CardContent>\n                      </Card>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"bottom\" className=\"max-w-xs\">\n                      <div className=\"space-y-1\">\n                        <p className=\"font-semibold\">{diffConfig.difficulty}</p>\n                        {difficulty === 'intermediate' && (\n                          <>\n                            <p className=\"text-xs text-green-400\">âœ“ Progressive chaos - effects ramp up gradually</p>\n                            <p className=\"text-xs text-green-400\">âœ“ Milestone encouragement at 25%, 50%, 75%</p>\n                            <p className=\"text-xs text-green-400\">âœ“ Effect warnings before disorienting moments</p>\n                          </>\n                        )}\n                        {difficulty === 'beginner' && (\n                          <p className=\"text-xs text-green-400\">âœ“ Perfect for learning the chaos mechanics</p>\n                        )}\n                        {difficulty === 'nightmare' && (\n                          <>\n                            <p className=\"text-xs text-purple-400\">âœ“ Pulsing blur waves - text clarity fluctuates</p>\n                            <p className=\"text-xs text-purple-400\">âœ“ Chromatic aberration - RGB color splitting</p>\n                            <p className=\"text-xs text-purple-400\">âœ“ Blur intensity: {diffConfig.constantBlur}px - {diffConfig.maxBlur}px</p>\n                          </>\n                        )}\n                        {difficulty === 'impossible' && (\n                          <>\n                            <p className=\"text-xs text-red-400\">âœ“ Reality distortion - screen warps and skews</p>\n                            <p className=\"text-xs text-red-400\">âœ“ Text scramble - characters shift randomly</p>\n                            <p className=\"text-xs text-red-400\">âœ“ Extreme chaos waves - contrast/brightness bursts</p>\n                            <p className=\"text-xs text-red-400\">âœ“ Multi-effect combos - simultaneous chaos!</p>\n                            <p className=\"text-xs text-red-400\">âœ“ Enhanced chromatic aberration</p>\n                            <p className=\"text-xs text-red-400\">âœ“ Heavy blur: {diffConfig.constantBlur}px - {diffConfig.maxBlur}px</p>\n                          </>\n                        )}\n                        <p className=\"text-xs text-muted-foreground\">{activeEffects.length} active effects</p>\n                      </div>\n                    </TooltipContent>\n                  </Tooltip>\n                );\n              })}\n            </div>\n\n            <div className=\"text-center\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => setSoundEnabled(!soundEnabled)}\n                    className=\"gap-2\"\n                    data-testid=\"button-toggle-sound\"\n                    aria-pressed={soundEnabled}\n                  >\n                    {soundEnabled ? <Volume2 className=\"w-4 h-4\" /> : <VolumeX className=\"w-4 h-4\" />}\n                    {soundEnabled ? 'Sound On' : 'Sound Off'}\n                  </Button>\n                </TooltipTrigger>\n                <TooltipContent side=\"top\">\n                  <p>{soundEnabled ? 'Click to mute chaotic sound effects' : 'Click to enable sound effects during the test'}</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n          </div>\n        </div>\n      </TooltipProvider>\n    );\n  }\n\n  if (countdown > 0 && !isStarted) {\n    return (\n      <TooltipProvider>\n        <div className=\"fixed inset-0 bg-background/95 backdrop-blur-sm flex items-center justify-center z-50\" role=\"alert\" aria-live=\"assertive\">\n          <div className=\"text-center\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <h2 className=\"text-2xl font-bold mb-4 text-muted-foreground cursor-help\">Get Ready...</h2>\n              </TooltipTrigger>\n              <TooltipContent side=\"top\">\n                <p>Focus on the screen - chaos begins soon!</p>\n              </TooltipContent>\n            </Tooltip>\n            <div className={`text-9xl font-bold text-destructive ${prefersReducedMotion ? '' : 'animate-bounce'}`} aria-label={`Starting in ${countdown}`}>\n              {countdown}\n            </div>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <p className=\"text-xl text-muted-foreground mt-4 cursor-help\">\n                  {config?.name}\n                </p>\n              </TooltipTrigger>\n              <TooltipContent side=\"bottom\">\n                <p>{config?.description}</p>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n        </div>\n      </TooltipProvider>\n    );\n  }\n\n  if (isFinished && finalResults) {\n    const { survivalTime, wpm, accuracy, completionRate, stressScore } = finalResults;\n\n    return (\n      <TooltipProvider delayDuration={200}>\n        <div className=\"container mx-auto px-4 py-8\">\n          <div className=\"max-w-2xl mx-auto\">\n            <Card>\n              <CardContent className=\"p-8\">\n                <div className=\"text-center mb-8\" role=\"status\" aria-live=\"polite\">\n                  <Trophy className=\"w-16 h-16 mx-auto mb-4 text-primary\" aria-hidden=\"true\" />\n                  \n                  <h2 className=\"text-4xl font-bold mb-2\">\n                    {completionRate >= 100 ? 'ðŸŽ‰ Completed!' : 'ðŸ’€ Survived!'}\n                  </h2>\n                  \n                  <p className=\"text-lg text-muted-foreground mb-2\">\n                    {config?.name} Â· {config?.difficulty}\n                  </p>\n                  \n                  <div className=\"inline-flex items-center gap-2 bg-primary/10 px-6 py-3 rounded-full\">\n                    <span className=\"text-sm text-muted-foreground\">Stress Score</span>\n                    <span className=\"text-3xl font-bold text-primary\">{stressScore}</span>\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4 mb-8\" role=\"list\" aria-label=\"Test results\">\n                  <div className=\"text-center p-4 bg-muted rounded-lg hover:bg-muted/80 transition-colors\" data-testid=\"stat-wpm\" role=\"listitem\">\n                    <div className=\"text-3xl font-bold text-primary\" aria-label={`${wpm} words per minute`}>{wpm}</div>\n                    <div className=\"text-sm text-muted-foreground flex items-center justify-center gap-1\">\n                      <BarChart3 className=\"w-3 h-3\" aria-hidden=\"true\" />\n                      WPM\n                    </div>\n                  </div>\n                  \n                  <div className=\"text-center p-4 bg-muted rounded-lg hover:bg-muted/80 transition-colors\" data-testid=\"stat-accuracy\" role=\"listitem\">\n                    <div className=\"text-3xl font-bold text-green-500\" aria-label={`${accuracy.toFixed(1)} percent accuracy`}>{accuracy.toFixed(1)}%</div>\n                    <div className=\"text-sm text-muted-foreground flex items-center justify-center gap-1\">\n                      <Target className=\"w-3 h-3\" aria-hidden=\"true\" />\n                      Accuracy\n                    </div>\n                  </div>\n                  \n                  <div className=\"text-center p-4 bg-muted rounded-lg hover:bg-muted/80 transition-colors\" data-testid=\"stat-completion\" role=\"listitem\">\n                    <div className=\"text-3xl font-bold text-orange-500\" aria-label={`${completionRate.toFixed(1)} percent completed`}>{completionRate.toFixed(1)}%</div>\n                    <div className=\"text-sm text-muted-foreground flex items-center justify-center gap-1\">\n                      <Eye className=\"w-3 h-3\" aria-hidden=\"true\" />\n                      Completed\n                    </div>\n                  </div>\n                  \n                  <div className=\"text-center p-4 bg-muted rounded-lg hover:bg-muted/80 transition-colors\" data-testid=\"stat-combo\" role=\"listitem\">\n                    <div className=\"text-3xl font-bold text-purple-500\" aria-label={`Maximum combo of ${maxCombo}`}>{maxCombo}</div>\n                    <div className=\"text-sm text-muted-foreground flex items-center justify-center gap-1\">\n                      <Flame className=\"w-3 h-3\" aria-hidden=\"true\" />\n                      Max Combo\n                    </div>\n                  </div>\n                  \n                  <div className=\"text-center p-4 bg-muted rounded-lg hover:bg-muted/80 transition-colors\" data-testid=\"stat-errors\" role=\"listitem\">\n                    <div className=\"text-3xl font-bold text-red-500\" aria-label={`${errors} errors`}>{errors}</div>\n                    <div className=\"text-sm text-muted-foreground flex items-center justify-center gap-1\">\n                      <XCircle className=\"w-3 h-3\" aria-hidden=\"true\" />\n                      Errors\n                    </div>\n                  </div>\n                  \n                  <div className=\"text-center p-4 bg-muted rounded-lg hover:bg-muted/80 transition-colors\" data-testid=\"stat-survival\" role=\"listitem\">\n                    <div className=\"text-3xl font-bold text-blue-500\" aria-label={`Survived ${Math.round(survivalTime)} seconds`}>{Math.round(survivalTime)}s</div>\n                    <div className=\"text-sm text-muted-foreground flex items-center justify-center gap-1\">\n                      <Timer className=\"w-3 h-3\" aria-hidden=\"true\" />\n                      Survival Time\n                    </div>\n                  </div>\n                </div>\n\n                {!user && (\n                  <div className=\"mb-6 p-4 bg-amber-500/10 border border-amber-500/30 rounded-lg\" data-testid=\"login-prompt\">\n                    <div className=\"flex items-center gap-3\">\n                      <LogIn className=\"w-5 h-5 text-amber-500 flex-shrink-0\" aria-hidden=\"true\" />\n                      <div className=\"flex-1\">\n                        <p className=\"font-medium text-amber-500\">Login to save your results</p>\n                        <p className=\"text-sm text-muted-foreground\">Your score won't be saved to the leaderboard without an account.</p>\n                      </div>\n                      <Link href=\"/login\">\n                        <Button size=\"sm\" variant=\"outline\" className=\"border-amber-500/50 text-amber-500 hover:bg-amber-500/10\" data-testid=\"button-login-save\">\n                          Login\n                        </Button>\n                      </Link>\n                    </div>\n                  </div>\n                )}\n\n                {user && (\n                  <div className={`mb-6 p-3 rounded-lg ${\n                    !isOnline || pendingResultData \n                      ? 'bg-amber-500/10 border border-amber-500/30' \n                      : saveResultMutation.isError \n                        ? 'bg-red-500/10 border border-red-500/30'\n                        : 'bg-green-500/10 border border-green-500/30'\n                  }`} data-testid=\"save-status\">\n                    {!isOnline ? (\n                      <div className=\"flex items-center justify-center gap-2\">\n                        <WifiOff className=\"w-4 h-4 text-amber-500\" />\n                        <p className=\"text-sm text-amber-500\">\n                          You're offline. Result will be saved when you reconnect.\n                        </p>\n                      </div>\n                    ) : pendingResultData ? (\n                      <div className=\"flex items-center justify-center gap-2\">\n                        <RefreshCw className={`w-4 h-4 text-amber-500 ${saveResultMutation.isPending ? 'animate-spin' : ''}`} />\n                        <p className=\"text-sm text-amber-500\">\n                          {saveResultMutation.isPending ? 'Retrying save...' : 'Pending save - '}\n                        </p>\n                        {!saveResultMutation.isPending && (\n                          <Button \n                            size=\"sm\" \n                            variant=\"ghost\" \n                            className=\"h-6 px-2 text-amber-500 hover:text-amber-400\"\n                            onClick={retrySave}\n                            data-testid=\"button-retry-save\"\n                          >\n                            Retry Now\n                          </Button>\n                        )}\n                      </div>\n                    ) : saveResultMutation.isError ? (\n                      <div className=\"flex items-center justify-center gap-2\">\n                        <p className=\"text-sm text-red-500\">âœ— Failed to save</p>\n                        <Button \n                          size=\"sm\" \n                          variant=\"ghost\" \n                          className=\"h-6 px-2 text-red-500 hover:text-red-400\"\n                          onClick={retrySave}\n                          data-testid=\"button-retry-save-error\"\n                        >\n                          Retry\n                        </Button>\n                      </div>\n                    ) : (\n                      <p className=\"text-sm text-green-500 text-center\">\n                        {saveResultMutation.isPending ? 'â³ Saving result...' : \n                         saveResultMutation.isSuccess ? 'âœ“ Result saved to your profile!' : ''}\n                      </p>\n                    )}\n                  </div>\n                )}\n\n                {certificateData && !showCertificate && (\n                  <div className=\"mb-6\">\n                    <Button \n                      onClick={() => setShowCertificate(true)} \n                      className=\"w-full gap-2\"\n                      size=\"lg\"\n                      variant=\"outline\"\n                      data-testid=\"button-view-certificate\"\n                    >\n                      <Award className=\"w-5 h-5\" />\n                      View Your Certificate\n                    </Button>\n                  </div>\n                )}\n\n                {showCertificate && certificateData && (\n                  <div className=\"mb-6 space-y-4\">\n                    <div className=\"flex justify-between items-center\">\n                      <h3 className=\"text-xl font-bold\">Your Achievement Certificate</h3>\n                      <Button \n                        onClick={() => setShowCertificate(false)} \n                        variant=\"ghost\" \n                        size=\"sm\"\n                        data-testid=\"button-hide-certificate\"\n                      >\n                        <X className=\"w-4 h-4 mr-2\" />\n                        Hide\n                      </Button>\n                    </div>\n                    <StressCertificate {...certificateData} />\n                  </div>\n                )}\n\n                <div className=\"flex flex-col gap-3\">\n                  <Button \n                    onClick={() => selectedDifficulty && handleStart(selectedDifficulty)} \n                    className=\"w-full gap-2\"\n                    data-testid=\"button-retry-same\"\n                  >\n                    <Zap className=\"w-4 h-4\" aria-hidden=\"true\" />\n                    Retry {config?.name}\n                  </Button>\n                  \n                  <div className=\"flex gap-4\">\n                    <Button onClick={handleReset} variant=\"outline\" className=\"flex-1 gap-2\" data-testid=\"button-try-again\">\n                      <RefreshCw className=\"w-4 h-4\" aria-hidden=\"true\" />\n                      Change Difficulty\n                    </Button>\n                    \n                    <Link href=\"/\" className=\"flex-1\">\n                      <Button variant=\"outline\" className=\"w-full gap-2\" data-testid=\"button-home\">\n                        <Home className=\"w-4 h-4\" aria-hidden=\"true\" />\n                        Home\n                      </Button>\n                    </Link>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </TooltipProvider>\n    );\n  }\n\n  const progress = currentText.length > 0 ? Math.min(100, (typedText.length / currentText.length) * 100) : 0;\n\n  return (\n    <TooltipProvider delayDuration={300}>\n      <div\n        ref={containerRef}\n        onClick={() => inputRef.current?.focus()}\n        className={`min-h-screen flex items-center justify-center p-4 transition-all duration-100 cursor-text ${\n          backgroundFlash ? 'bg-red-500/30' : 'bg-background'\n        }`}\n        style={{\n          transform: prefersReducedMotion ? 'none' : `translate(${shakeOffset.x}px, ${shakeOffset.y}px) rotate(${rotation}deg) scale(${zoomScale + chaosWaveIntensity * 0.1}) ${screenFlipped ? 'rotateX(180deg)' : ''} skewX(${realityWarp}deg)`,\n          filter: prefersReducedMotion ? 'none' : `${glitchActive ? 'hue-rotate(180deg) saturate(3)' : ''} ${screenInverted ? 'invert(1) hue-rotate(180deg)' : ''} ${chaosWaveIntensity > 0 ? `contrast(${1 + chaosWaveIntensity * 0.3}) brightness(${1 + chaosWaveIntensity * 0.2})` : ''}`,\n        }}\n        role=\"main\"\n        aria-label=\"Stress test in progress\"\n      >\n        {!prefersReducedMotion && particles.map((particle) => (\n          <Particle key={particle.id} particle={particle} />\n        ))}\n\n        <div className=\"w-full max-w-4xl\">\n          <div className=\"mb-8 flex items-center justify-between\" role=\"status\" aria-live=\"polite\">\n            <div className=\"flex items-center gap-4\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"text-2xl font-mono font-bold cursor-help\" style={{ color: prefersReducedMotion ? undefined : currentColor }} aria-label={`${timeLeft} seconds remaining`}>\n                    {timeLeft}s\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\">\n                  <p>Time remaining - type fast!</p>\n                </TooltipContent>\n              </Tooltip>\n              \n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className={`text-sm text-muted-foreground transition-all cursor-help ${\n                    comboExplosion && !prefersReducedMotion ? 'scale-150 text-yellow-500' : ''\n                  }`} aria-label={`Current combo: ${combo}`}>\n                    Combo: <span className=\"text-primary font-bold\">{combo}</span>\n                    {comboExplosion && !prefersReducedMotion && <span className=\"ml-1 animate-ping\" aria-hidden=\"true\">ðŸ”¥</span>}\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\">\n                  <p>Current streak of correct keys. Every 10 combo = bonus!</p>\n                </TooltipContent>\n              </Tooltip>\n              \n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"text-sm text-muted-foreground cursor-help\" aria-label={`${errors} errors`}>\n                    Errors: <span className=\"text-destructive font-bold\">{errors}</span>\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent side=\"bottom\">\n                  <p>Mistakes reset your combo and shake the screen!</p>\n                </TooltipContent>\n              </Tooltip>\n            </div>\n            \n            <Tooltip>\n              <TooltipTrigger asChild>\n                <div className=\"flex items-center gap-2 cursor-help\" aria-label={`Stress level: ${Math.round(stressLevel)} percent`}>\n                  <span className=\"text-sm text-muted-foreground\">Stress</span>\n                  <div className=\"w-32 h-2 bg-muted rounded-full overflow-hidden\" role=\"progressbar\" aria-valuenow={Math.round(stressLevel)} aria-valuemin={0} aria-valuemax={100}>\n                    <div \n                      className=\"h-full bg-gradient-to-r from-green-500 via-yellow-500 to-red-500 transition-all duration-300\"\n                      style={{ width: `${stressLevel}%` }}\n                    />\n                  </div>\n                </div>\n              </TooltipTrigger>\n              <TooltipContent side=\"bottom\">\n                <div className=\"space-y-1\">\n                  <p className=\"font-semibold\">Stress Level: {Math.round(stressLevel)}%</p>\n                  <p className=\"text-xs\">As stress increases, visual effects intensify!</p>\n                </div>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <div className=\"cursor-help\">\n                <Progress value={progress} className=\"mb-8 h-3\" aria-label={`Progress: ${progress.toFixed(1)} percent complete`} />\n              </div>\n            </TooltipTrigger>\n            <TooltipContent side=\"top\">\n              <p>Progress: {progress.toFixed(1)}% - {typedText.length}/{currentText.length} characters</p>\n            </TooltipContent>\n          </Tooltip>\n\n          <Card\n            className={`mb-8 transition-all duration-200 ${multiEffectActive ? 'ring-4 ring-purple-500/50' : ''}`}\n            style={prefersReducedMotion ? {} : {\n              transform: `translateY(${gravityOffset}px) translate(${textPosition.x}px, ${textPosition.y}px)`,\n              opacity: textOpacity,\n              filter: `blur(${blur}px)`,\n              borderColor: currentColor,\n              borderWidth: '2px',\n            }}\n          >\n            <CardContent className=\"p-8 relative overflow-hidden\">\n              {(chromaticOffset.r !== 0 || chromaticOffset.g !== 0 || chromaticOffset.b !== 0) && !prefersReducedMotion && (\n                <>\n                  <div \n                    className=\"absolute inset-0 pointer-events-none text-2xl font-mono leading-relaxed whitespace-pre-wrap select-none mix-blend-screen opacity-30\"\n                    style={{ \n                      transform: `translate(${chromaticOffset.r}px, ${chromaticOffset.r * 0.5}px)`,\n                      color: 'red',\n                    }}\n                    aria-hidden=\"true\"\n                  >\n                    {displayText}\n                  </div>\n                  <div \n                    className=\"absolute inset-0 pointer-events-none text-2xl font-mono leading-relaxed whitespace-pre-wrap select-none mix-blend-screen opacity-30\"\n                    style={{ \n                      transform: `translate(${chromaticOffset.b}px, ${chromaticOffset.b * 0.5}px)`,\n                      color: 'blue',\n                    }}\n                    aria-hidden=\"true\"\n                  >\n                    {displayText}\n                  </div>\n                </>\n              )}\n              {(doubleVisionOffset.x !== 0 || doubleVisionOffset.y !== 0) && !prefersReducedMotion && (\n                <div \n                  className=\"absolute inset-0 pointer-events-none text-2xl font-mono leading-relaxed whitespace-pre-wrap select-none opacity-40\"\n                  style={{ \n                    transform: `translate(${doubleVisionOffset.x}px, ${doubleVisionOffset.y}px)`,\n                    filter: 'blur(0.5px)',\n                  }}\n                  aria-hidden=\"true\"\n                >\n                  {displayText}\n                </div>\n              )}\n              <div \n                className=\"text-2xl font-mono leading-relaxed whitespace-pre-wrap select-none relative z-10\" \n                aria-label=\"Text to type\"\n                style={{\n                  ...(textScrambleActive && !prefersReducedMotion ? { \n                    letterSpacing: `${Math.random() * 5}px`,\n                    wordSpacing: `${Math.random() * 10}px`,\n                  } : {}),\n                  ...(textWarpAmount !== 0 && !prefersReducedMotion ? {\n                    transform: `skewX(${textWarpAmount}deg) skewY(${textWarpAmount * 0.3}deg)`,\n                  } : {}),\n                }}\n              >\n                {renderedCharacters.map(({ char, color, index }) => (\n                  <span\n                    key={index}\n                    className={`${color} transition-colors duration-100`}\n                    style={{\n                      display: 'inline-block',\n                      animation: glitchActive && !prefersReducedMotion ? 'glitch 0.1s infinite' : 'none',\n                      transform: textScrambleActive && !prefersReducedMotion && Math.random() > 0.7 \n                        ? `translateY(${(Math.random() - 0.5) * 8}px) rotate(${(Math.random() - 0.5) * 10}deg)` \n                        : 'none',\n                    }}\n                  >\n                    {char}\n                  </span>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          <input\n            ref={inputRef}\n            type=\"text\"\n            value={typedText}\n            onChange={handleInputChange}\n            onBlur={() => {\n              if (isStarted && !isFinished && isTestActiveRef.current) {\n                setTimeout(() => inputRef.current?.focus(), 10);\n              }\n            }}\n            className=\"sr-only\"\n            autoComplete=\"off\"\n            autoCapitalize=\"off\"\n            autoCorrect=\"off\"\n            spellCheck={false}\n            aria-label=\"Type the text shown above\"\n            data-testid=\"input-typing\"\n          />\n          \n          <p className=\"text-center text-sm text-muted-foreground\" aria-live=\"polite\">\n            {isStarted ? 'Click anywhere or press ESC to quit' : 'Click to focus and start typing'}\n          </p>\n        </div>\n      </div>\n    </TooltipProvider>\n  );\n}\n","path":null,"size_bytes":87387,"size_tokens":null},"client/src/pages/stress-leaderboard.tsx":{"content":"import { useState } from 'react';\nimport { Link } from 'wouter';\nimport { ArrowLeft, Trophy, Zap, Flame, Award, Info, Target, BarChart3, Timer, CheckCircle2, Medal, Crown, Star, HelpCircle, AlertCircle, RefreshCw } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Avatar, AvatarFallback } from '@/components/ui/avatar';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { useQuery } from '@tanstack/react-query';\nimport { useAuth } from '@/lib/auth-context';\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from '@/components/ui/tooltip';\nimport { ErrorBoundary } from '@/components/error-boundary';\n\ntype Difficulty = 'all' | 'beginner' | 'intermediate' | 'expert' | 'nightmare' | 'impossible';\n\nconst DIFFICULTY_ICONS: Record<Exclude<Difficulty, 'all'>, string> = {\n  beginner: 'ðŸ”¥',\n  intermediate: 'âš¡',\n  expert: 'ðŸ’€',\n  nightmare: 'â˜ ï¸',\n  impossible: 'ðŸŒ€',\n};\n\nconst DIFFICULTY_COLORS: Record<Exclude<Difficulty, 'all'>, string> = {\n  beginner: 'text-orange-500',\n  intermediate: 'text-purple-500',\n  expert: 'text-red-500',\n  nightmare: 'text-red-900',\n  impossible: 'text-purple-900',\n};\n\nconst DIFFICULTY_DESCRIPTIONS: Record<Exclude<Difficulty, 'all'>, string> = {\n  beginner: 'Gentle introduction with light effects - 30 seconds',\n  intermediate: 'Screen inverts, zoom chaos, and sensory assault - 45 seconds',\n  expert: 'Screen flips upside down, glitches, complete chaos - 60 seconds',\n  nightmare: 'Text reverses, screen inverts/flips, reality collapses - 90 seconds',\n  impossible: 'Text teleports, ALL effects active, reality ceases to exist - 120 seconds',\n};\n\nfunction StressLeaderboardContent() {\n  const { user } = useAuth();\n  const [selectedDifficulty, setSelectedDifficulty] = useState<Difficulty>('all');\n  const [offset, setOffset] = useState(0);\n  const limit = 50;\n\n  const { data: leaderboardData, isLoading: leaderboardLoading, isFetching, isError, error, refetch } = useQuery({\n    queryKey: ['stress-leaderboard', selectedDifficulty, offset, limit],\n    queryFn: async () => {\n      const params = new URLSearchParams({ limit: String(limit), offset: String(offset) });\n      if (selectedDifficulty !== 'all') params.set('difficulty', selectedDifficulty);\n      const res = await fetch(`/api/stress-test/leaderboard?${params}`, {\n        credentials: 'include',\n      });\n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({}));\n        throw new Error(errorData.message || 'Failed to fetch leaderboard');\n      }\n      return res.json();\n    },\n    staleTime: 30000,\n    retry: 2,\n  });\n\n  const { data: statsData, isLoading: statsLoading } = useQuery({\n    queryKey: ['stress-stats'],\n    queryFn: async () => {\n      const res = await fetch('/api/stress-test/stats', {\n        credentials: 'include',\n      });\n      if (!res.ok) throw new Error('Failed to fetch stats');\n      return res.json();\n    },\n    enabled: !!user,\n  });\n\n  const leaderboard = leaderboardData?.entries || [];\n  const pagination = leaderboardData?.pagination || { total: 0, hasMore: false };\n  const stats = statsData?.stats;\n\n  const handleDifficultyChange = (v: string) => {\n    setSelectedDifficulty(v as Difficulty);\n    setOffset(0);\n  };\n\n  return (\n    <TooltipProvider delayDuration={200}>\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"mb-8\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Link href=\"/stress-test\">\n                <Button variant=\"ghost\" size=\"sm\" className=\"gap-2\" data-testid=\"button-back\">\n                  <ArrowLeft className=\"w-4 h-4\" />\n                  Back to Stress Test\n                </Button>\n              </Link>\n            </TooltipTrigger>\n            <TooltipContent side=\"bottom\">\n              <p>Return to difficulty selection and take the test</p>\n            </TooltipContent>\n          </Tooltip>\n        </div>\n\n        <div className=\"max-w-6xl mx-auto\">\n          {/* Header */}\n          <div className=\"text-center mb-12\">\n            <div className=\"flex items-center justify-center gap-3 mb-4\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div>\n                    <Trophy className=\"w-12 h-12 text-primary animate-pulse cursor-help\" />\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent side=\"top\">\n                  <p>Global rankings of stress test champions</p>\n                </TooltipContent>\n              </Tooltip>\n              <h1 className=\"text-5xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-orange-500 via-red-500 to-purple-500\">\n                Stress Test Leaderboard\n              </h1>\n            </div>\n            <p className=\"text-xl text-muted-foreground max-w-2xl mx-auto\">\n              The bravest warriors who survived the chaos\n            </p>\n          </div>\n\n          {/* User Stats */}\n          {user && stats && (\n            <Card className=\"mb-8 border-2 border-primary/20\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div className=\"flex items-center gap-2 cursor-help\">\n                        <Award className=\"w-5 h-5 text-primary\" />\n                        Your Statistics\n                        <HelpCircle className=\"w-4 h-4 text-muted-foreground\" />\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"right\">\n                      <p>Your personal stress test performance summary</p>\n                    </TooltipContent>\n                  </Tooltip>\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4\">\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div className=\"text-center p-4 bg-muted rounded-lg cursor-help hover:bg-muted/80 transition-colors\">\n                        <div className=\"text-3xl font-bold text-primary\">{stats.totalTests}</div>\n                        <div className=\"text-sm text-muted-foreground flex items-center justify-center gap-1\">\n                          <BarChart3 className=\"w-3 h-3\" />\n                          Total Tests\n                        </div>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"top\">\n                      <p>Total number of stress tests you've attempted</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  \n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div className=\"text-center p-4 bg-muted rounded-lg cursor-help hover:bg-muted/80 transition-colors\">\n                        <div className=\"text-3xl font-bold text-green-500\">{stats.completedTests}</div>\n                        <div className=\"text-sm text-muted-foreground flex items-center justify-center gap-1\">\n                          <CheckCircle2 className=\"w-3 h-3\" />\n                          Completed\n                        </div>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"top\">\n                      <div className=\"space-y-1\">\n                        <p>Tests where you typed 100% of the text</p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          Completion rate: {stats.totalTests > 0 ? ((stats.completedTests / stats.totalTests) * 100).toFixed(0) : 0}%\n                        </p>\n                      </div>\n                    </TooltipContent>\n                  </Tooltip>\n                  \n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div className=\"text-center p-4 bg-muted rounded-lg cursor-help hover:bg-muted/80 transition-colors\">\n                        <div className=\"text-3xl font-bold text-orange-500\">{stats.bestScore}</div>\n                        <div className=\"text-sm text-muted-foreground flex items-center justify-center gap-1\">\n                          <Crown className=\"w-3 h-3\" />\n                          Best Score\n                        </div>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"top\">\n                      <p>Your highest stress score ever achieved</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  \n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div className=\"text-center p-4 bg-muted rounded-lg cursor-help hover:bg-muted/80 transition-colors\">\n                        <div className=\"text-3xl font-bold text-blue-500\">{stats.avgScore}</div>\n                        <div className=\"text-sm text-muted-foreground flex items-center justify-center gap-1\">\n                          <Target className=\"w-3 h-3\" />\n                          Avg Score\n                        </div>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"top\">\n                      <p>Your average stress score across all tests</p>\n                    </TooltipContent>\n                  </Tooltip>\n                  \n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <div className=\"text-center p-4 bg-muted rounded-lg cursor-help hover:bg-muted/80 transition-colors\">\n                        <div className=\"text-3xl font-bold text-purple-500\">{stats.difficultiesCompleted.length}</div>\n                        <div className=\"text-sm text-muted-foreground flex items-center justify-center gap-1\">\n                          <Medal className=\"w-3 h-3\" />\n                          Difficulties Beat\n                        </div>\n                      </div>\n                    </TooltipTrigger>\n                    <TooltipContent side=\"top\">\n                      <div className=\"space-y-1\">\n                        <p>Number of unique difficulties you've completed</p>\n                        <p className=\"text-xs text-muted-foreground\">Complete all 5 difficulties to become a true champion!</p>\n                      </div>\n                    </TooltipContent>\n                  </Tooltip>\n                </div>\n                \n                {stats.difficultiesCompleted.length > 0 && (\n                  <div className=\"mt-4 text-center\">\n                    <p className=\"text-sm text-muted-foreground mb-2\">Conquered Difficulties:</p>\n                    <div className=\"flex items-center justify-center gap-2 flex-wrap\">\n                      {stats.difficultiesCompleted.map((diff: string) => (\n                        <Tooltip key={diff}>\n                          <TooltipTrigger asChild>\n                            <span className=\"inline-flex items-center gap-1 px-3 py-1 bg-primary/10 rounded-full text-sm font-medium cursor-help hover:bg-primary/20 transition-colors\">\n                              <span>{DIFFICULTY_ICONS[diff as keyof typeof DIFFICULTY_ICONS]}</span>\n                              <span className=\"capitalize\">{diff}</span>\n                            </span>\n                          </TooltipTrigger>\n                          <TooltipContent side=\"top\">\n                            <p>{DIFFICULTY_DESCRIPTIONS[diff as keyof typeof DIFFICULTY_DESCRIPTIONS]}</p>\n                          </TooltipContent>\n                        </Tooltip>\n                      ))}\n                    </div>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Difficulty Filter */}\n          <Tabs value={selectedDifficulty} onValueChange={handleDifficultyChange} className=\"mb-8\">\n            <TabsList className=\"grid w-full grid-cols-6\">\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <TabsTrigger value=\"all\" data-testid=\"tab-all\">\n                    All\n                  </TabsTrigger>\n                </TooltipTrigger>\n                <TooltipContent side=\"top\">\n                  <p>View all difficulties combined</p>\n                </TooltipContent>\n              </Tooltip>\n              \n              <TabsTrigger value=\"beginner\" data-testid=\"tab-beginner\">\n                ðŸ”¥ Beginner\n              </TabsTrigger>\n              \n              <TabsTrigger value=\"intermediate\" data-testid=\"tab-intermediate\">\n                âš¡ Intermediate\n              </TabsTrigger>\n              \n              <TabsTrigger value=\"expert\" data-testid=\"tab-expert\">\n                ðŸ’€ Expert\n              </TabsTrigger>\n              \n              <TabsTrigger value=\"nightmare\" data-testid=\"tab-nightmare\">\n                â˜ ï¸ Nightmare\n              </TabsTrigger>\n              \n              <TabsTrigger value=\"impossible\" data-testid=\"tab-impossible\">\n                ðŸŒ€ Impossible\n              </TabsTrigger>\n            </TabsList>\n\n            <TabsContent value={selectedDifficulty}>\n              <Card>\n                <CardContent className=\"p-0\">\n                  {isError ? (\n                    <div className=\"flex flex-col items-center justify-center py-12 text-center\">\n                      <AlertCircle className=\"w-12 h-12 text-destructive mb-4\" />\n                      <p className=\"text-lg font-medium text-destructive mb-2\">Failed to load leaderboard</p>\n                      <p className=\"text-sm text-muted-foreground mb-4\">\n                        {error instanceof Error ? error.message : \"An unexpected error occurred\"}\n                      </p>\n                      <Button \n                        variant=\"outline\" \n                        onClick={() => refetch()}\n                        disabled={isFetching}\n                        data-testid=\"retry-button\"\n                      >\n                        <RefreshCw className={`w-4 h-4 mr-2 ${isFetching ? 'animate-spin' : ''}`} />\n                        Try Again\n                      </Button>\n                    </div>\n                  ) : leaderboardLoading ? (\n                    <div className=\"text-center py-12\">\n                      <div className=\"w-8 h-8 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">Loading leaderboard...</p>\n                    </div>\n                  ) : leaderboard.length === 0 ? (\n                    <div className=\"text-center py-12\">\n                      <Zap className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground\" />\n                      <p className=\"text-lg text-muted-foreground\">\n                        No one has conquered this challenge yet. Be the first!\n                      </p>\n                    </div>\n                  ) : (\n                    <div className=\"divide-y divide-border\">\n                      {/* Table Header */}\n                      <div className=\"hidden md:flex items-center gap-4 p-4 bg-muted/30 text-xs font-medium text-muted-foreground uppercase tracking-wider\">\n                        <div className=\"w-12 text-center\">Rank</div>\n                        <div className=\"flex-1\">Player</div>\n                        {selectedDifficulty === 'all' && <div className=\"w-24\">Difficulty</div>}\n                        <div className=\"w-20 text-center\">Score</div>\n                        <div className=\"w-16 text-center\">WPM</div>\n                        <div className=\"w-16 text-center\">Acc</div>\n                        <div className=\"w-16 text-center\">Done</div>\n                      </div>\n                      \n                      {leaderboard.map((entry: any, index: number) => {\n                        const rank = entry.rank || (index + 1);\n                        return (\n                        <div\n                          key={`${entry.userId}-${entry.difficulty}-${entry.createdAt}`}\n                          className={`flex items-center gap-4 p-4 transition-colors ${\n                            entry.userId === user?.id ? 'bg-primary/10' : 'hover:bg-muted/50'\n                          }`}\n                          data-testid={`leaderboard-entry-${index}`}\n                        >\n                          {/* Rank - uses DENSE_RANK from API for proper tie handling */}\n                          <div className=\"flex-shrink-0 w-12 text-center\">\n                            {rank === 1 && (\n                              <Tooltip>\n                                <TooltipTrigger asChild>\n                                  <div className=\"text-3xl animate-bounce cursor-help\">ðŸ¥‡</div>\n                                </TooltipTrigger>\n                                <TooltipContent side=\"right\">\n                                  <p>1st Place - The Champion!</p>\n                                </TooltipContent>\n                              </Tooltip>\n                            )}\n                            {rank === 2 && (\n                              <Tooltip>\n                                <TooltipTrigger asChild>\n                                  <div className=\"text-3xl animate-bounce cursor-help\" style={{ animationDelay: '0.1s' }}>ðŸ¥ˆ</div>\n                                </TooltipTrigger>\n                                <TooltipContent side=\"right\">\n                                  <p>2nd Place - Silver medalist!</p>\n                                </TooltipContent>\n                              </Tooltip>\n                            )}\n                            {rank === 3 && (\n                              <Tooltip>\n                                <TooltipTrigger asChild>\n                                  <div className=\"text-3xl animate-bounce cursor-help\" style={{ animationDelay: '0.2s' }}>ðŸ¥‰</div>\n                                </TooltipTrigger>\n                                <TooltipContent side=\"right\">\n                                  <p>3rd Place - Bronze medalist!</p>\n                                </TooltipContent>\n                              </Tooltip>\n                            )}\n                            {rank > 3 && (\n                              <span className=\"text-2xl font-bold text-muted-foreground\">#{rank}</span>\n                            )}\n                          </div>\n\n                          {/* User */}\n                          <div className=\"flex items-center gap-3 flex-1 min-w-0\">\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <Avatar className=\"w-10 h-10 border-2 cursor-help\" style={{ borderColor: entry.avatarColor || '#888' }}>\n                                  <AvatarFallback style={{ backgroundColor: entry.avatarColor || '#888' }}>\n                                    {entry.username.substring(0, 2).toUpperCase()}\n                                  </AvatarFallback>\n                                </Avatar>\n                              </TooltipTrigger>\n                              <TooltipContent side=\"top\">\n                                <p>{entry.username}'s profile</p>\n                              </TooltipContent>\n                            </Tooltip>\n                            <div className=\"min-w-0 flex-1\">\n                              <div className=\"font-semibold truncate flex items-center gap-2\">\n                                {entry.username}\n                                {entry.userId === user?.id && (\n                                  <Tooltip>\n                                    <TooltipTrigger asChild>\n                                      <span className=\"text-xs px-2 py-0.5 bg-primary/20 text-primary rounded cursor-help\">You</span>\n                                    </TooltipTrigger>\n                                    <TooltipContent side=\"top\">\n                                      <p>This is your entry!</p>\n                                    </TooltipContent>\n                                  </Tooltip>\n                                )}\n                              </div>\n                              <Tooltip>\n                                <TooltipTrigger asChild>\n                                  <div className=\"text-sm text-muted-foreground cursor-help\">\n                                    {new Date(entry.createdAt).toLocaleDateString()}\n                                  </div>\n                                </TooltipTrigger>\n                                <TooltipContent side=\"bottom\">\n                                  <p>Achieved on {new Date(entry.createdAt).toLocaleString()}</p>\n                                </TooltipContent>\n                              </Tooltip>\n                            </div>\n                          </div>\n\n                          {/* Difficulty Badge */}\n                          {selectedDifficulty === 'all' && (\n                            <div className=\"flex-shrink-0\">\n                              <span className={`inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium ${\n                                DIFFICULTY_COLORS[entry.difficulty as keyof typeof DIFFICULTY_COLORS]\n                              } bg-muted`}>\n                                <span>{DIFFICULTY_ICONS[entry.difficulty as keyof typeof DIFFICULTY_ICONS]}</span>\n                                <span className=\"capitalize\">{entry.difficulty}</span>\n                              </span>\n                            </div>\n                          )}\n\n                          {/* Stats */}\n                          <div className=\"flex gap-6 flex-shrink-0\">\n                            <div className=\"text-center\">\n                              <div className=\"text-2xl font-bold text-primary\">{entry.stressScore}</div>\n                              <div className=\"text-xs text-muted-foreground flex items-center justify-center gap-1\">\n                                <Star className=\"w-3 h-3\" />\n                                Score\n                              </div>\n                            </div>\n                            \n                            <div className=\"text-center\">\n                              <div className=\"text-lg font-semibold text-blue-500\">{entry.wpm}</div>\n                              <div className=\"text-xs text-muted-foreground flex items-center justify-center gap-1\">\n                                <BarChart3 className=\"w-3 h-3\" />\n                                WPM\n                              </div>\n                            </div>\n                            \n                            <div className=\"text-center\">\n                              <div className=\"text-lg font-semibold text-green-500\">{entry.accuracy.toFixed(1)}%</div>\n                              <div className=\"text-xs text-muted-foreground flex items-center justify-center gap-1\">\n                                <Target className=\"w-3 h-3\" />\n                                Acc\n                              </div>\n                            </div>\n                            \n                            <div className=\"text-center\">\n                              <div className=\"text-lg font-semibold text-orange-500\">{entry.completionRate.toFixed(0)}%</div>\n                              <div className=\"text-xs text-muted-foreground flex items-center justify-center gap-1\">\n                                <CheckCircle2 className=\"w-3 h-3\" />\n                                Done\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      );\n                      })}\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n\n          {/* CTA */}\n          <div className=\"text-center mt-8\">\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Link href=\"/stress-test\">\n                  <Button size=\"lg\" className=\"gap-2\" data-testid=\"button-take-test\">\n                    <Flame className=\"w-5 h-5\" />\n                    Take the Test\n                  </Button>\n                </Link>\n              </TooltipTrigger>\n              <TooltipContent side=\"top\">\n                <p>Challenge yourself and climb the leaderboard!</p>\n              </TooltipContent>\n            </Tooltip>\n          </div>\n        </div>\n      </div>\n    </TooltipProvider>\n  );\n}\n\nexport default function StressLeaderboard() {\n  return (\n    <ErrorBoundary>\n      <StressLeaderboardContent />\n    </ErrorBoundary>\n  );\n}\n","path":null,"size_bytes":24906,"size_tokens":null},"client/src/lib/keystroke-tracker.ts":{"content":"interface KeystrokeEvent {\n  key: string;\n  keyCode: string;\n  pressTime: number;\n  releaseTime: number | null;\n  dwellTime: number | null;\n  flightTime: number | null;\n  isCorrect: boolean;\n  expectedKey: string | null;\n  position: number;\n  finger: string | null;\n  hand: string | null;\n}\n\ninterface DigraphTiming {\n  digraph: string;\n  avgTime: number;\n  count: number;\n}\n\ninterface AntiCheatValidation {\n  isSuspicious: boolean;\n  suspiciousFlags: string[] | null;\n  validationScore: number;\n  minKeystrokeInterval: number | null;\n  keystrokeVariance: number | null;\n  syntheticInputDetected: boolean;\n}\n\nconst ANTICHEAT_THRESHOLDS = {\n  MIN_KEYSTROKE_INTERVAL_MS: 10,\n  SUSPECT_INTERVAL_MS: 25,\n  MAX_WPM_WITHOUT_FLAG: 200,\n  MAX_CONSISTENT_VARIANCE: 5,\n  MIN_KEYSTROKES_FOR_ANALYSIS: 20,\n  BURST_WINDOW_SIZE: 10,\n  BURST_THRESHOLD_RATIO: 0.8,\n  PERFECT_RHYTHM_THRESHOLD: 0.95,\n  SUSPICIOUS_FLAG_THRESHOLD: 2,\n} as const;\n\ninterface TypingAnalytics {\n  wpm: number;\n  rawWpm: number;\n  accuracy: number;\n  consistency: number | null;\n  avgDwellTime: number | null;\n  avgFlightTime: number | null;\n  stdDevFlightTime: number | null;\n  fastestDigraph: string | null;\n  slowestDigraph: string | null;\n  fingerUsage: Record<string, number> | null;\n  handBalance: number | null;\n  totalErrors: number;\n  errorsByType: Record<string, number> | null;\n  errorKeys: string[] | null;\n  wpmByPosition: number[] | null;\n  slowestWords: string[] | null;\n  keyHeatmap: Record<string, number> | null;\n  testResultId: number | null;\n  \n  // Enhanced industry-standard metrics\n  burstWpm: number | null; // Peak 5-second WPM (like Monkeytype)\n  adjustedWpm: number | null; // WPM with error penalty (industry standard)\n  consistencyRating: number | null; // Rhythm rating based on timing consistency (0-100)\n  rollingAccuracy: number[] | null; // Accuracy across 5 chunks for trend analysis\n  topDigraphs: DigraphTiming[] | null; // Top 5 fastest digraphs with timing\n  bottomDigraphs: DigraphTiming[] | null; // Top 5 slowest digraphs with timing\n  typingRhythm: number | null; // Rhythm score based on timing variance (0-100)\n  peakPerformanceWindow: { startPos: number; endPos: number; wpm: number } | null;\n  fatigueIndicator: number | null; // Speed drop from first half to second half (%)\n  errorBurstCount: number | null; // Number of consecutive error sequences\n  \n  // Anti-Cheat Validation\n  isSuspicious: boolean;\n  suspiciousFlags: string[] | null;\n  validationScore: number | null;\n  minKeystrokeInterval: number | null;\n  keystrokeVariance: number | null;\n  syntheticInputDetected: boolean;\n}\n\nconst CODE_FINGER_MAP: Record<string, { finger: string; hand: string }> = {\n  // Left hand - Number row\n  'Backquote': { finger: 'Left Pinky', hand: 'left' },\n  'Digit1': { finger: 'Left Pinky', hand: 'left' },\n  'Digit2': { finger: 'Left Ring', hand: 'left' },\n  'Digit3': { finger: 'Left Middle', hand: 'left' },\n  'Digit4': { finger: 'Left Index', hand: 'left' },\n  'Digit5': { finger: 'Left Index', hand: 'left' },\n  // Left hand - Top row\n  'KeyQ': { finger: 'Left Pinky', hand: 'left' },\n  'KeyW': { finger: 'Left Ring', hand: 'left' },\n  'KeyE': { finger: 'Left Middle', hand: 'left' },\n  'KeyR': { finger: 'Left Index', hand: 'left' },\n  'KeyT': { finger: 'Left Index', hand: 'left' },\n  // Left hand - Home row\n  'KeyA': { finger: 'Left Pinky', hand: 'left' },\n  'KeyS': { finger: 'Left Ring', hand: 'left' },\n  'KeyD': { finger: 'Left Middle', hand: 'left' },\n  'KeyF': { finger: 'Left Index', hand: 'left' },\n  'KeyG': { finger: 'Left Index', hand: 'left' },\n  // Left hand - Bottom row\n  'KeyZ': { finger: 'Left Pinky', hand: 'left' },\n  'KeyX': { finger: 'Left Ring', hand: 'left' },\n  'KeyC': { finger: 'Left Middle', hand: 'left' },\n  'KeyV': { finger: 'Left Index', hand: 'left' },\n  'KeyB': { finger: 'Left Index', hand: 'left' },\n  // Left hand - Control keys\n  'Tab': { finger: 'Left Pinky', hand: 'left' },\n  'CapsLock': { finger: 'Left Pinky', hand: 'left' },\n  'ShiftLeft': { finger: 'Left Pinky', hand: 'left' },\n  'ControlLeft': { finger: 'Left Pinky', hand: 'left' },\n  'AltLeft': { finger: 'Left Thumb', hand: 'left' },\n  'MetaLeft': { finger: 'Left Thumb', hand: 'left' },\n  'Escape': { finger: 'Left Pinky', hand: 'left' },\n  \n  // Right hand - Number row\n  'Digit6': { finger: 'Right Index', hand: 'right' },\n  'Digit7': { finger: 'Right Index', hand: 'right' },\n  'Digit8': { finger: 'Right Middle', hand: 'right' },\n  'Digit9': { finger: 'Right Ring', hand: 'right' },\n  'Digit0': { finger: 'Right Pinky', hand: 'right' },\n  'Minus': { finger: 'Right Pinky', hand: 'right' },\n  'Equal': { finger: 'Right Pinky', hand: 'right' },\n  'Backspace': { finger: 'Right Pinky', hand: 'right' },\n  // Right hand - Top row\n  'KeyY': { finger: 'Right Index', hand: 'right' },\n  'KeyU': { finger: 'Right Index', hand: 'right' },\n  'KeyI': { finger: 'Right Middle', hand: 'right' },\n  'KeyO': { finger: 'Right Ring', hand: 'right' },\n  'KeyP': { finger: 'Right Pinky', hand: 'right' },\n  'BracketLeft': { finger: 'Right Pinky', hand: 'right' },\n  'BracketRight': { finger: 'Right Pinky', hand: 'right' },\n  'Backslash': { finger: 'Right Pinky', hand: 'right' },\n  // Right hand - Home row\n  'KeyH': { finger: 'Right Index', hand: 'right' },\n  'KeyJ': { finger: 'Right Index', hand: 'right' },\n  'KeyK': { finger: 'Right Middle', hand: 'right' },\n  'KeyL': { finger: 'Right Ring', hand: 'right' },\n  'Semicolon': { finger: 'Right Pinky', hand: 'right' },\n  'Quote': { finger: 'Right Pinky', hand: 'right' },\n  'Enter': { finger: 'Right Pinky', hand: 'right' },\n  // Right hand - Bottom row\n  'KeyN': { finger: 'Right Index', hand: 'right' },\n  'KeyM': { finger: 'Right Index', hand: 'right' },\n  'Comma': { finger: 'Right Middle', hand: 'right' },\n  'Period': { finger: 'Right Ring', hand: 'right' },\n  'Slash': { finger: 'Right Pinky', hand: 'right' },\n  'ShiftRight': { finger: 'Right Pinky', hand: 'right' },\n  // Right hand - Control keys\n  'ControlRight': { finger: 'Right Pinky', hand: 'right' },\n  'AltRight': { finger: 'Right Thumb', hand: 'right' },\n  'MetaRight': { finger: 'Right Thumb', hand: 'right' },\n  'ArrowUp': { finger: 'Right Index', hand: 'right' },\n  'ArrowDown': { finger: 'Right Index', hand: 'right' },\n  'ArrowLeft': { finger: 'Right Index', hand: 'right' },\n  'ArrowRight': { finger: 'Right Index', hand: 'right' },\n  \n  // Space bar - Thumbs (counted as both hands for balance)\n  'Space': { finger: 'Thumbs', hand: 'both' },\n};\n\nconst CHAR_FINGER_MAP: Record<string, { finger: string; hand: string }> = {\n  // Left hand characters (including shifted)\n  '`': { finger: 'Left Pinky', hand: 'left' },\n  '~': { finger: 'Left Pinky', hand: 'left' },\n  '1': { finger: 'Left Pinky', hand: 'left' },\n  '!': { finger: 'Left Pinky', hand: 'left' },\n  '2': { finger: 'Left Ring', hand: 'left' },\n  '@': { finger: 'Left Ring', hand: 'left' },\n  '3': { finger: 'Left Middle', hand: 'left' },\n  '#': { finger: 'Left Middle', hand: 'left' },\n  '4': { finger: 'Left Index', hand: 'left' },\n  '$': { finger: 'Left Index', hand: 'left' },\n  '5': { finger: 'Left Index', hand: 'left' },\n  '%': { finger: 'Left Index', hand: 'left' },\n  'Q': { finger: 'Left Pinky', hand: 'left' },\n  'W': { finger: 'Left Ring', hand: 'left' },\n  'E': { finger: 'Left Middle', hand: 'left' },\n  'R': { finger: 'Left Index', hand: 'left' },\n  'T': { finger: 'Left Index', hand: 'left' },\n  'A': { finger: 'Left Pinky', hand: 'left' },\n  'S': { finger: 'Left Ring', hand: 'left' },\n  'D': { finger: 'Left Middle', hand: 'left' },\n  'F': { finger: 'Left Index', hand: 'left' },\n  'G': { finger: 'Left Index', hand: 'left' },\n  'Z': { finger: 'Left Pinky', hand: 'left' },\n  'X': { finger: 'Left Ring', hand: 'left' },\n  'C': { finger: 'Left Middle', hand: 'left' },\n  'V': { finger: 'Left Index', hand: 'left' },\n  'B': { finger: 'Left Index', hand: 'left' },\n  \n  // Right hand characters (including shifted)\n  '6': { finger: 'Right Index', hand: 'right' },\n  '^': { finger: 'Right Index', hand: 'right' },\n  '7': { finger: 'Right Index', hand: 'right' },\n  '&': { finger: 'Right Index', hand: 'right' },\n  '8': { finger: 'Right Middle', hand: 'right' },\n  '*': { finger: 'Right Middle', hand: 'right' },\n  '9': { finger: 'Right Ring', hand: 'right' },\n  '(': { finger: 'Right Ring', hand: 'right' },\n  '0': { finger: 'Right Pinky', hand: 'right' },\n  ')': { finger: 'Right Pinky', hand: 'right' },\n  '-': { finger: 'Right Pinky', hand: 'right' },\n  '_': { finger: 'Right Pinky', hand: 'right' },\n  '=': { finger: 'Right Pinky', hand: 'right' },\n  '+': { finger: 'Right Pinky', hand: 'right' },\n  'Y': { finger: 'Right Index', hand: 'right' },\n  'U': { finger: 'Right Index', hand: 'right' },\n  'I': { finger: 'Right Middle', hand: 'right' },\n  'O': { finger: 'Right Ring', hand: 'right' },\n  'P': { finger: 'Right Pinky', hand: 'right' },\n  '[': { finger: 'Right Pinky', hand: 'right' },\n  '{': { finger: 'Right Pinky', hand: 'right' },\n  ']': { finger: 'Right Pinky', hand: 'right' },\n  '}': { finger: 'Right Pinky', hand: 'right' },\n  '\\\\': { finger: 'Right Pinky', hand: 'right' },\n  '|': { finger: 'Right Pinky', hand: 'right' },\n  'H': { finger: 'Right Index', hand: 'right' },\n  'J': { finger: 'Right Index', hand: 'right' },\n  'K': { finger: 'Right Middle', hand: 'right' },\n  'L': { finger: 'Right Ring', hand: 'right' },\n  ';': { finger: 'Right Pinky', hand: 'right' },\n  ':': { finger: 'Right Pinky', hand: 'right' },\n  '\\'': { finger: 'Right Pinky', hand: 'right' },\n  '\"': { finger: 'Right Pinky', hand: 'right' },\n  'N': { finger: 'Right Index', hand: 'right' },\n  'M': { finger: 'Right Index', hand: 'right' },\n  ',': { finger: 'Right Middle', hand: 'right' },\n  '<': { finger: 'Right Middle', hand: 'right' },\n  '.': { finger: 'Right Ring', hand: 'right' },\n  '>': { finger: 'Right Ring', hand: 'right' },\n  '/': { finger: 'Right Pinky', hand: 'right' },\n  '?': { finger: 'Right Pinky', hand: 'right' },\n  \n  // Space bar\n  ' ': { finger: 'Thumbs', hand: 'both' },\n};\n\nconst getFingerInfo = (key: string, keyCode: string): { finger: string | null; hand: string | null } => {\n  if (CODE_FINGER_MAP[keyCode]) {\n    return CODE_FINGER_MAP[keyCode];\n  }\n  if (CHAR_FINGER_MAP[key.toUpperCase()]) {\n    return CHAR_FINGER_MAP[key.toUpperCase()];\n  }\n  if (CHAR_FINGER_MAP[key]) {\n    return CHAR_FINGER_MAP[key];\n  }\n  return { finger: null, hand: null };\n};\n\nconst FINGER_MAP: Record<string, { finger: string; hand: string }> = CHAR_FINGER_MAP;\n\nexport class KeystrokeTracker {\n  private events: KeystrokeEvent[] = [];\n  private pressedKeys: Map<string, number> = new Map();\n  private lastReleaseTime: number | null = null;\n  public expectedText: string = '';\n  public currentPosition: number = 0;\n\n  constructor(expectedText: string) {\n    this.expectedText = expectedText;\n  }\n\n  onKeyDown(key: string, keyCode: string, timestamp: number) {\n    if (!this.pressedKeys.has(key)) {\n      this.pressedKeys.set(key, timestamp);\n    }\n  }\n\n  onKeyUp(key: string, keyCode: string, timestamp: number, isCorrect: boolean) {\n    const pressTime = this.pressedKeys.get(key);\n    if (!pressTime) return;\n\n    const dwellTime = timestamp - pressTime;\n    const flightTime = this.lastReleaseTime ? pressTime - this.lastReleaseTime : null;\n    const expectedKey = this.expectedText[this.currentPosition] || null;\n    \n    const fingerInfo = getFingerInfo(key, keyCode);\n\n    const event: KeystrokeEvent = {\n      key,\n      keyCode,\n      pressTime,\n      releaseTime: timestamp,\n      dwellTime,\n      flightTime,\n      isCorrect,\n      expectedKey,\n      position: this.currentPosition,\n      ...fingerInfo,\n    };\n\n    this.events.push(event);\n    this.pressedKeys.delete(key);\n    this.lastReleaseTime = timestamp;\n    \n    // Don't auto-increment position - let the component manage it\n    // based on actual input state\n  }\n\n  computeAnalytics(wpm: number, rawWpm: number, accuracy: number, totalErrors: number, testResultId: number | null = null): TypingAnalytics {\n    if (this.events.length === 0) {\n      return {\n        wpm,\n        rawWpm,\n        accuracy,\n        consistency: null,\n        avgDwellTime: null,\n        avgFlightTime: null,\n        stdDevFlightTime: null,\n        fastestDigraph: null,\n        slowestDigraph: null,\n        fingerUsage: null,\n        handBalance: null,\n        totalErrors,\n        errorsByType: null,\n        errorKeys: null,\n        wpmByPosition: null,\n        slowestWords: null,\n        keyHeatmap: null,\n        testResultId,\n        burstWpm: null,\n        adjustedWpm: null,\n        consistencyRating: null,\n        rollingAccuracy: null,\n        topDigraphs: null,\n        bottomDigraphs: null,\n        typingRhythm: null,\n        peakPerformanceWindow: null,\n        fatigueIndicator: null,\n        errorBurstCount: null,\n        isSuspicious: false,\n        suspiciousFlags: null,\n        validationScore: null,\n        minKeystrokeInterval: null,\n        keystrokeVariance: null,\n        syntheticInputDetected: false,\n      };\n    }\n\n    // Calculate dwell and flight times\n    const dwellTimes = this.events.filter(e => e.dwellTime !== null).map(e => e.dwellTime!);\n    const flightTimes = this.events.filter(e => e.flightTime !== null).map(e => e.flightTime!);\n    \n    const avgDwellTime = dwellTimes.length > 0 ? dwellTimes.reduce((a, b) => a + b, 0) / dwellTimes.length : null;\n    const avgFlightTime = flightTimes.length > 0 ? flightTimes.reduce((a, b) => a + b, 0) / flightTimes.length : null;\n    \n    // Calculate std dev of flight times for consistency\n    let stdDevFlightTime = null;\n    if (flightTimes.length > 1 && avgFlightTime !== null) {\n      const variance = flightTimes.reduce((sum, time) => sum + Math.pow(time - avgFlightTime, 2), 0) / flightTimes.length;\n      stdDevFlightTime = Math.sqrt(variance);\n    }\n\n    // Consistency score (inverse coefficient of variation, 0-100)\n    // Filter out long pauses (> 1000ms) for a more accurate consistency score\n    // Use dynamic threshold based on average speed - slower typists naturally have longer flight times\n    let consistency: number | null = null;\n    if (flightTimes.length >= 2) {\n      // Use a generous 1000ms threshold first, then fall back to unfiltered if needed\n      const outlierThreshold = 1000;\n      let timesToUse = flightTimes.filter(t => t > 0 && t < outlierThreshold);\n      \n      // Fallback: if too few times remain after filtering, use all positive flight times\n      if (timesToUse.length < 2) {\n        timesToUse = flightTimes.filter(t => t > 0);\n      }\n      \n      if (timesToUse.length >= 2) {\n        const calcAvg = timesToUse.reduce((a, b) => a + b, 0) / timesToUse.length;\n        const calcVariance = timesToUse.reduce((sum, t) => sum + Math.pow(t - calcAvg, 2), 0) / timesToUse.length;\n        const calcStdDev = Math.sqrt(calcVariance);\n        // Scale the coefficient of variation more gently - multiply by 50 instead of 100 for more realistic scores\n        const cv = (calcStdDev / calcAvg);\n        consistency = Math.max(0, Math.min(100, 100 - (cv * 50)));\n      }\n    }\n\n    // Build keyboard heatmap\n    const keyHeatmap: Record<string, number> = {};\n    this.events.forEach(event => {\n      const upperKey = event.key.toUpperCase();\n      keyHeatmap[upperKey] = (keyHeatmap[upperKey] || 0) + 1;\n    });\n\n    // Finger usage\n    const fingerUsage: Record<string, number> = {};\n    this.events.forEach(event => {\n      if (event.finger) {\n        fingerUsage[event.finger] = (fingerUsage[event.finger] || 0) + 1;\n      }\n    });\n\n    // Hand balance\n    const leftCount = this.events.filter(e => e.hand === 'left').length;\n    const rightCount = this.events.filter(e => e.hand === 'right').length;\n    const totalHands = leftCount + rightCount;\n    const handBalance = totalHands > 0 ? (leftCount / totalHands) * 100 : null;\n\n    // Error analysis\n    const errors = this.events.filter(e => !e.isCorrect);\n    const errorKeysSet = new Set(errors.map(e => e.expectedKey).filter(k => k !== null));\n    const errorKeys = Array.from(errorKeysSet) as string[];\n    \n    const errorsByType: Record<string, number> = {\n      substitution: 0,\n      adjacent: 0,\n      doublet: 0,\n      other: 0,\n    };\n\n    errors.forEach(event => {\n      if (!event.expectedKey) {\n        errorsByType.other++;\n        return;\n      }\n      \n      // Simple error classification\n      if (event.key === event.expectedKey) {\n        errorsByType.doublet++;\n      } else {\n        errorsByType.substitution++;\n      }\n    });\n\n    // Digraph analysis (two-key combinations)\n    const digraphs: Map<string, number[]> = new Map();\n    for (let i = 1; i < this.events.length; i++) {\n      const prev = this.events[i - 1];\n      const curr = this.events[i];\n      if (prev.releaseTime && curr.pressTime) {\n        const digraph = prev.key + curr.key;\n        const time = curr.pressTime - prev.releaseTime;\n        if (!digraphs.has(digraph)) {\n          digraphs.set(digraph, []);\n        }\n        digraphs.get(digraph)!.push(time);\n      }\n    }\n\n    let fastestDigraph = null;\n    let slowestDigraph = null;\n    let minTime = Infinity;\n    let maxTime = -Infinity;\n\n    digraphs.forEach((times, digraph) => {\n      const avgTime = times.reduce((a, b) => a + b, 0) / times.length;\n      if (avgTime < minTime) {\n        minTime = avgTime;\n        fastestDigraph = digraph;\n      }\n      if (avgTime > maxTime) {\n        maxTime = avgTime;\n        slowestDigraph = digraph;\n      }\n    });\n\n    // Calculate WPM by position (divide text into 10 chunks)\n    const wpmByPosition = this.calculateWpmByPosition();\n\n    // Identify slowest words\n    const slowestWords = this.calculateSlowestWords();\n\n    // === ENHANCED INDUSTRY-STANDARD METRICS ===\n    \n    // 1. Burst WPM - Peak 5-second performance window (like Monkeytype)\n    const burstWpm = this.calculateBurstWpm();\n    \n    // 2. Adjusted WPM - Calculate from actual correct keystrokes and test duration\n    // This is more accurate than applying a fixed penalty per error\n    let adjustedWpm: number | null = null;\n    if (this.events.length >= 2) {\n      const firstEvent = this.events[0];\n      const lastEvent = this.events[this.events.length - 1];\n      if (firstEvent.pressTime && lastEvent.releaseTime) {\n        const testDurationMs = lastEvent.releaseTime - firstEvent.pressTime;\n        const testDurationMinutes = testDurationMs / 60000;\n        if (testDurationMinutes > 0) {\n          const correctChars = this.events.filter(e => e.isCorrect).length;\n          // Standard WPM formula: (correct characters / 5) / minutes\n          adjustedWpm = Math.round((correctChars / 5) / testDurationMinutes);\n        }\n      }\n    }\n    // Fallback: use the already-calculated net WPM (which is passed in as 'wpm')\n    // This ensures we always use time-normalized calculations\n    if (adjustedWpm === null) {\n      adjustedWpm = Math.max(0, wpm);\n    }\n    \n    // 3. Rolling Accuracy - Accuracy across 5 chunks for trend analysis\n    const rollingAccuracy = this.calculateRollingAccuracy();\n    \n    // 4. Enhanced Digraph Analysis - Top 5 fastest and slowest with timings\n    const digraphAnalysis = this.calculateEnhancedDigraphs(digraphs);\n    const topDigraphs = digraphAnalysis.top;\n    const bottomDigraphs = digraphAnalysis.bottom;\n    \n    // 5. Typing Rhythm Score - Based on interkey timing variance (0-100)\n    // Lower variance = better rhythm = higher score\n    const typingRhythm = this.calculateTypingRhythm(flightTimes);\n    \n    // 6. Peak Performance Window - Best consecutive 20% of the test\n    const peakPerformanceWindow = this.calculatePeakPerformance();\n    \n    // 7. Fatigue Indicator - Speed drop from first half to second half (%)\n    const fatigueIndicator = this.calculateFatigueIndicator();\n    \n    // 8. Error Burst Count - Consecutive error sequences (indicates struggle points)\n    const errorBurstCount = this.calculateErrorBurstCount();\n    \n    // 9. Consistency/Rhythm Rating - Same as consistency score (0-100)\n    // This measures how consistent the timing is between keystrokes\n    const consistencyRating = consistency !== null \n      ? this.getConsistencyRating(consistency)\n      : null;\n\n    // === ANTI-CHEAT VALIDATION ===\n    const antiCheatValidation = this.performAntiCheatValidation(wpm, flightTimes);\n\n    return {\n      wpm,\n      rawWpm,\n      accuracy,\n      consistency,\n      avgDwellTime,\n      avgFlightTime,\n      stdDevFlightTime,\n      fastestDigraph,\n      slowestDigraph,\n      fingerUsage,\n      handBalance,\n      totalErrors,\n      errorsByType,\n      errorKeys,\n      wpmByPosition,\n      slowestWords,\n      keyHeatmap,\n      testResultId,\n      burstWpm,\n      adjustedWpm,\n      consistencyRating,\n      rollingAccuracy,\n      topDigraphs,\n      bottomDigraphs,\n      typingRhythm,\n      peakPerformanceWindow,\n      fatigueIndicator,\n      errorBurstCount,\n      ...antiCheatValidation,\n    };\n  }\n  \n  // Calculate peak 5-second WPM (burst speed)\n  private calculateBurstWpm(): number | null {\n    if (this.events.length < 5) return null;\n    \n    const windowMs = 5000; // 5 seconds\n    let maxBurstWpm = 0;\n    \n    for (let i = 0; i < this.events.length; i++) {\n      const windowStart = this.events[i].pressTime;\n      let windowEnd = windowStart + windowMs;\n      let charsInWindow = 0;\n      \n      for (let j = i; j < this.events.length; j++) {\n        if (this.events[j].pressTime > windowEnd) break;\n        if (this.events[j].isCorrect) charsInWindow++;\n      }\n      \n      // WPM = (chars / 5) / (minutes)\n      const burstWpm = Math.round((charsInWindow / 5) / (windowMs / 60000));\n      if (burstWpm > maxBurstWpm) maxBurstWpm = burstWpm;\n    }\n    \n    return maxBurstWpm > 0 ? Math.min(maxBurstWpm, 300) : null; // Cap at 300 WPM\n  }\n  \n  // Calculate accuracy across 5 chunks for trend analysis\n  private calculateRollingAccuracy(): number[] | null {\n    if (this.events.length < 5) return null;\n    \n    const numChunks = 5;\n    const chunkSize = Math.ceil(this.events.length / numChunks);\n    const rollingAccuracy: number[] = [];\n    \n    for (let i = 0; i < numChunks; i++) {\n      const startIdx = i * chunkSize;\n      const endIdx = Math.min((i + 1) * chunkSize, this.events.length);\n      const chunkEvents = this.events.slice(startIdx, endIdx);\n      \n      if (chunkEvents.length === 0) {\n        rollingAccuracy.push(0);\n        continue;\n      }\n      \n      const correct = chunkEvents.filter(e => e.isCorrect).length;\n      const acc = Math.round((correct / chunkEvents.length) * 100);\n      rollingAccuracy.push(acc);\n    }\n    \n    return rollingAccuracy;\n  }\n  \n  // Enhanced digraph analysis with top 5 fastest and slowest\n  private calculateEnhancedDigraphs(digraphs: Map<string, number[]>): { top: DigraphTiming[] | null; bottom: DigraphTiming[] | null } {\n    if (digraphs.size < 5) return { top: null, bottom: null };\n    \n    const digraphStats: DigraphTiming[] = [];\n    \n    digraphs.forEach((times, digraph) => {\n      if (times.length >= 2) { // Only consider digraphs with multiple occurrences\n        const avgTime = times.reduce((a, b) => a + b, 0) / times.length;\n        digraphStats.push({ digraph, avgTime: Math.round(avgTime), count: times.length });\n      }\n    });\n    \n    if (digraphStats.length < 5) return { top: null, bottom: null };\n    \n    // Sort by average time\n    digraphStats.sort((a, b) => a.avgTime - b.avgTime);\n    \n    const top = digraphStats.slice(0, 5);\n    const bottom = digraphStats.slice(-5).reverse();\n    \n    return { top, bottom };\n  }\n  \n  // Typing rhythm score based on interkey timing variance\n  // Uses same scaling as consistency for uniformity\n  private calculateTypingRhythm(flightTimes: number[]): number | null {\n    if (flightTimes.length < 3) return null;\n    \n    // Filter out extreme outliers (> 1000ms pauses are likely not typing rhythm)\n    // Use a generous threshold that works for slow typists too\n    let filteredTimes = flightTimes.filter(t => t > 0 && t < 1000);\n    \n    // Fallback: if too few times remain after filtering, use all positive flight times\n    if (filteredTimes.length < 3) {\n      filteredTimes = flightTimes.filter(t => t > 0);\n    }\n    if (filteredTimes.length < 3) return null;\n    \n    const mean = filteredTimes.reduce((a, b) => a + b, 0) / filteredTimes.length;\n    const variance = filteredTimes.reduce((sum, t) => sum + Math.pow(t - mean, 2), 0) / filteredTimes.length;\n    const stdDev = Math.sqrt(variance);\n    \n    // Coefficient of variation (0-1 range) - lower is better rhythm\n    const cv = stdDev / mean;\n    \n    // Convert to 0-100 score using same scaling as consistency formula\n    // Flight times naturally have higher variance, so use gentler scaling (cv * 50)\n    // This matches the consistency calculation for uniform metrics\n    const rhythmScore = Math.max(0, Math.min(100, 100 - (cv * 50)));\n    \n    return Math.round(rhythmScore);\n  }\n  \n  // Find the best performing 20% window of the test\n  private calculatePeakPerformance(): { startPos: number; endPos: number; wpm: number } | null {\n    if (this.events.length < 5) return null;\n    \n    const windowSize = Math.ceil(this.events.length * 0.2);\n    let bestWindow = { startPos: 0, endPos: 0, wpm: 0 };\n    \n    for (let i = 0; i <= this.events.length - windowSize; i++) {\n      const windowEvents = this.events.slice(i, i + windowSize);\n      \n      const firstEvent = windowEvents[0];\n      const lastEvent = windowEvents[windowEvents.length - 1];\n      \n      if (!firstEvent.pressTime || !lastEvent.releaseTime) continue;\n      \n      const durationMs = lastEvent.releaseTime - firstEvent.pressTime;\n      if (durationMs <= 0) continue;\n      \n      const correctChars = windowEvents.filter(e => e.isCorrect).length;\n      const windowWpm = Math.round((correctChars / 5) / (durationMs / 60000));\n      \n      if (windowWpm > bestWindow.wpm) {\n        bestWindow = {\n          startPos: firstEvent.position,\n          endPos: lastEvent.position,\n          wpm: Math.min(windowWpm, 300)\n        };\n      }\n    }\n    \n    return bestWindow.wpm > 0 ? bestWindow : null;\n  }\n  \n  // Calculate speed drop from first half to second half (fatigue indicator)\n  private calculateFatigueIndicator(): number | null {\n    if (this.events.length < 10) return null;\n    \n    const midpoint = Math.floor(this.events.length / 2);\n    const firstHalf = this.events.slice(0, midpoint);\n    const secondHalf = this.events.slice(midpoint);\n    \n    const calculateHalfWpm = (events: KeystrokeEvent[]): number => {\n      if (events.length < 5) return 0;\n      const first = events[0];\n      const last = events[events.length - 1];\n      if (!first.pressTime || !last.releaseTime) return 0;\n      const durationMs = last.releaseTime - first.pressTime;\n      if (durationMs <= 0) return 0;\n      const correctChars = events.filter(e => e.isCorrect).length;\n      return (correctChars / 5) / (durationMs / 60000);\n    };\n    \n    const firstHalfWpm = calculateHalfWpm(firstHalf);\n    const secondHalfWpm = calculateHalfWpm(secondHalf);\n    \n    if (firstHalfWpm === 0) return null;\n    \n    // Positive = fatigue (slowed down), Negative = warmed up (sped up)\n    const speedChange = ((firstHalfWpm - secondHalfWpm) / firstHalfWpm) * 100;\n    \n    return Math.round(speedChange);\n  }\n  \n  // Count consecutive error sequences (error bursts)\n  private calculateErrorBurstCount(): number | null {\n    if (this.events.length < 3) return null;\n    \n    let burstCount = 0;\n    let inBurst = false;\n    \n    for (const event of this.events) {\n      if (!event.isCorrect) {\n        if (!inBurst) {\n          burstCount++;\n          inBurst = true;\n        }\n      } else {\n        inBurst = false;\n      }\n    }\n    \n    return burstCount;\n  }\n  \n  // Get rhythm rating - simply returns the consistency score\n  // Consistency score (0-100) directly measures typing rhythm stability\n  // Higher scores indicate more consistent timing between keystrokes\n  private getConsistencyRating(consistency: number): number {\n    return Math.max(0, Math.min(100, Math.round(consistency)));\n  }\n\n  private calculateWpmByPosition(): number[] | null {\n    if (this.events.length < 10) return null;\n\n    const numChunks = 10;\n    const chunkSize = Math.ceil(this.events.length / numChunks);\n    const wpmByPosition: number[] = [];\n\n    for (let i = 0; i < numChunks; i++) {\n      const startIdx = i * chunkSize;\n      const endIdx = Math.min((i + 1) * chunkSize, this.events.length);\n      const chunkEvents = this.events.slice(startIdx, endIdx);\n\n      if (chunkEvents.length < 2) {\n        wpmByPosition.push(0);\n        continue;\n      }\n\n      const firstEvent = chunkEvents[0];\n      const lastEvent = chunkEvents[chunkEvents.length - 1];\n      \n      if (!firstEvent.pressTime || !lastEvent.releaseTime) {\n        wpmByPosition.push(0);\n        continue;\n      }\n\n      const chunkDuration = (lastEvent.releaseTime - firstEvent.pressTime) / 1000 / 60; // in minutes\n      if (chunkDuration <= 0) {\n        wpmByPosition.push(0);\n        continue;\n      }\n\n      const correctChars = chunkEvents.filter(e => e.isCorrect).length;\n      const chunkWpm = Math.round((correctChars / 5) / chunkDuration);\n      wpmByPosition.push(Math.min(chunkWpm, 300)); // Cap at 300 WPM for sanity\n    }\n\n    return wpmByPosition.length > 0 ? wpmByPosition : null;\n  }\n\n  private calculateSlowestWords(): string[] | null {\n    if (this.events.length < 5 || !this.expectedText) return null;\n\n    // Split expected text into words\n    const words = this.expectedText.split(/\\s+/);\n    if (words.length < 2) return null;\n\n    // Map events to word boundaries\n    const wordTimings: { word: string; startTime: number; endTime: number; duration: number }[] = [];\n    let currentWordIndex = 0;\n    let currentWordStart = 0;\n    let charPosition = 0;\n\n    // Find character positions for each word\n    const wordPositions: { word: string; startPos: number; endPos: number }[] = [];\n    let pos = 0;\n    for (const word of words) {\n      wordPositions.push({\n        word,\n        startPos: pos,\n        endPos: pos + word.length - 1\n      });\n      pos += word.length + 1; // +1 for space\n    }\n\n    // Calculate timing for each word based on keystroke events\n    for (const wp of wordPositions) {\n      const wordEvents = this.events.filter(e => e.position >= wp.startPos && e.position <= wp.endPos);\n      \n      if (wordEvents.length < 2) continue;\n\n      const startTime = wordEvents[0].pressTime;\n      const lastEvent = wordEvents[wordEvents.length - 1];\n      const endTime = lastEvent.releaseTime || lastEvent.pressTime;\n\n      if (startTime && endTime && endTime > startTime) {\n        wordTimings.push({\n          word: wp.word,\n          startTime,\n          endTime,\n          duration: endTime - startTime\n        });\n      }\n    }\n\n    if (wordTimings.length < 3) return null;\n\n    // Calculate average word duration\n    const avgDuration = wordTimings.reduce((sum, w) => sum + w.duration, 0) / wordTimings.length;\n\n    // Find words slower than average (sorted by how much slower)\n    const slowWords = wordTimings\n      .filter(w => w.duration > avgDuration * 1.3) // 30% slower than average\n      .sort((a, b) => b.duration - a.duration)\n      .slice(0, 10) // Top 10 slowest\n      .map(w => w.word);\n\n    return slowWords.length > 0 ? slowWords : null;\n  }\n\n  private performAntiCheatValidation(wpm: number, flightTimes: number[]): AntiCheatValidation {\n    const suspiciousFlags: string[] = [];\n    let syntheticInputDetected = false;\n    \n    if (this.events.length < ANTICHEAT_THRESHOLDS.MIN_KEYSTROKES_FOR_ANALYSIS) {\n      return {\n        isSuspicious: false,\n        suspiciousFlags: null,\n        validationScore: 100,\n        minKeystrokeInterval: null,\n        keystrokeVariance: null,\n        syntheticInputDetected: false,\n      };\n    }\n    \n    const intervals: number[] = [];\n    for (let i = 1; i < this.events.length; i++) {\n      const interval = this.events[i].pressTime - this.events[i - 1].pressTime;\n      if (interval > 0) intervals.push(interval);\n    }\n    \n    const minInterval = intervals.length > 0 ? Math.min(...intervals) : null;\n    const avgInterval = intervals.length > 0 ? intervals.reduce((a, b) => a + b, 0) / intervals.length : 0;\n    const variance = intervals.length > 1 \n      ? intervals.reduce((sum, t) => sum + Math.pow(t - avgInterval, 2), 0) / intervals.length\n      : null;\n    \n    if (minInterval !== null && minInterval < ANTICHEAT_THRESHOLDS.MIN_KEYSTROKE_INTERVAL_MS) {\n      suspiciousFlags.push('inhuman_speed');\n      syntheticInputDetected = true;\n    }\n    \n    if (wpm > ANTICHEAT_THRESHOLDS.MAX_WPM_WITHOUT_FLAG) {\n      suspiciousFlags.push('impossible_wpm');\n    }\n    \n    if (variance !== null && variance < ANTICHEAT_THRESHOLDS.MAX_CONSISTENT_VARIANCE && intervals.length > 20) {\n      suspiciousFlags.push('programmatic_pattern');\n      syntheticInputDetected = true;\n    }\n    \n    if (this.detectSuspiciousBursts(intervals)) {\n      suspiciousFlags.push('burst_typing');\n    }\n    \n    if (this.detectPerfectRhythm(intervals)) {\n      suspiciousFlags.push('perfect_rhythm');\n      syntheticInputDetected = true;\n    }\n    \n    // Flight time analysis - detect unnatural consistency in key-to-key transition times\n    if (flightTimes.length > 20) {\n      const filteredFlights = flightTimes.filter(t => t > 0 && t < 500);\n      if (filteredFlights.length > 10) {\n        const avgFlight = filteredFlights.reduce((a, b) => a + b, 0) / filteredFlights.length;\n        const flightVariance = filteredFlights.reduce((sum, t) => sum + Math.pow(t - avgFlight, 2), 0) / filteredFlights.length;\n        \n        // Extremely low flight variance (< 5ms^2) indicates programmatic input\n        if (flightVariance < ANTICHEAT_THRESHOLDS.MAX_CONSISTENT_VARIANCE) {\n          if (!suspiciousFlags.includes('programmatic_pattern')) {\n            suspiciousFlags.push('uniform_flight_times');\n          }\n          syntheticInputDetected = true;\n        }\n      }\n    }\n    \n    let validationScore = 100;\n    validationScore -= suspiciousFlags.length * 20;\n    if (syntheticInputDetected) validationScore -= 30;\n    validationScore = Math.max(0, validationScore);\n    \n    const isSuspicious = suspiciousFlags.length >= ANTICHEAT_THRESHOLDS.SUSPICIOUS_FLAG_THRESHOLD;\n    \n    return {\n      isSuspicious,\n      suspiciousFlags: suspiciousFlags.length > 0 ? suspiciousFlags : null,\n      validationScore,\n      minKeystrokeInterval: minInterval !== null ? Math.round(minInterval) : null,\n      keystrokeVariance: variance !== null ? Math.round(variance * 100) / 100 : null,\n      syntheticInputDetected,\n    };\n  }\n\n  private detectSuspiciousBursts(intervals: number[]): boolean {\n    if (intervals.length < ANTICHEAT_THRESHOLDS.BURST_WINDOW_SIZE * 2) return false;\n    \n    for (let i = 0; i <= intervals.length - ANTICHEAT_THRESHOLDS.BURST_WINDOW_SIZE; i++) {\n      const window = intervals.slice(i, i + ANTICHEAT_THRESHOLDS.BURST_WINDOW_SIZE);\n      const fastCount = window.filter(t => t < ANTICHEAT_THRESHOLDS.SUSPECT_INTERVAL_MS).length;\n      if (fastCount / window.length >= ANTICHEAT_THRESHOLDS.BURST_THRESHOLD_RATIO) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  private detectPerfectRhythm(intervals: number[]): boolean {\n    if (intervals.length < 20) return false;\n    \n    let consistentCount = 0;\n    for (let i = 1; i < intervals.length; i++) {\n      const diff = Math.abs(intervals[i] - intervals[i - 1]);\n      if (diff < ANTICHEAT_THRESHOLDS.MAX_CONSISTENT_VARIANCE) {\n        consistentCount++;\n      }\n    }\n    \n    return (consistentCount / intervals.length) > ANTICHEAT_THRESHOLDS.PERFECT_RHYTHM_THRESHOLD;\n  }\n\n  getEvents(): KeystrokeEvent[] {\n    return this.events;\n  }\n\n  reset() {\n    this.events = [];\n    this.pressedKeys.clear();\n    this.lastReleaseTime = null;\n    this.currentPosition = 0;\n  }\n}\n","path":null,"size_bytes":35851,"size_tokens":null},"client/src/lib/notification-manager.ts":{"content":"// Browser Push Notification Manager\n// Handles service worker registration, push subscription, and permission requests\n\nexport class NotificationManager {\n  private static instance: NotificationManager;\n  private registration: ServiceWorkerRegistration | null = null;\n  private subscription: PushSubscription | null = null;\n\n  private constructor() {}\n\n  static getInstance(): NotificationManager {\n    if (!NotificationManager.instance) {\n      NotificationManager.instance = new NotificationManager();\n    }\n    return NotificationManager.instance;\n  }\n\n  // Check if browser supports notifications\n  isSupported(): boolean {\n    return (\n      'serviceWorker' in navigator &&\n      'PushManager' in window &&\n      'Notification' in window\n    );\n  }\n\n  // Get current permission status\n  getPermissionStatus(): NotificationPermission {\n    return Notification.permission;\n  }\n\n  // Register service worker\n  async registerServiceWorker(): Promise<ServiceWorkerRegistration | null> {\n    if (!this.isSupported()) {\n      console.warn('[Notifications] Push notifications not supported');\n      return null;\n    }\n\n    try {\n      this.registration = await navigator.serviceWorker.register(\n        '/service-worker.js',\n        { scope: '/' }\n      );\n\n      console.log('[Notifications] Service Worker registered:', this.registration);\n\n      // Wait for service worker to be ready\n      await navigator.serviceWorker.ready;\n\n      return this.registration;\n    } catch (error) {\n      console.error('[Notifications] Service Worker registration failed:', error);\n      return null;\n    }\n  }\n\n  // Request notification permission from user\n  async requestPermission(): Promise<NotificationPermission> {\n    if (!this.isSupported()) {\n      console.warn('[Notifications] Push notifications not supported');\n      return 'denied';\n    }\n\n    try {\n      const permission = await Notification.requestPermission();\n      console.log('[Notifications] Permission status:', permission);\n      return permission;\n    } catch (error) {\n      console.error('[Notifications] Permission request failed:', error);\n      return 'denied';\n    }\n  }\n\n  // Subscribe to push notifications\n  async subscribe(vapidPublicKey: string): Promise<PushSubscription | null> {\n    if (!this.registration) {\n      await this.registerServiceWorker();\n    }\n\n    if (!this.registration) {\n      console.error('[Notifications] No service worker registration');\n      return null;\n    }\n\n    try {\n      const convertedKey = this.urlBase64ToUint8Array(vapidPublicKey);\n\n      this.subscription = await this.registration.pushManager.subscribe({\n        userVisibleOnly: true,\n        applicationServerKey: convertedKey,\n      });\n\n      console.log('[Notifications] Push subscription created:', this.subscription);\n      return this.subscription;\n    } catch (error) {\n      console.error('[Notifications] Push subscription failed:', error);\n      return null;\n    }\n  }\n\n  // Get existing subscription\n  async getSubscription(): Promise<PushSubscription | null> {\n    if (!this.registration) {\n      await this.registerServiceWorker();\n    }\n\n    if (!this.registration) {\n      return null;\n    }\n\n    try {\n      this.subscription = await this.registration.pushManager.getSubscription();\n      return this.subscription;\n    } catch (error) {\n      console.error('[Notifications] Failed to get subscription:', error);\n      return null;\n    }\n  }\n\n  // Unsubscribe from push notifications\n  async unsubscribe(): Promise<boolean> {\n    const subscription = await this.getSubscription();\n\n    if (!subscription) {\n      console.log('[Notifications] No active subscription to unsubscribe');\n      return true;\n    }\n\n    try {\n      const result = await subscription.unsubscribe();\n      console.log('[Notifications] Unsubscribed successfully:', result);\n      this.subscription = null;\n      return result;\n    } catch (error) {\n      console.error('[Notifications] Unsubscribe failed:', error);\n      return false;\n    }\n  }\n\n  // Save subscription to server\n  async saveSubscriptionToServer(subscription: PushSubscription): Promise<boolean> {\n    try {\n      const response = await fetch('/api/notifications/subscribe', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify(subscription),\n      });\n\n      if (!response.ok) {\n        throw new Error(`Server returned ${response.status}`);\n      }\n\n      console.log('[Notifications] Subscription saved to server');\n      return true;\n    } catch (error) {\n      console.error('[Notifications] Failed to save subscription:', error);\n      return false;\n    }\n  }\n\n  // Remove subscription from server\n  async removeSubscriptionFromServer(): Promise<boolean> {\n    try {\n      const response = await fetch('/api/notifications/unsubscribe', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n      });\n\n      if (!response.ok) {\n        throw new Error(`Server returned ${response.status}`);\n      }\n\n      console.log('[Notifications] Subscription removed from server');\n      return true;\n    } catch (error) {\n      console.error('[Notifications] Failed to remove subscription:', error);\n      return false;\n    }\n  }\n\n  // Complete flow: Request permission, subscribe, and save to server\n  async enableNotifications(vapidPublicKey: string): Promise<{\n    success: boolean;\n    permission?: NotificationPermission;\n    subscription?: PushSubscription;\n    error?: string;\n  }> {\n    try {\n      // Check support\n      if (!this.isSupported()) {\n        return {\n          success: false,\n          error: 'Push notifications are not supported in your browser',\n        };\n      }\n\n      // Request permission\n      const permission = await this.requestPermission();\n      if (permission !== 'granted') {\n        return {\n          success: false,\n          permission,\n          error: 'Notification permission was denied',\n        };\n      }\n\n      // Subscribe to push\n      const subscription = await this.subscribe(vapidPublicKey);\n      if (!subscription) {\n        return {\n          success: false,\n          permission,\n          error: 'Failed to create push subscription',\n        };\n      }\n\n      // Save to server\n      const saved = await this.saveSubscriptionToServer(subscription);\n      if (!saved) {\n        return {\n          success: false,\n          permission,\n          subscription,\n          error: 'Failed to save subscription to server',\n        };\n      }\n\n      return {\n        success: true,\n        permission,\n        subscription,\n      };\n    } catch (error: any) {\n      console.error('[Notifications] Enable notifications failed:', error);\n      return {\n        success: false,\n        error: error.message || 'An unexpected error occurred',\n      };\n    }\n  }\n\n  // Complete flow: Unsubscribe and remove from server\n  async disableNotifications(): Promise<{\n    success: boolean;\n    error?: string;\n  }> {\n    try {\n      // Remove from server first\n      await this.removeSubscriptionFromServer();\n\n      // Then unsubscribe locally\n      const unsubscribed = await this.unsubscribe();\n\n      return {\n        success: unsubscribed,\n        error: unsubscribed ? undefined : 'Failed to unsubscribe',\n      };\n    } catch (error: any) {\n      console.error('[Notifications] Disable notifications failed:', error);\n      return {\n        success: false,\n        error: error.message || 'An unexpected error occurred',\n      };\n    }\n  }\n\n  // Show a test notification (for testing purposes)\n  async showTestNotification(title: string, options?: NotificationOptions): Promise<void> {\n    if (!this.registration) {\n      console.error('[Notifications] No service worker registration');\n      return;\n    }\n\n    try {\n      const notificationOptions: NotificationOptions = {\n        body: options?.body || 'This is a test notification',\n        icon: options?.icon || '/icon-192x192.png',\n        badge: options?.badge || '/icon-72x72.png',\n        data: options?.data || { url: '/' },\n        ...options,\n      };\n\n      await this.registration.showNotification(title, notificationOptions);\n      console.log('[Notifications] Test notification shown');\n    } catch (error) {\n      console.error('[Notifications] Failed to show test notification:', error);\n    }\n  }\n\n  // Helper: Convert VAPID public key from Base64 to Uint8Array\n  private urlBase64ToUint8Array(base64String: string): Uint8Array {\n    const padding = '='.repeat((4 - (base64String.length % 4)) % 4);\n    const base64 = (base64String + padding)\n      .replace(/-/g, '+')\n      .replace(/_/g, '/');\n\n    const rawData = window.atob(base64);\n    const outputArray = new Uint8Array(rawData.length);\n\n    for (let i = 0; i < rawData.length; ++i) {\n      outputArray[i] = rawData.charCodeAt(i);\n    }\n\n    return outputArray;\n  }\n}\n\n// Export singleton instance\nexport const notificationManager = NotificationManager.getInstance();\n","path":null,"size_bytes":9008,"size_tokens":null},"client/public/service-worker.js":{"content":"// TypeMasterAI Service Worker - PWA & Push Notifications\nconst CACHE_NAME = 'typemaster-v1';\nconst urlsToCache = [\n  '/',\n  '/offline.html'\n];\n\n// Install Service Worker and cache resources\nself.addEventListener('install', event => {\n  console.log('[Service Worker] Installing...');\n  event.waitUntil(\n    caches.open(CACHE_NAME)\n      .then(cache => {\n        console.log('[Service Worker] Caching app shell');\n        return cache.addAll(urlsToCache);\n      })\n      .then(() => self.skipWaiting())\n  );\n});\n\n// Activate Service Worker and clean up old caches\nself.addEventListener('activate', event => {\n  console.log('[Service Worker] Activating...');\n  event.waitUntil(\n    caches.keys().then(cacheNames => {\n      return Promise.all(\n        cacheNames.map(cacheName => {\n          if (cacheName !== CACHE_NAME) {\n            console.log('[Service Worker] Deleting old cache:', cacheName);\n            return caches.delete(cacheName);\n          }\n        })\n      );\n    }).then(() => self.clients.claim())\n  );\n});\n\n// Fetch Strategy: Network First, fallback to Cache\nself.addEventListener('fetch', event => {\n  // Skip non-GET requests\n  if (event.request.method !== 'GET') return;\n  \n  // Skip chrome-extension and other protocols\n  if (!event.request.url.startsWith('http')) return;\n\n  event.respondWith(\n    fetch(event.request)\n      .then(response => {\n        // Clone the response before caching\n        const responseToCache = response.clone();\n        caches.open(CACHE_NAME).then(cache => {\n          cache.put(event.request, responseToCache);\n        });\n        return response;\n      })\n      .catch(() => {\n        // If network fails, try cache\n        return caches.match(event.request).then(response => {\n          if (response) {\n            return response;\n          }\n          // Return offline page for navigation requests\n          if (event.request.mode === 'navigate') {\n            return caches.match('/offline.html');\n          }\n        });\n      })\n  );\n});\n\n// Push Notification Handler\nself.addEventListener('push', event => {\n  console.log('[Service Worker] Push notification received');\n  \n  let notificationData = {\n    title: 'TypeMasterAI',\n    body: 'You have a new notification',\n    icon: '/icon-192x192.png',\n    badge: '/icon-72x72.png',\n    vibrate: [200, 100, 200],\n    data: {\n      url: '/',\n      timestamp: Date.now()\n    },\n    actions: []\n  };\n\n  if (event.data) {\n    try {\n      const payload = event.data.json();\n      notificationData = {\n        ...notificationData,\n        title: payload.title || notificationData.title,\n        body: payload.body || notificationData.body,\n        icon: payload.icon || notificationData.icon,\n        badge: payload.badge || notificationData.badge,\n        data: {\n          url: payload.url || notificationData.data.url,\n          timestamp: Date.now(),\n          type: payload.type,\n          ...payload.data\n        },\n        tag: payload.tag || `notification-${Date.now()}`,\n        requireInteraction: payload.requireInteraction || false\n      };\n\n      // Add context-specific actions\n      if (payload.type === 'daily_reminder') {\n        notificationData.actions = [\n          { action: 'start_test', title: 'Start Test', icon: '/icon-96x96.png' },\n          { action: 'dismiss', title: 'Later' }\n        ];\n      } else if (payload.type === 'streak_warning') {\n        notificationData.actions = [\n          { action: 'save_streak', title: 'Save Streak!', icon: '/icon-96x96.png' },\n          { action: 'dismiss', title: 'Ignore' }\n        ];\n      } else if (payload.type === 'race_invite') {\n        notificationData.actions = [\n          { action: 'join_race', title: 'Join Race', icon: '/icon-96x96.png' },\n          { action: 'dismiss', title: 'Decline' }\n        ];\n      } else if (payload.type === 'achievement_unlocked') {\n        notificationData.actions = [\n          { action: 'view_achievement', title: 'View', icon: '/icon-96x96.png' }\n        ];\n      } else {\n        notificationData.actions = [\n          { action: 'view', title: 'View' },\n          { action: 'dismiss', title: 'Dismiss' }\n        ];\n      }\n    } catch (error) {\n      console.error('[Service Worker] Error parsing push payload:', error);\n    }\n  }\n\n  event.waitUntil(\n    self.registration.showNotification(notificationData.title, notificationData)\n  );\n});\n\n// Notification Click Handler\nself.addEventListener('notificationclick', event => {\n  console.log('[Service Worker] Notification click:', event.action);\n  event.notification.close();\n\n  const urlToOpen = event.notification.data?.url || '/';\n  const action = event.action;\n\n  // Handle different actions\n  if (action === 'dismiss') {\n    // Just close the notification\n    return;\n  }\n\n  // Track notification click\n  if (event.notification.data?.notificationId) {\n    fetch('/api/notifications/track-click', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        notificationId: event.notification.data.notificationId,\n        action: action || 'default'\n      })\n    }).catch(err => console.error('[Service Worker] Failed to track click:', err));\n  }\n\n  // Determine target URL based on action\n  let targetUrl = urlToOpen;\n  if (action === 'start_test' || action === 'save_streak') {\n    targetUrl = '/';\n  } else if (action === 'join_race') {\n    targetUrl = event.notification.data?.raceUrl || '/multiplayer';\n  } else if (action === 'view_achievement') {\n    targetUrl = '/profile';\n  } else if (action === 'view') {\n    targetUrl = urlToOpen;\n  }\n\n  // Open or focus window\n  event.waitUntil(\n    clients.matchAll({ type: 'window', includeUncontrolled: true })\n      .then(windowClients => {\n        // Check if there's already a window open\n        for (let client of windowClients) {\n          if (client.url === targetUrl && 'focus' in client) {\n            return client.focus();\n          }\n        }\n        // If not, open a new window\n        if (clients.openWindow) {\n          return clients.openWindow(targetUrl);\n        }\n      })\n  );\n});\n\n// Handle Push Subscription Changes (e.g., expired)\nself.addEventListener('pushsubscriptionchange', event => {\n  console.log('[Service Worker] Push subscription changed');\n  \n  event.waitUntil(\n    self.registration.pushManager.subscribe({\n      userVisibleOnly: true,\n      applicationServerKey: urlBase64ToUint8Array(self.VAPID_PUBLIC_KEY || '')\n    }).then(subscription => {\n      console.log('[Service Worker] Re-subscribed to push');\n      return fetch('/api/notifications/update-subscription', {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify(subscription)\n      });\n    }).catch(error => {\n      console.error('[Service Worker] Re-subscription failed:', error);\n    })\n  );\n});\n\n// Background Sync (for offline actions)\nself.addEventListener('sync', event => {\n  console.log('[Service Worker] Background sync:', event.tag);\n  \n  if (event.tag === 'sync-test-results') {\n    event.waitUntil(syncTestResults());\n  }\n});\n\n// Helper: Sync test results when online\nasync function syncTestResults() {\n  try {\n    const cache = await caches.open('pending-requests');\n    const requests = await cache.keys();\n    \n    for (const request of requests) {\n      try {\n        await fetch(request.clone());\n        await cache.delete(request);\n      } catch (error) {\n        console.error('[Service Worker] Failed to sync request:', error);\n      }\n    }\n  } catch (error) {\n    console.error('[Service Worker] Sync failed:', error);\n  }\n}\n\n// Helper: Convert VAPID key\nfunction urlBase64ToUint8Array(base64String) {\n  const padding = '='.repeat((4 - base64String.length % 4) % 4);\n  const base64 = (base64String + padding)\n    .replace(/\\-/g, '+')\n    .replace(/_/g, '/');\n  const rawData = atob(base64);\n  return Uint8Array.from([...rawData].map(char => char.charCodeAt(0)));\n}\n\nconsole.log('[Service Worker] Loaded successfully');\n","path":null,"size_bytes":8000,"size_tokens":null},"server/achievement-service.ts":{"content":"import type { IStorage } from './storage';\nimport type { NotificationScheduler } from './notification-scheduler';\nimport type { TestResult, Achievement } from '@shared/schema';\nimport { BADGES, type Badge } from '@shared/badges';\n\ninterface AchievementCheck {\n  key: string;\n  name: string;\n  description: string;\n  category: string;\n  tier: string;\n  points: number;\n  icon: string;\n  color: string;\n  check: (stats: UserStats) => boolean;\n  getProgress?: (stats: UserStats) => number;\n  target?: number;\n  isSecret?: boolean;\n}\n\nexport interface NearCompletionAchievement {\n  key: string;\n  name: string;\n  description: string;\n  category: string;\n  tier: string;\n  points: number;\n  icon: string;\n  color: string;\n  progress: number;\n  currentValue: number;\n  targetValue: number;\n}\n\ninterface UserStats {\n  totalTests: number;\n  bestWpm: number;\n  avgWpm: number;\n  avgAccuracy: number;\n  currentStreak: number;\n  bestStreak: number;\n  lastTestResult?: TestResult;\n  totalShares?: number;\n  testHour?: number;\n  consecutivePerfectAccuracy?: number;\n  testsCompletedToday?: number;\n  best100WpmInFirst10Tests?: boolean;\n}\n\n/**\n * Build AchievementCheck array from shared BADGES definitions\n * This ensures frontend and backend use a single source of truth\n */\nfunction buildAchievementChecks(): AchievementCheck[] {\n  return BADGES.map((badge: Badge): AchievementCheck => {\n    const { id, name, description, icon, category, tier, points, color, requirement, isSecret } = badge;\n    \n    let check: (stats: UserStats) => boolean;\n    let getProgress: ((stats: UserStats) => number) | undefined;\n    let target: number | undefined = requirement.value > 0 ? requirement.value : undefined;\n    \n    switch (requirement.type) {\n      case 'wpm':\n        check = (stats) => stats.bestWpm >= requirement.value;\n        getProgress = (stats) => Math.min(100, (stats.bestWpm / requirement.value) * 100);\n        break;\n        \n      case 'accuracy':\n        if (id === 'accuracy_flawless_100') {\n          check = (stats) => stats.lastTestResult?.accuracy === 100;\n          getProgress = (stats) => stats.lastTestResult ? Math.min(100, stats.lastTestResult.accuracy) : stats.avgAccuracy;\n        } else {\n          check = (stats) => stats.avgAccuracy >= requirement.value;\n          getProgress = (stats) => Math.min(100, (stats.avgAccuracy / requirement.value) * 100);\n        }\n        break;\n        \n      case 'testCount':\n        check = (stats) => stats.totalTests >= requirement.value;\n        getProgress = requirement.value === 1 \n          ? (stats) => stats.totalTests >= 1 ? 100 : 0\n          : (stats) => Math.min(100, (stats.totalTests / requirement.value) * 100);\n        break;\n        \n      case 'streak':\n        check = (stats) => stats.currentStreak >= requirement.value;\n        getProgress = (stats) => Math.min(100, (stats.currentStreak / requirement.value) * 100);\n        break;\n        \n      case 'shares':\n        check = (stats) => (stats.totalShares ?? 0) >= requirement.value;\n        getProgress = requirement.value === 1\n          ? (stats) => (stats.totalShares ?? 0) >= 1 ? 100 : 0\n          : (stats) => Math.min(100, ((stats.totalShares ?? 0) / requirement.value) * 100);\n        break;\n        \n      case 'special':\n        if (id === 'special_speed_accuracy') {\n          check = (stats) => stats.lastTestResult ? \n            stats.lastTestResult.wpm >= 80 && stats.lastTestResult.accuracy >= 95 : false;\n          getProgress = (stats) => {\n            if (!stats.lastTestResult) return 0;\n            const speedProgress = Math.min(100, (stats.lastTestResult.wpm / 80) * 100);\n            const accuracyProgress = Math.min(100, (stats.lastTestResult.accuracy / 95) * 100);\n            return Math.min(speedProgress, accuracyProgress);\n          };\n        } else {\n          check = () => false;\n        }\n        break;\n        \n      case 'secret':\n        switch (id) {\n          case 'secret_night_owl':\n            check = (stats) => {\n              const hour = stats.testHour ?? -1;\n              return hour >= 0 && hour < 4;\n            };\n            break;\n          case 'secret_early_bird':\n            check = (stats) => {\n              const hour = stats.testHour ?? -1;\n              return hour >= 5 && hour < 7;\n            };\n            break;\n          case 'secret_speed_demon':\n            check = (stats) => stats.best100WpmInFirst10Tests === true;\n            break;\n          case 'secret_perfectionist':\n            target = 5;\n            check = (stats) => (stats.consecutivePerfectAccuracy ?? 0) >= 5;\n            getProgress = (stats) => Math.min(100, ((stats.consecutivePerfectAccuracy ?? 0) / 5) * 100);\n            break;\n          case 'secret_marathon_runner':\n            target = 10;\n            check = (stats) => (stats.testsCompletedToday ?? 0) >= 10;\n            getProgress = (stats) => Math.min(100, ((stats.testsCompletedToday ?? 0) / 10) * 100);\n            break;\n          default:\n            check = () => false;\n        }\n        break;\n        \n      default:\n        check = () => false;\n    }\n    \n    return {\n      key: id,\n      name,\n      description,\n      category,\n      tier,\n      points,\n      icon,\n      color,\n      check,\n      getProgress,\n      target,\n      isSecret,\n    };\n  });\n}\n\nexport class AchievementService {\n  private storage: IStorage;\n  private notificationScheduler?: NotificationScheduler;\n  \n  private achievements: AchievementCheck[] = buildAchievementChecks();\n\n  constructor(storage: IStorage, notificationScheduler?: NotificationScheduler) {\n    this.storage = storage;\n    this.notificationScheduler = notificationScheduler;\n  }\n\n  /**\n   * Initialize achievement system by seeding achievements in database\n   * @throws Error if critical initialization fails\n   */\n  async initializeAchievements(): Promise<void> {\n    console.log('[Achievements] Initializing achievement system...');\n    let created = 0;\n    let existing = 0;\n    const errors: Array<{ key: string; error: unknown }> = [];\n    \n    for (const achievement of this.achievements) {\n      try {\n        const existingAchievement = await this.storage.getAchievementByKey(achievement.key);\n        \n        if (!existingAchievement) {\n          await this.storage.createAchievement({\n            key: achievement.key,\n            name: achievement.name,\n            description: achievement.description,\n            category: achievement.category,\n            tier: achievement.tier,\n            requirement: { type: 'custom', check: achievement.key },\n            points: achievement.points,\n            icon: achievement.icon,\n            color: achievement.color,\n            isSecret: achievement.isSecret ?? false,\n            isActive: true,\n          });\n          created++;\n        } else {\n          existing++;\n        }\n      } catch (error) {\n        errors.push({ key: achievement.key, error });\n        console.error(`[Achievements] Failed to initialize achievement ${achievement.key}:`, error);\n      }\n    }\n    \n    console.log(`[Achievements] Achievement system initialized: ${created} created, ${existing} existing, ${errors.length} errors`);\n    \n    if (errors.length > 0) {\n      console.error(`[Achievements] Failed achievements: ${errors.map(e => e.key).join(', ')}`);\n      if (errors.length === this.achievements.length) {\n        throw new Error('Achievement system initialization completely failed - no achievements could be created');\n      }\n    }\n  }\n\n  /**\n   * Check for new achievement unlocks after a test\n   * Returns an array of newly unlocked achievements for celebration UI\n   */\n  async checkAchievements(userId: string, testResult: TestResult): Promise<AchievementCheck[]> {\n    const newlyUnlocked: AchievementCheck[] = [];\n    const errors: Array<{ achievement: string; error: unknown }> = [];\n    \n    try {\n      // Get user stats\n      const stats = await this.storage.getUserStats(userId);\n      const badgeData = await this.storage.getUserBadgeData(userId);\n      \n      if (!stats) {\n        console.warn(`[Achievements] No stats found for user ${userId}, skipping achievement check`);\n        return newlyUnlocked;\n      }\n\n      // Calculate extended stats for secret achievements\n      const extendedStats = await this.calculateExtendedStats(userId, testResult);\n\n      const userStats: UserStats = {\n        totalTests: stats.totalTests,\n        bestWpm: stats.bestWpm,\n        avgWpm: stats.avgWpm,\n        avgAccuracy: stats.avgAccuracy,\n        currentStreak: badgeData?.currentStreak || 0,\n        bestStreak: badgeData?.bestStreak || 0,\n        lastTestResult: testResult,\n        ...extendedStats,\n      };\n\n      // Get user's existing achievements\n      const userAchievements = await this.storage.getUserAchievements(userId);\n      const unlockedKeys = new Set(userAchievements.map(ua => ua.achievement.key));\n\n      // Check each achievement\n      for (const achievement of this.achievements) {\n        // Skip if already unlocked\n        if (unlockedKeys.has(achievement.key)) {\n          continue;\n        }\n\n        // Check if user qualifies for this achievement\n        try {\n          if (achievement.check(userStats)) {\n            await this.unlockAchievement(userId, achievement, testResult.id);\n            newlyUnlocked.push(achievement);\n          }\n        } catch (unlockError) {\n          errors.push({ achievement: achievement.key, error: unlockError });\n          console.error(`[Achievements] Failed to unlock ${achievement.key} for user ${userId}:`, unlockError);\n        }\n      }\n\n      // Log summary of any errors that occurred during unlock attempts\n      if (errors.length > 0) {\n        console.error(`[Achievements] ${errors.length} unlock error(s) for user ${userId}:`, \n          errors.map(e => e.achievement).join(', '));\n      }\n    } catch (error) {\n      console.error(`[Achievements] Critical error checking achievements for user ${userId}, testResult ${testResult.id}:`, error);\n    }\n    \n    return newlyUnlocked;\n  }\n\n  /**\n   * Calculate extended stats for secret achievements\n   */\n  private async calculateExtendedStats(\n    userId: string,\n    testResult: TestResult\n  ): Promise<{\n    testHour: number;\n    consecutivePerfectAccuracy: number;\n    testsCompletedToday: number;\n    best100WpmInFirst10Tests: boolean;\n  }> {\n    try {\n      // Get user's timezone for accurate time-based achievements\n      const user = await this.storage.getUser(userId);\n      const userTimezone = user?.timezone || 'UTC';\n      \n      // Get hour from test result's createdAt in user's timezone\n      const testDate = testResult.createdAt ? new Date(testResult.createdAt) : new Date();\n      const hourFormatter = new Intl.DateTimeFormat('en-US', { \n        timeZone: userTimezone, \n        hour: 'numeric', \n        hour12: false \n      });\n      const testHour = parseInt(hourFormatter.format(testDate), 10);\n\n      // Get user's recent test results to calculate extended stats\n      const recentTests = await this.storage.getUserTestResults(userId, 100);\n      \n      // Calculate consecutive perfect accuracy\n      let consecutivePerfectAccuracy = 0;\n      for (const test of recentTests) {\n        if (test.accuracy === 100) {\n          consecutivePerfectAccuracy++;\n        } else {\n          break;\n        }\n      }\n\n      // Calculate tests completed today in user's timezone\n      const dateFormatter = new Intl.DateTimeFormat('en-US', {\n        timeZone: userTimezone,\n        year: 'numeric',\n        month: '2-digit',\n        day: '2-digit',\n      });\n      const todayStr = dateFormatter.format(new Date());\n      const testsCompletedToday = recentTests.filter(test => {\n        const testDay = test.createdAt ? new Date(test.createdAt) : null;\n        if (!testDay) return false;\n        const testDayStr = dateFormatter.format(testDay);\n        return testDayStr === todayStr;\n      }).length;\n\n      // Check if achieved 100+ WPM in first 10 tests\n      const userStats = await this.storage.getUserStats(userId);\n      const totalTests = userStats?.totalTests ?? 0;\n      let best100WpmInFirst10Tests = false;\n      \n      if (totalTests <= 10) {\n        // Still in first 10 tests, check if any test hit 100+ WPM\n        const first10Tests = recentTests.slice(0, 10);\n        best100WpmInFirst10Tests = first10Tests.some(test => test.wpm >= 100);\n      }\n\n      return {\n        testHour,\n        consecutivePerfectAccuracy,\n        testsCompletedToday,\n        best100WpmInFirst10Tests,\n      };\n    } catch (error) {\n      console.error(`[Achievements] Failed to calculate extended stats for user ${userId}, testResult ${testResult.id}:`, error);\n      return {\n        testHour: -1,\n        consecutivePerfectAccuracy: 0,\n        testsCompletedToday: 0,\n        best100WpmInFirst10Tests: false,\n      };\n    }\n  }\n\n  /**\n   * Check for social sharing achievements\n   */\n  async checkSocialAchievements(userId: string, totalShares: number): Promise<void> {\n    const errors: Array<{ achievement: string; error: unknown }> = [];\n    \n    try {\n      const userStats: UserStats = {\n        totalTests: 0,\n        bestWpm: 0,\n        avgWpm: 0,\n        avgAccuracy: 0,\n        currentStreak: 0,\n        bestStreak: 0,\n        totalShares: totalShares,\n      };\n\n      // Get user's existing achievements\n      const userAchievements = await this.storage.getUserAchievements(userId);\n      const unlockedKeys = new Set(userAchievements.map(ua => ua.achievement.key));\n\n      // Check only social achievements\n      const socialAchievements = this.achievements.filter(a => a.key.startsWith('social_'));\n      \n      for (const achievement of socialAchievements) {\n        if (unlockedKeys.has(achievement.key)) {\n          continue;\n        }\n\n        try {\n          if (achievement.check(userStats)) {\n            await this.unlockAchievement(userId, achievement, 0);\n          }\n        } catch (unlockError) {\n          errors.push({ achievement: achievement.key, error: unlockError });\n          console.error(`[Achievements] Failed to unlock social achievement ${achievement.key} for user ${userId}:`, unlockError);\n        }\n      }\n\n      if (errors.length > 0) {\n        console.error(`[Achievements] ${errors.length} social unlock error(s) for user ${userId}:`, \n          errors.map(e => e.achievement).join(', '));\n      }\n    } catch (error) {\n      console.error(`[Achievements] Critical error checking social achievements for user ${userId}:`, error);\n    }\n  }\n\n  /**\n   * Unlock an achievement for a user\n   * @throws Error if the unlock fails - caller should handle this\n   */\n  private async unlockAchievement(\n    userId: string,\n    achievement: AchievementCheck,\n    testResultId: number\n  ): Promise<void> {\n    // Get achievement from database\n    const dbAchievement = await this.storage.getAchievementByKey(achievement.key);\n    if (!dbAchievement) {\n      throw new Error(`Achievement ${achievement.key} not found in database - ensure initializeAchievements() was called`);\n    }\n\n    // Unlock the achievement\n    await this.storage.unlockAchievement(userId, dbAchievement.id, testResultId);\n    console.log(`[Achievements] Unlocked ${achievement.name} for user ${userId}`);\n\n    // Update gamification profile\n    try {\n      let gamification = await this.storage.getUserGamification(userId);\n      if (!gamification) {\n        gamification = await this.storage.createUserGamification({\n          userId,\n          totalPoints: 0,\n          level: 1,\n          experiencePoints: 0,\n          totalAchievements: 0,\n          totalChallengesCompleted: 0,\n        });\n      }\n\n      // Add points and XP\n      const newPoints = gamification.totalPoints + achievement.points;\n      const newXP = gamification.experiencePoints + achievement.points;\n      const newAchievementCount = gamification.totalAchievements + 1;\n      \n      // Calculate level (100 XP per level)\n      const newLevel = Math.floor(newXP / 100) + 1;\n\n      await this.storage.updateUserGamification(userId, {\n        totalPoints: newPoints,\n        experiencePoints: newXP,\n        level: newLevel,\n        totalAchievements: newAchievementCount,\n      });\n    } catch (gamificationError) {\n      // Gamification update failure is non-critical - achievement was still unlocked\n      console.error(`[Achievements] Failed to update gamification for user ${userId} after unlocking ${achievement.key}:`, gamificationError);\n    }\n\n    // Send notification (non-critical)\n    try {\n      if (this.notificationScheduler) {\n        await this.notificationScheduler.notifyAchievementUnlock(userId, {\n          name: achievement.name,\n          description: achievement.description,\n          tier: achievement.tier,\n          points: achievement.points,\n          icon: achievement.icon,\n        });\n      }\n    } catch (notificationError) {\n      console.error(`[Achievements] Failed to send notification for ${achievement.key} to user ${userId}:`, notificationError);\n    }\n  }\n\n  /**\n   * Get achievements that are near completion (80%+ progress but not yet unlocked)\n   * Used for \"Almost There\" motivational notifications\n   * @param lastTestResult - Optional: include latest test result for fresh data\n   */\n  async getNearCompletionAchievements(\n    userId: string,\n    minProgress: number = 80,\n    lastTestResult?: TestResult\n  ): Promise<NearCompletionAchievement[]> {\n    const nearCompletion: NearCompletionAchievement[] = [];\n    \n    try {\n      const stats = await this.storage.getUserStats(userId);\n      const badgeData = await this.storage.getUserBadgeData(userId);\n      \n      if (!stats) return nearCompletion;\n\n      // Use the better of stored bestWpm or current test WPM for fresh progress calculation\n      const effectiveBestWpm = lastTestResult \n        ? Math.max(stats.bestWpm, lastTestResult.wpm) \n        : stats.bestWpm;\n\n      const userStats: UserStats = {\n        totalTests: stats.totalTests,\n        bestWpm: effectiveBestWpm,\n        avgWpm: stats.avgWpm,\n        avgAccuracy: stats.avgAccuracy,\n        currentStreak: badgeData?.currentStreak || 0,\n        bestStreak: badgeData?.bestStreak || 0,\n        lastTestResult,\n      };\n\n      const userAchievements = await this.storage.getUserAchievements(userId);\n      const unlockedKeys = new Set(userAchievements.map(ua => ua.achievement.key));\n\n      for (const achievement of this.achievements) {\n        if (unlockedKeys.has(achievement.key)) {\n          continue;\n        }\n\n        if (!achievement.getProgress) {\n          continue;\n        }\n\n        const progress = achievement.getProgress(userStats);\n        \n        if (progress >= minProgress && progress < 100) {\n          let currentValue = 0;\n          const targetValue = achievement.target || 0;\n          \n          if (achievement.category === 'speed') {\n            currentValue = userStats.bestWpm;\n          } else if (achievement.category === 'accuracy') {\n            currentValue = Math.round(userStats.avgAccuracy);\n          } else if (achievement.category === 'streak') {\n            currentValue = userStats.currentStreak;\n          } else if (achievement.category === 'consistency') {\n            currentValue = userStats.totalTests;\n          } else if (achievement.key.startsWith('social_')) {\n            currentValue = userStats.totalShares || 0;\n          } else if (achievement.key === 'special_speed_accuracy' && lastTestResult) {\n            // For combo achievements, show progress as percentage\n            currentValue = Math.round(progress);\n          }\n\n          nearCompletion.push({\n            key: achievement.key,\n            name: achievement.name,\n            description: achievement.description,\n            category: achievement.category,\n            tier: achievement.tier,\n            points: achievement.points,\n            icon: achievement.icon,\n            color: achievement.color,\n            progress: Math.round(progress),\n            currentValue: Math.max(0, Math.round(currentValue)),\n            targetValue,\n          });\n        }\n      }\n\n      nearCompletion.sort((a, b) => b.progress - a.progress);\n\n    } catch (error) {\n      console.error('[Achievements] Near completion check error:', error);\n    }\n    \n    return nearCompletion;\n  }\n\n  /**\n   * Get the closest achievement to unlock for guidance\n   */\n  async getNextAchievementToUnlock(userId: string): Promise<NearCompletionAchievement | null> {\n    try {\n      const stats = await this.storage.getUserStats(userId);\n      const badgeData = await this.storage.getUserBadgeData(userId);\n      \n      if (!stats) return null;\n\n      const userStats: UserStats = {\n        totalTests: stats.totalTests,\n        bestWpm: stats.bestWpm,\n        avgWpm: stats.avgWpm,\n        avgAccuracy: stats.avgAccuracy,\n        currentStreak: badgeData?.currentStreak || 0,\n        bestStreak: badgeData?.bestStreak || 0,\n      };\n\n      const userAchievements = await this.storage.getUserAchievements(userId);\n      const unlockedKeys = new Set(userAchievements.map(ua => ua.achievement.key));\n\n      let closest: { achievement: AchievementCheck; progress: number; currentValue: number } | null = null;\n\n      for (const achievement of this.achievements) {\n        if (unlockedKeys.has(achievement.key)) {\n          continue;\n        }\n\n        if (!achievement.getProgress) {\n          continue;\n        }\n\n        const progress = achievement.getProgress(userStats);\n        \n        if (progress < 100 && (!closest || progress > closest.progress)) {\n          let currentValue = 0;\n          \n          if (achievement.category === 'speed') {\n            currentValue = userStats.bestWpm;\n          } else if (achievement.category === 'accuracy') {\n            currentValue = userStats.avgAccuracy;\n          } else if (achievement.category === 'streak') {\n            currentValue = userStats.currentStreak;\n          } else if (achievement.category === 'consistency') {\n            currentValue = userStats.totalTests;\n          }\n\n          closest = { achievement, progress, currentValue };\n        }\n      }\n\n      if (!closest) return null;\n\n      return {\n        key: closest.achievement.key,\n        name: closest.achievement.name,\n        description: closest.achievement.description,\n        category: closest.achievement.category,\n        tier: closest.achievement.tier,\n        points: closest.achievement.points,\n        icon: closest.achievement.icon,\n        color: closest.achievement.color,\n        progress: Math.round(closest.progress),\n        currentValue: Math.round(closest.currentValue),\n        targetValue: closest.achievement.target || 0,\n      };\n    } catch (error) {\n      console.error('[Achievements] Next achievement error:', error);\n      return null;\n    }\n  }\n}\n","path":null,"size_bytes":22746,"size_tokens":null},"server/notification-routes.ts":{"content":"import { Router } from 'express';\nimport type { IStorage } from './storage';\nimport { NotificationService } from './notification-service';\nimport { insertPushSubscriptionSchema, insertNotificationPreferencesSchema, updateNotificationPreferencesSchema } from '@shared/schema';\n\nexport function createNotificationRoutes(storage: IStorage) {\n  const router = Router();\n  const notificationService = new NotificationService(storage);\n\n  // Get VAPID public key for subscription\n  router.get('/api/notifications/vapid-public-key', (req, res) => {\n    const publicKey = notificationService.getPublicKey();\n    res.json({ publicKey });\n  });\n\n  // Subscribe to push notifications\n  router.post('/api/notifications/subscribe', async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ error: 'Not authenticated' });\n    }\n\n    try {\n      const validated = insertPushSubscriptionSchema.parse({\n        ...req.body,\n        userId: req.user.id,\n        isActive: true,\n      });\n\n      // Check if subscription already exists\n      const existing = await storage.findExistingSubscription(\n        req.user.id,\n        validated.endpoint\n      );\n\n      let subscription;\n      if (existing) {\n        // Update existing subscription\n        subscription = existing;\n      } else {\n        // Create new subscription\n        subscription = await storage.createPushSubscription(validated);\n      }\n\n      res.json({ success: true, subscription });\n    } catch (error: any) {\n      console.error('[Notifications] Subscribe error:', error);\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Unsubscribe from push notifications\n  router.post('/api/notifications/unsubscribe', async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ error: 'Not authenticated' });\n    }\n\n    try {\n      const { endpoint } = req.body;\n      const subscription = await storage.findExistingSubscription(req.user.id, endpoint);\n      \n      if (subscription) {\n        await storage.deletePushSubscription(subscription.id);\n      }\n\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error('[Notifications] Unsubscribe error:', error);\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Get user's notification preferences\n  router.get('/api/notifications/preferences', async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ error: 'Not authenticated' });\n    }\n\n    try {\n      let prefs = await storage.getNotificationPreferences(req.user.id);\n      \n      // Create default preferences if none exist\n      if (!prefs) {\n        prefs = await storage.createNotificationPreferences({\n          userId: req.user.id,\n        });\n      }\n\n      res.json(prefs);\n    } catch (error: any) {\n      console.error('[Notifications] Get preferences error:', error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Update notification preferences\n  router.put('/api/notifications/preferences', async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ error: 'Not authenticated' });\n    }\n\n    try {\n      // Validate request body with Zod schema\n      const validatedPrefs = updateNotificationPreferencesSchema.parse(req.body);\n      \n      console.log('[Notifications] Received preferences update:', JSON.stringify(validatedPrefs, null, 2));\n      const prefs = await storage.updateNotificationPreferences(\n        req.user.id,\n        validatedPrefs\n      );\n      console.log('[Notifications] Saved preferences:', JSON.stringify(prefs, null, 2));\n\n      res.json(prefs);\n    } catch (error: any) {\n      console.error('[Notifications] Update preferences error:', error);\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  // Get notification history\n  router.get('/api/notifications/history', async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ error: 'Not authenticated' });\n    }\n\n    try {\n      const limit = parseInt(req.query.limit as string) || 50;\n      const history = await storage.getUserNotificationHistory(req.user.id, limit);\n      res.json(history);\n    } catch (error: any) {\n      console.error('[Notifications] Get history error:', error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Mark notification as clicked\n  router.post('/api/notifications/:id/clicked', async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ error: 'Not authenticated' });\n    }\n\n    try {\n      const notificationId = parseInt(req.params.id);\n      await storage.markNotificationClicked(notificationId);\n      res.json({ success: true });\n    } catch (error: any) {\n      console.error('[Notifications] Mark clicked error:', error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Send test notification\n  router.post('/api/notifications/test', async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ error: 'Not authenticated' });\n    }\n\n    try {\n      await notificationService.sendToUser({\n        userId: req.user.id,\n        type: 'test',\n        payload: {\n          title: 'ðŸ”” Test Notification',\n          body: 'This is a test notification from TypeMasterAI!',\n          icon: '/icon-192x192.png',\n          badge: '/icon-72x72.png',\n          data: { url: '/' },\n        },\n      });\n\n      res.json({ success: true, message: 'Test notification sent' });\n    } catch (error: any) {\n      console.error('[Notifications] Send test error:', error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Get user achievements\n  router.get('/api/achievements', async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ error: 'Not authenticated' });\n    }\n\n    try {\n      const userAchievements = await storage.getUserAchievements(req.user.id);\n      const allAchievements = await storage.getAllAchievements();\n      \n      res.json({\n        unlocked: userAchievements,\n        all: allAchievements,\n      });\n    } catch (error: any) {\n      console.error('[Achievements] Get error:', error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Get active challenges\n  router.get('/api/challenges/active', async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ error: 'Not authenticated' });\n    }\n\n    try {\n      const dailyChallenge = await storage.getActiveChallenge('daily');\n      const weeklyChallenge = await storage.getActiveChallenge('weekly');\n      \n      let dailyProgress = null;\n      let weeklyProgress = null;\n      \n      if (dailyChallenge) {\n        dailyProgress = await storage.getUserChallengeProgress(req.user.id, dailyChallenge.id);\n      }\n      \n      if (weeklyChallenge) {\n        weeklyProgress = await storage.getUserChallengeProgress(req.user.id, weeklyChallenge.id);\n      }\n\n      res.json({\n        daily: dailyChallenge ? { ...dailyChallenge, progress: dailyProgress } : null,\n        weekly: weeklyChallenge ? { ...weeklyChallenge, progress: weeklyProgress } : null,\n      });\n    } catch (error: any) {\n      console.error('[Challenges] Get active error:', error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Get user gamification profile\n  router.get('/api/gamification/profile', async (req, res) => {\n    if (!req.user) {\n      return res.status(401).json({ error: 'Not authenticated' });\n    }\n\n    try {\n      let profile = await storage.getUserGamification(req.user.id);\n      \n      // Create default profile if none exists\n      if (!profile) {\n        profile = await storage.createUserGamification({\n          userId: req.user.id,\n          totalPoints: 0,\n          level: 1,\n          experiencePoints: 0,\n          totalAchievements: 0,\n          totalChallengesCompleted: 0,\n        });\n      }\n\n      res.json(profile);\n    } catch (error: any) {\n      console.error('[Gamification] Get profile error:', error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  return router;\n}\n","path":null,"size_bytes":8049,"size_tokens":null},"server/notification-service.ts":{"content":"import webpush from 'web-push';\nimport type { \n  PushSubscription, \n  InsertNotificationHistory, \n  NotificationHistory \n} from '@shared/schema';\nimport type { IStorage } from './storage';\n\n// VAPID Configuration\nconst VAPID_PUBLIC_KEY = process.env.VAPID_PUBLIC_KEY;\nconst VAPID_PRIVATE_KEY = process.env.VAPID_PRIVATE_KEY;\nconst VAPID_SUBJECT = process.env.VAPID_SUBJECT || 'mailto:no-reply@typemasterai.com';\n\n// Log VAPID status (non-blocking - app runs fine without push notifications)\nif (!VAPID_PUBLIC_KEY || !VAPID_PRIVATE_KEY) {\n  console.log('[NotificationService] VAPID keys not configured - push notifications will be disabled');\n  console.log('[NotificationService] To enable push notifications, set VAPID_PUBLIC_KEY and VAPID_PRIVATE_KEY');\n}\n\n// Initialize web-push with VAPID keys\nconst VAPID_KEYS_AVAILABLE = !!(VAPID_PUBLIC_KEY && VAPID_PRIVATE_KEY);\nif (VAPID_KEYS_AVAILABLE) {\n  webpush.setVapidDetails(\n    VAPID_SUBJECT,\n    VAPID_PUBLIC_KEY,\n    VAPID_PRIVATE_KEY\n  );\n  console.log('âœ“ Push notification service initialized with VAPID keys');\n}\n\nexport interface NotificationPayload {\n  title: string;\n  body: string;\n  icon?: string;\n  badge?: string;\n  image?: string;\n  data?: Record<string, any>;\n  actions?: Array<{ action: string; title: string; icon?: string }>;\n  tag?: string;\n  requireInteraction?: boolean;\n}\n\nexport interface SendNotificationOptions {\n  userId: string;\n  type: string;\n  payload: NotificationPayload;\n  ttl?: number; // Time to live in seconds\n  urgency?: 'very-low' | 'low' | 'normal' | 'high';\n}\n\nexport class NotificationService {\n  constructor(private storage: IStorage) {}\n\n  /**\n   * Send push notification to a specific user\n   */\n  async sendToUser(options: SendNotificationOptions): Promise<{ sent: number; failed: number }> {\n    const { userId, type, payload, ttl = 86400, urgency = 'normal' } = options;\n\n    // Check if VAPID keys are configured\n    if (!VAPID_KEYS_AVAILABLE) {\n      console.warn('[NotificationService] Skipping notification - VAPID keys not configured');\n      return { sent: 0, failed: 0 };\n    }\n\n    // Get user's active push subscriptions\n    const subscriptions = await this.storage.getUserPushSubscriptions(userId);\n    \n    if (subscriptions.length === 0) {\n      console.log(`[Notifications] No subscriptions found for user ${userId}`);\n      return { sent: 0, failed: 0 };\n    }\n\n    let sent = 0;\n    let failed = 0;\n\n    // Send to all user's devices\n    for (const subscription of subscriptions) {\n      try {\n        const keys = subscription.keys as any;\n        const pushSubscription = {\n          endpoint: subscription.endpoint,\n          keys: {\n            p256dh: keys.p256dh,\n            auth: keys.auth,\n          },\n        };\n\n        await webpush.sendNotification(\n          pushSubscription,\n          JSON.stringify(payload),\n          {\n            TTL: ttl,\n            urgency,\n          }\n        );\n\n        // Record success in notification history\n        await this.storage.createNotificationHistory({\n          userId,\n          type,\n          title: payload.title,\n          body: payload.body,\n          data: payload.data as any,\n          status: 'sent',\n          sentAt: new Date(),\n        });\n\n        sent++;\n      } catch (error: any) {\n        console.error(`[Notifications] Failed to send to subscription ${subscription.id}:`, error);\n        \n        // If subscription expired or invalid, remove it\n        if (error.statusCode === 410 || error.statusCode === 404) {\n          await this.storage.deletePushSubscription(subscription.id);\n          console.log(`[Notifications] Removed invalid subscription ${subscription.id}`);\n        }\n\n        // Record failure\n        await this.storage.createNotificationHistory({\n          userId,\n          type,\n          title: payload.title,\n          body: payload.body,\n          data: payload.data as any,\n          status: 'failed',\n          errorMessage: error.message,\n          sentAt: new Date(),\n        });\n\n        failed++;\n      }\n    }\n\n    console.log(`[Notifications] Sent to user ${userId}: ${sent} succeeded, ${failed} failed`);\n    return { sent, failed };\n  }\n\n  /**\n   * Send push notification to multiple users\n   */\n  async sendToUsers(userIds: string[], type: string, payload: NotificationPayload): Promise<void> {\n    const promises = userIds.map(userId =>\n      this.sendToUser({ userId, type, payload })\n    );\n\n    await Promise.allSettled(promises);\n  }\n\n  /**\n   * Send daily practice reminder\n   */\n  async sendDailyReminder(userId: string, stats: { streak: number; avgWpm: number }): Promise<void> {\n    const { streak, avgWpm } = stats;\n\n    const messages = [\n      `Keep your ${streak}-day streak alive! Time for your daily practice. ðŸ”¥`,\n      `Your typing skills are calling! Current streak: ${streak} days. Let's go! ðŸ’ª`,\n      `Practice makes perfect! You're averaging ${avgWpm} WPM. Ready to improve? âŒ¨ï¸`,\n      `${streak} days strong! Don't break your streak - practice now! ðŸŽ¯`,\n    ];\n\n    const payload: NotificationPayload = {\n      title: 'Daily Practice Reminder',\n      body: messages[Math.floor(Math.random() * messages.length)],\n      icon: '/icon-192x192.png',\n      badge: '/icon-72x72.png',\n      data: {\n        url: '/practice',\n        type: 'daily_reminder',\n        streak,\n      },\n      tag: 'daily-reminder',\n      actions: [\n        { action: 'practice', title: 'Start Practicing' },\n        { action: 'dismiss', title: 'Maybe Later' },\n      ],\n    };\n\n    await this.sendToUser({ userId, type: 'daily_reminder', payload });\n  }\n\n  /**\n   * Send streak warning (streak about to break)\n   */\n  async sendStreakWarning(userId: string, streak: number, hoursLeft: number): Promise<void> {\n    const payload: NotificationPayload = {\n      title: `âš ï¸ Streak Alert: ${streak} Days at Risk!`,\n      body: `Only ${hoursLeft} hours left to keep your ${streak}-day streak! Practice now!`,\n      icon: '/icon-192x192.png',\n      badge: '/icon-72x72.png',\n      data: {\n        url: '/practice',\n        type: 'streak_warning',\n        streak,\n        hoursLeft,\n      },\n      tag: 'streak-warning',\n      requireInteraction: true,\n      actions: [\n        { action: 'practice', title: 'Save My Streak!' },\n        { action: 'snooze', title: 'Remind Me in 1 Hour' },\n      ],\n    };\n\n    await this.sendToUser({ \n      userId, \n      type: 'streak_warning', \n      payload,\n      urgency: 'high',\n    });\n  }\n\n  /**\n   * Send weekly summary\n   */\n  async sendWeeklySummary(\n    userId: string, \n    summary: {\n      testsCompleted: number;\n      avgWpm: number;\n      avgAccuracy: number;\n      improvement: number;\n      rank: number;\n    }\n  ): Promise<void> {\n    const { testsCompleted, avgWpm, avgAccuracy, improvement, rank } = summary;\n\n    const improvementText = improvement > 0 \n      ? `+${improvement.toFixed(1)} WPM improvement! ðŸ“ˆ`\n      : improvement < 0\n      ? `${improvement.toFixed(1)} WPM this week ðŸ“Š`\n      : 'Steady progress! ðŸ“Š';\n\n    const payload: NotificationPayload = {\n      title: 'ðŸ“Š Your Weekly Typing Report',\n      body: `${testsCompleted} tests completed | ${avgWpm} WPM avg | ${avgAccuracy.toFixed(1)}% accuracy | ${improvementText}`,\n      icon: '/icon-192x192.png',\n      badge: '/icon-72x72.png',\n      image: '/weekly-summary-chart.png', // Could be dynamically generated\n      data: {\n        url: '/analytics',\n        type: 'weekly_summary',\n        summary,\n      },\n      tag: 'weekly-summary',\n      actions: [\n        { action: 'view', title: 'View Full Report' },\n        { action: 'share', title: 'Share Progress' },\n      ],\n    };\n\n    await this.sendToUser({ userId, type: 'weekly_summary', payload });\n  }\n\n  /**\n   * Send achievement unlock notification\n   */\n  async sendAchievementUnlock(\n    userId: string,\n    achievement: {\n      name: string;\n      description: string;\n      tier: string;\n      points: number;\n      icon: string;\n    }\n  ): Promise<void> {\n    const tierEmojis: Record<string, string> = {\n      bronze: 'ðŸ¥‰',\n      silver: 'ðŸ¥ˆ',\n      gold: 'ðŸ¥‡',\n      platinum: 'ðŸ’Ž',\n      diamond: 'ðŸ‘‘',\n    };\n\n    const emoji = tierEmojis[achievement.tier] || 'ðŸ†';\n\n    const payload: NotificationPayload = {\n      title: `${emoji} Achievement Unlocked!`,\n      body: `${achievement.name}: ${achievement.description} (+${achievement.points} points)`,\n      icon: '/icon-192x192.png',\n      badge: '/icon-72x72.png',\n      data: {\n        url: '/profile?tab=achievements',\n        type: 'achievement_unlock',\n        achievement,\n      },\n      tag: `achievement-${achievement.name}`,\n      requireInteraction: true,\n      actions: [\n        { action: 'view', title: 'View Achievement' },\n        { action: 'share', title: 'Share' },\n      ],\n    };\n\n    await this.sendToUser({ \n      userId, \n      type: 'achievement_unlock', \n      payload,\n      urgency: 'high',\n    });\n  }\n\n  /**\n   * Send challenge notification\n   */\n  async sendChallengeNotification(\n    userId: string,\n    challenge: {\n      title: string;\n      description: string;\n      type: 'started' | 'progress' | 'completed';\n      progress?: number;\n      target?: number;\n      reward?: number;\n    }\n  ): Promise<void> {\n    const { title, description, type, progress, target, reward } = challenge;\n\n    let notificationTitle = '';\n    let notificationBody = '';\n\n    if (type === 'started') {\n      notificationTitle = `ðŸŽ¯ New Challenge: ${title}`;\n      notificationBody = description;\n    } else if (type === 'progress') {\n      notificationTitle = `ðŸ“Š Challenge Progress: ${title}`;\n      notificationBody = `${progress}/${target} - Keep going! You're ${Math.round((progress! / target!) * 100)}% there!`;\n    } else {\n      notificationTitle = `ðŸŽ‰ Challenge Complete: ${title}`;\n      notificationBody = `Congratulations! You earned ${reward} points!`;\n    }\n\n    const payload: NotificationPayload = {\n      title: notificationTitle,\n      body: notificationBody,\n      icon: '/icon-192x192.png',\n      badge: '/icon-72x72.png',\n      data: {\n        url: '/challenges',\n        type: `challenge_${type}`,\n        challenge,\n      },\n      tag: `challenge-${title}`,\n      actions: [\n        { action: 'view', title: 'View Challenge' },\n      ],\n    };\n\n    await this.sendToUser({ \n      userId, \n      type: `challenge_${type}`, \n      payload,\n      urgency: type === 'completed' ? 'high' : 'normal',\n    });\n  }\n\n  /**\n   * Send leaderboard update notification\n   */\n  async sendLeaderboardUpdate(\n    userId: string,\n    update: {\n      category: string;\n      oldRank: number;\n      newRank: number;\n      totalUsers: number;\n    }\n  ): Promise<void> {\n    const { category, oldRank, newRank, totalUsers } = update;\n\n    const isImprovement = newRank < oldRank;\n    const rankDiff = Math.abs(newRank - oldRank);\n\n    const payload: NotificationPayload = {\n      title: isImprovement \n        ? `ðŸš€ You Moved Up the Leaderboard!`\n        : `ðŸ“Š Leaderboard Update`,\n      body: isImprovement\n        ? `You climbed ${rankDiff} spots in ${category}! Now #${newRank} of ${totalUsers}`\n        : `Your rank in ${category}: #${newRank} of ${totalUsers}`,\n      icon: '/icon-192x192.png',\n      badge: '/icon-72x72.png',\n      data: {\n        url: '/leaderboard',\n        type: 'leaderboard_update',\n        update,\n      },\n      tag: 'leaderboard-update',\n      actions: [\n        { action: 'view', title: 'View Leaderboard' },\n      ],\n    };\n\n    await this.sendToUser({ userId, type: 'leaderboard_update', payload });\n  }\n\n  /**\n   * Send race invite notification\n   */\n  async sendRaceInvite(\n    userId: string,\n    invite: {\n      inviterName: string;\n      roomCode: string;\n      mode: string;\n    }\n  ): Promise<void> {\n    const { inviterName, roomCode, mode } = invite;\n\n    const payload: NotificationPayload = {\n      title: `ðŸ Race Invitation!`,\n      body: `${inviterName} invited you to a ${mode} typing race. Room: ${roomCode}`,\n      icon: '/icon-192x192.png',\n      badge: '/icon-72x72.png',\n      data: {\n        url: `/race/${roomCode}`,\n        type: 'race_invite',\n        invite,\n      },\n      tag: `race-invite-${roomCode}`,\n      requireInteraction: true,\n      actions: [\n        { action: 'join', title: 'Join Race' },\n        { action: 'decline', title: 'Decline' },\n      ],\n    };\n\n    await this.sendToUser({ \n      userId, \n      type: 'race_invite', \n      payload,\n      urgency: 'high',\n      ttl: 3600, // 1 hour TTL for race invites\n    });\n  }\n\n  /**\n   * Check if user should receive a notification based on preferences\n   */\n  async shouldSendNotification(userId: string, notificationType: string): Promise<boolean> {\n    const prefs = await this.storage.getNotificationPreferences(userId);\n    \n    if (!prefs) {\n      return false;\n    }\n\n    // Check specific notification type preferences\n    const typeMapping: Record<string, keyof typeof prefs> = {\n      'daily_reminder': 'dailyReminder',\n      'streak_warning': 'streakWarning',\n      'weekly_summary': 'weeklySummary',\n      'achievement_unlock': 'achievementUnlocked',\n      'challenge_started': 'challengeInvite',\n      'challenge_progress': 'challengeInvite',\n      'challenge_completed': 'challengeComplete',\n      'leaderboard_update': 'leaderboardChange',\n      'race_invite': 'raceInvite',\n    };\n\n    const prefKey = typeMapping[notificationType];\n    if (prefKey && typeof prefs[prefKey] === 'boolean') {\n      return prefs[prefKey] as boolean;\n    }\n\n    return true; // Default to true for unknown types\n  }\n\n  /**\n   * Get VAPID public key for client subscription\n   */\n  getPublicKey(): string {\n    return VAPID_PUBLIC_KEY || '';\n  }\n\n  /**\n   * Generate VAPID keys (for initial setup)\n   */\n  static generateVapidKeys() {\n    return webpush.generateVAPIDKeys();\n  }\n}\n","path":null,"size_bytes":13812,"size_tokens":null},"server/notification-scheduler.ts":{"content":"import { DateTime } from 'luxon';\nimport type { IStorage } from './storage';\nimport { NotificationService } from './notification-service';\nimport { NotificationJobGenerator } from './notification-job-generator';\nimport type { NotificationJob } from '@shared/schema';\n\nexport class NotificationScheduler {\n  private storage: IStorage;\n  private notificationService: NotificationService;\n  private jobGenerator: NotificationJobGenerator;\n  private intervals: NodeJS.Timeout[] = [];\n  private isProcessing = false;\n\n  constructor(storage: IStorage) {\n    this.storage = storage;\n    this.notificationService = new NotificationService(storage);\n    this.jobGenerator = new NotificationJobGenerator(storage);\n  }\n\n  /**\n   * Start all scheduled notification tasks\n   */\n  async start() {\n    console.log('[Scheduler] Starting notification scheduler...');\n\n    await this.initialJobGeneration();\n\n    const tickInterval = setInterval(() => {\n      this.processDueJobs().catch(console.error);\n    }, 60 * 1000);\n    this.intervals.push(tickInterval);\n\n    const regenerationInterval = setInterval(() => {\n      this.regenerateJobs().catch(console.error);\n    }, 24 * 60 * 60 * 1000);\n    this.intervals.push(regenerationInterval);\n\n    const cleanupInterval = setInterval(() => {\n      this.jobGenerator.cleanupOldJobs().catch(console.error);\n    }, 6 * 60 * 60 * 1000);\n    this.intervals.push(cleanupInterval);\n\n    setTimeout(() => {\n      this.processDueJobs().catch(console.error);\n    }, 5000);\n\n    console.log('[Scheduler] Notification scheduler started with minute-precision');\n  }\n\n  /**\n   * Stop all scheduled tasks\n   */\n  stop() {\n    console.log('[Scheduler] Stopping notification scheduler...');\n    this.intervals.forEach(interval => clearInterval(interval));\n    this.intervals = [];\n  }\n\n  /**\n   * Initial job generation on startup\n   */\n  private async initialJobGeneration() {\n    try {\n      console.log('[Scheduler] Running initial job generation...');\n      await this.jobGenerator.regenerateAllJobs();\n    } catch (error) {\n      console.error('[Scheduler] Initial job generation failed:', error);\n    }\n  }\n\n  /**\n   * Process due notification jobs\n   */\n  private async processDueJobs() {\n    if (this.isProcessing) {\n      return;\n    }\n\n    this.isProcessing = true;\n\n    try {\n      const now = DateTime.utc().toJSDate();\n      const batchSize = 100;\n\n      const dueJobs = await this.storage.claimDueNotificationJobs(now, batchSize);\n\n      if (dueJobs.length === 0) {\n        this.isProcessing = false;\n        return;\n      }\n\n      console.log(`[Scheduler] Processing ${dueJobs.length} due jobs`);\n\n      const results = await Promise.allSettled(\n        dueJobs.map(job => this.processJob(job))\n      );\n\n      const succeeded = results.filter(r => r.status === 'fulfilled').length;\n      const failed = results.filter(r => r.status === 'rejected').length;\n\n      console.log(`[Scheduler] Job batch completed: ${succeeded} succeeded, ${failed} failed`);\n    } catch (error) {\n      console.error('[Scheduler] Error processing due jobs:', error);\n    } finally {\n      this.isProcessing = false;\n    }\n  }\n\n  /**\n   * Process a single notification job\n   */\n  private async processJob(job: NotificationJob): Promise<void> {\n    try {\n      const meta = job.payloadMeta as Record<string, any> || {};\n\n      switch (job.notificationType) {\n        case 'daily_reminder': {\n          const avgWpm = await this.storage.getUserAverageWpm(job.userId);\n          await this.notificationService.sendDailyReminder(job.userId, {\n            streak: meta.streak || 0,\n            avgWpm: avgWpm || 0,\n          });\n          break;\n        }\n\n        case 'streak_warning': {\n          const user = await this.storage.getUser(job.userId);\n          if (!user) break;\n\n          const userTimezone = meta.timezone || 'UTC';\n          const nowUserZone = DateTime.now().setZone(userTimezone);\n\n          if (user.lastTestDate) {\n            const lastTestUserZone = DateTime.fromJSDate(user.lastTestDate).setZone(userTimezone);\n            if (lastTestUserZone.hasSame(nowUserZone, 'day')) {\n              break;\n            }\n          }\n\n          const endOfDay = nowUserZone.endOf('day');\n          const hoursLeft = Math.ceil(endOfDay.diff(nowUserZone, 'hours').hours);\n\n          await this.notificationService.sendStreakWarning(\n            job.userId,\n            user.currentStreak || 0,\n            hoursLeft\n          );\n          break;\n        }\n\n        case 'weekly_summary': {\n          const weeklyStats = await this.storage.getWeeklySummaryStats(job.userId);\n\n          if (weeklyStats.testsCompleted > 0) {\n            await this.notificationService.sendWeeklySummary(job.userId, {\n              testsCompleted: weeklyStats.testsCompleted,\n              avgWpm: weeklyStats.avgWpm,\n              avgAccuracy: weeklyStats.avgAccuracy,\n              improvement: weeklyStats.improvement,\n              rank: weeklyStats.rank,\n            });\n          }\n          break;\n        }\n\n        default:\n          throw new Error(`Unknown notification type: ${job.notificationType}`);\n      }\n\n      await this.storage.markJobCompleted(job.id);\n\n      const nextJobTime = this.calculateNextJobTime(job);\n      if (nextJobTime) {\n        await this.storage.createNotificationJobs([{\n          userId: job.userId,\n          notificationType: job.notificationType,\n          sendAtUtc: nextJobTime,\n          status: 'pending',\n          attemptCount: 0,\n          payloadMeta: job.payloadMeta,\n        }]);\n      }\n    } catch (error) {\n      console.error(`[Scheduler] Failed to process job ${job.id}:`, error);\n\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n\n      if (job.attemptCount < 3) {\n        const retryDelay = Math.pow(2, job.attemptCount) * 5;\n        const retryTime = DateTime.utc().plus({ minutes: retryDelay }).toJSDate();\n        await this.storage.rescheduleJob(job.id, retryTime);\n      } else {\n        await this.storage.markJobFailed(job.id, errorMessage);\n      }\n\n      throw error;\n    }\n  }\n\n  /**\n   * Calculate next job time for recurring notifications\n   */\n  private calculateNextJobTime(job: NotificationJob): Date | null {\n    const meta = job.payloadMeta as Record<string, any> || {};\n    const userTimezone = meta.timezone || 'UTC';\n\n    switch (job.notificationType) {\n      case 'daily_reminder': {\n        const currentSendTime = DateTime.fromJSDate(job.sendAtUtc).setZone(userTimezone);\n        return currentSendTime.plus({ days: 1 }).toUTC().toJSDate();\n      }\n\n      case 'streak_warning': {\n        const currentSendTime = DateTime.fromJSDate(job.sendAtUtc).setZone(userTimezone);\n        return currentSendTime.plus({ days: 1 }).toUTC().toJSDate();\n      }\n\n      case 'weekly_summary': {\n        const currentSendTime = DateTime.fromJSDate(job.sendAtUtc).setZone(userTimezone);\n        return currentSendTime.plus({ weeks: 1 }).toUTC().toJSDate();\n      }\n\n      default:\n        return null;\n    }\n  }\n\n  /**\n   * Regenerate all notification jobs (run daily)\n   */\n  private async regenerateJobs() {\n    try {\n      console.log('[Scheduler] Running daily job regeneration...');\n      await this.jobGenerator.regenerateAllJobs();\n    } catch (error) {\n      console.error('[Scheduler] Job regeneration failed:', error);\n    }\n  }\n\n  /**\n   * Legacy methods for backward compatibility (kept for achievements, challenges, etc.)\n   */\n\n  /**\n   * Send achievement unlock notification\n   */\n  async notifyAchievementUnlock(\n    userId: string,\n    achievement: {\n      name: string;\n      description: string;\n      tier: string;\n      points: number;\n      icon: string;\n    }\n  ): Promise<void> {\n    const shouldSend = await this.notificationService.shouldSendNotification(\n      userId,\n      'achievement_unlock'\n    );\n\n    if (shouldSend) {\n      await this.notificationService.sendAchievementUnlock(userId, achievement);\n    }\n  }\n\n  /**\n   * Send challenge notification\n   */\n  async notifyChallengeUpdate(\n    userId: string,\n    challenge: {\n      title: string;\n      description: string;\n      type: 'started' | 'progress' | 'completed';\n      progress?: number;\n      target?: number;\n      reward?: number;\n    }\n  ): Promise<void> {\n    const notificationType = `challenge_${challenge.type}`;\n    const shouldSend = await this.notificationService.shouldSendNotification(\n      userId,\n      notificationType\n    );\n\n    if (shouldSend) {\n      await this.notificationService.sendChallengeNotification(userId, challenge);\n    }\n  }\n\n  /**\n   * Send leaderboard update notification\n   */\n  async notifyLeaderboardUpdate(\n    userId: string,\n    update: {\n      category: string;\n      oldRank: number;\n      newRank: number;\n      totalUsers: number;\n    }\n  ): Promise<void> {\n    if (update.newRank >= update.oldRank) {\n      return;\n    }\n\n    const shouldSend = await this.notificationService.shouldSendNotification(\n      userId,\n      'leaderboard_update'\n    );\n\n    if (shouldSend) {\n      await this.notificationService.sendLeaderboardUpdate(userId, update);\n    }\n  }\n\n  /**\n   * Send race invite notification\n   */\n  async notifyRaceInvite(\n    userId: string,\n    invite: {\n      inviterName: string;\n      roomCode: string;\n      mode: string;\n    }\n  ): Promise<void> {\n    const shouldSend = await this.notificationService.shouldSendNotification(\n      userId,\n      'race_invite'\n    );\n\n    if (shouldSend) {\n      await this.notificationService.sendRaceInvite(userId, invite);\n    }\n  }\n}\n","path":null,"size_bytes":9527,"size_tokens":null},"client/src/pages/NotificationSettings.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Switch } from '@/components/ui/switch';\nimport { Label } from '@/components/ui/label';\nimport { Input } from '@/components/ui/input';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Separator } from '@/components/ui/separator';\nimport { Bell, BellOff, Loader2, CheckCircle2, XCircle, Clock, Globe } from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\nimport { notificationManager } from '@/lib/notification-manager';\n\nconst TIMEZONES = [\n  { value: 'UTC', label: 'UTC (Coordinated Universal Time)' },\n  { value: 'America/New_York', label: 'Eastern Time (US & Canada)' },\n  { value: 'America/Chicago', label: 'Central Time (US & Canada)' },\n  { value: 'America/Denver', label: 'Mountain Time (US & Canada)' },\n  { value: 'America/Los_Angeles', label: 'Pacific Time (US & Canada)' },\n  { value: 'Europe/London', label: 'London (GMT/BST)' },\n  { value: 'Europe/Paris', label: 'Central European Time' },\n  { value: 'Asia/Tokyo', label: 'Tokyo (JST)' },\n  { value: 'Asia/Shanghai', label: 'China Standard Time' },\n  { value: 'Asia/Kolkata', label: 'India Standard Time' },\n  { value: 'Australia/Sydney', label: 'Australian Eastern Time' },\n];\n\ninterface NotificationPreferences {\n  id: number;\n  userId: string;\n  timezone: string | null;\n  dailyReminder: boolean;\n  dailyReminderTime: string | null;\n  streakWarning: boolean;\n  streakMilestone: boolean;\n  weeklySummary: boolean;\n  weeklySummaryDay: string | null;\n  achievementUnlocked: boolean;\n  challengeInvite: boolean;\n  challengeComplete: boolean;\n  leaderboardChange: boolean;\n  newPersonalRecord: boolean;\n  raceInvite: boolean;\n  raceStarting: boolean;\n  socialUpdates: boolean;\n  tipOfTheDay: boolean;\n  quietHoursStart: string | null;\n  quietHoursEnd: string | null;\n}\n\nexport default function NotificationSettings() {\n  const [loading, setLoading] = useState(true);\n  const [saving, setSaving] = useState(false);\n  const [subscribed, setSubscribed] = useState(false);\n  const [permission, setPermission] = useState<NotificationPermission>('default');\n  const [preferences, setPreferences] = useState<NotificationPreferences | null>(null);\n  const { toast } = useToast();\n\n  useEffect(() => {\n    checkPermissionStatus();\n    loadPreferences();\n  }, []);\n\n  const checkPermissionStatus = async () => {\n    const permission = await notificationManager.getPermissionStatus();\n    setSubscribed(permission === 'granted');\n    setPermission(permission);\n  };\n\n  const loadPreferences = async () => {\n    try {\n      const response = await fetch('/api/notifications/preferences');\n      if (response.ok) {\n        const prefs = await response.json();\n        setPreferences(prefs);\n      }\n    } catch (error) {\n      console.error('Failed to load preferences:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleEnableNotifications = async () => {\n    try {\n      const success = await notificationManager.requestPermission();\n      if (success) {\n        setSubscribed(true);\n        setPermission('granted');\n        toast({\n          title: \"Notifications Enabled!\",\n          description: \"You'll now receive push notifications\",\n        });\n      } else {\n        toast({\n          title: \"Permission Denied\",\n          description: \"Please enable notifications in your browser settings\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      console.error('Failed to enable notifications:', error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to enable notifications\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleDisableNotifications = async () => {\n    try {\n      await notificationManager.unsubscribe();\n      setSubscribed(false);\n      toast({\n        title: \"Notifications Disabled\",\n        description: \"You will no longer receive push notifications\",\n      });\n    } catch (error) {\n      console.error('Failed to disable notifications:', error);\n    }\n  };\n\n  const handleTestNotification = async () => {\n    try {\n      const response = await fetch('/api/notifications/test', {\n        method: 'POST',\n      });\n      \n      if (response.ok) {\n        toast({\n          title: \"Test Notification Sent!\",\n          description: \"Check your notifications\",\n        });\n      }\n    } catch (error) {\n      console.error('Failed to send test notification:', error);\n    }\n  };\n\n  const handleSavePreferences = async () => {\n    if (!preferences) return;\n\n    setSaving(true);\n    try {\n      const response = await fetch('/api/notifications/preferences', {\n        method: 'PUT',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(preferences),\n      });\n\n      if (response.ok) {\n        toast({\n          title: \"Preferences Saved\",\n          description: \"Your notification settings have been updated\",\n        });\n      }\n    } catch (error) {\n      console.error('Failed to save preferences:', error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to save preferences\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setSaving(false);\n    }\n  };\n\n  const updatePreference = (key: keyof NotificationPreferences, value: boolean | string) => {\n    if (!preferences) return;\n    setPreferences({ ...preferences, [key]: value });\n  };\n\n  if (loading) {\n    return (\n      <div className=\"container mx-auto py-8 flex justify-center items-center min-h-screen\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto py-8 max-w-4xl\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-3xl font-bold mb-2\">Notification Settings</h1>\n        <p className=\"text-muted-foreground\">\n          Manage your notification preferences and push notification settings\n        </p>\n      </div>\n\n      {/* Push Notification Status */}\n      <Card className=\"mb-6\">\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            {subscribed ? <Bell className=\"h-5 w-5\" /> : <BellOff className=\"h-5 w-5\" />}\n            Push Notifications\n          </CardTitle>\n          <CardDescription>\n            Enable browser push notifications to stay updated\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-1\">\n              <p className=\"text-sm font-medium\">Status</p>\n              <p className=\"text-sm text-muted-foreground flex items-center gap-2\">\n                {subscribed ? (\n                  <>\n                    <CheckCircle2 className=\"h-4 w-4 text-green-500\" />\n                    Enabled\n                  </>\n                ) : (\n                  <>\n                    <XCircle className=\"h-4 w-4 text-gray-400\" />\n                    Disabled\n                  </>\n                )}\n              </p>\n            </div>\n            {!subscribed ? (\n              <Button onClick={handleEnableNotifications} data-testid=\"button-enable-notifications\">\n                Enable Notifications\n              </Button>\n            ) : (\n              <div className=\"flex gap-2\">\n                <Button variant=\"outline\" onClick={handleTestNotification} data-testid=\"button-test-notification\">\n                  Send Test\n                </Button>\n                <Button variant=\"destructive\" onClick={handleDisableNotifications} data-testid=\"button-disable-notifications\">\n                  Disable\n                </Button>\n              </div>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Notification Preferences */}\n      {preferences && (\n        <>\n          <Card className=\"mb-6\">\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Globe className=\"h-5 w-5\" />\n                Timezone & Schedule\n              </CardTitle>\n              <CardDescription>\n                Configure your timezone for accurate notification delivery\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"timezone\">\n                  Timezone\n                  <p className=\"text-sm text-muted-foreground\">Select your local timezone</p>\n                </Label>\n                <Select\n                  value={preferences.timezone || 'UTC'}\n                  onValueChange={(value) => updatePreference('timezone', value)}\n                >\n                  <SelectTrigger id=\"timezone\" data-testid=\"select-timezone\">\n                    <SelectValue placeholder=\"Select timezone\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {TIMEZONES.map((tz) => (\n                      <SelectItem key={tz.value} value={tz.value} data-testid={`option-timezone-${tz.value}`}>\n                        {tz.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <Separator />\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"dailyReminderTime\" className=\"flex items-center gap-2\">\n                  <Clock className=\"h-4 w-4\" />\n                  Daily Reminder Time\n                  <p className=\"text-sm text-muted-foreground\">Set your preferred reminder time</p>\n                </Label>\n                <Input\n                  id=\"dailyReminderTime\"\n                  type=\"time\"\n                  value={preferences.dailyReminderTime || '09:00'}\n                  onChange={(e) => updatePreference('dailyReminderTime', e.target.value)}\n                  data-testid=\"input-daily-reminder-time\"\n                  className=\"max-w-[200px]\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"mb-6\">\n            <CardHeader>\n              <CardTitle>Daily & Weekly Notifications</CardTitle>\n              <CardDescription>\n                Stay on track with regular reminders and summaries\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"dailyReminder\" className=\"flex-1\">\n                  Daily Practice Reminder\n                  <p className=\"text-sm text-muted-foreground\">Get reminded to practice every day</p>\n                </Label>\n                <Switch\n                  id=\"dailyReminder\"\n                  checked={preferences.dailyReminder}\n                  onCheckedChange={(checked) => updatePreference('dailyReminder', checked)}\n                  data-testid=\"switch-daily-reminder\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"streakWarning\" className=\"flex-1\">\n                  Streak Warning\n                  <p className=\"text-sm text-muted-foreground\">Get notified when your streak is at risk</p>\n                </Label>\n                <Switch\n                  id=\"streakWarning\"\n                  checked={preferences.streakWarning}\n                  onCheckedChange={(checked) => updatePreference('streakWarning', checked)}\n                  data-testid=\"switch-streak-warning\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"weeklySummary\" className=\"flex-1\">\n                  Weekly Summary\n                  <p className=\"text-sm text-muted-foreground\">Receive your weekly progress report</p>\n                </Label>\n                <Switch\n                  id=\"weeklySummary\"\n                  checked={preferences.weeklySummary}\n                  onCheckedChange={(checked) => updatePreference('weeklySummary', checked)}\n                  data-testid=\"switch-weekly-summary\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"mb-6\">\n            <CardHeader>\n              <CardTitle>Achievements & Challenges</CardTitle>\n              <CardDescription>\n                Get notified about your progress and accomplishments\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"achievementUnlocked\" className=\"flex-1\">\n                  Achievement Unlocked\n                  <p className=\"text-sm text-muted-foreground\">Celebrate when you unlock badges</p>\n                </Label>\n                <Switch\n                  id=\"achievementUnlocked\"\n                  checked={preferences.achievementUnlocked}\n                  onCheckedChange={(checked) => updatePreference('achievementUnlocked', checked)}\n                  data-testid=\"switch-achievement-unlocked\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"challengeInvite\" className=\"flex-1\">\n                  Challenge Invitations\n                  <p className=\"text-sm text-muted-foreground\">Get notified about new challenges</p>\n                </Label>\n                <Switch\n                  id=\"challengeInvite\"\n                  checked={preferences.challengeInvite}\n                  onCheckedChange={(checked) => updatePreference('challengeInvite', checked)}\n                  data-testid=\"switch-challenge-invite\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"challengeComplete\" className=\"flex-1\">\n                  Challenge Completed\n                  <p className=\"text-sm text-muted-foreground\">Celebrate when you complete challenges</p>\n                </Label>\n                <Switch\n                  id=\"challengeComplete\"\n                  checked={preferences.challengeComplete}\n                  onCheckedChange={(checked) => updatePreference('challengeComplete', checked)}\n                  data-testid=\"switch-challenge-complete\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"mb-6\">\n            <CardHeader>\n              <CardTitle>Social & Competition</CardTitle>\n              <CardDescription>\n                Stay updated on competitive features and social interactions\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"raceInvite\" className=\"flex-1\">\n                  Race Invitations\n                  <p className=\"text-sm text-muted-foreground\">Get notified when invited to typing races</p>\n                </Label>\n                <Switch\n                  id=\"raceInvite\"\n                  checked={preferences.raceInvite}\n                  onCheckedChange={(checked) => updatePreference('raceInvite', checked)}\n                  data-testid=\"switch-race-invite\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"leaderboardChange\" className=\"flex-1\">\n                  Leaderboard Changes\n                  <p className=\"text-sm text-muted-foreground\">Get updates when your rank changes</p>\n                </Label>\n                <Switch\n                  id=\"leaderboardChange\"\n                  checked={preferences.leaderboardChange}\n                  onCheckedChange={(checked) => updatePreference('leaderboardChange', checked)}\n                  data-testid=\"switch-leaderboard-change\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"newPersonalRecord\" className=\"flex-1\">\n                  Personal Records\n                  <p className=\"text-sm text-muted-foreground\">Celebrate new personal bests</p>\n                </Label>\n                <Switch\n                  id=\"newPersonalRecord\"\n                  checked={preferences.newPersonalRecord}\n                  onCheckedChange={(checked) => updatePreference('newPersonalRecord', checked)}\n                  data-testid=\"switch-personal-record\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n\n          <Card className=\"mb-6\">\n            <CardHeader>\n              <CardTitle>Community & Learning</CardTitle>\n              <CardDescription>\n                Stay informed with updates and helpful tips\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"socialUpdates\" className=\"flex-1\">\n                  Social Updates\n                  <p className=\"text-sm text-muted-foreground\">Get notified about community features and updates</p>\n                </Label>\n                <Switch\n                  id=\"socialUpdates\"\n                  checked={preferences.socialUpdates}\n                  onCheckedChange={(checked) => updatePreference('socialUpdates', checked)}\n                  data-testid=\"switch-social-updates\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"flex items-center justify-between\">\n                <Label htmlFor=\"tipOfTheDay\" className=\"flex-1\">\n                  Tip of the Day\n                  <p className=\"text-sm text-muted-foreground\">Receive daily typing tips and tricks</p>\n                </Label>\n                <Switch\n                  id=\"tipOfTheDay\"\n                  checked={preferences.tipOfTheDay}\n                  onCheckedChange={(checked) => updatePreference('tipOfTheDay', checked)}\n                  data-testid=\"switch-tip-of-the-day\"\n                />\n              </div>\n            </CardContent>\n          </Card>\n\n          <div className=\"flex justify-end\">\n            <Button\n              onClick={handleSavePreferences}\n              disabled={saving}\n              size=\"lg\"\n              data-testid=\"button-save-preferences\"\n            >\n              {saving ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Saving...\n                </>\n              ) : (\n                'Save Preferences'\n              )}\n            </Button>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":19100,"size_tokens":null},"client/src/pages/typeracer-alternative.tsx":{"content":"import { Link } from 'wouter';\nimport { Check, X, Zap, Trophy, Users, Target, Brain, Code, TrendingUp } from 'lucide-react';\nimport { useSEO } from '@/lib/seo';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Breadcrumbs } from '@/components/breadcrumbs';\n\nexport default function TyperacerAlternativePage() {\n  useSEO({\n    title: 'Typeracer Alternative | TypeMasterAI - Best Free Typing Race Game',\n    description: 'Looking for a Typeracer alternative? TypeMasterAI offers multiplayer typing races, AI analytics, code typing mode, and instant matchmaking. Try the best free typing race game with advanced features Typeracer doesn\\'t have!',\n    keywords: 'typeracer alternative, typing race game, multiplayer typing test, typeracer competitor, better than typeracer, typing race online, free typing game',\n    canonical: 'https://typemaster-ai.replit.app/typeracer-alternative',\n    ogUrl: 'https://typemaster-ai.replit.app/typeracer-alternative',\n  });\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950\">\n      <div className=\"container mx-auto px-4 pt-20 pb-16\">\n        <Breadcrumbs items={[{ label: 'Typeracer Alternative', href: '/typeracer-alternative' }]} />\n        \n        {/* Hero Section */}\n        <section className=\"max-w-4xl mx-auto text-center pt-8 pb-16\">\n          <h1 className=\"text-4xl md:text-6xl font-bold text-cyan-400 mb-6\">\n            The Modern Typeracer Alternative\n          </h1>\n          <p className=\"text-xl md:text-2xl text-slate-300 mb-4\">\n            Multiplayer typing races with AI-powered analytics and instant matchmaking\n          </p>\n          <p className=\"text-lg text-slate-400 mb-8\">\n            Everything Typeracer offers, plus advanced features for serious typists\n          </p>\n          <Link href=\"/multiplayer\">\n            <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-12 py-6\" data-testid=\"button-start-race\">\n              <Trophy className=\"mr-2 h-6 w-6\" />\n              Start Racing Now - Free, No Signup\n            </Button>\n          </Link>\n        </section>\n\n        {/* Comparison Table */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            TypeMasterAI vs Typeracer - Complete Comparison\n          </h2>\n          \n          <div className=\"bg-slate-800/50 rounded-lg border border-slate-700 overflow-hidden\">\n            <table className=\"w-full\">\n              <thead className=\"bg-slate-900/50\">\n                <tr>\n                  <th className=\"text-left p-6 text-white font-semibold\">Feature</th>\n                  <th className=\"text-center p-6 text-cyan-400 font-semibold\">TypeMasterAI</th>\n                  <th className=\"text-center p-6 text-slate-400 font-semibold\">Typeracer</th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-slate-700\">\n                <tr>\n                  <td className=\"p-6 text-white\">Multiplayer Racing</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-slate-800/30\">\n                  <td className=\"p-6 text-white\">Free to Play</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr>\n                  <td className=\"p-6 text-white\">Real-time WPM Tracking</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Instant Matchmaking (No Waiting)</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">AI-Powered Analytics</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Keystroke Heatmap</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Code Typing Mode</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Private Race Rooms</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Finger Usage Analytics</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">AI Practice Recommendations</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Modern UI/UX Design</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6 text-slate-400\">Dated</td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">No Ads</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr>\n                  <td className=\"p-6 text-white\">Car Customization</td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n              </tbody>\n            </table>\n          </div>\n        </section>\n\n        {/* Why Switch from Typeracer */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            Why TypeMasterAI is Better Than Typeracer\n          </h2>\n          \n          <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-8\">\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Zap className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Instant Matchmaking</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  No waiting in lobbies! Our AI bot racers fill rooms instantly so you can start racing immediately. Typeracer makes you wait for other players.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Brain className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">AI-Powered Insights</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Get personalized recommendations based on your typing patterns. Our AI analyzes your weaknesses and suggests targeted practice - something Typeracer doesn't offer.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Code className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Code Typing Races</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Practice typing in JavaScript, Python, Java, and more. Perfect for developers who want to improve coding speed - a feature Typeracer completely lacks.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Target className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Advanced Analytics</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Keystroke heatmaps, finger usage charts, consistency scores, and WPM trends. Get professional-grade analytics that Typeracer's basic stats can't match.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Users className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Private Race Rooms</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Create private rooms and race with friends using a simple room code. Challenge specific people without dealing with random public lobbies.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <TrendingUp className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Modern Experience</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Clean, responsive design with no ads or distractions. Built with modern web technologies for smooth performance on all devices.\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        </section>\n\n        {/* SEO Content */}\n        <section className=\"max-w-4xl mx-auto py-16\">\n          <article className=\"prose prose-invert prose-cyan max-w-none\">\n            <h2 className=\"text-3xl font-bold text-white\">Is TypeMasterAI a Good Typeracer Alternative?</h2>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              Yes! <strong>TypeMasterAI</strong> is designed specifically as a modern alternative to Typeracer, offering all the competitive multiplayer racing features you love, plus advanced analytics and features that Typeracer doesn't provide. If you enjoy Typeracer but want more in-depth performance tracking, instant matchmaking, and AI-powered improvement suggestions, TypeMasterAI is the perfect upgrade.\n            </p>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">What Makes Typeracer Special?</h3>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              Typeracer pioneered the multiplayer typing race concept back in 2008. The car racing theme and competitive element make typing practice fun and engaging. However, after 15+ years, Typeracer's interface feels dated, and it lacks modern features that today's typists expect.\n            </p>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Key Problems with Typeracer</h3>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li><strong>Long wait times</strong> - Often stuck in lobbies waiting for other players</li>\n              <li><strong>Intrusive ads</strong> - Free version has distracting advertisements</li>\n              <li><strong>Limited analytics</strong> - Only basic WPM and accuracy stats</li>\n              <li><strong>Outdated interface</strong> - UI hasn't been modernized significantly</li>\n              <li><strong>No AI insights</strong> - Doesn't tell you how to improve</li>\n              <li><strong>Text-only</strong> - No code typing practice for developers</li>\n              <li><strong>Basic progress tracking</strong> - Limited historical data visualization</li>\n            </ul>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">How TypeMasterAI Solves These Issues</h3>\n            \n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">1. Instant Matchmaking with AI Bots</h4>\n            <p className=\"text-lg text-slate-300\">\n              Our intelligent bot system fills race rooms automatically, so you never wait. Bots have realistic skill levels (35-130 WPM) and typing patterns that mimic real players. Start racing in seconds, not minutes.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">2. Zero Ads, Ever</h4>\n            <p className=\"text-lg text-slate-300\">\n              TypeMasterAI is completely ad-free. No distractions, no interruptions, just pure typing competition. We believe in providing a premium experience without paywalls.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">3. Professional-Grade Analytics</h4>\n            <p className=\"text-lg text-slate-300\">\n              Go beyond basic stats with:\n            </p>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li>Keystroke heatmaps showing which keys you use most</li>\n              <li>Finger usage distribution to identify imbalances</li>\n              <li>WPM consistency charts tracking speed fluctuations</li>\n              <li>Slowest words and digraph analysis</li>\n              <li>Hand balance metrics (left vs right)</li>\n            </ul>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">4. AI-Powered Improvement Plan</h4>\n            <p className=\"text-lg text-slate-300\">\n              Our AI analyzes your typing patterns and generates personalized practice exercises targeting your specific weaknesses. Get actionable recommendations, not just numbers.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">5. Code Typing Mode for Developers</h4>\n            <p className=\"text-lg text-slate-300\">\n              Practice typing in JavaScript, Python, Java, C++, Go, Rust, and more. Build muscle memory for programming syntax, something completely absent from Typeracer.\n            </p>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Typeracer vs TypeMasterAI: User Experience</h3>\n            <div className=\"overflow-x-auto my-6\">\n              <table className=\"w-full border-collapse bg-slate-800/50 rounded-lg overflow-hidden\">\n                <thead className=\"bg-slate-900/50\">\n                  <tr>\n                    <th className=\"p-4 text-left text-white font-semibold border-b border-slate-700\">Aspect</th>\n                    <th className=\"p-4 text-left text-white font-semibold border-b border-slate-700\">TypeMasterAI</th>\n                    <th className=\"p-4 text-left text-white font-semibold border-b border-slate-700\">Typeracer</th>\n                  </tr>\n                </thead>\n                <tbody className=\"text-slate-300\">\n                  <tr>\n                    <td className=\"p-4 border-b border-slate-700 font-semibold\">Wait Time</td>\n                    <td className=\"p-4 border-b border-slate-700\">Instant (AI bots)</td>\n                    <td className=\"p-4 border-b border-slate-700\">Variable (need players)</td>\n                  </tr>\n                  <tr className=\"bg-slate-800/30\">\n                    <td className=\"p-4 border-b border-slate-700 font-semibold\">Interface</td>\n                    <td className=\"p-4 border-b border-slate-700\">Modern, clean, responsive</td>\n                    <td className=\"p-4 border-b border-slate-700\">Dated, cluttered</td>\n                  </tr>\n                  <tr>\n                    <td className=\"p-4 border-b border-slate-700 font-semibold\">Monetization</td>\n                    <td className=\"p-4 border-b border-slate-700\">Free, no ads</td>\n                    <td className=\"p-4 border-b border-slate-700\">Ads or premium</td>\n                  </tr>\n                  <tr className=\"bg-slate-800/30\">\n                    <td className=\"p-4 border-b border-slate-700 font-semibold\">Analytics Depth</td>\n                    <td className=\"p-4 border-b border-slate-700\">Advanced (heatmaps, AI insights)</td>\n                    <td className=\"p-4 border-b border-slate-700\">Basic (WPM, accuracy)</td>\n                  </tr>\n                  <tr>\n                    <td className=\"p-4 font-semibold\">Mobile Experience</td>\n                    <td className=\"p-4\">Fully responsive</td>\n                    <td className=\"p-4\">Desktop-focused</td>\n                  </tr>\n                </tbody>\n              </table>\n            </div>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Who Should Use TypeMasterAI Instead of Typeracer?</h3>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li><strong>Serious typists</strong> who want detailed analytics to improve faster</li>\n              <li><strong>Developers</strong> who need to practice typing code, not just prose</li>\n              <li><strong>Impatient racers</strong> tired of waiting in Typeracer lobbies</li>\n              <li><strong>Data enthusiasts</strong> who love tracking progress with charts and heatmaps</li>\n              <li><strong>Ad-averse users</strong> who want distraction-free practice</li>\n              <li><strong>Mobile typists</strong> who need a responsive interface</li>\n            </ul>\n\n            <div className=\"bg-slate-800/50 border-l-4 border-cyan-500 p-6 my-8\">\n              <h4 className=\"text-xl font-bold text-cyan-400 mb-2\">Try Both!</h4>\n              <p className=\"text-slate-300\">\n                TypeMasterAI is free and requires no signup. Try a few races and compare the experience yourself. Many Typeracer veterans switch to TypeMasterAI for the instant matchmaking alone!\n              </p>\n            </div>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Frequently Asked Questions</h3>\n            \n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Can I race against real players on TypeMasterAI?</h4>\n            <p className=\"text-lg text-slate-300\">\n              Yes! While our AI bots ensure instant matchmaking, real players join public races all the time. You'll see a mix of humans and bots, creating a balanced competitive experience.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Is TypeMasterAI completely free like Typeracer?</h4>\n            <p className=\"text-lg text-slate-300\">\n              Yes, and we have no ads! All features including multiplayer racing, AI analytics, code typing mode, and advanced stats are completely free. No paywalls, no premium tiers.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Do I need an account to race?</h4>\n            <p className=\"text-lg text-slate-300\">\n              No! You can race as a guest immediately. However, creating a free account lets you save your progress, earn achievements, and access personalized analytics.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">What happened to the car theme from Typeracer?</h4>\n            <p className=\"text-lg text-slate-300\">\n              TypeMasterAI focuses on clean, distraction-free racing with real-time WPM visualization. While we don't have car customization, our interface provides clearer feedback on typing performance.\n            </p>\n\n            <div className=\"text-center mt-12\">\n              <Link href=\"/multiplayer\">\n                <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-12 py-6\" data-testid=\"button-start-race-bottom\">\n                  <Trophy className=\"mr-2 h-6 w-6\" />\n                  Try the Best Typeracer Alternative Now\n                </Button>\n              </Link>\n            </div>\n          </article>\n        </section>\n\n        {/* Related Pages */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl font-bold text-center text-white mb-12\">Compare More Typing Test Platforms</h2>\n          <div className=\"grid md:grid-cols-3 gap-6\">\n            <Link href=\"/monkeytype-alternative\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-monkeytype\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Monkeytype Alternative</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-slate-400\">\n                    See how TypeMasterAI compares to Monkeytype's minimalist approach\n                  </p>\n                </CardContent>\n              </Card>\n            </Link>\n\n            <Link href=\"/10fastfingers-alternative\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-10fastfingers\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">10FastFingers Alternative</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-slate-400\">\n                    Compare our features to 10FastFingers' word-based tests\n                  </p>\n                </CardContent>\n              </Card>\n            </Link>\n\n            <Link href=\"/typingcom-alternative\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-typingcom\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Typing.com Alternative</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-slate-400\">\n                    100% free with premium features included\n                  </p>\n                </CardContent>\n              </Card>\n            </Link>\n          </div>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":24186,"size_tokens":null},"client/src/pages/monkeytype-alternative.tsx":{"content":"import { Link } from 'wouter';\nimport { Check, X, Zap, Code, Users, TrendingUp, Brain, Trophy } from 'lucide-react';\nimport { useSEO } from '@/lib/seo';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Breadcrumbs } from '@/components/breadcrumbs';\n\nexport default function MonkeytypeAlternativePage() {\n  useSEO({\n    title: 'Monkeytype Alternative | TypeMasterAI - Free Typing Test with AI Features',\n    description: 'Looking for a Monkeytype alternative? TypeMasterAI offers everything Monkeytype has plus AI-powered analytics, code typing mode, multiplayer racing, and 23+ languages. Try the best free typing test alternative now!',\n    keywords: 'monkeytype alternative, typing test alternative, better than monkeytype, monkeytype vs typemaster, free typing test, typing speed test online, monkeytype competitor',\n    canonical: 'https://typemaster-ai.replit.app/monkeytype-alternative',\n    ogUrl: 'https://typemaster-ai.replit.app/monkeytype-alternative',\n  });\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950\">\n      <div className=\"container mx-auto px-4 pt-20 pb-16\">\n        <Breadcrumbs items={[{ label: 'Monkeytype Alternative', href: '/monkeytype-alternative' }]} />\n        \n        {/* Hero Section */}\n        <section className=\"max-w-4xl mx-auto text-center pt-8 pb-16\">\n          <h1 className=\"text-4xl md:text-6xl font-bold text-cyan-400 mb-6\">\n            The Best Monkeytype Alternative\n          </h1>\n          <p className=\"text-xl md:text-2xl text-slate-300 mb-4\">\n            Everything you love about Monkeytype, plus AI-powered features\n          </p>\n          <p className=\"text-lg text-slate-400 mb-8\">\n            Free typing test with advanced analytics, code typing mode, multiplayer racing, and more\n          </p>\n          <Link href=\"/\">\n            <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-12 py-6\" data-testid=\"button-try-typemaster\">\n              <Zap className=\"mr-2 h-6 w-6\" />\n              Try TypeMasterAI Free - No Signup Required\n            </Button>\n          </Link>\n        </section>\n\n        {/* Comparison Table */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            TypeMasterAI vs Monkeytype - Feature Comparison\n          </h2>\n          \n          <div className=\"bg-slate-800/50 rounded-lg border border-slate-700 overflow-hidden\">\n            <table className=\"w-full\">\n              <thead className=\"bg-slate-900/50\">\n                <tr>\n                  <th className=\"text-left p-6 text-white font-semibold\">Feature</th>\n                  <th className=\"text-center p-6 text-cyan-400 font-semibold\">TypeMasterAI</th>\n                  <th className=\"text-center p-6 text-slate-400 font-semibold\">Monkeytype</th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-slate-700\">\n                <tr>\n                  <td className=\"p-6 text-white\">Free to Use</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-slate-800/30\">\n                  <td className=\"p-6 text-white\">No Signup Required</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr>\n                  <td className=\"p-6 text-white\">Multiple Test Durations</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-slate-800/30\">\n                  <td className=\"p-6 text-white\">Real-time WPM & Accuracy</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">AI-Powered Analytics</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Code Typing Mode (10+ Languages)</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Multiplayer Racing</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Keystroke Heatmap</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Finger Usage Analytics</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">AI Practice Recommendations</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Daily Challenges & Achievements</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Push Notifications</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr>\n                  <td className=\"p-6 text-white\">23+ Languages Supported</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6 text-slate-400\">Limited</td>\n                </tr>\n              </tbody>\n            </table>\n          </div>\n        </section>\n\n        {/* Why Choose TypeMasterAI */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            Why Choose TypeMasterAI Over Monkeytype?\n          </h2>\n          \n          <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-8\">\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Brain className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">AI-Powered Insights</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Get personalized AI recommendations based on your typing patterns. Our AI analyzes your weaknesses and suggests targeted practice exercises.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Code className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Code Typing Practice</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Practice typing in JavaScript, Python, Java, C++, and more. Perfect for developers who want to improve their coding speed with syntax highlighting.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Users className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Multiplayer Racing</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Compete against other typists in real-time multiplayer races. See live WPM updates and climb the global leaderboard.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <TrendingUp className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Advanced Analytics</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Visualize your progress with keystroke heatmaps, finger usage charts, WPM trends, and detailed error analysis that Monkeytype doesn't offer.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Trophy className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Gamification</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Earn achievements, complete daily challenges, unlock badges, and track your streak. Stay motivated with our comprehensive gamification system.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Zap className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Modern UI/UX</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Sleek, responsive design with dark mode, smooth animations, and intuitive navigation. Works perfectly on desktop, tablet, and mobile.\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        </section>\n\n        {/* SEO Content */}\n        <section className=\"max-w-4xl mx-auto py-16\">\n          <article className=\"prose prose-invert prose-cyan max-w-none\">\n            <h2 className=\"text-3xl font-bold text-white\">What Makes TypeMasterAI Different?</h2>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              While Monkeytype is a great minimalist typing test, <strong>TypeMasterAI</strong> takes it to the next level with AI-powered features designed for serious typists and developers who want to maximize their improvement.\n            </p>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">AI-Powered Personalized Analytics</h3>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              Unlike Monkeytype's basic statistics, TypeMasterAI uses artificial intelligence to analyze your typing patterns and provide <strong>personalized recommendations</strong>. Our AI identifies your weak keys, problematic digraphs, and suggests targeted practice exercises to help you improve faster.\n            </p>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Code Typing Mode for Developers</h3>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              TypeMasterAI is the only typing test platform with a dedicated <strong>code typing mode</strong>. Practice typing in JavaScript, Python, Java, C++, Go, Rust, TypeScript, Ruby, PHP, and Swift with proper syntax highlighting. Perfect for developers who want to improve their coding speed.\n            </p>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Real-Time Multiplayer Racing</h3>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              Compete against other typists in <strong>live multiplayer races</strong>. Join public rooms or create private races with friends. See real-time WPM updates for all participants and race to the finish line. It's like Typeracer meets Monkeytype!\n            </p>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Advanced Keystroke Analytics</h3>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              TypeMasterAI provides industry-leading analytics that Monkeytype doesn't offer:\n            </p>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li><strong>Keyboard Heatmap</strong> - Visualize which keys you press most often</li>\n              <li><strong>Finger Usage Distribution</strong> - See which fingers are overworked or underutilized</li>\n              <li><strong>Hand Balance Analysis</strong> - Track left vs right hand usage</li>\n              <li><strong>Slowest Words & Digraphs</strong> - Identify exactly where you're losing time</li>\n              <li><strong>WPM Consistency Chart</strong> - See your speed fluctuations throughout the test</li>\n            </ul>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Who Should Use TypeMasterAI?</h3>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              TypeMasterAI is perfect for:\n            </p>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li><strong>Developers</strong> - Practice coding speed with our code typing mode</li>\n              <li><strong>Competitive Typists</strong> - Race against others in multiplayer mode</li>\n              <li><strong>Data Entry Professionals</strong> - Track improvement with detailed analytics</li>\n              <li><strong>Students</strong> - Improve typing skills for essays and assignments</li>\n              <li><strong>Writers</strong> - Build muscle memory for faster content creation</li>\n              <li><strong>Anyone</strong> who wants to type faster and more accurately</li>\n            </ul>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Frequently Asked Questions</h3>\n            \n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Is TypeMasterAI really free like Monkeytype?</h4>\n            <p className=\"text-lg text-slate-300\">\n              Yes! TypeMasterAI is completely free with no paywalls. All features including AI analytics, code typing, and multiplayer racing are available without any cost.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Do I need to create an account?</h4>\n            <p className=\"text-lg text-slate-300\">\n              No signup is required for basic features. You can start testing immediately. However, creating a free account lets you save your progress, earn achievements, and access personalized analytics.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">How is TypeMasterAI better than Monkeytype?</h4>\n            <p className=\"text-lg text-slate-300\">\n              TypeMasterAI offers everything Monkeytype has plus AI-powered analytics, code typing mode for developers, multiplayer racing, keystroke heatmaps, finger usage statistics, daily challenges, achievements, and push notifications.\n            </p>\n\n            <div className=\"text-center mt-12\">\n              <Link href=\"/\">\n                <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-12 py-6\" data-testid=\"button-start-test-bottom\">\n                  <Zap className=\"mr-2 h-6 w-6\" />\n                  Try the Best Monkeytype Alternative Now\n                </Button>\n              </Link>\n            </div>\n          </article>\n        </section>\n\n        {/* Related Pages */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl font-bold text-center text-white mb-12\">Compare More Typing Test Platforms</h2>\n          <div className=\"grid md:grid-cols-3 gap-6\">\n            <Link href=\"/typeracer-alternative\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-typeracer\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Typeracer Alternative</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-slate-400\">\n                    Discover multiplayer racing with instant matchmaking\n                  </p>\n                </CardContent>\n              </Card>\n            </Link>\n\n            <Link href=\"/10fastfingers-alternative\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-10fastfingers\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">10FastFingers Alternative</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-slate-400\">\n                    Compare our features to 10FastFingers' word-based tests\n                  </p>\n                </CardContent>\n              </Card>\n            </Link>\n\n            <Link href=\"/typingcom-alternative\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-typingcom\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Typing.com Alternative</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-slate-400\">\n                    100% free with premium features included\n                  </p>\n                </CardContent>\n              </Card>\n            </Link>\n          </div>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":19568,"size_tokens":null},"client/src/pages/typing-test-1-min.tsx":{"content":"import { useEffect } from 'react';\nimport { Link } from 'wouter';\nimport { Timer, Zap, Target, TrendingUp, Award, ArrowRight } from 'lucide-react';\nimport { useSEO } from '@/lib/seo';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\n\nexport default function TypingTest1MinPage() {\n  useSEO({\n    title: '1 Minute Typing Test | Free 60 Second WPM Speed Test - TypeMasterAI',\n    description: 'Take a quick 1-minute typing speed test and measure your WPM instantly. Perfect for beginners and quick practice sessions. Get real-time accuracy tracking and instant results. Start your free 60-second typing test now!',\n    keywords: '1 minute typing test, 60 second typing test, quick typing test, typing test 1 min, one minute typing speed test, fast typing test, typing speed 60 seconds',\n    canonical: 'https://typemaster-ai.replit.app/1-minute-typing-test',\n    ogUrl: 'https://typemaster-ai.replit.app/1-minute-typing-test',\n    structuredData: {\n      '@context': 'https://schema.org',\n      '@type': 'HowTo',\n      name: 'How to Take a 1 Minute Typing Test',\n      description: 'Complete a typing speed test in just 60 seconds and get your WPM results',\n      step: [\n        {\n          '@type': 'HowToStep',\n          name: 'Start the Test',\n          text: 'Click the Start Test button below to begin your 1-minute typing challenge',\n          position: 1,\n        },\n        {\n          '@type': 'HowToStep',\n          name: 'Type the Text',\n          text: 'Type the displayed paragraph as quickly and accurately as possible for 60 seconds',\n          position: 2,\n        },\n        {\n          '@type': 'HowToStep',\n          name: 'View Your Results',\n          text: 'Get instant WPM, accuracy percentage, and detailed performance analytics',\n          position: 3,\n        },\n      ],\n    },\n  });\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950\">\n      {/* Hero Section */}\n      <section className=\"container mx-auto px-4 pt-24 pb-16\">\n        <div className=\"max-w-4xl mx-auto text-center\">\n          <h1 className=\"text-5xl md:text-6xl font-bold text-cyan-400 mb-6\">\n            1 Minute Typing Test\n          </h1>\n          <p className=\"text-xl md:text-2xl text-slate-300 mb-8\">\n            Quick & accurate typing speed measurement in just 60 seconds\n          </p>\n          <div className=\"flex flex-col sm:flex-row gap-4 justify-center items-center mb-12\">\n            <Link href=\"/\">\n              <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-8 py-6\" data-testid=\"button-start-1min-test\">\n                <Zap className=\"mr-2 h-5 w-5\" />\n                Start 1 Minute Test\n              </Button>\n            </Link>\n            <Link href=\"/multiplayer\">\n              <Button size=\"lg\" variant=\"outline\" className=\"border-cyan-500 text-cyan-400 hover:bg-cyan-500/10 text-lg px-8 py-6\" data-testid=\"button-multiplayer-race\">\n                Multiplayer Race\n                <ArrowRight className=\"ml-2 h-5 w-5\" />\n              </Button>\n            </Link>\n          </div>\n        </div>\n      </section>\n\n      {/* Benefits Section */}\n      <section className=\"container mx-auto px-4 py-16\">\n        <div className=\"max-w-6xl mx-auto\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            Why Choose a 1 Minute Typing Test?\n          </h2>\n          <div className=\"grid md:grid-cols-2 lg:grid-cols-4 gap-6\">\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Timer className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Quick Results</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Get your WPM score in just 60 seconds. Perfect for quick practice sessions or warm-ups.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Target className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">High Accuracy</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Real-time accuracy tracking ensures you get precise measurements of your typing performance.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <TrendingUp className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Track Progress</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Save your results and monitor improvement over time with detailed analytics and charts.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Award className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Free Forever</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Unlimited tests, no signup required. Start testing your typing speed immediately.\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </section>\n\n      {/* SEO Content Section */}\n      <section className=\"container mx-auto px-4 py-16\">\n        <div className=\"max-w-4xl mx-auto prose prose-invert prose-cyan\">\n          <article className=\"text-slate-300 space-y-6\">\n            <h2 className=\"text-3xl font-bold text-white\">What is a 1 Minute Typing Test?</h2>\n            <p className=\"text-lg leading-relaxed\">\n              A <strong>1 minute typing test</strong> is a quick and efficient way to measure your typing speed and accuracy. In just 60 seconds, you'll type a displayed paragraph while the system calculates your <strong>words per minute (WPM)</strong> and accuracy percentage in real-time.\n            </p>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Average Typing Speed Benchmarks</h3>\n            <ul className=\"list-disc list-inside space-y-2 text-lg\">\n              <li><strong>Beginner:</strong> 20-30 WPM - Just starting to learn touch typing</li>\n              <li><strong>Average:</strong> 40-50 WPM - Typical for most computer users</li>\n              <li><strong>Above Average:</strong> 60-80 WPM - Good typing proficiency</li>\n              <li><strong>Professional:</strong> 80-100 WPM - Office workers and writers</li>\n              <li><strong>Expert:</strong> 100+ WPM - Professional typists and court reporters</li>\n            </ul>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">How to Improve Your 1 Minute Test Score</h3>\n            <ol className=\"list-decimal list-inside space-y-3 text-lg\">\n              <li><strong>Practice regularly</strong> - Take the test daily to build muscle memory</li>\n              <li><strong>Focus on accuracy first</strong> - Speed naturally improves with correct technique</li>\n              <li><strong>Use proper finger placement</strong> - Learn touch typing home row positions</li>\n              <li><strong>Minimize errors</strong> - Backspacing wastes valuable time in a 1-minute test</li>\n              <li><strong>Stay relaxed</strong> - Tension slows you down; maintain a comfortable posture</li>\n              <li><strong>Track your progress</strong> - Monitor improvements over time to stay motivated</li>\n            </ol>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Why 1 Minute vs Longer Tests?</h3>\n            <p className=\"text-lg leading-relaxed\">\n              The <strong>1-minute format</strong> is perfect for quick assessments and frequent practice. It provides:\n            </p>\n            <ul className=\"list-disc list-inside space-y-2 text-lg\">\n              <li>Instant feedback on your current typing ability</li>\n              <li>Lower fatigue compared to 3 or 5-minute tests</li>\n              <li>Easy to fit into busy schedules</li>\n              <li>Great for warm-ups before longer typing sessions</li>\n              <li>Multiple attempts possible in one sitting</li>\n            </ul>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Features of Our 1 Minute Typing Test</h3>\n            <ul className=\"list-disc list-inside space-y-2 text-lg\">\n              <li>âœ¨ <strong>AI-generated content</strong> - Fresh paragraphs every time</li>\n              <li>ðŸ“Š <strong>Real-time WPM tracking</strong> - Watch your speed live</li>\n              <li>ðŸŽ¯ <strong>Accuracy percentage</strong> - See your error rate instantly</li>\n              <li>ðŸ“ˆ <strong>Detailed analytics</strong> - Keystroke heatmaps and finger usage stats</li>\n              <li>ðŸŒ <strong>23+ languages</strong> - Practice in your native language</li>\n              <li>ðŸ† <strong>Leaderboards</strong> - Compete with typists worldwide</li>\n              <li>ðŸ’¯ <strong>No signup required</strong> - Start testing immediately</li>\n            </ul>\n\n            <div className=\"bg-slate-800/50 border-l-4 border-cyan-500 p-6 my-8\">\n              <h4 className=\"text-xl font-bold text-cyan-400 mb-2\">Pro Tip</h4>\n              <p className=\"text-slate-300\">\n                For the most accurate results, ensure you're in a quiet environment with minimal distractions. Position your fingers on the home row (ASDF JKL;) before starting the test.\n              </p>\n            </div>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Frequently Asked Questions</h3>\n            \n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Is a 1-minute test accurate?</h4>\n            <p className=\"text-lg\">\n              Yes! While longer tests can provide more stable averages, a 1-minute test gives you a reliable snapshot of your current typing ability. Take multiple tests for the most consistent results.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">How many words are in a 1-minute test?</h4>\n            <p className=\"text-lg\">\n              The number of words varies based on your typing speed. At 40 WPM (average), you'll type about 40 words. Faster typists (80+ WPM) will type 80+ words in the same minute.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Can I retake the test immediately?</h4>\n            <p className=\"text-lg\">\n              Absolutely! You can take unlimited 1-minute typing tests. We recommend taking at least 3 tests and averaging the results for the most accurate measure of your true typing speed.\n            </p>\n\n            <div className=\"text-center mt-12\">\n              <Link href=\"/\">\n                <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-12 py-6\" data-testid=\"button-start-test-bottom\">\n                  <Zap className=\"mr-2 h-6 w-6\" />\n                  Start Your Free 1 Minute Test Now\n                </Button>\n              </Link>\n            </div>\n          </article>\n        </div>\n      </section>\n\n      {/* Internal Links Section */}\n      <section className=\"container mx-auto px-4 py-16\">\n        <div className=\"max-w-6xl mx-auto\">\n          <h2 className=\"text-3xl font-bold text-center text-white mb-12\">Explore More Typing Tests</h2>\n          <div className=\"grid md:grid-cols-3 gap-6\">\n            <Link href=\"/\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-standard-test\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Standard Typing Test</CardTitle>\n                  <CardDescription className=\"text-slate-400\">\n                    Choose your duration: 15s, 30s, 60s, 2min, or 5min\n                  </CardDescription>\n                </CardHeader>\n              </Card>\n            </Link>\n\n            <Link href=\"/code-test\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-code-test\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Code Typing Test</CardTitle>\n                  <CardDescription className=\"text-slate-400\">\n                    Practice typing code in 10+ programming languages\n                  </CardDescription>\n                </CardHeader>\n              </Card>\n            </Link>\n\n            <Link href=\"/multiplayer\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-multiplayer\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Multiplayer Race</CardTitle>\n                  <CardDescription className=\"text-slate-400\">\n                    Compete against other typists in real-time\n                  </CardDescription>\n                </CardHeader>\n              </Card>\n            </Link>\n          </div>\n        </div>\n      </section>\n    </div>\n  );\n}\n","path":null,"size_bytes":13589,"size_tokens":null},"server/auth-security-service.ts":{"content":"import type { IStorage } from \"./storage\";\nimport type { Request } from \"express\";\nimport crypto from \"node:crypto\";\nimport { emailService, type EmailSendResult } from \"./email-service\";\n\ninterface LoginAttemptResult {\n  allowed: boolean;\n  lockoutMinutes?: number;\n  attemptsRemaining?: number;\n  message?: string;\n}\n\nexport class AuthSecurityService {\n  private readonly MAX_FAILED_ATTEMPTS = 5;\n  private readonly LOCKOUT_DURATION_MINUTES = 30;\n  private readonly FAILED_ATTEMPTS_WINDOW_MINUTES = 15;\n\n  constructor(private storage: IStorage) {}\n\n  async checkAccountLockout(userId: string): Promise<LoginAttemptResult> {\n    const isLocked = await this.storage.isAccountLocked(userId);\n    \n    if (isLocked) {\n      const lockout = await this.storage.getAccountLockout(userId);\n      const lockedUntil = lockout?.lockedUntil;\n      \n      if (lockedUntil) {\n        const minutesRemaining = Math.ceil((lockedUntil.getTime() - Date.now()) / (1000 * 60));\n        return {\n          allowed: false,\n          lockoutMinutes: minutesRemaining,\n          message: `Account is temporarily locked. Please try again in ${minutesRemaining} minute${minutesRemaining > 1 ? 's' : ''}.`,\n        };\n      }\n    }\n\n    return { allowed: true };\n  }\n\n  async handleFailedLogin(userId: string, email: string, req: Request, reason: string): Promise<void> {\n    // Record failed login attempt and update lockout in a single transaction\n    await this.storage.handleFailedLoginTransaction(\n      userId,\n      email,\n      req,\n      reason,\n      this.FAILED_ATTEMPTS_WINDOW_MINUTES,\n      this.MAX_FAILED_ATTEMPTS,\n      this.LOCKOUT_DURATION_MINUTES\n    );\n  }\n\n  async handleSuccessfulLogin(userId: string, email: string, req: Request): Promise<void> {\n    // Record successful login\n    await this.recordLoginAttempt(userId, email, req, true);\n\n    // Clear any account lockout\n    await this.storage.clearAccountLockout(userId);\n\n    // Create or update session tracking\n    if (req.session && req.session.id) {\n      const sessionInfo = this.extractSessionInfo(req);\n      await this.storage.createUserSession({\n        userId,\n        sessionId: req.session.id,\n        ...sessionInfo,\n      });\n    }\n  }\n\n  async recordLoginAttempt(\n    userId: string | null,\n    email: string,\n    req: Request,\n    success: boolean,\n    failureReason?: string\n  ): Promise<void> {\n    const ipAddress = this.getClientIp(req);\n    const userAgent = req.headers[\"user-agent\"] || \"\";\n    const deviceFingerprint = this.generateDeviceFingerprint(req);\n\n    await this.storage.createLoginHistory({\n      userId,\n      email,\n      ipAddress,\n      userAgent,\n      deviceFingerprint,\n      success,\n      failureReason,\n      isSuspicious: false, // Can be enhanced with ML-based detection\n    });\n  }\n\n  private getClientIp(req: Request): string {\n    const forwarded = req.headers[\"x-forwarded-for\"];\n    if (typeof forwarded === \"string\") {\n      return forwarded.split(\",\")[0].trim();\n    }\n    return req.socket.remoteAddress || \"\";\n  }\n\n  private extractSessionInfo(req: Request) {\n    const userAgent = req.headers[\"user-agent\"] || \"\";\n    const ipAddress = this.getClientIp(req);\n\n    // Parse user agent for device/browser info\n    const deviceInfo = this.parseUserAgent(userAgent);\n\n    return {\n      deviceName: deviceInfo.deviceName,\n      deviceType: deviceInfo.deviceType,\n      browser: deviceInfo.browser,\n      browserVersion: deviceInfo.browserVersion,\n      os: deviceInfo.os,\n      osVersion: deviceInfo.osVersion,\n      ipAddress,\n    };\n  }\n\n  private parseUserAgent(userAgent: string): {\n    deviceName: string;\n    deviceType: string;\n    browser: string;\n    browserVersion: string;\n    os: string;\n    osVersion: string;\n  } {\n    // Simple user agent parsing (can be enhanced with a library like ua-parser-js)\n    let browser = \"Unknown\";\n    let browserVersion = \"\";\n    let os = \"Unknown\";\n    let osVersion = \"\";\n    let deviceType = \"desktop\";\n\n    // Browser detection\n    if (userAgent.includes(\"Chrome\")) {\n      browser = \"Chrome\";\n      const match = userAgent.match(/Chrome\\/([\\d.]+)/);\n      browserVersion = match ? match[1] : \"\";\n    } else if (userAgent.includes(\"Firefox\")) {\n      browser = \"Firefox\";\n      const match = userAgent.match(/Firefox\\/([\\d.]+)/);\n      browserVersion = match ? match[1] : \"\";\n    } else if (userAgent.includes(\"Safari\") && !userAgent.includes(\"Chrome\")) {\n      browser = \"Safari\";\n      const match = userAgent.match(/Version\\/([\\d.]+)/);\n      browserVersion = match ? match[1] : \"\";\n    } else if (userAgent.includes(\"Edge\")) {\n      browser = \"Edge\";\n      const match = userAgent.match(/Edge\\/([\\d.]+)/);\n      browserVersion = match ? match[1] : \"\";\n    }\n\n    // OS detection\n    if (userAgent.includes(\"Windows\")) {\n      os = \"Windows\";\n      if (userAgent.includes(\"Windows NT 10.0\")) osVersion = \"10\";\n      else if (userAgent.includes(\"Windows NT 6.3\")) osVersion = \"8.1\";\n      else if (userAgent.includes(\"Windows NT 6.2\")) osVersion = \"8\";\n      else if (userAgent.includes(\"Windows NT 6.1\")) osVersion = \"7\";\n    } else if (userAgent.includes(\"Mac OS X\")) {\n      os = \"macOS\";\n      const match = userAgent.match(/Mac OS X ([\\d_]+)/);\n      osVersion = match ? match[1].replace(/_/g, \".\") : \"\";\n    } else if (userAgent.includes(\"Linux\")) {\n      os = \"Linux\";\n    } else if (userAgent.includes(\"Android\")) {\n      os = \"Android\";\n      deviceType = \"mobile\";\n      const match = userAgent.match(/Android ([\\d.]+)/);\n      osVersion = match ? match[1] : \"\";\n    } else if (userAgent.includes(\"iOS\") || userAgent.includes(\"iPhone\") || userAgent.includes(\"iPad\")) {\n      os = \"iOS\";\n      deviceType = userAgent.includes(\"iPad\") ? \"tablet\" : \"mobile\";\n      const match = userAgent.match(/OS ([\\d_]+)/);\n      osVersion = match ? match[1].replace(/_/g, \".\") : \"\";\n    }\n\n    // Device type detection\n    if (userAgent.includes(\"Mobile\") && deviceType === \"desktop\") {\n      deviceType = \"mobile\";\n    } else if (userAgent.includes(\"Tablet\")) {\n      deviceType = \"tablet\";\n    }\n\n    const deviceName = `${os} ${deviceType}`;\n\n    return {\n      deviceName,\n      deviceType,\n      browser,\n      browserVersion,\n      os,\n      osVersion,\n    };\n  }\n\n  private generateDeviceFingerprint(req: Request): string {\n    const userAgent = req.headers[\"user-agent\"] || \"\";\n    const acceptLanguage = req.headers[\"accept-language\"] || \"\";\n    const acceptEncoding = req.headers[\"accept-encoding\"] || \"\";\n    \n    const fingerprintData = `${userAgent}|${acceptLanguage}|${acceptEncoding}`;\n    return crypto.createHash(\"sha256\").update(fingerprintData).digest(\"hex\").substring(0, 64);\n  }\n\n  async getRemainingAttempts(userId: string): Promise<number> {\n    const recentFailures = await this.storage.getRecentFailedLogins(\n      userId,\n      this.FAILED_ATTEMPTS_WINDOW_MINUTES\n    );\n    return Math.max(0, this.MAX_FAILED_ATTEMPTS - recentFailures.length);\n  }\n\n  async generateSecureToken(): Promise<string> {\n    return crypto.randomBytes(32).toString(\"hex\");\n  }\n\n  async sendVerificationEmail(userId: string, email: string, username?: string): Promise<EmailSendResult> {\n    const token = await this.generateSecureToken();\n    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours\n\n    await this.storage.deleteEmailVerificationToken(userId).catch(() => {});\n    await this.storage.createEmailVerificationToken(userId, token, expiresAt);\n\n    const result = await emailService.sendEmailVerificationEmail(email, token, { username });\n\n    if (!result.success) {\n      console.error(`[AuthSecurityService] Failed to send verification email to ${email}:`, result.error);\n    } else {\n      console.log(`[AuthSecurityService] Verification email sent to ${email} (messageId: ${result.messageId})`);\n    }\n\n    return result;\n  }\n\n  async sendPasswordResetEmail(userId: string, email: string, ipAddress: string, username?: string, timezone?: string): Promise<EmailSendResult> {\n    const token = await this.generateSecureToken();\n    const expiresAt = new Date(Date.now() + 60 * 60 * 1000); // 1 hour\n\n    await this.storage.deletePasswordResetTokens(userId).catch(() => {});\n    await this.storage.createPasswordResetToken(userId, token, expiresAt, ipAddress);\n\n    const result = await emailService.sendPasswordResetEmail(email, token, {\n      username,\n      ipAddress,\n      expiresInMinutes: 60,\n      timezone,\n    });\n\n    if (!result.success) {\n      console.error(`[AuthSecurityService] Failed to send password reset email to ${email}:`, result.error);\n    } else {\n      console.log(`[AuthSecurityService] Password reset email sent to ${email} (messageId: ${result.messageId})`);\n    }\n\n    return result;\n  }\n\n  getEmailServiceStatus() {\n    return emailService.getServiceStatus();\n  }\n}\n","path":null,"size_bytes":8780,"size_tokens":null},"client/src/pages/typing-test-5-min.tsx":{"content":"import { Link } from 'wouter';\nimport { Timer, Zap, Target, TrendingUp, Award, ArrowRight, Brain } from 'lucide-react';\nimport { useSEO } from '@/lib/seo';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Breadcrumbs } from '@/components/breadcrumbs';\n\nexport default function TypingTest5MinPage() {\n  useSEO({\n    title: '5 Minute Typing Test | Free 300 Second WPM Endurance Test - TypeMasterAI',\n    description: 'Take a professional 5-minute typing speed test for maximum accuracy. Perfect for advanced typists and job assessments. Get comprehensive performance analytics and stamina evaluation. Start your free 5-minute typing test now!',\n    keywords: '5 minute typing test, 300 second typing test, typing test 5 min, five minute typing speed test, typing endurance test, professional typing test',\n    canonical: 'https://typemaster-ai.replit.app/5-minute-typing-test',\n    ogUrl: 'https://typemaster-ai.replit.app/5-minute-typing-test',\n    structuredData: {\n      '@context': 'https://schema.org',\n      '@type': 'HowTo',\n      name: 'How to Complete a 5 Minute Professional Typing Test',\n      description: 'Master the professional-grade 5-minute typing test for job applications and certification',\n      step: [\n        {\n          '@type': 'HowToStep',\n          name: 'Set Up Your Environment',\n          text: 'Ensure quiet workspace, comfortable seating, proper keyboard positioning',\n          position: 1,\n        },\n        {\n          '@type': 'HowToStep',\n          name: 'Warm Up',\n          text: 'Take a 1-minute practice test to activate muscle memory before the main test',\n          position: 2,\n        },\n        {\n          '@type': 'HowToStep',\n          name: 'Start the Test',\n          text: 'Begin typing and maintain steady pace throughout the full 5 minutes',\n          position: 3,\n        },\n        {\n          '@type': 'HowToStep',\n          name: 'Monitor Progress',\n          text: 'Watch real-time WPM and accuracy feedback to adjust your speed',\n          position: 4,\n        },\n        {\n          '@type': 'HowToStep',\n          name: 'Analyze Results',\n          text: 'Review comprehensive analytics including stamina chart and consistency metrics',\n          position: 5,\n        },\n      ],\n    },\n  });\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950\">\n      <div className=\"container mx-auto px-4 pt-20 pb-16\">\n        <Breadcrumbs items={[{ label: '5 Minute Typing Test', href: '/5-minute-typing-test' }]} />\n\n        {/* Hero Section */}\n        <section className=\"max-w-4xl mx-auto text-center pt-8 pb-16\">\n          <h1 className=\"text-5xl md:text-6xl font-bold text-cyan-400 mb-6\">\n            5 Minute Typing Test\n          </h1>\n          <p className=\"text-xl md:text-2xl text-slate-300 mb-8\">\n            Professional-grade endurance test for maximum accuracy\n          </p>\n          <div className=\"flex flex-col sm:flex-row gap-4 justify-center items-center mb-12\">\n            <Link href=\"/\">\n              <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-8 py-6\" data-testid=\"button-start-5min-test\">\n                <Timer className=\"mr-2 h-5 w-5\" />\n                Start 5 Minute Test\n              </Button>\n            </Link>\n            <Link href=\"/multiplayer\">\n              <Button size=\"lg\" variant=\"outline\" className=\"border-cyan-500 text-cyan-400 hover:bg-cyan-500/10 text-lg px-8 py-6\" data-testid=\"button-multiplayer-race\">\n                Multiplayer Race\n                <ArrowRight className=\"ml-2 h-5 w-5\" />\n              </Button>\n            </Link>\n          </div>\n        </section>\n\n        {/* Benefits Section */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            Why Choose a 5 Minute Typing Test?\n          </h2>\n          <div className=\"grid md:grid-cols-2 lg:grid-cols-4 gap-6\">\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Target className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Maximum Accuracy</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  5 minutes provides the most statistically accurate measure of your true typing ability by averaging performance over extended time.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <TrendingUp className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Stamina Training</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Build typing endurance essential for long documents, coding sessions, and professional work requiring sustained focus.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Award className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Job Assessment Ready</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Many employers require 5-minute typing tests. Practice with the same format to excel in job applications and certifications.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Brain className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Deep Analytics</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Longer tests generate richer data for AI analysis. Get detailed insights on consistency, stamina decline, and improvement areas.\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        </section>\n\n        {/* SEO Content Section */}\n        <section className=\"max-w-4xl mx-auto py-16\">\n          <article className=\"prose prose-invert prose-cyan max-w-none\">\n            <h2 className=\"text-3xl font-bold text-white\">What is a 5 Minute Typing Test?</h2>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              A <strong>5 minute typing test</strong> is the professional standard for measuring sustained typing performance. Over 300 seconds, you'll demonstrate not just your peak speed but your ability to maintain consistency, accuracy, and focus during extended typing sessions. This format is used by employers, certification programs, and typing competitions worldwide.\n            </p>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Professional Typing Standards (5-Minute Test)</h3>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li><strong>Data Entry:</strong> 40-50 WPM minimum requirement</li>\n              <li><strong>Administrative:</strong> 50-60 WPM expected for office work</li>\n              <li><strong>Transcriptionist:</strong> 60-80 WPM with 95%+ accuracy</li>\n              <li><strong>Court Reporter:</strong> 80-120 WPM with near-perfect accuracy</li>\n              <li><strong>Professional Typist:</strong> 100+ WPM sustained over 5 minutes</li>\n              <li><strong>Elite Competitor:</strong> 120+ WPM with 98%+ accuracy</li>\n            </ul>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Why 5 Minutes is the Professional Standard</h3>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              The <strong>5-minute duration</strong> reveals your true professional capability:\n            </p>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li><strong>Eliminates luck</strong> - Can't maintain artificial speed for 5 full minutes</li>\n              <li><strong>Tests stamina</strong> - Reveals if you can sustain pace or fade over time</li>\n              <li><strong>Simulates work</strong> - Mirrors real-world typing tasks like report writing</li>\n              <li><strong>Highest accuracy</strong> - Statistical law of large numbers minimizes variance</li>\n              <li><strong>Industry standard</strong> - Most professional certifications use 5-minute tests</li>\n              <li><strong>Comprehensive analytics</strong> - Enough data to identify specific weaknesses</li>\n            </ul>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Training Strategy for 5-Minute Tests</h3>\n            <ol className=\"list-decimal list-inside space-y-3 text-lg text-slate-300\">\n              <li><strong>Build gradually</strong> - Master 1-minute tests, then 3-minute, before attempting 5</li>\n              <li><strong>Focus on consistency</strong> - Aim for steady WPM throughout, not fast starts</li>\n              <li><strong>Pace yourself</strong> - Start at 90% max speed to preserve stamina</li>\n              <li><strong>Prioritize accuracy</strong> - Each error impacts your score more over longer tests</li>\n              <li><strong>Practice posture</strong> - Proper ergonomics prevents fatigue in longer sessions</li>\n              <li><strong>Mental endurance</strong> - Stay focused for full 5 minutes; concentration matters</li>\n              <li><strong>Regular breaks</strong> - Don't take multiple 5-minute tests back-to-back; rest hands</li>\n            </ol>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Common Challenges in 5-Minute Tests</h3>\n            <div className=\"space-y-4\">\n              <div className=\"bg-slate-800/50 border-l-4 border-yellow-500 p-4\">\n                <h4 className=\"text-lg font-bold text-yellow-400 mb-2\">Speed Decline</h4>\n                <p className=\"text-slate-300\">\n                  <strong>Problem:</strong> Starting fast but slowing significantly by minute 3-4.<br />\n                  <strong>Solution:</strong> Start at 80-85% of max speed and maintain it. Practice longer 3-5 minute sessions to build stamina.\n                </p>\n              </div>\n\n              <div className=\"bg-slate-800/50 border-l-4 border-yellow-500 p-4\">\n                <h4 className=\"text-lg font-bold text-yellow-400 mb-2\">Accuracy Drop</h4>\n                <p className=\"text-slate-300\">\n                  <strong>Problem:</strong> Making more errors as test progresses due to fatigue.<br />\n                  <strong>Solution:</strong> Slow down by 5 WPM and focus on precision. Better to finish strong at 70 WPM than fade to 60 WPM.\n                </p>\n              </div>\n\n              <div className=\"bg-slate-800/50 border-l-4 border-yellow-500 p-4\">\n                <h4 className=\"text-lg font-bold text-yellow-400 mb-2\">Mental Fatigue</h4>\n                <p className=\"text-slate-300\">\n                  <strong>Problem:</strong> Losing concentration around minute 3.<br />\n                  <strong>Solution:</strong> Practice meditation and focus exercises. Break test into mental \"checkpoints\" every 60 seconds.\n                </p>\n              </div>\n            </div>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">How Employers Use 5-Minute Tests</h3>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              Many companies require typing tests as part of their hiring process. Here's what they look for:\n            </p>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li><strong>Minimum WPM threshold</strong> - Usually 40-60 WPM depending on role</li>\n              <li><strong>Accuracy requirement</strong> - Typically 95% or higher for professional positions</li>\n              <li><strong>Consistency check</strong> - Looking for steady performance, not erratic speed changes</li>\n              <li><strong>Stamina verification</strong> - Ensuring you can maintain pace during full workday</li>\n              <li><strong>Error pattern analysis</strong> - Some roles (data entry) require near-zero errors</li>\n            </ul>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Advanced Features for 5-Minute Tests</h3>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li>ðŸ“Š <strong>Stamina analysis chart</strong> - See WPM progression minute-by-minute</li>\n              <li>ðŸŽ¯ <strong>Consistency score</strong> - Measures how steady your speed remains</li>\n              <li>ðŸ”¥ <strong>Fatigue detection</strong> - AI identifies when/where speed drops occur</li>\n              <li>ðŸ§  <strong>Deep analytics</strong> - Keystroke timing, finger usage, hand balance</li>\n              <li>ðŸ“ˆ <strong>Historical comparison</strong> - Track improvement over multiple tests</li>\n              <li>ðŸ† <strong>Elite leaderboards</strong> - Compare with top 5-minute test performers</li>\n              <li>ðŸ’ª <strong>Endurance training plan</strong> - AI generates stamina-building exercises</li>\n            </ul>\n\n            <div className=\"bg-slate-800/50 border-l-4 border-cyan-500 p-6 my-8\">\n              <h4 className=\"text-xl font-bold text-cyan-400 mb-2\">Pro Tip for Job Tests</h4>\n              <p className=\"text-slate-300\">\n                If preparing for an employment typing test, practice 5-minute tests in the same environment and time of day as your scheduled assessment. Take at least 5 practice tests and aim to score 10 WPM above the job requirement to account for test-day anxiety.\n              </p>\n            </div>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Frequently Asked Questions</h3>\n            \n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Is 5 minutes too long for a typing test?</h4>\n            <p className=\"text-lg text-slate-300\">\n              For beginners, yes - start with 1-3 minute tests first. But for professional assessment and certification, 5 minutes is the standard because it accurately reflects your sustained typing ability, not just short bursts.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">What's a good score on a 5-minute typing test?</h4>\n            <p className=\"text-lg text-slate-300\">\n              40+ WPM is acceptable for most jobs. 60-80 WPM is professional level. 80+ WPM is excellent. 100+ WPM places you in the elite category. But remember: accuracy matters more than speed!\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">How can I prevent fatigue during 5-minute tests?</h4>\n            <p className=\"text-lg text-slate-300\">\n              Build stamina gradually through practice. Use proper ergonomics, keep wrists neutral, take regular practice breaks (not during the test!), and start at a sustainable pace rather than sprinting. Treat it like a marathon, not a sprint.\n            </p>\n\n            <div className=\"text-center mt-12\">\n              <Link href=\"/\">\n                <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-12 py-6\" data-testid=\"button-start-test-bottom\">\n                  <Timer className=\"mr-2 h-6 w-6\" />\n                  Start Your Free 5 Minute Professional Test\n                </Button>\n              </Link>\n            </div>\n          </article>\n        </section>\n\n        {/* Related Tests */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl font-bold text-center text-white mb-12\">Choose Your Test Duration</h2>\n          <div className=\"grid md:grid-cols-3 gap-6\">\n            <Link href=\"/1-minute-typing-test\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-1min-test\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">1 Minute Test</CardTitle>\n                  <CardDescription className=\"text-slate-400\">\n                    Quick speed assessment for beginners and warm-ups\n                  </CardDescription>\n                </CardHeader>\n              </Card>\n            </Link>\n\n            <Link href=\"/3-minute-typing-test\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-3min-test\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">3 Minute Test</CardTitle>\n                  <CardDescription className=\"text-slate-400\">\n                    Industry standard for accurate WPM measurement\n                  </CardDescription>\n                </CardHeader>\n              </Card>\n            </Link>\n\n            <Link href=\"/multiplayer\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-multiplayer\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Multiplayer Race</CardTitle>\n                  <CardDescription className=\"text-slate-400\">\n                    Compete against other typists in real-time races\n                  </CardDescription>\n                </CardHeader>\n              </Card>\n            </Link>\n          </div>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":17827,"size_tokens":null},"client/src/pages/10fastfingers-alternative.tsx":{"content":"import { Link } from 'wouter';\nimport { Check, X, Zap, Trophy, Brain, Code, TrendingUp, Target, Award } from 'lucide-react';\nimport { useSEO } from '@/lib/seo';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Breadcrumbs } from '@/components/breadcrumbs';\n\nexport default function TenFastFingersAlternativePage() {\n  useSEO({\n    title: '10FastFingers Alternative | TypeMasterAI - Better Typing Speed Test',\n    description: 'Looking for a 10FastFingers alternative? TypeMasterAI offers everything 10FastFingers has plus AI analytics, code typing mode, multiplayer racing, and advanced features. Try the best free typing test alternative now!',\n    keywords: '10fastfingers alternative, 10 fast fingers alternative, typing speed test, typing test alternative, better than 10fastfingers, free typing test, wpm test online',\n    canonical: 'https://typemaster-ai.replit.app/10fastfingers-alternative',\n    ogUrl: 'https://typemaster-ai.replit.app/10fastfingers-alternative',\n  });\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950\">\n      <div className=\"container mx-auto px-4 pt-20 pb-16\">\n        <Breadcrumbs items={[{ label: '10FastFingers Alternative', href: '/10fastfingers-alternative' }]} />\n        \n        {/* Hero Section */}\n        <section className=\"max-w-4xl mx-auto text-center pt-8 pb-16\">\n          <h1 className=\"text-4xl md:text-6xl font-bold text-cyan-400 mb-6\">\n            The Superior 10FastFingers Alternative\n          </h1>\n          <p className=\"text-xl md:text-2xl text-slate-300 mb-4\">\n            Fast typing tests with AI-powered analytics and deeper insights\n          </p>\n          <p className=\"text-lg text-slate-400 mb-8\">\n            Everything 10FastFingers offers, plus advanced features they don't have\n          </p>\n          <Link href=\"/\">\n            <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-12 py-6\" data-testid=\"button-start-test\">\n              <Zap className=\"mr-2 h-6 w-6\" />\n              Start Typing Test - Free, No Signup\n            </Button>\n          </Link>\n        </section>\n\n        {/* Comparison Table */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            TypeMasterAI vs 10FastFingers - Feature Comparison\n          </h2>\n          \n          <div className=\"bg-slate-800/50 rounded-lg border border-slate-700 overflow-hidden\">\n            <table className=\"w-full\">\n              <thead className=\"bg-slate-900/50\">\n                <tr>\n                  <th className=\"text-left p-6 text-white font-semibold\">Feature</th>\n                  <th className=\"text-center p-6 text-cyan-400 font-semibold\">TypeMasterAI</th>\n                  <th className=\"text-center p-6 text-slate-400 font-semibold\">10FastFingers</th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-slate-700\">\n                <tr>\n                  <td className=\"p-6 text-white\">Fast 1-Minute Test</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-slate-800/30\">\n                  <td className=\"p-6 text-white\">Multiple Languages</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr>\n                  <td className=\"p-6 text-white\">Free to Use</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-slate-800/30\">\n                  <td className=\"p-6 text-white\">Leaderboards</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">AI-Powered Analytics</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Keystroke Heatmap</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Finger Usage Analytics</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Code Typing Mode</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Multiplayer Racing</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">WPM Consistency Chart</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">AI Practice Recommendations</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Achievement System</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Modern UI Design</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6 text-slate-400\">Basic</td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Mobile Optimized</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6 text-slate-400\">Limited</td>\n                </tr>\n              </tbody>\n            </table>\n          </div>\n        </section>\n\n        {/* Why Choose TypeMasterAI */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            Why TypeMasterAI Beats 10FastFingers\n          </h2>\n          \n          <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-8\">\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Brain className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">AI-Powered Insights</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Get personalized recommendations based on your typing patterns. Our AI identifies your weaknesses and suggests targeted practice exercises.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Target className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Keystroke Heatmaps</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Visualize which keys you press most often with color-coded heatmaps. Identify overused fingers and optimize your typing technique.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Code className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Code Typing Practice</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Practice typing in JavaScript, Python, Java, and more. Perfect for developers - a feature 10FastFingers completely lacks.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Trophy className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Multiplayer Racing</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Compete against other typists in real-time races. Instant matchmaking ensures you never wait for opponents.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <TrendingUp className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Progress Tracking</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  WPM trends, consistency scores, accuracy history, and performance charts. Track improvement with professional-grade analytics.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Award className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Achievement System</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Unlock 25+ achievements across 5 categories. Earn badges, complete challenges, and level up your typing skills.\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        </section>\n\n        {/* SEO Content */}\n        <section className=\"max-w-4xl mx-auto py-16\">\n          <article className=\"prose prose-invert prose-cyan max-w-none\">\n            <h2 className=\"text-3xl font-bold text-white\">Why Look for a 10FastFingers Alternative?</h2>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              <strong>10FastFingers</strong> is a popular typing test platform known for its simple, fast approach. However, after using it for a while, many typists want more: deeper analytics, personalized improvement plans, and modern features. That's where <strong>TypeMasterAI</strong> comes in - offering everything 10FastFingers provides, plus advanced tools they don't have.\n            </p>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">What Makes 10FastFingers Popular?</h3>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              10FastFingers gained popularity by focusing on simplicity and speed:\n            </p>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li><strong>Quick 1-minute tests</strong> - Fast results without commitment</li>\n              <li><strong>Multiple languages</strong> - Support for 40+ languages</li>\n              <li><strong>Global leaderboards</strong> - Compete with typists worldwide</li>\n              <li><strong>Free access</strong> - No payment required for basic features</li>\n              <li><strong>Multiplayer mode</strong> - Race against other typists</li>\n            </ul>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Limitations of 10FastFingers</h3>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              Despite its popularity, 10FastFingers has several significant limitations:\n            </p>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li><strong>Basic statistics only</strong> - Just WPM and accuracy, no deeper insights</li>\n              <li><strong>No improvement guidance</strong> - Doesn't tell you HOW to get better</li>\n              <li><strong>Limited test variety</strong> - Mostly random word lists</li>\n              <li><strong>Dated interface</strong> - UI feels outdated and cluttered</li>\n              <li><strong>No code typing</strong> - Not suitable for developers</li>\n              <li><strong>Weak mobile experience</strong> - Not optimized for phones/tablets</li>\n              <li><strong>No keystroke analysis</strong> - Can't see which keys slow you down</li>\n            </ul>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">How TypeMasterAI Addresses These Limitations</h3>\n            \n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">1. Professional Analytics Dashboard</h4>\n            <p className=\"text-lg text-slate-300\">\n              Beyond basic WPM and accuracy, TypeMasterAI provides:\n            </p>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li><strong>Keystroke heatmap</strong> - Visual representation of key usage frequency</li>\n              <li><strong>Finger usage distribution</strong> - See which fingers are overworked</li>\n              <li><strong>Hand balance analysis</strong> - Left vs right hand usage comparison</li>\n              <li><strong>WPM consistency chart</strong> - Track speed fluctuations during tests</li>\n              <li><strong>Slowest words analysis</strong> - Identify exactly which words trip you up</li>\n              <li><strong>Digraph performance</strong> - Find your fastest and slowest letter combinations</li>\n            </ul>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">2. AI-Powered Improvement Plan</h4>\n            <p className=\"text-lg text-slate-300\">\n              10FastFingers tells you your WPM. TypeMasterAI tells you how to increase it. Our AI:\n            </p>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li>Analyzes your typing patterns across multiple tests</li>\n              <li>Identifies specific weaknesses (slow keys, problem digraphs, finger imbalances)</li>\n              <li>Generates personalized practice exercises targeting YOUR weaknesses</li>\n              <li>Provides actionable recommendations for technique improvement</li>\n              <li>Tracks progress and adjusts recommendations over time</li>\n            </ul>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">3. Code Typing Mode for Developers</h4>\n            <p className=\"text-lg text-slate-300\">\n              If you're a programmer, 10FastFingers' random word tests aren't helpful. TypeMasterAI offers dedicated code typing practice in:\n            </p>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li>JavaScript / TypeScript</li>\n              <li>Python</li>\n              <li>Java</li>\n              <li>C++ / C</li>\n              <li>Go</li>\n              <li>Rust</li>\n              <li>Ruby</li>\n              <li>PHP</li>\n              <li>Swift</li>\n              <li>And more...</li>\n            </ul>\n            <p className=\"text-lg text-slate-300\">\n              Practice typing realistic code snippets with proper syntax highlighting, building muscle memory for programming syntax that 10FastFingers can't provide.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">4. Modern, Responsive Interface</h4>\n            <p className=\"text-lg text-slate-300\">\n              TypeMasterAI features a clean, modern UI built with the latest web technologies:\n            </p>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li>Fully responsive design - works perfectly on desktop, tablet, and mobile</li>\n              <li>Dark mode optimized for reduced eye strain</li>\n              <li>Smooth animations and real-time feedback</li>\n              <li>Intuitive navigation and clean layout</li>\n              <li>No ads or clutter</li>\n            </ul>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">10FastFingers vs TypeMasterAI: Side-by-Side</h3>\n            <div className=\"overflow-x-auto my-6\">\n              <table className=\"w-full border-collapse bg-slate-800/50 rounded-lg overflow-hidden\">\n                <thead className=\"bg-slate-900/50\">\n                  <tr>\n                    <th className=\"p-4 text-left text-white font-semibold border-b border-slate-700\">Feature</th>\n                    <th className=\"p-4 text-left text-white font-semibold border-b border-slate-700\">10FastFingers</th>\n                    <th className=\"p-4 text-left text-white font-semibold border-b border-slate-700\">TypeMasterAI</th>\n                  </tr>\n                </thead>\n                <tbody className=\"text-slate-300\">\n                  <tr>\n                    <td className=\"p-4 border-b border-slate-700 font-semibold\">Basic WPM Test</td>\n                    <td className=\"p-4 border-b border-slate-700\">âœ“ Yes</td>\n                    <td className=\"p-4 border-b border-slate-700\">âœ“ Yes</td>\n                  </tr>\n                  <tr className=\"bg-slate-800/30\">\n                    <td className=\"p-4 border-b border-slate-700 font-semibold\">Advanced Analytics</td>\n                    <td className=\"p-4 border-b border-slate-700\">âœ— No</td>\n                    <td className=\"p-4 border-b border-slate-700 text-cyan-400\">âœ“ Heatmaps, charts, insights</td>\n                  </tr>\n                  <tr>\n                    <td className=\"p-4 border-b border-slate-700 font-semibold\">AI Recommendations</td>\n                    <td className=\"p-4 border-b border-slate-700\">âœ— No</td>\n                    <td className=\"p-4 border-b border-slate-700 text-cyan-400\">âœ“ Personalized plans</td>\n                  </tr>\n                  <tr className=\"bg-slate-800/30\">\n                    <td className=\"p-4 border-b border-slate-700 font-semibold\">Code Typing</td>\n                    <td className=\"p-4 border-b border-slate-700\">âœ— No</td>\n                    <td className=\"p-4 border-b border-slate-700 text-cyan-400\">âœ“ 10+ languages</td>\n                  </tr>\n                  <tr>\n                    <td className=\"p-4 border-b border-slate-700 font-semibold\">Mobile Experience</td>\n                    <td className=\"p-4 border-b border-slate-700\">Limited</td>\n                    <td className=\"p-4 border-b border-slate-700 text-cyan-400\">Fully responsive</td>\n                  </tr>\n                  <tr className=\"bg-slate-800/30\">\n                    <td className=\"p-4 font-semibold\">Achievement System</td>\n                    <td className=\"p-4\">âœ— No</td>\n                    <td className=\"p-4 text-cyan-400\">âœ“ 25+ achievements</td>\n                  </tr>\n                </tbody>\n              </table>\n            </div>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Who Should Switch to TypeMasterAI?</h3>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li><strong>Serious typists</strong> who want to actually improve, not just test</li>\n              <li><strong>Developers</strong> who need code-specific typing practice</li>\n              <li><strong>Data enthusiasts</strong> who love detailed analytics and progress tracking</li>\n              <li><strong>Mobile users</strong> who want a responsive, touch-optimized experience</li>\n              <li><strong>Competitive racers</strong> who enjoy multiplayer with instant matchmaking</li>\n              <li><strong>Goal-oriented learners</strong> who want AI-guided improvement plans</li>\n            </ul>\n\n            <div className=\"bg-slate-800/50 border-l-4 border-cyan-500 p-6 my-8\">\n              <h4 className=\"text-xl font-bold text-cyan-400 mb-2\">Best of Both Worlds</h4>\n              <p className=\"text-slate-300\">\n                TypeMasterAI isn't trying to replace 10FastFingers - it's evolving the concept. We keep what works (fast tests, leaderboards, multiple languages) and add what's missing (deep analytics, AI insights, code typing, modern UX).\n              </p>\n            </div>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Frequently Asked Questions</h3>\n            \n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Is TypeMasterAI free like 10FastFingers?</h4>\n            <p className=\"text-lg text-slate-300\">\n              Yes! All features including AI analytics, code typing, multiplayer racing, and advanced stats are completely free. No paywalls, no premium tiers, no ads.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Do I need to create an account?</h4>\n            <p className=\"text-lg text-slate-300\">\n              No signup required to start testing! Create a free account later if you want to save your progress, earn achievements, and access personalized AI insights.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Does TypeMasterAI support as many languages as 10FastFingers?</h4>\n            <p className=\"text-lg text-slate-300\">\n              We currently support 23+ languages including English, Spanish, French, German, Chinese, Japanese, and more. We're actively adding more based on user requests.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Can I still do quick 1-minute tests?</h4>\n            <p className=\"text-lg text-slate-300\">\n              Absolutely! We support 15 seconds, 30 seconds, 1 minute, 2 minutes, and 5 minutes. Choose the duration that fits your schedule, just like 10FastFingers.\n            </p>\n\n            <div className=\"text-center mt-12\">\n              <Link href=\"/\">\n                <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-12 py-6\" data-testid=\"button-start-test-bottom\">\n                  <Zap className=\"mr-2 h-6 w-6\" />\n                  Try the Best 10FastFingers Alternative Now\n                </Button>\n              </Link>\n            </div>\n          </article>\n        </section>\n\n        {/* Related Pages */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl font-bold text-center text-white mb-12\">Compare More Typing Test Platforms</h2>\n          <div className=\"grid md:grid-cols-3 gap-6\">\n            <Link href=\"/monkeytype-alternative\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-monkeytype\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Monkeytype Alternative</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-slate-400\">\n                    See how TypeMasterAI compares to Monkeytype's minimalist approach\n                  </p>\n                </CardContent>\n              </Card>\n            </Link>\n\n            <Link href=\"/typeracer-alternative\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-typeracer\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Typeracer Alternative</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-slate-400\">\n                    Discover multiplayer racing with instant matchmaking\n                  </p>\n                </CardContent>\n              </Card>\n            </Link>\n\n            <Link href=\"/typingcom-alternative\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-typingcom\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Typing.com Alternative</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-slate-400\">\n                    100% free with premium features included\n                  </p>\n                </CardContent>\n              </Card>\n            </Link>\n          </div>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":26617,"size_tokens":null},"client/src/components/breadcrumbs.tsx":{"content":"import { ChevronRight, Home } from 'lucide-react';\n\nexport interface BreadcrumbItem {\n  label: string;\n  href: string;\n}\n\ninterface BreadcrumbsProps {\n  items: BreadcrumbItem[];\n}\n\nexport function Breadcrumbs({ items }: BreadcrumbsProps) {\n  return (\n    <nav aria-label=\"Breadcrumb\" className=\"py-4\">\n      <ol className=\"flex items-center space-x-2 text-sm text-slate-400\" itemScope itemType=\"https://schema.org/BreadcrumbList\">\n        <li itemProp=\"itemListElement\" itemScope itemType=\"https://schema.org/ListItem\">\n          <a \n            href=\"/\" \n            itemProp=\"item\"\n            className=\"flex items-center hover:text-cyan-400 transition-colors\" \n            data-testid=\"breadcrumb-home\"\n          >\n            <Home className=\"h-4 w-4\" />\n            <span className=\"sr-only\" itemProp=\"name\">Home</span>\n          </a>\n          <meta itemProp=\"position\" content=\"1\" />\n        </li>\n        \n        {items.map((item, index) => (\n          <li key={item.href} className=\"flex items-center\" itemProp=\"itemListElement\" itemScope itemType=\"https://schema.org/ListItem\">\n            <ChevronRight className=\"h-4 w-4 mx-2\" />\n            {index === items.length - 1 ? (\n              <>\n                <span className=\"text-cyan-400 font-medium\" itemProp=\"name\" data-testid={`breadcrumb-${index}`}>\n                  {item.label}\n                </span>\n                <meta itemProp=\"item\" content={`https://typemaster-ai.replit.app${item.href}`} />\n              </>\n            ) : (\n              <a \n                href={item.href} \n                itemProp=\"item\"\n                className=\"hover:text-cyan-400 transition-colors\" \n                data-testid={`breadcrumb-${index}`}\n              >\n                <span itemProp=\"name\">{item.label}</span>\n              </a>\n            )}\n            <meta itemProp=\"position\" content={String(index + 2)} />\n          </li>\n        ))}\n      </ol>\n    </nav>\n  );\n}\n","path":null,"size_bytes":1945,"size_tokens":null},"client/src/lib/seo.tsx":{"content":"import { useEffect } from 'react';\n\nexport interface SEOConfig {\n  title?: string;\n  description?: string;\n  keywords?: string;\n  ogTitle?: string;\n  ogDescription?: string;\n  ogUrl?: string;\n  twitterTitle?: string;\n  twitterDescription?: string;\n  canonical?: string;\n  structuredData?: object;\n}\n\n/**\n * SEO Component for dynamic meta tag management\n * Updates page-specific meta tags for better search engine optimization\n */\nexport function useSEO(config: SEOConfig) {\n  useEffect(() => {\n    // Update document title\n    if (config.title) {\n      document.title = config.title;\n      updateMetaTag('name', 'title', config.title);\n      updateMetaTag('property', 'og:title', config.ogTitle || config.title);\n      updateMetaTag('name', 'twitter:title', config.twitterTitle || config.title);\n    }\n\n    // Update description\n    if (config.description) {\n      updateMetaTag('name', 'description', config.description);\n      updateMetaTag('property', 'og:description', config.ogDescription || config.description);\n      updateMetaTag('name', 'twitter:description', config.twitterDescription || config.description);\n    }\n\n    // Update keywords\n    if (config.keywords) {\n      updateMetaTag('name', 'keywords', config.keywords);\n    }\n\n    // Update canonical URL\n    if (config.canonical) {\n      updateLinkTag('canonical', config.canonical);\n    }\n\n    // Update Open Graph URL\n    if (config.ogUrl) {\n      updateMetaTag('property', 'og:url', config.ogUrl);\n      updateMetaTag('name', 'twitter:url', config.ogUrl);\n    }\n\n    // Add structured data if provided\n    if (config.structuredData) {\n      addStructuredData(config.structuredData);\n    }\n  }, [config]);\n}\n\n/**\n * Update or create a meta tag\n */\nfunction updateMetaTag(attribute: string, key: string, content: string) {\n  let element = document.querySelector(`meta[${attribute}=\"${key}\"]`);\n  \n  if (!element) {\n    element = document.createElement('meta');\n    element.setAttribute(attribute, key);\n    document.head.appendChild(element);\n  }\n  \n  element.setAttribute('content', content);\n}\n\n/**\n * Update or create a link tag\n */\nfunction updateLinkTag(rel: string, href: string) {\n  let element = document.querySelector(`link[rel=\"${rel}\"]`) as HTMLLinkElement;\n  \n  if (!element) {\n    element = document.createElement('link');\n    element.setAttribute('rel', rel);\n    document.head.appendChild(element);\n  }\n  \n  element.href = href;\n}\n\n/**\n * Add structured data (JSON-LD) to the page\n */\nfunction addStructuredData(data: object) {\n  // Remove existing dynamic structured data\n  const existing = document.querySelector('script[data-dynamic-seo=\"true\"]');\n  if (existing) {\n    existing.remove();\n  }\n\n  // Add new structured data\n  const script = document.createElement('script');\n  script.setAttribute('type', 'application/ld+json');\n  script.setAttribute('data-dynamic-seo', 'true');\n  script.textContent = JSON.stringify(data);\n  document.head.appendChild(script);\n}\n\n/**\n * Page-specific SEO configurations - Updated December 2025\n */\nexport const SEO_CONFIGS = {\n  home: {\n    title: 'Free Typing Test | TypeMasterAI - Check Your WPM & Typing Speed Online',\n    description: 'Test your typing speed in 60 seconds! Free online typing test with real-time WPM calculator, accuracy tracker, AI-powered analytics, multiplayer racing, code typing mode for developers, and 23+ languages. No signup required.',\n    keywords: 'typing test, typing speed test, wpm test, words per minute test, free typing test, typing speed, online typing test, typing test wpm, 1 minute typing test, typing accuracy test, typing game, typing practice, monkeytype alternative, code typing test, multiplayer typing race',\n    canonical: 'https://typemaster-ai.replit.app/',\n    ogUrl: 'https://typemaster-ai.replit.app/',\n  },\n  test: {\n    title: '1 Minute Typing Speed Test | Free WPM Calculator - TypeMasterAI',\n    description: 'Take a quick 1-minute typing speed test and get instant WPM results. Track your accuracy, view detailed analytics, and compare with global averages. No signup required.',\n    keywords: '1 minute typing test, typing speed test, wpm calculator, typing test 60 seconds, free typing test, online typing speed test, check typing speed',\n    canonical: 'https://typemaster-ai.replit.app/test',\n    ogUrl: 'https://typemaster-ai.replit.app/test',\n  },\n  codeMode: {\n    title: 'Code Typing Test for Programmers | 20+ Languages - TypeMasterAI',\n    description: 'Improve your coding speed with our specialized code typing test. Practice typing in JavaScript, Python, Java, C++, TypeScript, Go, Rust, and 15+ more languages with syntax highlighting.',\n    keywords: 'code typing test, programming typing test, coding speed test, developer typing practice, javascript typing test, python typing test, coding wpm, programmer typing speed',\n    canonical: 'https://typemaster-ai.replit.app/code-mode',\n    ogUrl: 'https://typemaster-ai.replit.app/code-mode',\n  },\n  multiplayer: {\n    title: 'Multiplayer Typing Race | Compete Live Online - TypeMasterAI',\n    description: 'Join real-time multiplayer typing races and compete against players worldwide. Race to type the fastest, see live WPM updates, ELO ratings, and climb the rankings!',\n    keywords: 'multiplayer typing race, typing game online, competitive typing, typeracer alternative, online typing competition, typing race multiplayer, typing battle',\n    canonical: 'https://typemaster-ai.replit.app/multiplayer',\n    ogUrl: 'https://typemaster-ai.replit.app/multiplayer',\n  },\n  leaderboard: {\n    title: 'Global Typing Speed Leaderboard | Top WPM Rankings - TypeMasterAI',\n    description: 'View the fastest typists in the world! Browse global and code typing leaderboards, filter by language, and compete for the top spot.',\n    keywords: 'typing leaderboard, fastest typists, typing speed rankings, wpm leaderboard, typing competition rankings, best typists, world record typing speed',\n    canonical: 'https://typemaster-ai.replit.app/leaderboard',\n    ogUrl: 'https://typemaster-ai.replit.app/leaderboard',\n  },\n  analytics: {\n    title: 'Typing Analytics & Performance Insights | AI-Powered - TypeMasterAI',\n    description: 'Get detailed typing analytics with keystroke heatmaps, finger usage stats, WPM trends, accuracy metrics, and AI-powered personalized recommendations to improve faster.',\n    keywords: 'typing analytics, typing statistics, keystroke analysis, typing performance, wpm tracking, typing improvement insights, finger usage analysis',\n    canonical: 'https://typemaster-ai.replit.app/analytics',\n    ogUrl: 'https://typemaster-ai.replit.app/analytics',\n  },\n  profile: {\n    title: 'Your Typing Profile & Progress | Track Improvement - TypeMasterAI',\n    description: 'View your typing history, track progress over time, earn achievements, manage badges, and monitor your typing speed improvement journey.',\n    keywords: 'typing profile, typing progress, typing history, typing achievements, track typing speed, typing improvement',\n    canonical: 'https://typemaster-ai.replit.app/profile',\n    ogUrl: 'https://typemaster-ai.replit.app/profile',\n  },\n  stressTest: {\n    title: 'Stress Typing Test | Challenge Your Focus Under Pressure - TypeMasterAI',\n    description: 'Test your typing skills under pressure with visual distractions, screen shake, glitch effects, and more. Multiple difficulty levels from beginner to impossible.',\n    keywords: 'stress typing test, hard typing test, typing test with distractions, challenging typing test, focus test, typing under pressure',\n    canonical: 'https://typemaster-ai.replit.app/stress-test',\n    ogUrl: 'https://typemaster-ai.replit.app/stress-test',\n  },\n  dictationTest: {\n    title: 'Dictation Typing Test | Improve Listening & Typing - TypeMasterAI',\n    description: 'Practice dictation typing to improve both listening and typing skills. Hear sentences spoken aloud and type what you hear with real-time accuracy feedback.',\n    keywords: 'dictation test, listening typing test, transcription practice, audio typing test, dictation practice, typing from audio',\n    canonical: 'https://typemaster-ai.replit.app/dictation-test',\n    ogUrl: 'https://typemaster-ai.replit.app/dictation-test',\n  },\n  bookChapterTest: {\n    title: 'Book Chapter Typing | Practice with Classic Literature - TypeMasterAI',\n    description: 'Practice typing with excerpts from classic literature. Type passages from famous books to improve speed while enjoying great stories.',\n    keywords: 'book typing test, literature typing practice, long text typing test, classic book typing, typing practice stories',\n    canonical: 'https://typemaster-ai.replit.app/book-chapter-test',\n    ogUrl: 'https://typemaster-ai.replit.app/book-chapter-test',\n  },\n  achievements: {\n    title: 'Typing Achievements & Badges | Gamify Your Practice - TypeMasterAI',\n    description: 'Unlock achievements and earn badges as you improve your typing skills. Track milestones and show off your typing accomplishments.',\n    keywords: 'typing achievements, typing badges, typing rewards, typing milestones, gamified typing practice, typing goals',\n    canonical: 'https://typemaster-ai.replit.app/achievements',\n    ogUrl: 'https://typemaster-ai.replit.app/achievements',\n  },\n  challenges: {\n    title: 'Daily Typing Challenges | Compete & Win Rewards - TypeMasterAI',\n    description: 'Complete daily typing challenges to earn rewards and climb the challenge leaderboard. New challenges every day to keep you motivated.',\n    keywords: 'daily typing challenge, typing competition, typing contest, daily typing practice, typing rewards, typing streak',\n    canonical: 'https://typemaster-ai.replit.app/challenges',\n    ogUrl: 'https://typemaster-ai.replit.app/challenges',\n  },\n};\n","path":null,"size_bytes":9754,"size_tokens":null},"client/src/pages/typing-test-3-min.tsx":{"content":"import { Link } from 'wouter';\nimport { Clock, Zap, Target, TrendingUp, Award, ArrowRight } from 'lucide-react';\nimport { useSEO } from '@/lib/seo';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Breadcrumbs } from '@/components/breadcrumbs';\n\nexport default function TypingTest3MinPage() {\n  useSEO({\n    title: '3 Minute Typing Test | Free 180 Second WPM Speed Test - TypeMasterAI',\n    description: 'Take a comprehensive 3-minute typing speed test for accurate WPM measurement. Perfect for intermediate typists seeking reliable results. Get detailed performance analytics and progress tracking. Start your free 3-minute typing test now!',\n    keywords: '3 minute typing test, 180 second typing test, typing test 3 min, three minute typing speed test, typing speed test 3 minutes, intermediate typing test',\n    canonical: 'https://typemaster-ai.replit.app/3-minute-typing-test',\n    ogUrl: 'https://typemaster-ai.replit.app/3-minute-typing-test',\n    structuredData: {\n      '@context': 'https://schema.org',\n      '@type': 'HowTo',\n      name: 'How to Take a 3 Minute Typing Test',\n      description: 'Complete a comprehensive typing speed test in 3 minutes for accurate WPM measurement',\n      step: [\n        {\n          '@type': 'HowToStep',\n          name: 'Prepare Your Workspace',\n          text: 'Sit comfortably with proper posture, position fingers on home row keys',\n          position: 1,\n        },\n        {\n          '@type': 'HowToStep',\n          name: 'Start the Test',\n          text: 'Click Start Test and begin typing the displayed paragraph for 3 minutes',\n          position: 2,\n        },\n        {\n          '@type': 'HowToStep',\n          name: 'Maintain Consistency',\n          text: 'Type steadily for the full 3 minutes to get an accurate average WPM',\n          position: 3,\n        },\n        {\n          '@type': 'HowToStep',\n          name: 'Review Results',\n          text: 'Analyze your WPM, accuracy, keystroke heatmap, and improvement recommendations',\n          position: 4,\n        },\n      ],\n    },\n  });\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950\">\n      <div className=\"container mx-auto px-4 pt-20 pb-16\">\n        <Breadcrumbs items={[{ label: '3 Minute Typing Test', href: '/3-minute-typing-test' }]} />\n\n        {/* Hero Section */}\n        <section className=\"max-w-4xl mx-auto text-center pt-8 pb-16\">\n          <h1 className=\"text-5xl md:text-6xl font-bold text-cyan-400 mb-6\">\n            3 Minute Typing Test\n          </h1>\n          <p className=\"text-xl md:text-2xl text-slate-300 mb-8\">\n            The gold standard for accurate typing speed measurement\n          </p>\n          <div className=\"flex flex-col sm:flex-row gap-4 justify-center items-center mb-12\">\n            <Link href=\"/\">\n              <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-8 py-6\" data-testid=\"button-start-3min-test\">\n                <Clock className=\"mr-2 h-5 w-5\" />\n                Start 3 Minute Test\n              </Button>\n            </Link>\n            <Link href=\"/multiplayer\">\n              <Button size=\"lg\" variant=\"outline\" className=\"border-cyan-500 text-cyan-400 hover:bg-cyan-500/10 text-lg px-8 py-6\" data-testid=\"button-multiplayer-race\">\n                Multiplayer Race\n                <ArrowRight className=\"ml-2 h-5 w-5\" />\n              </Button>\n            </Link>\n          </div>\n        </section>\n\n        {/* Benefits Section */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            Why Take a 3 Minute Typing Test?\n          </h2>\n          <div className=\"grid md:grid-cols-2 lg:grid-cols-4 gap-6\">\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Target className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Most Accurate</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  3 minutes is the industry standard for typing tests. Long enough to eliminate variance, short enough to maintain focus.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <TrendingUp className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Consistent Results</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Longer tests smooth out speed fluctuations, giving you a reliable average WPM that represents your true skill level.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Clock className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Build Stamina</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Train your endurance for longer typing sessions. Essential for professional work that requires sustained typing speed.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\">\n              <CardHeader>\n                <Award className=\"h-12 w-12 text-cyan-400 mb-4\" />\n                <CardTitle className=\"text-white\">Professional Standard</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-slate-400\">\n                  Many employers use 3-minute tests for job assessments. Practice with the same duration to prepare for real evaluations.\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        </section>\n\n        {/* SEO Content Section */}\n        <section className=\"max-w-4xl mx-auto py-16\">\n          <article className=\"prose prose-invert prose-cyan max-w-none\">\n            <h2 className=\"text-3xl font-bold text-white\">What is a 3 Minute Typing Test?</h2>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              A <strong>3 minute typing test</strong> is widely considered the most accurate way to measure your true typing ability. In 180 seconds, you'll type a paragraph while the system tracks your <strong>words per minute (WPM)</strong> and accuracy percentage. This duration provides enough time to establish a consistent rhythm while being short enough to maintain concentration.\n            </p>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Professional Typing Speed Benchmarks</h3>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li><strong>Entry Level:</strong> 30-40 WPM - Minimum for most office jobs</li>\n              <li><strong>Intermediate:</strong> 40-60 WPM - Comfortable for general computer work</li>\n              <li><strong>Advanced:</strong> 60-80 WPM - Competitive typing proficiency</li>\n              <li><strong>Expert:</strong> 80-100 WPM - Professional typist level</li>\n              <li><strong>Elite:</strong> 100+ WPM - Top 1% of typists worldwide</li>\n            </ul>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Why 3 Minutes is the Gold Standard</h3>\n            <p className=\"text-lg text-slate-300 leading-relaxed\">\n              The <strong>3-minute duration</strong> has become the industry standard for several important reasons:\n            </p>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li><strong>Statistical reliability</strong> - Enough time to average out brief speed bursts or slowdowns</li>\n              <li><strong>Reduced test anxiety</strong> - Less pressure than 1-minute sprint tests</li>\n              <li><strong>Real-world simulation</strong> - Matches typical work typing scenarios</li>\n              <li><strong>Stamina assessment</strong> - Reveals your sustained typing ability, not just peak speed</li>\n              <li><strong>Employment standard</strong> - Most companies use 3-5 minute tests for hiring</li>\n            </ul>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">How to Maximize Your 3 Minute Test Score</h3>\n            <ol className=\"list-decimal list-inside space-y-3 text-lg text-slate-300\">\n              <li><strong>Warm up first</strong> - Take a 1-minute practice test before your scored attempt</li>\n              <li><strong>Maintain steady pace</strong> - Don't sprint at the start; consistency wins</li>\n              <li><strong>Focus on accuracy</strong> - One error can cost you 5-10 WPM in overall score</li>\n              <li><strong>Use proper technique</strong> - Touch typing with home row finger placement</li>\n              <li><strong>Minimize corrections</strong> - Backspacing wastes valuable time</li>\n              <li><strong>Stay relaxed</strong> - Tension reduces speed and increases errors</li>\n              <li><strong>Practice regularly</strong> - Take tests at the same time daily for best results</li>\n            </ol>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">1 Minute vs 3 Minute vs 5 Minute Tests</h3>\n            <div className=\"overflow-x-auto my-6\">\n              <table className=\"w-full border-collapse bg-slate-800/50 rounded-lg overflow-hidden\">\n                <thead className=\"bg-slate-900/50\">\n                  <tr>\n                    <th className=\"p-4 text-left text-white font-semibold border-b border-slate-700\">Duration</th>\n                    <th className=\"p-4 text-left text-white font-semibold border-b border-slate-700\">Best For</th>\n                    <th className=\"p-4 text-left text-white font-semibold border-b border-slate-700\">Accuracy</th>\n                    <th className=\"p-4 text-left text-white font-semibold border-b border-slate-700\">Use Case</th>\n                  </tr>\n                </thead>\n                <tbody className=\"text-slate-300\">\n                  <tr>\n                    <td className=\"p-4 border-b border-slate-700\">1 Minute</td>\n                    <td className=\"p-4 border-b border-slate-700\">Quick checks, warm-ups</td>\n                    <td className=\"p-4 border-b border-slate-700\">Moderate variance</td>\n                    <td className=\"p-4 border-b border-slate-700\">Daily practice, speed bursts</td>\n                  </tr>\n                  <tr className=\"bg-cyan-900/10\">\n                    <td className=\"p-4 border-b border-slate-700 font-semibold text-cyan-400\">3 Minutes</td>\n                    <td className=\"p-4 border-b border-slate-700\">Accurate measurement</td>\n                    <td className=\"p-4 border-b border-slate-700\">Most consistent</td>\n                    <td className=\"p-4 border-b border-slate-700\">Job tests, certifications</td>\n                  </tr>\n                  <tr>\n                    <td className=\"p-4\">5 Minutes</td>\n                    <td className=\"p-4\">Endurance training</td>\n                    <td className=\"p-4\">Very stable</td>\n                    <td className=\"p-4\">Professional evaluation</td>\n                  </tr>\n                </tbody>\n              </table>\n            </div>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Features of Our 3 Minute Typing Test</h3>\n            <ul className=\"list-disc list-inside space-y-2 text-lg text-slate-300\">\n              <li>âœ¨ <strong>Real-time WPM display</strong> - Track your speed throughout the test</li>\n              <li>ðŸ“Š <strong>Advanced analytics</strong> - Keystroke heatmaps, finger usage, consistency charts</li>\n              <li>ðŸŽ¯ <strong>Accuracy tracking</strong> - See errors in real-time with highlighted mistakes</li>\n              <li>ðŸ§  <strong>AI-powered insights</strong> - Get personalized recommendations after each test</li>\n              <li>ðŸŒ <strong>23+ languages</strong> - Practice in English, Spanish, French, and more</li>\n              <li>ðŸ† <strong>Global leaderboards</strong> - Compare your results with typists worldwide</li>\n              <li>ðŸ’¯ <strong>No signup required</strong> - Start testing immediately, save results optionally</li>\n            </ul>\n\n            <div className=\"bg-slate-800/50 border-l-4 border-cyan-500 p-6 my-8\">\n              <h4 className=\"text-xl font-bold text-cyan-400 mb-2\">Expert Tip</h4>\n              <p className=\"text-slate-300\">\n                For the most representative score, take 3-5 consecutive 3-minute tests and average the results. This eliminates outliers and gives you a true baseline of your typing ability.\n              </p>\n            </div>\n\n            <h3 className=\"text-2xl font-bold text-white mt-8\">Frequently Asked Questions</h3>\n            \n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Is 3 minutes too long for a typing test?</h4>\n            <p className=\"text-lg text-slate-300\">\n              No! 3 minutes is actually the sweet spot - long enough for accurate measurement but short enough to maintain focus. It's the standard used by employers and typing certification programs.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">What's a good WPM for a 3-minute test?</h4>\n            <p className=\"text-lg text-slate-300\">\n              For general computer use, 40-50 WPM is average. Office professionals typically score 60-80 WPM. Anything above 80 WPM is considered excellent, and 100+ WPM places you in the expert category.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Should I aim for speed or accuracy?</h4>\n            <p className=\"text-lg text-slate-300\">\n              Accuracy first! A 3-minute test rewards consistency. It's better to type at 70 WPM with 98% accuracy than 90 WPM with 85% accuracy. Master accuracy first, then gradually increase speed.\n            </p>\n\n            <div className=\"text-center mt-12\">\n              <Link href=\"/\">\n                <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-12 py-6\" data-testid=\"button-start-test-bottom\">\n                  <Clock className=\"mr-2 h-6 w-6\" />\n                  Start Your Free 3 Minute Test Now\n                </Button>\n              </Link>\n            </div>\n          </article>\n        </section>\n\n        {/* Related Tests */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl font-bold text-center text-white mb-12\">Try Other Test Durations</h2>\n          <div className=\"grid md:grid-cols-3 gap-6\">\n            <Link href=\"/1-minute-typing-test\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-1min-test\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">1 Minute Test</CardTitle>\n                  <CardDescription className=\"text-slate-400\">\n                    Quick speed check, perfect for warm-ups and daily practice\n                  </CardDescription>\n                </CardHeader>\n              </Card>\n            </Link>\n\n            <Link href=\"/\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-standard-test\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Custom Duration</CardTitle>\n                  <CardDescription className=\"text-slate-400\">\n                    Choose 15s, 30s, 60s, 2min, or 5min for flexible practice\n                  </CardDescription>\n                </CardHeader>\n              </Card>\n            </Link>\n\n            <Link href=\"/code-test\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-code-test\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Code Typing Test</CardTitle>\n                  <CardDescription className=\"text-slate-400\">\n                    Practice typing code in 10+ programming languages\n                  </CardDescription>\n                </CardHeader>\n              </Card>\n            </Link>\n          </div>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":16744,"size_tokens":null},"client/src/pages/typingcom-alternative.tsx":{"content":"import { Link } from 'wouter';\nimport { Check, X, Zap, GraduationCap, Users, TrendingUp, Brain, Trophy, BookOpen, Target } from 'lucide-react';\nimport { useSEO } from '@/lib/seo';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Breadcrumbs } from '@/components/breadcrumbs';\n\nexport default function TypingComAlternativePage() {\n  useSEO({\n    title: 'Typing.com Alternative | TypeMasterAI - Free Typing Test for Students & Teachers',\n    description: 'Looking for a Typing.com alternative? TypeMasterAI offers free typing tests with AI-powered analytics, multiplayer racing, code typing mode, and comprehensive progress tracking. Perfect for students, teachers, and self-learners!',\n    keywords: 'typing.com alternative, free typing lessons, typing test for students, typing tutor alternative, typing practice online, learn to type free, typing course alternative, student typing test',\n    canonical: 'https://typemaster-ai.replit.app/typingcom-alternative',\n    ogUrl: 'https://typemaster-ai.replit.app/typingcom-alternative',\n  });\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950\">\n      <div className=\"container mx-auto px-4 pt-20 pb-16\">\n        <Breadcrumbs items={[{ label: 'Typing.com Alternative', href: '/typingcom-alternative' }]} />\n        \n        {/* Hero Section */}\n        <section className=\"max-w-4xl mx-auto text-center pt-8 pb-16\">\n          <h1 className=\"text-4xl md:text-6xl font-bold text-cyan-400 mb-6\">\n            The Best Free Typing.com Alternative\n          </h1>\n          <p className=\"text-xl md:text-2xl text-slate-300 mb-4\">\n            Everything you need to master typing, without the subscription fees\n          </p>\n          <p className=\"text-lg text-slate-400 mb-8\">\n            Free typing tests, AI-powered analytics, and engaging features for students and self-learners\n          </p>\n          <Link href=\"/\">\n            <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-12 py-6\" data-testid=\"button-try-typemaster\">\n              <Zap className=\"mr-2 h-6 w-6\" />\n              Start Free Typing Test - No Signup Required\n            </Button>\n          </Link>\n        </section>\n\n        {/* Comparison Table */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            TypeMasterAI vs Typing.com - Feature Comparison\n          </h2>\n          \n          <div className=\"bg-slate-800/50 rounded-lg border border-slate-700 overflow-hidden\">\n            <table className=\"w-full\">\n              <thead className=\"bg-slate-900/50\">\n                <tr>\n                  <th className=\"text-left p-6 text-white font-semibold\">Feature</th>\n                  <th className=\"text-center p-6 text-cyan-400 font-semibold\">TypeMasterAI</th>\n                  <th className=\"text-center p-6 text-slate-400 font-semibold\">Typing.com</th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-slate-700\">\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">100% Free Forever</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6 text-slate-400\">Premium Required</td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">No Subscription Fees</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr>\n                  <td className=\"p-6 text-white\">No Signup Required</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-slate-800/30\">\n                  <td className=\"p-6 text-white\">Real-time WPM & Accuracy</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr>\n                  <td className=\"p-6 text-white\">Multiple Test Durations</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-slate-800/30\">\n                  <td className=\"p-6 text-white\">Progress Tracking</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">AI-Powered Analytics</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Keystroke Heatmap</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Finger Usage Analytics</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">AI Practice Recommendations</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Code Typing Mode (10+ Languages)</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Multiplayer Racing</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Daily Challenges & Achievements</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-cyan-900/20 border-l-4 border-cyan-500\">\n                  <td className=\"p-6 text-white font-semibold\">Push Notifications</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-cyan-400 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><X className=\"h-6 w-6 text-red-500 mx-auto\" /></td>\n                </tr>\n                <tr className=\"bg-slate-800/30\">\n                  <td className=\"p-6 text-white\">23+ Languages Supported</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n                <tr>\n                  <td className=\"p-6 text-white\">Lessons & Curriculum</td>\n                  <td className=\"text-center p-6 text-slate-400\">Practice-Based</td>\n                  <td className=\"text-center p-6\"><Check className=\"h-6 w-6 text-green-500 mx-auto\" /></td>\n                </tr>\n              </tbody>\n            </table>\n          </div>\n        </section>\n\n        {/* Why Choose TypeMasterAI */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            Why Students & Self-Learners Choose TypeMasterAI Over Typing.com\n          </h2>\n          \n          <div className=\"grid md:grid-cols-2 gap-8\">\n            <Card className=\"bg-slate-800/50 border-slate-700\" data-testid=\"card-free-forever\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center text-cyan-400\">\n                  <Zap className=\"mr-3 h-6 w-6\" />\n                  100% Free Forever\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"text-slate-300\">\n                <p className=\"mb-4\">\n                  While Typing.com requires a premium subscription for advanced features, TypeMasterAI provides everything completely free. No hidden fees, no premium tiersâ€”just unlimited access to all features for everyone.\n                </p>\n                <p>\n                  Perfect for students, teachers, and anyone who wants to improve their typing without spending money on subscriptions.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\" data-testid=\"card-ai-powered\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center text-cyan-400\">\n                  <Brain className=\"mr-3 h-6 w-6\" />\n                  AI-Powered Insights\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"text-slate-300\">\n                <p className=\"mb-4\">\n                  Our advanced AI analyzes your typing patterns in real-time, identifying specific weaknesses like slow key combinations, finger misuse, and hand balance issues.\n                </p>\n                <p>\n                  Get personalized practice recommendations that target your exact problem areasâ€”something Typing.com doesn't offer at any price.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\" data-testid=\"card-code-typing\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center text-cyan-400\">\n                  <GraduationCap className=\"mr-3 h-6 w-6\" />\n                  Code Typing for Future Developers\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"text-slate-300\">\n                <p className=\"mb-4\">\n                  If you're learning programming, our code typing mode helps you practice typing real code snippets in Python, JavaScript, Java, C++, and 10+ other languages.\n                </p>\n                <p>\n                  Develop muscle memory for brackets, semicolons, and special characters that regular typing tests don't emphasizeâ€”crucial skills for aspiring developers.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\" data-testid=\"card-multiplayer\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center text-cyan-400\">\n                  <Users className=\"mr-3 h-6 w-6\" />\n                  Competitive Multiplayer Racing\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"text-slate-300\">\n                <p className=\"mb-4\">\n                  Learning is more fun when it's social! Race against friends or random opponents in real-time multiplayer typing races.\n                </p>\n                <p>\n                  Instant matchmaking, private rooms for classroom competitions, and live leaderboards make practice feel like a gameâ€”keeping students engaged and motivated.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\" data-testid=\"card-analytics\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center text-cyan-400\">\n                  <TrendingUp className=\"mr-3 h-6 w-6\" />\n                  Industry-Leading Analytics\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"text-slate-300\">\n                <p className=\"mb-4\">\n                  Visualize your progress with detailed charts, keyboard heatmaps showing which keys slow you down, finger usage breakdowns, and hand balance metrics.\n                </p>\n                <p>\n                  Track WPM consistency throughout tests, identify your slowest words, and see fastest vs slowest key combinationsâ€”analytics that go far beyond basic WPM tracking.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\" data-testid=\"card-gamification\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center text-cyan-400\">\n                  <Trophy className=\"mr-3 h-6 w-6\" />\n                  Achievements & Daily Challenges\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"text-slate-300\">\n                <p className=\"mb-4\">\n                  Unlock 25+ achievements across 5 tiers (bronze to diamond) as you hit speed milestones, maintain accuracy, and build practice streaks.\n                </p>\n                <p>\n                  Daily and weekly challenges with point rewards keep practice fresh and excitingâ€”perfect for maintaining long-term motivation and consistency.\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        </section>\n\n        {/* For Students Section */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            Perfect for Students at Every Level\n          </h2>\n          \n          <article className=\"bg-slate-800/30 rounded-lg border border-slate-700 p-8 mb-8\">\n            <h3 className=\"text-2xl font-bold text-cyan-400 mb-6\">Elementary & Middle School Students</h3>\n            <div className=\"text-lg text-slate-300 space-y-4\">\n              <p>\n                TypeMasterAI is ideal for young learners who are just starting their typing journey. Unlike Typing.com's structured curriculum approach, we focus on practice-based learning that lets students progress at their own pace.\n              </p>\n              <p>\n                Our gamification featuresâ€”achievements, challenges, and multiplayer racesâ€”keep younger students engaged without the pressure of grades or formal assessments. The visual feedback system with color-coded letters helps reinforce proper technique naturally.\n              </p>\n              <p>\n                Parents and teachers love that it's completely free with no ads, subscriptions, or paywalls blocking features. Students can practice unlimited tests anytime, anywhere, on any device.\n              </p>\n            </div>\n          </article>\n\n          <article className=\"bg-slate-800/30 rounded-lg border border-slate-700 p-8 mb-8\">\n            <h3 className=\"text-2xl font-bold text-cyan-400 mb-6\">High School & College Students</h3>\n            <div className=\"text-lg text-slate-300 space-y-4\">\n              <p>\n                For older students preparing for college or careers, TypeMasterAI offers advanced features that Typing.com Premium charges for. Our AI-powered analytics identify exactly which keys and combinations slow you down, with personalized practice plans to target those weaknesses.\n              </p>\n              <p>\n                The code typing mode is perfect for students in computer science classes or learning programming on their own. Practice typing real Python, JavaScript, Java, C++, and other language syntaxâ€”building muscle memory for brackets, semicolons, and special characters that regular typing tests ignore.\n              </p>\n              <p>\n                Competitive students can track their progress on global leaderboards, earn achievements for speed milestones, and challenge classmates in multiplayer races. These social features make practice feel less like homework and more like a competition.\n              </p>\n            </div>\n          </article>\n\n          <article className=\"bg-slate-800/30 rounded-lg border border-slate-700 p-8\">\n            <h3 className=\"text-2xl font-bold text-cyan-400 mb-6\">Self-Learners & Adult Students</h3>\n            <div className=\"text-lg text-slate-300 space-y-4\">\n              <p>\n                Adults improving their typing skills for work or personal development appreciate TypeMasterAI's no-nonsense approach. No childish graphics or mandatory lessonsâ€”just powerful tools to measure and improve your speed.\n              </p>\n              <p>\n                The comprehensive analytics dashboard shows WPM trends over time, accuracy improvements, consistency scores, and detailed breakdowns of which fingers and hands need more practice. This data-driven approach helps adults optimize their learning efficiently.\n              </p>\n              <p>\n                Professional features like code typing mode, stress tests, and book typing mode cater to developers, writers, and knowledge workers who need typing proficiency for their careersâ€”all without the monthly subscription fees that Typing.com charges.\n              </p>\n            </div>\n          </article>\n        </section>\n\n        {/* How TypeMasterAI Works */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            How TypeMasterAI Helps You Improve\n          </h2>\n          \n          <div className=\"space-y-8\">\n            <Card className=\"bg-slate-800/50 border-slate-700\" data-testid=\"card-step-1\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center text-white\">\n                  <div className=\"flex items-center justify-center w-12 h-12 rounded-full bg-cyan-500 text-white font-bold mr-4\">1</div>\n                  Take Your First Typing Test\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"text-slate-300\">\n                <p className=\"mb-4\">\n                  Start with a simple 1-minute, 3-minute, or 5-minute typing test. No account requiredâ€”just click start and begin typing. Our system captures every keystroke, measuring your speed (WPM), accuracy, and consistency in real-time.\n                </p>\n                <p>\n                  Choose from 23+ languages and multiple difficulty levels. Test yourself on standard paragraphs, code snippets, or even full book chapters depending on your goals.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\" data-testid=\"card-step-2\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center text-white\">\n                  <div className=\"flex items-center justify-center w-12 h-12 rounded-full bg-cyan-500 text-white font-bold mr-4\">2</div>\n                  Review Your Detailed Analytics\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"text-slate-300\">\n                <p className=\"mb-4\">\n                  After each test, view comprehensive analytics that go far beyond simple WPM scores. See your keyboard heatmap showing which keys you press most (and slowest), finger usage distribution, hand balance metrics, and WPM consistency throughout the test.\n                </p>\n                <p>\n                  Identify your slowest words, fastest and slowest key combinations (digraphs), and common error patterns. This level of detail helps you understand exactly where to focus your improvement efforts.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\" data-testid=\"card-step-3\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center text-white\">\n                  <div className=\"flex items-center justify-center w-12 h-12 rounded-full bg-cyan-500 text-white font-bold mr-4\">3</div>\n                  Get AI-Powered Recommendations\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"text-slate-300\">\n                <p className=\"mb-4\">\n                  Our AI analyzes your keystroke data and generates personalized practice recommendations. It identifies specific weaknesses like slow digraphs, underused fingers, or accuracy issues on certain keys.\n                </p>\n                <p>\n                  Each recommendation includes actionable steps, target keys or combinations to practice, and estimated practice duration. Follow these custom plans to improve faster than generic typing lessons ever could.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\" data-testid=\"card-step-4\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center text-white\">\n                  <div className=\"flex items-center justify-center w-12 h-12 rounded-full bg-cyan-500 text-white font-bold mr-4\">4</div>\n                  Practice Consistently & Track Progress\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"text-slate-300\">\n                <p className=\"mb-4\">\n                  Build a daily practice habit with our achievement system and daily challenges. Earn points, unlock badges from bronze to diamond tiers, and maintain practice streaks.\n                </p>\n                <p>\n                  Track your improvement over days, weeks, and months with trend charts showing WPM growth, accuracy improvements, and consistency gains. See tangible proof that your practice is paying off.\n                </p>\n              </CardContent>\n            </Card>\n\n            <Card className=\"bg-slate-800/50 border-slate-700\" data-testid=\"card-step-5\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center text-white\">\n                  <div className=\"flex items-center justify-center w-12 h-12 rounded-full bg-cyan-500 text-white font-bold mr-4\">5</div>\n                  Challenge Yourself & Compete\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"text-slate-300\">\n                <p className=\"mb-4\">\n                  Once you've built a solid foundation, test your skills in multiplayer races against other typists worldwide. Compete on global leaderboards, join daily and weekly challenges, and push yourself to new speed milestones.\n                </p>\n                <p>\n                  Try specialized modes like code typing (for developers), stress tests (for endurance), or book typing (for writers) to challenge yourself in new ways and keep practice interesting.\n                </p>\n              </CardContent>\n            </Card>\n          </div>\n        </section>\n\n        {/* Typing.com Premium vs TypeMasterAI Free */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            Typing.com Premium vs TypeMasterAI Free\n          </h2>\n          \n          <article className=\"bg-slate-800/30 rounded-lg border border-slate-700 p-8\">\n            <h3 className=\"text-2xl font-bold text-cyan-400 mb-6\">The Cost Comparison</h3>\n            <div className=\"text-lg text-slate-300 space-y-4 mb-8\">\n              <p>\n                Typing.com charges a monthly or annual subscription fee to access premium features like detailed analytics, custom practice plans, and advanced progress tracking. Over a year, these subscription costs can add up to hundreds of dollars per student.\n              </p>\n              <p>\n                TypeMasterAI provides all features completely freeâ€”forever. No trials, no premium tiers, no feature limitations. What would cost you $100+ per year on Typing.com is available instantly at zero cost on TypeMasterAI.\n              </p>\n            </div>\n\n            <div className=\"grid md:grid-cols-2 gap-6 mb-8\">\n              <div className=\"bg-slate-700/30 rounded-lg p-6 border border-slate-600\">\n                <h4 className=\"text-xl font-semibold text-slate-300 mb-4\">Typing.com Premium</h4>\n                <p className=\"text-3xl font-bold text-red-400 mb-4\">$99/year</p>\n                <ul className=\"space-y-2 text-slate-400\">\n                  <li className=\"flex items-start\">\n                    <Check className=\"h-5 w-5 text-green-500 mr-2 mt-0.5 flex-shrink-0\" />\n                    <span>Structured lessons & curriculum</span>\n                  </li>\n                  <li className=\"flex items-start\">\n                    <Check className=\"h-5 w-5 text-green-500 mr-2 mt-0.5 flex-shrink-0\" />\n                    <span>Basic progress tracking</span>\n                  </li>\n                  <li className=\"flex items-start\">\n                    <Check className=\"h-5 w-5 text-green-500 mr-2 mt-0.5 flex-shrink-0\" />\n                    <span>Teacher dashboard (separate fee)</span>\n                  </li>\n                  <li className=\"flex items-start\">\n                    <X className=\"h-5 w-5 text-red-500 mr-2 mt-0.5 flex-shrink-0\" />\n                    <span>No AI-powered analytics</span>\n                  </li>\n                  <li className=\"flex items-start\">\n                    <X className=\"h-5 w-5 text-red-500 mr-2 mt-0.5 flex-shrink-0\" />\n                    <span>No multiplayer racing</span>\n                  </li>\n                  <li className=\"flex items-start\">\n                    <X className=\"h-5 w-5 text-red-500 mr-2 mt-0.5 flex-shrink-0\" />\n                    <span>No code typing mode</span>\n                  </li>\n                </ul>\n              </div>\n\n              <div className=\"bg-gradient-to-br from-cyan-900/30 to-blue-900/30 rounded-lg p-6 border-2 border-cyan-500\">\n                <h4 className=\"text-xl font-semibold text-white mb-4\">TypeMasterAI Free</h4>\n                <p className=\"text-3xl font-bold text-cyan-400 mb-4\">$0/forever</p>\n                <ul className=\"space-y-2 text-slate-300\">\n                  <li className=\"flex items-start\">\n                    <Check className=\"h-5 w-5 text-cyan-400 mr-2 mt-0.5 flex-shrink-0\" />\n                    <span>Practice-based learning</span>\n                  </li>\n                  <li className=\"flex items-start\">\n                    <Check className=\"h-5 w-5 text-cyan-400 mr-2 mt-0.5 flex-shrink-0\" />\n                    <span>Advanced AI analytics</span>\n                  </li>\n                  <li className=\"flex items-start\">\n                    <Check className=\"h-5 w-5 text-cyan-400 mr-2 mt-0.5 flex-shrink-0\" />\n                    <span>Multiplayer racing</span>\n                  </li>\n                  <li className=\"flex items-start\">\n                    <Check className=\"h-5 w-5 text-cyan-400 mr-2 mt-0.5 flex-shrink-0\" />\n                    <span>Code typing mode</span>\n                  </li>\n                  <li className=\"flex items-start\">\n                    <Check className=\"h-5 w-5 text-cyan-400 mr-2 mt-0.5 flex-shrink-0\" />\n                    <span>Achievements & challenges</span>\n                  </li>\n                  <li className=\"flex items-start\">\n                    <Check className=\"h-5 w-5 text-cyan-400 mr-2 mt-0.5 flex-shrink-0\" />\n                    <span>All features unlocked</span>\n                  </li>\n                </ul>\n              </div>\n            </div>\n\n            <p className=\"text-lg text-slate-300\">\n              <strong className=\"text-cyan-400\">Bottom line:</strong> Save $99/year per student by choosing TypeMasterAI. For a classroom of 30 students, that's nearly $3,000 in annual savingsâ€”without sacrificing quality or features. In fact, you get advanced AI capabilities that Typing.com doesn't offer at any price.\n            </p>\n          </article>\n        </section>\n\n        {/* FAQ Section */}\n        <section className=\"max-w-4xl mx-auto py-16\">\n          <h2 className=\"text-3xl md:text-4xl font-bold text-center text-white mb-12\">\n            Frequently Asked Questions\n          </h2>\n          \n          <article className=\"space-y-6 text-slate-300\">\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Is TypeMasterAI really 100% free?</h4>\n            <p className=\"text-lg text-slate-300\">\n              Yes! TypeMasterAI is completely free with no subscriptions, trials, or premium tiers. All featuresâ€”AI analytics, multiplayer racing, code typing mode, achievements, and moreâ€”are available to everyone at zero cost. We believe typing education should be accessible to all students regardless of their financial situation.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Do I need to create an account to practice?</h4>\n            <p className=\"text-lg text-slate-300\">\n              No signup required! You can start taking typing tests immediately without creating an account. However, creating a free account lets you save your progress, track improvement over time, earn achievements, and compete on leaderboards. Accounts are optional but recommended for long-term learners.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Does TypeMasterAI have structured lessons like Typing.com?</h4>\n            <p className=\"text-lg text-slate-300\">\n              TypeMasterAI takes a different approach than Typing.com's curriculum-based lessons. Instead of forcing you through pre-set lesson plans, we use AI to analyze your actual typing patterns and create personalized practice recommendations based on your specific weaknesses. This adaptive approach often leads to faster improvement than one-size-fits-all lessons.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Can teachers use TypeMasterAI in the classroom?</h4>\n            <p className=\"text-lg text-slate-300\">\n              Absolutely! Teachers love TypeMasterAI because it's free for all students with no licensing fees. Students can practice at school and at home using the same account. Teachers can organize classroom competitions using multiplayer races or create private race rooms for student assessments. While we don't currently have a dedicated teacher dashboard like Typing.com, the free access for unlimited students makes it ideal for schools and educational programs.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">What makes TypeMasterAI better than Typing.com?</h4>\n            <p className=\"text-lg text-slate-300\">\n              While Typing.com excels at structured curriculum and teacher management tools, TypeMasterAI offers superior analytics, AI-powered personalization, engaging multiplayer features, and specialized modes like code typingâ€”all completely free. If you're a self-motivated learner or want advanced features without subscription costs, TypeMasterAI is the better choice. If you prefer formal lessons with teacher oversight and don't mind paying, Typing.com might suit you. Try both and see which approach works better for your learning style.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">How long does it take to improve my typing speed?</h4>\n            <p className=\"text-lg text-slate-300\">\n              Most students see noticeable improvement within 2-4 weeks of consistent daily practice (15-30 minutes per day). Our AI analytics help you focus on your weakest areas, accelerating improvement compared to generic practice. Beginners typically start around 30-40 WPM and can reach 50-60 WPM within a month. More advanced typists working on speed can often add 10-20 WPM within 2-3 months of targeted practice.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">Is TypeMasterAI suitable for young children?</h4>\n            <p className=\"text-lg text-slate-300\">\n              Yes! Our visual feedback system with color-coded letters helps young learners understand typing in real-time. The gamification featuresâ€”achievements, challenges, and multiplayer racesâ€”keep children engaged without the pressure of grades. Parents appreciate that it's completely free with no ads or inappropriate content. For very young children (under 8), we recommend starting with 1-minute tests and focusing on accuracy over speed.\n            </p>\n\n            <h4 className=\"text-xl font-semibold text-cyan-400 mt-6\">What languages does TypeMasterAI support?</h4>\n            <p className=\"text-lg text-slate-300\">\n              We support 23+ languages including English, Spanish, French, German, Italian, Portuguese, Russian, Chinese, Japanese, Korean, Hindi, and many more. You can switch languages anytime to practice typing in your native language or learn typing in a foreign language you're studying.\n            </p>\n\n            <div className=\"text-center mt-12\">\n              <Link href=\"/\">\n                <Button size=\"lg\" className=\"bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 text-white text-lg px-12 py-6\" data-testid=\"button-start-test-bottom\">\n                  <Zap className=\"mr-2 h-6 w-6\" />\n                  Try TypeMasterAI Free - Better Than Typing.com\n                </Button>\n              </Link>\n            </div>\n          </article>\n        </section>\n\n        {/* Related Pages */}\n        <section className=\"max-w-6xl mx-auto py-16\">\n          <h2 className=\"text-3xl font-bold text-center text-white mb-12\">Compare More Typing Test Platforms</h2>\n          <div className=\"grid md:grid-cols-3 gap-6\">\n            <Link href=\"/monkeytype-alternative\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-monkeytype\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Monkeytype Alternative</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-slate-400\">\n                    See how TypeMasterAI compares to Monkeytype's minimalist approach\n                  </p>\n                </CardContent>\n              </Card>\n            </Link>\n\n            <Link href=\"/typeracer-alternative\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-typeracer\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">Typeracer Alternative</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-slate-400\">\n                    Discover multiplayer racing with instant matchmaking\n                  </p>\n                </CardContent>\n              </Card>\n            </Link>\n\n            <Link href=\"/10fastfingers-alternative\">\n              <Card className=\"bg-slate-800/50 border-slate-700 hover:border-cyan-500 transition-colors cursor-pointer\" data-testid=\"card-10fastfingers\">\n                <CardHeader>\n                  <CardTitle className=\"text-white\">10FastFingers Alternative</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-slate-400\">\n                    Compare our features to 10FastFingers' word-based tests\n                  </p>\n                </CardContent>\n              </Card>\n            </Link>\n          </div>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":37240,"size_tokens":null},"server/notification-job-generator.ts":{"content":"import { DateTime } from 'luxon';\nimport type { IStorage } from './storage';\nimport type { InsertNotificationJob } from '@shared/schema';\n\nexport class NotificationJobGenerator {\n  constructor(private storage: IStorage) {}\n\n  async generateDailyReminderJobs(): Promise<number> {\n    let totalGenerated = 0;\n    let offset = 0;\n    const batchSize = 200;\n\n    while (true) {\n      const userBatch = await this.storage.getUsersWithNotificationPreferences(\n        'daily_reminder',\n        offset,\n        batchSize\n      );\n\n      if (userBatch.length === 0) break;\n\n      const jobs: InsertNotificationJob[] = [];\n      const nowUtc = DateTime.utc();\n\n      for (const { user, preferences } of userBatch) {\n        if (!preferences.dailyReminderTime) continue;\n\n        const [hours, minutes] = preferences.dailyReminderTime.split(':').map(Number);\n        if (isNaN(hours) || isNaN(minutes)) continue;\n\n        const userTimezone = user.timezone || 'UTC';\n        let nextSend = DateTime.now()\n          .setZone(userTimezone)\n          .set({ hour: hours, minute: minutes, second: 0, millisecond: 0 });\n\n        const nextSendUtc = nextSend.toUTC();\n        if (nextSendUtc <= nowUtc) {\n          nextSend = nextSend.plus({ days: 1 });\n        }\n\n        jobs.push({\n          userId: user.id,\n          notificationType: 'daily_reminder',\n          sendAtUtc: nextSend.toUTC().toJSDate(),\n          status: 'pending',\n          attemptCount: 0,\n          payloadMeta: {\n            streak: user.currentStreak,\n            username: user.username,\n            timezone: userTimezone,\n          },\n        });\n      }\n\n      if (jobs.length > 0) {\n        await this.storage.createNotificationJobs(jobs);\n        totalGenerated += jobs.length;\n      }\n\n      offset += batchSize;\n      if (userBatch.length < batchSize) break;\n    }\n\n    return totalGenerated;\n  }\n\n  async generateStreakWarningJobs(): Promise<number> {\n    let totalGenerated = 0;\n    let offset = 0;\n    const batchSize = 200;\n\n    while (true) {\n      const userBatch = await this.storage.getUsersWithNotificationPreferences(\n        'streak_warning',\n        offset,\n        batchSize\n      );\n\n      if (userBatch.length === 0) break;\n\n      const jobs: InsertNotificationJob[] = [];\n      const nowUtc = DateTime.utc();\n\n      for (const { user, preferences } of userBatch) {\n        if (user.currentStreak === 0) continue;\n\n        const userTimezone = user.timezone || 'UTC';\n        const nowUserZone = DateTime.now().setZone(userTimezone);\n\n        if (user.lastTestDate) {\n          const lastTestUserZone = DateTime.fromJSDate(user.lastTestDate).setZone(userTimezone);\n          if (lastTestUserZone.hasSame(nowUserZone, 'day')) {\n            continue;\n          }\n        }\n\n        const reminderTime = preferences.dailyReminderTime || '09:00';\n        const [reminderHour, reminderMinute] = reminderTime.split(':').map(Number);\n        \n        const reminderToday = nowUserZone.set({ \n          hour: reminderHour, \n          minute: reminderMinute || 0, \n          second: 0, \n          millisecond: 0 \n        });\n        \n        const PRIMARY_BUFFER_HOURS = 8;\n        const MIN_BUFFER_MINUTES = 60;\n        \n        const baseline = reminderToday.plus({ hours: PRIMARY_BUFFER_HOURS });\n        const minBuffer = reminderToday.plus({ minutes: MIN_BUFFER_MINUTES });\n        \n        let deadline = DateTime.max(baseline, minBuffer);\n        \n        const sameDayCap = reminderToday.set({ \n          hour: 23, \n          minute: 45, \n          second: 0, \n          millisecond: 0 \n        });\n        \n        if (deadline.hasSame(reminderToday, 'day') && deadline > sameDayCap) {\n          deadline = sameDayCap;\n        }\n        \n        if (!deadline.isValid) {\n          console.error(`[JobGenerator] Invalid deadline for user ${user.id}, skipping`);\n          continue;\n        }\n        \n        let nextSend = deadline;\n        const nextSendUtc = nextSend.toUTC();\n        if (nextSendUtc <= nowUtc) {\n          nextSend = nextSend.plus({ days: 1 });\n        }\n\n        jobs.push({\n          userId: user.id,\n          notificationType: 'streak_warning',\n          sendAtUtc: nextSend.toUTC().toJSDate(),\n          status: 'pending',\n          attemptCount: 0,\n          payloadMeta: {\n            streak: user.currentStreak,\n            username: user.username,\n            timezone: userTimezone,\n          },\n        });\n      }\n\n      if (jobs.length > 0) {\n        await this.storage.createNotificationJobs(jobs);\n        totalGenerated += jobs.length;\n      }\n\n      offset += batchSize;\n      if (userBatch.length < batchSize) break;\n    }\n\n    return totalGenerated;\n  }\n\n  async generateWeeklySummaryJobs(): Promise<number> {\n    let totalGenerated = 0;\n    let offset = 0;\n    const batchSize = 200;\n\n    while (true) {\n      const userBatch = await this.storage.getUsersWithNotificationPreferences(\n        'weekly_summary',\n        offset,\n        batchSize\n      );\n\n      if (userBatch.length === 0) break;\n\n      const jobs: InsertNotificationJob[] = [];\n      const nowUtc = DateTime.utc();\n\n      for (const { user } of userBatch) {\n        const userTimezone = user.timezone || 'UTC';\n        let nextSunday = DateTime.now()\n          .setZone(userTimezone)\n          .set({ weekday: 7, hour: 19, minute: 0, second: 0, millisecond: 0 });\n\n        const nextSundayUtc = nextSunday.toUTC();\n        if (nextSundayUtc <= nowUtc) {\n          nextSunday = nextSunday.plus({ weeks: 1 });\n        }\n\n        jobs.push({\n          userId: user.id,\n          notificationType: 'weekly_summary',\n          sendAtUtc: nextSunday.toUTC().toJSDate(),\n          status: 'pending',\n          attemptCount: 0,\n          payloadMeta: {\n            username: user.username,\n            timezone: userTimezone,\n          },\n        });\n      }\n\n      if (jobs.length > 0) {\n        await this.storage.createNotificationJobs(jobs);\n        totalGenerated += jobs.length;\n      }\n\n      offset += batchSize;\n      if (userBatch.length < batchSize) break;\n    }\n\n    return totalGenerated;\n  }\n\n  async regenerateAllJobs(): Promise<{ daily: number; streak: number; weekly: number }> {\n    console.log('[JobGenerator] Starting job regeneration...');\n\n    const dailyCount = await this.generateDailyReminderJobs();\n    console.log(`[JobGenerator] Generated ${dailyCount} daily reminder jobs`);\n\n    const streakCount = await this.generateStreakWarningJobs();\n    console.log(`[JobGenerator] Generated ${streakCount} streak warning jobs`);\n\n    const weeklyCount = await this.generateWeeklySummaryJobs();\n    console.log(`[JobGenerator] Generated ${weeklyCount} weekly summary jobs`);\n\n    return { daily: dailyCount, streak: streakCount, weekly: weeklyCount };\n  }\n\n\n  async cleanupOldJobs(): Promise<number> {\n    const deleted = await this.storage.deleteCompletedJobsOlderThan(7);\n    console.log(`[JobGenerator] Cleaned up ${deleted} old completed jobs`);\n    return deleted;\n  }\n}\n","path":null,"size_bytes":6977,"size_tokens":null},"client/src/pages/forgot-password.tsx":{"content":"import { useState } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Keyboard, AlertCircle, CheckCircle2, ArrowLeft } from \"lucide-react\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\n\nexport default function ForgotPassword() {\n  const [, setLocation] = useLocation();\n  const [email, setEmail] = useState(\"\");\n  const [error, setError] = useState(\"\");\n  const [success, setSuccess] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(\"\");\n    setIsLoading(true);\n\n    try {\n      const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;\n      const response = await fetch(\"/api/auth/forgot-password\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ email, timezone }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.message || \"Failed to send reset email\");\n      }\n\n      setSuccess(true);\n    } catch (err: any) {\n      setError(err.message || \"Something went wrong. Please try again.\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  if (success) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <div className=\"w-full max-w-md space-y-6\">\n          <div className=\"flex flex-col items-center gap-4\">\n            <div className=\"w-16 h-16 bg-green-500 rounded-2xl flex items-center justify-center text-white\">\n              <CheckCircle2 className=\"w-8 h-8\" />\n            </div>\n            <div className=\"text-center\">\n              <h1 className=\"text-3xl font-bold tracking-tight\">Check Your Email</h1>\n              <p className=\"text-muted-foreground mt-2\">\n                If an account exists with that email, we've sent password reset instructions.\n              </p>\n            </div>\n          </div>\n\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"space-y-4 text-center\">\n                <p className=\"text-sm text-muted-foreground\">\n                  Didn't receive an email? Check your spam folder or try again with a different email address.\n                </p>\n                <div className=\"flex flex-col gap-2\">\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => {\n                      setSuccess(false);\n                      setEmail(\"\");\n                    }}\n                    data-testid=\"button-try-again\"\n                  >\n                    Try Again\n                  </Button>\n                  <Button\n                    onClick={() => setLocation(\"/login\")}\n                    data-testid=\"button-back-to-login\"\n                  >\n                    Back to Login\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n      <div className=\"w-full max-w-md space-y-6\">\n        <div className=\"flex flex-col items-center gap-4\">\n          <div className=\"w-16 h-16 bg-primary rounded-2xl flex items-center justify-center text-primary-foreground\">\n            <Keyboard className=\"w-8 h-8\" />\n          </div>\n          <div className=\"text-center\">\n            <h1 className=\"text-3xl font-bold tracking-tight\">Forgot Password?</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              No worries, we'll send you reset instructions.\n            </p>\n          </div>\n        </div>\n\n        <Card>\n          <form onSubmit={handleSubmit}>\n            <CardHeader>\n              <CardTitle>Reset Password</CardTitle>\n              <CardDescription>\n                Enter your email address and we'll send you a link to reset your password.\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {error && (\n                <Alert variant=\"destructive\">\n                  <AlertCircle className=\"h-4 w-4\" />\n                  <AlertDescription>{error}</AlertDescription>\n                </Alert>\n              )}\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"email\">Email</Label>\n                <Input\n                  id=\"email\"\n                  type=\"email\"\n                  placeholder=\"you@example.com\"\n                  value={email}\n                  onChange={(e) => setEmail(e.target.value)}\n                  required\n                  data-testid=\"input-email\"\n                />\n              </div>\n            </CardContent>\n            <CardFooter className=\"flex flex-col gap-4\">\n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={isLoading}\n                data-testid=\"button-send-reset\"\n              >\n                {isLoading ? \"Sending...\" : \"Send Reset Link\"}\n              </Button>\n              <button\n                type=\"button\"\n                onClick={() => setLocation(\"/login\")}\n                className=\"text-sm text-muted-foreground hover:text-foreground flex items-center gap-2\"\n                data-testid=\"link-back-to-login\"\n              >\n                <ArrowLeft className=\"w-4 h-4\" />\n                Back to login\n              </button>\n            </CardFooter>\n          </form>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":5799,"size_tokens":null},"client/src/pages/verify-email.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation, useSearch } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { CheckCircle2, XCircle, Loader2, Mail } from \"lucide-react\";\n\ntype VerificationState = \"loading\" | \"success\" | \"error\" | \"expired\";\n\nexport default function VerifyEmail() {\n  const [, setLocation] = useLocation();\n  const searchString = useSearch();\n  const [state, setState] = useState<VerificationState>(\"loading\");\n  const [message, setMessage] = useState(\"\");\n\n  useEffect(() => {\n    const params = new URLSearchParams(searchString);\n    const token = params.get(\"token\");\n    \n    if (!token) {\n      setState(\"error\");\n      setMessage(\"No verification token provided.\");\n      return;\n    }\n\n    verifyEmail(token);\n  }, [searchString]);\n\n  const verifyEmail = async (token: string) => {\n    try {\n      const response = await fetch(\"/api/auth/verify-email\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ token }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        if (data.code === \"TOKEN_EXPIRED\") {\n          setState(\"expired\");\n          setMessage(\"This verification link has expired.\");\n        } else {\n          setState(\"error\");\n          setMessage(data.message || \"Failed to verify email.\");\n        }\n        return;\n      }\n\n      setState(\"success\");\n      setMessage(\"Your email has been verified successfully!\");\n    } catch (err) {\n      setState(\"error\");\n      setMessage(\"An error occurred while verifying your email.\");\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n      <div className=\"w-full max-w-md space-y-6\">\n        {state === \"loading\" && (\n          <>\n            <div className=\"flex flex-col items-center gap-4\">\n              <div className=\"w-16 h-16 bg-primary/10 rounded-2xl flex items-center justify-center\">\n                <Loader2 className=\"w-8 h-8 text-primary animate-spin\" />\n              </div>\n              <div className=\"text-center\">\n                <h1 className=\"text-3xl font-bold tracking-tight\">Verifying Email</h1>\n                <p className=\"text-muted-foreground mt-2\">\n                  Please wait while we verify your email address...\n                </p>\n              </div>\n            </div>\n          </>\n        )}\n\n        {state === \"success\" && (\n          <>\n            <div className=\"flex flex-col items-center gap-4\">\n              <div className=\"w-16 h-16 bg-green-500 rounded-2xl flex items-center justify-center text-white\">\n                <CheckCircle2 className=\"w-8 h-8\" />\n              </div>\n              <div className=\"text-center\">\n                <h1 className=\"text-3xl font-bold tracking-tight\">Email Verified!</h1>\n                <p className=\"text-muted-foreground mt-2\">{message}</p>\n              </div>\n            </div>\n\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"space-y-4 text-center\">\n                  <p className=\"text-sm text-muted-foreground\">\n                    Your account is now fully activated. You can access all features of TypeMasterAI.\n                  </p>\n                  <div className=\"flex flex-col gap-2\">\n                    <Button\n                      onClick={() => setLocation(\"/\")}\n                      className=\"w-full\"\n                      data-testid=\"button-start-typing\"\n                    >\n                      Start Typing\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      onClick={() => setLocation(\"/profile\")}\n                      data-testid=\"button-view-profile\"\n                    >\n                      View Profile\n                    </Button>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </>\n        )}\n\n        {state === \"expired\" && (\n          <>\n            <div className=\"flex flex-col items-center gap-4\">\n              <div className=\"w-16 h-16 bg-yellow-500 rounded-2xl flex items-center justify-center text-white\">\n                <Mail className=\"w-8 h-8\" />\n              </div>\n              <div className=\"text-center\">\n                <h1 className=\"text-3xl font-bold tracking-tight\">Link Expired</h1>\n                <p className=\"text-muted-foreground mt-2\">{message}</p>\n              </div>\n            </div>\n\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"space-y-4 text-center\">\n                  <p className=\"text-sm text-muted-foreground\">\n                    Email verification links expire after 24 hours for security reasons. \n                    Please request a new verification email.\n                  </p>\n                  <div className=\"flex flex-col gap-2\">\n                    <Button\n                      onClick={() => setLocation(\"/settings\")}\n                      className=\"w-full\"\n                      data-testid=\"button-resend-verification\"\n                    >\n                      Resend Verification Email\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      onClick={() => setLocation(\"/\")}\n                      data-testid=\"button-go-home\"\n                    >\n                      Go to Homepage\n                    </Button>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </>\n        )}\n\n        {state === \"error\" && (\n          <>\n            <div className=\"flex flex-col items-center gap-4\">\n              <div className=\"w-16 h-16 bg-destructive rounded-2xl flex items-center justify-center text-destructive-foreground\">\n                <XCircle className=\"w-8 h-8\" />\n              </div>\n              <div className=\"text-center\">\n                <h1 className=\"text-3xl font-bold tracking-tight\">Verification Failed</h1>\n                <p className=\"text-muted-foreground mt-2\">{message}</p>\n              </div>\n            </div>\n\n            <Card>\n              <CardContent className=\"pt-6\">\n                <div className=\"space-y-4 text-center\">\n                  <p className=\"text-sm text-muted-foreground\">\n                    If you continue to experience issues, please contact our support team.\n                  </p>\n                  <div className=\"flex flex-col gap-2\">\n                    <Button\n                      onClick={() => setLocation(\"/settings\")}\n                      className=\"w-full\"\n                      data-testid=\"button-request-new-verification\"\n                    >\n                      Request New Verification\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      onClick={() => setLocation(\"/contact\")}\n                      data-testid=\"button-contact-support\"\n                    >\n                      Contact Support\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      onClick={() => setLocation(\"/\")}\n                      data-testid=\"button-go-home\"\n                    >\n                      Go to Homepage\n                    </Button>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":7568,"size_tokens":null},"client/src/pages/reset-password.tsx":{"content":"import { useState, useEffect, useMemo } from \"react\";\nimport { useLocation, useSearch } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Keyboard, AlertCircle, CheckCircle2, XCircle, Eye, EyeOff, Shield } from \"lucide-react\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Progress } from \"@/components/ui/progress\";\n\nexport default function ResetPassword() {\n  const [, setLocation] = useLocation();\n  const searchString = useSearch();\n  const [token, setToken] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [confirmPassword, setConfirmPassword] = useState(\"\");\n  const [showPassword, setShowPassword] = useState(false);\n  const [showConfirmPassword, setShowConfirmPassword] = useState(false);\n  const [error, setError] = useState(\"\");\n  const [success, setSuccess] = useState(false);\n  const [isLoading, setIsLoading] = useState(false);\n  const [isValidToken, setIsValidToken] = useState<boolean | null>(null);\n\n  useEffect(() => {\n    const params = new URLSearchParams(searchString);\n    const tokenParam = params.get(\"token\");\n    if (tokenParam) {\n      setToken(tokenParam);\n      validateToken(tokenParam);\n    } else {\n      setIsValidToken(false);\n    }\n  }, [searchString]);\n\n  const validateToken = async (tokenValue: string) => {\n    try {\n      const response = await fetch(`/api/auth/validate-reset-token?token=${tokenValue}`);\n      const data = await response.json();\n      setIsValidToken(data.valid);\n    } catch (err) {\n      setIsValidToken(false);\n    }\n  };\n\n  const passwordRequirements = useMemo(() => [\n    { check: password.length >= 8, text: \"At least 8 characters\" },\n    { check: /[A-Z]/.test(password), text: \"One uppercase letter\" },\n    { check: /[a-z]/.test(password), text: \"One lowercase letter\" },\n    { check: /[0-9]/.test(password), text: \"One number\" },\n    { check: /[^A-Za-z0-9]/.test(password), text: \"One special character (!@#$%^&*)\" },\n  ], [password]);\n\n  const passwordStrength = useMemo(() => {\n    if (!password) return { score: 0, label: \"\", color: \"\" };\n    \n    let score = 0;\n    if (password.length >= 8) score += 20;\n    if (password.length >= 12) score += 10;\n    if (/[A-Z]/.test(password)) score += 20;\n    if (/[a-z]/.test(password)) score += 15;\n    if (/[0-9]/.test(password)) score += 15;\n    if (/[^A-Za-z0-9]/.test(password)) score += 20;\n    \n    if (score < 40) return { score, label: \"Weak\", color: \"bg-red-500\" };\n    if (score < 60) return { score, label: \"Fair\", color: \"bg-orange-500\" };\n    if (score < 80) return { score, label: \"Good\", color: \"bg-yellow-500\" };\n    return { score: Math.min(score, 100), label: \"Strong\", color: \"bg-green-500\" };\n  }, [password]);\n\n  const validatePassword = () => {\n    const errors: string[] = [];\n    if (password.length < 8) errors.push(\"At least 8 characters\");\n    if (!/[A-Z]/.test(password)) errors.push(\"One uppercase letter\");\n    if (!/[a-z]/.test(password)) errors.push(\"One lowercase letter\");\n    if (!/[0-9]/.test(password)) errors.push(\"One number\");\n    if (!/[^A-Za-z0-9]/.test(password)) errors.push(\"One special character\");\n    return errors;\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(\"\");\n\n    if (password !== confirmPassword) {\n      setError(\"Passwords do not match\");\n      return;\n    }\n\n    const passwordErrors = validatePassword();\n    if (passwordErrors.length > 0) {\n      setError(`Password must have: ${passwordErrors.join(\", \")}`);\n      return;\n    }\n\n    setIsLoading(true);\n\n    try {\n      const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;\n      const response = await fetch(\"/api/auth/reset-password\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ token, password, timezone }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.message || \"Failed to reset password\");\n      }\n\n      setSuccess(true);\n    } catch (err: any) {\n      setError(err.message || \"Something went wrong. Please try again.\");\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  if (isValidToken === null) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4\"></div>\n          <p className=\"text-muted-foreground\">Validating reset link...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (isValidToken === false) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <div className=\"w-full max-w-md space-y-6\">\n          <div className=\"flex flex-col items-center gap-4\">\n            <div className=\"w-16 h-16 bg-destructive rounded-2xl flex items-center justify-center text-destructive-foreground\">\n              <XCircle className=\"w-8 h-8\" />\n            </div>\n            <div className=\"text-center\">\n              <h1 className=\"text-3xl font-bold tracking-tight\">Invalid or Expired Link</h1>\n              <p className=\"text-muted-foreground mt-2\">\n                This password reset link is invalid or has expired.\n              </p>\n            </div>\n          </div>\n\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"space-y-4 text-center\">\n                <p className=\"text-sm text-muted-foreground\">\n                  Password reset links expire after 1 hour for security reasons. Please request a new link.\n                </p>\n                <div className=\"flex flex-col gap-2\">\n                  <Button\n                    onClick={() => setLocation(\"/forgot-password\")}\n                    data-testid=\"button-request-new-link\"\n                  >\n                    Request New Link\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => setLocation(\"/login\")}\n                    data-testid=\"button-back-to-login\"\n                  >\n                    Back to Login\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  if (success) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n        <div className=\"w-full max-w-md space-y-6\">\n          <div className=\"flex flex-col items-center gap-4\">\n            <div className=\"w-16 h-16 bg-green-500 rounded-2xl flex items-center justify-center text-white\">\n              <CheckCircle2 className=\"w-8 h-8\" />\n            </div>\n            <div className=\"text-center\">\n              <h1 className=\"text-3xl font-bold tracking-tight\">Password Reset!</h1>\n              <p className=\"text-muted-foreground mt-2\">\n                Your password has been successfully reset.\n              </p>\n            </div>\n          </div>\n\n          <Card>\n            <CardContent className=\"pt-6\">\n              <div className=\"space-y-4 text-center\">\n                <p className=\"text-sm text-muted-foreground\">\n                  You can now log in with your new password.\n                </p>\n                <Button\n                  onClick={() => setLocation(\"/login\")}\n                  className=\"w-full\"\n                  data-testid=\"button-go-to-login\"\n                >\n                  Go to Login\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\n      <div className=\"w-full max-w-md space-y-6\">\n        <div className=\"flex flex-col items-center gap-4\">\n          <div className=\"w-16 h-16 bg-primary rounded-2xl flex items-center justify-center text-primary-foreground\">\n            <Keyboard className=\"w-8 h-8\" />\n          </div>\n          <div className=\"text-center\">\n            <h1 className=\"text-3xl font-bold tracking-tight\">Set New Password</h1>\n            <p className=\"text-muted-foreground mt-2\">\n              Create a strong password for your account.\n            </p>\n          </div>\n        </div>\n\n        <Card>\n          <form onSubmit={handleSubmit}>\n            <CardHeader>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Shield className=\"w-5 h-5 text-primary\" />\n                New Password\n              </CardTitle>\n              <CardDescription>\n                Create a strong password with at least 8 characters, including uppercase, lowercase, number, and special character.\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {error && (\n                <Alert variant=\"destructive\">\n                  <AlertCircle className=\"h-4 w-4\" />\n                  <AlertDescription>{error}</AlertDescription>\n                </Alert>\n              )}\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"password\">New Password</Label>\n                <div className=\"relative\">\n                  <Input\n                    id=\"password\"\n                    type={showPassword ? \"text\" : \"password\"}\n                    placeholder=\"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\"\n                    value={password}\n                    onChange={(e) => setPassword(e.target.value)}\n                    required\n                    data-testid=\"input-password\"\n                  />\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowPassword(!showPassword)}\n                    className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n                    data-testid=\"button-toggle-password\"\n                  >\n                    {showPassword ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n                  </button>\n                </div>\n                {password && (\n                  <div className=\"mt-3 space-y-3\">\n                    <div className=\"space-y-1\">\n                      <div className=\"flex justify-between text-xs\">\n                        <span className=\"text-muted-foreground\">Password strength</span>\n                        <span className={`font-medium ${\n                          passwordStrength.label === \"Weak\" ? \"text-red-500\" :\n                          passwordStrength.label === \"Fair\" ? \"text-orange-500\" :\n                          passwordStrength.label === \"Good\" ? \"text-yellow-600\" :\n                          \"text-green-500\"\n                        }`}>\n                          {passwordStrength.label}\n                        </span>\n                      </div>\n                      <div className=\"h-2 w-full bg-muted rounded-full overflow-hidden\">\n                        <div \n                          className={`h-full transition-all duration-300 ${passwordStrength.color}`}\n                          style={{ width: `${passwordStrength.score}%` }}\n                        />\n                      </div>\n                    </div>\n                    <ul className=\"text-xs space-y-1\">\n                      {passwordRequirements.map(({ check, text }) => (\n                        <li key={text} className={`flex items-center gap-1.5 ${check ? \"text-green-600\" : \"text-muted-foreground\"}`}>\n                          {check ? <CheckCircle2 className=\"w-3.5 h-3.5\" /> : <XCircle className=\"w-3.5 h-3.5\" />}\n                          {text}\n                        </li>\n                      ))}\n                    </ul>\n                  </div>\n                )}\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"confirmPassword\">Confirm New Password</Label>\n                <div className=\"relative\">\n                  <Input\n                    id=\"confirmPassword\"\n                    type={showConfirmPassword ? \"text\" : \"password\"}\n                    placeholder=\"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢\"\n                    value={confirmPassword}\n                    onChange={(e) => setConfirmPassword(e.target.value)}\n                    required\n                    data-testid=\"input-confirm-password\"\n                  />\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowConfirmPassword(!showConfirmPassword)}\n                    className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground\"\n                    data-testid=\"button-toggle-confirm-password\"\n                  >\n                    {showConfirmPassword ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n                  </button>\n                </div>\n                {confirmPassword && (\n                  <p className={`text-xs ${password === confirmPassword ? \"text-green-600\" : \"text-destructive\"}`}>\n                    {password === confirmPassword ? \"Passwords match\" : \"Passwords do not match\"}\n                  </p>\n                )}\n              </div>\n            </CardContent>\n            <CardFooter>\n              <Button\n                type=\"submit\"\n                className=\"w-full\"\n                disabled={isLoading || validatePassword().length > 0 || password !== confirmPassword}\n                data-testid=\"button-reset-password\"\n              >\n                {isLoading ? \"Resetting...\" : \"Reset Password\"}\n              </Button>\n            </CardFooter>\n          </form>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":13855,"size_tokens":null},"client/src/components/share-card.tsx":{"content":"import { useRef, useEffect, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Download, Share2, Copy, Check, Twitter, Facebook, MessageCircle, Mail, Send, Image, Clipboard } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface ShareCardProps {\n  wpm: number;\n  accuracy: number;\n  mode: number;\n  language: string;\n  username?: string;\n  freestyle?: boolean;\n  consistency?: number;\n  words?: number;\n  characters?: number;\n  onClose?: () => void;\n  onShareTracked?: (platform: string) => void;\n}\n\nexport function ShareCard({ wpm, accuracy, mode, language, username, freestyle = false, consistency = 100, words = 0, characters = 0, onClose, onShareTracked }: ShareCardProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [isSharing, setIsSharing] = useState(false);\n  const [copied, setCopied] = useState(false);\n  const { toast } = useToast();\n\n  const getPerformanceRating = () => {\n    // For Freestyle, use WPM and consistency instead of accuracy\n    if (freestyle) {\n      if (wpm >= 100 && consistency >= 85) return { emoji: \"ðŸ†\", title: \"Freestyle Master\", badge: \"Diamond\", color: \"#b9f2ff\", bgGradient: [\"#0f172a\", \"#1e3a5f\", \"#0f172a\"] };\n      if (wpm >= 80 && consistency >= 75) return { emoji: \"âš¡\", title: \"Speed Demon\", badge: \"Platinum\", color: \"#e5e4e2\", bgGradient: [\"#0f172a\", \"#2d3748\", \"#0f172a\"] };\n      if (wpm >= 60 && consistency >= 65) return { emoji: \"ðŸ”¥\", title: \"Fast & Steady\", badge: \"Gold\", color: \"#ffd700\", bgGradient: [\"#0f172a\", \"#3d2914\", \"#0f172a\"] };\n      if (wpm >= 40) return { emoji: \"ðŸ’ª\", title: \"Solid Performer\", badge: \"Silver\", color: \"#c0c0c0\", bgGradient: [\"#0f172a\", \"#374151\", \"#0f172a\"] };\n      return { emoji: \"ðŸŽ¯\", title: \"Rising Star\", badge: \"Bronze\", color: \"#cd7f32\", bgGradient: [\"#0f172a\", \"#3d2a1a\", \"#0f172a\"] };\n    }\n    // Standard mode ratings\n    if (wpm >= 100 && accuracy >= 98) return { emoji: \"ðŸ†\", title: \"Legendary Typist\", badge: \"Diamond\", color: \"#b9f2ff\", bgGradient: [\"#0f172a\", \"#1e3a5f\", \"#0f172a\"] };\n    if (wpm >= 80 && accuracy >= 95) return { emoji: \"âš¡\", title: \"Speed Demon\", badge: \"Platinum\", color: \"#e5e4e2\", bgGradient: [\"#0f172a\", \"#2d3748\", \"#0f172a\"] };\n    if (wpm >= 60 && accuracy >= 90) return { emoji: \"ðŸ”¥\", title: \"Fast & Accurate\", badge: \"Gold\", color: \"#ffd700\", bgGradient: [\"#0f172a\", \"#3d2914\", \"#0f172a\"] };\n    if (wpm >= 40 && accuracy >= 85) return { emoji: \"ðŸ’ª\", title: \"Solid Performer\", badge: \"Silver\", color: \"#c0c0c0\", bgGradient: [\"#0f172a\", \"#374151\", \"#0f172a\"] };\n    return { emoji: \"ðŸŽ¯\", title: \"Rising Star\", badge: \"Bronze\", color: \"#cd7f32\", bgGradient: [\"#0f172a\", \"#3d2a1a\", \"#0f172a\"] };\n  };\n\n  useEffect(() => {\n    generateCard();\n  }, [wpm, accuracy, mode, language, username, freestyle, consistency, words, characters]);\n\n  const generateCard = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const ctx = canvas.getContext(\"2d\");\n    if (!ctx) return;\n\n    const rating = getPerformanceRating();\n    const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)}min` : `${mode}s`;\n\n    canvas.width = 600;\n    canvas.height = 400;\n\n    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);\n    gradient.addColorStop(0, rating.bgGradient[0]);\n    gradient.addColorStop(0.5, rating.bgGradient[1]);\n    gradient.addColorStop(1, rating.bgGradient[2]);\n    ctx.fillStyle = gradient;\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n\n    ctx.strokeStyle = \"#00ffff\";\n    ctx.lineWidth = 3;\n    ctx.strokeRect(15, 15, canvas.width - 30, canvas.height - 30);\n\n    ctx.strokeStyle = rating.color;\n    ctx.lineWidth = 1;\n    ctx.strokeRect(25, 25, canvas.width - 50, canvas.height - 50);\n\n    ctx.fillStyle = \"#00ffff\";\n    ctx.font = \"bold 16px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"left\";\n    ctx.fillText(\"TypeMasterAI\", 40, 55);\n\n    ctx.fillStyle = rating.color;\n    ctx.font = \"12px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"right\";\n    ctx.fillText(`${rating.emoji} ${rating.badge}`, canvas.width - 40, 55);\n\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 72px 'JetBrains Mono', monospace\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(`${wpm}`, canvas.width / 2, 150);\n\n    ctx.fillStyle = \"#00ffff\";\n    ctx.font = \"24px 'DM Sans', sans-serif\";\n    ctx.fillText(\"WPM\", canvas.width / 2, 180);\n\n    ctx.fillStyle = \"#94a3b8\";\n    ctx.font = \"18px 'DM Sans', sans-serif\";\n    ctx.fillText(rating.title, canvas.width / 2, 215);\n\n    const statsY = 260;\n    ctx.fillStyle = \"rgba(30, 41, 59, 0.8)\";\n    ctx.fillRect(40, statsY - 25, canvas.width - 80, 60);\n    ctx.strokeStyle = rating.color;\n    ctx.lineWidth = 1;\n    ctx.strokeRect(40, statsY - 25, canvas.width - 80, 60);\n\n    if (freestyle) {\n      // Freestyle mode: show Consistency, Words, Characters\n      ctx.font = \"bold 20px 'JetBrains Mono', monospace\";\n      ctx.fillStyle = \"#22c55e\";\n      ctx.textAlign = \"center\";\n      ctx.fillText(`${consistency}%`, 140, statsY + 8);\n      ctx.fillStyle = \"#64748b\";\n      ctx.font = \"12px 'DM Sans', sans-serif\";\n      ctx.fillText(\"Consistency\", 140, statsY + 25);\n\n      ctx.font = \"bold 20px 'JetBrains Mono', monospace\";\n      ctx.fillStyle = \"#a855f7\";\n      ctx.fillText(`${words}`, canvas.width / 2, statsY + 8);\n      ctx.fillStyle = \"#64748b\";\n      ctx.font = \"12px 'DM Sans', sans-serif\";\n      ctx.fillText(\"Words\", canvas.width / 2, statsY + 25);\n\n      ctx.font = \"bold 20px 'JetBrains Mono', monospace\";\n      ctx.fillStyle = \"#f59e0b\";\n      ctx.fillText(`${characters}`, canvas.width - 140, statsY + 8);\n      ctx.fillStyle = \"#64748b\";\n      ctx.font = \"12px 'DM Sans', sans-serif\";\n      ctx.fillText(\"Characters\", canvas.width - 140, statsY + 25);\n    } else {\n      // Standard mode: show Accuracy, Duration, Language\n      ctx.font = \"bold 20px 'JetBrains Mono', monospace\";\n      ctx.fillStyle = \"#22c55e\";\n      ctx.textAlign = \"center\";\n      ctx.fillText(`${accuracy}%`, 140, statsY + 8);\n      ctx.fillStyle = \"#64748b\";\n      ctx.font = \"12px 'DM Sans', sans-serif\";\n      ctx.fillText(\"Accuracy\", 140, statsY + 25);\n\n      ctx.font = \"bold 20px 'JetBrains Mono', monospace\";\n      ctx.fillStyle = \"#a855f7\";\n      ctx.fillText(modeDisplay, canvas.width / 2, statsY + 8);\n      ctx.fillStyle = \"#64748b\";\n      ctx.font = \"12px 'DM Sans', sans-serif\";\n      ctx.fillText(\"Duration\", canvas.width / 2, statsY + 25);\n\n      ctx.font = \"bold 20px 'JetBrains Mono', monospace\";\n      ctx.fillStyle = \"#f59e0b\";\n      ctx.fillText(language.toUpperCase(), canvas.width - 140, statsY + 8);\n      ctx.fillStyle = \"#64748b\";\n      ctx.font = \"12px 'DM Sans', sans-serif\";\n      ctx.fillText(\"Language\", canvas.width - 140, statsY + 25);\n    }\n\n    if (username) {\n      ctx.fillStyle = \"#94a3b8\";\n      ctx.font = \"14px 'DM Sans', sans-serif\";\n      ctx.textAlign = \"center\";\n      ctx.fillText(`@${username}`, canvas.width / 2, 340);\n    }\n\n    ctx.fillStyle = \"#a855f7\";\n    ctx.font = \"bold 14px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"typemasterai.com\", canvas.width / 2, 375);\n\n    ctx.fillStyle = \"#64748b\";\n    ctx.font = \"10px 'DM Sans', sans-serif\";\n    ctx.fillText(\"Can you beat my score? ðŸŽ¯\", canvas.width / 2, 390);\n  };\n\n  const downloadCard = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const link = document.createElement(\"a\");\n    link.download = `TypeMasterAI_${wpm}WPM_${accuracy}acc.png`;\n    link.href = canvas.toDataURL(\"image/png\");\n    link.click();\n    \n    onShareTracked?.('visual_card_download');\n    \n    toast({\n      title: \"Card Downloaded!\",\n      description: \"Share it on social media to challenge your friends!\",\n    });\n  };\n\n  const shareCard = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    setIsSharing(true);\n    try {\n      const blob = await new Promise<Blob>((resolve, reject) => {\n        canvas.toBlob((blob) => {\n          if (blob) resolve(blob);\n          else reject(new Error(\"Failed to create blob\"));\n        }, \"image/png\");\n      });\n\n      const file = new File([blob], `TypeMasterAI_${wpm}WPM.png`, { type: \"image/png\" });\n      const rating = getPerformanceRating();\n      const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n\n      if ('share' in navigator && navigator.canShare?.({ files: [file] })) {\n        const shareText = freestyle\n          ? `${rating.emoji} I scored ${wpm} WPM with ${consistency}% consistency in Freestyle mode on TypeMasterAI!\\n\\nðŸ… ${rating.title} - ${rating.badge} Badge\\nâ±ï¸ ${modeDisplay} session\\nâœï¸ ${words} words, ${characters} characters\\n\\nCan you beat my score?\\n\\nðŸ”— typemasterai.com`\n          : `${rating.emoji} I scored ${wpm} WPM with ${accuracy}% accuracy on TypeMasterAI!\\n\\nðŸ… ${rating.title} - ${rating.badge} Badge\\nâ±ï¸ ${modeDisplay} test\\n\\nCan you beat my score?\\n\\nðŸ”— typemasterai.com`;\n        await navigator.share({\n          title: `TypeMasterAI - ${wpm} WPM`,\n          text: shareText,\n          files: [file],\n        });\n        onShareTracked?.('visual_card_native');\n        toast({\n          title: \"Shared Successfully!\",\n          description: \"Your achievement is on its way to inspire others!\",\n        });\n      } else {\n        downloadCard();\n      }\n    } catch (error: any) {\n      if (error.name !== 'AbortError') {\n        downloadCard();\n      }\n    } finally {\n      setIsSharing(false);\n    }\n  };\n\n  const [imageCopied, setImageCopied] = useState(false);\n\n  const copyImageToClipboard = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    try {\n      const blob = await new Promise<Blob>((resolve, reject) => {\n        canvas.toBlob((blob) => {\n          if (blob) resolve(blob);\n          else reject(new Error(\"Failed to create blob\"));\n        }, \"image/png\");\n      });\n\n      await navigator.clipboard.write([\n        new ClipboardItem({ \"image/png\": blob })\n      ]);\n      \n      setImageCopied(true);\n      setTimeout(() => setImageCopied(false), 2000);\n      onShareTracked?.('visual_card_copy_image');\n      toast({\n        title: \"Image Copied!\",\n        description: \"Paste directly into Twitter, Discord, or any app that supports images!\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Copy Failed\",\n        description: \"Your browser doesn't support image copying. Please download instead.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const copyShareText = () => {\n    const rating = getPerformanceRating();\n    const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n    const text = freestyle \n      ? `${rating.emoji} I just scored ${wpm} WPM in Freestyle mode on TypeMasterAI!\n\nâŒ¨ï¸ ${wpm} WPM | ðŸ“ˆ ${consistency}% Consistency\nâœï¸ ${words} words | ${characters} characters\nðŸ… ${rating.title} - ${rating.badge} Badge\nâ±ï¸ ${modeDisplay} freestyle session\n\nThink you can beat my score? Try it now! ðŸŽ¯\n\nðŸ”— https://typemasterai.com\n\n#TypingTest #TypeMasterAI #FreestyleTyping #WPM`\n      : `${rating.emoji} I just scored ${wpm} WPM with ${accuracy}% accuracy on TypeMasterAI!\n\nâŒ¨ï¸ ${wpm} WPM | âœ¨ ${accuracy}% Accuracy\nðŸ… ${rating.title} - ${rating.badge} Badge\nâ±ï¸ ${modeDisplay} typing test\n\nThink you can beat my score? Try it now! ðŸŽ¯\n\nðŸ”— https://typemasterai.com\n\n#TypingTest #TypeMasterAI #WPM`;\n\n    navigator.clipboard.writeText(text);\n    setCopied(true);\n    setTimeout(() => setCopied(false), 2000);\n    onShareTracked?.('visual_card_copy');\n    toast({\n      title: \"Copied!\",\n      description: \"Share text copied to clipboard.\",\n    });\n  };\n\n  const getShareText = () => {\n    const rating = getPerformanceRating();\n    const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n    return freestyle\n      ? `${rating.emoji} I scored ${wpm} WPM with ${consistency}% consistency in Freestyle mode on TypeMasterAI! ${rating.badge} Badge - ${modeDisplay} session. Can you beat me?`\n      : `${rating.emoji} I scored ${wpm} WPM with ${accuracy}% accuracy on TypeMasterAI! ${rating.badge} Badge - ${modeDisplay} test. Can you beat me?`;\n  };\n\n  const shareToTwitter = () => {\n    const text = encodeURIComponent(getShareText());\n    window.open(`https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent('https://typemasterai.com')}`, '_blank', 'width=600,height=400');\n    onShareTracked?.('visual_card_twitter');\n  };\n\n  const shareToFacebook = () => {\n    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent('https://typemasterai.com')}&quote=${encodeURIComponent(getShareText())}`, '_blank', 'width=600,height=400');\n    onShareTracked?.('visual_card_facebook');\n  };\n\n  const shareToWhatsApp = () => {\n    const fullText = getShareText() + '\\n\\nðŸ”— https://typemasterai.com';\n    window.open(`https://wa.me/?text=${encodeURIComponent(fullText)}`, '_blank', 'width=600,height=400');\n    onShareTracked?.('visual_card_whatsapp');\n  };\n\n  const shareToReddit = () => {\n    const title = encodeURIComponent(`I scored ${wpm} WPM on TypeMasterAI!`);\n    window.open(`https://www.reddit.com/submit?url=${encodeURIComponent('https://typemasterai.com')}&title=${title}`, '_blank', 'width=600,height=600');\n    onShareTracked?.('visual_card_reddit');\n  };\n\n  const shareToTelegram = () => {\n    const text = getShareText();\n    window.open(`https://t.me/share/url?url=${encodeURIComponent('https://typemasterai.com')}&text=${encodeURIComponent(text)}`, '_blank', 'width=600,height=400');\n    onShareTracked?.('visual_card_telegram');\n  };\n\n  const shareViaEmail = () => {\n    const subject = encodeURIComponent(`I scored ${wpm} WPM on TypeMasterAI!`);\n    const body = encodeURIComponent(`${getShareText()}\\n\\nTry it yourself: https://typemasterai.com`);\n    window.open(`mailto:?subject=${subject}&body=${body}`);\n    onShareTracked?.('visual_card_email');\n  };\n\n  return (\n    <div className=\"flex flex-col items-center gap-4\">\n      <canvas\n        ref={canvasRef}\n        className=\"rounded-xl shadow-2xl max-w-full h-auto border border-primary/20\"\n        style={{ maxWidth: \"100%\", height: \"auto\" }}\n      />\n      \n      {/* Image Sharing Section */}\n      <div className=\"w-full space-y-3\">\n        <div className=\"p-3 bg-gradient-to-r from-purple-500/10 to-pink-500/10 rounded-xl border border-purple-500/20\">\n          <p className=\"text-xs text-center text-purple-300 font-medium mb-2\">Share This Image</p>\n          <div className=\"grid grid-cols-2 gap-2\">\n            <Button\n              onClick={copyImageToClipboard}\n              variant=\"outline\"\n              className=\"gap-2 bg-purple-500/10 border-purple-500/30 hover:bg-purple-500/20\"\n              data-testid=\"button-copy-image\"\n            >\n              {imageCopied ? <Check className=\"w-4 h-4 text-green-500\" /> : <Clipboard className=\"w-4 h-4 text-purple-400\" />}\n              {imageCopied ? \"Copied!\" : \"Copy Image\"}\n            </Button>\n            <Button\n              onClick={downloadCard}\n              variant=\"outline\"\n              className=\"gap-2 bg-blue-500/10 border-blue-500/30 hover:bg-blue-500/20\"\n              data-testid=\"button-download-card\"\n            >\n              <Download className=\"w-4 h-4 text-blue-400\" />\n              Download\n            </Button>\n          </div>\n          <p className=\"text-[10px] text-center text-muted-foreground mt-2\">\n            Copy image and paste directly into Twitter, Discord, or any social app\n          </p>\n        </div>\n\n        {/* Native Share (Mobile) */}\n        {'share' in navigator && (\n          <Button\n            onClick={shareCard}\n            disabled={isSharing}\n            className=\"w-full gap-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600\"\n            data-testid=\"button-share-card\"\n          >\n            <Share2 className=\"w-4 h-4\" />\n            {isSharing ? \"Sharing...\" : \"Share Image (Mobile/Desktop Apps)\"}\n          </Button>\n        )}\n      </div>\n\n      {/* Quick Text Share Section */}\n      <div className=\"w-full space-y-2\">\n        <p className=\"text-xs text-center text-muted-foreground uppercase tracking-wide\">Or Share with Text + Link</p>\n        <div className=\"grid grid-cols-3 gap-2\">\n          <button\n            onClick={shareToTwitter}\n            className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#1DA1F2]/10 hover:bg-[#1DA1F2]/25 border border-[#1DA1F2]/20 transition-all\"\n            data-testid=\"button-visual-share-twitter\"\n          >\n            <Twitter className=\"w-4 h-4 text-[#1DA1F2]\" />\n            <span className=\"text-xs font-medium\">Twitter</span>\n          </button>\n          <button\n            onClick={shareToFacebook}\n            className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#1877F2]/10 hover:bg-[#1877F2]/25 border border-[#1877F2]/20 transition-all\"\n            data-testid=\"button-visual-share-facebook\"\n          >\n            <Facebook className=\"w-4 h-4 text-[#1877F2]\" />\n            <span className=\"text-xs font-medium\">Facebook</span>\n          </button>\n          <button\n            onClick={shareToWhatsApp}\n            className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#25D366]/10 hover:bg-[#25D366]/25 border border-[#25D366]/20 transition-all\"\n            data-testid=\"button-visual-share-whatsapp\"\n          >\n            <MessageCircle className=\"w-4 h-4 text-[#25D366]\" />\n            <span className=\"text-xs font-medium\">WhatsApp</span>\n          </button>\n          <button\n            onClick={shareToReddit}\n            className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#FF4500]/10 hover:bg-[#FF4500]/25 border border-[#FF4500]/20 transition-all\"\n            data-testid=\"button-visual-share-reddit\"\n          >\n            <svg className=\"w-4 h-4 text-[#FF4500]\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n              <path d=\"M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z\"/>\n            </svg>\n            <span className=\"text-xs font-medium\">Reddit</span>\n          </button>\n          <button\n            onClick={shareToTelegram}\n            className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#0088cc]/10 hover:bg-[#0088cc]/25 border border-[#0088cc]/20 transition-all\"\n            data-testid=\"button-visual-share-telegram\"\n          >\n            <Send className=\"w-4 h-4 text-[#0088cc]\" />\n            <span className=\"text-xs font-medium\">Telegram</span>\n          </button>\n          <button\n            onClick={shareViaEmail}\n            className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-gray-500/10 hover:bg-gray-500/25 border border-gray-500/20 transition-all\"\n            data-testid=\"button-visual-share-email\"\n          >\n            <Mail className=\"w-4 h-4 text-gray-400\" />\n            <span className=\"text-xs font-medium\">Email</span>\n          </button>\n        </div>\n        \n        {/* Copy Text Button */}\n        <button\n          onClick={copyShareText}\n          className=\"w-full py-2 mt-2 bg-secondary/50 hover:bg-secondary text-secondary-foreground rounded-lg text-sm flex items-center justify-center gap-2 transition-all\"\n          data-testid=\"button-copy-share-text\"\n        >\n          {copied ? <Check className=\"w-4 h-4 text-green-500\" /> : <Copy className=\"w-4 h-4\" />}\n          {copied ? \"Text Copied!\" : \"Copy Share Text\"}\n        </button>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":20577,"size_tokens":null},"client/src/components/CodeShareCard.tsx":{"content":"import { useRef, useEffect, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Download, Share2, Check, Clipboard } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { \n  getCodePerformanceRating, \n  getLanguageIcon, \n  drawCardBackground,\n  triggerCelebration,\n  CARD_DIMENSIONS \n} from \"@/lib/share-utils\";\n\ninterface CodeShareCardProps {\n  wpm: number;\n  rawWpm: number;\n  accuracy: number;\n  consistency: number;\n  language: string;\n  languageName: string;\n  difficulty: string;\n  characters: number;\n  errors: number;\n  time: string;\n  username?: string;\n  onShareTracked?: (platform: string) => void;\n}\n\nexport function CodeShareCard({ \n  wpm, \n  rawWpm,\n  accuracy, \n  consistency,\n  language,\n  languageName,\n  difficulty,\n  characters,\n  errors,\n  time,\n  username, \n  onShareTracked \n}: CodeShareCardProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [isSharing, setIsSharing] = useState(false);\n  const [imageCopied, setImageCopied] = useState(false);\n  const { toast } = useToast();\n\n  const rating = getCodePerformanceRating(wpm, accuracy);\n  const langIcon = getLanguageIcon(language);\n\n  useEffect(() => {\n    generateCard();\n  }, [wpm, rawWpm, accuracy, consistency, language, languageName, difficulty, characters, errors, time, username]);\n\n  const generateCard = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const ctx = canvas.getContext(\"2d\");\n    if (!ctx) return;\n\n    const dims = CARD_DIMENSIONS.code;\n    canvas.width = dims.width;\n    canvas.height = dims.height;\n\n    drawCardBackground(ctx, canvas, rating);\n\n    ctx.fillStyle = \"#00ffff\";\n    ctx.font = \"bold 16px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"left\";\n    ctx.fillText(\"TypeMasterAI - Code Mode\", 40, 55);\n\n    ctx.fillStyle = rating.color;\n    ctx.font = \"12px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"right\";\n    ctx.fillText(`${rating.emoji} ${rating.badge}`, canvas.width - 40, 55);\n\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 72px 'JetBrains Mono', monospace\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(`${wpm}`, canvas.width / 2, 140);\n\n    ctx.fillStyle = \"#00ffff\";\n    ctx.font = \"24px 'DM Sans', sans-serif\";\n    ctx.fillText(\"WPM\", canvas.width / 2, 170);\n\n    ctx.fillStyle = \"#94a3b8\";\n    ctx.font = \"18px 'DM Sans', sans-serif\";\n    ctx.fillText(rating.title, canvas.width / 2, 200);\n\n    const statsY = 250;\n    ctx.fillStyle = \"rgba(30, 41, 59, 0.8)\";\n    ctx.fillRect(40, statsY - 25, canvas.width - 80, 60);\n    ctx.strokeStyle = rating.color;\n    ctx.lineWidth = 1;\n    ctx.strokeRect(40, statsY - 25, canvas.width - 80, 60);\n\n    const statPositions = [90, 180, 280, 380, 480];\n    \n    ctx.font = \"bold 18px 'JetBrains Mono', monospace\";\n    ctx.fillStyle = \"#22c55e\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(`${accuracy}%`, statPositions[0], statsY + 8);\n    ctx.fillStyle = \"#64748b\";\n    ctx.font = \"10px 'DM Sans', sans-serif\";\n    ctx.fillText(\"Accuracy\", statPositions[0], statsY + 22);\n\n    ctx.font = \"bold 18px 'JetBrains Mono', monospace\";\n    ctx.fillStyle = \"#a855f7\";\n    ctx.fillText(`${rawWpm}`, statPositions[1], statsY + 8);\n    ctx.fillStyle = \"#64748b\";\n    ctx.font = \"10px 'DM Sans', sans-serif\";\n    ctx.fillText(\"Raw WPM\", statPositions[1], statsY + 22);\n\n    ctx.font = \"bold 18px 'JetBrains Mono', monospace\";\n    ctx.fillStyle = \"#22c55e\";\n    ctx.fillText(`${consistency}%`, statPositions[2], statsY + 8);\n    ctx.fillStyle = \"#64748b\";\n    ctx.font = \"10px 'DM Sans', sans-serif\";\n    ctx.fillText(\"Consistency\", statPositions[2], statsY + 22);\n\n    ctx.font = \"bold 18px 'JetBrains Mono', monospace\";\n    ctx.fillStyle = errors > 0 ? \"#ef4444\" : \"#22c55e\";\n    ctx.fillText(`${errors}`, statPositions[3], statsY + 8);\n    ctx.fillStyle = \"#64748b\";\n    ctx.font = \"10px 'DM Sans', sans-serif\";\n    ctx.fillText(\"Errors\", statPositions[3], statsY + 22);\n\n    ctx.font = \"bold 18px 'JetBrains Mono', monospace\";\n    ctx.fillStyle = \"#3b82f6\";\n    ctx.fillText(`${characters}`, statPositions[4], statsY + 8);\n    ctx.fillStyle = \"#64748b\";\n    ctx.font = \"10px 'DM Sans', sans-serif\";\n    ctx.fillText(\"Chars\", statPositions[4], statsY + 22);\n\n    const langY = 340;\n    ctx.fillStyle = \"rgba(30, 41, 59, 0.6)\";\n    ctx.fillRect(130, langY - 20, 340, 40);\n    ctx.strokeStyle = \"#3b82f6\";\n    ctx.lineWidth = 1;\n    ctx.strokeRect(130, langY - 20, 340, 40);\n\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 16px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(`${langIcon} ${languageName}`, canvas.width / 2 - 50, langY + 6);\n    \n    ctx.fillStyle = \"#64748b\";\n    ctx.font = \"12px 'DM Sans', sans-serif\";\n    ctx.fillText(`â€¢ ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} â€¢ ${time}`, canvas.width / 2 + 80, langY + 6);\n\n    if (username) {\n      ctx.fillStyle = \"#94a3b8\";\n      ctx.font = \"14px 'DM Sans', sans-serif\";\n      ctx.textAlign = \"center\";\n      ctx.fillText(`@${username}`, canvas.width / 2, 390);\n    }\n\n    ctx.fillStyle = \"#a855f7\";\n    ctx.font = \"bold 14px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"typemasterai.com/code-mode\", canvas.width / 2, 420);\n\n    ctx.fillStyle = \"#64748b\";\n    ctx.font = \"10px 'DM Sans', sans-serif\";\n    ctx.fillText(\"Can you type code faster? ðŸš€\", canvas.width / 2, 435);\n  };\n\n  const downloadCard = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const link = document.createElement(\"a\");\n    link.download = `TypeMasterAI_Code_${languageName}_${wpm}WPM.png`;\n    link.href = canvas.toDataURL(\"image/png\");\n    link.click();\n    \n    triggerCelebration('small');\n    onShareTracked?.('code_card_download');\n    \n    toast({\n      title: \"Card Downloaded!\",\n      description: \"Share it on social media to challenge other coders!\",\n    });\n  };\n\n  const shareCard = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    setIsSharing(true);\n    try {\n      const blob = await new Promise<Blob>((resolve, reject) => {\n        canvas.toBlob((blob) => {\n          if (blob) resolve(blob);\n          else reject(new Error(\"Failed to create blob\"));\n        }, \"image/png\");\n      });\n\n      const file = new File([blob], `TypeMasterAI_Code_${wpm}WPM.png`, { type: \"image/png\" });\n\n      if ('share' in navigator && navigator.canShare?.({ files: [file] })) {\n        await navigator.share({\n          title: `TypeMasterAI Code Mode - ${wpm} WPM`,\n          text: `${rating.emoji} I typed ${languageName} code at ${wpm} WPM with ${accuracy}% accuracy on TypeMasterAI!\\n\\nðŸ… ${rating.title} - ${rating.badge} Badge\\nðŸ’» ${characters} characters\\n\\nCan you code faster?\\n\\nðŸ”— typemasterai.com/code-mode`,\n          files: [file],\n        });\n        triggerCelebration('medium');\n        onShareTracked?.('code_card_native');\n        toast({\n          title: \"Shared Successfully!\",\n          description: \"Your code typing achievement is on its way!\",\n        });\n      } else {\n        downloadCard();\n      }\n    } catch (error: any) {\n      if (error.name !== 'AbortError') {\n        downloadCard();\n      }\n    } finally {\n      setIsSharing(false);\n    }\n  };\n\n  const copyImageToClipboard = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    try {\n      const blob = await new Promise<Blob>((resolve, reject) => {\n        canvas.toBlob((blob) => {\n          if (blob) resolve(blob);\n          else reject(new Error(\"Failed to create blob\"));\n        }, \"image/png\");\n      });\n\n      await navigator.clipboard.write([\n        new ClipboardItem({ \"image/png\": blob })\n      ]);\n      \n      setImageCopied(true);\n      setTimeout(() => setImageCopied(false), 2000);\n      triggerCelebration('small');\n      onShareTracked?.('code_card_copy_image');\n      toast({\n        title: \"Image Copied!\",\n        description: \"Paste directly into Twitter, Discord, or any app!\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Copy Failed\",\n        description: \"Your browser doesn't support image copying. Please download instead.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  return (\n    <div className=\"flex flex-col items-center gap-4\">\n      <canvas\n        ref={canvasRef}\n        className=\"rounded-xl shadow-2xl max-w-full h-auto border border-primary/20\"\n        style={{ maxWidth: \"100%\", height: \"auto\" }}\n      />\n      \n      <div className=\"w-full space-y-3\">\n        <div className=\"p-3 bg-gradient-to-r from-blue-500/10 to-cyan-500/10 rounded-xl border border-blue-500/20\">\n          <p className=\"text-xs text-center text-blue-300 font-medium mb-2\">Share This Image</p>\n          <div className=\"grid grid-cols-2 gap-2\">\n            <Button\n              onClick={copyImageToClipboard}\n              variant=\"outline\"\n              className=\"gap-2 bg-blue-500/10 border-blue-500/30 hover:bg-blue-500/20\"\n              data-testid=\"button-copy-code-image\"\n            >\n              {imageCopied ? <Check className=\"w-4 h-4 text-green-500\" /> : <Clipboard className=\"w-4 h-4 text-blue-400\" />}\n              {imageCopied ? \"Copied!\" : \"Copy Image\"}\n            </Button>\n            <Button\n              onClick={downloadCard}\n              variant=\"outline\"\n              className=\"gap-2 bg-cyan-500/10 border-cyan-500/30 hover:bg-cyan-500/20\"\n              data-testid=\"button-download-code-card\"\n            >\n              <Download className=\"w-4 h-4 text-cyan-400\" />\n              Download\n            </Button>\n          </div>\n          <p className=\"text-[10px] text-center text-muted-foreground mt-2\">\n            Copy image and paste directly into Twitter, Discord, or any social app\n          </p>\n        </div>\n\n        {'share' in navigator && (\n          <Button\n            onClick={shareCard}\n            disabled={isSharing}\n            className=\"w-full gap-2 bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600\"\n            data-testid=\"button-share-code-card\"\n          >\n            <Share2 className=\"w-4 h-4\" />\n            {isSharing ? \"Sharing...\" : \"Share Image (Mobile/Desktop Apps)\"}\n          </Button>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10231,"size_tokens":null},"client/src/components/CodeCertificate.tsx":{"content":"import { useRef, useEffect, useMemo } from \"react\";\nimport { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Download, Share2, Check, Clipboard, Award, Sparkles } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { getCodePerformanceRating, getLanguageIcon, triggerCelebration } from \"@/lib/share-utils\";\n\ninterface CodeCertificateProps {\n  wpm: number;\n  rawWpm: number;\n  accuracy: number;\n  consistency: number;\n  language: string;\n  languageName: string;\n  difficulty: string;\n  characters: number;\n  errors: number;\n  time: string;\n  username?: string;\n  date?: Date;\n}\n\ninterface TierVisuals {\n  primaryColor: string;\n  secondaryColor: string;\n  glowColor: string;\n  borderGradient: [string, string, string];\n  sealColor: string;\n}\n\nconst TIER_VISUALS: Record<string, TierVisuals> = {\n  Diamond: {\n    primaryColor: \"#00d4ff\",\n    secondaryColor: \"#9be7ff\",\n    glowColor: \"rgba(0, 212, 255, 0.5)\",\n    borderGradient: [\"#00d4ff\", \"#9be7ff\", \"#00d4ff\"],\n    sealColor: \"#00d4ff\",\n  },\n  Platinum: {\n    primaryColor: \"#c0c0c0\",\n    secondaryColor: \"#e8e8e8\",\n    glowColor: \"rgba(192, 192, 192, 0.5)\",\n    borderGradient: [\"#a0a0a0\", \"#e8e8e8\", \"#a0a0a0\"],\n    sealColor: \"#c0c0c0\",\n  },\n  Gold: {\n    primaryColor: \"#ffd700\",\n    secondaryColor: \"#ffed4a\",\n    glowColor: \"rgba(255, 215, 0, 0.5)\",\n    borderGradient: [\"#b8860b\", \"#ffd700\", \"#b8860b\"],\n    sealColor: \"#ffd700\",\n  },\n  Silver: {\n    primaryColor: \"#a8a8a8\",\n    secondaryColor: \"#d4d4d4\",\n    glowColor: \"rgba(168, 168, 168, 0.5)\",\n    borderGradient: [\"#808080\", \"#d4d4d4\", \"#808080\"],\n    sealColor: \"#a8a8a8\",\n  },\n  Bronze: {\n    primaryColor: \"#cd7f32\",\n    secondaryColor: \"#daa06d\",\n    glowColor: \"rgba(205, 127, 50, 0.5)\",\n    borderGradient: [\"#8b4513\", \"#cd7f32\", \"#8b4513\"],\n    sealColor: \"#cd7f32\",\n  },\n};\n\nexport function CodeCertificate({\n  wpm,\n  rawWpm,\n  accuracy,\n  consistency,\n  language,\n  languageName,\n  difficulty,\n  characters,\n  errors,\n  time,\n  username,\n  date = new Date(),\n}: CodeCertificateProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [isSharing, setIsSharing] = useState(false);\n  const [imageCopied, setImageCopied] = useState(false);\n  const { toast } = useToast();\n\n  const rating = getCodePerformanceRating(wpm, accuracy);\n  const tierVisuals = TIER_VISUALS[rating.badge] || TIER_VISUALS.Bronze;\n\n  const certificateId = useMemo(() => {\n    const data = `${wpm}-${accuracy}-${consistency}-${language}-${characters}-${errors}-${time}`;\n    let hash = 0;\n    for (let i = 0; i < data.length; i++) {\n      const char = data.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash;\n    }\n    const chars = \"ABCDEFGHJKLMNPQRSTUVWXYZ23456789\";\n    let id = \"TM-\";\n    const absHash = Math.abs(hash);\n    for (let i = 0; i < 8; i++) {\n      id += chars[(absHash >> (i * 4)) % chars.length];\n    }\n    return id;\n  }, [wpm, accuracy, consistency, language, characters, errors, time]);\n\n  useEffect(() => {\n    generateCertificate();\n  }, [wpm, rawWpm, accuracy, consistency, language, languageName, difficulty, characters, errors, time, username]);\n\n  const generateCertificate = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const ctx = canvas.getContext(\"2d\");\n    if (!ctx) return;\n\n    const langIcon = getLanguageIcon(language);\n    const displayName = username || \"Code Enthusiast\";\n\n    canvas.width = 1200;\n    canvas.height = 675;\n\n    // Premium dark gradient background\n    const bgGradient = ctx.createRadialGradient(\n      canvas.width / 2, canvas.height / 2, 0,\n      canvas.width / 2, canvas.height / 2, canvas.width * 0.7\n    );\n    bgGradient.addColorStop(0, \"#1a1a2e\");\n    bgGradient.addColorStop(0.5, \"#16213e\");\n    bgGradient.addColorStop(1, \"#0f0f23\");\n    ctx.fillStyle = bgGradient;\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n\n    // Subtle pattern overlay\n    ctx.globalAlpha = 0.02;\n    for (let i = 0; i < canvas.width; i += 40) {\n      for (let j = 0; j < canvas.height; j += 40) {\n        if ((i + j) % 80 === 0) {\n          ctx.fillStyle = \"#ffffff\";\n          ctx.beginPath();\n          ctx.arc(i, j, 1.5, 0, Math.PI * 2);\n          ctx.fill();\n        }\n      }\n    }\n    ctx.globalAlpha = 1;\n\n    // Elegant outer border with tier color\n    const borderWidth = 6;\n    const borderGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);\n    borderGradient.addColorStop(0, tierVisuals.borderGradient[0]);\n    borderGradient.addColorStop(0.5, tierVisuals.borderGradient[1]);\n    borderGradient.addColorStop(1, tierVisuals.borderGradient[2]);\n    \n    ctx.strokeStyle = borderGradient;\n    ctx.lineWidth = borderWidth;\n    ctx.strokeRect(borderWidth / 2, borderWidth / 2, canvas.width - borderWidth, canvas.height - borderWidth);\n\n    // Inner decorative border\n    ctx.strokeStyle = \"rgba(255, 255, 255, 0.08)\";\n    ctx.lineWidth = 1;\n    ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);\n\n    // Corner decorations\n    const cornerSize = 35;\n    const cornerOffset = 15;\n    ctx.strokeStyle = tierVisuals.primaryColor;\n    ctx.lineWidth = 2;\n    \n    // Top-left\n    ctx.beginPath();\n    ctx.moveTo(cornerOffset, cornerOffset + cornerSize);\n    ctx.lineTo(cornerOffset, cornerOffset);\n    ctx.lineTo(cornerOffset + cornerSize, cornerOffset);\n    ctx.stroke();\n    \n    // Top-right\n    ctx.beginPath();\n    ctx.moveTo(canvas.width - cornerOffset - cornerSize, cornerOffset);\n    ctx.lineTo(canvas.width - cornerOffset, cornerOffset);\n    ctx.lineTo(canvas.width - cornerOffset, cornerOffset + cornerSize);\n    ctx.stroke();\n    \n    // Bottom-left\n    ctx.beginPath();\n    ctx.moveTo(cornerOffset, canvas.height - cornerOffset - cornerSize);\n    ctx.lineTo(cornerOffset, canvas.height - cornerOffset);\n    ctx.lineTo(cornerOffset + cornerSize, canvas.height - cornerOffset);\n    ctx.stroke();\n    \n    // Bottom-right\n    ctx.beginPath();\n    ctx.moveTo(canvas.width - cornerOffset - cornerSize, canvas.height - cornerOffset);\n    ctx.lineTo(canvas.width - cornerOffset, canvas.height - cornerOffset);\n    ctx.lineTo(canvas.width - cornerOffset, canvas.height - cornerOffset - cornerSize);\n    ctx.stroke();\n\n    // Header: </> CODE TYPING CERTIFICATE\n    ctx.fillStyle = tierVisuals.primaryColor;\n    ctx.font = \"bold 16px 'JetBrains Mono', monospace\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"</>\", canvas.width / 2 - 180, 65);\n    \n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 28px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"CODE TYPING CERTIFICATE\", canvas.width / 2 + 20, 68);\n\n    // Decorative line under header\n    const lineWidth = 500;\n    const lineY = 90;\n    const lineGradient = ctx.createLinearGradient(\n      canvas.width / 2 - lineWidth / 2, lineY,\n      canvas.width / 2 + lineWidth / 2, lineY\n    );\n    lineGradient.addColorStop(0, \"transparent\");\n    lineGradient.addColorStop(0.2, tierVisuals.primaryColor);\n    lineGradient.addColorStop(0.5, tierVisuals.secondaryColor);\n    lineGradient.addColorStop(0.8, tierVisuals.primaryColor);\n    lineGradient.addColorStop(1, \"transparent\");\n    \n    ctx.strokeStyle = lineGradient;\n    ctx.lineWidth = 2;\n    ctx.beginPath();\n    ctx.moveTo(canvas.width / 2 - lineWidth / 2, lineY);\n    ctx.lineTo(canvas.width / 2 + lineWidth / 2, lineY);\n    ctx.stroke();\n\n    // \"This certifies that\"\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.7)\";\n    ctx.font = \"italic 20px 'DM Sans', system-ui, sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"This certifies that\", canvas.width / 2, 140);\n\n    // User Name - Large and prominent with glow\n    ctx.save();\n    ctx.shadowColor = tierVisuals.glowColor;\n    ctx.shadowBlur = 30;\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 48px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(displayName, canvas.width / 2, 195);\n    ctx.restore();\n\n    // \"has successfully completed a Code Mode test\"\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.7)\";\n    ctx.font = \"italic 18px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"has successfully completed a Code Mode test\", canvas.width / 2, 235);\n\n    // Language info\n    ctx.fillStyle = tierVisuals.primaryColor;\n    ctx.font = \"600 16px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(`${langIcon} ${languageName} Programming  â€¢  ${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} Difficulty`, canvas.width / 2, 265);\n\n    // \"with the following results:\"\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.6)\";\n    ctx.font = \"16px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"with the following results:\", canvas.width / 2, 300);\n\n    // Stats box background\n    const statsBoxX = 200;\n    const statsBoxY = 320;\n    const statsBoxWidth = 800;\n    const statsBoxHeight = 100;\n    \n    ctx.fillStyle = \"rgba(255, 255, 255, 0.03)\";\n    ctx.beginPath();\n    ctx.roundRect(statsBoxX, statsBoxY, statsBoxWidth, statsBoxHeight, 12);\n    ctx.fill();\n    \n    ctx.strokeStyle = \"rgba(255, 255, 255, 0.1)\";\n    ctx.lineWidth = 1;\n    ctx.beginPath();\n    ctx.roundRect(statsBoxX, statsBoxY, statsBoxWidth, statsBoxHeight, 12);\n    ctx.stroke();\n\n    // Stats Row 1: WPM | Accuracy | Consistency\n    const row1Y = statsBoxY + 40;\n    const statsStartX = statsBoxX + 80;\n    const statSpacing = 250;\n\n    // WPM\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 32px 'JetBrains Mono', monospace\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(`${wpm}`, statsStartX, row1Y);\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"12px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"WPM\", statsStartX, row1Y + 20);\n\n    // Divider\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.2)\";\n    ctx.fillText(\"|\", statsStartX + statSpacing / 2, row1Y);\n\n    // Accuracy\n    ctx.fillStyle = \"#4ade80\";\n    ctx.font = \"bold 32px 'JetBrains Mono', monospace\";\n    ctx.fillText(`${accuracy}%`, statsStartX + statSpacing, row1Y);\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"12px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"ACCURACY\", statsStartX + statSpacing, row1Y + 20);\n\n    // Divider\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.2)\";\n    ctx.fillText(\"|\", statsStartX + statSpacing * 1.5, row1Y);\n\n    // Raw WPM\n    ctx.fillStyle = \"#c084fc\";\n    ctx.font = \"bold 32px 'JetBrains Mono', monospace\";\n    ctx.fillText(`${rawWpm}`, statsStartX + statSpacing * 2, row1Y);\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"12px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"RAW WPM\", statsStartX + statSpacing * 2, row1Y + 20);\n\n    // Divider\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.2)\";\n    ctx.fillText(\"|\", statsStartX + statSpacing * 2.5, row1Y);\n\n    // Time\n    ctx.fillStyle = \"#22d3ee\";\n    ctx.font = \"bold 32px 'JetBrains Mono', monospace\";\n    ctx.fillText(time, statsStartX + statSpacing * 3, row1Y);\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"12px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"TIME\", statsStartX + statSpacing * 3, row1Y + 20);\n\n    // Performance tier badge (on right side)\n    const badgeX = canvas.width - 120;\n    const badgeY = statsBoxY + statsBoxHeight / 2;\n    const badgeRadius = 35;\n    \n    ctx.save();\n    ctx.shadowColor = tierVisuals.glowColor;\n    ctx.shadowBlur = 15;\n    \n    const badgeGradient = ctx.createRadialGradient(badgeX, badgeY, 0, badgeX, badgeY, badgeRadius);\n    badgeGradient.addColorStop(0, tierVisuals.secondaryColor);\n    badgeGradient.addColorStop(0.7, tierVisuals.primaryColor);\n    badgeGradient.addColorStop(1, tierVisuals.borderGradient[0]);\n    \n    ctx.fillStyle = badgeGradient;\n    ctx.beginPath();\n    ctx.arc(badgeX, badgeY, badgeRadius, 0, Math.PI * 2);\n    ctx.fill();\n    \n    ctx.fillStyle = \"#1a1a2e\";\n    ctx.beginPath();\n    ctx.arc(badgeX, badgeY, badgeRadius - 6, 0, Math.PI * 2);\n    ctx.fill();\n    \n    ctx.restore();\n    \n    ctx.fillStyle = tierVisuals.primaryColor;\n    ctx.font = \"bold 12px 'DM Sans', system-ui, sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(rating.badge.toUpperCase(), badgeX, badgeY - 2);\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"9px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"TIER\", badgeX, badgeY + 12);\n\n    // Earned on date\n    const formattedDate = date.toLocaleDateString('en-GB', { \n      day: '2-digit', \n      month: '2-digit', \n      year: 'numeric' \n    });\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.7)\";\n    ctx.font = \"16px 'DM Sans', system-ui, sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(`Earned on: ${formattedDate}`, canvas.width / 2, 465);\n\n    // Motivational quote\n    ctx.fillStyle = tierVisuals.primaryColor;\n    ctx.font = \"italic 22px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(`\"${rating.title}\"`, canvas.width / 2, 510);\n\n    // Additional stats line\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.4)\";\n    ctx.font = \"13px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(`${characters} characters  â€¢  ${errors} error${errors !== 1 ? 's' : ''}  â€¢  ${consistency}% consistency`, canvas.width / 2, 545);\n\n    // Signature section\n    const sigY = 595;\n    \n    // Signature line\n    ctx.strokeStyle = \"rgba(255, 255, 255, 0.3)\";\n    ctx.lineWidth = 1;\n    ctx.beginPath();\n    ctx.moveTo(canvas.width / 2 - 150, sigY);\n    ctx.lineTo(canvas.width / 2 + 150, sigY);\n    ctx.stroke();\n\n    // AI Coach signature\n    ctx.fillStyle = tierVisuals.primaryColor;\n    ctx.font = \"italic 18px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"TypeMasterAI Coach\", canvas.width / 2, sigY - 10);\n    \n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"11px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"AI Typing Coach & Certification Authority\", canvas.width / 2, sigY + 18);\n\n    // Footer with certificate ID and URL\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.4)\";\n    ctx.font = \"10px 'JetBrains Mono', monospace\";\n    ctx.textAlign = \"left\";\n    ctx.fillText(`ID: ${certificateId}`, 50, canvas.height - 25);\n\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"typemasterai.com/code-mode\", canvas.width / 2, canvas.height - 25);\n\n    ctx.textAlign = \"right\";\n    ctx.fillStyle = tierVisuals.primaryColor;\n    ctx.font = \"bold 10px 'JetBrains Mono', monospace\";\n    ctx.fillText(`${rating.emoji} ${rating.badge} CERTIFIED`, canvas.width - 50, canvas.height - 25);\n  };\n\n  const downloadCertificate = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const link = document.createElement(\"a\");\n    link.download = `TypeMasterAI_Certificate_${languageName}_${wpm}WPM_${certificateId}.png`;\n    link.href = canvas.toDataURL(\"image/png\");\n    link.click();\n    \n    triggerCelebration('medium');\n    \n    toast({\n      title: \"Certificate Downloaded!\",\n      description: \"Share your achievement on social media!\",\n    });\n  };\n\n  const shareCertificate = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    setIsSharing(true);\n    try {\n      const blob = await new Promise<Blob>((resolve, reject) => {\n        canvas.toBlob((blob) => {\n          if (blob) resolve(blob);\n          else reject(new Error(\"Failed to create blob\"));\n        }, \"image/png\");\n      });\n\n      const file = new File([blob], `TypeMasterAI_Certificate_${wpm}WPM.png`, { type: \"image/png\" });\n\n      if ('share' in navigator && navigator.canShare?.({ files: [file] })) {\n        await navigator.share({\n          title: `TypeMasterAI Code Typing Certificate - ${wpm} WPM`,\n          text: `${rating.emoji} I earned a ${rating.badge} Certificate typing ${languageName} code at ${wpm} WPM with ${accuracy}% accuracy!\\n\\nðŸ… ${rating.title}\\nðŸ“œ Certificate: ${certificateId}\\n\\nCan you beat my score?\\n\\nðŸ”— typemasterai.com/code-mode`,\n          files: [file],\n        });\n        triggerCelebration('medium');\n        toast({\n          title: \"Certificate Shared!\",\n          description: \"Your achievement is on its way!\",\n        });\n      } else {\n        downloadCertificate();\n      }\n    } catch (error: any) {\n      if (error.name !== 'AbortError') {\n        downloadCertificate();\n      }\n    } finally {\n      setIsSharing(false);\n    }\n  };\n\n  const copyImageToClipboard = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    try {\n      const blob = await new Promise<Blob>((resolve, reject) => {\n        canvas.toBlob((blob) => {\n          if (blob) resolve(blob);\n          else reject(new Error(\"Failed to create blob\"));\n        }, \"image/png\");\n      });\n\n      await navigator.clipboard.write([\n        new ClipboardItem({ \"image/png\": blob })\n      ]);\n      \n      setImageCopied(true);\n      setTimeout(() => setImageCopied(false), 2000);\n      triggerCelebration('small');\n      \n      toast({\n        title: \"Certificate Copied!\",\n        description: \"Paste directly into Twitter, Discord, or LinkedIn!\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Copy Failed\",\n        description: \"Your browser doesn't support image copying. Please download instead.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  return (\n    <div className=\"flex flex-col items-center gap-4\">\n      <div className=\"relative w-full overflow-hidden rounded-xl shadow-2xl\" data-testid=\"certificate-container\" style={{ boxShadow: `0 25px 50px -12px ${tierVisuals.glowColor}` }}>\n        <canvas\n          ref={canvasRef}\n          className=\"w-full h-auto\"\n          style={{ maxWidth: \"100%\" }}\n          data-testid=\"certificate-canvas\"\n        />\n        <div className=\"absolute top-3 left-3 flex items-center gap-1.5 px-3 py-1.5 bg-black/60 rounded-full backdrop-blur-sm border border-white/10\">\n          <Award className=\"w-3.5 h-3.5\" style={{ color: tierVisuals.primaryColor }} />\n          <span className=\"text-[10px] font-semibold uppercase tracking-wider\" style={{ color: tierVisuals.primaryColor }}>\n            {rating.badge} Tier\n          </span>\n        </div>\n      </div>\n      \n      <div className=\"w-full space-y-3\">\n        <div className=\"p-4 bg-gradient-to-br from-zinc-900 via-zinc-800 to-zinc-900 rounded-xl border border-zinc-700\">\n          <div className=\"flex items-center justify-center gap-2 mb-3\">\n            <Sparkles className=\"w-4 h-4\" style={{ color: tierVisuals.primaryColor }} />\n            <p className=\"text-sm font-medium\" style={{ color: tierVisuals.primaryColor }}>Share Your Achievement</p>\n            <Sparkles className=\"w-4 h-4\" style={{ color: tierVisuals.primaryColor }} />\n          </div>\n          <div className=\"grid grid-cols-2 gap-3\">\n            <Button\n              onClick={copyImageToClipboard}\n              variant=\"outline\"\n              className=\"gap-2 h-10 bg-zinc-800/50 border-zinc-600 hover:bg-zinc-700/50 hover:border-zinc-500\"\n              data-testid=\"button-copy-certificate\"\n            >\n              {imageCopied ? <Check className=\"w-4 h-4 text-green-500\" /> : <Clipboard className=\"w-4 h-4\" style={{ color: tierVisuals.primaryColor }} />}\n              <span className=\"text-zinc-200\">{imageCopied ? \"Copied!\" : \"Copy Image\"}</span>\n            </Button>\n            <Button\n              onClick={downloadCertificate}\n              variant=\"outline\"\n              className=\"gap-2 h-10 bg-zinc-800/50 border-zinc-600 hover:bg-zinc-700/50 hover:border-zinc-500\"\n              data-testid=\"button-download-certificate\"\n            >\n              <Download className=\"w-4 h-4 text-purple-400\" />\n              <span className=\"text-zinc-200\">Download</span>\n            </Button>\n          </div>\n        </div>\n\n        {'share' in navigator && (\n          <Button\n            onClick={shareCertificate}\n            disabled={isSharing}\n            className=\"w-full gap-2 h-11 text-white font-semibold\"\n            style={{ \n              background: `linear-gradient(135deg, ${tierVisuals.borderGradient[0]}, ${tierVisuals.primaryColor}, ${tierVisuals.borderGradient[2]})`,\n            }}\n            data-testid=\"button-share-certificate\"\n          >\n            <Share2 className=\"w-4 h-4\" />\n            {isSharing ? \"Sharing...\" : \"Share Certificate\"}\n          </Button>\n        )}\n        \n        <p className=\"text-[10px] text-center text-zinc-500\" data-testid=\"text-certificate-id\">\n          Certificate ID: <span className=\"font-mono\" style={{ color: tierVisuals.primaryColor }}>{certificateId}</span>\n        </p>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":20426,"size_tokens":null},"client/src/lib/share-utils.ts":{"content":"import confetti from \"canvas-confetti\";\n\nexport interface PerformanceRating {\n  emoji: string;\n  title: string;\n  badge: string;\n  color: string;\n  bgGradient: [string, string, string];\n}\n\nexport const LANGUAGE_ICONS: Record<string, string> = {\n  python: \"ðŸ\",\n  javascript: \"ðŸ“œ\",\n  typescript: \"ðŸ’™\",\n  java: \"â˜•\",\n  cpp: \"âš¡\",\n  csharp: \"ðŸŸ£\",\n  go: \"ðŸ¹\",\n  rust: \"ðŸ¦€\",\n  ruby: \"ðŸ’Ž\",\n  php: \"ðŸ˜\",\n  swift: \"ðŸŽ\",\n  kotlin: \"ðŸŽ¯\",\n  scala: \"ðŸ”´\",\n  sql: \"ðŸ—„ï¸\",\n  html: \"ðŸŒ\",\n  css: \"ðŸŽ¨\",\n  dart: \"ðŸŽ¯\",\n  r: \"ðŸ“Š\",\n};\n\nexport interface SocialPlatform {\n  name: string;\n  color: string;\n  icon: 'twitter' | 'facebook' | 'whatsapp' | 'telegram' | 'linkedin' | 'reddit' | 'discord' | 'email';\n  getUrl: (text: string, url: string, title?: string) => string;\n}\n\nexport const SOCIAL_PLATFORMS: Record<string, SocialPlatform> = {\n  twitter: {\n    name: \"Twitter\",\n    color: \"#1DA1F2\",\n    icon: \"twitter\",\n    getUrl: (text, url) => `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,\n  },\n  facebook: {\n    name: \"Facebook\",\n    color: \"#1877F2\",\n    icon: \"facebook\",\n    getUrl: (text, url) => `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(text)}`,\n  },\n  whatsapp: {\n    name: \"WhatsApp\",\n    color: \"#25D366\",\n    icon: \"whatsapp\",\n    getUrl: (text, url) => `https://wa.me/?text=${encodeURIComponent(text + \"\\n\\n\" + url)}`,\n  },\n  telegram: {\n    name: \"Telegram\",\n    color: \"#0088cc\",\n    icon: \"telegram\",\n    getUrl: (text, url) => `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`,\n  },\n  linkedin: {\n    name: \"LinkedIn\",\n    color: \"#0A66C2\",\n    icon: \"linkedin\",\n    getUrl: (text, url, title) => `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(title || \"\")}&summary=${encodeURIComponent(text)}`,\n  },\n  reddit: {\n    name: \"Reddit\",\n    color: \"#FF4500\",\n    icon: \"reddit\",\n    getUrl: (text, url, title) => `https://www.reddit.com/submit?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title || text.substring(0, 100))}`,\n  },\n  discord: {\n    name: \"Discord\",\n    color: \"#5865F2\",\n    icon: \"discord\",\n    getUrl: (text, url) => `https://discord.com/channels/@me?text=${encodeURIComponent(text + \"\\n\" + url)}`,\n  },\n  email: {\n    name: \"Email\",\n    color: \"#6B7280\",\n    icon: \"email\",\n    getUrl: (text, url, title) => `mailto:?subject=${encodeURIComponent(title || \"Check this out!\")}&body=${encodeURIComponent(text + \"\\n\\nTry it yourself: \" + url)}`,\n  },\n};\n\nexport function getTypingPerformanceRating(wpm: number, accuracy: number): PerformanceRating {\n  if (wpm >= 100 && accuracy >= 98) return { emoji: \"ðŸ†\", title: \"Legendary Typist\", badge: \"Diamond\", color: \"#b9f2ff\", bgGradient: [\"#0f172a\", \"#1e3a5f\", \"#0f172a\"] };\n  if (wpm >= 80 && accuracy >= 95) return { emoji: \"âš¡\", title: \"Speed Demon\", badge: \"Platinum\", color: \"#e5e4e2\", bgGradient: [\"#0f172a\", \"#2d3748\", \"#0f172a\"] };\n  if (wpm >= 60 && accuracy >= 90) return { emoji: \"ðŸ”¥\", title: \"Fast & Accurate\", badge: \"Gold\", color: \"#ffd700\", bgGradient: [\"#0f172a\", \"#3d2914\", \"#0f172a\"] };\n  if (wpm >= 40 && accuracy >= 85) return { emoji: \"ðŸ’ª\", title: \"Solid Performer\", badge: \"Silver\", color: \"#c0c0c0\", bgGradient: [\"#0f172a\", \"#374151\", \"#0f172a\"] };\n  return { emoji: \"ðŸŽ¯\", title: \"Rising Star\", badge: \"Bronze\", color: \"#cd7f32\", bgGradient: [\"#0f172a\", \"#3d2a1a\", \"#0f172a\"] };\n}\n\nexport function getCodePerformanceRating(wpm: number, accuracy: number): PerformanceRating {\n  if (wpm >= 80 && accuracy >= 98) return { emoji: \"ðŸ†\", title: \"Code Master\", badge: \"Diamond\", color: \"#b9f2ff\", bgGradient: [\"#0f172a\", \"#1e3a5f\", \"#0f172a\"] };\n  if (wpm >= 60 && accuracy >= 95) return { emoji: \"âš¡\", title: \"Code Ninja\", badge: \"Platinum\", color: \"#e5e4e2\", bgGradient: [\"#0f172a\", \"#2d3748\", \"#0f172a\"] };\n  if (wpm >= 45 && accuracy >= 90) return { emoji: \"ðŸ”¥\", title: \"Fast Coder\", badge: \"Gold\", color: \"#ffd700\", bgGradient: [\"#0f172a\", \"#3d2914\", \"#0f172a\"] };\n  if (wpm >= 30 && accuracy >= 85) return { emoji: \"ðŸ’ª\", title: \"Code Warrior\", badge: \"Silver\", color: \"#c0c0c0\", bgGradient: [\"#0f172a\", \"#374151\", \"#0f172a\"] };\n  return { emoji: \"ðŸŽ¯\", title: \"Rising Coder\", badge: \"Bronze\", color: \"#cd7f32\", bgGradient: [\"#0f172a\", \"#3d2a1a\", \"#0f172a\"] };\n}\n\nexport function getLanguageIcon(language: string): string {\n  return LANGUAGE_ICONS[language.toLowerCase()] || \"ðŸ’»\";\n}\n\nexport function triggerCelebration(intensity: 'small' | 'medium' | 'large' = 'medium') {\n  const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;\n  if (prefersReducedMotion) return;\n\n  const configs = {\n    small: { particleCount: 30, spread: 40, origin: { y: 0.7 } },\n    medium: { particleCount: 60, spread: 70, origin: { y: 0.6 } },\n    large: { particleCount: 100, spread: 100, origin: { y: 0.5 } },\n  };\n\n  confetti({\n    ...configs[intensity],\n    colors: ['#00ffff', '#a855f7', '#22c55e', '#f59e0b', '#3b82f6'],\n    zIndex: 9999,\n  });\n}\n\nexport function shareToSocialPlatform(\n  platform: keyof typeof SOCIAL_PLATFORMS,\n  text: string,\n  url: string,\n  title?: string\n) {\n  const config = SOCIAL_PLATFORMS[platform];\n  if (!config) return;\n\n  const shareUrl = config.getUrl(text, url, title);\n  \n  if (platform === 'email') {\n    window.location.href = shareUrl;\n  } else if (platform === 'discord') {\n    navigator.clipboard.writeText(text + \"\\n\" + url);\n    return 'copied';\n  } else {\n    window.open(shareUrl, \"_blank\", \"width=600,height=400\");\n  }\n}\n\nexport function buildCodeShareText(\n  wpm: number,\n  accuracy: number,\n  languageName: string,\n  characters: number,\n  time: string,\n  rating: PerformanceRating,\n  langIcon: string\n): string {\n  return `${rating.emoji} I just typed ${languageName} code at ${wpm} WPM with ${accuracy}% accuracy on TypeMasterAI!\n\n${langIcon} ${languageName} | âŒ¨ï¸ ${wpm} WPM | âœ¨ ${accuracy}% Accuracy\nðŸ… ${rating.title} - ${rating.badge} Badge\nðŸ’» ${characters} characters in ${time}\n\nThink you can code faster? Try it now! ðŸš€\n\nðŸ”— https://typemasterai.com/code-mode\n\n#CodeTyping #TypeMasterAI #${languageName.replace(/\\s+/g, '')} #Programming`;\n}\n\nexport function buildTypingShareText(\n  wpm: number,\n  accuracy: number,\n  mode: number,\n  rating: PerformanceRating\n): string {\n  const modeDisplay = mode >= 60 ? `${Math.floor(mode / 60)} minute` : `${mode} second`;\n  return `${rating.emoji} I just scored ${wpm} WPM with ${accuracy}% accuracy on TypeMasterAI!\n\nâŒ¨ï¸ ${wpm} WPM | âœ¨ ${accuracy}% Accuracy\nðŸ… ${rating.title} - ${rating.badge} Badge\nâ±ï¸ ${modeDisplay} typing test\n\nThink you can beat my score? Try it now! ðŸŽ¯\n\nðŸ”— https://typemasterai.com\n\n#TypingTest #TypeMasterAI #WPM`;\n}\n\nexport interface CardDimensions {\n  width: number;\n  height: number;\n}\n\nexport const CARD_DIMENSIONS: Record<string, CardDimensions> = {\n  standard: { width: 600, height: 400 },\n  code: { width: 600, height: 450 },\n};\n\nexport function drawCardBackground(\n  ctx: CanvasRenderingContext2D,\n  canvas: HTMLCanvasElement,\n  rating: PerformanceRating\n) {\n  const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);\n  gradient.addColorStop(0, rating.bgGradient[0]);\n  gradient.addColorStop(0.5, rating.bgGradient[1]);\n  gradient.addColorStop(1, rating.bgGradient[2]);\n  ctx.fillStyle = gradient;\n  ctx.fillRect(0, 0, canvas.width, canvas.height);\n\n  ctx.strokeStyle = \"#00ffff\";\n  ctx.lineWidth = 3;\n  ctx.strokeRect(15, 15, canvas.width - 30, canvas.height - 30);\n\n  ctx.strokeStyle = rating.color;\n  ctx.lineWidth = 1;\n  ctx.strokeRect(25, 25, canvas.width - 50, canvas.height - 50);\n}\n","path":null,"size_bytes":7731,"size_tokens":null},"client/src/hooks/useNetworkStatus.ts":{"content":"import { useState, useEffect, useCallback, useRef } from 'react';\n\nexport type ConnectionState = 'connected' | 'connecting' | 'disconnected' | 'reconnecting';\n\nexport type ConnectionQuality = 'excellent' | 'good' | 'fair' | 'poor' | 'offline';\n\nexport interface NetworkStatus {\n  isOnline: boolean;\n  wasOffline: boolean;\n  lastOnlineAt: Date | null;\n  lastOfflineAt: Date | null;\n  connectionType: string | null;\n  effectiveType: string | null;\n  downlink: number | null;\n  rtt: number | null;\n  connectionState: ConnectionState;\n  connectionQuality: ConnectionQuality;\n  consecutiveFailures: number;\n  lastHealthCheck: Date | null;\n}\n\ninterface NetworkInformation extends EventTarget {\n  effectiveType: string;\n  downlink: number;\n  rtt: number;\n  type: string;\n  addEventListener(type: string, listener: EventListener): void;\n  removeEventListener(type: string, listener: EventListener): void;\n}\n\ndeclare global {\n  interface Navigator {\n    connection?: NetworkInformation;\n    mozConnection?: NetworkInformation;\n    webkitConnection?: NetworkInformation;\n  }\n}\n\nfunction getConnection(): NetworkInformation | null {\n  return navigator.connection || navigator.mozConnection || navigator.webkitConnection || null;\n}\n\nfunction determineConnectionQuality(\n  isOnline: boolean,\n  effectiveType: string | null,\n  rtt: number | null,\n  downlink: number | null\n): ConnectionQuality {\n  if (!isOnline) return 'offline';\n  \n  if (effectiveType) {\n    switch (effectiveType) {\n      case '4g':\n        if (rtt && rtt < 50) return 'excellent';\n        if (rtt && rtt < 100) return 'good';\n        return 'fair';\n      case '3g':\n        return 'fair';\n      case '2g':\n      case 'slow-2g':\n        return 'poor';\n    }\n  }\n  \n  if (rtt !== null) {\n    if (rtt < 50) return 'excellent';\n    if (rtt < 100) return 'good';\n    if (rtt < 300) return 'fair';\n    return 'poor';\n  }\n  \n  if (downlink !== null) {\n    if (downlink >= 10) return 'excellent';\n    if (downlink >= 5) return 'good';\n    if (downlink >= 1) return 'fair';\n    return 'poor';\n  }\n  \n  return 'good';\n}\n\nconst HEALTH_CHECK_INTERVAL = 30000;\nconst HEALTH_CHECK_TIMEOUT = 5000;\nconst MAX_CONSECUTIVE_FAILURES = 3;\n\nexport function useNetworkStatus(): NetworkStatus {\n  const [status, setStatus] = useState<NetworkStatus>(() => ({\n    isOnline: typeof navigator !== 'undefined' ? navigator.onLine : true,\n    wasOffline: false,\n    lastOnlineAt: typeof navigator !== 'undefined' && navigator.onLine ? new Date() : null,\n    lastOfflineAt: null,\n    connectionType: null,\n    effectiveType: null,\n    downlink: null,\n    rtt: null,\n    connectionState: typeof navigator !== 'undefined' && navigator.onLine ? 'connected' : 'disconnected',\n    connectionQuality: 'good',\n    consecutiveFailures: 0,\n    lastHealthCheck: null,\n  }));\n\n  const healthCheckIntervalRef = useRef<NodeJS.Timeout | null>(null);\n  const isCheckingRef = useRef(false);\n\n  const updateNetworkInfo = useCallback(() => {\n    const connection = getConnection();\n    if (connection) {\n      const effectiveType = connection.effectiveType || null;\n      const rtt = connection.rtt || null;\n      const downlink = connection.downlink || null;\n      \n      setStatus(prev => ({\n        ...prev,\n        connectionType: connection.type || null,\n        effectiveType,\n        downlink,\n        rtt,\n        connectionQuality: determineConnectionQuality(prev.isOnline, effectiveType, rtt, downlink),\n      }));\n    }\n  }, []);\n\n  const performHealthCheck = useCallback(async () => {\n    if (isCheckingRef.current) return;\n    isCheckingRef.current = true;\n\n    try {\n      const isReachable = await checkServerReachability(HEALTH_CHECK_TIMEOUT);\n      \n      setStatus(prev => {\n        if (isReachable) {\n          return {\n            ...prev,\n            isOnline: true,\n            connectionState: 'connected',\n            consecutiveFailures: 0,\n            lastHealthCheck: new Date(),\n            wasOffline: prev.connectionState === 'disconnected' || prev.connectionState === 'reconnecting',\n          };\n        } else {\n          const newFailures = prev.consecutiveFailures + 1;\n          const isDisconnected = newFailures >= MAX_CONSECUTIVE_FAILURES;\n          \n          return {\n            ...prev,\n            consecutiveFailures: newFailures,\n            connectionState: isDisconnected ? 'disconnected' : 'reconnecting',\n            lastHealthCheck: new Date(),\n            connectionQuality: isDisconnected ? 'offline' : 'poor',\n          };\n        }\n      });\n    } finally {\n      isCheckingRef.current = false;\n    }\n  }, []);\n\n  const handleOnline = useCallback(() => {\n    setStatus(prev => ({\n      ...prev,\n      isOnline: true,\n      wasOffline: true,\n      connectionState: 'reconnecting',\n      lastOnlineAt: new Date(),\n    }));\n    updateNetworkInfo();\n    performHealthCheck();\n  }, [updateNetworkInfo, performHealthCheck]);\n\n  const handleOffline = useCallback(() => {\n    setStatus(prev => ({\n      ...prev,\n      isOnline: false,\n      connectionState: 'disconnected',\n      connectionQuality: 'offline',\n      lastOfflineAt: new Date(),\n      consecutiveFailures: MAX_CONSECUTIVE_FAILURES,\n    }));\n  }, []);\n\n  useEffect(() => {\n    window.addEventListener('online', handleOnline);\n    window.addEventListener('offline', handleOffline);\n\n    const connection = getConnection();\n    if (connection) {\n      connection.addEventListener('change', updateNetworkInfo);\n      updateNetworkInfo();\n    }\n\n    if (status.isOnline) {\n      performHealthCheck();\n    }\n\n    healthCheckIntervalRef.current = setInterval(() => {\n      if (navigator.onLine) {\n        performHealthCheck();\n      }\n    }, HEALTH_CHECK_INTERVAL);\n\n    return () => {\n      window.removeEventListener('online', handleOnline);\n      window.removeEventListener('offline', handleOffline);\n      \n      const conn = getConnection();\n      if (conn) {\n        conn.removeEventListener('change', updateNetworkInfo);\n      }\n\n      if (healthCheckIntervalRef.current) {\n        clearInterval(healthCheckIntervalRef.current);\n      }\n    };\n  }, [handleOnline, handleOffline, updateNetworkInfo, performHealthCheck]);\n\n  return status;\n}\n\nexport function useIsOnline(): boolean {\n  const { isOnline, connectionState } = useNetworkStatus();\n  return isOnline && connectionState === 'connected';\n}\n\nexport async function checkServerReachability(timeout = 5000): Promise<boolean> {\n  try {\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), timeout);\n    \n    const startTime = performance.now();\n    const response = await fetch('/api/health', {\n      method: 'HEAD',\n      signal: controller.signal,\n      cache: 'no-store',\n    });\n    const endTime = performance.now();\n    \n    clearTimeout(timeoutId);\n    \n    const responseTime = endTime - startTime;\n    if (responseTime > timeout * 0.8) {\n      console.warn(`[Network] Health check slow: ${responseTime.toFixed(0)}ms`);\n    }\n    \n    return response.ok;\n  } catch {\n    return false;\n  }\n}\n\nexport async function measureLatency(): Promise<number | null> {\n  try {\n    const startTime = performance.now();\n    await fetch('/api/health', {\n      method: 'HEAD',\n      cache: 'no-store',\n    });\n    return performance.now() - startTime;\n  } catch {\n    return null;\n  }\n}\n","path":null,"size_bytes":7303,"size_tokens":null},"client/src/components/NetworkStatusBanner.tsx":{"content":"import { useEffect, useState, useCallback } from 'react';\nimport { useNetwork } from '@/lib/network-context';\nimport { WifiOff, Wifi, RefreshCw, AlertTriangle, CheckCircle, Cloud, CloudOff, Signal, SignalLow, SignalMedium, SignalHigh } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { cn } from '@/lib/utils';\nimport { ConnectionQuality } from '@/hooks/useNetworkStatus';\n\nfunction getQualityIcon(quality: ConnectionQuality) {\n  switch (quality) {\n    case 'excellent':\n      return <SignalHigh className=\"w-4 h-4\" />;\n    case 'good':\n      return <SignalMedium className=\"w-4 h-4\" />;\n    case 'fair':\n      return <SignalLow className=\"w-4 h-4\" />;\n    case 'poor':\n      return <Signal className=\"w-4 h-4\" />;\n    case 'offline':\n      return <WifiOff className=\"w-4 h-4\" />;\n  }\n}\n\nexport function NetworkStatusBanner() {\n  const { \n    isOnline, \n    wasOffline, \n    connectionState,\n    connectionQuality,\n    isServerReachable, \n    isCheckingServer,\n    checkConnection,\n    pendingActions,\n    retryPendingActions,\n    nextRetryIn,\n    retryCount,\n  } = useNetwork();\n  \n  const [showReconnected, setShowReconnected] = useState(false);\n  const [isRetrying, setIsRetrying] = useState(false);\n  const [dismissedOffline, setDismissedOffline] = useState(false);\n\n  useEffect(() => {\n    if (connectionState === 'connected' && wasOffline) {\n      setShowReconnected(true);\n      setDismissedOffline(false);\n      const timer = setTimeout(() => {\n        setShowReconnected(false);\n      }, 5000);\n      return () => clearTimeout(timer);\n    }\n  }, [connectionState, wasOffline]);\n\n  useEffect(() => {\n    if (connectionState === 'disconnected') {\n      setDismissedOffline(false);\n    }\n  }, [connectionState]);\n\n  const handleRetry = useCallback(async () => {\n    setIsRetrying(true);\n    try {\n      const connected = await checkConnection();\n      if (connected && pendingActions.length > 0) {\n        await retryPendingActions();\n      }\n    } finally {\n      setIsRetrying(false);\n    }\n  }, [checkConnection, pendingActions.length, retryPendingActions]);\n\n  const isDisconnected = connectionState === 'disconnected' || !isOnline;\n  const isReconnecting = connectionState === 'reconnecting';\n  const isConnected = connectionState === 'connected' && isOnline && isServerReachable;\n\n  if (isDisconnected && !dismissedOffline) {\n    return (\n      <div \n        className=\"fixed top-0 left-0 right-0 z-[9999] animate-in slide-in-from-top duration-300\"\n        role=\"alert\"\n        aria-live=\"assertive\"\n        aria-atomic=\"true\"\n      >\n        <div className=\"bg-gradient-to-r from-red-600 to-red-500 text-white shadow-lg\">\n          <div className=\"container mx-auto px-4 py-3\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <div className=\"flex items-center gap-3 min-w-0 flex-1\">\n                <div className=\"flex items-center justify-center w-10 h-10 rounded-full bg-white/20 shrink-0\">\n                  <WifiOff className=\"w-5 h-5 animate-pulse\" aria-hidden=\"true\" />\n                </div>\n                <div className=\"min-w-0\">\n                  <p className=\"font-semibold text-base\">No Internet Connection</p>\n                  <p className=\"text-sm text-white/90 truncate\">\n                    Check your connection. Your progress is saved and will sync automatically.\n                  </p>\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2 shrink-0\">\n                <Button\n                  variant=\"secondary\"\n                  size=\"sm\"\n                  onClick={handleRetry}\n                  disabled={isRetrying || isCheckingServer}\n                  className=\"bg-white text-red-600 hover:bg-white/90 font-medium\"\n                  data-testid=\"button-retry-connection\"\n                  aria-label=\"Retry connection\"\n                >\n                  <RefreshCw \n                    className={cn(\"w-4 h-4 mr-2\", (isRetrying || isCheckingServer) && \"animate-spin\")} \n                    aria-hidden=\"true\" \n                  />\n                  Try Again\n                </Button>\n              </div>\n            </div>\n            {pendingActions.length > 0 && (\n              <div className=\"mt-2 pt-2 border-t border-white/20 flex items-center gap-2 text-sm text-white/80\">\n                <AlertTriangle className=\"w-4 h-4 shrink-0\" aria-hidden=\"true\" />\n                <span>{pendingActions.length} unsaved action{pendingActions.length > 1 ? 's' : ''} waiting to sync</span>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (isOnline && !isServerReachable && !isCheckingServer && !isReconnecting) {\n    return (\n      <div \n        className=\"fixed top-0 left-0 right-0 z-[9999] animate-in slide-in-from-top duration-300\"\n        role=\"alert\"\n        aria-live=\"polite\"\n        aria-atomic=\"true\"\n      >\n        <div className=\"bg-gradient-to-r from-amber-500 to-orange-500 text-amber-950 shadow-lg\">\n          <div className=\"container mx-auto px-4 py-3\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <div className=\"flex items-center gap-3 min-w-0 flex-1\">\n                <div className=\"flex items-center justify-center w-10 h-10 rounded-full bg-white/30 shrink-0\">\n                  <CloudOff className=\"w-5 h-5\" aria-hidden=\"true\" />\n                </div>\n                <div className=\"min-w-0\">\n                  <p className=\"font-semibold text-base\">Server Unreachable</p>\n                  <p className=\"text-sm opacity-90 truncate\">\n                    You're online but we can't reach our servers. Some features may not work.\n                  </p>\n                </div>\n              </div>\n              <Button\n                variant=\"secondary\"\n                size=\"sm\"\n                onClick={handleRetry}\n                disabled={isRetrying || isCheckingServer}\n                className=\"bg-white/90 text-amber-700 hover:bg-white font-medium shrink-0\"\n                data-testid=\"button-retry-server\"\n                aria-label=\"Retry server connection\"\n              >\n                <RefreshCw \n                  className={cn(\"w-4 h-4 mr-2\", (isRetrying || isCheckingServer) && \"animate-spin\")} \n                  aria-hidden=\"true\" \n                />\n                Retry\n              </Button>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (isReconnecting) {\n    return (\n      <div \n        className=\"fixed top-0 left-0 right-0 z-[9999] animate-in slide-in-from-top duration-300\"\n        role=\"status\"\n        aria-live=\"polite\"\n        aria-atomic=\"true\"\n      >\n        <div className=\"bg-gradient-to-r from-blue-500 to-indigo-500 text-white shadow-lg\">\n          <div className=\"container mx-auto px-4 py-3\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"flex items-center justify-center w-10 h-10 rounded-full bg-white/20 shrink-0\">\n                <RefreshCw className=\"w-5 h-5 animate-spin\" aria-hidden=\"true\" />\n              </div>\n              <div>\n                <p className=\"font-semibold text-base\">Reconnecting...</p>\n                <p className=\"text-sm text-white/90\">\n                  Attempting to restore your connection\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (showReconnected && isConnected) {\n    return (\n      <div \n        className=\"fixed top-0 left-0 right-0 z-[9999] animate-in slide-in-from-top duration-300\"\n        role=\"status\"\n        aria-live=\"polite\"\n        aria-atomic=\"true\"\n      >\n        <div className=\"bg-gradient-to-r from-emerald-500 to-green-500 text-white shadow-lg\">\n          <div className=\"container mx-auto px-4 py-3\">\n            <div className=\"flex items-center justify-between gap-4\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"flex items-center justify-center w-10 h-10 rounded-full bg-white/20 shrink-0\">\n                  <CheckCircle className=\"w-5 h-5\" aria-hidden=\"true\" />\n                </div>\n                <div>\n                  <p className=\"font-semibold text-base\">You're Back Online!</p>\n                  {pendingActions.length > 0 ? (\n                    <p className=\"text-sm text-white/90\">\n                      Syncing {pendingActions.length} pending action{pendingActions.length > 1 ? 's' : ''}...\n                    </p>\n                  ) : (\n                    <p className=\"text-sm text-white/90\">Your connection has been restored.</p>\n                  )}\n                </div>\n              </div>\n              <div className=\"flex items-center gap-2 shrink-0\">\n                <Wifi className=\"w-5 h-5\" aria-hidden=\"true\" />\n                <Cloud className=\"w-5 h-5\" aria-hidden=\"true\" />\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (pendingActions.length > 0 && isConnected) {\n    return (\n      <div \n        className=\"fixed top-0 left-0 right-0 z-[9999] animate-in slide-in-from-top duration-300\"\n        role=\"status\"\n        aria-live=\"polite\"\n        aria-atomic=\"true\"\n      >\n        <div className=\"bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg\">\n          <div className=\"container mx-auto px-4 py-3\">\n            <div className=\"flex items-center justify-between gap-4 flex-wrap\">\n              <div className=\"flex items-center gap-3 min-w-0 flex-1\">\n                <div className=\"flex items-center justify-center w-10 h-10 rounded-full bg-white/20 shrink-0\">\n                  <AlertTriangle className=\"w-5 h-5\" aria-hidden=\"true\" />\n                </div>\n                <div className=\"min-w-0\">\n                  <p className=\"font-semibold text-base\">Pending Actions</p>\n                  <p className=\"text-sm text-white/90\">\n                    {pendingActions.length} action{pendingActions.length > 1 ? 's' : ''} waiting to sync\n                    {nextRetryIn !== null && ` â€¢ Auto-retry in ${nextRetryIn}s`}\n                    {retryCount > 0 && retryCount < 5 && ` (attempt ${retryCount + 1}/5)`}\n                  </p>\n                </div>\n              </div>\n              <Button\n                variant=\"secondary\"\n                size=\"sm\"\n                onClick={handleRetry}\n                disabled={isRetrying}\n                className=\"bg-white text-blue-600 hover:bg-white/90 font-medium shrink-0\"\n                data-testid=\"button-sync-pending\"\n                aria-label=\"Sync pending actions now\"\n              >\n                <RefreshCw \n                  className={cn(\"w-4 h-4 mr-2\", isRetrying && \"animate-spin\")} \n                  aria-hidden=\"true\" \n                />\n                Sync Now\n              </Button>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return null;\n}\n\nexport function OfflineIndicator({ className }: { className?: string }) {\n  const { isOnline, connectionState } = useNetwork();\n\n  if (isOnline && connectionState === 'connected') return null;\n\n  return (\n    <div \n      className={cn(\n        \"inline-flex items-center gap-1.5 px-2 py-1 bg-destructive/10 text-destructive rounded-full text-xs font-medium\",\n        className\n      )}\n      role=\"status\"\n      aria-label=\"Offline\"\n    >\n      <WifiOff className=\"w-3 h-3\" aria-hidden=\"true\" />\n      {connectionState === 'reconnecting' ? 'Reconnecting...' : 'Offline'}\n    </div>\n  );\n}\n\nexport function ConnectionQualityIndicator({ className, showLabel = false }: { className?: string; showLabel?: boolean }) {\n  const { connectionQuality, isOnline, connectionState } = useNetwork();\n\n  if (!isOnline || connectionState !== 'connected') return null;\n\n  const qualityConfig: Record<ConnectionQuality, { label: string; color: string }> = {\n    excellent: { label: 'Excellent', color: 'text-green-500' },\n    good: { label: 'Good', color: 'text-emerald-500' },\n    fair: { label: 'Fair', color: 'text-yellow-500' },\n    poor: { label: 'Poor', color: 'text-orange-500' },\n    offline: { label: 'Offline', color: 'text-red-500' },\n  };\n\n  const config = qualityConfig[connectionQuality];\n\n  return (\n    <div \n      className={cn(\n        \"inline-flex items-center gap-1.5\",\n        config.color,\n        className\n      )}\n      role=\"status\"\n      aria-label={`Connection quality: ${config.label}`}\n    >\n      {getQualityIcon(connectionQuality)}\n      {showLabel && <span className=\"text-xs font-medium\">{config.label}</span>}\n    </div>\n  );\n}\n","path":null,"size_bytes":12607,"size_tokens":null},"client/src/lib/network-context.tsx":{"content":"import { createContext, useContext, useEffect, useState, useCallback, useRef, ReactNode } from 'react';\nimport { useNetworkStatus, NetworkStatus, checkServerReachability, ConnectionState, ConnectionQuality } from '@/hooks/useNetworkStatus';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface NetworkContextType extends NetworkStatus {\n  isServerReachable: boolean;\n  isCheckingServer: boolean;\n  checkConnection: () => Promise<boolean>;\n  pendingActions: PendingAction[];\n  addPendingAction: (action: PendingAction) => void;\n  removePendingAction: (id: string) => void;\n  clearPendingActions: () => void;\n  retryPendingActions: () => Promise<void>;\n  nextRetryIn: number | null;\n  retryCount: number;\n}\n\nexport interface PendingAction {\n  id: string;\n  type: 'save_result' | 'save_stress_test' | 'update_progress' | 'send_message';\n  data: unknown;\n  timestamp: Date;\n  retryCount: number;\n}\n\nconst NetworkContext = createContext<NetworkContextType | undefined>(undefined);\n\nconst PENDING_ACTIONS_KEY = 'typemasterai_pending_actions';\nconst MAX_RETRIES = 5;\nconst BASE_RETRY_DELAY = 3000;\nconst MAX_RETRY_DELAY = 60000;\n\nfunction calculateRetryDelay(attempt: number): number {\n  const delay = Math.min(BASE_RETRY_DELAY * Math.pow(2, attempt), MAX_RETRY_DELAY);\n  const jitter = delay * 0.2 * Math.random();\n  return delay + jitter;\n}\n\nexport function NetworkProvider({ children }: { children: ReactNode }) {\n  const networkStatus = useNetworkStatus();\n  const { toast } = useToast();\n  const [isServerReachable, setIsServerReachable] = useState(true);\n  const [isCheckingServer, setIsCheckingServer] = useState(false);\n  const [nextRetryIn, setNextRetryIn] = useState<number | null>(null);\n  const [retryCount, setRetryCount] = useState(0);\n  const [pendingActions, setPendingActions] = useState<PendingAction[]>(() => {\n    try {\n      const stored = localStorage.getItem(PENDING_ACTIONS_KEY);\n      if (stored) {\n        const parsed = JSON.parse(stored);\n        return parsed.map((action: PendingAction) => ({\n          ...action,\n          timestamp: new Date(action.timestamp),\n        }));\n      }\n      return [];\n    } catch {\n      return [];\n    }\n  });\n\n  const retryTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const countdownIntervalRef = useRef<NodeJS.Timeout | null>(null);\n  const previousStateRef = useRef<ConnectionState>(networkStatus.connectionState);\n  const toastShownRef = useRef<{ offline: boolean; reconnected: boolean }>({\n    offline: false,\n    reconnected: false,\n  });\n\n  useEffect(() => {\n    try {\n      localStorage.setItem(PENDING_ACTIONS_KEY, JSON.stringify(pendingActions));\n    } catch {\n    }\n  }, [pendingActions]);\n\n  useEffect(() => {\n    const prevState = previousStateRef.current;\n    const currentState = networkStatus.connectionState;\n    \n    if (prevState !== currentState) {\n      if (currentState === 'disconnected' && !toastShownRef.current.offline) {\n        toastShownRef.current.offline = true;\n        toastShownRef.current.reconnected = false;\n        toast({\n          variant: 'destructive',\n          title: \"You're offline\",\n          description: \"Your progress is saved and will sync when you reconnect.\",\n          duration: 10000,\n        });\n      } else if (currentState === 'connected' && prevState === 'disconnected' && !toastShownRef.current.reconnected) {\n        toastShownRef.current.reconnected = true;\n        toastShownRef.current.offline = false;\n        toast({\n          title: \"You're back online!\",\n          description: pendingActions.length > 0 \n            ? `Syncing ${pendingActions.length} pending action${pendingActions.length > 1 ? 's' : ''}...`\n            : \"Your connection has been restored.\",\n          duration: 5000,\n        });\n      } else if (currentState === 'reconnecting') {\n        toastShownRef.current.offline = false;\n      }\n      \n      previousStateRef.current = currentState;\n    }\n  }, [networkStatus.connectionState, pendingActions.length, toast]);\n\n  useEffect(() => {\n    if (networkStatus.connectionState === 'disconnected' || networkStatus.connectionState === 'reconnecting') {\n      setIsServerReachable(false);\n    } else if (networkStatus.connectionState === 'connected') {\n      setIsServerReachable(true);\n    }\n  }, [networkStatus.connectionState]);\n\n  const checkConnection = useCallback(async (): Promise<boolean> => {\n    if (!networkStatus.isOnline) {\n      setIsServerReachable(false);\n      return false;\n    }\n\n    setIsCheckingServer(true);\n    try {\n      const reachable = await checkServerReachability();\n      setIsServerReachable(reachable);\n      return reachable;\n    } finally {\n      setIsCheckingServer(false);\n    }\n  }, [networkStatus.isOnline]);\n\n  const addPendingAction = useCallback((action: PendingAction) => {\n    setPendingActions(prev => {\n      const existing = prev.find(a => a.id === action.id);\n      if (existing) {\n        return prev.map(a => a.id === action.id ? action : a);\n      }\n      return [...prev, action];\n    });\n  }, []);\n\n  const removePendingAction = useCallback((id: string) => {\n    setPendingActions(prev => prev.filter(a => a.id !== id));\n  }, []);\n\n  const clearPendingActions = useCallback(() => {\n    setPendingActions([]);\n    setRetryCount(0);\n    setNextRetryIn(null);\n  }, []);\n\n  const retryPendingActions = useCallback(async () => {\n    if (!networkStatus.isOnline || pendingActions.length === 0) return;\n    \n    const reachable = await checkServerReachability();\n    if (!reachable) {\n      setIsServerReachable(false);\n      return;\n    }\n    setIsServerReachable(true);\n\n    const actionsSnapshot = [...pendingActions];\n    const processedIds: string[] = [];\n    const failedActions: PendingAction[] = [];\n\n    for (const action of actionsSnapshot) {\n      try {\n        let endpoint = '';\n        \n        switch (action.type) {\n          case 'save_result':\n            endpoint = '/api/results';\n            break;\n          case 'save_stress_test':\n            endpoint = '/api/stress-test';\n            break;\n          case 'update_progress':\n            endpoint = '/api/progress';\n            break;\n          case 'send_message':\n            endpoint = '/api/messages';\n            break;\n        }\n\n        if (endpoint) {\n          const response = await fetch(endpoint, {\n            method: 'POST',\n            headers: { 'Content-Type': 'application/json' },\n            credentials: 'include',\n            body: JSON.stringify(action.data),\n          });\n\n          if (response.ok) {\n            processedIds.push(action.id);\n          } else if (response.status === 401) {\n            processedIds.push(action.id);\n            toast({\n              variant: 'destructive',\n              title: 'Session expired',\n              description: 'Please log in again to save your results.',\n              duration: 5000,\n            });\n          } else if (action.retryCount >= MAX_RETRIES) {\n            processedIds.push(action.id);\n            toast({\n              variant: 'destructive',\n              title: 'Failed to sync',\n              description: 'Some data could not be saved after multiple attempts.',\n              duration: 5000,\n            });\n          } else {\n            failedActions.push({ ...action, retryCount: action.retryCount + 1 });\n          }\n        }\n        \n        await new Promise(resolve => setTimeout(resolve, 300));\n      } catch {\n        if (action.retryCount >= MAX_RETRIES) {\n          processedIds.push(action.id);\n        } else {\n          failedActions.push({ ...action, retryCount: action.retryCount + 1 });\n        }\n      }\n    }\n\n    setPendingActions(prev => {\n      const remaining = prev.filter(a => !processedIds.includes(a.id));\n      return remaining.map(a => {\n        const failed = failedActions.find(f => f.id === a.id);\n        return failed || a;\n      });\n    });\n\n    if (processedIds.length > 0 && processedIds.length === actionsSnapshot.length) {\n      toast({\n        title: 'All synced!',\n        description: 'Your pending data has been saved successfully.',\n        duration: 3000,\n      });\n      setRetryCount(0);\n    } else if (failedActions.length > 0) {\n      setRetryCount(prev => prev + 1);\n    }\n  }, [networkStatus.isOnline, pendingActions, toast]);\n\n  useEffect(() => {\n    if (networkStatus.connectionState === 'connected' && networkStatus.wasOffline && pendingActions.length > 0) {\n      setRetryCount(0);\n      const timer = setTimeout(() => {\n        retryPendingActions();\n      }, 1500);\n      return () => clearTimeout(timer);\n    }\n  }, [networkStatus.connectionState, networkStatus.wasOffline]);\n\n  useEffect(() => {\n    if (retryTimeoutRef.current) {\n      clearTimeout(retryTimeoutRef.current);\n      retryTimeoutRef.current = null;\n    }\n    if (countdownIntervalRef.current) {\n      clearInterval(countdownIntervalRef.current);\n      countdownIntervalRef.current = null;\n    }\n\n    if (networkStatus.isOnline && pendingActions.length > 0 && retryCount > 0 && retryCount < MAX_RETRIES) {\n      const delay = calculateRetryDelay(retryCount);\n      let remaining = Math.ceil(delay / 1000);\n      setNextRetryIn(remaining);\n\n      countdownIntervalRef.current = setInterval(() => {\n        remaining -= 1;\n        setNextRetryIn(remaining > 0 ? remaining : null);\n      }, 1000);\n\n      retryTimeoutRef.current = setTimeout(async () => {\n        const reachable = await checkServerReachability();\n        if (reachable) {\n          retryPendingActions();\n        } else {\n          setRetryCount(prev => prev + 1);\n        }\n      }, delay);\n    } else {\n      setNextRetryIn(null);\n    }\n\n    return () => {\n      if (retryTimeoutRef.current) {\n        clearTimeout(retryTimeoutRef.current);\n      }\n      if (countdownIntervalRef.current) {\n        clearInterval(countdownIntervalRef.current);\n      }\n    };\n  }, [networkStatus.isOnline, pendingActions.length, retryCount, retryPendingActions]);\n\n  useEffect(() => {\n    if (pendingActions.length === 0) {\n      setRetryCount(0);\n      setNextRetryIn(null);\n    }\n  }, [pendingActions.length]);\n\n  return (\n    <NetworkContext.Provider\n      value={{\n        ...networkStatus,\n        isServerReachable,\n        isCheckingServer,\n        checkConnection,\n        pendingActions,\n        addPendingAction,\n        removePendingAction,\n        clearPendingActions,\n        retryPendingActions,\n        nextRetryIn,\n        retryCount,\n      }}\n    >\n      {children}\n    </NetworkContext.Provider>\n  );\n}\n\nexport function useNetwork(): NetworkContextType {\n  const context = useContext(NetworkContext);\n  if (!context) {\n    throw new Error('useNetwork must be used within a NetworkProvider');\n  }\n  return context;\n}\n\nexport function useOfflineAwareAction() {\n  const { isOnline, connectionState, addPendingAction } = useNetwork();\n\n  return useCallback(\n    async <T,>(\n      actionFn: () => Promise<T>,\n      pendingAction: Omit<PendingAction, 'timestamp' | 'retryCount'>\n    ): Promise<T | null> => {\n      if (!isOnline || connectionState === 'disconnected') {\n        addPendingAction({\n          ...pendingAction,\n          timestamp: new Date(),\n          retryCount: 0,\n        });\n        return null;\n      }\n\n      try {\n        return await actionFn();\n      } catch (error) {\n        if (error instanceof TypeError && error.message.includes('fetch')) {\n          addPendingAction({\n            ...pendingAction,\n            timestamp: new Date(),\n            retryCount: 0,\n          });\n          return null;\n        }\n        throw error;\n      }\n    },\n    [isOnline, connectionState, addPendingAction]\n  );\n}\n","path":null,"size_bytes":11586,"size_tokens":null},"server/stress-test-anticheat.ts":{"content":"import { storage } from \"./storage\";\n\nexport interface StressTestValidationResult {\n  isValid: boolean;\n  errors: string[];\n  flags: string[];\n  requiresManualReview: boolean;\n}\n\nexport interface StressTestSubmission {\n  userId: string;\n  difficulty: string;\n  wpm: number;\n  accuracy: number;\n  stressScore: number;\n  completionRate: number;\n  duration: number;\n  survivalTime: number;\n  totalCharacters: number;\n  errors: number;\n  maxCombo: number;\n}\n\nconst VALIDATION_CONSTANTS = {\n  MAX_WPM: 250,\n  MIN_ACCURACY: 50,\n  MAX_ACCURACY: 100,\n  MIN_COMPLETION_RATE: 0,\n  MAX_COMPLETION_RATE: 100,\n  PROGRESSION_THRESHOLD_WPM: 50,\n  SUSPICIOUS_FIRST_ATTEMPT_WPM: 180,\n  HIGH_SCORE_THRESHOLD_WPM: 150,\n  MAX_STRESS_SCORE_BY_DIFFICULTY: {\n    beginner: 15000,\n    intermediate: 12000,\n    advanced: 10000,\n    expert: 8000,\n    nightmare: 6000,\n    impossible: 4000,\n  } as Record<string, number>,\n  MIN_TEST_DURATION_SECONDS: 5,\n  MAX_CHARS_PER_SECOND: 15,\n};\n\nexport async function validateStressTestSubmission(\n  submission: StressTestSubmission\n): Promise<StressTestValidationResult> {\n  const errors: string[] = [];\n  const flags: string[] = [];\n  let requiresManualReview = false;\n\n  if (submission.wpm > VALIDATION_CONSTANTS.MAX_WPM) {\n    errors.push(`WPM (${submission.wpm}) exceeds maximum possible (${VALIDATION_CONSTANTS.MAX_WPM})`);\n  }\n\n  if (submission.wpm < 0) {\n    errors.push(\"WPM cannot be negative\");\n  }\n\n  if (submission.accuracy < VALIDATION_CONSTANTS.MIN_ACCURACY || \n      submission.accuracy > VALIDATION_CONSTANTS.MAX_ACCURACY) {\n    errors.push(`Accuracy (${submission.accuracy}) is out of valid range (${VALIDATION_CONSTANTS.MIN_ACCURACY}-${VALIDATION_CONSTANTS.MAX_ACCURACY})`);\n  }\n\n  if (submission.completionRate < VALIDATION_CONSTANTS.MIN_COMPLETION_RATE || \n      submission.completionRate > VALIDATION_CONSTANTS.MAX_COMPLETION_RATE) {\n    errors.push(`Completion rate (${submission.completionRate}) is out of valid range`);\n  }\n\n  if (submission.duration < VALIDATION_CONSTANTS.MIN_TEST_DURATION_SECONDS) {\n    errors.push(`Test duration (${submission.duration}s) is too short`);\n  }\n\n  if (submission.stressScore < 0) {\n    errors.push(\"Stress score cannot be negative\");\n  }\n\n  // Session timing validation: Check if duration matches the characters typed\n  // Maximum typing speed is about 15 characters per second for elite typists\n  if (submission.totalCharacters > 0 && submission.duration > 0) {\n    const charsPerSecond = submission.totalCharacters / submission.duration;\n    if (charsPerSecond > VALIDATION_CONSTANTS.MAX_CHARS_PER_SECOND) {\n      errors.push(`Typing speed (${charsPerSecond.toFixed(1)} chars/sec) exceeds human limits (${VALIDATION_CONSTANTS.MAX_CHARS_PER_SECOND} chars/sec)`);\n    }\n    \n    // Also validate that survivalTime is reasonable relative to duration\n    if (submission.survivalTime > submission.duration * 1.1) {\n      errors.push(`Survival time (${submission.survivalTime}s) exceeds test duration (${submission.duration}s)`);\n    }\n  }\n\n  const maxScoreForDifficulty = VALIDATION_CONSTANTS.MAX_STRESS_SCORE_BY_DIFFICULTY[submission.difficulty];\n  if (maxScoreForDifficulty && submission.stressScore > maxScoreForDifficulty) {\n    flags.push(`stress_score_exceeds_difficulty_max:${submission.stressScore}>${maxScoreForDifficulty}`);\n    requiresManualReview = true;\n  }\n\n  if (submission.totalCharacters > 0 && submission.duration > 0) {\n    const calculatedWpm = Math.round((submission.totalCharacters / 5) / (submission.duration / 60));\n    const wpmDifference = Math.abs(calculatedWpm - submission.wpm);\n    if (wpmDifference > 20) {\n      flags.push(`wpm_mismatch:claimed=${submission.wpm},calculated=${calculatedWpm}`);\n    }\n  }\n\n  try {\n    const userTests = await storage.getUserStressTests(submission.userId, 5);\n    \n    if (userTests.length === 0) {\n      if (submission.wpm > VALIDATION_CONSTANTS.SUSPICIOUS_FIRST_ATTEMPT_WPM) {\n        flags.push(`suspicious_first_attempt:${submission.wpm}wpm`);\n        requiresManualReview = true;\n      }\n    } else {\n      const recentSameDifficulty = userTests.filter(t => t.difficulty === submission.difficulty);\n      if (recentSameDifficulty.length > 0) {\n        const avgPreviousWpm = recentSameDifficulty.reduce((sum, t) => sum + t.wpm, 0) / recentSameDifficulty.length;\n        const wpmImprovement = submission.wpm - avgPreviousWpm;\n        \n        if (wpmImprovement > VALIDATION_CONSTANTS.PROGRESSION_THRESHOLD_WPM) {\n          flags.push(`sudden_improvement:+${Math.round(wpmImprovement)}wpm`);\n          requiresManualReview = true;\n        }\n      }\n    }\n  } catch (error) {\n    console.error(\"Error checking user history for anti-cheat:\", error);\n  }\n\n  if (submission.wpm > VALIDATION_CONSTANTS.HIGH_SCORE_THRESHOLD_WPM) {\n    flags.push(`high_wpm_score:${submission.wpm}`);\n  }\n\n  if (submission.accuracy === 100 && submission.wpm > 100) {\n    flags.push(\"perfect_accuracy_high_speed\");\n  }\n\n  return {\n    isValid: errors.length === 0,\n    errors,\n    flags,\n    requiresManualReview: requiresManualReview && errors.length === 0,\n  };\n}\n\nexport function formatValidationErrors(result: StressTestValidationResult): string {\n  if (result.isValid) return \"\";\n  return result.errors.join(\"; \");\n}\n\nexport function logSuspiciousSubmission(\n  userId: string,\n  submission: StressTestSubmission,\n  result: StressTestValidationResult\n): void {\n  if (result.flags.length > 0 || !result.isValid) {\n    console.warn(`[ANTI-CHEAT] Suspicious stress test submission:`, {\n      userId,\n      difficulty: submission.difficulty,\n      wpm: submission.wpm,\n      accuracy: submission.accuracy,\n      stressScore: submission.stressScore,\n      flags: result.flags,\n      errors: result.errors,\n      requiresManualReview: result.requiresManualReview,\n      timestamp: new Date().toISOString(),\n    });\n  }\n}\n","path":null,"size_bytes":5833,"size_tokens":null},"server/auth-security.ts":{"content":"import crypto from \"node:crypto\";\nimport type { Request, Response, NextFunction } from \"express\";\nimport { storage } from \"./storage\";\n\nexport type AuthEventType = \n  | \"login_success\"\n  | \"login_failed\"\n  | \"logout\"\n  | \"oauth_login\"\n  | \"oauth_link\"\n  | \"oauth_unlink\"\n  | \"password_change\"\n  | \"remember_me_created\"\n  | \"remember_me_used\"\n  | \"remember_me_theft_detected\"\n  | \"session_created\"\n  | \"session_revoked\"\n  | \"account_locked\"\n  | \"account_unlocked\"\n  | \"rate_limit_exceeded\";\n\nexport interface AuthAuditLog {\n  eventType: AuthEventType;\n  userId?: string;\n  email?: string;\n  provider?: string;\n  ipAddress: string;\n  userAgent: string;\n  deviceFingerprint: string;\n  success: boolean;\n  metadata?: Record<string, any>;\n  timestamp: Date;\n}\n\nexport interface DeviceInfo {\n  userAgent: string;\n  ipAddress: string;\n  fingerprint: string;\n  acceptLanguage?: string;\n  platform?: string;\n}\n\nexport function generateDeviceFingerprint(req: Request): string {\n  const components = [\n    req.get(\"User-Agent\") || \"unknown\",\n    req.get(\"Accept-Language\") || \"unknown\",\n    req.get(\"Accept-Encoding\") || \"unknown\",\n    req.ip || \"unknown\",\n  ];\n  return crypto\n    .createHash(\"sha256\")\n    .update(components.join(\"|\"))\n    .digest(\"hex\")\n    .slice(0, 32);\n}\n\nexport function extractDeviceInfo(req: Request): DeviceInfo {\n  return {\n    userAgent: req.get(\"User-Agent\") || \"unknown\",\n    ipAddress: req.ip || \"unknown\",\n    fingerprint: generateDeviceFingerprint(req),\n    acceptLanguage: req.get(\"Accept-Language\"),\n    platform: extractPlatform(req.get(\"User-Agent\") || \"\"),\n  };\n}\n\nfunction extractPlatform(userAgent: string): string {\n  if (/Windows/.test(userAgent)) return \"Windows\";\n  if (/Macintosh/.test(userAgent)) return \"macOS\";\n  if (/Linux/.test(userAgent)) return \"Linux\";\n  if (/Android/.test(userAgent)) return \"Android\";\n  if (/iPhone|iPad/.test(userAgent)) return \"iOS\";\n  return \"Unknown\";\n}\n\nexport function logAuthEvent(event: Omit<AuthAuditLog, \"timestamp\">): void {\n  const log: AuthAuditLog = {\n    ...event,\n    timestamp: new Date(),\n  };\n  \n  const logLevel = event.success ? \"info\" : \"warn\";\n  const sanitizedLog = {\n    ...log,\n    userAgent: log.userAgent.slice(0, 100),\n  };\n  \n  if (event.eventType === \"remember_me_theft_detected\") {\n    console.error(\"[AUTH SECURITY] Token theft detected:\", sanitizedLog);\n  } else if (logLevel === \"warn\") {\n    console.warn(\"[AUTH AUDIT]\", sanitizedLog);\n  } else {\n    console.log(\"[AUTH AUDIT]\", event.eventType, event.userId || event.email || \"anonymous\");\n  }\n  \n  storage.createAuditLog({\n    eventType: event.eventType,\n    userId: event.userId || null,\n    ipAddress: event.ipAddress,\n    userAgent: event.userAgent,\n    deviceFingerprint: event.deviceFingerprint,\n    provider: event.provider || null,\n    success: event.success,\n    failureReason: event.metadata?.failureReason || null,\n    metadata: event.metadata ? event.metadata : null,\n  }).catch((err) => {\n    console.error(\"[AUTH AUDIT] Failed to persist audit log:\", err);\n  });\n}\n\nexport async function getRecentAuthEvents(\n  userId?: string,\n  limit: number = 50\n): Promise<AuthAuditLog[]> {\n  const logs = userId \n    ? await storage.getUserAuditLogs(userId, limit)\n    : await storage.getAuditLogs({ limit });\n  \n  return logs.map((log) => ({\n    eventType: log.eventType as AuthEventType,\n    userId: log.userId || undefined,\n    provider: log.provider || undefined,\n    ipAddress: log.ipAddress || \"unknown\",\n    userAgent: log.userAgent || \"unknown\",\n    deviceFingerprint: log.deviceFingerprint || \"unknown\",\n    success: log.success,\n    metadata: log.metadata as Record<string, any> | undefined,\n    timestamp: log.createdAt,\n  }));\n}\n\nexport function generateOAuthState(): string {\n  return crypto.randomBytes(32).toString(\"hex\");\n}\n\nexport function generateCodeVerifier(): string {\n  return crypto.randomBytes(32).toString(\"base64url\");\n}\n\nexport function generateCodeChallenge(verifier: string): string {\n  return crypto.createHash(\"sha256\").update(verifier).digest(\"base64url\");\n}\n\nconst STATE_EXPIRY_MS = 10 * 60 * 1000;\n\nexport async function storeOAuthState(\n  state: string,\n  provider: string,\n  options?: { \n    codeVerifier?: string; \n    returnTo?: string;\n    linkToUserId?: string;\n  }\n): Promise<void> {\n  storage.deleteExpiredOAuthStates().catch(() => {});\n  \n  const expiresAt = new Date(Date.now() + STATE_EXPIRY_MS);\n  \n  await storage.createOAuthState({\n    state,\n    provider,\n    codeVerifier: options?.codeVerifier || null,\n    redirectTo: options?.returnTo || null,\n    linkUserId: options?.linkToUserId || null,\n    expiresAt,\n  });\n}\n\nexport async function validateAndConsumeOAuthState(\n  state: string\n): Promise<{ \n  valid: boolean; \n  codeVerifier?: string; \n  returnTo?: string;\n  linkToUserId?: string;\n}> {\n  const stored = await storage.getOAuthState(state);\n  if (!stored) {\n    return { valid: false };\n  }\n  \n  await storage.deleteOAuthState(state);\n  \n  if (new Date() > stored.expiresAt) {\n    return { valid: false };\n  }\n  \n  return {\n    valid: true,\n    codeVerifier: stored.codeVerifier || undefined,\n    returnTo: stored.redirectTo || undefined,\n    linkToUserId: stored.linkUserId || undefined,\n  };\n}\n\nexport interface RateLimitEntry {\n  count: number;\n  firstAttempt: Date;\n  lastAttempt: Date;\n  blocked: boolean;\n}\n\nconst rateLimitStore = new Map<string, RateLimitEntry>();\n\ninterface RateLimitConfig {\n  windowMs: number;\n  maxAttempts: number;\n  blockDurationMs: number;\n}\n\nconst authRateLimits: Record<string, RateLimitConfig> = {\n  login: { windowMs: 15 * 60 * 1000, maxAttempts: 5, blockDurationMs: 30 * 60 * 1000 },\n  oauth: { windowMs: 15 * 60 * 1000, maxAttempts: 10, blockDurationMs: 15 * 60 * 1000 },\n  passwordChange: { windowMs: 60 * 60 * 1000, maxAttempts: 3, blockDurationMs: 60 * 60 * 1000 },\n  unlink: { windowMs: 60 * 60 * 1000, maxAttempts: 5, blockDurationMs: 60 * 60 * 1000 },\n};\n\nexport function checkRateLimit(\n  identifier: string,\n  action: keyof typeof authRateLimits\n): { allowed: boolean; remainingAttempts: number; retryAfterMs?: number } {\n  const config = authRateLimits[action];\n  const key = `${action}:${identifier}`;\n  const entry = rateLimitStore.get(key);\n  const now = Date.now();\n\n  if (!entry) {\n    rateLimitStore.set(key, {\n      count: 1,\n      firstAttempt: new Date(),\n      lastAttempt: new Date(),\n      blocked: false,\n    });\n    return { allowed: true, remainingAttempts: config.maxAttempts - 1 };\n  }\n\n  if (entry.blocked) {\n    const blockEndTime = entry.lastAttempt.getTime() + config.blockDurationMs;\n    if (now < blockEndTime) {\n      return {\n        allowed: false,\n        remainingAttempts: 0,\n        retryAfterMs: blockEndTime - now,\n      };\n    }\n    rateLimitStore.delete(key);\n    return checkRateLimit(identifier, action);\n  }\n\n  const windowStart = now - config.windowMs;\n  if (entry.firstAttempt.getTime() < windowStart) {\n    rateLimitStore.set(key, {\n      count: 1,\n      firstAttempt: new Date(),\n      lastAttempt: new Date(),\n      blocked: false,\n    });\n    return { allowed: true, remainingAttempts: config.maxAttempts - 1 };\n  }\n\n  entry.count++;\n  entry.lastAttempt = new Date();\n\n  if (entry.count > config.maxAttempts) {\n    entry.blocked = true;\n    return {\n      allowed: false,\n      remainingAttempts: 0,\n      retryAfterMs: config.blockDurationMs,\n    };\n  }\n\n  return {\n    allowed: true,\n    remainingAttempts: config.maxAttempts - entry.count,\n  };\n}\n\nexport function resetRateLimit(identifier: string, action: keyof typeof authRateLimits): void {\n  const key = `${action}:${identifier}`;\n  rateLimitStore.delete(key);\n}\n\nexport function validateDeviceBinding(\n  storedFingerprint: string | null,\n  currentFingerprint: string,\n  strictMode: boolean = false\n): boolean {\n  if (!storedFingerprint) return true;\n  \n  if (strictMode) {\n    return storedFingerprint === currentFingerprint;\n  }\n  \n  const similarity = calculateFingerprintSimilarity(storedFingerprint, currentFingerprint);\n  return similarity > 0.5;\n}\n\nfunction calculateFingerprintSimilarity(fp1: string, fp2: string): number {\n  if (fp1 === fp2) return 1.0;\n  \n  let matches = 0;\n  const len = Math.min(fp1.length, fp2.length);\n  for (let i = 0; i < len; i++) {\n    if (fp1[i] === fp2[i]) matches++;\n  }\n  return matches / len;\n}\n\nexport async function canUnlinkProvider(\n  userId: string,\n  providerToUnlink: string\n): Promise<{ allowed: boolean; reason?: string }> {\n  const user = await storage.getUser(userId);\n  if (!user) {\n    return { allowed: false, reason: \"User not found\" };\n  }\n\n  const linkedAccounts = await storage.getUserOAuthAccounts(userId);\n  const hasPassword = !!user.password;\n  const otherProviders = linkedAccounts.filter((acc: { provider: string }) => acc.provider !== providerToUnlink);\n\n  if (!hasPassword && otherProviders.length === 0) {\n    return {\n      allowed: false,\n      reason: \"Cannot unlink the only login method. Please set a password first or link another account.\",\n    };\n  }\n\n  return { allowed: true };\n}\n\nexport function getProviderAvailability(): Record<string, boolean> {\n  return {\n    google: !!(process.env.GOOGLE_CLIENT_ID && process.env.GOOGLE_CLIENT_SECRET),\n    github: !!(process.env.GITHUB_CLIENT_ID && process.env.GITHUB_CLIENT_SECRET),\n    facebook: !!(process.env.FACEBOOK_APP_ID && process.env.FACEBOOK_APP_SECRET),\n  };\n}\n\nexport function regenerateSession(req: Request): Promise<void> {\n  return new Promise((resolve, reject) => {\n    const oldSession = req.session;\n    req.session.regenerate((err) => {\n      if (err) {\n        reject(err);\n        return;\n      }\n      \n      if (oldSession) {\n        Object.keys(oldSession).forEach((key) => {\n          if (key !== \"cookie\" && key !== \"id\") {\n            (req.session as any)[key] = (oldSession as any)[key];\n          }\n        });\n      }\n      \n      resolve();\n    });\n  });\n}\n\nexport function csrfProtection() {\n  return (req: Request, res: Response, next: NextFunction) => {\n    if ([\"POST\", \"PUT\", \"DELETE\", \"PATCH\"].includes(req.method)) {\n      const origin = req.get(\"Origin\");\n      const host = req.get(\"Host\");\n      \n      if (origin) {\n        try {\n          const originUrl = new URL(origin);\n          const expectedHost = host?.split(\":\")[0];\n          const actualHost = originUrl.hostname;\n          \n          if (actualHost !== expectedHost && actualHost !== \"localhost\") {\n            console.warn(\"[CSRF] Origin mismatch:\", { origin, host });\n            return res.status(403).json({ message: \"CSRF validation failed\" });\n          }\n        } catch {\n          return res.status(403).json({ message: \"Invalid origin header\" });\n        }\n      }\n    }\n    next();\n  };\n}\n\nexport function securityHeaders() {\n  return (_req: Request, res: Response, next: NextFunction) => {\n    res.setHeader(\"X-Content-Type-Options\", \"nosniff\");\n    res.setHeader(\"X-Frame-Options\", \"DENY\");\n    res.setHeader(\"X-XSS-Protection\", \"1; mode=block\");\n    res.setHeader(\"Referrer-Policy\", \"strict-origin-when-cross-origin\");\n    res.setHeader(\n      \"Content-Security-Policy\",\n      \"default-src 'self'; \" +\n      \"script-src 'self' 'unsafe-inline' 'unsafe-eval'; \" +\n      \"style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; \" +\n      \"font-src 'self' https://fonts.gstatic.com; \" +\n      \"img-src 'self' data: https:; \" +\n      \"connect-src 'self' https://accounts.google.com https://github.com https://www.facebook.com; \" +\n      \"frame-ancestors 'none';\"\n    );\n    \n    if (process.env.NODE_ENV === \"production\") {\n      res.setHeader(\n        \"Strict-Transport-Security\",\n        \"max-age=31536000; includeSubDomains; preload\"\n      );\n    }\n    \n    next();\n  };\n}\n","path":null,"size_bytes":11671,"size_tokens":null},"server/oauth-service.ts":{"content":"import crypto from \"node:crypto\";\nimport passport from \"passport\";\nimport { Strategy as GoogleStrategy, Profile as GoogleProfile } from \"passport-google-oauth20\";\nimport { Strategy as GitHubStrategy, Profile as GitHubProfile } from \"passport-github2\";\nimport { Strategy as FacebookStrategy, Profile as FacebookProfile } from \"passport-facebook\";\nimport { storage } from \"./storage\";\nimport type { User, OAuthProvider } from \"@shared/schema\";\nimport type { Request, Response, NextFunction } from \"express\";\nimport {\n  generateOAuthState,\n  generateCodeVerifier,\n  generateCodeChallenge,\n  storeOAuthState,\n  validateAndConsumeOAuthState,\n  logAuthEvent,\n  extractDeviceInfo,\n  generateDeviceFingerprint,\n  validateDeviceBinding,\n  checkRateLimit,\n  canUnlinkProvider,\n  getProviderAvailability,\n  regenerateSession,\n} from \"./auth-security\";\n\nconst REMEMBER_ME_COOKIE = \"remember_me\";\nconst REMEMBER_ME_EXPIRY_DAYS = 30;\n\nfunction hashToken(token: string): string {\n  return crypto.createHash(\"sha256\").update(token).digest(\"hex\");\n}\n\nfunction generateSecureToken(): string {\n  return crypto.randomBytes(32).toString(\"hex\");\n}\n\nexport interface PersistentLoginToken {\n  series: string;\n  token: string;\n}\n\nexport function parsePersistentLoginCookie(cookieValue: string): PersistentLoginToken | null {\n  try {\n    const parts = cookieValue.split(\":\");\n    if (parts.length !== 2) return null;\n    return { series: parts[0], token: parts[1] };\n  } catch {\n    return null;\n  }\n}\n\nexport function formatPersistentLoginCookie(series: string, token: string): string {\n  return `${series}:${token}`;\n}\n\nexport async function createRememberMeToken(\n  userId: string,\n  userAgent?: string,\n  ipAddress?: string,\n  deviceFingerprint?: string\n): Promise<{ series: string; token: string; cookieValue: string }> {\n  const series = generateSecureToken();\n  const token = generateSecureToken();\n  const tokenHash = hashToken(token);\n  const expiresAt = new Date(Date.now() + REMEMBER_ME_EXPIRY_DAYS * 24 * 60 * 60 * 1000);\n\n  await storage.createPersistentLogin({\n    userId,\n    series,\n    tokenHash,\n    expiresAt,\n    userAgent: userAgent || null,\n    ipAddress: ipAddress || null,\n    deviceFingerprint: deviceFingerprint || null,\n    lastUsed: new Date(),\n  });\n\n  logAuthEvent({\n    eventType: \"remember_me_created\",\n    userId,\n    ipAddress: ipAddress || \"unknown\",\n    userAgent: userAgent || \"unknown\",\n    deviceFingerprint: deviceFingerprint || \"unknown\",\n    success: true,\n  });\n\n  return { series, token, cookieValue: formatPersistentLoginCookie(series, token) };\n}\n\nexport interface ValidateRememberMeResult {\n  valid: boolean;\n  user?: User;\n  newCookieValue?: string;\n  theftDetected?: boolean;\n  deviceMismatch?: boolean;\n}\n\nexport async function validateAndRotateRememberMeToken(\n  cookieValue: string,\n  userAgent?: string,\n  ipAddress?: string,\n  deviceFingerprint?: string\n): Promise<ValidateRememberMeResult> {\n  const parsed = parsePersistentLoginCookie(cookieValue);\n  if (!parsed) {\n    return { valid: false };\n  }\n\n  const { series, token } = parsed;\n  const persistentLogin = await storage.getPersistentLogin(series);\n\n  if (!persistentLogin) {\n    return { valid: false };\n  }\n\n  if (new Date() > persistentLogin.expiresAt) {\n    await storage.deletePersistentLogin(series);\n    return { valid: false };\n  }\n\n  const tokenHash = hashToken(token);\n  if (tokenHash !== persistentLogin.tokenHash) {\n    logAuthEvent({\n      eventType: \"remember_me_theft_detected\",\n      userId: persistentLogin.userId,\n      ipAddress: ipAddress || \"unknown\",\n      userAgent: userAgent || \"unknown\",\n      deviceFingerprint: deviceFingerprint || \"unknown\",\n      success: false,\n      metadata: {\n        series,\n        storedIp: persistentLogin.ipAddress,\n        currentIp: ipAddress,\n      },\n    });\n    \n    await storage.deleteAllUserPersistentLogins(persistentLogin.userId);\n    return { valid: false, theftDetected: true };\n  }\n\n  if (deviceFingerprint && persistentLogin.deviceFingerprint) {\n    const isValidDevice = validateDeviceBinding(\n      persistentLogin.deviceFingerprint,\n      deviceFingerprint,\n      false\n    );\n    \n    if (!isValidDevice) {\n      logAuthEvent({\n        eventType: \"remember_me_used\",\n        userId: persistentLogin.userId,\n        ipAddress: ipAddress || \"unknown\",\n        userAgent: userAgent || \"unknown\",\n        deviceFingerprint: deviceFingerprint || \"unknown\",\n        success: false,\n        metadata: { reason: \"device_mismatch\", series },\n      });\n      return { valid: false, deviceMismatch: true };\n    }\n  }\n\n  const user = await storage.getUser(persistentLogin.userId);\n  if (!user) {\n    await storage.deletePersistentLogin(series);\n    return { valid: false };\n  }\n\n  const newToken = generateSecureToken();\n  const newTokenHash = hashToken(newToken);\n  await storage.updatePersistentLoginToken(series, newTokenHash, new Date());\n\n  logAuthEvent({\n    eventType: \"remember_me_used\",\n    userId: user.id,\n    ipAddress: ipAddress || \"unknown\",\n    userAgent: userAgent || \"unknown\",\n    deviceFingerprint: deviceFingerprint || \"unknown\",\n    success: true,\n  });\n\n  return {\n    valid: true,\n    user,\n    newCookieValue: formatPersistentLoginCookie(series, newToken),\n  };\n}\n\nexport async function clearRememberMeToken(cookieValue: string): Promise<void> {\n  const parsed = parsePersistentLoginCookie(cookieValue);\n  if (parsed) {\n    await storage.deletePersistentLogin(parsed.series);\n  }\n}\n\nexport function getRememberMeCookieOptions(\n  secure: boolean\n): {\n  httpOnly: boolean;\n  secure: boolean;\n  sameSite: \"lax\" | \"strict\" | \"none\";\n  maxAge: number;\n  path: string;\n  priority: \"high\" | \"medium\" | \"low\";\n} {\n  return {\n    httpOnly: true,\n    secure,\n    sameSite: \"lax\",\n    maxAge: REMEMBER_ME_EXPIRY_DAYS * 24 * 60 * 60 * 1000,\n    path: \"/\",\n    priority: \"high\",\n  };\n}\n\nexport function getClearCookieOptions(secure: boolean): {\n  httpOnly: boolean;\n  secure: boolean;\n  sameSite: \"lax\" | \"strict\" | \"none\";\n  path: string;\n} {\n  return {\n    httpOnly: true,\n    secure,\n    sameSite: \"lax\",\n    path: \"/\",\n  };\n}\n\nfunction getBaseUrl(): string {\n  // Prioritize APP_URL for production OAuth redirects (stable domain)\n  if (process.env.APP_URL) {\n    return process.env.APP_URL;\n  }\n  // Fallback to Replit domains for development if APP_URL not set\n  if (process.env.REPLIT_DEV_DOMAIN) {\n    return `https://${process.env.REPLIT_DEV_DOMAIN}`;\n  }\n  if (process.env.REPL_SLUG && process.env.REPL_OWNER) {\n    return `https://${process.env.REPL_SLUG}.${process.env.REPL_OWNER}.repl.co`;\n  }\n  return \"http://localhost:5000\";\n}\n\ntype OAuthProfileInfo = {\n  id: string;\n  email: string | null;\n  profileName: string;\n  avatarUrl?: string;\n};\n\nfunction extractProfileInfo(\n  provider: OAuthProvider,\n  profile: GoogleProfile | GitHubProfile | FacebookProfile\n): OAuthProfileInfo {\n  let email: string | null = null;\n  let avatarUrl: string | undefined;\n\n  if (profile.emails && profile.emails.length > 0) {\n    email = profile.emails[0].value;\n  }\n\n  if (profile.photos && profile.photos.length > 0) {\n    avatarUrl = profile.photos[0].value;\n  }\n\n  const profileName = profile.displayName || (profile as any).username || `User${profile.id.slice(0, 6)}`;\n\n  return {\n    id: profile.id,\n    email,\n    profileName,\n    avatarUrl,\n  };\n}\n\nfunction hashAccessToken(token: string): string {\n  return crypto.createHash(\"sha256\").update(token).digest(\"hex\");\n}\n\nasync function handleOAuthCallback(\n  req: Request,\n  provider: OAuthProvider,\n  profile: OAuthProfileInfo,\n  accessToken: string,\n  refreshToken: string | undefined,\n  done: (error: any, user?: User | false, info?: object) => void\n) {\n  const deviceInfo = extractDeviceInfo(req);\n  \n  try {\n    const linkToUserId = (req as any).oauthLinkUserId;\n    \n    if (linkToUserId) {\n      const existingAccount = await storage.getOAuthAccount(provider, profile.id);\n      if (existingAccount && existingAccount.userId !== linkToUserId) {\n        logAuthEvent({\n          eventType: \"oauth_link\",\n          userId: linkToUserId,\n          provider,\n          ipAddress: deviceInfo.ipAddress,\n          userAgent: deviceInfo.userAgent,\n          deviceFingerprint: deviceInfo.fingerprint,\n          success: false,\n          metadata: { reason: \"already_linked_to_another_account\" },\n        });\n        return done(null, false, { message: \"This social account is already linked to another user\" });\n      }\n      \n      await storage.linkOAuthAccount(linkToUserId, {\n        provider,\n        providerUserId: profile.id,\n        email: profile.email,\n        profileName: profile.profileName,\n        avatarUrl: profile.avatarUrl || null,\n        accessTokenHash: hashAccessToken(accessToken),\n        refreshTokenHash: refreshToken ? hashAccessToken(refreshToken) : null,\n      });\n      \n      const user = await storage.getUser(linkToUserId);\n      \n      logAuthEvent({\n        eventType: \"oauth_link\",\n        userId: linkToUserId,\n        provider,\n        ipAddress: deviceInfo.ipAddress,\n        userAgent: deviceInfo.userAgent,\n        deviceFingerprint: deviceInfo.fingerprint,\n        success: true,\n      });\n      \n      return done(null, user || false);\n    }\n    \n    let user = await storage.findUserByOAuthProvider(provider, profile.id);\n\n    if (user) {\n      logAuthEvent({\n        eventType: \"oauth_login\",\n        userId: user.id,\n        provider,\n        ipAddress: deviceInfo.ipAddress,\n        userAgent: deviceInfo.userAgent,\n        deviceFingerprint: deviceInfo.fingerprint,\n        success: true,\n      });\n      return done(null, user);\n    }\n\n    if (profile.email) {\n      const existingUser = await storage.getUserByEmail(profile.email);\n      if (existingUser) {\n        await storage.linkOAuthAccount(existingUser.id, {\n          provider,\n          providerUserId: profile.id,\n          email: profile.email,\n          profileName: profile.profileName,\n          avatarUrl: profile.avatarUrl || null,\n          accessTokenHash: hashAccessToken(accessToken),\n          refreshTokenHash: refreshToken ? hashAccessToken(refreshToken) : null,\n        });\n        \n        logAuthEvent({\n          eventType: \"oauth_login\",\n          userId: existingUser.id,\n          email: profile.email,\n          provider,\n          ipAddress: deviceInfo.ipAddress,\n          userAgent: deviceInfo.userAgent,\n          deviceFingerprint: deviceInfo.fingerprint,\n          success: true,\n          metadata: { linkedExisting: true },\n        });\n        \n        return done(null, existingUser);\n      }\n    }\n\n    let username = profile.profileName.toLowerCase().replace(/[^a-z0-9]/g, \"\");\n    if (username.length < 3) {\n      username = `user${profile.id.slice(0, 8)}`;\n    }\n\n    let usernameAttempt = username;\n    let attempt = 0;\n    while (await storage.getUserByUsername(usernameAttempt)) {\n      attempt++;\n      usernameAttempt = `${username}${attempt}`;\n    }\n\n    const avatarColors = [\n      \"#E53E3E\", \"#DD6B20\", \"#D69E2E\", \"#38A169\", \"#319795\",\n      \"#3182CE\", \"#5A67D8\", \"#805AD5\", \"#D53F8C\", \"#718096\",\n    ];\n    const avatarColor = avatarColors[Math.floor(Math.random() * avatarColors.length)];\n\n    const userEmail = profile.email || `oauth.${provider}.${profile.id}@placeholder.typemasterai.local`;\n\n    user = await storage.createUser({\n      username: usernameAttempt,\n      email: userEmail,\n      password: null,\n      emailVerified: !!profile.email,\n      avatarColor,\n    });\n\n    await storage.linkOAuthAccount(user.id, {\n      provider,\n      providerUserId: profile.id,\n      email: profile.email,\n      profileName: profile.profileName,\n      avatarUrl: profile.avatarUrl || null,\n      accessTokenHash: hashAccessToken(accessToken),\n      refreshTokenHash: refreshToken ? hashAccessToken(refreshToken) : null,\n    });\n\n    logAuthEvent({\n      eventType: \"oauth_login\",\n      userId: user.id,\n      email: profile.email || undefined,\n      provider,\n      ipAddress: deviceInfo.ipAddress,\n      userAgent: deviceInfo.userAgent,\n      deviceFingerprint: deviceInfo.fingerprint,\n      success: true,\n      metadata: { newUser: true },\n    });\n\n    return done(null, user);\n  } catch (error) {\n    console.error(`OAuth ${provider} error:`, error);\n    \n    logAuthEvent({\n      eventType: \"oauth_login\",\n      provider,\n      ipAddress: deviceInfo.ipAddress,\n      userAgent: deviceInfo.userAgent,\n      deviceFingerprint: deviceInfo.fingerprint,\n      success: false,\n      metadata: { error: String(error) },\n    });\n    \n    return done(error);\n  }\n}\n\nexport function initializeOAuthStrategies() {\n  const baseUrl = getBaseUrl();\n  console.log(`OAuth base URL: ${baseUrl}`);\n\n  if (process.env.GOOGLE_CLIENT_ID && process.env.GOOGLE_CLIENT_SECRET) {\n    passport.use(\n      new GoogleStrategy(\n        {\n          clientID: process.env.GOOGLE_CLIENT_ID,\n          clientSecret: process.env.GOOGLE_CLIENT_SECRET,\n          callbackURL: `${baseUrl}/api/auth/callback/google`,\n          scope: [\"profile\", \"email\"],\n          passReqToCallback: true,\n        },\n        async (req: Request, accessToken: string, refreshToken: string, profile: GoogleProfile, done: any) => {\n          const info = extractProfileInfo(\"google\", profile);\n          await handleOAuthCallback(req, \"google\", info, accessToken, refreshToken, done);\n        }\n      )\n    );\n    console.log(\"Google OAuth strategy initialized\");\n  } else {\n    console.log(\"Google OAuth not configured (missing GOOGLE_CLIENT_ID or GOOGLE_CLIENT_SECRET)\");\n  }\n\n  if (process.env.GITHUB_CLIENT_ID && process.env.GITHUB_CLIENT_SECRET) {\n    passport.use(\n      new GitHubStrategy(\n        {\n          clientID: process.env.GITHUB_CLIENT_ID,\n          clientSecret: process.env.GITHUB_CLIENT_SECRET,\n          callbackURL: `${baseUrl}/api/auth/callback/github`,\n          scope: [\"user:email\"],\n          passReqToCallback: true,\n        },\n        async (req: Request, accessToken: string, refreshToken: string, profile: GitHubProfile, done: any) => {\n          const info = extractProfileInfo(\"github\", profile);\n          await handleOAuthCallback(req, \"github\", info, accessToken, refreshToken, done);\n        }\n      )\n    );\n    console.log(\"GitHub OAuth strategy initialized\");\n  } else {\n    console.log(\"GitHub OAuth not configured (missing GITHUB_CLIENT_ID or GITHUB_CLIENT_SECRET)\");\n  }\n\n  if (process.env.FACEBOOK_APP_ID && process.env.FACEBOOK_APP_SECRET) {\n    passport.use(\n      new FacebookStrategy(\n        {\n          clientID: process.env.FACEBOOK_APP_ID,\n          clientSecret: process.env.FACEBOOK_APP_SECRET,\n          callbackURL: `${baseUrl}/api/auth/callback/facebook`,\n          profileFields: [\"id\", \"emails\", \"name\", \"displayName\", \"photos\"],\n          passReqToCallback: true,\n        },\n        async (req: Request, accessToken: string, refreshToken: string, profile: FacebookProfile, done: any) => {\n          const info = extractProfileInfo(\"facebook\", profile);\n          await handleOAuthCallback(req, \"facebook\", info, accessToken, refreshToken, done);\n        }\n      )\n    );\n    console.log(\"Facebook OAuth strategy initialized\");\n  } else {\n    console.log(\"Facebook OAuth not configured (missing FACEBOOK_APP_ID or FACEBOOK_APP_SECRET)\");\n  }\n}\n\nexport function rememberMeMiddleware() {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    if (req.isAuthenticated?.() || !req.cookies?.[REMEMBER_ME_COOKIE]) {\n      return next();\n    }\n\n    const cookieValue = req.cookies[REMEMBER_ME_COOKIE];\n    const isSecure = req.secure || req.headers[\"x-forwarded-proto\"] === \"https\";\n    const deviceInfo = extractDeviceInfo(req);\n\n    try {\n      const result = await validateAndRotateRememberMeToken(\n        cookieValue,\n        deviceInfo.userAgent,\n        deviceInfo.ipAddress,\n        deviceInfo.fingerprint\n      );\n\n      if (result.theftDetected) {\n        console.warn(`Token theft detected for cookie, clearing all tokens`);\n        res.clearCookie(REMEMBER_ME_COOKIE, getClearCookieOptions(isSecure));\n        return next();\n      }\n\n      if (result.deviceMismatch) {\n        console.warn(`Device mismatch for remember-me token`);\n        res.clearCookie(REMEMBER_ME_COOKIE, getClearCookieOptions(isSecure));\n        return next();\n      }\n\n      if (result.valid && result.user && result.newCookieValue) {\n        res.cookie(REMEMBER_ME_COOKIE, result.newCookieValue, getRememberMeCookieOptions(isSecure));\n        \n        await regenerateSession(req).catch(() => {});\n        \n        req.login(result.user, (err) => {\n          if (err) {\n            console.error(\"Remember-me auto-login failed:\", err);\n          }\n          next();\n        });\n      } else {\n        res.clearCookie(REMEMBER_ME_COOKIE, getClearCookieOptions(isSecure));\n        next();\n      }\n    } catch (error) {\n      console.error(\"Remember-me middleware error:\", error);\n      res.clearCookie(REMEMBER_ME_COOKIE, getClearCookieOptions(isSecure));\n      next();\n    }\n  };\n}\n\nexport function setupRememberMeOnLogin(req: Request, res: Response, userId: string): Promise<void> {\n  return new Promise(async (resolve, reject) => {\n    try {\n      const isSecure = req.secure || req.headers[\"x-forwarded-proto\"] === \"https\";\n      const deviceInfo = extractDeviceInfo(req);\n\n      const { cookieValue } = await createRememberMeToken(\n        userId,\n        deviceInfo.userAgent,\n        deviceInfo.ipAddress,\n        deviceInfo.fingerprint\n      );\n      res.cookie(REMEMBER_ME_COOKIE, cookieValue, getRememberMeCookieOptions(isSecure));\n      resolve();\n    } catch (error) {\n      reject(error);\n    }\n  });\n}\n\nexport async function clearRememberMeOnLogout(req: Request, res: Response): Promise<void> {\n  const isSecure = req.secure || req.headers[\"x-forwarded-proto\"] === \"https\";\n  const cookieValue = req.cookies?.[REMEMBER_ME_COOKIE];\n  const userId = (req.user as User)?.id;\n\n  if (cookieValue) {\n    await clearRememberMeToken(cookieValue);\n    res.clearCookie(REMEMBER_ME_COOKIE, getClearCookieOptions(isSecure));\n  }\n\n  if (userId) {\n    const deviceInfo = extractDeviceInfo(req);\n    logAuthEvent({\n      eventType: \"logout\",\n      userId,\n      ipAddress: deviceInfo.ipAddress,\n      userAgent: deviceInfo.userAgent,\n      deviceFingerprint: deviceInfo.fingerprint,\n      success: true,\n    });\n  }\n}\n\nexport function oauthRateLimitMiddleware() {\n  return (req: Request, res: Response, next: NextFunction) => {\n    const identifier = req.ip || \"unknown\";\n    const result = checkRateLimit(identifier, \"oauth\");\n    \n    if (!result.allowed) {\n      logAuthEvent({\n        eventType: \"rate_limit_exceeded\",\n        ipAddress: identifier,\n        userAgent: req.get(\"User-Agent\") || \"unknown\",\n        deviceFingerprint: generateDeviceFingerprint(req),\n        success: false,\n        metadata: { action: \"oauth\", retryAfterMs: result.retryAfterMs },\n      });\n      \n      return res.status(429).json({\n        message: \"Too many authentication attempts. Please try again later.\",\n        retryAfterMs: result.retryAfterMs,\n      });\n    }\n    \n    next();\n  };\n}\n\nexport function initiateOAuthFlow(provider: string, linkToUserId?: string) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    try {\n      const state = generateOAuthState();\n      const codeVerifier = provider === \"google\" ? generateCodeVerifier() : undefined;\n      \n      await storeOAuthState(state, provider, {\n        codeVerifier,\n        returnTo: req.query.returnTo as string | undefined,\n        linkToUserId,\n      });\n\n      (req as any).oauthState = state;\n      (req as any).oauthCodeVerifier = codeVerifier;\n      \n      const authenticateOptions: any = { \n        state,\n        session: false,\n      };\n      \n      if (codeVerifier && provider === \"google\") {\n        authenticateOptions.codeChallenge = generateCodeChallenge(codeVerifier);\n        authenticateOptions.codeChallengeMethod = \"S256\";\n      }\n\n      passport.authenticate(provider, authenticateOptions)(req, res, next);\n    } catch (error) {\n      console.error(`Failed to initiate OAuth flow for ${provider}:`, error);\n      return res.redirect(\"/login?error=oauth_error\");\n    }\n  };\n}\n\nexport function handleOAuthCallbackFlow(provider: string) {\n  return async (req: Request, res: Response, next: NextFunction) => {\n    const state = req.query.state as string;\n    \n    if (!state) {\n      console.warn(`OAuth ${provider} callback missing state parameter`);\n      return res.redirect(\"/login?error=invalid_state\");\n    }\n    \n    const stateResult = await validateAndConsumeOAuthState(state);\n    \n    if (!stateResult.valid) {\n      console.warn(`OAuth ${provider} callback with invalid/expired state`);\n      return res.redirect(\"/login?error=invalid_state\");\n    }\n\n    if (stateResult.linkToUserId) {\n      (req as any).oauthLinkUserId = stateResult.linkToUserId;\n    }\n\n    passport.authenticate(provider, { session: false }, async (err: any, user: User | false, info: any) => {\n      const isSecure = req.secure || req.headers[\"x-forwarded-proto\"] === \"https\";\n      \n      if (err) {\n        console.error(`OAuth ${provider} authentication error:`, err);\n        return res.redirect(\"/login?error=oauth_error\");\n      }\n\n      if (!user) {\n        const message = info?.message || \"authentication_failed\";\n        return res.redirect(`/login?error=${encodeURIComponent(message)}`);\n      }\n\n      try {\n        await regenerateSession(req);\n      } catch (e) {\n        console.error(\"Session regeneration failed:\", e);\n      }\n\n      req.login(user, async (loginErr) => {\n        if (loginErr) {\n          console.error(`OAuth ${provider} login error:`, loginErr);\n          return res.redirect(\"/login?error=login_error\");\n        }\n\n        try {\n          const deviceInfo = extractDeviceInfo(req);\n          const { cookieValue } = await createRememberMeToken(\n            user.id,\n            deviceInfo.userAgent,\n            deviceInfo.ipAddress,\n            deviceInfo.fingerprint\n          );\n          res.cookie(REMEMBER_ME_COOKIE, cookieValue, getRememberMeCookieOptions(isSecure));\n        } catch (e) {\n          console.error(\"Failed to create remember-me token:\", e);\n        }\n\n        const returnTo = stateResult.returnTo || \"/\";\n        res.redirect(returnTo);\n      });\n    })(req, res, next);\n  };\n}\n\nexport {\n  REMEMBER_ME_COOKIE,\n  canUnlinkProvider,\n  getProviderAvailability,\n  extractDeviceInfo,\n  logAuthEvent,\n  checkRateLimit,\n  regenerateSession,\n};\n","path":null,"size_bytes":22441,"size_tokens":null},"server/errors.ts":{"content":"import { ZodError } from \"zod\";\nimport { fromError } from \"zod-validation-error\";\n\nexport enum ErrorCode {\n  VALIDATION_ERROR = \"VALIDATION_ERROR\",\n  AUTHENTICATION_REQUIRED = \"AUTHENTICATION_REQUIRED\",\n  INVALID_CREDENTIALS = \"INVALID_CREDENTIALS\",\n  TOKEN_EXPIRED = \"TOKEN_EXPIRED\",\n  TOKEN_INVALID = \"TOKEN_INVALID\",\n  ACCESS_DENIED = \"ACCESS_DENIED\",\n  RESOURCE_NOT_FOUND = \"RESOURCE_NOT_FOUND\",\n  RESOURCE_ALREADY_EXISTS = \"RESOURCE_ALREADY_EXISTS\",\n  RATE_LIMIT_EXCEEDED = \"RATE_LIMIT_EXCEEDED\",\n  DATABASE_ERROR = \"DATABASE_ERROR\",\n  DATABASE_CONNECTION_ERROR = \"DATABASE_CONNECTION_ERROR\",\n  DATABASE_CONSTRAINT_ERROR = \"DATABASE_CONSTRAINT_ERROR\",\n  EXTERNAL_SERVICE_ERROR = \"EXTERNAL_SERVICE_ERROR\",\n  OAUTH_ERROR = \"OAUTH_ERROR\",\n  OAUTH_STATE_INVALID = \"OAUTH_STATE_INVALID\",\n  OAUTH_PROVIDER_ERROR = \"OAUTH_PROVIDER_ERROR\",\n  EMAIL_SEND_ERROR = \"EMAIL_SEND_ERROR\",\n  FILE_UPLOAD_ERROR = \"FILE_UPLOAD_ERROR\",\n  FILE_TOO_LARGE = \"FILE_TOO_LARGE\",\n  INVALID_FILE_TYPE = \"INVALID_FILE_TYPE\",\n  SESSION_EXPIRED = \"SESSION_EXPIRED\",\n  SESSION_INVALID = \"SESSION_INVALID\",\n  DEVICE_MISMATCH = \"DEVICE_MISMATCH\",\n  SUSPICIOUS_ACTIVITY = \"SUSPICIOUS_ACTIVITY\",\n  ACCOUNT_LOCKED = \"ACCOUNT_LOCKED\",\n  ACCOUNT_DISABLED = \"ACCOUNT_DISABLED\",\n  EMAIL_NOT_VERIFIED = \"EMAIL_NOT_VERIFIED\",\n  PASSWORD_TOO_WEAK = \"PASSWORD_TOO_WEAK\",\n  OPERATION_NOT_ALLOWED = \"OPERATION_NOT_ALLOWED\",\n  WEBSOCKET_ERROR = \"WEBSOCKET_ERROR\",\n  AI_SERVICE_ERROR = \"AI_SERVICE_ERROR\",\n  AI_QUOTA_EXCEEDED = \"AI_QUOTA_EXCEEDED\",\n  INTERNAL_ERROR = \"INTERNAL_ERROR\",\n  SERVICE_UNAVAILABLE = \"SERVICE_UNAVAILABLE\",\n  REQUEST_TIMEOUT = \"REQUEST_TIMEOUT\",\n}\n\nexport enum ErrorCategory {\n  VALIDATION = \"VALIDATION\",\n  AUTHENTICATION = \"AUTHENTICATION\",\n  AUTHORIZATION = \"AUTHORIZATION\",\n  NOT_FOUND = \"NOT_FOUND\",\n  CONFLICT = \"CONFLICT\",\n  RATE_LIMIT = \"RATE_LIMIT\",\n  DATABASE = \"DATABASE\",\n  EXTERNAL = \"EXTERNAL\",\n  SECURITY = \"SECURITY\",\n  INTERNAL = \"INTERNAL\",\n}\n\nconst ERROR_CODE_TO_CATEGORY: Record<ErrorCode, ErrorCategory> = {\n  [ErrorCode.VALIDATION_ERROR]: ErrorCategory.VALIDATION,\n  [ErrorCode.AUTHENTICATION_REQUIRED]: ErrorCategory.AUTHENTICATION,\n  [ErrorCode.INVALID_CREDENTIALS]: ErrorCategory.AUTHENTICATION,\n  [ErrorCode.TOKEN_EXPIRED]: ErrorCategory.AUTHENTICATION,\n  [ErrorCode.TOKEN_INVALID]: ErrorCategory.AUTHENTICATION,\n  [ErrorCode.ACCESS_DENIED]: ErrorCategory.AUTHORIZATION,\n  [ErrorCode.RESOURCE_NOT_FOUND]: ErrorCategory.NOT_FOUND,\n  [ErrorCode.RESOURCE_ALREADY_EXISTS]: ErrorCategory.CONFLICT,\n  [ErrorCode.RATE_LIMIT_EXCEEDED]: ErrorCategory.RATE_LIMIT,\n  [ErrorCode.DATABASE_ERROR]: ErrorCategory.DATABASE,\n  [ErrorCode.DATABASE_CONNECTION_ERROR]: ErrorCategory.DATABASE,\n  [ErrorCode.DATABASE_CONSTRAINT_ERROR]: ErrorCategory.DATABASE,\n  [ErrorCode.EXTERNAL_SERVICE_ERROR]: ErrorCategory.EXTERNAL,\n  [ErrorCode.OAUTH_ERROR]: ErrorCategory.EXTERNAL,\n  [ErrorCode.OAUTH_STATE_INVALID]: ErrorCategory.SECURITY,\n  [ErrorCode.OAUTH_PROVIDER_ERROR]: ErrorCategory.EXTERNAL,\n  [ErrorCode.EMAIL_SEND_ERROR]: ErrorCategory.EXTERNAL,\n  [ErrorCode.FILE_UPLOAD_ERROR]: ErrorCategory.VALIDATION,\n  [ErrorCode.FILE_TOO_LARGE]: ErrorCategory.VALIDATION,\n  [ErrorCode.INVALID_FILE_TYPE]: ErrorCategory.VALIDATION,\n  [ErrorCode.SESSION_EXPIRED]: ErrorCategory.AUTHENTICATION,\n  [ErrorCode.SESSION_INVALID]: ErrorCategory.AUTHENTICATION,\n  [ErrorCode.DEVICE_MISMATCH]: ErrorCategory.SECURITY,\n  [ErrorCode.SUSPICIOUS_ACTIVITY]: ErrorCategory.SECURITY,\n  [ErrorCode.ACCOUNT_LOCKED]: ErrorCategory.SECURITY,\n  [ErrorCode.ACCOUNT_DISABLED]: ErrorCategory.AUTHORIZATION,\n  [ErrorCode.EMAIL_NOT_VERIFIED]: ErrorCategory.AUTHORIZATION,\n  [ErrorCode.PASSWORD_TOO_WEAK]: ErrorCategory.VALIDATION,\n  [ErrorCode.OPERATION_NOT_ALLOWED]: ErrorCategory.AUTHORIZATION,\n  [ErrorCode.WEBSOCKET_ERROR]: ErrorCategory.INTERNAL,\n  [ErrorCode.AI_SERVICE_ERROR]: ErrorCategory.EXTERNAL,\n  [ErrorCode.AI_QUOTA_EXCEEDED]: ErrorCategory.RATE_LIMIT,\n  [ErrorCode.INTERNAL_ERROR]: ErrorCategory.INTERNAL,\n  [ErrorCode.SERVICE_UNAVAILABLE]: ErrorCategory.INTERNAL,\n  [ErrorCode.REQUEST_TIMEOUT]: ErrorCategory.INTERNAL,\n};\n\nconst ERROR_CODE_TO_STATUS: Record<ErrorCode, number> = {\n  [ErrorCode.VALIDATION_ERROR]: 400,\n  [ErrorCode.AUTHENTICATION_REQUIRED]: 401,\n  [ErrorCode.INVALID_CREDENTIALS]: 401,\n  [ErrorCode.TOKEN_EXPIRED]: 401,\n  [ErrorCode.TOKEN_INVALID]: 401,\n  [ErrorCode.ACCESS_DENIED]: 403,\n  [ErrorCode.RESOURCE_NOT_FOUND]: 404,\n  [ErrorCode.RESOURCE_ALREADY_EXISTS]: 409,\n  [ErrorCode.RATE_LIMIT_EXCEEDED]: 429,\n  [ErrorCode.DATABASE_ERROR]: 500,\n  [ErrorCode.DATABASE_CONNECTION_ERROR]: 503,\n  [ErrorCode.DATABASE_CONSTRAINT_ERROR]: 409,\n  [ErrorCode.EXTERNAL_SERVICE_ERROR]: 502,\n  [ErrorCode.OAUTH_ERROR]: 502,\n  [ErrorCode.OAUTH_STATE_INVALID]: 400,\n  [ErrorCode.OAUTH_PROVIDER_ERROR]: 502,\n  [ErrorCode.EMAIL_SEND_ERROR]: 502,\n  [ErrorCode.FILE_UPLOAD_ERROR]: 400,\n  [ErrorCode.FILE_TOO_LARGE]: 413,\n  [ErrorCode.INVALID_FILE_TYPE]: 415,\n  [ErrorCode.SESSION_EXPIRED]: 401,\n  [ErrorCode.SESSION_INVALID]: 401,\n  [ErrorCode.DEVICE_MISMATCH]: 401,\n  [ErrorCode.SUSPICIOUS_ACTIVITY]: 403,\n  [ErrorCode.ACCOUNT_LOCKED]: 423,\n  [ErrorCode.ACCOUNT_DISABLED]: 403,\n  [ErrorCode.EMAIL_NOT_VERIFIED]: 403,\n  [ErrorCode.PASSWORD_TOO_WEAK]: 400,\n  [ErrorCode.OPERATION_NOT_ALLOWED]: 403,\n  [ErrorCode.WEBSOCKET_ERROR]: 500,\n  [ErrorCode.AI_SERVICE_ERROR]: 502,\n  [ErrorCode.AI_QUOTA_EXCEEDED]: 429,\n  [ErrorCode.INTERNAL_ERROR]: 500,\n  [ErrorCode.SERVICE_UNAVAILABLE]: 503,\n  [ErrorCode.REQUEST_TIMEOUT]: 504,\n};\n\nexport interface ErrorDetails {\n  field?: string;\n  value?: unknown;\n  constraint?: string;\n  expected?: string;\n  received?: string;\n}\n\nexport interface SerializedError {\n  success: false;\n  error: {\n    code: ErrorCode;\n    message: string;\n    category: ErrorCategory;\n    details?: ErrorDetails[];\n    timestamp: string;\n    requestId?: string;\n    retryable: boolean;\n    retryAfter?: number;\n  };\n}\n\nexport class AppError extends Error {\n  public readonly code: ErrorCode;\n  public readonly category: ErrorCategory;\n  public readonly statusCode: number;\n  public readonly isOperational: boolean;\n  public readonly details?: ErrorDetails[];\n  public readonly retryable: boolean;\n  public readonly retryAfter?: number;\n  public readonly originalError?: Error;\n  public readonly context?: Record<string, unknown>;\n\n  constructor(\n    code: ErrorCode,\n    message: string,\n    options: {\n      details?: ErrorDetails[];\n      retryable?: boolean;\n      retryAfter?: number;\n      originalError?: Error;\n      context?: Record<string, unknown>;\n      statusCode?: number;\n    } = {}\n  ) {\n    super(message);\n    this.name = \"AppError\";\n    this.code = code;\n    this.category = ERROR_CODE_TO_CATEGORY[code];\n    this.statusCode = options.statusCode || ERROR_CODE_TO_STATUS[code];\n    this.isOperational = true;\n    this.details = options.details;\n    this.retryable = options.retryable ?? this.determineRetryable(code);\n    this.retryAfter = options.retryAfter;\n    this.originalError = options.originalError;\n    this.context = options.context;\n\n    Error.captureStackTrace(this, this.constructor);\n  }\n\n  private determineRetryable(code: ErrorCode): boolean {\n    const retryableCodes = [\n      ErrorCode.DATABASE_CONNECTION_ERROR,\n      ErrorCode.EXTERNAL_SERVICE_ERROR,\n      ErrorCode.SERVICE_UNAVAILABLE,\n      ErrorCode.REQUEST_TIMEOUT,\n      ErrorCode.RATE_LIMIT_EXCEEDED,\n    ];\n    return retryableCodes.includes(code);\n  }\n\n  serialize(requestId?: string): SerializedError {\n    return {\n      success: false,\n      error: {\n        code: this.code,\n        message: this.message,\n        category: this.category,\n        details: this.details,\n        timestamp: new Date().toISOString(),\n        requestId,\n        retryable: this.retryable,\n        retryAfter: this.retryAfter,\n      },\n    };\n  }\n\n  static fromZodError(error: ZodError, message?: string): AppError {\n    const validationError = fromError(error);\n    const details: ErrorDetails[] = error.errors.map((err) => ({\n      field: err.path.join(\".\"),\n      constraint: err.code,\n      expected: \"expected\" in err ? String(err.expected) : undefined,\n      received: \"received\" in err ? String(err.received) : undefined,\n    }));\n\n    return new AppError(\n      ErrorCode.VALIDATION_ERROR,\n      message || validationError.toString(),\n      { details, originalError: error }\n    );\n  }\n\n  static fromDatabaseError(error: Error): AppError {\n    const message = error.message.toLowerCase();\n    \n    if (message.includes(\"connection\") || message.includes(\"timeout\")) {\n      return new AppError(\n        ErrorCode.DATABASE_CONNECTION_ERROR,\n        \"Database connection failed. Please try again.\",\n        { originalError: error, retryable: true }\n      );\n    }\n    \n    if (message.includes(\"unique\") || message.includes(\"duplicate\")) {\n      return new AppError(\n        ErrorCode.DATABASE_CONSTRAINT_ERROR,\n        \"A record with this value already exists.\",\n        { originalError: error }\n      );\n    }\n    \n    if (message.includes(\"foreign key\") || message.includes(\"constraint\")) {\n      return new AppError(\n        ErrorCode.DATABASE_CONSTRAINT_ERROR,\n        \"This operation violates data integrity constraints.\",\n        { originalError: error }\n      );\n    }\n    \n    return new AppError(\n      ErrorCode.DATABASE_ERROR,\n      \"A database error occurred. Please try again.\",\n      { originalError: error }\n    );\n  }\n\n  static validation(message: string, details?: ErrorDetails[]): AppError {\n    return new AppError(ErrorCode.VALIDATION_ERROR, message, { details });\n  }\n\n  static unauthorized(message = \"Authentication required\"): AppError {\n    return new AppError(ErrorCode.AUTHENTICATION_REQUIRED, message);\n  }\n\n  static forbidden(message = \"Access denied\"): AppError {\n    return new AppError(ErrorCode.ACCESS_DENIED, message);\n  }\n\n  static notFound(resource = \"Resource\"): AppError {\n    return new AppError(ErrorCode.RESOURCE_NOT_FOUND, `${resource} not found`);\n  }\n\n  static conflict(message: string): AppError {\n    return new AppError(ErrorCode.RESOURCE_ALREADY_EXISTS, message);\n  }\n\n  static rateLimited(retryAfter?: number): AppError {\n    return new AppError(\n      ErrorCode.RATE_LIMIT_EXCEEDED,\n      \"Too many requests. Please slow down.\",\n      { retryAfter, retryable: true }\n    );\n  }\n\n  static internal(message = \"An unexpected error occurred\"): AppError {\n    return new AppError(ErrorCode.INTERNAL_ERROR, message);\n  }\n\n  static serviceUnavailable(service = \"Service\"): AppError {\n    return new AppError(\n      ErrorCode.SERVICE_UNAVAILABLE,\n      `${service} is temporarily unavailable`,\n      { retryable: true }\n    );\n  }\n}\n\nexport class ValidationError extends AppError {\n  constructor(message: string, details?: ErrorDetails[]) {\n    super(ErrorCode.VALIDATION_ERROR, message, { details });\n    this.name = \"ValidationError\";\n  }\n}\n\nexport class AuthenticationError extends AppError {\n  constructor(\n    code: ErrorCode.AUTHENTICATION_REQUIRED | ErrorCode.INVALID_CREDENTIALS | ErrorCode.TOKEN_EXPIRED | ErrorCode.TOKEN_INVALID | ErrorCode.SESSION_EXPIRED | ErrorCode.SESSION_INVALID = ErrorCode.AUTHENTICATION_REQUIRED,\n    message = \"Authentication required\"\n  ) {\n    super(code, message);\n    this.name = \"AuthenticationError\";\n  }\n}\n\nexport class AuthorizationError extends AppError {\n  constructor(message = \"Access denied\") {\n    super(ErrorCode.ACCESS_DENIED, message);\n    this.name = \"AuthorizationError\";\n  }\n}\n\nexport class NotFoundError extends AppError {\n  constructor(resource = \"Resource\") {\n    super(ErrorCode.RESOURCE_NOT_FOUND, `${resource} not found`);\n    this.name = \"NotFoundError\";\n  }\n}\n\nexport class ConflictError extends AppError {\n  constructor(message: string) {\n    super(ErrorCode.RESOURCE_ALREADY_EXISTS, message);\n    this.name = \"ConflictError\";\n  }\n}\n\nexport class RateLimitError extends AppError {\n  constructor(retryAfter?: number) {\n    super(ErrorCode.RATE_LIMIT_EXCEEDED, \"Too many requests. Please slow down.\", {\n      retryAfter,\n      retryable: true,\n    });\n    this.name = \"RateLimitError\";\n  }\n}\n\nexport class DatabaseError extends AppError {\n  constructor(message: string, originalError?: Error) {\n    super(ErrorCode.DATABASE_ERROR, message, { originalError });\n    this.name = \"DatabaseError\";\n  }\n}\n\nexport class ExternalServiceError extends AppError {\n  constructor(service: string, originalError?: Error) {\n    super(ErrorCode.EXTERNAL_SERVICE_ERROR, `${service} service error`, {\n      originalError,\n      retryable: true,\n    });\n    this.name = \"ExternalServiceError\";\n  }\n}\n\nexport class OAuthError extends AppError {\n  constructor(\n    code: ErrorCode.OAUTH_ERROR | ErrorCode.OAUTH_STATE_INVALID | ErrorCode.OAUTH_PROVIDER_ERROR = ErrorCode.OAUTH_ERROR,\n    message: string,\n    originalError?: Error\n  ) {\n    super(code, message, { originalError });\n    this.name = \"OAuthError\";\n  }\n}\n\nexport class SecurityError extends AppError {\n  constructor(\n    code: ErrorCode.DEVICE_MISMATCH | ErrorCode.SUSPICIOUS_ACTIVITY | ErrorCode.ACCOUNT_LOCKED = ErrorCode.SUSPICIOUS_ACTIVITY,\n    message: string\n  ) {\n    super(code, message);\n    this.name = \"SecurityError\";\n  }\n}\n\nexport function isAppError(error: unknown): error is AppError {\n  return error instanceof AppError;\n}\n\nexport function isOperationalError(error: unknown): boolean {\n  if (isAppError(error)) {\n    return error.isOperational;\n  }\n  return false;\n}\n\nexport function wrapError(error: unknown, fallbackMessage?: string): AppError {\n  if (isAppError(error)) {\n    return error;\n  }\n\n  if (error instanceof ZodError) {\n    return AppError.fromZodError(error);\n  }\n\n  if (error instanceof Error) {\n    const message = error.message.toLowerCase();\n    \n    if (message.includes(\"econnrefused\") || message.includes(\"etimedout\")) {\n      return new AppError(ErrorCode.SERVICE_UNAVAILABLE, \"Service temporarily unavailable\", {\n        originalError: error,\n        retryable: true,\n      });\n    }\n\n    if (message.includes(\"database\") || message.includes(\"postgres\") || message.includes(\"sql\")) {\n      return AppError.fromDatabaseError(error);\n    }\n\n    return new AppError(\n      ErrorCode.INTERNAL_ERROR,\n      fallbackMessage || \"An unexpected error occurred\",\n      { originalError: error }\n    );\n  }\n\n  return AppError.internal(fallbackMessage);\n}\n","path":null,"size_bytes":14289,"size_tokens":null},"server/error-middleware.ts":{"content":"import { Request, Response, NextFunction, ErrorRequestHandler } from \"express\";\nimport { ZodError } from \"zod\";\nimport { AppError, ErrorCode, wrapError, isOperationalError, SerializedError } from \"./errors\";\nimport { log } from \"./app\";\nimport crypto from \"node:crypto\";\n\ninterface ErrorLogEntry {\n  requestId: string;\n  timestamp: string;\n  method: string;\n  path: string;\n  statusCode: number;\n  errorCode: ErrorCode;\n  message: string;\n  stack?: string;\n  userId?: string;\n  ip?: string;\n  userAgent?: string;\n  duration?: number;\n  context?: Record<string, unknown>;\n}\n\nconst errorLog: ErrorLogEntry[] = [];\nconst MAX_ERROR_LOG_SIZE = 1000;\n\nfunction generateRequestId(): string {\n  return crypto.randomBytes(8).toString(\"hex\");\n}\n\nfunction sanitizeErrorMessage(message: string, isProduction: boolean): string {\n  if (!isProduction) {\n    return message;\n  }\n\n  const sensitivePatterns = [\n    /password/gi,\n    /secret/gi,\n    /token/gi,\n    /api[_-]?key/gi,\n    /authorization/gi,\n    /credential/gi,\n    /\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Z|a-z]{2,}\\b/g,\n    /\\b\\d{4}[-\\s]?\\d{4}[-\\s]?\\d{4}[-\\s]?\\d{4}\\b/g,\n  ];\n\n  let sanitized = message;\n  for (const pattern of sensitivePatterns) {\n    sanitized = sanitized.replace(pattern, \"[REDACTED]\");\n  }\n  return sanitized;\n}\n\nfunction getClientIp(req: Request): string {\n  const forwarded = req.headers[\"x-forwarded-for\"];\n  if (typeof forwarded === \"string\") {\n    return forwarded.split(\",\")[0].trim();\n  }\n  return req.socket.remoteAddress || \"unknown\";\n}\n\nfunction logError(entry: ErrorLogEntry): void {\n  errorLog.push(entry);\n  if (errorLog.length > MAX_ERROR_LOG_SIZE) {\n    errorLog.shift();\n  }\n\n  const logLevel = entry.statusCode >= 500 ? \"ERROR\" : \"WARN\";\n  const logMessage = `[${logLevel}] ${entry.method} ${entry.path} - ${entry.errorCode}: ${entry.message} (${entry.requestId})`;\n  \n  if (entry.statusCode >= 500) {\n    console.error(logMessage, entry.stack ? `\\n${entry.stack}` : \"\");\n  } else {\n    log(logMessage, \"error\");\n  }\n}\n\nexport function requestIdMiddleware(req: Request, res: Response, next: NextFunction): void {\n  const requestId = (req.headers[\"x-request-id\"] as string) || generateRequestId();\n  (req as any).requestId = requestId;\n  res.setHeader(\"X-Request-ID\", requestId);\n  next();\n}\n\nexport function asyncHandler<T>(\n  fn: (req: Request, res: Response, next: NextFunction) => Promise<T>\n): (req: Request, res: Response, next: NextFunction) => void {\n  return (req, res, next) => {\n    Promise.resolve(fn(req, res, next)).catch(next);\n  };\n}\n\nexport const errorHandler: ErrorRequestHandler = (\n  err: Error,\n  req: Request,\n  res: Response,\n  _next: NextFunction\n): void => {\n  const startTime = (req as any).startTime || Date.now();\n  const requestId = (req as any).requestId || generateRequestId();\n  const isProduction = process.env.NODE_ENV === \"production\";\n\n  let appError: AppError;\n\n  if (err instanceof ZodError) {\n    appError = AppError.fromZodError(err);\n  } else if (err instanceof AppError) {\n    appError = err;\n  } else {\n    appError = wrapError(err);\n  }\n\n  const userId = (req.user as any)?.id;\n  const ip = getClientIp(req);\n  const userAgent = req.headers[\"user-agent\"] || \"unknown\";\n\n  const logEntry: ErrorLogEntry = {\n    requestId,\n    timestamp: new Date().toISOString(),\n    method: req.method,\n    path: req.path,\n    statusCode: appError.statusCode,\n    errorCode: appError.code,\n    message: appError.message,\n    stack: isProduction ? undefined : appError.stack,\n    userId,\n    ip,\n    userAgent,\n    duration: Date.now() - startTime,\n    context: appError.context,\n  };\n\n  logError(logEntry);\n\n  if (!isOperationalError(err) && !isProduction) {\n    console.error(\"Non-operational error:\", err);\n  }\n\n  const serialized = appError.serialize(requestId);\n  \n  if (isProduction) {\n    serialized.error.message = sanitizeErrorMessage(serialized.error.message, true);\n    \n    if (appError.statusCode >= 500) {\n      serialized.error.message = \"An unexpected error occurred. Please try again later.\";\n    }\n  }\n\n  if (appError.retryAfter) {\n    res.setHeader(\"Retry-After\", appError.retryAfter);\n  }\n\n  res.status(appError.statusCode).json(serialized);\n};\n\nexport function notFoundHandler(req: Request, res: Response, next: NextFunction): void {\n  const error = AppError.notFound(`Route ${req.method} ${req.path}`);\n  next(error);\n}\n\nexport function getErrorLog(): ErrorLogEntry[] {\n  return [...errorLog];\n}\n\nexport function clearErrorLog(): void {\n  errorLog.length = 0;\n}\n\nexport function getErrorStats(): {\n  total: number;\n  byCode: Record<string, number>;\n  byCategory: Record<string, number>;\n  byStatus: Record<number, number>;\n  last24Hours: number;\n} {\n  const now = Date.now();\n  const oneDayAgo = now - 24 * 60 * 60 * 1000;\n\n  const stats = {\n    total: errorLog.length,\n    byCode: {} as Record<string, number>,\n    byCategory: {} as Record<string, number>,\n    byStatus: {} as Record<number, number>,\n    last24Hours: 0,\n  };\n\n  for (const entry of errorLog) {\n    stats.byCode[entry.errorCode] = (stats.byCode[entry.errorCode] || 0) + 1;\n    stats.byStatus[entry.statusCode] = (stats.byStatus[entry.statusCode] || 0) + 1;\n    \n    if (new Date(entry.timestamp).getTime() > oneDayAgo) {\n      stats.last24Hours++;\n    }\n  }\n\n  return stats;\n}\n\nexport function createErrorResponse(\n  code: ErrorCode,\n  message: string,\n  requestId?: string\n): SerializedError {\n  return {\n    success: false,\n    error: {\n      code,\n      message,\n      category: AppError.prototype[\"category\"] || \"INTERNAL\" as any,\n      timestamp: new Date().toISOString(),\n      requestId,\n      retryable: false,\n    },\n  };\n}\n\nexport function withErrorHandling<T extends (...args: any[]) => Promise<any>>(\n  fn: T,\n  errorTransformer?: (error: unknown) => AppError\n): T {\n  return (async (...args: Parameters<T>): Promise<ReturnType<T>> => {\n    try {\n      return await fn(...args);\n    } catch (error) {\n      if (errorTransformer) {\n        throw errorTransformer(error);\n      }\n      throw wrapError(error);\n    }\n  }) as T;\n}\n\nexport function createValidationError(\n  message: string,\n  fields: Array<{ field: string; message: string }>\n): AppError {\n  return AppError.validation(message, fields.map(f => ({\n    field: f.field,\n    constraint: f.message,\n  })));\n}\n","path":null,"size_bytes":6277,"size_tokens":null},"client/src/lib/error-context.tsx":{"content":"import React, { createContext, useContext, useState, useCallback, useEffect, ReactNode } from \"react\";\nimport { ApiError, ErrorCode, showErrorToast, isAuthError } from \"./error-utils\";\nimport { useLocation } from \"wouter\";\n\ninterface GlobalError {\n  id: string;\n  error: ApiError;\n  timestamp: Date;\n  dismissed: boolean;\n}\n\ninterface ErrorContextValue {\n  errors: GlobalError[];\n  lastError: ApiError | null;\n  hasErrors: boolean;\n  addError: (error: ApiError) => void;\n  clearError: (id: string) => void;\n  clearAllErrors: () => void;\n  dismissError: (id: string) => void;\n  getErrorById: (id: string) => GlobalError | undefined;\n  handleGlobalError: (error: unknown) => void;\n}\n\nconst ErrorContext = createContext<ErrorContextValue | null>(null);\n\nconst MAX_ERRORS = 50;\n\nfunction generateErrorId(): string {\n  return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n}\n\ninterface ErrorProviderProps {\n  children: ReactNode;\n  onAuthError?: () => void;\n  maxErrors?: number;\n}\n\nexport function ErrorProvider({\n  children,\n  onAuthError,\n  maxErrors = MAX_ERRORS,\n}: ErrorProviderProps) {\n  const [errors, setErrors] = useState<GlobalError[]>([]);\n  const [, setLocation] = useLocation();\n\n  const addError = useCallback((error: ApiError) => {\n    const globalError: GlobalError = {\n      id: generateErrorId(),\n      error,\n      timestamp: new Date(),\n      dismissed: false,\n    };\n\n    setErrors((prev) => {\n      const newErrors = [globalError, ...prev];\n      if (newErrors.length > maxErrors) {\n        return newErrors.slice(0, maxErrors);\n      }\n      return newErrors;\n    });\n\n    if (isAuthError(error)) {\n      if (onAuthError) {\n        onAuthError();\n      } else {\n        setLocation(\"/login\");\n      }\n    }\n\n    showErrorToast(error);\n  }, [maxErrors, onAuthError, setLocation]);\n\n  const clearError = useCallback((id: string) => {\n    setErrors((prev) => prev.filter((e) => e.id !== id));\n  }, []);\n\n  const clearAllErrors = useCallback(() => {\n    setErrors([]);\n  }, []);\n\n  const dismissError = useCallback((id: string) => {\n    setErrors((prev) =>\n      prev.map((e) => (e.id === id ? { ...e, dismissed: true } : e))\n    );\n  }, []);\n\n  const getErrorById = useCallback(\n    (id: string) => errors.find((e) => e.id === id),\n    [errors]\n  );\n\n  const handleGlobalError = useCallback(\n    (error: unknown) => {\n      let apiError: ApiError;\n\n      if (error instanceof Error) {\n        const isNetworkError =\n          error.name === \"NetworkError\" ||\n          error.message.toLowerCase().includes(\"network\") ||\n          error.message.toLowerCase().includes(\"fetch\");\n\n        apiError = {\n          code: isNetworkError ? ErrorCode.NETWORK_ERROR : ErrorCode.INTERNAL_ERROR,\n          message: error.message,\n          category: \"INTERNAL\",\n          timestamp: new Date().toISOString(),\n          retryable: isNetworkError,\n        };\n      } else if (typeof error === \"object\" && error !== null && \"code\" in error) {\n        apiError = error as ApiError;\n      } else {\n        apiError = {\n          code: ErrorCode.INTERNAL_ERROR,\n          message: String(error),\n          category: \"INTERNAL\",\n          timestamp: new Date().toISOString(),\n          retryable: false,\n        };\n      }\n\n      addError(apiError);\n    },\n    [addError]\n  );\n\n  useEffect(() => {\n    const handleUnhandledRejection = (event: PromiseRejectionEvent) => {\n      console.error(\"Unhandled promise rejection:\", event.reason);\n      handleGlobalError(event.reason);\n    };\n\n    window.addEventListener(\"unhandledrejection\", handleUnhandledRejection);\n    return () => {\n      window.removeEventListener(\"unhandledrejection\", handleUnhandledRejection);\n    };\n  }, [handleGlobalError]);\n\n  const lastError = errors.length > 0 ? errors[0].error : null;\n  const hasErrors = errors.filter((e) => !e.dismissed).length > 0;\n\n  const value: ErrorContextValue = {\n    errors,\n    lastError,\n    hasErrors,\n    addError,\n    clearError,\n    clearAllErrors,\n    dismissError,\n    getErrorById,\n    handleGlobalError,\n  };\n\n  return (\n    <ErrorContext.Provider value={value}>{children}</ErrorContext.Provider>\n  );\n}\n\nexport function useGlobalError(): ErrorContextValue {\n  const context = useContext(ErrorContext);\n  if (!context) {\n    throw new Error(\"useGlobalError must be used within an ErrorProvider\");\n  }\n  return context;\n}\n\nexport function useErrorReporting() {\n  const { addError, clearAllErrors, errors } = useGlobalError();\n\n  const reportError = useCallback(\n    async (error: ApiError, additionalContext?: Record<string, unknown>) => {\n      addError(error);\n\n      if (process.env.NODE_ENV === \"production\") {\n        try {\n          await fetch(\"/api/error-report\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            body: JSON.stringify({\n              error,\n              context: additionalContext,\n              timestamp: new Date().toISOString(),\n              url: window.location.href,\n              userAgent: navigator.userAgent,\n            }),\n          });\n        } catch {\n        }\n      }\n    },\n    [addError]\n  );\n\n  const getErrorSummary = useCallback(() => {\n    const summary: Record<string, number> = {};\n    for (const { error } of errors) {\n      summary[error.code] = (summary[error.code] || 0) + 1;\n    }\n    return summary;\n  }, [errors]);\n\n  return {\n    reportError,\n    clearAllErrors,\n    getErrorSummary,\n    errorCount: errors.length,\n  };\n}\n\nexport function ErrorDisplay() {\n  const { errors, dismissError } = useGlobalError();\n  const activeErrors = errors.filter((e) => !e.dismissed);\n\n  if (activeErrors.length === 0) {\n    return null;\n  }\n\n  return (\n    <div className=\"fixed bottom-4 right-4 z-50 space-y-2 max-w-sm\">\n      {activeErrors.slice(0, 3).map((globalError) => (\n        <div\n          key={globalError.id}\n          className=\"bg-destructive/10 border border-destructive/20 rounded-lg p-3 shadow-lg\"\n        >\n          <div className=\"flex items-start justify-between gap-2\">\n            <div>\n              <p className=\"text-sm font-medium text-destructive\">\n                {globalError.error.message}\n              </p>\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                {globalError.timestamp.toLocaleTimeString()}\n              </p>\n            </div>\n            <button\n              onClick={() => dismissError(globalError.id)}\n              className=\"text-muted-foreground hover:text-foreground\"\n              data-testid={`button-dismiss-error-${globalError.id}`}\n            >\n              Ã—\n            </button>\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n}\n","path":null,"size_bytes":6655,"size_tokens":null},"client/src/lib/error-utils.ts":{"content":"import { toast } from \"sonner\";\n\nexport enum ErrorCode {\n  VALIDATION_ERROR = \"VALIDATION_ERROR\",\n  AUTHENTICATION_REQUIRED = \"AUTHENTICATION_REQUIRED\",\n  INVALID_CREDENTIALS = \"INVALID_CREDENTIALS\",\n  TOKEN_EXPIRED = \"TOKEN_EXPIRED\",\n  TOKEN_INVALID = \"TOKEN_INVALID\",\n  ACCESS_DENIED = \"ACCESS_DENIED\",\n  RESOURCE_NOT_FOUND = \"RESOURCE_NOT_FOUND\",\n  RESOURCE_ALREADY_EXISTS = \"RESOURCE_ALREADY_EXISTS\",\n  RATE_LIMIT_EXCEEDED = \"RATE_LIMIT_EXCEEDED\",\n  DATABASE_ERROR = \"DATABASE_ERROR\",\n  DATABASE_CONNECTION_ERROR = \"DATABASE_CONNECTION_ERROR\",\n  EXTERNAL_SERVICE_ERROR = \"EXTERNAL_SERVICE_ERROR\",\n  OAUTH_ERROR = \"OAUTH_ERROR\",\n  SESSION_EXPIRED = \"SESSION_EXPIRED\",\n  DEVICE_MISMATCH = \"DEVICE_MISMATCH\",\n  ACCOUNT_LOCKED = \"ACCOUNT_LOCKED\",\n  ACCOUNT_DISABLED = \"ACCOUNT_DISABLED\",\n  EMAIL_NOT_VERIFIED = \"EMAIL_NOT_VERIFIED\",\n  AI_SERVICE_ERROR = \"AI_SERVICE_ERROR\",\n  AI_QUOTA_EXCEEDED = \"AI_QUOTA_EXCEEDED\",\n  INTERNAL_ERROR = \"INTERNAL_ERROR\",\n  SERVICE_UNAVAILABLE = \"SERVICE_UNAVAILABLE\",\n  NETWORK_ERROR = \"NETWORK_ERROR\",\n}\n\nexport interface ErrorDetail {\n  field?: string;\n  constraint?: string;\n  expected?: string;\n  received?: string;\n}\n\nexport interface ApiError {\n  code: ErrorCode;\n  message: string;\n  category: string;\n  details?: ErrorDetail[];\n  timestamp: string;\n  requestId?: string;\n  retryable: boolean;\n  retryAfter?: number;\n}\n\nexport interface ApiErrorResponse {\n  success: false;\n  error: ApiError;\n}\n\nconst USER_FRIENDLY_MESSAGES: Partial<Record<ErrorCode, string>> = {\n  [ErrorCode.VALIDATION_ERROR]: \"Please check your input and try again.\",\n  [ErrorCode.AUTHENTICATION_REQUIRED]: \"Please sign in to continue.\",\n  [ErrorCode.INVALID_CREDENTIALS]: \"Incorrect email or password.\",\n  [ErrorCode.TOKEN_EXPIRED]: \"Your session has expired. Please sign in again.\",\n  [ErrorCode.ACCESS_DENIED]: \"You don't have permission to do this.\",\n  [ErrorCode.RESOURCE_NOT_FOUND]: \"The requested item was not found.\",\n  [ErrorCode.RESOURCE_ALREADY_EXISTS]: \"This item already exists.\",\n  [ErrorCode.RATE_LIMIT_EXCEEDED]: \"Too many requests. Please wait a moment.\",\n  [ErrorCode.DATABASE_CONNECTION_ERROR]: \"Connection issue. Please try again.\",\n  [ErrorCode.EXTERNAL_SERVICE_ERROR]: \"A service is temporarily unavailable.\",\n  [ErrorCode.SESSION_EXPIRED]: \"Your session has expired. Please sign in again.\",\n  [ErrorCode.DEVICE_MISMATCH]: \"Sign-in detected from a different device.\",\n  [ErrorCode.ACCOUNT_LOCKED]: \"Your account has been temporarily locked.\",\n  [ErrorCode.ACCOUNT_DISABLED]: \"Your account is disabled.\",\n  [ErrorCode.EMAIL_NOT_VERIFIED]: \"Please verify your email to continue.\",\n  [ErrorCode.AI_SERVICE_ERROR]: \"AI service is temporarily unavailable.\",\n  [ErrorCode.AI_QUOTA_EXCEEDED]: \"AI usage limit reached. Please try again later.\",\n  [ErrorCode.INTERNAL_ERROR]: \"Something went wrong. Please try again.\",\n  [ErrorCode.SERVICE_UNAVAILABLE]: \"Service temporarily unavailable.\",\n  [ErrorCode.NETWORK_ERROR]: \"Network connection lost. Please check your connection.\",\n};\n\nexport function isApiErrorResponse(data: unknown): data is ApiErrorResponse {\n  return (\n    typeof data === \"object\" &&\n    data !== null &&\n    \"success\" in data &&\n    (data as any).success === false &&\n    \"error\" in data &&\n    typeof (data as any).error === \"object\" &&\n    \"code\" in (data as any).error\n  );\n}\n\nexport function parseApiError(response: Response, body: unknown): ApiError {\n  if (isApiErrorResponse(body)) {\n    return body.error;\n  }\n\n  let message = \"An unexpected error occurred\";\n  if (typeof body === \"object\" && body !== null) {\n    if (\"message\" in body && typeof (body as any).message === \"string\") {\n      message = (body as any).message;\n    } else if (\"error\" in body && typeof (body as any).error === \"string\") {\n      message = (body as any).error;\n    }\n  } else if (typeof body === \"string\") {\n    message = body;\n  }\n\n  const codeMap: Record<number, ErrorCode> = {\n    400: ErrorCode.VALIDATION_ERROR,\n    401: ErrorCode.AUTHENTICATION_REQUIRED,\n    403: ErrorCode.ACCESS_DENIED,\n    404: ErrorCode.RESOURCE_NOT_FOUND,\n    409: ErrorCode.RESOURCE_ALREADY_EXISTS,\n    429: ErrorCode.RATE_LIMIT_EXCEEDED,\n    500: ErrorCode.INTERNAL_ERROR,\n    502: ErrorCode.EXTERNAL_SERVICE_ERROR,\n    503: ErrorCode.SERVICE_UNAVAILABLE,\n  };\n\n  return {\n    code: codeMap[response.status] || ErrorCode.INTERNAL_ERROR,\n    message,\n    category: \"UNKNOWN\",\n    timestamp: new Date().toISOString(),\n    retryable: response.status >= 500 || response.status === 429,\n    retryAfter: parseInt(response.headers.get(\"Retry-After\") || \"0\") || undefined,\n  };\n}\n\nexport function getUserFriendlyMessage(error: ApiError): string {\n  return USER_FRIENDLY_MESSAGES[error.code] || error.message;\n}\n\nexport function getFieldErrors(error: ApiError): Record<string, string> {\n  const fieldErrors: Record<string, string> = {};\n  \n  if (error.details) {\n    for (const detail of error.details) {\n      if (detail.field) {\n        fieldErrors[detail.field] = detail.constraint || \"Invalid value\";\n      }\n    }\n  }\n  \n  return fieldErrors;\n}\n\nexport type ToastType = \"error\" | \"warning\" | \"info\";\n\nfunction getToastType(error: ApiError): ToastType {\n  if (error.code === ErrorCode.RATE_LIMIT_EXCEEDED) {\n    return \"warning\";\n  }\n  if (error.code === ErrorCode.SERVICE_UNAVAILABLE || error.retryable) {\n    return \"warning\";\n  }\n  return \"error\";\n}\n\nexport function showErrorToast(\n  error: ApiError | string,\n  options: {\n    title?: string;\n    duration?: number;\n    action?: {\n      label: string;\n      onClick: () => void;\n    };\n  } = {}\n): void {\n  const apiError = typeof error === \"string\" \n    ? { code: ErrorCode.INTERNAL_ERROR, message: error, category: \"UNKNOWN\", timestamp: new Date().toISOString(), retryable: false }\n    : error;\n\n  const message = getUserFriendlyMessage(apiError);\n  const type = getToastType(apiError);\n  const duration = options.duration ?? (apiError.retryable ? 8000 : 5000);\n\n  const toastOptions: any = {\n    duration,\n    description: options.title ? message : undefined,\n  };\n\n  if (options.action) {\n    toastOptions.action = {\n      label: options.action.label,\n      onClick: options.action.onClick,\n    };\n  }\n\n  const displayMessage = options.title || message;\n\n  switch (type) {\n    case \"warning\":\n      toast.warning(displayMessage, toastOptions);\n      break;\n    case \"info\":\n      toast.info(displayMessage, toastOptions);\n      break;\n    default:\n      toast.error(displayMessage, toastOptions);\n  }\n}\n\nexport function isRetryableError(error: ApiError): boolean {\n  if (error.retryable) return true;\n\n  const retryableCodes = [\n    ErrorCode.DATABASE_CONNECTION_ERROR,\n    ErrorCode.EXTERNAL_SERVICE_ERROR,\n    ErrorCode.SERVICE_UNAVAILABLE,\n    ErrorCode.NETWORK_ERROR,\n    ErrorCode.AI_SERVICE_ERROR,\n  ];\n\n  return retryableCodes.includes(error.code);\n}\n\nexport function isAuthError(error: ApiError): boolean {\n  const authCodes = [\n    ErrorCode.AUTHENTICATION_REQUIRED,\n    ErrorCode.TOKEN_EXPIRED,\n    ErrorCode.TOKEN_INVALID,\n    ErrorCode.SESSION_EXPIRED,\n    ErrorCode.DEVICE_MISMATCH,\n  ];\n  return authCodes.includes(error.code);\n}\n\nexport function isValidationError(error: ApiError): boolean {\n  return error.code === ErrorCode.VALIDATION_ERROR;\n}\n\nexport function formatRetryAfter(seconds: number): string {\n  if (seconds < 60) {\n    return `${seconds} second${seconds !== 1 ? \"s\" : \"\"}`;\n  }\n  const minutes = Math.ceil(seconds / 60);\n  return `${minutes} minute${minutes !== 1 ? \"s\" : \"\"}`;\n}\n\nexport class ApiRequestError extends Error {\n  public readonly apiError: ApiError;\n  public readonly status: number;\n\n  constructor(status: number, apiError: ApiError) {\n    super(apiError.message);\n    this.name = \"ApiRequestError\";\n    this.status = status;\n    this.apiError = apiError;\n  }\n\n  get code(): ErrorCode {\n    return this.apiError.code;\n  }\n\n  get isRetryable(): boolean {\n    return isRetryableError(this.apiError);\n  }\n\n  get isAuthError(): boolean {\n    return isAuthError(this.apiError);\n  }\n\n  get retryAfter(): number | undefined {\n    return this.apiError.retryAfter;\n  }\n\n  getUserFriendlyMessage(): string {\n    return getUserFriendlyMessage(this.apiError);\n  }\n\n  getFieldErrors(): Record<string, string> {\n    return getFieldErrors(this.apiError);\n  }\n\n  showToast(options?: Parameters<typeof showErrorToast>[1]): void {\n    showErrorToast(this.apiError, options);\n  }\n}\n\ninterface RetryOptions {\n  maxRetries?: number;\n  baseDelay?: number;\n  maxDelay?: number;\n  shouldRetry?: (error: ApiRequestError, attempt: number) => boolean;\n  onRetry?: (error: ApiRequestError, attempt: number, delay: number) => void;\n}\n\nexport async function withRetry<T>(\n  fn: () => Promise<T>,\n  options: RetryOptions = {}\n): Promise<T> {\n  const {\n    maxRetries = 3,\n    baseDelay = 1000,\n    maxDelay = 30000,\n    shouldRetry = (error) => error.isRetryable,\n    onRetry,\n  } = options;\n\n  let lastError: ApiRequestError | null = null;\n\n  for (let attempt = 0; attempt <= maxRetries; attempt++) {\n    try {\n      return await fn();\n    } catch (error) {\n      if (!(error instanceof ApiRequestError)) {\n        throw error;\n      }\n\n      lastError = error;\n\n      if (attempt >= maxRetries || !shouldRetry(error, attempt)) {\n        throw error;\n      }\n\n      let delay = error.retryAfter\n        ? error.retryAfter * 1000\n        : Math.min(baseDelay * Math.pow(2, attempt), maxDelay);\n\n      delay += Math.random() * 1000;\n\n      onRetry?.(error, attempt, delay);\n\n      await new Promise((resolve) => setTimeout(resolve, delay));\n    }\n  }\n\n  throw lastError;\n}\n\ntype CircuitState = \"closed\" | \"open\" | \"half-open\";\n\ninterface CircuitBreakerOptions {\n  failureThreshold?: number;\n  resetTimeout?: number;\n  halfOpenMaxAttempts?: number;\n}\n\nexport class CircuitBreaker {\n  private state: CircuitState = \"closed\";\n  private failures = 0;\n  private lastFailureTime = 0;\n  private halfOpenAttempts = 0;\n\n  constructor(private readonly options: CircuitBreakerOptions = {}) {\n    this.options = {\n      failureThreshold: 5,\n      resetTimeout: 30000,\n      halfOpenMaxAttempts: 3,\n      ...options,\n    };\n  }\n\n  async execute<T>(fn: () => Promise<T>): Promise<T> {\n    if (this.state === \"open\") {\n      if (Date.now() - this.lastFailureTime > this.options.resetTimeout!) {\n        this.state = \"half-open\";\n        this.halfOpenAttempts = 0;\n      } else {\n        throw new Error(\"Circuit breaker is open\");\n      }\n    }\n\n    try {\n      const result = await fn();\n      this.onSuccess();\n      return result;\n    } catch (error) {\n      this.onFailure();\n      throw error;\n    }\n  }\n\n  private onSuccess(): void {\n    this.failures = 0;\n    this.state = \"closed\";\n  }\n\n  private onFailure(): void {\n    this.failures++;\n    this.lastFailureTime = Date.now();\n\n    if (this.state === \"half-open\") {\n      this.halfOpenAttempts++;\n      if (this.halfOpenAttempts >= this.options.halfOpenMaxAttempts!) {\n        this.state = \"open\";\n      }\n    } else if (this.failures >= this.options.failureThreshold!) {\n      this.state = \"open\";\n    }\n  }\n\n  getState(): CircuitState {\n    return this.state;\n  }\n\n  reset(): void {\n    this.state = \"closed\";\n    this.failures = 0;\n    this.halfOpenAttempts = 0;\n  }\n}\n","path":null,"size_bytes":11187,"size_tokens":null},"client/src/hooks/useErrorHandler.ts":{"content":"import { useCallback, useState, useRef, useEffect } from \"react\";\nimport { useQueryClient } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport {\n  ApiError,\n  ApiRequestError,\n  ErrorCode,\n  showErrorToast,\n  isAuthError,\n  isRetryableError,\n  withRetry,\n  parseApiError,\n} from \"@/lib/error-utils\";\n\ninterface ErrorState {\n  error: ApiError | null;\n  isLoading: boolean;\n  retryCount: number;\n}\n\ninterface UseErrorHandlerOptions {\n  onAuthError?: () => void;\n  showToast?: boolean;\n  autoRetry?: boolean;\n  maxRetries?: number;\n  onError?: (error: ApiError) => void;\n  redirectOnAuth?: string;\n}\n\ninterface UseErrorHandlerReturn {\n  error: ApiError | null;\n  isLoading: boolean;\n  retryCount: number;\n  clearError: () => void;\n  handleError: (error: unknown) => void;\n  executeWithErrorHandling: <T>(\n    fn: () => Promise<T>,\n    options?: { showSuccessToast?: string }\n  ) => Promise<T | null>;\n  wrapMutation: <T, A extends unknown[]>(\n    fn: (...args: A) => Promise<T>\n  ) => (...args: A) => Promise<T | null>;\n}\n\nexport function useErrorHandler(\n  options: UseErrorHandlerOptions = {}\n): UseErrorHandlerReturn {\n  const {\n    onAuthError,\n    showToast = true,\n    autoRetry = false,\n    maxRetries = 2,\n    onError,\n    redirectOnAuth = \"/login\",\n  } = options;\n\n  const [state, setState] = useState<ErrorState>({\n    error: null,\n    isLoading: false,\n    retryCount: 0,\n  });\n\n  const [, setLocation] = useLocation();\n  const queryClient = useQueryClient();\n  const mountedRef = useRef(true);\n\n  useEffect(() => {\n    mountedRef.current = true;\n    return () => {\n      mountedRef.current = false;\n    };\n  }, []);\n\n  const safeSetState = useCallback((update: Partial<ErrorState>) => {\n    if (mountedRef.current) {\n      setState((prev) => ({ ...prev, ...update }));\n    }\n  }, []);\n\n  const clearError = useCallback(() => {\n    safeSetState({ error: null, retryCount: 0 });\n  }, [safeSetState]);\n\n  const handleError = useCallback(\n    (error: unknown) => {\n      let apiError: ApiError;\n\n      if (error instanceof ApiRequestError) {\n        apiError = error.apiError;\n      } else if (error instanceof Error) {\n        const isNetworkError =\n          error.name === \"NetworkError\" ||\n          error.message.toLowerCase().includes(\"network\") ||\n          error.message.toLowerCase().includes(\"fetch\");\n\n        apiError = {\n          code: isNetworkError ? ErrorCode.NETWORK_ERROR : ErrorCode.INTERNAL_ERROR,\n          message: error.message,\n          category: \"INTERNAL\",\n          timestamp: new Date().toISOString(),\n          retryable: isNetworkError,\n        };\n      } else {\n        apiError = {\n          code: ErrorCode.INTERNAL_ERROR,\n          message: \"An unexpected error occurred\",\n          category: \"INTERNAL\",\n          timestamp: new Date().toISOString(),\n          retryable: false,\n        };\n      }\n\n      safeSetState({ error: apiError });\n\n      if (isAuthError(apiError)) {\n        if (onAuthError) {\n          onAuthError();\n        } else if (redirectOnAuth) {\n          queryClient.clear();\n          setLocation(redirectOnAuth);\n        }\n      }\n\n      if (showToast) {\n        showErrorToast(apiError, {\n          action: isRetryableError(apiError)\n            ? {\n                label: \"Retry\",\n                onClick: clearError,\n              }\n            : undefined,\n        });\n      }\n\n      onError?.(apiError);\n    },\n    [\n      safeSetState,\n      onAuthError,\n      showToast,\n      onError,\n      clearError,\n      queryClient,\n      setLocation,\n      redirectOnAuth,\n    ]\n  );\n\n  const executeWithErrorHandling = useCallback(\n    async <T>(\n      fn: () => Promise<T>,\n      execOptions?: { showSuccessToast?: string }\n    ): Promise<T | null> => {\n      safeSetState({ isLoading: true, error: null });\n\n      try {\n        const executor = autoRetry\n          ? () =>\n              withRetry(fn, {\n                maxRetries,\n                onRetry: (_, attempt) => {\n                  safeSetState({ retryCount: attempt + 1 });\n                },\n              })\n          : fn;\n\n        const result = await executor();\n\n        safeSetState({ isLoading: false, retryCount: 0 });\n\n        if (execOptions?.showSuccessToast) {\n          const { toast } = await import(\"sonner\");\n          toast.success(execOptions.showSuccessToast);\n        }\n\n        return result;\n      } catch (error) {\n        safeSetState({ isLoading: false });\n        handleError(error);\n        return null;\n      }\n    },\n    [safeSetState, autoRetry, maxRetries, handleError]\n  );\n\n  const wrapMutation = useCallback(\n    <T, A extends unknown[]>(fn: (...args: A) => Promise<T>) => {\n      return async (...args: A): Promise<T | null> => {\n        return executeWithErrorHandling(() => fn(...args));\n      };\n    },\n    [executeWithErrorHandling]\n  );\n\n  return {\n    error: state.error,\n    isLoading: state.isLoading,\n    retryCount: state.retryCount,\n    clearError,\n    handleError,\n    executeWithErrorHandling,\n    wrapMutation,\n  };\n}\n\nexport async function fetchWithErrorHandling<T>(\n  url: string,\n  options?: RequestInit\n): Promise<T> {\n  const response = await fetch(url, {\n    ...options,\n    credentials: \"include\",\n    headers: {\n      \"Content-Type\": \"application/json\",\n      ...options?.headers,\n    },\n  });\n\n  if (!response.ok) {\n    let body: unknown;\n    try {\n      body = await response.json();\n    } catch {\n      body = await response.text();\n    }\n\n    const apiError = parseApiError(response, body);\n    throw new ApiRequestError(response.status, apiError);\n  }\n\n  const contentType = response.headers.get(\"content-type\");\n  if (contentType?.includes(\"application/json\")) {\n    return response.json();\n  }\n\n  return response.text() as unknown as T;\n}\n\nexport function createApiRequest(baseUrl = \"\") {\n  return {\n    async get<T>(path: string): Promise<T> {\n      return fetchWithErrorHandling<T>(`${baseUrl}${path}`, {\n        method: \"GET\",\n      });\n    },\n\n    async post<T>(path: string, data?: unknown): Promise<T> {\n      return fetchWithErrorHandling<T>(`${baseUrl}${path}`, {\n        method: \"POST\",\n        body: data ? JSON.stringify(data) : undefined,\n      });\n    },\n\n    async put<T>(path: string, data?: unknown): Promise<T> {\n      return fetchWithErrorHandling<T>(`${baseUrl}${path}`, {\n        method: \"PUT\",\n        body: data ? JSON.stringify(data) : undefined,\n      });\n    },\n\n    async patch<T>(path: string, data?: unknown): Promise<T> {\n      return fetchWithErrorHandling<T>(`${baseUrl}${path}`, {\n        method: \"PATCH\",\n        body: data ? JSON.stringify(data) : undefined,\n      });\n    },\n\n    async delete<T>(path: string): Promise<T> {\n      return fetchWithErrorHandling<T>(`${baseUrl}${path}`, {\n        method: \"DELETE\",\n      });\n    },\n  };\n}\n\nexport const api = createApiRequest(\"/api\");\n","path":null,"size_bytes":6832,"size_tokens":null},"server/race-cleanup.ts":{"content":"import { storage } from \"./storage\";\nimport { raceCache } from \"./race-cache\";\n\ninterface CleanupStats {\n  totalCleaned: number;\n  lastCleanup: Date | null;\n  waitingCleaned: number;\n  countdownCleaned: number;\n  racingCleaned: number;\n}\n\nconst CLEANUP_INTERVAL_MS = 60 * 1000; // Run cleanup every minute\nconst WAITING_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes for waiting races\nconst COUNTDOWN_TIMEOUT_MS = 2 * 60 * 1000; // 2 minutes for countdown races\nconst RACING_TIMEOUT_MS = 30 * 60 * 1000; // 30 minutes for racing races\nconst FINISHED_RETENTION_MS = 24 * 60 * 60 * 1000; // Keep finished races for 24 hours\n\nclass RaceCleanupScheduler {\n  private cleanupTimer: NodeJS.Timeout | null = null;\n  private isRunning = false;\n  private stats: CleanupStats = {\n    totalCleaned: 0,\n    lastCleanup: null,\n    waitingCleaned: 0,\n    countdownCleaned: 0,\n    racingCleaned: 0,\n  };\n\n  initialize() {\n    this.cleanupTimer = setInterval(() => {\n      this.runCleanup();\n    }, CLEANUP_INTERVAL_MS);\n    \n    setTimeout(() => {\n      this.runCleanup();\n    }, 5000);\n\n    console.log(\"[RaceCleanup] Scheduler initialized\");\n  }\n\n  shutdown() {\n    if (this.cleanupTimer) {\n      clearInterval(this.cleanupTimer);\n      this.cleanupTimer = null;\n    }\n  }\n\n  async runCleanup(): Promise<void> {\n    if (this.isRunning) {\n      console.log(\"[RaceCleanup] Cleanup already running, skipping\");\n      return;\n    }\n\n    this.isRunning = true;\n    const startTime = Date.now();\n\n    try {\n      const staleRaces = await storage.getStaleRaces(\n        WAITING_TIMEOUT_MS,\n        COUNTDOWN_TIMEOUT_MS,\n        RACING_TIMEOUT_MS\n      );\n\n      let cleaned = 0;\n\n      for (const race of staleRaces) {\n        try {\n          await storage.updateRaceStatus(race.id, \"finished\", undefined, new Date());\n          \n          raceCache.deleteRace(race.id);\n\n          cleaned++;\n\n          if (race.status === \"waiting\") this.stats.waitingCleaned++;\n          else if (race.status === \"countdown\") this.stats.countdownCleaned++;\n          else if (race.status === \"racing\") this.stats.racingCleaned++;\n\n        } catch (error) {\n          console.error(`[RaceCleanup] Failed to clean race ${race.id}:`, error);\n        }\n      }\n\n      const oldFinished = await storage.cleanupOldFinishedRaces(FINISHED_RETENTION_MS);\n\n      if (cleaned > 0 || oldFinished > 0) {\n        console.log(`[RaceCleanup] Cleaned ${cleaned} stale races, ${oldFinished} old finished races in ${Date.now() - startTime}ms`);\n      }\n\n      this.stats.totalCleaned += cleaned + oldFinished;\n      this.stats.lastCleanup = new Date();\n\n    } catch (error) {\n      console.error(\"[RaceCleanup] Cleanup failed:\", error);\n    } finally {\n      this.isRunning = false;\n    }\n  }\n\n  getStats(): CleanupStats {\n    return { ...this.stats };\n  }\n\n  async forceCleanup(): Promise<void> {\n    await this.runCleanup();\n  }\n}\n\nexport const raceCleanupScheduler = new RaceCleanupScheduler();\n","path":null,"size_bytes":2940,"size_tokens":null},"server/race-cache.ts":{"content":"import type { Race, RaceParticipant } from \"@shared/schema\";\n\ninterface CachedRace {\n  race: Race;\n  participants: RaceParticipant[];\n  updatedAt: number;\n  accessedAt: number;\n  version: number;\n}\n\ninterface ParticipantProgress {\n  progress: number;\n  wpm: number;\n  accuracy: number;\n  errors: number;\n  lastUpdate: number;\n  dirty: boolean;\n}\n\ninterface CacheStats {\n  hits: number;\n  misses: number;\n  evictions: number;\n  flushes: number;\n  activeRaces: number;\n  totalParticipants: number;\n}\n\nconst CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutes TTL for race data\nconst MAX_CACHE_SIZE = 10000; // Maximum number of races to cache\nconst PROGRESS_FLUSH_INTERVAL_MS = 500; // Flush progress updates every 500ms\nconst LRU_CHECK_INTERVAL_MS = 60 * 1000; // Check for LRU eviction every minute\n\nclass RaceCache {\n  private cache: Map<number, CachedRace> = new Map();\n  private progressBuffer: Map<number, ParticipantProgress> = new Map();\n  private stats: CacheStats = {\n    hits: 0,\n    misses: 0,\n    evictions: 0,\n    flushes: 0,\n    activeRaces: 0,\n    totalParticipants: 0,\n  };\n  private flushTimer: NodeJS.Timeout | null = null;\n  private lruTimer: NodeJS.Timeout | null = null;\n  private flushCallback: ((updates: Map<number, ParticipantProgress>) => Promise<void>) | null = null;\n\n  initialize(flushCallback: (updates: Map<number, ParticipantProgress>) => Promise<void>) {\n    this.flushCallback = flushCallback;\n    \n    this.flushTimer = setInterval(() => {\n      this.flushProgressUpdates();\n    }, PROGRESS_FLUSH_INTERVAL_MS);\n\n    this.lruTimer = setInterval(() => {\n      this.evictStaleEntries();\n    }, LRU_CHECK_INTERVAL_MS);\n\n    console.log(\"[RaceCache] Initialized with TTL:\", CACHE_TTL_MS, \"ms, max size:\", MAX_CACHE_SIZE);\n  }\n\n  shutdown() {\n    if (this.flushTimer) {\n      clearInterval(this.flushTimer);\n      this.flushTimer = null;\n    }\n    if (this.lruTimer) {\n      clearInterval(this.lruTimer);\n      this.lruTimer = null;\n    }\n    this.flushProgressUpdates();\n  }\n\n  async flushAll(): Promise<void> {\n    console.log(\"[RaceCache] Flushing all progress updates before shutdown...\");\n    await this.flushProgressUpdates();\n    console.log(`[RaceCache] Flushed ${this.progressBuffer.size} pending updates`);\n  }\n\n  setRace(race: Race, participants: RaceParticipant[] = []): void {\n    const existing = this.cache.get(race.id);\n    const now = Date.now();\n    \n    if (this.cache.size >= MAX_CACHE_SIZE && !existing) {\n      this.evictLRU();\n    }\n\n    this.cache.set(race.id, {\n      race,\n      participants,\n      updatedAt: now,\n      accessedAt: now,\n      version: existing ? existing.version + 1 : 1,\n    });\n\n    this.updateStats();\n  }\n\n  getRace(raceId: number): CachedRace | undefined {\n    const entry = this.cache.get(raceId);\n    if (entry) {\n      const now = Date.now();\n      if (now - entry.updatedAt > CACHE_TTL_MS) {\n        this.cache.delete(raceId);\n        this.stats.evictions++;\n        return undefined;\n      }\n      entry.accessedAt = now;\n      this.stats.hits++;\n      return entry;\n    }\n    this.stats.misses++;\n    return undefined;\n  }\n\n  updateParticipants(raceId: number, participants: RaceParticipant[]): void {\n    const entry = this.cache.get(raceId);\n    if (entry) {\n      entry.participants = participants;\n      entry.updatedAt = Date.now();\n      entry.version++;\n    }\n  }\n\n  addParticipant(raceId: number, participant: RaceParticipant): void {\n    const entry = this.cache.get(raceId);\n    if (entry) {\n      const existingIdx = entry.participants.findIndex(p => p.id === participant.id);\n      if (existingIdx >= 0) {\n        entry.participants[existingIdx] = participant;\n      } else {\n        entry.participants.push(participant);\n      }\n      entry.updatedAt = Date.now();\n      entry.version++;\n    }\n  }\n\n  removeParticipant(raceId: number, participantId: number): void {\n    const entry = this.cache.get(raceId);\n    if (entry) {\n      entry.participants = entry.participants.filter(p => p.id !== participantId);\n      entry.updatedAt = Date.now();\n      entry.version++;\n    }\n  }\n\n  updateRaceStatus(raceId: number, status: string, startedAt?: Date, finishedAt?: Date): void {\n    const entry = this.cache.get(raceId);\n    if (entry) {\n      entry.race = {\n        ...entry.race,\n        status,\n        startedAt: startedAt || entry.race.startedAt,\n        finishedAt: finishedAt || entry.race.finishedAt,\n      };\n      entry.updatedAt = Date.now();\n      entry.version++;\n    }\n  }\n\n  bufferProgress(participantId: number, progress: number, wpm: number, accuracy: number, errors: number): void {\n    this.progressBuffer.set(participantId, {\n      progress,\n      wpm,\n      accuracy,\n      errors,\n      lastUpdate: Date.now(),\n      dirty: true,\n    });\n\n    const entries = Array.from(this.cache.values());\n    for (const entry of entries) {\n      const participant = entry.participants.find((p: RaceParticipant) => p.id === participantId);\n      if (participant) {\n        participant.progress = progress;\n        participant.wpm = wpm;\n        participant.accuracy = accuracy;\n        participant.errors = errors;\n        break;\n      }\n    }\n  }\n\n  private async flushProgressUpdates(): Promise<void> {\n    if (this.progressBuffer.size === 0 || !this.flushCallback) {\n      return;\n    }\n\n    const dirtyUpdates = new Map<number, ParticipantProgress>();\n    const progressEntries = Array.from(this.progressBuffer.entries());\n    for (const [id, update] of progressEntries) {\n      if (update.dirty) {\n        dirtyUpdates.set(id, { ...update, dirty: false });\n        update.dirty = false;\n      }\n    }\n\n    if (dirtyUpdates.size > 0) {\n      try {\n        await this.flushCallback(dirtyUpdates);\n        this.stats.flushes++;\n        \n        // Clean up successfully flushed entries from progressBuffer\n        // Only keep entries that have been updated since we started the flush\n        const now = Date.now();\n        const STALE_THRESHOLD_MS = 30 * 1000; // 30 seconds\n        const entriesToDelete: number[] = [];\n        \n        for (const [id, update] of Array.from(this.progressBuffer.entries())) {\n          // Delete if not dirty and older than threshold (participant finished or disconnected)\n          if (!update.dirty && now - update.lastUpdate > STALE_THRESHOLD_MS) {\n            entriesToDelete.push(id);\n          }\n        }\n        \n        for (const id of entriesToDelete) {\n          this.progressBuffer.delete(id);\n        }\n        \n        // Enforce max size cap on progressBuffer to prevent unbounded growth\n        const MAX_PROGRESS_BUFFER_SIZE = 5000;\n        if (this.progressBuffer.size > MAX_PROGRESS_BUFFER_SIZE) {\n          // Remove oldest entries first\n          const sorted = Array.from(this.progressBuffer.entries())\n            .sort((a, b) => a[1].lastUpdate - b[1].lastUpdate);\n          const toRemove = sorted.slice(0, this.progressBuffer.size - MAX_PROGRESS_BUFFER_SIZE);\n          for (const [id] of toRemove) {\n            this.progressBuffer.delete(id);\n          }\n          console.log(`[RaceCache] Progress buffer capped, removed ${toRemove.length} oldest entries`);\n        }\n      } catch (error) {\n        console.error(\"[RaceCache] Failed to flush progress updates:\", error);\n        const dirtyEntries = Array.from(dirtyUpdates.entries());\n        for (const [id] of dirtyEntries) {\n          const existing = this.progressBuffer.get(id);\n          if (existing) {\n            existing.dirty = true;\n          }\n        }\n      }\n    }\n  }\n\n  private evictStaleEntries(): void {\n    const now = Date.now();\n    const entriesToRemove: number[] = [];\n\n    const cacheEntries = Array.from(this.cache.entries());\n    for (const [raceId, entry] of cacheEntries) {\n      if (now - entry.updatedAt > CACHE_TTL_MS) {\n        entriesToRemove.push(raceId);\n      }\n    }\n\n    for (const raceId of entriesToRemove) {\n      this.cache.delete(raceId);\n      this.stats.evictions++;\n    }\n\n    if (entriesToRemove.length > 0) {\n      console.log(`[RaceCache] Evicted ${entriesToRemove.length} stale entries`);\n    }\n\n    this.updateStats();\n  }\n\n  private evictLRU(): void {\n    let oldestAccess = Infinity;\n    let oldestRaceId: number | null = null;\n\n    const cacheEntries = Array.from(this.cache.entries());\n    for (const [raceId, entry] of cacheEntries) {\n      if (entry.accessedAt < oldestAccess) {\n        oldestAccess = entry.accessedAt;\n        oldestRaceId = raceId;\n      }\n    }\n\n    if (oldestRaceId !== null) {\n      this.cache.delete(oldestRaceId);\n      this.stats.evictions++;\n      console.log(`[RaceCache] LRU eviction: race ${oldestRaceId}`);\n    }\n  }\n\n  private updateStats(): void {\n    this.stats.activeRaces = this.cache.size;\n    let totalParticipants = 0;\n    const entries = Array.from(this.cache.values());\n    for (const entry of entries) {\n      totalParticipants += entry.participants.length;\n    }\n    this.stats.totalParticipants = totalParticipants;\n  }\n\n  deleteRace(raceId: number): void {\n    this.cache.delete(raceId);\n    this.updateStats();\n  }\n\n  getActiveRaces(): Race[] {\n    const now = Date.now();\n    const activeRaces: Race[] = [];\n\n    const entries = Array.from(this.cache.values());\n    for (const entry of entries) {\n      if (now - entry.updatedAt <= CACHE_TTL_MS) {\n        if ([\"waiting\", \"countdown\", \"racing\"].includes(entry.race.status)) {\n          activeRaces.push(entry.race);\n        }\n      }\n    }\n\n    return activeRaces.sort((a, b) => {\n      const aTime = a.createdAt ? new Date(a.createdAt).getTime() : 0;\n      const bTime = b.createdAt ? new Date(b.createdAt).getTime() : 0;\n      return bTime - aTime;\n    });\n  }\n\n  getStats(): CacheStats {\n    this.updateStats();\n    return { ...this.stats };\n  }\n\n  clearProgressBuffer(participantId: number): void {\n    this.progressBuffer.delete(participantId);\n  }\n\n  getProgressFromBuffer(participantId: number): ParticipantProgress | undefined {\n    return this.progressBuffer.get(participantId);\n  }\n\n  finishParticipant(raceId: number, participantId: number, position: number): void {\n    const entry = this.cache.get(raceId);\n    if (entry) {\n      const participant = entry.participants.find(p => p.id === participantId);\n      if (participant) {\n        participant.isFinished = 1;\n        participant.finishPosition = position;\n        participant.finishedAt = new Date();\n      }\n      entry.updatedAt = Date.now();\n      entry.version++;\n    }\n  }\n\n  extendParagraph(raceId: number, additionalContent: string): number | null {\n    const entry = this.cache.get(raceId);\n    if (entry) {\n      entry.race.paragraphContent = entry.race.paragraphContent + \" \" + additionalContent;\n      entry.updatedAt = Date.now();\n      entry.version++;\n      return entry.race.paragraphContent.length;\n    }\n    return null;\n  }\n}\n\nexport const raceCache = new RaceCache();\n","path":null,"size_bytes":10820,"size_tokens":null},"server/ws-rate-limiter.ts":{"content":"import type { WebSocket } from \"ws\";\n\ninterface RateLimitConfig {\n  maxTokens: number;\n  refillRate: number; // tokens per second\n  refillInterval: number; // ms between refills\n}\n\ninterface ClientBucket {\n  tokens: number;\n  lastRefill: number;\n  messageCount: number;\n  lastReset: number;\n  violations: number;\n}\n\ninterface RateLimitResult {\n  allowed: boolean;\n  remaining: number;\n  retryAfter?: number;\n  violation?: boolean;\n}\n\nconst MESSAGE_TYPE_LIMITS: Record<string, RateLimitConfig> = {\n  progress: { maxTokens: 30, refillRate: 20, refillInterval: 50 }, // 20 per second max\n  join: { maxTokens: 5, refillRate: 1, refillInterval: 1000 }, // 1 per second\n  ready: { maxTokens: 3, refillRate: 1, refillInterval: 1000 },\n  finish: { maxTokens: 3, refillRate: 1, refillInterval: 1000 },\n  leave: { maxTokens: 3, refillRate: 1, refillInterval: 1000 },\n  chat_message: { maxTokens: 20, refillRate: 2, refillInterval: 500 }, // 4 per second, burst of 20\n  // Host command rate limits - stricter to prevent abuse\n  kick_player: { maxTokens: 3, refillRate: 1, refillInterval: 2000 }, // 1 kick per 2 seconds\n  lock_room: { maxTokens: 2, refillRate: 1, refillInterval: 3000 }, // 1 lock toggle per 3 seconds\n  ready_toggle: { maxTokens: 5, refillRate: 2, refillInterval: 1000 }, // 2 toggles per second\n  rematch: { maxTokens: 2, refillRate: 1, refillInterval: 5000 }, // 1 rematch per 5 seconds\n  spectate: { maxTokens: 3, refillRate: 1, refillInterval: 2000 }, // 1 spectate per 2 seconds\n  stop_spectate: { maxTokens: 3, refillRate: 1, refillInterval: 1000 },\n  keystroke_validation: { maxTokens: 10, refillRate: 5, refillInterval: 200 }, // 5 per second\n  default: { maxTokens: 10, refillRate: 5, refillInterval: 200 },\n};\n\nconst MAX_PAYLOAD_SIZE = 10 * 1024; // 10KB max payload\nconst MAX_VIOLATIONS = 10;\nconst VIOLATION_RESET_MS = 60 * 1000; // Reset violations after 1 minute\nconst CLEANUP_INTERVAL_MS = 5 * 60 * 1000; // Clean up stale buckets every 5 minutes\nconst BUCKET_EXPIRE_MS = 10 * 60 * 1000; // Expire buckets after 10 minutes of inactivity\n\nclass WebSocketRateLimiter {\n  private buckets: Map<WebSocket, Map<string, ClientBucket>> = new Map();\n  private globalStats = {\n    totalMessages: 0,\n    droppedMessages: 0,\n    violations: 0,\n    activeConnections: 0,\n  };\n  private cleanupTimer: NodeJS.Timeout | null = null;\n\n  initialize() {\n    this.cleanupTimer = setInterval(() => {\n      this.cleanupStaleBuckets();\n    }, CLEANUP_INTERVAL_MS);\n    console.log(\"[WS RateLimiter] Initialized\");\n  }\n\n  shutdown() {\n    if (this.cleanupTimer) {\n      clearInterval(this.cleanupTimer);\n      this.cleanupTimer = null;\n    }\n  }\n\n  validatePayload(data: string): { valid: boolean; error?: string } {\n    if (data.length > MAX_PAYLOAD_SIZE) {\n      return { valid: false, error: `Payload too large: ${data.length} bytes (max: ${MAX_PAYLOAD_SIZE})` };\n    }\n\n    try {\n      const parsed = JSON.parse(data);\n      if (!parsed || typeof parsed !== 'object') {\n        return { valid: false, error: \"Invalid message format: must be JSON object\" };\n      }\n      if (!parsed.type || typeof parsed.type !== 'string') {\n        return { valid: false, error: \"Invalid message format: missing or invalid 'type' field\" };\n      }\n      if (parsed.type.length > 50) {\n        return { valid: false, error: \"Invalid message type: too long\" };\n      }\n      return { valid: true };\n    } catch {\n      return { valid: false, error: \"Invalid JSON\" };\n    }\n  }\n\n  checkLimit(ws: WebSocket, messageType: string): RateLimitResult {\n    this.globalStats.totalMessages++;\n\n    if (!this.buckets.has(ws)) {\n      this.buckets.set(ws, new Map());\n      this.globalStats.activeConnections = this.buckets.size;\n    }\n\n    const clientBuckets = this.buckets.get(ws)!;\n    const config = MESSAGE_TYPE_LIMITS[messageType] || MESSAGE_TYPE_LIMITS.default;\n\n    if (!clientBuckets.has(messageType)) {\n      clientBuckets.set(messageType, {\n        tokens: config.maxTokens,\n        lastRefill: Date.now(),\n        messageCount: 0,\n        lastReset: Date.now(),\n        violations: 0,\n      });\n    }\n\n    const bucket = clientBuckets.get(messageType)!;\n    const now = Date.now();\n\n    if (now - bucket.lastReset > VIOLATION_RESET_MS) {\n      bucket.violations = 0;\n      bucket.lastReset = now;\n    }\n\n    const timePassed = now - bucket.lastRefill;\n    const tokensToAdd = Math.floor((timePassed / config.refillInterval) * config.refillRate);\n    \n    if (tokensToAdd > 0) {\n      bucket.tokens = Math.min(config.maxTokens, bucket.tokens + tokensToAdd);\n      bucket.lastRefill = now;\n    }\n\n    if (bucket.tokens < 1) {\n      bucket.violations++;\n      this.globalStats.droppedMessages++;\n      \n      if (bucket.violations >= MAX_VIOLATIONS) {\n        this.globalStats.violations++;\n        return {\n          allowed: false,\n          remaining: 0,\n          retryAfter: Math.ceil(config.refillInterval / 1000),\n          violation: true,\n        };\n      }\n\n      return {\n        allowed: false,\n        remaining: 0,\n        retryAfter: Math.ceil(config.refillInterval / 1000),\n      };\n    }\n\n    bucket.tokens--;\n    bucket.messageCount++;\n\n    return {\n      allowed: true,\n      remaining: Math.floor(bucket.tokens),\n    };\n  }\n\n  removeClient(ws: WebSocket): void {\n    this.buckets.delete(ws);\n    this.globalStats.activeConnections = this.buckets.size;\n  }\n\n  private cleanupStaleBuckets(): void {\n    const now = Date.now();\n    let cleaned = 0;\n\n    const bucketEntries = Array.from(this.buckets.entries());\n    for (const [ws, clientBuckets] of bucketEntries) {\n      let allStale = true;\n      const bucketValues = Array.from(clientBuckets.values());\n      for (const bucket of bucketValues) {\n        if (now - bucket.lastRefill < BUCKET_EXPIRE_MS) {\n          allStale = false;\n          break;\n        }\n      }\n      if (allStale) {\n        this.buckets.delete(ws);\n        cleaned++;\n      }\n    }\n\n    if (cleaned > 0) {\n      console.log(`[WS RateLimiter] Cleaned ${cleaned} stale client buckets`);\n      this.globalStats.activeConnections = this.buckets.size;\n    }\n  }\n\n  getStats() {\n    return { ...this.globalStats };\n  }\n\n  getClientStats(ws: WebSocket): Record<string, { remaining: number; messageCount: number }> {\n    const clientBuckets = this.buckets.get(ws);\n    if (!clientBuckets) return {};\n\n    const stats: Record<string, { remaining: number; messageCount: number }> = {};\n    const clientBucketEntries = Array.from(clientBuckets.entries());\n    for (const [type, bucket] of clientBucketEntries) {\n      stats[type] = {\n        remaining: Math.floor(bucket.tokens),\n        messageCount: bucket.messageCount,\n      };\n    }\n    return stats;\n  }\n}\n\nexport const wsRateLimiter = new WebSocketRateLimiter();\n","path":null,"size_bytes":6737,"size_tokens":null},"server/graceful-shutdown.ts":{"content":"import type { Server } from \"http\";\nimport { raceWebSocket } from \"./websocket\";\nimport { metricsCollector } from \"./metrics\";\nimport { raceCleanupScheduler } from \"./race-cleanup\";\nimport { raceCache } from \"./race-cache\";\n\nconst SHUTDOWN_TIMEOUT_MS = 30000;\n\nlet isShuttingDown = false;\nlet httpServer: Server | null = null;\n\nexport function registerShutdownHandlers(server: Server): void {\n  httpServer = server;\n\n  process.on(\"SIGTERM\", () => handleShutdown(\"SIGTERM\"));\n  process.on(\"SIGINT\", () => handleShutdown(\"SIGINT\"));\n  \n  process.on(\"uncaughtException\", (error) => {\n    console.error(\"[Shutdown] Uncaught exception:\", error);\n    handleShutdown(\"uncaughtException\");\n  });\n  \n  process.on(\"unhandledRejection\", (reason) => {\n    console.error(\"[Shutdown] Unhandled rejection:\", reason);\n  });\n\n  console.log(\"[Shutdown] Graceful shutdown handlers registered\");\n}\n\nasync function handleShutdown(signal: string): Promise<void> {\n  if (isShuttingDown) {\n    console.log(\"[Shutdown] Already shutting down, ignoring signal:\", signal);\n    return;\n  }\n  \n  isShuttingDown = true;\n  console.log(`[Shutdown] Received ${signal}, starting graceful shutdown...`);\n  \n  const shutdownTimeout = setTimeout(() => {\n    console.error(\"[Shutdown] Forced exit after timeout\");\n    process.exit(1);\n  }, SHUTDOWN_TIMEOUT_MS);\n  \n  try {\n    console.log(\"[Shutdown] Stopping new connections...\");\n    if (httpServer) {\n      httpServer.close();\n    }\n    \n    console.log(\"[Shutdown] Flushing cache to database...\");\n    await raceCache.flushAll();\n    \n    console.log(\"[Shutdown] Closing WebSocket connections...\");\n    raceWebSocket.shutdown();\n    \n    console.log(\"[Shutdown] Stopping cleanup scheduler...\");\n    raceCleanupScheduler.shutdown();\n    \n    console.log(\"[Shutdown] Stopping metrics collector...\");\n    metricsCollector.shutdown();\n    \n    console.log(\"[Shutdown] Graceful shutdown complete\");\n    clearTimeout(shutdownTimeout);\n    process.exit(0);\n  } catch (error) {\n    console.error(\"[Shutdown] Error during shutdown:\", error);\n    clearTimeout(shutdownTimeout);\n    process.exit(1);\n  }\n}\n\nexport function isServerShuttingDown(): boolean {\n  return isShuttingDown;\n}\n","path":null,"size_bytes":2188,"size_tokens":null},"server/health-check.ts":{"content":"import { storage } from \"./storage\";\nimport { raceWebSocket } from \"./websocket\";\nimport { metricsCollector } from \"./metrics\";\n\ninterface HealthCheckResult {\n  status: \"healthy\" | \"degraded\" | \"unhealthy\";\n  timestamp: string;\n  version: string;\n  checks: {\n    database: ComponentHealth;\n    websocket: ComponentHealth;\n    memory: ComponentHealth;\n    cache: ComponentHealth;\n  };\n  metrics?: ReturnType<typeof metricsCollector.getStats>;\n}\n\ninterface ComponentHealth {\n  status: \"healthy\" | \"degraded\" | \"unhealthy\";\n  latencyMs?: number;\n  message?: string;\n  details?: Record<string, unknown>;\n}\n\nconst VERSION = \"2.0.0-scalable\";\nconst MEMORY_WARNING_THRESHOLD = 0.85;\nconst MEMORY_CRITICAL_THRESHOLD = 0.95;\nconst DB_LATENCY_WARNING_MS = 100;\nconst DB_LATENCY_CRITICAL_MS = 500;\n\nasync function checkDatabase(): Promise<ComponentHealth> {\n  const start = Date.now();\n  \n  try {\n    await storage.getActiveRaces();\n    const latencyMs = Date.now() - start;\n    \n    if (latencyMs > DB_LATENCY_CRITICAL_MS) {\n      return {\n        status: \"degraded\",\n        latencyMs,\n        message: \"Database response time is high\",\n      };\n    }\n    \n    if (latencyMs > DB_LATENCY_WARNING_MS) {\n      return {\n        status: \"healthy\",\n        latencyMs,\n        message: \"Database response time is elevated\",\n      };\n    }\n    \n    return {\n      status: \"healthy\",\n      latencyMs,\n    };\n  } catch (error: any) {\n    return {\n      status: \"unhealthy\",\n      message: `Database connection failed: ${error.message}`,\n    };\n  }\n}\n\nfunction checkWebSocket(): ComponentHealth {\n  try {\n    const stats = raceWebSocket.getStats();\n    const loadState = raceWebSocket.getLoadState();\n    \n    if (loadState.isUnderPressure) {\n      return {\n        status: \"degraded\",\n        message: \"WebSocket server under pressure\",\n        details: {\n          connections: stats.totalConnections,\n          dbFailures: loadState.dbFailures,\n          rejections: loadState.connectionRejections,\n        },\n      };\n    }\n    \n    return {\n      status: \"healthy\",\n      details: {\n        connections: stats.totalConnections,\n        rooms: stats.activeRooms,\n        messagesProcessed: stats.messagesProcessed,\n      },\n    };\n  } catch (error: any) {\n    return {\n      status: \"unhealthy\",\n      message: `WebSocket check failed: ${error.message}`,\n    };\n  }\n}\n\nfunction checkMemory(): ComponentHealth {\n  const memUsage = process.memoryUsage();\n  const heapUsedMB = Math.round(memUsage.heapUsed / 1024 / 1024);\n  const heapTotalMB = Math.round(memUsage.heapTotal / 1024 / 1024);\n  const rssMB = Math.round(memUsage.rss / 1024 / 1024);\n  const heapUsageRatio = memUsage.heapUsed / memUsage.heapTotal;\n  \n  const details = {\n    heapUsedMB,\n    heapTotalMB,\n    rssMB,\n    heapUsagePercent: Math.round(heapUsageRatio * 100),\n  };\n  \n  if (heapUsageRatio > MEMORY_CRITICAL_THRESHOLD) {\n    return {\n      status: \"unhealthy\",\n      message: \"Memory usage critical\",\n      details,\n    };\n  }\n  \n  if (heapUsageRatio > MEMORY_WARNING_THRESHOLD) {\n    return {\n      status: \"degraded\",\n      message: \"Memory usage high\",\n      details,\n    };\n  }\n  \n  return {\n    status: \"healthy\",\n    details,\n  };\n}\n\nfunction checkCache(): ComponentHealth {\n  try {\n    const cacheStats = raceWebSocket.getCacheStats();\n    const hitRate = cacheStats.hits + cacheStats.misses > 0\n      ? cacheStats.hits / (cacheStats.hits + cacheStats.misses)\n      : 1;\n    \n    return {\n      status: \"healthy\",\n      details: {\n        hitRate: Math.round(hitRate * 100),\n        activeRaces: cacheStats.activeRaces,\n        evictions: cacheStats.evictions,\n      },\n    };\n  } catch (error: any) {\n    return {\n      status: \"degraded\",\n      message: `Cache check failed: ${error.message}`,\n    };\n  }\n}\n\nexport async function performHealthCheck(includeMetrics = false): Promise<HealthCheckResult> {\n  const [database, websocket, memory, cache] = await Promise.all([\n    checkDatabase(),\n    Promise.resolve(checkWebSocket()),\n    Promise.resolve(checkMemory()),\n    Promise.resolve(checkCache()),\n  ]);\n  \n  const checks = { database, websocket, memory, cache };\n  \n  const statuses = Object.values(checks).map(c => c.status);\n  let overallStatus: \"healthy\" | \"degraded\" | \"unhealthy\";\n  \n  if (statuses.includes(\"unhealthy\")) {\n    overallStatus = \"unhealthy\";\n  } else if (statuses.includes(\"degraded\")) {\n    overallStatus = \"degraded\";\n  } else {\n    overallStatus = \"healthy\";\n  }\n  \n  const result: HealthCheckResult = {\n    status: overallStatus,\n    timestamp: new Date().toISOString(),\n    version: VERSION,\n    checks,\n  };\n  \n  if (includeMetrics) {\n    result.metrics = metricsCollector.getStats();\n  }\n  \n  return result;\n}\n\nexport async function performLivenessCheck(): Promise<{ alive: boolean }> {\n  return { alive: true };\n}\n\nexport async function performReadinessCheck(): Promise<{ ready: boolean; reason?: string }> {\n  try {\n    await storage.getActiveRaces();\n    return { ready: true };\n  } catch (error: any) {\n    return { ready: false, reason: error.message };\n  }\n}\n","path":null,"size_bytes":5060,"size_tokens":null},"server/metrics.ts":{"content":"interface RollingMetric {\n  values: number[];\n  timestamps: number[];\n  windowMs: number;\n}\n\ninterface MetricsState {\n  requestsPerSecond: RollingMetric;\n  wsMessagesPerSecond: RollingMetric;\n  dbQueriesPerSecond: RollingMetric;\n  avgResponseTimeMs: RollingMetric;\n  errorRate: RollingMetric;\n  startTime: number;\n  totalRequests: number;\n  totalErrors: number;\n  totalDbQueries: number;\n}\n\nconst WINDOW_SIZE_MS = 60 * 1000;\nconst SAMPLE_INTERVAL_MS = 1000;\n\nclass MetricsCollector {\n  private state: MetricsState;\n  private sampleTimer: NodeJS.Timeout | null = null;\n  private requestCount = 0;\n  private wsMessageCount = 0;\n  private dbQueryCount = 0;\n  private errorCount = 0;\n  private responseTimesMs: number[] = [];\n\n  constructor() {\n    this.state = {\n      requestsPerSecond: this.createRollingMetric(),\n      wsMessagesPerSecond: this.createRollingMetric(),\n      dbQueriesPerSecond: this.createRollingMetric(),\n      avgResponseTimeMs: this.createRollingMetric(),\n      errorRate: this.createRollingMetric(),\n      startTime: Date.now(),\n      totalRequests: 0,\n      totalErrors: 0,\n      totalDbQueries: 0,\n    };\n  }\n\n  private createRollingMetric(): RollingMetric {\n    return {\n      values: [],\n      timestamps: [],\n      windowMs: WINDOW_SIZE_MS,\n    };\n  }\n\n  initialize(): void {\n    if (this.sampleTimer) return;\n\n    this.sampleTimer = setInterval(() => {\n      this.sample();\n    }, SAMPLE_INTERVAL_MS);\n\n    console.log(\"[Metrics] Collector initialized\");\n  }\n\n  private sample(): void {\n    const now = Date.now();\n    const cutoff = now - WINDOW_SIZE_MS;\n\n    this.addSample(this.state.requestsPerSecond, this.requestCount, now, cutoff);\n    this.addSample(this.state.wsMessagesPerSecond, this.wsMessageCount, now, cutoff);\n    this.addSample(this.state.dbQueriesPerSecond, this.dbQueryCount, now, cutoff);\n    this.addSample(this.state.errorRate, this.errorCount, now, cutoff);\n\n    const avgResponseTime = this.responseTimesMs.length > 0\n      ? this.responseTimesMs.reduce((a, b) => a + b, 0) / this.responseTimesMs.length\n      : 0;\n    this.addSample(this.state.avgResponseTimeMs, avgResponseTime, now, cutoff);\n\n    this.state.totalRequests += this.requestCount;\n    this.state.totalErrors += this.errorCount;\n    this.state.totalDbQueries += this.dbQueryCount;\n\n    this.requestCount = 0;\n    this.wsMessageCount = 0;\n    this.dbQueryCount = 0;\n    this.errorCount = 0;\n    this.responseTimesMs = [];\n  }\n\n  private addSample(metric: RollingMetric, value: number, now: number, cutoff: number): void {\n    metric.values.push(value);\n    metric.timestamps.push(now);\n\n    while (metric.timestamps.length > 0 && metric.timestamps[0] < cutoff) {\n      metric.timestamps.shift();\n      metric.values.shift();\n    }\n  }\n\n  recordRequest(): void {\n    this.requestCount++;\n  }\n\n  recordWsMessage(): void {\n    this.wsMessageCount++;\n  }\n\n  recordDbQuery(): void {\n    this.dbQueryCount++;\n  }\n\n  recordError(): void {\n    this.errorCount++;\n  }\n\n  recordResponseTime(ms: number): void {\n    this.responseTimesMs.push(ms);\n  }\n\n  private getAverageFromMetric(metric: RollingMetric): number {\n    if (metric.values.length === 0) return 0;\n    return metric.values.reduce((a, b) => a + b, 0) / metric.values.length;\n  }\n\n  private getSumFromMetric(metric: RollingMetric): number {\n    return metric.values.reduce((a, b) => a + b, 0);\n  }\n\n  getStats() {\n    const uptimeMs = Date.now() - this.state.startTime;\n    const uptimeSeconds = Math.floor(uptimeMs / 1000);\n    const uptimeMinutes = Math.floor(uptimeSeconds / 60);\n    const uptimeHours = Math.floor(uptimeMinutes / 60);\n    const uptimeDays = Math.floor(uptimeHours / 24);\n\n    return {\n      uptime: {\n        ms: uptimeMs,\n        formatted: `${uptimeDays}d ${uptimeHours % 24}h ${uptimeMinutes % 60}m ${uptimeSeconds % 60}s`,\n      },\n      rolling60s: {\n        requestsPerSecond: this.getAverageFromMetric(this.state.requestsPerSecond),\n        wsMessagesPerSecond: this.getAverageFromMetric(this.state.wsMessagesPerSecond),\n        dbQueriesPerSecond: this.getAverageFromMetric(this.state.dbQueriesPerSecond),\n        avgResponseTimeMs: this.getAverageFromMetric(this.state.avgResponseTimeMs),\n        errorRate: this.getAverageFromMetric(this.state.errorRate),\n        totalRequests: this.getSumFromMetric(this.state.requestsPerSecond),\n        totalErrors: this.getSumFromMetric(this.state.errorRate),\n      },\n      lifetime: {\n        totalRequests: this.state.totalRequests,\n        totalErrors: this.state.totalErrors,\n        totalDbQueries: this.state.totalDbQueries,\n        errorPercentage: this.state.totalRequests > 0 \n          ? (this.state.totalErrors / this.state.totalRequests) * 100 \n          : 0,\n      },\n    };\n  }\n\n  shutdown(): void {\n    if (this.sampleTimer) {\n      clearInterval(this.sampleTimer);\n      this.sampleTimer = null;\n    }\n    console.log(\"[Metrics] Collector shutdown\");\n  }\n}\n\nexport const metricsCollector = new MetricsCollector();\n","path":null,"size_bytes":4964,"size_tokens":null},"server/elo-rating-service.ts":{"content":"import { storage } from \"./storage\";\nimport type { UserRating, RaceParticipant } from \"@shared/schema\";\n\ninterface RaceResult {\n  participantId: number;\n  userId: string | null;\n  position: number;\n  wpm: number;\n  accuracy: number;\n  isBot: boolean;\n}\n\ninterface RatingChange {\n  userId: string;\n  oldRating: number;\n  newRating: number;\n  change: number;\n  tier: string;\n  isProvisional: boolean;\n}\n\nconst processedRaces = new Map<number, number>();\nconst PROCESSED_RACE_TTL = 60 * 60 * 1000;\n\nfunction cleanupProcessedRaces() {\n  const now = Date.now();\n  for (const [raceId, timestamp] of Array.from(processedRaces.entries())) {\n    if (now - timestamp > PROCESSED_RACE_TTL) {\n      processedRaces.delete(raceId);\n    }\n  }\n}\n\nsetInterval(cleanupProcessedRaces, 5 * 60 * 1000);\n\nconst TIER_THRESHOLDS = {\n  grandmaster: 2400,\n  master: 2100,\n  diamond: 1800,\n  platinum: 1500,\n  gold: 1300,\n  silver: 1100,\n  bronze: 0,\n} as const;\n\nconst K_FACTOR = {\n  provisional: 64,\n  regular: 32,\n  established: 24,\n} as const;\n\nexport class EloRatingService {\n  private calculateExpectedScore(playerRating: number, opponentRating: number): number {\n    return 1 / (1 + Math.pow(10, (opponentRating - playerRating) / 400));\n  }\n\n  private getKFactor(rating: UserRating): number {\n    if (rating.isProvisional) {\n      return K_FACTOR.provisional;\n    }\n    if (rating.totalRaces < 50) {\n      return K_FACTOR.regular;\n    }\n    return K_FACTOR.established;\n  }\n\n  private getTierForRating(rating: number): string {\n    if (rating >= TIER_THRESHOLDS.grandmaster) return \"grandmaster\";\n    if (rating >= TIER_THRESHOLDS.master) return \"master\";\n    if (rating >= TIER_THRESHOLDS.diamond) return \"diamond\";\n    if (rating >= TIER_THRESHOLDS.platinum) return \"platinum\";\n    if (rating >= TIER_THRESHOLDS.gold) return \"gold\";\n    if (rating >= TIER_THRESHOLDS.silver) return \"silver\";\n    return \"bronze\";\n  }\n\n  private calculateMultiplayerScore(position: number, totalPlayers: number): number {\n    if (totalPlayers < 2) return 0.5;\n    return (totalPlayers - position) / (totalPlayers - 1);\n  }\n\n  async processRaceResults(raceId: number, results: RaceResult[]): Promise<RatingChange[]> {\n    if (processedRaces.has(raceId)) {\n      console.log(`[ELO] Race ${raceId} already processed, skipping duplicate`);\n      return [];\n    }\n    \n    const existingHistory = await storage.getRaceMatchHistory(raceId);\n    if (existingHistory.length > 0) {\n      console.log(`[ELO] Race ${raceId} match history exists, skipping duplicate`);\n      processedRaces.set(raceId, Date.now());\n      return [];\n    }\n    \n    processedRaces.set(raceId, Date.now());\n    \n    const humanResults = results.filter(r => !r.isBot && r.userId);\n    \n    if (humanResults.length < 2) {\n      console.log(\"[ELO] Not enough human players to calculate rating changes\");\n      return [];\n    }\n\n    const ratingChanges: RatingChange[] = [];\n    const playerRatings: Map<string, UserRating> = new Map();\n    \n    for (const result of humanResults) {\n      if (result.userId) {\n        const rating = await storage.getOrCreateUserRating(result.userId);\n        playerRatings.set(result.userId, rating);\n      }\n    }\n\n    const totalPlayers = humanResults.length;\n    const avgRating = Array.from(playerRatings.values()).reduce((sum, r) => sum + r.rating, 0) / totalPlayers;\n\n    for (const result of humanResults) {\n      if (!result.userId) continue;\n      \n      const playerRating = playerRatings.get(result.userId);\n      if (!playerRating) continue;\n\n      const actualScore = this.calculateMultiplayerScore(result.position, totalPlayers);\n      \n      let expectedScore = 0;\n      const entries = Array.from(playerRatings.entries());\n      for (const [opponentId, opponentRating] of entries) {\n        if (opponentId !== result.userId) {\n          expectedScore += this.calculateExpectedScore(playerRating.rating, opponentRating.rating);\n        }\n      }\n      expectedScore /= (totalPlayers - 1);\n\n      const K = this.getKFactor(playerRating);\n      const ratingChange = Math.round(K * (actualScore - expectedScore));\n      const newRating = Math.max(100, Math.min(3000, playerRating.rating + ratingChange));\n      \n      const isWin = result.position === 1;\n      const isLoss = result.position === totalPlayers;\n      const isDraw = !isWin && !isLoss && totalPlayers > 2;\n\n      const newWinStreak = isWin ? playerRating.winStreak + 1 : 0;\n      const newBestWinStreak = Math.max(playerRating.bestWinStreak, newWinStreak);\n      \n      const newTier = this.getTierForRating(newRating);\n      const newPeakRating = Math.max(playerRating.peakRating, newRating);\n      const newProvisionalGames = playerRating.provisionalGames + 1;\n      const isStillProvisional = newProvisionalGames < 10;\n\n      await storage.updateUserRating(result.userId, {\n        rating: newRating,\n        peakRating: newPeakRating,\n        tier: newTier,\n        totalRaces: playerRating.totalRaces + 1,\n        wins: playerRating.wins + (isWin ? 1 : 0),\n        losses: playerRating.losses + (isLoss ? 1 : 0),\n        draws: playerRating.draws + (isDraw ? 1 : 0),\n        winStreak: newWinStreak,\n        bestWinStreak: newBestWinStreak,\n        isProvisional: isStillProvisional,\n        provisionalGames: newProvisionalGames,\n        lastRaceAt: new Date(),\n      });\n\n      await storage.createRaceMatchHistory({\n        raceId,\n        participantId: result.participantId,\n        userId: result.userId,\n        finishPosition: result.position,\n        wpm: result.wpm,\n        accuracy: result.accuracy,\n        ratingBefore: playerRating.rating,\n        ratingAfter: newRating,\n        ratingChange: ratingChange,\n        opponentCount: totalPlayers - 1,\n        avgOpponentRating: Math.round(avgRating),\n      });\n\n      ratingChanges.push({\n        userId: result.userId,\n        oldRating: playerRating.rating,\n        newRating,\n        change: ratingChange,\n        tier: newTier,\n        isProvisional: isStillProvisional,\n      });\n    }\n\n    return ratingChanges;\n  }\n\n  async getMatchmakingPool(userId: string, tolerance: number = 200): Promise<UserRating[]> {\n    const userRating = await storage.getOrCreateUserRating(userId);\n    return storage.getUsersForMatchmaking(userRating.rating, tolerance, [userId]);\n  }\n\n  async applyRatingDecay(userId: string, daysInactive: number): Promise<number> {\n    if (daysInactive < 14) return 0;\n    \n    const rating = await storage.getUserRating(userId);\n    if (!rating) return 0;\n\n    const DECAY_PER_WEEK = 25;\n    const DECAY_CAP = 200;\n    const MIN_RATING = 1000;\n\n    const weeksInactive = Math.floor((daysInactive - 14) / 7);\n    const decayAmount = Math.min(weeksInactive * DECAY_PER_WEEK, DECAY_CAP);\n    \n    if (decayAmount > 0 && rating.rating > MIN_RATING) {\n      const newRating = Math.max(MIN_RATING, rating.rating - decayAmount);\n      const actualDecay = rating.rating - newRating;\n      \n      await storage.updateUserRating(userId, {\n        rating: newRating,\n        ratingDecay: rating.ratingDecay + actualDecay,\n        tier: this.getTierForRating(newRating),\n      });\n      \n      return actualDecay;\n    }\n\n    return 0;\n  }\n\n  getTierInfo(tier: string): { name: string; color: string; minRating: number } {\n    const tierColors: Record<string, string> = {\n      grandmaster: \"#ff4444\",\n      master: \"#ff8800\",\n      diamond: \"#00bfff\",\n      platinum: \"#00ff88\",\n      gold: \"#ffd700\",\n      silver: \"#c0c0c0\",\n      bronze: \"#cd7f32\",\n    };\n\n    return {\n      name: tier.charAt(0).toUpperCase() + tier.slice(1),\n      color: tierColors[tier] || \"#888888\",\n      minRating: TIER_THRESHOLDS[tier as keyof typeof TIER_THRESHOLDS] || 0,\n    };\n  }\n}\n\nexport const eloRatingService = new EloRatingService();\n","path":null,"size_bytes":7739,"size_tokens":null},"server/anticheat-service.ts":{"content":"import { storage } from \"./storage\";\nimport type { RaceKeystrokes, InsertRaceKeystrokes } from \"@shared/schema\";\n\ninterface Keystroke {\n  key: string;\n  expected: string;\n  timestamp: number;\n  correct: boolean;\n  position: number;\n  isTrusted?: boolean;\n}\n\ninterface ValidationResult {\n  isValid: boolean;\n  isFlagged: boolean;\n  flagReasons: string[];\n  serverCalculatedWpm: number;\n  requiresReview: boolean;\n  suspiciousPatterns: number;\n  metrics: {\n    avgInterval: number;\n    minInterval: number;\n    stdDevInterval: number;\n    clientReportedWpm: number;\n    wpmDiscrepancy: number;\n  };\n}\n\nconst THRESHOLDS = {\n  MIN_KEYSTROKE_INTERVAL_MS: 10,\n  SUSPECT_KEYSTROKE_INTERVAL_MS: 25,\n  MAX_WPM_WITHOUT_CERTIFICATION: 100,\n  WPM_DISCREPANCY_THRESHOLD: 15,\n  PERFECT_ACCURACY_WPM_THRESHOLD: 80,\n  MIN_KEYSTROKES_FOR_ANALYSIS: 20,\n  MAX_CONSISTENT_INTERVAL_VARIANCE: 5,\n  BURST_DETECTION_WINDOW: 10,\n  BURST_THRESHOLD_RATIO: 0.8,\n} as const;\n\nexport class AntiCheatService {\n  private calculateIntervals(keystrokes: Keystroke[]): number[] {\n    const intervals: number[] = [];\n    for (let i = 1; i < keystrokes.length; i++) {\n      intervals.push(keystrokes[i].timestamp - keystrokes[i - 1].timestamp);\n    }\n    return intervals;\n  }\n\n  private calculateStats(intervals: number[]): { avg: number; min: number; stdDev: number } {\n    if (intervals.length === 0) {\n      return { avg: 0, min: 0, stdDev: 0 };\n    }\n\n    const avg = intervals.reduce((a, b) => a + b, 0) / intervals.length;\n    const min = Math.min(...intervals);\n    const variance = intervals.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / intervals.length;\n    const stdDev = Math.sqrt(variance);\n\n    return { avg, min, stdDev };\n  }\n\n  private calculateServerWpm(keystrokes: Keystroke[]): number {\n    if (keystrokes.length < 2) return 0;\n\n    const totalTime = keystrokes[keystrokes.length - 1].timestamp - keystrokes[0].timestamp;\n    if (totalTime === 0) return 0;\n\n    const correctChars = keystrokes.filter(k => k.correct).length;\n    const minutes = totalTime / 60000;\n    const words = correctChars / 5;\n\n    return Math.round(words / minutes);\n  }\n\n  private detectBurstTyping(keystrokes: Keystroke[]): boolean {\n    if (keystrokes.length < THRESHOLDS.BURST_DETECTION_WINDOW * 2) return false;\n\n    const intervals = this.calculateIntervals(keystrokes);\n    const windowSize = THRESHOLDS.BURST_DETECTION_WINDOW;\n    \n    for (let i = 0; i <= intervals.length - windowSize; i++) {\n      const window = intervals.slice(i, i + windowSize);\n      const fastKeystrokes = window.filter(int => int < THRESHOLDS.SUSPECT_KEYSTROKE_INTERVAL_MS).length;\n      \n      if (fastKeystrokes / windowSize >= THRESHOLDS.BURST_THRESHOLD_RATIO) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  private detectProgrammaticPatterns(keystrokes: Keystroke[]): boolean {\n    const intervals = this.calculateIntervals(keystrokes);\n    if (intervals.length < 10) return false;\n\n    let consistentCount = 0;\n    for (let i = 1; i < intervals.length; i++) {\n      const diff = Math.abs(intervals[i] - intervals[i - 1]);\n      if (diff < THRESHOLDS.MAX_CONSISTENT_INTERVAL_VARIANCE) {\n        consistentCount++;\n      }\n    }\n\n    const consistencyRatio = consistentCount / intervals.length;\n    return consistencyRatio > 0.9;\n  }\n\n  private detectUntrustedEvents(keystrokes: Keystroke[]): boolean {\n    const untrustedCount = keystrokes.filter(k => k.isTrusted === false).length;\n    return untrustedCount > keystrokes.length * 0.1;\n  }\n\n  async validateKeystrokes(\n    raceId: number,\n    participantId: number,\n    keystrokes: Keystroke[],\n    clientReportedWpm: number,\n    userId?: string\n  ): Promise<ValidationResult> {\n    const flagReasons: string[] = [];\n    let suspiciousPatterns = 0;\n    let requiresReview = false;\n\n    if (keystrokes.length < THRESHOLDS.MIN_KEYSTROKES_FOR_ANALYSIS) {\n      return {\n        isValid: true,\n        isFlagged: false,\n        flagReasons: [],\n        serverCalculatedWpm: clientReportedWpm,\n        requiresReview: false,\n        suspiciousPatterns: 0,\n        metrics: {\n          avgInterval: 0,\n          minInterval: 0,\n          stdDevInterval: 0,\n          clientReportedWpm,\n          wpmDiscrepancy: 0,\n        },\n      };\n    }\n\n    const intervals = this.calculateIntervals(keystrokes);\n    const stats = this.calculateStats(intervals);\n    const serverWpm = this.calculateServerWpm(keystrokes);\n    const wpmDiscrepancy = Math.abs(serverWpm - clientReportedWpm);\n\n    if (stats.min < THRESHOLDS.MIN_KEYSTROKE_INTERVAL_MS) {\n      flagReasons.push(\"inhuman_speed\");\n      suspiciousPatterns++;\n      requiresReview = true;\n    }\n\n    if (wpmDiscrepancy > THRESHOLDS.WPM_DISCREPANCY_THRESHOLD) {\n      flagReasons.push(\"wpm_discrepancy\");\n      suspiciousPatterns++;\n      requiresReview = true;\n    }\n\n    if (this.detectBurstTyping(keystrokes)) {\n      flagReasons.push(\"burst_typing\");\n      suspiciousPatterns++;\n    }\n\n    if (this.detectProgrammaticPatterns(keystrokes)) {\n      flagReasons.push(\"programmatic_pattern\");\n      suspiciousPatterns++;\n      requiresReview = true;\n    }\n\n    if (this.detectUntrustedEvents(keystrokes)) {\n      flagReasons.push(\"untrusted_events\");\n      suspiciousPatterns++;\n      requiresReview = true;\n    }\n\n    const correctCount = keystrokes.filter(k => k.correct).length;\n    const accuracy = (correctCount / keystrokes.length) * 100;\n    if (accuracy === 100 && serverWpm > THRESHOLDS.PERFECT_ACCURACY_WPM_THRESHOLD) {\n      flagReasons.push(\"perfect_accuracy_high_wpm\");\n      suspiciousPatterns++;\n    }\n\n    if (serverWpm > THRESHOLDS.MAX_WPM_WITHOUT_CERTIFICATION && userId) {\n      const certification = await storage.getUserCertification(userId);\n      if (!certification || (certification.certifiedWpm && serverWpm > certification.certifiedWpm * 1.25)) {\n        flagReasons.push(\"requires_certification\");\n        requiresReview = true;\n      }\n    }\n\n    const isFlagged = flagReasons.length > 0;\n    const isValid = suspiciousPatterns < 3 && !flagReasons.includes(\"inhuman_speed\");\n\n    const keystrokeData: InsertRaceKeystrokes = {\n      raceId,\n      participantId,\n      keystrokes: keystrokes as any,\n      avgInterval: stats.avg,\n      minInterval: stats.min,\n      stdDevInterval: stats.stdDev,\n      suspiciousPatterns,\n      serverCalculatedWpm: serverWpm,\n      clientReportedWpm,\n      wpmDiscrepancy,\n      isFlagged,\n      flagReasons: flagReasons.length > 0 ? flagReasons : null,\n      requiresReview,\n    };\n\n    try {\n      await storage.saveRaceKeystrokes(keystrokeData);\n    } catch (error) {\n      console.error(\"[AntiCheat] Failed to save keystroke data:\", error);\n    }\n\n    return {\n      isValid,\n      isFlagged,\n      flagReasons,\n      serverCalculatedWpm: serverWpm,\n      requiresReview,\n      suspiciousPatterns,\n      metrics: {\n        avgInterval: stats.avg,\n        minInterval: stats.min,\n        stdDevInterval: stats.stdDev,\n        clientReportedWpm,\n        wpmDiscrepancy,\n      },\n    };\n  }\n\n  async triggerVerificationChallenge(userId: string, triggeredWpm: number): Promise<string> {\n    const challengeTexts = [\n      \"The quick brown fox jumps over the lazy dog near the river bank.\",\n      \"Pack my box with five dozen liquor jugs and bring them to the store.\",\n      \"How vexingly quick daft zebras jump across the open field today.\",\n      \"The five boxing wizards jump quickly through the morning fog now.\",\n    ];\n\n    const challengeText = challengeTexts[Math.floor(Math.random() * challengeTexts.length)];\n\n    await storage.createAntiCheatChallenge({\n      userId,\n      challengeText,\n      challengeType: \"typing\",\n      triggered: true,\n      triggeredWpm,\n    });\n\n    return challengeText;\n  }\n\n  async verifyChallenge(\n    challengeId: number,\n    keystrokes: Keystroke[],\n    clientWpm: number\n  ): Promise<{ passed: boolean; reason?: string }> {\n    if (keystrokes.length < 10) {\n      return { passed: false, reason: \"Not enough keystrokes recorded\" };\n    }\n\n    const intervals = this.calculateIntervals(keystrokes);\n    const stats = this.calculateStats(intervals);\n    const serverWpm = this.calculateServerWpm(keystrokes);\n\n    if (stats.min < THRESHOLDS.MIN_KEYSTROKE_INTERVAL_MS) {\n      return { passed: false, reason: \"Inhuman typing speed detected\" };\n    }\n\n    if (this.detectProgrammaticPatterns(keystrokes)) {\n      return { passed: false, reason: \"Suspicious typing pattern detected\" };\n    }\n\n    const wpmDiscrepancy = Math.abs(serverWpm - clientWpm);\n    if (wpmDiscrepancy > THRESHOLDS.WPM_DISCREPANCY_THRESHOLD * 2) {\n      return { passed: false, reason: \"WPM mismatch detected\" };\n    }\n\n    const certifiedWpm = Math.round(serverWpm * 1.25);\n    await storage.updateChallengePassed(challengeId, true, serverWpm, certifiedWpm);\n\n    return { passed: true };\n  }\n\n  generateChallengeText(): string {\n    const phrases = [\n      \"The quick brown fox jumps over the lazy dog near the river bank.\",\n      \"Pack my box with five dozen liquor jugs and bring them to the store.\",\n      \"How vexingly quick daft zebras jump across the open field today.\",\n      \"The five boxing wizards jump quickly through the morning fog now.\",\n      \"Sphinx of black quartz judge my vow while sitting by the campfire.\",\n      \"Two driven jocks help fax my big quiz about swimming techniques.\",\n      \"The job requires extra pluck and zeal from every young wage earner.\",\n      \"Crazy Frederick bought many very exquisite opal jewels for the auction.\",\n    ];\n    return phrases[Math.floor(Math.random() * phrases.length)];\n  }\n}\n\nexport const antiCheatService = new AntiCheatService();\n","path":null,"size_bytes":9631,"size_tokens":null},"server/leaderboard-cache.ts":{"content":"import { storage } from \"./storage\";\nimport crypto from \"node:crypto\";\n\nexport type LeaderboardType = \"global\" | \"code\" | \"stress\" | \"dictation\" | \"rating\";\nexport type TimeFrame = \"all\" | \"daily\" | \"weekly\" | \"monthly\";\n\ninterface CacheEntry<T> {\n  data: T;\n  timestamp: number;\n  lastAccessed: number;\n  hits: number;\n  etag: string;\n}\n\ninterface LeaderboardEntry {\n  userId: string;\n  username: string;\n  wpm: number;\n  accuracy: number;\n  avatarColor: string | null;\n  rank: number;\n  isVerified?: boolean;\n  verifiedAt?: Date;\n}\n\ninterface PaginatedResponse<T> {\n  entries: T[];\n  pagination: {\n    total: number;\n    limit: number;\n    offset: number;\n    hasMore: boolean;\n    nextCursor?: string;\n    prevCursor?: string;\n  };\n  metadata: {\n    cacheHit: boolean;\n    timeframe: TimeFrame;\n    lastUpdated: number;\n    etag?: string;\n  };\n}\n\nconst CACHE_TTL_MS = {\n  global: 30000,\n  code: 30000,\n  stress: 5000,\n  dictation: 30000,\n  rating: 15000,\n  aroundMe: 10000,\n  timeBased: 60000,\n};\n\nconst MAX_CACHE_SIZE = 100;\nconst MAX_MEMORY_MB = 50;\n\nfunction generateEtag(data: any): string {\n  const hash = crypto.createHash('md5');\n  hash.update(JSON.stringify(data));\n  return `\"${hash.digest('hex').substring(0, 16)}\"`;\n}\n\nfunction estimateMemorySize(obj: any): number {\n  const str = JSON.stringify(obj);\n  return Buffer.byteLength(str, 'utf8');\n}\n\nclass LeaderboardCache {\n  private cache = new Map<string, CacheEntry<any>>();\n  private stats = {\n    hits: 0,\n    misses: 0,\n    evictions: 0,\n    memoryUsedBytes: 0,\n  };\n\n  private getCacheKey(\n    type: LeaderboardType,\n    options: {\n      timeframe?: TimeFrame;\n      difficulty?: string;\n      language?: string;\n      tier?: string;\n      limit?: number;\n      offset?: number;\n      userId?: string;\n    }\n  ): string {\n    const parts: string[] = [type];\n    if (options.timeframe) parts.push(`tf:${options.timeframe}`);\n    if (options.difficulty) parts.push(`diff:${options.difficulty}`);\n    if (options.language) parts.push(`lang:${options.language}`);\n    if (options.tier) parts.push(`tier:${options.tier}`);\n    if (options.limit) parts.push(`lim:${options.limit}`);\n    if (options.offset) parts.push(`off:${options.offset}`);\n    if (options.userId) parts.push(`uid:${options.userId}`);\n    return parts.join(\":\");\n  }\n\n  private getTTL(type: LeaderboardType): number {\n    return CACHE_TTL_MS[type] || 30000;\n  }\n\n  private isExpired(entry: CacheEntry<any>, ttl: number): boolean {\n    return Date.now() - entry.timestamp > ttl;\n  }\n\n  private evictLRU(): void {\n    if (this.cache.size < MAX_CACHE_SIZE) return;\n\n    let lruKey: string | null = null;\n    let lruTime = Infinity;\n\n    const entries = Array.from(this.cache.entries());\n    for (const [key, entry] of entries) {\n      if (entry.lastAccessed < lruTime) {\n        lruTime = entry.lastAccessed;\n        lruKey = key;\n      }\n    }\n\n    if (lruKey) {\n      this.cache.delete(lruKey);\n      this.stats.evictions++;\n    }\n  }\n\n  get<T>(key: string, ttl: number): { data: T; etag: string } | null {\n    const entry = this.cache.get(key);\n    if (!entry) {\n      this.stats.misses++;\n      return null;\n    }\n\n    if (this.isExpired(entry, ttl)) {\n      this.stats.memoryUsedBytes -= estimateMemorySize(entry.data);\n      this.cache.delete(key);\n      this.stats.misses++;\n      return null;\n    }\n\n    entry.lastAccessed = Date.now();\n    entry.hits++;\n    this.stats.hits++;\n    return { data: entry.data as T, etag: entry.etag };\n  }\n\n  getEtag(key: string, ttl: number): string | null {\n    const entry = this.cache.get(key);\n    if (!entry || this.isExpired(entry, ttl)) {\n      return null;\n    }\n    return entry.etag;\n  }\n\n  set<T>(key: string, data: T): string {\n    this.evictLRU();\n    const now = Date.now();\n    const etag = generateEtag(data);\n    const memSize = estimateMemorySize(data);\n    \n    const existingEntry = this.cache.get(key);\n    if (existingEntry) {\n      this.stats.memoryUsedBytes -= estimateMemorySize(existingEntry.data);\n    }\n    \n    this.cache.set(key, {\n      data,\n      timestamp: now,\n      lastAccessed: now,\n      hits: 0,\n      etag,\n    });\n    \n    this.stats.memoryUsedBytes += memSize;\n    this.evictIfMemoryExceeded();\n    return etag;\n  }\n\n  private evictIfMemoryExceeded(): void {\n    const maxBytes = MAX_MEMORY_MB * 1024 * 1024;\n    while (this.stats.memoryUsedBytes > maxBytes && this.cache.size > 0) {\n      let lruKey: string | null = null;\n      let lruTime = Infinity;\n\n      for (const [key, entry] of this.cache.entries()) {\n        if (entry.lastAccessed < lruTime) {\n          lruTime = entry.lastAccessed;\n          lruKey = key;\n        }\n      }\n\n      if (lruKey) {\n        const entry = this.cache.get(lruKey);\n        if (entry) {\n          this.stats.memoryUsedBytes -= estimateMemorySize(entry.data);\n        }\n        this.cache.delete(lruKey);\n        this.stats.evictions++;\n      } else {\n        break;\n      }\n    }\n  }\n\n  invalidate(pattern?: string): void {\n    if (!pattern) {\n      this.cache.clear();\n      return;\n    }\n\n    const keys = Array.from(this.cache.keys());\n    for (const key of keys) {\n      if (key.includes(pattern)) {\n        this.cache.delete(key);\n      }\n    }\n  }\n\n  getStats() {\n    const hitRate = this.stats.hits + this.stats.misses > 0\n      ? this.stats.hits / (this.stats.hits + this.stats.misses)\n      : 0;\n    return {\n      ...this.stats,\n      hitRate: Math.round(hitRate * 100) / 100,\n      size: this.cache.size,\n    };\n  }\n\n  async getGlobalLeaderboard(options: {\n    timeframe?: TimeFrame;\n    limit?: number;\n    offset?: number;\n    language?: string;\n  }): Promise<PaginatedResponse<any>> {\n    const { timeframe = \"all\", limit = 20, offset = 0, language = \"en\" } = options;\n    const cacheKey = this.getCacheKey(\"global\", { timeframe, limit, offset, language });\n    \n    const cached = this.get<PaginatedResponse<any>>(cacheKey, CACHE_TTL_MS.global);\n    if (cached) {\n      return { ...cached.data, metadata: { ...cached.data.metadata, cacheHit: true, etag: cached.etag } };\n    }\n\n    const entries = await storage.getLeaderboardPaginated(limit, offset, timeframe, language);\n    const total = await storage.getLeaderboardCount(timeframe, language);\n\n    const response: PaginatedResponse<any> = {\n      entries,\n      pagination: {\n        total,\n        limit,\n        offset,\n        hasMore: offset + entries.length < total,\n        nextCursor: offset + limit < total ? this.encodeCursor(offset + limit) : undefined,\n        prevCursor: offset > 0 ? this.encodeCursor(Math.max(0, offset - limit)) : undefined,\n      },\n      metadata: {\n        cacheHit: false,\n        timeframe,\n        lastUpdated: Date.now(),\n      },\n    };\n\n    const etag = this.set(cacheKey, response);\n    return { ...response, metadata: { ...response.metadata, etag } };\n  }\n\n  async getStressLeaderboard(options: {\n    difficulty?: string;\n    limit?: number;\n    offset?: number;\n  }): Promise<PaginatedResponse<any>> {\n    const { difficulty, limit = 50, offset = 0 } = options;\n    const cacheKey = this.getCacheKey(\"stress\", { difficulty, limit, offset });\n    \n    const cached = this.get<PaginatedResponse<any>>(cacheKey, CACHE_TTL_MS.stress);\n    if (cached) {\n      return { ...cached.data, metadata: { ...cached.data.metadata, cacheHit: true, etag: cached.etag } };\n    }\n\n    const entries = await storage.getStressTestLeaderboardPaginated(difficulty, limit, offset);\n    const total = await storage.getStressTestLeaderboardCount(difficulty);\n\n    const response: PaginatedResponse<any> = {\n      entries,\n      pagination: {\n        total,\n        limit,\n        offset,\n        hasMore: offset + entries.length < total,\n        nextCursor: offset + limit < total ? this.encodeCursor(offset + limit) : undefined,\n        prevCursor: offset > 0 ? this.encodeCursor(Math.max(0, offset - limit)) : undefined,\n      },\n      metadata: {\n        cacheHit: false,\n        timeframe: \"all\",\n        lastUpdated: Date.now(),\n      },\n    };\n\n    const etag = this.set(cacheKey, response);\n    return { ...response, metadata: { ...response.metadata, etag } };\n  }\n\n  async getCodeLeaderboard(options: {\n    language?: string;\n    limit?: number;\n    offset?: number;\n  }): Promise<PaginatedResponse<any>> {\n    const { language, limit = 20, offset = 0 } = options;\n    const cacheKey = this.getCacheKey(\"code\", { language, limit, offset });\n    \n    const cached = this.get<PaginatedResponse<any>>(cacheKey, CACHE_TTL_MS.code);\n    if (cached) {\n      return { ...cached.data, metadata: { ...cached.data.metadata, cacheHit: true, etag: cached.etag } };\n    }\n\n    const entries = await storage.getCodeLeaderboardPaginated(language, limit, offset);\n    const total = await storage.getCodeLeaderboardCount(language);\n\n    const response: PaginatedResponse<any> = {\n      entries,\n      pagination: {\n        total,\n        limit,\n        offset,\n        hasMore: offset + entries.length < total,\n        nextCursor: offset + limit < total ? this.encodeCursor(offset + limit) : undefined,\n        prevCursor: offset > 0 ? this.encodeCursor(Math.max(0, offset - limit)) : undefined,\n      },\n      metadata: {\n        cacheHit: false,\n        timeframe: \"all\",\n        lastUpdated: Date.now(),\n      },\n    };\n\n    const etag = this.set(cacheKey, response);\n    return { ...response, metadata: { ...response.metadata, etag } };\n  }\n\n  async getRatingLeaderboard(options: {\n    tier?: string;\n    limit?: number;\n    offset?: number;\n  }): Promise<PaginatedResponse<any>> {\n    const { tier, limit = 50, offset = 0 } = options;\n    const cacheKey = this.getCacheKey(\"rating\", { tier, limit, offset });\n    \n    const cached = this.get<PaginatedResponse<any>>(cacheKey, CACHE_TTL_MS.rating);\n    if (cached) {\n      return { ...cached.data, metadata: { ...cached.data.metadata, cacheHit: true, etag: cached.etag } };\n    }\n\n    const entries = await storage.getRatingLeaderboardPaginated(tier, limit, offset);\n    const total = await storage.getRatingLeaderboardCount(tier);\n\n    const response: PaginatedResponse<any> = {\n      entries,\n      pagination: {\n        total,\n        limit,\n        offset,\n        hasMore: offset + entries.length < total,\n        nextCursor: offset + limit < total ? this.encodeCursor(offset + limit) : undefined,\n        prevCursor: offset > 0 ? this.encodeCursor(Math.max(0, offset - limit)) : undefined,\n      },\n      metadata: {\n        cacheHit: false,\n        timeframe: \"all\",\n        lastUpdated: Date.now(),\n      },\n    };\n\n    const etag = this.set(cacheKey, response);\n    return { ...response, metadata: { ...response.metadata, etag } };\n  }\n\n  async getDictationLeaderboard(options: {\n    limit?: number;\n    offset?: number;\n  }): Promise<PaginatedResponse<any>> {\n    const { limit = 20, offset = 0 } = options;\n    const cacheKey = this.getCacheKey(\"dictation\", { limit, offset });\n    \n    const cached = this.get<PaginatedResponse<any>>(cacheKey, CACHE_TTL_MS.dictation);\n    if (cached) {\n      return { ...cached.data, metadata: { ...cached.data.metadata, cacheHit: true, etag: cached.etag } };\n    }\n\n    const entries = await storage.getDictationLeaderboardPaginated(limit, offset);\n    const total = await storage.getDictationLeaderboardCount();\n\n    const response: PaginatedResponse<any> = {\n      entries,\n      pagination: {\n        total,\n        limit,\n        offset,\n        hasMore: offset + entries.length < total,\n        nextCursor: offset + limit < total ? this.encodeCursor(offset + limit) : undefined,\n        prevCursor: offset > 0 ? this.encodeCursor(Math.max(0, offset - limit)) : undefined,\n      },\n      metadata: {\n        cacheHit: false,\n        timeframe: \"all\",\n        lastUpdated: Date.now(),\n      },\n    };\n\n    const etag = this.set(cacheKey, response);\n    return { ...response, metadata: { ...response.metadata, etag } };\n  }\n\n  async getAroundMe(\n    type: LeaderboardType,\n    userId: string,\n    options: {\n      difficulty?: string;\n      language?: string;\n      tier?: string;\n      range?: number;\n      timeframe?: TimeFrame;\n    } = {}\n  ): Promise<{ userRank: number; entries: any[]; cacheHit: boolean }> {\n    const { range = 5, timeframe } = options;\n    const cacheKey = this.getCacheKey(type, { ...options, userId, timeframe });\n    \n    const cached = this.get<{ userRank: number; entries: any[] }>(cacheKey, CACHE_TTL_MS.aroundMe);\n    if (cached) {\n      return { ...cached.data, cacheHit: true };\n    }\n\n    let result: { userRank: number; entries: any[] };\n\n    switch (type) {\n      case \"global\":\n        result = await storage.getLeaderboardAroundUser(userId, range, timeframe, options.language || \"en\");\n        break;\n      case \"stress\":\n        result = await storage.getStressLeaderboardAroundUser(userId, options.difficulty, range);\n        break;\n      case \"code\":\n        result = await storage.getCodeLeaderboardAroundUser(userId, options.language, range);\n        break;\n      case \"rating\":\n        result = await storage.getRatingLeaderboardAroundUser(userId, options.tier, range);\n        break;\n      case \"dictation\":\n        result = await storage.getDictationLeaderboardAroundUser(userId, range);\n        break;\n      default:\n        result = { userRank: -1, entries: [] };\n    }\n\n    this.set(cacheKey, result);\n    return { ...result, cacheHit: false };\n  }\n\n  private encodeCursor(offset: number): string {\n    return Buffer.from(`offset:${offset}`).toString(\"base64\");\n  }\n\n  decodeCursor(cursor: string): number {\n    try {\n      const decoded = Buffer.from(cursor, \"base64\").toString(\"utf-8\");\n      const match = decoded.match(/^offset:(\\d+)$/);\n      return match ? parseInt(match[1], 10) : 0;\n    } catch {\n      return 0;\n    }\n  }\n}\n\nexport const leaderboardCache = new LeaderboardCache();\n\nexport function getTimeframeDateRange(timeframe: TimeFrame): { start: Date; end: Date } {\n  const now = new Date();\n  const end = new Date(now);\n  let start: Date;\n\n  switch (timeframe) {\n    case \"daily\":\n      start = new Date(now);\n      start.setHours(0, 0, 0, 0);\n      break;\n    case \"weekly\":\n      start = new Date(now);\n      start.setDate(now.getDate() - now.getDay());\n      start.setHours(0, 0, 0, 0);\n      break;\n    case \"monthly\":\n      start = new Date(now.getFullYear(), now.getMonth(), 1);\n      break;\n    case \"all\":\n    default:\n      start = new Date(0);\n      break;\n  }\n\n  return { start, end };\n}\n","path":null,"size_bytes":14399,"size_tokens":null},"client/src/hooks/useAchievementUnlocks.ts":{"content":"import { useEffect, useRef } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { useAchievementCelebration, type UnlockedAchievement } from \"@/components/achievement-celebration\";\n\ninterface UserAchievementData {\n  id: number;\n  unlockedAt: string;\n  achievement: {\n    id: number;\n    key: string;\n    name: string;\n    description: string;\n    category: string;\n    tier: string;\n    points: number;\n    icon: string;\n    color: string;\n  };\n}\n\nconst tierIcons: Record<string, string> = {\n  bronze: \"ðŸ¥‰\",\n  silver: \"ðŸ¥ˆ\",\n  gold: \"ðŸ¥‡\",\n  platinum: \"ðŸ’Ž\",\n  diamond: \"ðŸ‘‘\",\n};\n\nexport function useAchievementUnlocks() {\n  const { user } = useAuth();\n  const { celebrate } = useAchievementCelebration();\n  const previousAchievementIds = useRef<Set<number>>(new Set());\n  const initialized = useRef(false);\n\n  const { data: achievements } = useQuery<{ achievements: UserAchievementData[] }>({\n    queryKey: [\"user-achievements\"],\n    queryFn: async () => {\n      const response = await fetch(\"/api/achievements\", {\n        credentials: \"include\",\n      });\n      if (!response.ok) throw new Error(\"Failed to fetch achievements\");\n      return response.json();\n    },\n    enabled: !!user,\n    refetchInterval: 30000,\n    staleTime: 10000,\n  });\n\n  useEffect(() => {\n    if (!achievements?.achievements || !user) return;\n\n    const currentIds = new Set(achievements.achievements.map((a) => a.id));\n\n    if (!initialized.current) {\n      previousAchievementIds.current = currentIds;\n      initialized.current = true;\n      return;\n    }\n\n    const newAchievements = achievements.achievements.filter(\n      (a) => !previousAchievementIds.current.has(a.id)\n    );\n\n    if (newAchievements.length > 0) {\n      const formattedAchievements: UnlockedAchievement[] = newAchievements.map((a) => ({\n        id: a.achievement.key,\n        name: a.achievement.name,\n        description: a.achievement.description,\n        icon: tierIcons[a.achievement.tier] || a.achievement.icon,\n        tier: a.achievement.tier as UnlockedAchievement[\"tier\"],\n        points: a.achievement.points,\n        category: a.achievement.category,\n      }));\n\n      formattedAchievements.forEach((achievement) => celebrate(achievement));\n    }\n\n    previousAchievementIds.current = currentIds;\n  }, [achievements, user, celebrate]);\n\n  return {\n    achievements: achievements?.achievements || [],\n    totalAchievements: achievements?.achievements.length || 0,\n  };\n}\n\nexport function useCheckNewAchievements() {\n  const { user } = useAuth();\n  const { celebrateMultiple } = useAchievementCelebration();\n\n  const checkForNewAchievements = async (): Promise<number> => {\n    if (!user) return 0;\n\n    try {\n      const response = await fetch(\"/api/achievements/check-new\", {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n\n      if (!response.ok) return 0;\n\n      const data = await response.json();\n      \n      if (data.newAchievements && data.newAchievements.length > 0) {\n        const formattedAchievements: UnlockedAchievement[] = data.newAchievements.map((a: any) => ({\n          id: a.key,\n          name: a.name,\n          description: a.description,\n          icon: tierIcons[a.tier] || a.icon,\n          tier: a.tier as UnlockedAchievement[\"tier\"],\n          points: a.points,\n          category: a.category,\n        }));\n\n        celebrateMultiple(formattedAchievements);\n        return formattedAchievements.length;\n      }\n\n      return 0;\n    } catch (error) {\n      console.error(\"Failed to check for new achievements:\", error);\n      return 0;\n    }\n  };\n\n  return { checkForNewAchievements };\n}\n","path":null,"size_bytes":3667,"size_tokens":null},"client/src/components/achievement-celebration.tsx":{"content":"import { useState, useEffect, createContext, useContext, useCallback } from \"react\";\nimport { motion, AnimatePresence } from \"framer-motion\";\nimport confetti from \"canvas-confetti\";\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { cn } from \"@/lib/utils\";\nimport { Trophy, Star, Sparkles, Share2, X, Zap, Target, Flame, TrendingUp, Award, Moon, Sunrise, Rocket, Timer, Image } from \"lucide-react\";\nimport { BadgeShareCard } from \"@/components/badge-share-card\";\nimport { BADGES } from \"@shared/badges\";\nimport { useAuth } from \"@/lib/auth-context\";\n\nconst iconMap: Record<string, React.ComponentType<{ className?: string }>> = {\n  Zap,\n  Target,\n  Flame,\n  TrendingUp,\n  Star,\n  Award,\n  Share2,\n  Trophy,\n  Moon,\n  Sunrise,\n  Rocket,\n  Sparkles,\n  Timer,\n};\n\nexport interface UnlockedAchievement {\n  id: string;\n  name: string;\n  description: string;\n  icon: string;\n  tier: \"bronze\" | \"silver\" | \"gold\" | \"platinum\" | \"diamond\";\n  points: number;\n  category: string;\n}\n\ninterface AchievementCelebrationContextType {\n  celebrate: (achievement: UnlockedAchievement) => void;\n  celebrateMultiple: (achievements: UnlockedAchievement[]) => void;\n}\n\nconst AchievementCelebrationContext = createContext<AchievementCelebrationContextType | null>(null);\n\nexport function useAchievementCelebration() {\n  const context = useContext(AchievementCelebrationContext);\n  if (!context) {\n    throw new Error(\"useAchievementCelebration must be used within AchievementCelebrationProvider\");\n  }\n  return context;\n}\n\nconst tierColors = {\n  bronze: { bg: \"from-orange-600 to-orange-800\", border: \"border-orange-500\", text: \"text-orange-400\" },\n  silver: { bg: \"from-slate-400 to-slate-600\", border: \"border-slate-400\", text: \"text-slate-300\" },\n  gold: { bg: \"from-yellow-500 to-amber-600\", border: \"border-yellow-400\", text: \"text-yellow-400\" },\n  platinum: { bg: \"from-cyan-400 to-blue-600\", border: \"border-cyan-400\", text: \"text-cyan-400\" },\n  diamond: { bg: \"from-purple-400 to-pink-600\", border: \"border-purple-400\", text: \"text-purple-400\" },\n};\n\nconst tierEmojis = {\n  bronze: \"ðŸ¥‰\",\n  silver: \"ðŸ¥ˆ\",\n  gold: \"ðŸ¥‡\",\n  platinum: \"ðŸ’Ž\",\n  diamond: \"ðŸ‘‘\",\n};\n\nlet sharedAudioContext: AudioContext | null = null;\nlet audioContextResumed = false;\n\nfunction getAudioContext(): AudioContext | null {\n  try {\n    if (!sharedAudioContext) {\n      sharedAudioContext = new (window.AudioContext || (window as any).webkitAudioContext)();\n    }\n    return sharedAudioContext;\n  } catch {\n    return null;\n  }\n}\n\nexport function preWarmAudioContext() {\n  const ctx = getAudioContext();\n  if (ctx && ctx.state === \"suspended\" && !audioContextResumed) {\n    ctx.resume().then(() => {\n      audioContextResumed = true;\n    }).catch(() => {});\n  }\n}\n\nasync function playAchievementSound(tier: string) {\n  try {\n    const audioContext = getAudioContext();\n    if (!audioContext) return;\n    \n    if (audioContext.state === \"suspended\") {\n      await audioContext.resume();\n    }\n    \n    const tierFrequencies: Record<string, number[]> = {\n      bronze: [523.25, 659.25, 783.99],\n      silver: [587.33, 739.99, 880.00],\n      gold: [659.25, 830.61, 987.77],\n      platinum: [739.99, 932.33, 1108.73],\n      diamond: [783.99, 987.77, 1174.66, 1318.51],\n    };\n    \n    const frequencies = tierFrequencies[tier] || tierFrequencies.bronze;\n    \n    frequencies.forEach((freq, index) => {\n      const oscillator = audioContext.createOscillator();\n      const gainNode = audioContext.createGain();\n      \n      oscillator.connect(gainNode);\n      gainNode.connect(audioContext.destination);\n      \n      oscillator.frequency.value = freq;\n      oscillator.type = \"sine\";\n      \n      const startTime = audioContext.currentTime + index * 0.15;\n      const duration = 0.3;\n      \n      gainNode.gain.setValueAtTime(0, startTime);\n      gainNode.gain.linearRampToValueAtTime(0.15, startTime + 0.05);\n      gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);\n      \n      oscillator.start(startTime);\n      oscillator.stop(startTime + duration);\n    });\n  } catch (error) {\n    console.warn(\"Could not play achievement sound:\", error);\n  }\n}\n\nfunction triggerAchievementConfetti(tier: string) {\n  const prefersReducedMotion = window.matchMedia(\"(prefers-reduced-motion: reduce)\").matches;\n  if (prefersReducedMotion) return;\n\n  const tierConfigs = {\n    bronze: { particleCount: 50, spread: 60, colors: [\"#CD7F32\", \"#B87333\", \"#A0522D\"] },\n    silver: { particleCount: 80, spread: 70, colors: [\"#C0C0C0\", \"#A9A9A9\", \"#D3D3D3\"] },\n    gold: { particleCount: 100, spread: 80, colors: [\"#FFD700\", \"#FFA500\", \"#DAA520\"] },\n    platinum: { particleCount: 120, spread: 90, colors: [\"#00CED1\", \"#40E0D0\", \"#00FFFF\"] },\n    diamond: { particleCount: 150, spread: 100, colors: [\"#9B59B6\", \"#E91E63\", \"#FF69B4\", \"#FFD700\"] },\n  };\n\n  const config = tierConfigs[tier as keyof typeof tierConfigs] || tierConfigs.bronze;\n\n  confetti({\n    particleCount: config.particleCount,\n    spread: config.spread,\n    origin: { y: 0.4 },\n    colors: config.colors,\n    zIndex: 10000,\n  });\n\n  if (tier === \"diamond\" || tier === \"platinum\") {\n    setTimeout(() => {\n      confetti({\n        particleCount: 30,\n        angle: 60,\n        spread: 55,\n        origin: { x: 0 },\n        colors: config.colors,\n        zIndex: 10000,\n      });\n      confetti({\n        particleCount: 30,\n        angle: 120,\n        spread: 55,\n        origin: { x: 1 },\n        colors: config.colors,\n        zIndex: 10000,\n      });\n    }, 300);\n  }\n}\n\ninterface AchievementCelebrationModalProps {\n  achievement: UnlockedAchievement | null;\n  isOpen: boolean;\n  onClose: () => void;\n  queueLength: number;\n}\n\nfunction AchievementCelebrationModal({ achievement, isOpen, onClose, queueLength }: AchievementCelebrationModalProps) {\n  const { user } = useAuth();\n  const [showShareCard, setShowShareCard] = useState(false);\n\n  useEffect(() => {\n    if (isOpen && achievement) {\n      triggerAchievementConfetti(achievement.tier);\n      playAchievementSound(achievement.tier);\n    }\n  }, [isOpen, achievement]);\n\n  const handleShareTracked = async (platform: string) => {\n    try {\n      await fetch(\"/api/share/track\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ platform, type: \"badge\", badgeId: achievement?.id }),\n      });\n    } catch (error) {\n      console.error(\"Failed to track share:\", error);\n    }\n  };\n\n  const badgeData = achievement ? BADGES.find(b => b.id === achievement.id) : null;\n\n  if (!achievement) return null;\n\n  const colors = tierColors[achievement.tier] || tierColors.bronze;\n  const tierEmoji = tierEmojis[achievement.tier] || \"ðŸ†\";\n  const IconComponent = iconMap[achievement.icon] || Trophy;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>\n      <DialogContent className=\"sm:max-w-md border-2 border-primary/50 bg-background/95 backdrop-blur-xl p-0 overflow-hidden\">\n        <motion.div\n          initial={{ opacity: 0, scale: 0.8 }}\n          animate={{ opacity: 1, scale: 1 }}\n          exit={{ opacity: 0, scale: 0.8 }}\n          transition={{ type: \"spring\", duration: 0.5 }}\n          className=\"relative\"\n        >\n          <div className={cn(\"absolute inset-0 bg-gradient-to-br opacity-20\", colors.bg)} />\n          \n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            className=\"absolute right-2 top-2 z-10\"\n            onClick={onClose}\n            data-testid=\"button-close-celebration\"\n          >\n            <X className=\"h-4 w-4\" />\n          </Button>\n\n          <div className=\"relative p-8 text-center\">\n            <motion.div\n              initial={{ y: -20, opacity: 0 }}\n              animate={{ y: 0, opacity: 1 }}\n              transition={{ delay: 0.1 }}\n              className=\"flex items-center justify-center gap-2 mb-4\"\n            >\n              <Sparkles className=\"w-5 h-5 text-yellow-400 animate-pulse\" />\n              <span className=\"text-sm font-semibold text-muted-foreground uppercase tracking-wider\">\n                Achievement Unlocked!\n              </span>\n              <Sparkles className=\"w-5 h-5 text-yellow-400 animate-pulse\" />\n            </motion.div>\n\n            <motion.div\n              initial={{ scale: 0 }}\n              animate={{ scale: 1 }}\n              transition={{ type: \"spring\", delay: 0.2, duration: 0.6 }}\n              className={cn(\n                \"w-28 h-28 mx-auto rounded-full flex items-center justify-center mb-6\",\n                \"bg-gradient-to-br shadow-2xl ring-4 ring-offset-2 ring-offset-background\",\n                colors.bg,\n                colors.border\n              )}\n            >\n              <motion.div\n                animate={{ \n                  rotate: [0, -10, 10, -10, 0],\n                  scale: [1, 1.1, 1]\n                }}\n                transition={{ duration: 0.5, delay: 0.5 }}\n              >\n                <IconComponent className=\"w-14 h-14 text-white drop-shadow-lg\" />\n              </motion.div>\n            </motion.div>\n\n            <motion.div\n              initial={{ y: 20, opacity: 0 }}\n              animate={{ y: 0, opacity: 1 }}\n              transition={{ delay: 0.3 }}\n              className=\"space-y-3\"\n            >\n              <h2 className=\"text-2xl font-bold\">{achievement.name}</h2>\n              <p className=\"text-muted-foreground\">{achievement.description}</p>\n              \n              <div className=\"flex items-center justify-center gap-3 pt-2\">\n                <Badge variant=\"outline\" className={cn(\"uppercase font-bold\", colors.text, colors.border)}>\n                  {tierEmoji} {achievement.tier}\n                </Badge>\n                <Badge variant=\"secondary\" className=\"bg-primary/20 text-primary\">\n                  <Star className=\"w-3 h-3 mr-1\" />\n                  +{achievement.points} XP\n                </Badge>\n              </div>\n            </motion.div>\n\n            <motion.div\n              initial={{ y: 20, opacity: 0 }}\n              animate={{ y: 0, opacity: 1 }}\n              transition={{ delay: 0.4 }}\n              className=\"flex flex-col gap-3 mt-8\"\n            >\n              <Button\n                onClick={onClose}\n                className={cn(\"w-full bg-gradient-to-r\", colors.bg)}\n                size=\"lg\"\n                data-testid=\"button-continue\"\n              >\n                <Trophy className=\"w-4 h-4 mr-2\" />\n                {queueLength > 0 ? `Continue (${queueLength} more)` : \"Awesome!\"}\n              </Button>\n              \n              <Button\n                variant=\"outline\"\n                onClick={() => setShowShareCard(true)}\n                className=\"w-full\"\n                size=\"lg\"\n                data-testid=\"button-share-achievement\"\n              >\n                <Image className=\"w-4 h-4 mr-2\" />\n                Share with Visual Card\n              </Button>\n              \n              <Button\n                variant=\"ghost\"\n                onClick={() => {\n                  const text = `I just unlocked the \"${achievement.name}\" achievement on TypeMasterAI! ${achievement.icon}`;\n                  const url = \"https://typemasterai.com\";\n                  window.open(\n                    `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,\n                    \"_blank\",\n                    \"width=600,height=400\"\n                  );\n                  handleShareTracked('twitter_quick');\n                }}\n                className=\"w-full text-muted-foreground\"\n                size=\"sm\"\n                data-testid=\"button-quick-share-twitter\"\n              >\n                <Share2 className=\"w-3 h-3 mr-2\" />\n                Quick Share to Twitter\n              </Button>\n            </motion.div>\n          </div>\n        </motion.div>\n      </DialogContent>\n\n      {badgeData && (\n        <BadgeShareCard\n          badge={badgeData}\n          username={user?.username}\n          isOpen={showShareCard}\n          onClose={() => setShowShareCard(false)}\n          onShareTracked={handleShareTracked}\n        />\n      )}\n    </Dialog>\n  );\n}\n\nexport function AchievementCelebrationProvider({ children }: { children: React.ReactNode }) {\n  const [queue, setQueue] = useState<UnlockedAchievement[]>([]);\n  const [currentAchievement, setCurrentAchievement] = useState<UnlockedAchievement | null>(null);\n  const [isOpen, setIsOpen] = useState(false);\n\n  const processQueue = useCallback(() => {\n    if (queue.length > 0 && !isOpen) {\n      const [next, ...rest] = queue;\n      setCurrentAchievement(next);\n      setQueue(rest);\n      setIsOpen(true);\n    }\n  }, [queue, isOpen]);\n\n  useEffect(() => {\n    processQueue();\n  }, [processQueue]);\n\n  const celebrate = useCallback((achievement: UnlockedAchievement) => {\n    setQueue((prev) => [...prev, achievement]);\n  }, []);\n\n  const celebrateMultiple = useCallback((achievements: UnlockedAchievement[]) => {\n    setQueue((prev) => [...prev, ...achievements]);\n  }, []);\n\n  const handleClose = useCallback(() => {\n    setIsOpen(false);\n    setCurrentAchievement(null);\n    setTimeout(processQueue, 300);\n  }, [processQueue]);\n\n  return (\n    <AchievementCelebrationContext.Provider value={{ celebrate, celebrateMultiple }}>\n      {children}\n      <AnimatePresence>\n        {isOpen && (\n          <AchievementCelebrationModal\n            achievement={currentAchievement}\n            isOpen={isOpen}\n            onClose={handleClose}\n            queueLength={queue.length}\n          />\n        )}\n      </AnimatePresence>\n    </AchievementCelebrationContext.Provider>\n  );\n}\n","path":null,"size_bytes":13770,"size_tokens":null},"client/src/components/badge-share-card.tsx":{"content":"import { useRef, useEffect, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Download, Share2, Copy, Check, Twitter, Facebook, MessageCircle, Mail, Send, Clipboard, X, Loader2 } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { type Badge as BadgeType } from \"@shared/badges\";\n\ninterface BadgeShareCardProps {\n  badge: BadgeType;\n  username?: string;\n  unlockedAt?: string;\n  isOpen: boolean;\n  onClose: () => void;\n  onShareTracked?: (platform: string) => void;\n}\n\nconst tierColors = {\n  bronze: { primary: \"#CD7F32\", secondary: \"#B87333\", accent: \"#FFE4B5\", glow: \"rgba(205, 127, 50, 0.4)\" },\n  silver: { primary: \"#C0C0C0\", secondary: \"#A9A9A9\", accent: \"#F5F5F5\", glow: \"rgba(192, 192, 192, 0.4)\" },\n  gold: { primary: \"#FFD700\", secondary: \"#DAA520\", accent: \"#FFFACD\", glow: \"rgba(255, 215, 0, 0.4)\" },\n  platinum: { primary: \"#00CED1\", secondary: \"#20B2AA\", accent: \"#E0FFFF\", glow: \"rgba(0, 206, 209, 0.4)\" },\n  diamond: { primary: \"#9B59B6\", secondary: \"#E91E63\", accent: \"#F8BBD9\", glow: \"rgba(155, 89, 182, 0.4)\" },\n};\n\nconst tierEmojis = {\n  bronze: \"ðŸ¥‰\",\n  silver: \"ðŸ¥ˆ\",\n  gold: \"ðŸ¥‡\",\n  platinum: \"ðŸ’Ž\",\n  diamond: \"ðŸ‘‘\",\n};\n\nconst categoryEmojis: Record<string, string> = {\n  speed: \"âš¡\",\n  accuracy: \"ðŸŽ¯\",\n  consistency: \"ðŸ“ˆ\",\n  streak: \"ðŸ”¥\",\n  special: \"â­\",\n  secret: \"ðŸ”®\",\n};\n\nexport function BadgeShareCard({ badge, username, unlockedAt, isOpen, onClose, onShareTracked }: BadgeShareCardProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [isSharing, setIsSharing] = useState(false);\n  const [copied, setCopied] = useState(false);\n  const [imageCopied, setImageCopied] = useState(false);\n  const [isCanvasReady, setIsCanvasReady] = useState(false);\n  const { toast } = useToast();\n\n  const colors = tierColors[badge.tier] || tierColors.bronze;\n  const tierEmoji = tierEmojis[badge.tier] || \"ðŸ†\";\n  const categoryEmoji = categoryEmojis[badge.category] || \"ðŸ†\";\n\n  useEffect(() => {\n    if (isOpen) {\n      setIsCanvasReady(false);\n      const timer = setTimeout(() => {\n        requestAnimationFrame(() => {\n          requestAnimationFrame(() => {\n            generateCard();\n            setIsCanvasReady(true);\n          });\n        });\n      }, 100);\n      return () => clearTimeout(timer);\n    }\n  }, [isOpen, badge, username]);\n\n  const generateCard = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const ctx = canvas.getContext(\"2d\");\n    if (!ctx) return;\n\n    canvas.width = 600;\n    canvas.height = 400;\n\n    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);\n    gradient.addColorStop(0, \"#0f172a\");\n    gradient.addColorStop(0.3, \"#1e293b\");\n    gradient.addColorStop(0.7, \"#1e293b\");\n    gradient.addColorStop(1, \"#0f172a\");\n    ctx.fillStyle = gradient;\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n\n    ctx.strokeStyle = colors.primary;\n    ctx.lineWidth = 3;\n    ctx.strokeRect(15, 15, canvas.width - 30, canvas.height - 30);\n\n    ctx.strokeStyle = colors.secondary;\n    ctx.lineWidth = 1;\n    ctx.strokeRect(25, 25, canvas.width - 50, canvas.height - 50);\n\n    ctx.fillStyle = \"#00ffff\";\n    ctx.font = \"bold 16px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"left\";\n    ctx.fillText(\"TypeMasterAI\", 40, 55);\n\n    ctx.fillStyle = \"#a855f7\";\n    ctx.font = \"10px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"left\";\n    ctx.fillText(\"ACHIEVEMENT UNLOCKED\", 40, 70);\n\n    ctx.fillStyle = colors.primary;\n    ctx.font = \"bold 14px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"right\";\n    ctx.fillText(`${tierEmoji} ${badge.tier.toUpperCase()}`, canvas.width - 40, 55);\n\n    ctx.fillStyle = \"#64748b\";\n    ctx.font = \"12px 'DM Sans', sans-serif\";\n    ctx.fillText(`+${badge.points} XP`, canvas.width - 40, 70);\n\n    const centerX = canvas.width / 2;\n    const badgeY = 145;\n    const badgeRadius = 50;\n\n    ctx.save();\n    ctx.shadowColor = colors.glow;\n    ctx.shadowBlur = 30;\n    ctx.beginPath();\n    ctx.arc(centerX, badgeY, badgeRadius + 5, 0, Math.PI * 2);\n    ctx.strokeStyle = colors.primary;\n    ctx.lineWidth = 3;\n    ctx.stroke();\n    ctx.restore();\n\n    const badgeGradient = ctx.createRadialGradient(\n      centerX, badgeY - 20, 0,\n      centerX, badgeY, badgeRadius\n    );\n    badgeGradient.addColorStop(0, colors.accent);\n    badgeGradient.addColorStop(0.5, colors.primary);\n    badgeGradient.addColorStop(1, colors.secondary);\n\n    ctx.beginPath();\n    ctx.arc(centerX, badgeY, badgeRadius, 0, Math.PI * 2);\n    ctx.fillStyle = badgeGradient;\n    ctx.fill();\n\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"40px Arial\";\n    ctx.textAlign = \"center\";\n    ctx.textBaseline = \"middle\";\n    ctx.fillText(categoryEmoji, centerX, badgeY);\n\n    ctx.textBaseline = \"alphabetic\";\n\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 28px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(badge.name, centerX, 230);\n\n    ctx.fillStyle = \"#94a3b8\";\n    ctx.font = \"16px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"center\";\n    \n    const maxWidth = 500;\n    const words = badge.description.split(' ');\n    let line = '';\n    let y = 260;\n    \n    for (let word of words) {\n      const testLine = line + word + ' ';\n      const metrics = ctx.measureText(testLine);\n      if (metrics.width > maxWidth && line !== '') {\n        ctx.fillText(line.trim(), centerX, y);\n        line = word + ' ';\n        y += 22;\n      } else {\n        line = testLine;\n      }\n    }\n    ctx.fillText(line.trim(), centerX, y);\n\n    if (username) {\n      ctx.fillStyle = \"#64748b\";\n      ctx.font = \"14px 'DM Sans', sans-serif\";\n      ctx.textAlign = \"center\";\n      ctx.fillText(`Unlocked by @${username}`, centerX, 320);\n    }\n\n    if (unlockedAt) {\n      const date = new Date(unlockedAt).toLocaleDateString('en-US', { \n        year: 'numeric', \n        month: 'short', \n        day: 'numeric' \n      });\n      ctx.fillStyle = \"#475569\";\n      ctx.font = \"12px 'DM Sans', sans-serif\";\n      ctx.fillText(date, centerX, 340);\n    }\n\n    ctx.fillStyle = \"#a855f7\";\n    ctx.font = \"bold 14px 'DM Sans', sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"typemasterai.com\", centerX, 375);\n\n    ctx.fillStyle = \"#64748b\";\n    ctx.font = \"10px 'DM Sans', sans-serif\";\n    ctx.fillText(\"Can you unlock this badge too? ðŸŽ¯\", centerX, 390);\n  };\n\n  const downloadCard = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const link = document.createElement(\"a\");\n    link.download = `TypeMasterAI_Badge_${badge.id}.png`;\n    link.href = canvas.toDataURL(\"image/png\");\n    link.click();\n    \n    onShareTracked?.('badge_card_download');\n    \n    toast({\n      title: \"Badge Card Downloaded!\",\n      description: \"Share it on social media to show off your achievement!\",\n    });\n  };\n\n  const shareCard = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    setIsSharing(true);\n    try {\n      const blob = await new Promise<Blob>((resolve, reject) => {\n        canvas.toBlob((blob) => {\n          if (blob) resolve(blob);\n          else reject(new Error(\"Failed to create blob\"));\n        }, \"image/png\");\n      });\n\n      const file = new File([blob], `TypeMasterAI_Badge_${badge.id}.png`, { type: \"image/png\" });\n\n      if ('share' in navigator && navigator.canShare?.({ files: [file] })) {\n        await navigator.share({\n          title: `${badge.name} - TypeMasterAI Achievement`,\n          text: getShareText(),\n          files: [file],\n        });\n        onShareTracked?.('badge_card_native');\n        toast({\n          title: \"Shared Successfully!\",\n          description: \"Your achievement is on its way to inspire others!\",\n        });\n      } else {\n        downloadCard();\n      }\n    } catch (error: any) {\n      if (error.name !== 'AbortError') {\n        downloadCard();\n      }\n    } finally {\n      setIsSharing(false);\n    }\n  };\n\n  const copyImageToClipboard = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    try {\n      const blob = await new Promise<Blob>((resolve, reject) => {\n        canvas.toBlob((blob) => {\n          if (blob) resolve(blob);\n          else reject(new Error(\"Failed to create blob\"));\n        }, \"image/png\");\n      });\n\n      await navigator.clipboard.write([\n        new ClipboardItem({ \"image/png\": blob })\n      ]);\n      \n      setImageCopied(true);\n      setTimeout(() => setImageCopied(false), 2000);\n      onShareTracked?.('badge_card_copy_image');\n      toast({\n        title: \"Image Copied!\",\n        description: \"Paste directly into Twitter, Discord, or any app that supports images!\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Copy Failed\",\n        description: \"Your browser doesn't support image copying. Please download instead.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const getShareText = () => {\n    return `${tierEmoji} I just unlocked the \"${badge.name}\" badge on TypeMasterAI!\\n\\n${categoryEmoji} ${badge.description}\\nðŸ… ${badge.tier.charAt(0).toUpperCase() + badge.tier.slice(1)} Tier â€¢ +${badge.points} XP\\n\\nCan you unlock this badge too? ðŸŽ¯`;\n  };\n\n  const copyShareText = () => {\n    const text = getShareText() + '\\n\\nðŸ”— https://typemasterai.com';\n\n    navigator.clipboard.writeText(text);\n    setCopied(true);\n    setTimeout(() => setCopied(false), 2000);\n    onShareTracked?.('badge_card_copy_text');\n    toast({\n      title: \"Copied!\",\n      description: \"Share text copied to clipboard.\",\n    });\n  };\n\n  const shareToTwitter = () => {\n    const text = encodeURIComponent(getShareText());\n    window.open(`https://twitter.com/intent/tweet?text=${text}&url=${encodeURIComponent('https://typemasterai.com')}`, '_blank', 'width=600,height=400');\n    onShareTracked?.('badge_twitter');\n  };\n\n  const shareToFacebook = () => {\n    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent('https://typemasterai.com')}&quote=${encodeURIComponent(getShareText())}`, '_blank', 'width=600,height=400');\n    onShareTracked?.('badge_facebook');\n  };\n\n  const shareToWhatsApp = () => {\n    const fullText = getShareText() + '\\n\\nðŸ”— https://typemasterai.com';\n    window.open(`https://wa.me/?text=${encodeURIComponent(fullText)}`, '_blank', 'width=600,height=400');\n    onShareTracked?.('badge_whatsapp');\n  };\n\n  const shareToReddit = () => {\n    const title = encodeURIComponent(`I unlocked the \"${badge.name}\" badge on TypeMasterAI!`);\n    window.open(`https://www.reddit.com/submit?url=${encodeURIComponent('https://typemasterai.com')}&title=${title}`, '_blank', 'width=600,height=600');\n    onShareTracked?.('badge_reddit');\n  };\n\n  const shareToTelegram = () => {\n    const text = getShareText();\n    window.open(`https://t.me/share/url?url=${encodeURIComponent('https://typemasterai.com')}&text=${encodeURIComponent(text)}`, '_blank', 'width=600,height=400');\n    onShareTracked?.('badge_telegram');\n  };\n\n  const shareViaEmail = () => {\n    const subject = encodeURIComponent(`I unlocked the \"${badge.name}\" badge on TypeMasterAI!`);\n    const body = encodeURIComponent(`${getShareText()}\\n\\nTry it yourself: https://typemasterai.com`);\n    window.open(`mailto:?subject=${subject}&body=${body}`);\n    onShareTracked?.('badge_email');\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>\n      <DialogContent className=\"sm:max-w-lg max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Share2 className=\"w-5 h-5\" />\n            Share Your Achievement\n          </DialogTitle>\n        </DialogHeader>\n        \n        <div className=\"flex flex-col items-center gap-4\">\n          <div className=\"relative\">\n            <canvas\n              ref={canvasRef}\n              width={600}\n              height={400}\n              className=\"rounded-xl shadow-2xl max-w-full h-auto border border-primary/20\"\n              style={{ maxWidth: \"100%\", height: \"auto\" }}\n              data-testid=\"badge-share-canvas\"\n            />\n            {!isCanvasReady && (\n              <div className=\"absolute inset-0 flex items-center justify-center bg-background/80 rounded-xl\">\n                <div className=\"flex flex-col items-center gap-2\">\n                  <Loader2 className=\"w-8 h-8 animate-spin text-primary\" />\n                  <span className=\"text-sm text-muted-foreground\">Generating card...</span>\n                </div>\n              </div>\n            )}\n          </div>\n          \n          <div className=\"w-full space-y-3\">\n            <div className=\"p-3 bg-gradient-to-r from-purple-500/10 to-pink-500/10 rounded-xl border border-purple-500/20\">\n              <p className=\"text-xs text-center text-purple-300 font-medium mb-2\">Share This Image</p>\n              <div className=\"grid grid-cols-2 gap-2\">\n                <Button\n                  onClick={copyImageToClipboard}\n                  variant=\"outline\"\n                  className=\"gap-2 bg-purple-500/10 border-purple-500/30 hover:bg-purple-500/20\"\n                  disabled={!isCanvasReady}\n                  data-testid=\"button-badge-copy-image\"\n                >\n                  {imageCopied ? <Check className=\"w-4 h-4 text-green-500\" /> : <Clipboard className=\"w-4 h-4 text-purple-400\" />}\n                  {imageCopied ? \"Copied!\" : \"Copy Image\"}\n                </Button>\n                <Button\n                  onClick={downloadCard}\n                  variant=\"outline\"\n                  className=\"gap-2 bg-blue-500/10 border-blue-500/30 hover:bg-blue-500/20\"\n                  disabled={!isCanvasReady}\n                  data-testid=\"button-badge-download\"\n                >\n                  <Download className=\"w-4 h-4 text-blue-400\" />\n                  Download\n                </Button>\n              </div>\n              <p className=\"text-[10px] text-center text-muted-foreground mt-2\">\n                Copy image and paste directly into Twitter, Discord, or any social app\n              </p>\n            </div>\n\n            {'share' in navigator && (\n              <Button\n                onClick={shareCard}\n                disabled={isSharing || !isCanvasReady}\n                className=\"w-full gap-2 bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600\"\n                data-testid=\"button-badge-share-native\"\n              >\n                <Share2 className=\"w-4 h-4\" />\n                {isSharing ? \"Sharing...\" : \"Share Image (Mobile/Desktop Apps)\"}\n              </Button>\n            )}\n          </div>\n\n          <div className=\"w-full space-y-2\">\n            <p className=\"text-xs text-center text-muted-foreground uppercase tracking-wide\">Or Share with Text + Link</p>\n            <div className=\"grid grid-cols-3 gap-2\">\n              <button\n                onClick={shareToTwitter}\n                className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#1DA1F2]/10 hover:bg-[#1DA1F2]/25 border border-[#1DA1F2]/20 transition-all\"\n                data-testid=\"button-badge-share-twitter\"\n              >\n                <Twitter className=\"w-4 h-4 text-[#1DA1F2]\" />\n                <span className=\"text-xs font-medium\">Twitter</span>\n              </button>\n              <button\n                onClick={shareToFacebook}\n                className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#1877F2]/10 hover:bg-[#1877F2]/25 border border-[#1877F2]/20 transition-all\"\n                data-testid=\"button-badge-share-facebook\"\n              >\n                <Facebook className=\"w-4 h-4 text-[#1877F2]\" />\n                <span className=\"text-xs font-medium\">Facebook</span>\n              </button>\n              <button\n                onClick={shareToWhatsApp}\n                className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#25D366]/10 hover:bg-[#25D366]/25 border border-[#25D366]/20 transition-all\"\n                data-testid=\"button-badge-share-whatsapp\"\n              >\n                <MessageCircle className=\"w-4 h-4 text-[#25D366]\" />\n                <span className=\"text-xs font-medium\">WhatsApp</span>\n              </button>\n              <button\n                onClick={shareToReddit}\n                className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#FF4500]/10 hover:bg-[#FF4500]/25 border border-[#FF4500]/20 transition-all\"\n                data-testid=\"button-badge-share-reddit\"\n              >\n                <svg className=\"w-4 h-4 text-[#FF4500]\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                  <path d=\"M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z\"/>\n                </svg>\n                <span className=\"text-xs font-medium\">Reddit</span>\n              </button>\n              <button\n                onClick={shareToTelegram}\n                className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-[#0088cc]/10 hover:bg-[#0088cc]/25 border border-[#0088cc]/20 transition-all\"\n                data-testid=\"button-badge-share-telegram\"\n              >\n                <Send className=\"w-4 h-4 text-[#0088cc]\" />\n                <span className=\"text-xs font-medium\">Telegram</span>\n              </button>\n              <button\n                onClick={shareViaEmail}\n                className=\"flex items-center justify-center gap-2 p-3 rounded-xl bg-gray-500/10 hover:bg-gray-500/25 border border-gray-500/20 transition-all\"\n                data-testid=\"button-badge-share-email\"\n              >\n                <Mail className=\"w-4 h-4 text-gray-400\" />\n                <span className=\"text-xs font-medium\">Email</span>\n              </button>\n            </div>\n            \n            <button\n              onClick={copyShareText}\n              className=\"w-full py-2 mt-2 bg-secondary/50 hover:bg-secondary text-secondary-foreground rounded-lg text-sm flex items-center justify-center gap-2 transition-all\"\n              data-testid=\"button-badge-copy-text\"\n            >\n              {copied ? <Check className=\"w-4 h-4 text-green-500\" /> : <Copy className=\"w-4 h-4\" />}\n              {copied ? \"Text Copied!\" : \"Copy Share Text\"}\n            </button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":19372,"size_tokens":null},"server/auth-error-handling.ts":{"content":"import crypto from \"node:crypto\";\nimport type { Request, Response, NextFunction } from \"express\";\n\nexport enum AuthErrorCode {\n  INVALID_INPUT = \"AUTH_001\",\n  VALIDATION_FAILED = \"AUTH_002\",\n  EMAIL_EXISTS = \"AUTH_003\",\n  USERNAME_EXISTS = \"AUTH_004\",\n  INVALID_CREDENTIALS = \"AUTH_005\",\n  ACCOUNT_LOCKED = \"AUTH_006\",\n  ACCOUNT_INACTIVE = \"AUTH_007\",\n  OAUTH_ONLY_ACCOUNT = \"AUTH_008\",\n  TOKEN_INVALID = \"AUTH_009\",\n  TOKEN_EXPIRED = \"AUTH_010\",\n  TOKEN_USED = \"AUTH_011\",\n  PASSWORD_TOO_WEAK = \"AUTH_012\",\n  PASSWORD_COMMON = \"AUTH_013\",\n  USERNAME_RESERVED = \"AUTH_014\",\n  USERNAME_INVALID_FORMAT = \"AUTH_015\",\n  EMAIL_INVALID = \"AUTH_016\",\n  SESSION_ERROR = \"AUTH_017\",\n  RATE_LIMITED = \"AUTH_018\",\n  PAYLOAD_TOO_LARGE = \"AUTH_019\",\n  DATABASE_ERROR = \"AUTH_020\",\n  CONCURRENT_REQUEST = \"AUTH_021\",\n  OAUTH_CONFLICT = \"AUTH_022\",\n  PROVIDER_ERROR = \"AUTH_023\",\n  INTERNAL_ERROR = \"AUTH_099\",\n}\n\ninterface AuthErrorDetails {\n  code: AuthErrorCode;\n  message: string;\n  statusCode: number;\n  field?: string;\n  retryable?: boolean;\n  attemptsRemaining?: number;\n  lockoutMinutes?: number;\n}\n\nexport class AuthError extends Error {\n  public readonly code: AuthErrorCode;\n  public readonly statusCode: number;\n  public readonly field?: string;\n  public readonly retryable: boolean;\n  public readonly attemptsRemaining?: number;\n  public readonly lockoutMinutes?: number;\n  public readonly timestamp: Date;\n  public readonly requestId?: string;\n\n  constructor(details: AuthErrorDetails, requestId?: string) {\n    super(details.message);\n    this.name = \"AuthError\";\n    this.code = details.code;\n    this.statusCode = details.statusCode;\n    this.field = details.field;\n    this.retryable = details.retryable ?? false;\n    this.attemptsRemaining = details.attemptsRemaining;\n    this.lockoutMinutes = details.lockoutMinutes;\n    this.timestamp = new Date();\n    this.requestId = requestId;\n  }\n\n  toJSON() {\n    return {\n      error: {\n        code: this.code,\n        message: this.message,\n        field: this.field,\n        retryable: this.retryable,\n        ...(this.attemptsRemaining !== undefined && { attemptsRemaining: this.attemptsRemaining }),\n        ...(this.lockoutMinutes !== undefined && { lockoutMinutes: this.lockoutMinutes }),\n      },\n    };\n  }\n}\n\nconst COMMON_PASSWORDS = new Set([\n  \"password\", \"123456\", \"12345678\", \"qwerty\", \"abc123\", \"monkey\", \"1234567\",\n  \"letmein\", \"trustno1\", \"dragon\", \"baseball\", \"iloveyou\", \"master\", \"sunshine\",\n  \"ashley\", \"bailey\", \"shadow\", \"123123\", \"654321\", \"superman\", \"qazwsx\",\n  \"michael\", \"football\", \"password1\", \"password123\", \"welcome\", \"welcome1\",\n  \"admin\", \"login\", \"passw0rd\", \"starwars\", \"hello123\", \"charlie\", \"donald\",\n  \"password12\", \"1qaz2wsx\", \"qwertyuiop\", \"000000\", \"princess\", \"computer\",\n  \"zxcvbnm\", \"baseball1\", \"1234qwer\", \"12qwaszx\", \"qwerty123\", \"admin123\",\n  \"access\", \"test\", \"test123\", \"root\", \"guest\", \"administrator\", \"111111\",\n  \"123456789\", \"1234567890\", \"password1234\", \"typing\", \"typemaster\", \"typemasterai\"\n]);\n\nconst RESERVED_USERNAMES = new Set([\n  \"admin\", \"administrator\", \"root\", \"system\", \"support\", \"help\", \"info\",\n  \"contact\", \"webmaster\", \"postmaster\", \"hostmaster\", \"abuse\", \"security\",\n  \"sales\", \"marketing\", \"billing\", \"legal\", \"privacy\", \"terms\", \"api\",\n  \"www\", \"ftp\", \"mail\", \"email\", \"smtp\", \"pop\", \"imap\", \"ns\", \"dns\",\n  \"test\", \"demo\", \"staging\", \"dev\", \"development\", \"prod\", \"production\",\n  \"null\", \"undefined\", \"nan\", \"true\", \"false\", \"bot\", \"robot\", \"ai\",\n  \"typemasterai\", \"typemaster\", \"official\", \"verified\", \"anonymous\",\n  \"moderator\", \"mod\", \"staff\", \"team\", \"owner\", \"founder\", \"ceo\", \"cto\",\n  \"guest\", \"user\", \"member\", \"account\", \"profile\", \"settings\", \"dashboard\",\n  \"login\", \"logout\", \"register\", \"signup\", \"signin\", \"password\", \"reset\",\n  \"verify\", \"verification\", \"confirm\", \"confirmation\", \"delete\", \"remove\",\n  \"create\", \"update\", \"edit\", \"new\", \"all\", \"everyone\", \"anybody\", \"nobody\"\n]);\n\nconst CONFUSING_CHAR_PATTERNS = [\n  /[^\\x00-\\x7F]/, // Non-ASCII characters (homoglyphs)\n  /[\\u200B-\\u200D\\uFEFF]/, // Zero-width characters\n  /[\\u202A-\\u202E]/, // Bidirectional text control\n  /[\\u2066-\\u2069]/, // Additional bidi controls\n];\n\nexport class InputSanitizer {\n  static normalizeEmail(email: string): string {\n    if (!email || typeof email !== \"string\") {\n      throw new AuthError({\n        code: AuthErrorCode.EMAIL_INVALID,\n        message: \"Email is required\",\n        statusCode: 400,\n        field: \"email\",\n      });\n    }\n\n    let normalized = email.trim().toLowerCase();\n    \n    if (normalized.length > 254) {\n      throw new AuthError({\n        code: AuthErrorCode.PAYLOAD_TOO_LARGE,\n        message: \"Email address is too long\",\n        statusCode: 400,\n        field: \"email\",\n      });\n    }\n\n    if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(normalized)) {\n      throw new AuthError({\n        code: AuthErrorCode.EMAIL_INVALID,\n        message: \"Invalid email format\",\n        statusCode: 400,\n        field: \"email\",\n      });\n    }\n\n    return normalized;\n  }\n\n  static normalizeUsername(username: string): string {\n    if (!username || typeof username !== \"string\") {\n      throw new AuthError({\n        code: AuthErrorCode.USERNAME_INVALID_FORMAT,\n        message: \"Username is required\",\n        statusCode: 400,\n        field: \"username\",\n      });\n    }\n\n    const normalized = username.trim();\n    \n    if (normalized.length < 3) {\n      throw new AuthError({\n        code: AuthErrorCode.USERNAME_INVALID_FORMAT,\n        message: \"Username must be at least 3 characters\",\n        statusCode: 400,\n        field: \"username\",\n      });\n    }\n\n    if (normalized.length > 30) {\n      throw new AuthError({\n        code: AuthErrorCode.PAYLOAD_TOO_LARGE,\n        message: \"Username must be less than 30 characters\",\n        statusCode: 400,\n        field: \"username\",\n      });\n    }\n\n    if (!/^[a-zA-Z]/.test(normalized)) {\n      throw new AuthError({\n        code: AuthErrorCode.USERNAME_INVALID_FORMAT,\n        message: \"Username must start with a letter\",\n        statusCode: 400,\n        field: \"username\",\n      });\n    }\n\n    if (!/^[a-zA-Z0-9_]+$/.test(normalized)) {\n      throw new AuthError({\n        code: AuthErrorCode.USERNAME_INVALID_FORMAT,\n        message: \"Username can only contain letters, numbers, and underscores\",\n        statusCode: 400,\n        field: \"username\",\n      });\n    }\n\n    for (const pattern of CONFUSING_CHAR_PATTERNS) {\n      if (pattern.test(normalized)) {\n        throw new AuthError({\n          code: AuthErrorCode.USERNAME_INVALID_FORMAT,\n          message: \"Username contains invalid characters\",\n          statusCode: 400,\n          field: \"username\",\n        });\n      }\n    }\n\n    if (RESERVED_USERNAMES.has(normalized.toLowerCase())) {\n      throw new AuthError({\n        code: AuthErrorCode.USERNAME_RESERVED,\n        message: \"This username is reserved. Please choose a different one.\",\n        statusCode: 400,\n        field: \"username\",\n      });\n    }\n\n    return normalized;\n  }\n\n  static sanitizeToken(token: string): string {\n    if (!token || typeof token !== \"string\") {\n      throw new AuthError({\n        code: AuthErrorCode.TOKEN_INVALID,\n        message: \"Token is required\",\n        statusCode: 400,\n        field: \"token\",\n      });\n    }\n\n    const sanitized = token.trim();\n    \n    if (!/^[a-fA-F0-9]{64}$/.test(sanitized)) {\n      throw new AuthError({\n        code: AuthErrorCode.TOKEN_INVALID,\n        message: \"Invalid token format\",\n        statusCode: 400,\n        field: \"token\",\n      });\n    }\n\n    return sanitized.toLowerCase();\n  }\n}\n\nexport class PasswordValidator {\n  static validate(password: string, email?: string, username?: string): void {\n    if (!password || typeof password !== \"string\") {\n      throw new AuthError({\n        code: AuthErrorCode.PASSWORD_TOO_WEAK,\n        message: \"Password is required\",\n        statusCode: 400,\n        field: \"password\",\n      });\n    }\n\n    if (password.length < 8) {\n      throw new AuthError({\n        code: AuthErrorCode.PASSWORD_TOO_WEAK,\n        message: \"Password must be at least 8 characters\",\n        statusCode: 400,\n        field: \"password\",\n      });\n    }\n\n    if (password.length > 128) {\n      throw new AuthError({\n        code: AuthErrorCode.PAYLOAD_TOO_LARGE,\n        message: \"Password is too long (max 128 characters)\",\n        statusCode: 400,\n        field: \"password\",\n      });\n    }\n\n    if (!/[A-Z]/.test(password)) {\n      throw new AuthError({\n        code: AuthErrorCode.PASSWORD_TOO_WEAK,\n        message: \"Password must contain at least one uppercase letter\",\n        statusCode: 400,\n        field: \"password\",\n      });\n    }\n\n    if (!/[a-z]/.test(password)) {\n      throw new AuthError({\n        code: AuthErrorCode.PASSWORD_TOO_WEAK,\n        message: \"Password must contain at least one lowercase letter\",\n        statusCode: 400,\n        field: \"password\",\n      });\n    }\n\n    if (!/[0-9]/.test(password)) {\n      throw new AuthError({\n        code: AuthErrorCode.PASSWORD_TOO_WEAK,\n        message: \"Password must contain at least one number\",\n        statusCode: 400,\n        field: \"password\",\n      });\n    }\n\n    if (!/[^A-Za-z0-9]/.test(password)) {\n      throw new AuthError({\n        code: AuthErrorCode.PASSWORD_TOO_WEAK,\n        message: \"Password must contain at least one special character\",\n        statusCode: 400,\n        field: \"password\",\n      });\n    }\n\n    const lowerPassword = password.toLowerCase();\n    if (COMMON_PASSWORDS.has(lowerPassword)) {\n      throw new AuthError({\n        code: AuthErrorCode.PASSWORD_COMMON,\n        message: \"This password is too common. Please choose a more secure password.\",\n        statusCode: 400,\n        field: \"password\",\n      });\n    }\n\n    if (email) {\n      const emailPart = email.split(\"@\")[0].toLowerCase();\n      if (lowerPassword.includes(emailPart) && emailPart.length >= 3) {\n        throw new AuthError({\n          code: AuthErrorCode.PASSWORD_TOO_WEAK,\n          message: \"Password should not contain your email address\",\n          statusCode: 400,\n          field: \"password\",\n        });\n      }\n    }\n\n    if (username && username.length >= 3) {\n      if (lowerPassword.includes(username.toLowerCase())) {\n        throw new AuthError({\n          code: AuthErrorCode.PASSWORD_TOO_WEAK,\n          message: \"Password should not contain your username\",\n          statusCode: 400,\n          field: \"password\",\n        });\n      }\n    }\n  }\n\n  static checkBreached(password: string): boolean {\n    return COMMON_PASSWORDS.has(password.toLowerCase());\n  }\n}\n\nexport class TokenSecurity {\n  static timingSafeCompare(a: string, b: string): boolean {\n    if (typeof a !== \"string\" || typeof b !== \"string\") {\n      return false;\n    }\n\n    try {\n      const bufA = Buffer.from(a, \"utf8\");\n      const bufB = Buffer.from(b, \"utf8\");\n\n      if (bufA.length !== bufB.length) {\n        crypto.timingSafeEqual(bufA, bufA);\n        return false;\n      }\n\n      return crypto.timingSafeEqual(bufA, bufB);\n    } catch {\n      return false;\n    }\n  }\n\n  static isTokenExpired(expiresAt: Date): boolean {\n    return new Date() > expiresAt;\n  }\n\n  static validateTokenState(token: { expiresAt: Date; used?: boolean; usedAt?: Date | null } | null | undefined): void {\n    if (!token) {\n      throw new AuthError({\n        code: AuthErrorCode.TOKEN_INVALID,\n        message: \"Invalid or expired token\",\n        statusCode: 400,\n      });\n    }\n\n    if (token.used || token.usedAt) {\n      throw new AuthError({\n        code: AuthErrorCode.TOKEN_USED,\n        message: \"This token has already been used\",\n        statusCode: 400,\n      });\n    }\n\n    if (this.isTokenExpired(token.expiresAt)) {\n      throw new AuthError({\n        code: AuthErrorCode.TOKEN_EXPIRED,\n        message: \"This token has expired. Please request a new one.\",\n        statusCode: 400,\n      });\n    }\n  }\n}\n\nconst POSTGRES_ERROR_CODES = {\n  UNIQUE_VIOLATION: \"23505\",\n  FOREIGN_KEY_VIOLATION: \"23503\",\n  NOT_NULL_VIOLATION: \"23502\",\n  CHECK_VIOLATION: \"23514\",\n  SERIALIZATION_FAILURE: \"40001\",\n  DEADLOCK_DETECTED: \"40P01\",\n  CONNECTION_EXCEPTION: \"08000\",\n  CONNECTION_FAILURE: \"08006\",\n  ADMIN_SHUTDOWN: \"57P01\",\n  CRASH_SHUTDOWN: \"57P02\",\n  CANNOT_CONNECT_NOW: \"57P03\",\n};\n\ninterface DatabaseErrorInfo {\n  isRetryable: boolean;\n  authError: AuthError;\n  shouldLog: boolean;\n}\n\nexport class DatabaseErrorHandler {\n  static handle(error: any, context: string, requestId?: string): DatabaseErrorInfo {\n    const pgCode = error?.code;\n    const detail = error?.detail || \"\";\n    const constraint = error?.constraint || \"\";\n\n    if (pgCode === POSTGRES_ERROR_CODES.UNIQUE_VIOLATION) {\n      if (detail.includes(\"email\") || constraint.includes(\"email\")) {\n        return {\n          isRetryable: false,\n          shouldLog: false,\n          authError: new AuthError({\n            code: AuthErrorCode.EMAIL_EXISTS,\n            message: \"An account with this email already exists\",\n            statusCode: 409,\n            field: \"email\",\n          }, requestId),\n        };\n      }\n      if (detail.includes(\"username\") || constraint.includes(\"username\")) {\n        return {\n          isRetryable: false,\n          shouldLog: false,\n          authError: new AuthError({\n            code: AuthErrorCode.USERNAME_EXISTS,\n            message: \"This username is already taken\",\n            statusCode: 409,\n            field: \"username\",\n          }, requestId),\n        };\n      }\n      return {\n        isRetryable: false,\n        shouldLog: true,\n        authError: new AuthError({\n          code: AuthErrorCode.CONCURRENT_REQUEST,\n          message: \"This request conflicts with another operation. Please try again.\",\n          statusCode: 409,\n          retryable: true,\n        }, requestId),\n      };\n    }\n\n    if (pgCode === POSTGRES_ERROR_CODES.SERIALIZATION_FAILURE || \n        pgCode === POSTGRES_ERROR_CODES.DEADLOCK_DETECTED) {\n      return {\n        isRetryable: true,\n        shouldLog: true,\n        authError: new AuthError({\n          code: AuthErrorCode.CONCURRENT_REQUEST,\n          message: \"Server is busy. Please try again in a moment.\",\n          statusCode: 503,\n          retryable: true,\n        }, requestId),\n      };\n    }\n\n    if ([\n      POSTGRES_ERROR_CODES.CONNECTION_EXCEPTION,\n      POSTGRES_ERROR_CODES.CONNECTION_FAILURE,\n      POSTGRES_ERROR_CODES.ADMIN_SHUTDOWN,\n      POSTGRES_ERROR_CODES.CRASH_SHUTDOWN,\n      POSTGRES_ERROR_CODES.CANNOT_CONNECT_NOW,\n    ].includes(pgCode)) {\n      return {\n        isRetryable: true,\n        shouldLog: true,\n        authError: new AuthError({\n          code: AuthErrorCode.DATABASE_ERROR,\n          message: \"Service temporarily unavailable. Please try again later.\",\n          statusCode: 503,\n          retryable: true,\n        }, requestId),\n      };\n    }\n\n    return {\n      isRetryable: false,\n      shouldLog: true,\n      authError: new AuthError({\n        code: AuthErrorCode.INTERNAL_ERROR,\n        message: \"An unexpected error occurred. Please try again.\",\n        statusCode: 500,\n      }, requestId),\n    };\n  }\n\n  static async withRetry<T>(\n    operation: () => Promise<T>,\n    maxRetries: number = 3,\n    baseDelayMs: number = 100\n  ): Promise<T> {\n    let lastError: any;\n\n    for (let attempt = 0; attempt <= maxRetries; attempt++) {\n      try {\n        return await operation();\n      } catch (error: any) {\n        lastError = error;\n        const errorInfo = this.handle(error, \"withRetry\");\n        \n        if (!errorInfo.isRetryable || attempt === maxRetries) {\n          throw error;\n        }\n\n        const jitter = Math.random() * 50;\n        const delay = baseDelayMs * Math.pow(2, attempt) + jitter;\n        await new Promise(resolve => setTimeout(resolve, delay));\n      }\n    }\n\n    throw lastError;\n  }\n}\n\ninterface AuthLogEntry {\n  timestamp: string;\n  level: \"info\" | \"warn\" | \"error\";\n  event: string;\n  requestId?: string;\n  userId?: string;\n  email?: string;\n  ipAddress?: string;\n  userAgent?: string;\n  errorCode?: AuthErrorCode;\n  errorMessage?: string;\n  durationMs?: number;\n  metadata?: Record<string, any>;\n}\n\nexport class AuthLogger {\n  private static hashEmail(email: string): string {\n    return crypto.createHash(\"sha256\").update(email.toLowerCase()).digest(\"hex\").substring(0, 16);\n  }\n\n  private static getClientIp(req: Request): string {\n    const forwarded = req.headers[\"x-forwarded-for\"];\n    if (typeof forwarded === \"string\") {\n      return forwarded.split(\",\")[0].trim();\n    }\n    return req.socket?.remoteAddress || \"unknown\";\n  }\n\n  static log(entry: AuthLogEntry): void {\n    const sanitized = {\n      ...entry,\n      email: entry.email ? this.hashEmail(entry.email) : undefined,\n    };\n    \n    const logLine = JSON.stringify(sanitized);\n    \n    switch (entry.level) {\n      case \"error\":\n        console.error(`[AUTH] ${logLine}`);\n        break;\n      case \"warn\":\n        console.warn(`[AUTH] ${logLine}`);\n        break;\n      default:\n        console.log(`[AUTH] ${logLine}`);\n    }\n  }\n\n  static logAuthEvent(\n    event: string,\n    req: Request,\n    options: {\n      level?: \"info\" | \"warn\" | \"error\";\n      userId?: string;\n      email?: string;\n      error?: AuthError | Error;\n      durationMs?: number;\n      metadata?: Record<string, any>;\n    } = {}\n  ): void {\n    const requestId = (req as any).requestId || crypto.randomUUID().substring(0, 8);\n    \n    this.log({\n      timestamp: new Date().toISOString(),\n      level: options.level || \"info\",\n      event,\n      requestId,\n      userId: options.userId,\n      email: options.email,\n      ipAddress: this.getClientIp(req),\n      userAgent: req.headers[\"user-agent\"]?.substring(0, 200),\n      errorCode: options.error instanceof AuthError ? options.error.code : undefined,\n      errorMessage: options.error?.message,\n      durationMs: options.durationMs,\n      metadata: options.metadata,\n    });\n  }\n\n  static logLoginAttempt(req: Request, email: string, success: boolean, userId?: string, reason?: string): void {\n    this.logAuthEvent(success ? \"LOGIN_SUCCESS\" : \"LOGIN_FAILED\", req, {\n      level: success ? \"info\" : \"warn\",\n      userId,\n      email,\n      metadata: reason ? { reason } : undefined,\n    });\n  }\n\n  static logRegistration(req: Request, email: string, success: boolean, userId?: string, reason?: string): void {\n    this.logAuthEvent(success ? \"REGISTRATION_SUCCESS\" : \"REGISTRATION_FAILED\", req, {\n      level: success ? \"info\" : \"warn\",\n      userId,\n      email,\n      metadata: reason ? { reason } : undefined,\n    });\n  }\n\n  static logPasswordReset(req: Request, email: string, stage: \"requested\" | \"completed\" | \"failed\", reason?: string): void {\n    this.logAuthEvent(`PASSWORD_RESET_${stage.toUpperCase()}`, req, {\n      level: stage === \"failed\" ? \"warn\" : \"info\",\n      email,\n      metadata: reason ? { reason } : undefined,\n    });\n  }\n}\n\nexport function authErrorMiddleware(err: Error, req: Request, res: Response, next: NextFunction): void {\n  if (err instanceof AuthError) {\n    AuthLogger.logAuthEvent(\"AUTH_ERROR\", req, {\n      level: err.statusCode >= 500 ? \"error\" : \"warn\",\n      error: err,\n    });\n    \n    res.status(err.statusCode).json(err.toJSON());\n    return;\n  }\n\n  AuthLogger.logAuthEvent(\"UNEXPECTED_ERROR\", req, {\n    level: \"error\",\n    error: err,\n  });\n  \n  res.status(500).json({\n    error: {\n      code: AuthErrorCode.INTERNAL_ERROR,\n      message: \"An unexpected error occurred. Please try again.\",\n    },\n  });\n}\n\nexport function payloadLimitMiddleware(maxSizeKB: number = 10) {\n  return (req: Request, res: Response, next: NextFunction): void => {\n    const contentLength = parseInt(req.headers[\"content-length\"] || \"0\", 10);\n    const maxBytes = maxSizeKB * 1024;\n\n    if (contentLength > maxBytes) {\n      const error = new AuthError({\n        code: AuthErrorCode.PAYLOAD_TOO_LARGE,\n        message: `Request payload too large. Maximum size is ${maxSizeKB}KB.`,\n        statusCode: 413,\n      });\n      \n      res.status(error.statusCode).json(error.toJSON());\n      return;\n    }\n\n    next();\n  };\n}\n\nexport function requestIdMiddleware(req: Request, _res: Response, next: NextFunction): void {\n  (req as any).requestId = crypto.randomUUID().substring(0, 8);\n  next();\n}\n\nexport async function addTimingJitter(minMs: number = 100, maxMs: number = 300): Promise<void> {\n  const delay = minMs + Math.random() * (maxMs - minMs);\n  await new Promise(resolve => setTimeout(resolve, delay));\n}\n\nconst idempotencyStore = new Map<string, { timestamp: number; response: any }>();\nconst IDEMPOTENCY_TTL_MS = 5 * 60 * 1000; // 5 minutes\n\nexport function generateIdempotencyKey(email: string, action: string): string {\n  const window = Math.floor(Date.now() / IDEMPOTENCY_TTL_MS);\n  return crypto.createHash(\"sha256\").update(`${email}:${action}:${window}`).digest(\"hex\");\n}\n\nexport function checkIdempotency(key: string): { isDuplicate: boolean; cachedResponse?: any } {\n  const now = Date.now();\n  \n  Array.from(idempotencyStore.entries()).forEach(([k, v]) => {\n    if (now - v.timestamp > IDEMPOTENCY_TTL_MS) {\n      idempotencyStore.delete(k);\n    }\n  });\n\n  const cached = idempotencyStore.get(key);\n  if (cached) {\n    return { isDuplicate: true, cachedResponse: cached.response };\n  }\n\n  return { isDuplicate: false };\n}\n\nexport function storeIdempotencyResult(key: string, response: any): void {\n  idempotencyStore.set(key, { timestamp: Date.now(), response });\n}\n\nexport const authErrors = {\n  emailExists: () => new AuthError({\n    code: AuthErrorCode.EMAIL_EXISTS,\n    message: \"An account with this email already exists\",\n    statusCode: 409,\n    field: \"email\",\n  }),\n  usernameExists: () => new AuthError({\n    code: AuthErrorCode.USERNAME_EXISTS,\n    message: \"This username is already taken\",\n    statusCode: 409,\n    field: \"username\",\n  }),\n  invalidCredentials: (attemptsRemaining?: number) => new AuthError({\n    code: AuthErrorCode.INVALID_CREDENTIALS,\n    message: attemptsRemaining !== undefined && attemptsRemaining > 0\n      ? `Invalid email or password. ${attemptsRemaining} attempt${attemptsRemaining > 1 ? 's' : ''} remaining.`\n      : \"Invalid email or password\",\n    statusCode: 401,\n    attemptsRemaining,\n  }),\n  accountLocked: (minutesRemaining: number) => new AuthError({\n    code: AuthErrorCode.ACCOUNT_LOCKED,\n    message: `Account is temporarily locked. Please try again in ${minutesRemaining} minute${minutesRemaining > 1 ? 's' : ''}.`,\n    statusCode: 403,\n    lockoutMinutes: minutesRemaining,\n  }),\n  accountInactive: () => new AuthError({\n    code: AuthErrorCode.ACCOUNT_INACTIVE,\n    message: \"Account has been deactivated. Please contact support.\",\n    statusCode: 403,\n  }),\n  oauthOnlyAccount: () => new AuthError({\n    code: AuthErrorCode.OAUTH_ONLY_ACCOUNT,\n    message: \"This account uses social login. Please sign in with your connected provider.\",\n    statusCode: 400,\n  }),\n  sessionError: () => new AuthError({\n    code: AuthErrorCode.SESSION_ERROR,\n    message: \"Session error occurred. Please try logging in again.\",\n    statusCode: 500,\n    retryable: true,\n  }),\n  rateLimited: () => new AuthError({\n    code: AuthErrorCode.RATE_LIMITED,\n    message: \"Too many requests. Please wait before trying again.\",\n    statusCode: 429,\n    retryable: true,\n  }),\n  oauthConflict: (provider: string) => new AuthError({\n    code: AuthErrorCode.OAUTH_CONFLICT,\n    message: `This email is already associated with a different account. Please sign in with your original method or link your ${provider} account from settings.`,\n    statusCode: 409,\n  }),\n  providerError: (provider: string) => new AuthError({\n    code: AuthErrorCode.PROVIDER_ERROR,\n    message: `Failed to authenticate with ${provider}. Please try again.`,\n    statusCode: 502,\n    retryable: true,\n  }),\n};\n","path":null,"size_bytes":23705,"size_tokens":null},"client/src/components/auth/auth-layout.tsx":{"content":"import { motion } from \"framer-motion\";\nimport { useEffect, useState, useCallback, useMemo } from \"react\";\nimport { Keyboard, Sparkles } from \"lucide-react\";\nimport { PLATFORM_STATS, formatNumber } from \"@shared/platform-stats\";\n\ninterface Particle {\n  id: number;\n  x: number;\n  y: number;\n  size: number;\n  duration: number;\n  delay: number;\n  color: string;\n}\n\nfunction FloatingParticles() {\n  const particles = useMemo(() => {\n    const colors = [\n      \"bg-primary/30\",\n      \"bg-purple-500/30\",\n      \"bg-blue-500/20\",\n      \"bg-pink-500/20\",\n    ];\n    return Array.from({ length: 50 }, (_, i) => ({\n      id: i,\n      x: Math.random() * 100,\n      y: Math.random() * 100,\n      size: Math.random() * 6 + 2,\n      duration: Math.random() * 15 + 10,\n      delay: Math.random() * 5,\n      color: colors[Math.floor(Math.random() * colors.length)],\n    }));\n  }, []);\n\n  return (\n    <div className=\"absolute inset-0 overflow-hidden pointer-events-none\">\n      {particles.map((particle) => (\n        <motion.div\n          key={particle.id}\n          className={`absolute rounded-full ${particle.color}`}\n          style={{\n            left: `${particle.x}%`,\n            top: `${particle.y}%`,\n            width: particle.size,\n            height: particle.size,\n            filter: \"blur(1px)\",\n          }}\n          animate={{\n            y: [0, -50, 0],\n            x: [0, 25, -25, 0],\n            opacity: [0.3, 0.7, 0.3],\n            scale: [1, 1.5, 1],\n          }}\n          transition={{\n            duration: particle.duration,\n            delay: particle.delay,\n            repeat: Infinity,\n            ease: \"easeInOut\",\n          }}\n        />\n      ))}\n    </div>\n  );\n}\n\nfunction PulsingOrbs() {\n  return (\n    <div className=\"absolute inset-0 overflow-hidden pointer-events-none\">\n      <motion.div\n        className=\"absolute w-[600px] h-[600px] rounded-full\"\n        style={{\n          background: \"radial-gradient(circle, hsl(var(--primary) / 0.15) 0%, transparent 70%)\",\n          left: \"-20%\",\n          top: \"-20%\",\n        }}\n        animate={{\n          scale: [1, 1.2, 1],\n          opacity: [0.3, 0.5, 0.3],\n        }}\n        transition={{\n          duration: 8,\n          repeat: Infinity,\n          ease: \"easeInOut\",\n        }}\n      />\n      <motion.div\n        className=\"absolute w-[500px] h-[500px] rounded-full\"\n        style={{\n          background: \"radial-gradient(circle, hsl(262 83% 58% / 0.12) 0%, transparent 70%)\",\n          right: \"-15%\",\n          bottom: \"-15%\",\n        }}\n        animate={{\n          scale: [1.2, 1, 1.2],\n          opacity: [0.4, 0.6, 0.4],\n        }}\n        transition={{\n          duration: 10,\n          repeat: Infinity,\n          ease: \"easeInOut\",\n          delay: 2,\n        }}\n      />\n      <motion.div\n        className=\"absolute w-[400px] h-[400px] rounded-full\"\n        style={{\n          background: \"radial-gradient(circle, hsl(280 70% 50% / 0.1) 0%, transparent 70%)\",\n          left: \"50%\",\n          top: \"50%\",\n          transform: \"translate(-50%, -50%)\",\n        }}\n        animate={{\n          scale: [1, 1.3, 1],\n          opacity: [0.2, 0.4, 0.2],\n        }}\n        transition={{\n          duration: 12,\n          repeat: Infinity,\n          ease: \"easeInOut\",\n          delay: 4,\n        }}\n      />\n    </div>\n  );\n}\n\nfunction AnimatedBackground() {\n  const [mousePosition, setMousePosition] = useState({ x: 50, y: 50 });\n\n  const handleMouseMove = useCallback((e: MouseEvent) => {\n    const x = (e.clientX / window.innerWidth) * 100;\n    const y = (e.clientY / window.innerHeight) * 100;\n    setMousePosition({ x, y });\n  }, []);\n\n  useEffect(() => {\n    window.addEventListener(\"mousemove\", handleMouseMove);\n    return () => window.removeEventListener(\"mousemove\", handleMouseMove);\n  }, [handleMouseMove]);\n\n  return (\n    <div className=\"absolute inset-0 overflow-hidden\">\n      <motion.div\n        className=\"absolute inset-0\"\n        style={{\n          background: `\n            radial-gradient(\n              ellipse 100% 80% at ${mousePosition.x}% ${mousePosition.y}%,\n              hsl(var(--primary) / 0.2) 0%,\n              transparent 50%\n            ),\n            radial-gradient(\n              ellipse 80% 100% at ${100 - mousePosition.x}% ${100 - mousePosition.y}%,\n              hsl(262 83% 58% / 0.15) 0%,\n              transparent 50%\n            ),\n            linear-gradient(\n              180deg,\n              hsl(var(--background)) 0%,\n              hsl(240 10% 4%) 50%,\n              hsl(var(--background)) 100%\n            )\n          `,\n        }}\n        animate={{\n          opacity: [1, 0.9, 1],\n        }}\n        transition={{\n          duration: 3,\n          repeat: Infinity,\n          ease: \"easeInOut\",\n        }}\n      />\n      <PulsingOrbs />\n      <FloatingParticles />\n      <div \n        className=\"absolute inset-0 opacity-[0.02]\"\n        style={{\n          backgroundImage: `url(\"data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E\")`,\n        }}\n      />\n    </div>\n  );\n}\n\ninterface AuthLayoutProps {\n  children: React.ReactNode;\n  title: string;\n  subtitle: string;\n}\n\nexport function AuthLayout({ children, title, subtitle }: AuthLayoutProps) {\n  return (\n    <div className=\"min-h-screen relative flex items-center justify-center p-4 overflow-hidden\">\n      <AnimatedBackground />\n      \n      <div className=\"w-full max-w-5xl relative z-10 grid lg:grid-cols-2 gap-8 lg:gap-12 items-center\">\n        <motion.div\n          className=\"hidden lg:flex flex-col gap-8\"\n          initial={{ opacity: 0, x: -50 }}\n          animate={{ opacity: 1, x: 0 }}\n          transition={{ duration: 0.8, ease: \"easeOut\" }}\n        >\n          <motion.div \n            className=\"flex items-center gap-4\"\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.2, duration: 0.6 }}\n          >\n            <motion.div \n              className=\"relative h-24\"\n              whileHover={{ scale: 1.05 }}\n              transition={{ type: \"spring\", stiffness: 400 }}\n            >\n              <img \n                src=\"/logo-horizontal.svg\" \n                alt=\"TypeMasterAI Logo\" \n                className=\"h-24 w-auto object-contain drop-shadow-[0_0_20px_rgba(0,255,255,0.3)]\"\n              />\n            </motion.div>\n            <div>\n              <p className=\"text-sm text-muted-foreground flex items-center gap-1\">\n                <Sparkles className=\"w-3 h-3 text-primary\" />\n                Master your typing skills\n              </p>\n            </div>\n          </motion.div>\n\n          <motion.div\n            className=\"space-y-6\"\n            initial={{ opacity: 0, y: 30 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.4, duration: 0.6 }}\n          >\n            <h1 className=\"text-4xl lg:text-5xl font-bold leading-tight\">\n              <motion.span \n                className=\"bg-gradient-to-r from-white via-zinc-200 to-zinc-400 bg-clip-text text-transparent inline-block\"\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                transition={{ delay: 0.5, duration: 0.6 }}\n              >\n                {title}\n              </motion.span>\n            </h1>\n            <motion.p \n              className=\"text-lg text-muted-foreground leading-relaxed max-w-md\"\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              transition={{ delay: 0.7, duration: 0.6 }}\n            >\n              {subtitle}\n            </motion.p>\n          </motion.div>\n\n          <motion.div\n            className=\"grid grid-cols-2 gap-4 mt-4\"\n            initial={{ opacity: 0, y: 30 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.6, duration: 0.6 }}\n          >\n            <StatCard value={formatNumber(PLATFORM_STATS.TOTAL_TESTS)} label=\"Tests Completed\" delay={0.7} />\n            <StatCard value={formatNumber(PLATFORM_STATS.TOTAL_USERS)} label=\"Active Users\" delay={0.8} />\n          </motion.div>\n\n          <motion.div\n            className=\"flex flex-wrap gap-3 mt-2\"\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            transition={{ delay: 1, duration: 0.6 }}\n          >\n            <FeatureTag icon=\"ðŸŽ¯\" text=\"AI-Powered Practice\" delay={0} />\n            <FeatureTag icon=\"ðŸ†\" text=\"Global Leaderboards\" delay={0.1} />\n            <FeatureTag icon=\"ðŸ“Š\" text=\"Advanced Analytics\" delay={0.2} />\n            <FeatureTag icon=\"ðŸŽ®\" text=\"Multiplayer Racing\" delay={0.3} />\n          </motion.div>\n        </motion.div>\n\n        <motion.div\n          className=\"flex flex-col items-center lg:items-end\"\n          initial={{ opacity: 0, y: 30 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ duration: 0.6, delay: 0.2 }}\n        >\n          <div className=\"lg:hidden flex flex-col items-center gap-4 mb-8\">\n            <motion.div \n              className=\"relative h-18\"\n              initial={{ scale: 0 }}\n              animate={{ scale: 1 }}\n              transition={{ type: \"spring\", stiffness: 300, delay: 0.1 }}\n            >\n              <img \n                src=\"/logo-horizontal.svg\" \n                alt=\"TypeMasterAI Logo\" \n                className=\"h-18 w-auto object-contain drop-shadow-[0_0_20px_rgba(0,255,255,0.3)]\"\n              />\n            </motion.div>\n            <div className=\"text-center\">\n              <h1 className=\"text-2xl font-bold\">{title}</h1>\n              <p className=\"text-sm text-muted-foreground mt-1\">{subtitle}</p>\n            </div>\n          </div>\n          {children}\n        </motion.div>\n      </div>\n    </div>\n  );\n}\n\nfunction StatCard({ value, label, delay }: { value: string; label: string; delay: number }) {\n  return (\n    <motion.div\n      className=\"relative bg-zinc-900/50 backdrop-blur-sm border border-zinc-800 rounded-xl p-4 text-center overflow-hidden group cursor-default\"\n      initial={{ opacity: 0, scale: 0.9 }}\n      animate={{ opacity: 1, scale: 1 }}\n      transition={{ delay, duration: 0.5, type: \"spring\" }}\n      whileHover={{ scale: 1.05, borderColor: \"hsl(var(--primary) / 0.5)\" }}\n    >\n      <motion.div\n        className=\"absolute inset-0 bg-gradient-to-r from-primary/10 via-purple-500/10 to-primary/10\"\n        initial={{ x: \"-100%\" }}\n        whileHover={{ x: \"100%\" }}\n        transition={{ duration: 0.6 }}\n      />\n      <motion.div\n        className=\"absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300\"\n        style={{\n          background: \"radial-gradient(circle at center, hsl(var(--primary) / 0.1) 0%, transparent 70%)\",\n        }}\n      />\n      <motion.div \n        className=\"text-2xl font-bold bg-gradient-to-r from-primary to-purple-400 bg-clip-text text-transparent relative z-10\"\n        animate={{ \n          scale: [1, 1.02, 1],\n        }}\n        transition={{ duration: 2, repeat: Infinity }}\n      >\n        {value}\n      </motion.div>\n      <div className=\"text-xs text-muted-foreground mt-1 relative z-10\">{label}</div>\n    </motion.div>\n  );\n}\n\nfunction FeatureTag({ icon, text, delay }: { icon: string; text: string; delay: number }) {\n  return (\n    <motion.div\n      className=\"flex items-center gap-2 bg-zinc-900/60 backdrop-blur-sm border border-zinc-800 rounded-full px-3 py-1.5 text-sm cursor-default group\"\n      initial={{ opacity: 0, x: -20 }}\n      animate={{ opacity: 1, x: 0 }}\n      transition={{ delay: 1 + delay, duration: 0.4 }}\n      whileHover={{ scale: 1.08, borderColor: \"hsl(var(--primary) / 0.5)\" }}\n    >\n      <motion.span\n        animate={{ rotate: [0, 10, -10, 0] }}\n        transition={{ duration: 2, repeat: Infinity, delay: delay }}\n      >\n        {icon}\n      </motion.span>\n      <span className=\"text-zinc-300 group-hover:text-white transition-colors\">{text}</span>\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":12132,"size_tokens":null},"client/src/components/auth/index.ts":{"content":"export { AuthLayout } from \"./auth-layout\";\nexport { AuthPanel, AuthPanelHeader, AuthPanelContent, AuthPanelFooter } from \"./auth-panel\";\nexport { AuthInput, PasswordStrengthMeter, CapsLockWarning } from \"./auth-input\";\nexport { SocialButton, SubmitButton, AuthDivider, AuthLink } from \"./auth-buttons\";\n","path":null,"size_bytes":304,"size_tokens":null},"client/src/components/auth/auth-buttons.tsx":{"content":"import { motion, AnimatePresence } from \"framer-motion\";\nimport { useState } from \"react\";\nimport { cn } from \"@/lib/utils\";\nimport { Github, Loader2, Check, ArrowRight, Sparkles } from \"lucide-react\";\n\nfunction GoogleIcon({ className }: { className?: string }) {\n  return (\n    <svg className={className} viewBox=\"0 0 24 24\" fill=\"currentColor\">\n      <path d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\" fill=\"#4285F4\"/>\n      <path d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\" fill=\"#34A853\"/>\n      <path d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z\" fill=\"#FBBC05\"/>\n      <path d=\"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\" fill=\"#EA4335\"/>\n    </svg>\n  );\n}\n\nfunction FacebookIcon({ className }: { className?: string }) {\n  return (\n    <svg className={className} viewBox=\"0 0 24 24\" fill=\"#1877F2\">\n      <path d=\"M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z\"/>\n    </svg>\n  );\n}\n\ninterface SocialButtonProps {\n  provider: \"google\" | \"github\" | \"facebook\";\n  onClick: () => void;\n  isRegister?: boolean;\n  delay?: number;\n  disabled?: boolean;\n}\n\nexport function SocialButton({ provider, onClick, isRegister = false, delay = 0, disabled }: SocialButtonProps) {\n  const [isHovered, setIsHovered] = useState(false);\n  \n  const config = {\n    google: {\n      icon: <GoogleIcon className=\"w-5 h-5\" />,\n      label: isRegister ? \"Sign up with Google\" : \"Continue with Google\",\n      hoverBorder: \"group-hover:border-blue-500/50\",\n      glowColor: \"rgba(66, 133, 244, 0.3)\",\n    },\n    github: {\n      icon: <Github className=\"w-5 h-5\" />,\n      label: isRegister ? \"Sign up with GitHub\" : \"Continue with GitHub\",\n      hoverBorder: \"group-hover:border-zinc-500/50\",\n      glowColor: \"rgba(255, 255, 255, 0.15)\",\n    },\n    facebook: {\n      icon: <FacebookIcon className=\"w-5 h-5\" />,\n      label: isRegister ? \"Sign up with Facebook\" : \"Continue with Facebook\",\n      hoverBorder: \"group-hover:border-blue-600/50\",\n      glowColor: \"rgba(24, 119, 242, 0.3)\",\n    },\n  };\n\n  const { icon, label, hoverBorder, glowColor } = config[provider];\n\n  return (\n    <motion.button\n      type=\"button\"\n      className={cn(\n        \"group relative w-full h-12 flex items-center justify-center gap-3\",\n        \"bg-zinc-900/60 border border-zinc-800 rounded-lg\",\n        \"text-sm font-medium text-zinc-200\",\n        \"transition-all duration-300\",\n        \"hover:bg-zinc-800/80\",\n        \"disabled:opacity-50 disabled:cursor-not-allowed\",\n        \"overflow-hidden\"\n      )}\n      onClick={onClick}\n      disabled={disabled}\n      onHoverStart={() => setIsHovered(true)}\n      onHoverEnd={() => setIsHovered(false)}\n      initial={{ opacity: 0, y: 15, scale: 0.95 }}\n      animate={{ opacity: 1, y: 0, scale: 1 }}\n      transition={{ delay: delay * 0.08, duration: 0.4 }}\n      whileHover={{ scale: 1.02, y: -2 }}\n      whileTap={{ scale: 0.98 }}\n    >\n      <motion.div\n        className=\"absolute inset-0 rounded-lg\"\n        animate={isHovered ? { \n          boxShadow: `0 0 30px ${glowColor}`,\n          opacity: 1,\n        } : { \n          boxShadow: \"0 0 0px transparent\",\n          opacity: 0,\n        }}\n        transition={{ duration: 0.3 }}\n      />\n      \n      <motion.div\n        className=\"absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent\"\n        initial={{ x: \"-200%\" }}\n        animate={isHovered ? { x: \"200%\" } : { x: \"-200%\" }}\n        transition={{ duration: 0.6 }}\n      />\n      \n      <motion.div\n        className={cn(\"absolute inset-0 border rounded-lg transition-colors duration-300\", hoverBorder)}\n        style={{ borderColor: \"transparent\" }}\n      />\n      \n      <motion.span \n        className=\"relative z-10\"\n        animate={isHovered ? { scale: 1.1, rotate: 5 } : { scale: 1, rotate: 0 }}\n        transition={{ duration: 0.2 }}\n      >\n        {icon}\n      </motion.span>\n      <span className=\"relative z-10\">{label}</span>\n    </motion.button>\n  );\n}\n\ninterface SubmitButtonProps {\n  isLoading?: boolean;\n  isSuccess?: boolean;\n  children: React.ReactNode;\n  disabled?: boolean;\n}\n\nexport function SubmitButton({ isLoading, isSuccess, children, disabled }: SubmitButtonProps) {\n  const [isHovered, setIsHovered] = useState(false);\n  \n  return (\n    <motion.button\n      type=\"submit\"\n      className={cn(\n        \"relative w-full h-12 flex items-center justify-center gap-2\",\n        \"bg-gradient-to-r from-primary via-purple-600 to-primary\",\n        \"text-white font-semibold rounded-lg\",\n        \"transition-all duration-300\",\n        \"disabled:opacity-50 disabled:cursor-not-allowed\",\n        \"overflow-hidden group\"\n      )}\n      style={{ backgroundSize: \"200% 100%\" }}\n      disabled={disabled || isLoading}\n      onHoverStart={() => setIsHovered(true)}\n      onHoverEnd={() => setIsHovered(false)}\n      whileHover={{ scale: disabled ? 1 : 1.02, y: disabled ? 0 : -2 }}\n      whileTap={{ scale: disabled ? 1 : 0.98 }}\n      initial={{ opacity: 0, y: 15 }}\n      animate={{ \n        opacity: 1, \n        y: 0,\n        backgroundPosition: isHovered ? [\"0% 50%\", \"100% 50%\"] : \"0% 50%\",\n      }}\n      transition={{ \n        duration: 0.4,\n        backgroundPosition: { duration: 0.5 },\n      }}\n    >\n      <motion.div\n        className=\"absolute inset-0 rounded-lg\"\n        animate={{\n          boxShadow: isHovered \n            ? \"0 0 40px hsl(var(--primary) / 0.5), 0 0 80px hsl(var(--primary) / 0.3)\"\n            : \"0 0 20px hsl(var(--primary) / 0.3)\",\n        }}\n        transition={{ duration: 0.3 }}\n      />\n      \n      <motion.div\n        className=\"absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent\"\n        initial={{ x: \"-100%\" }}\n        animate={{ x: \"200%\" }}\n        transition={{ \n          duration: 1.5, \n          repeat: Infinity, \n          repeatDelay: 2,\n          ease: \"easeInOut\" \n        }}\n      />\n      \n      <motion.div\n        className=\"absolute inset-0\"\n        style={{\n          background: \"radial-gradient(circle at center, hsl(var(--primary) / 0.3) 0%, transparent 70%)\",\n        }}\n        animate={{\n          scale: [1, 1.5, 1],\n          opacity: [0.3, 0.6, 0.3],\n        }}\n        transition={{\n          duration: 2,\n          repeat: Infinity,\n          ease: \"easeInOut\",\n        }}\n      />\n\n      <AnimatePresence mode=\"wait\">\n        <motion.span \n          key={isLoading ? \"loading\" : isSuccess ? \"success\" : \"default\"}\n          className=\"relative z-10 flex items-center gap-2\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          exit={{ opacity: 0, y: -10 }}\n          transition={{ duration: 0.2 }}\n        >\n          {isLoading ? (\n            <>\n              <motion.div\n                animate={{ rotate: 360 }}\n                transition={{ duration: 1, repeat: Infinity, ease: \"linear\" }}\n              >\n                <Loader2 className=\"h-5 w-5\" />\n              </motion.div>\n              <span>Please wait...</span>\n            </>\n          ) : isSuccess ? (\n            <>\n              <motion.div\n                initial={{ scale: 0, rotate: -180 }}\n                animate={{ scale: 1, rotate: 0 }}\n                transition={{ type: \"spring\", stiffness: 500, damping: 15 }}\n              >\n                <Check className=\"h-5 w-5\" />\n              </motion.div>\n              <span>Success!</span>\n              <motion.div\n                initial={{ opacity: 0 }}\n                animate={{ opacity: 1 }}\n              >\n                <Sparkles className=\"h-4 w-4\" />\n              </motion.div>\n            </>\n          ) : (\n            <>\n              {children}\n              <motion.div\n                animate={{ x: isHovered ? 5 : 0 }}\n                transition={{ duration: 0.2 }}\n              >\n                <ArrowRight className=\"h-4 w-4\" />\n              </motion.div>\n            </>\n          )}\n        </motion.span>\n      </AnimatePresence>\n    </motion.button>\n  );\n}\n\ninterface AuthDividerProps {\n  text?: string;\n}\n\nexport function AuthDivider({ text = \"Or continue with email\" }: AuthDividerProps) {\n  return (\n    <motion.div \n      className=\"relative my-6\"\n      initial={{ opacity: 0, scaleX: 0 }}\n      animate={{ opacity: 1, scaleX: 1 }}\n      transition={{ delay: 0.3, duration: 0.5 }}\n    >\n      <div className=\"absolute inset-0 flex items-center\">\n        <motion.div \n          className=\"w-full border-t border-zinc-800\"\n          initial={{ scaleX: 0 }}\n          animate={{ scaleX: 1 }}\n          transition={{ delay: 0.4, duration: 0.6 }}\n        />\n      </div>\n      <div className=\"relative flex justify-center text-xs uppercase\">\n        <motion.span \n          className=\"bg-zinc-950 px-3 text-muted-foreground\"\n          initial={{ opacity: 0, y: 10 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.5, duration: 0.4 }}\n        >\n          {text}\n        </motion.span>\n      </div>\n    </motion.div>\n  );\n}\n\ninterface AuthLinkProps {\n  text: string;\n  linkText: string;\n  onClick: () => void;\n  testId?: string;\n}\n\nexport function AuthLink({ text, linkText, onClick, testId }: AuthLinkProps) {\n  const [isHovered, setIsHovered] = useState(false);\n  \n  return (\n    <motion.p \n      className=\"text-sm text-center text-muted-foreground\"\n      initial={{ opacity: 0, y: 10 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ delay: 0.6, duration: 0.4 }}\n    >\n      {text}{\" \"}\n      <motion.button\n        type=\"button\"\n        onClick={onClick}\n        className=\"text-primary hover:text-primary/80 font-medium transition-colors relative\"\n        data-testid={testId}\n        onHoverStart={() => setIsHovered(true)}\n        onHoverEnd={() => setIsHovered(false)}\n        whileHover={{ scale: 1.05 }}\n        whileTap={{ scale: 0.95 }}\n      >\n        <motion.span\n          animate={isHovered ? { \n            textShadow: \"0 0 10px hsl(var(--primary) / 0.5)\",\n          } : {\n            textShadow: \"0 0 0px transparent\",\n          }}\n        >\n          {linkText}\n        </motion.span>\n        <motion.span\n          className=\"absolute -bottom-0.5 left-0 right-0 h-px bg-gradient-to-r from-primary via-purple-500 to-primary\"\n          initial={{ scaleX: 0 }}\n          animate={{ scaleX: isHovered ? 1 : 0 }}\n          transition={{ duration: 0.2 }}\n        />\n      </motion.button>\n    </motion.p>\n  );\n}\n","path":null,"size_bytes":10898,"size_tokens":null},"client/src/components/auth/auth-panel.tsx":{"content":"import { motion } from \"framer-motion\";\nimport { cn } from \"@/lib/utils\";\n\ninterface AuthPanelProps {\n  children: React.ReactNode;\n  className?: string;\n}\n\nexport function AuthPanel({ children, className }: AuthPanelProps) {\n  return (\n    <motion.div\n      className={cn(\n        \"w-full max-w-md relative group\",\n        className\n      )}\n      initial={{ opacity: 0, y: 30, scale: 0.95 }}\n      animate={{ opacity: 1, y: 0, scale: 1 }}\n      transition={{ duration: 0.6, ease: \"easeOut\" }}\n    >\n      <motion.div \n        className=\"absolute -inset-1 bg-gradient-to-r from-primary/40 via-purple-500/30 to-pink-500/40 rounded-2xl blur-xl\"\n        animate={{\n          opacity: [0.4, 0.6, 0.4],\n          scale: [1, 1.02, 1],\n        }}\n        transition={{\n          duration: 3,\n          repeat: Infinity,\n          ease: \"easeInOut\",\n        }}\n      />\n      \n      <motion.div \n        className=\"absolute -inset-0.5 rounded-2xl overflow-hidden\"\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        transition={{ delay: 0.3 }}\n      >\n        <motion.div\n          className=\"absolute inset-0 bg-gradient-to-r from-primary via-purple-500 to-primary\"\n          animate={{\n            backgroundPosition: [\"0% 50%\", \"100% 50%\", \"0% 50%\"],\n          }}\n          transition={{\n            duration: 5,\n            repeat: Infinity,\n            ease: \"linear\",\n          }}\n          style={{ backgroundSize: \"200% 200%\", opacity: 0.3 }}\n        />\n      </motion.div>\n      \n      <div className=\"relative bg-zinc-950/90 backdrop-blur-xl border border-zinc-800/50 rounded-2xl shadow-2xl shadow-black/50 overflow-hidden\">\n        <motion.div \n          className=\"absolute inset-0 bg-gradient-to-br from-zinc-900/60 via-transparent to-zinc-900/40 pointer-events-none\"\n          animate={{\n            opacity: [0.5, 0.7, 0.5],\n          }}\n          transition={{\n            duration: 4,\n            repeat: Infinity,\n            ease: \"easeInOut\",\n          }}\n        />\n        \n        <motion.div \n          className=\"absolute top-0 left-0 right-0 h-px\"\n          style={{\n            background: \"linear-gradient(90deg, transparent, hsl(var(--primary) / 0.5), hsl(262 83% 58% / 0.5), transparent)\",\n          }}\n          animate={{\n            opacity: [0.5, 1, 0.5],\n          }}\n          transition={{\n            duration: 2,\n            repeat: Infinity,\n            ease: \"easeInOut\",\n          }}\n        />\n        \n        <motion.div\n          className=\"absolute inset-0 bg-gradient-to-r from-transparent via-white/[0.03] to-transparent\"\n          initial={{ x: \"-100%\" }}\n          animate={{ x: \"200%\" }}\n          transition={{\n            duration: 3,\n            repeat: Infinity,\n            repeatDelay: 5,\n            ease: \"easeInOut\",\n          }}\n        />\n        \n        <div className=\"relative z-10\">\n          {children}\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\ninterface AuthPanelHeaderProps {\n  title: string;\n  description: string;\n}\n\nexport function AuthPanelHeader({ title, description }: AuthPanelHeaderProps) {\n  return (\n    <motion.div \n      className=\"p-6 pb-2\"\n      initial={{ opacity: 0, y: 15 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ delay: 0.3, duration: 0.5 }}\n    >\n      <motion.h2 \n        className=\"text-2xl font-bold bg-gradient-to-r from-white via-zinc-200 to-zinc-400 bg-clip-text text-transparent\"\n        initial={{ opacity: 0, x: -20 }}\n        animate={{ opacity: 1, x: 0 }}\n        transition={{ delay: 0.4, duration: 0.5 }}\n      >\n        {title}\n      </motion.h2>\n      <motion.p \n        className=\"text-sm text-muted-foreground mt-1\"\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        transition={{ delay: 0.5, duration: 0.4 }}\n      >\n        {description}\n      </motion.p>\n    </motion.div>\n  );\n}\n\ninterface AuthPanelContentProps {\n  children: React.ReactNode;\n}\n\nexport function AuthPanelContent({ children }: AuthPanelContentProps) {\n  return (\n    <motion.div \n      className=\"p-6 pt-4 space-y-4\"\n      initial={{ opacity: 0 }}\n      animate={{ opacity: 1 }}\n      transition={{ delay: 0.4, duration: 0.5 }}\n    >\n      {children}\n    </motion.div>\n  );\n}\n\ninterface AuthPanelFooterProps {\n  children: React.ReactNode;\n}\n\nexport function AuthPanelFooter({ children }: AuthPanelFooterProps) {\n  return (\n    <motion.div \n      className=\"p-6 pt-2\"\n      initial={{ opacity: 0, y: 10 }}\n      animate={{ opacity: 1, y: 0 }}\n      transition={{ delay: 0.6, duration: 0.5 }}\n    >\n      {children}\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":4583,"size_tokens":null},"client/src/components/auth/auth-input.tsx":{"content":"import { motion, AnimatePresence } from \"framer-motion\";\nimport { useState, forwardRef } from \"react\";\nimport { cn } from \"@/lib/utils\";\nimport { HelpCircle, Eye, EyeOff, Check, X, AlertTriangle } from \"lucide-react\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\n\ninterface AuthInputProps extends React.InputHTMLAttributes<HTMLInputElement> {\n  label: string;\n  tooltip?: string;\n  error?: string;\n  success?: boolean;\n  icon?: React.ReactNode;\n  delay?: number;\n}\n\nexport const AuthInput = forwardRef<HTMLInputElement, AuthInputProps>(\n  ({ label, tooltip, error, success, icon, delay = 0, className, type, ...props }, ref) => {\n    const [isFocused, setIsFocused] = useState(false);\n    const [showPassword, setShowPassword] = useState(false);\n    \n    const isPassword = type === \"password\";\n    const inputType = isPassword ? (showPassword ? \"text\" : \"password\") : type;\n\n    return (\n      <motion.div\n        className=\"space-y-2\"\n        initial={{ opacity: 0, x: -30 }}\n        animate={{ opacity: 1, x: 0 }}\n        transition={{ delay: delay * 0.08, duration: 0.5, ease: \"easeOut\" }}\n      >\n        <div className=\"flex items-center gap-1.5\">\n          <motion.label \n            className=\"text-sm font-medium text-zinc-300\"\n            animate={isFocused ? { color: \"hsl(var(--primary))\" } : { color: \"rgb(212 212 216)\" }}\n            transition={{ duration: 0.2 }}\n          >\n            {label}\n          </motion.label>\n          {tooltip && (\n            <TooltipProvider>\n              <Tooltip>\n                <TooltipTrigger type=\"button\" tabIndex={-1}>\n                  <HelpCircle className=\"h-3.5 w-3.5 text-muted-foreground hover:text-foreground transition-colors\" />\n                </TooltipTrigger>\n                <TooltipContent side=\"right\">\n                  <p>{tooltip}</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n          )}\n          <AnimatePresence mode=\"wait\">\n            {error && (\n              <motion.span\n                className=\"text-xs text-red-400 ml-auto flex items-center gap-1\"\n                initial={{ opacity: 0, scale: 0.8, x: 10 }}\n                animate={{ opacity: 1, scale: 1, x: 0 }}\n                exit={{ opacity: 0, scale: 0.8, x: 10 }}\n              >\n                <X className=\"h-3 w-3\" />\n                {error}\n              </motion.span>\n            )}\n            {success && !error && (\n              <motion.span\n                className=\"ml-auto\"\n                initial={{ opacity: 0, scale: 0, rotate: -180 }}\n                animate={{ opacity: 1, scale: 1, rotate: 0 }}\n                exit={{ opacity: 0, scale: 0 }}\n                transition={{ type: \"spring\", stiffness: 500, damping: 15 }}\n              >\n                <Check className=\"h-4 w-4 text-green-500\" />\n              </motion.span>\n            )}\n          </AnimatePresence>\n        </div>\n        \n        <div className=\"relative group\">\n          <motion.div\n            className={cn(\n              \"absolute -inset-0.5 rounded-lg blur-md transition-all duration-300\",\n              error ? \"bg-red-500/40\" : \"bg-primary/50\"\n            )}\n            animate={isFocused ? { opacity: 0.7, scale: 1 } : { opacity: 0, scale: 0.95 }}\n            transition={{ duration: 0.2 }}\n          />\n          \n          <motion.div\n            className=\"absolute -inset-px rounded-lg overflow-hidden pointer-events-none\"\n            animate={isFocused ? { opacity: 1 } : { opacity: 0 }}\n          >\n            <motion.div\n              className={cn(\n                \"absolute inset-0\",\n                error \n                  ? \"bg-gradient-to-r from-red-500/30 via-red-400/30 to-red-500/30\" \n                  : \"bg-gradient-to-r from-primary/30 via-purple-500/30 to-primary/30\"\n              )}\n              animate={{\n                backgroundPosition: [\"0% 50%\", \"100% 50%\", \"0% 50%\"],\n              }}\n              transition={{\n                duration: 2,\n                repeat: Infinity,\n                ease: \"linear\",\n              }}\n              style={{ backgroundSize: \"200% 200%\" }}\n            />\n          </motion.div>\n          \n          <div className=\"relative\">\n            <AnimatePresence>\n              {icon && (\n                <motion.div \n                  className=\"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground z-10\"\n                  animate={isFocused ? { \n                    color: error ? \"rgb(239 68 68)\" : \"hsl(var(--primary))\",\n                    scale: 1.1,\n                  } : { \n                    color: \"rgb(113 113 122)\",\n                    scale: 1,\n                  }}\n                  transition={{ duration: 0.2 }}\n                >\n                  {icon}\n                </motion.div>\n              )}\n            </AnimatePresence>\n            \n            <input\n              ref={ref}\n              type={inputType}\n              className={cn(\n                \"w-full h-12 bg-zinc-900/80 border rounded-lg px-4 text-sm text-white placeholder:text-zinc-500\",\n                \"focus:outline-none transition-all duration-300\",\n                \"hover:border-zinc-600 hover:bg-zinc-900\",\n                icon && \"pl-10\",\n                isPassword && \"pr-10\",\n                error \n                  ? \"border-red-500/50 focus:border-red-500\" \n                  : isFocused \n                    ? \"border-primary/70 shadow-lg shadow-primary/20\" \n                    : \"border-zinc-800\",\n                className\n              )}\n              onFocus={() => setIsFocused(true)}\n              onBlur={() => setIsFocused(false)}\n              {...props}\n            />\n            \n            {isPassword && (\n              <motion.button\n                type=\"button\"\n                tabIndex={-1}\n                className=\"absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground hover:text-foreground transition-colors z-10\"\n                onClick={() => setShowPassword(!showPassword)}\n                whileHover={{ scale: 1.1 }}\n                whileTap={{ scale: 0.9 }}\n              >\n                <AnimatePresence mode=\"wait\">\n                  {showPassword ? (\n                    <motion.div\n                      key=\"hide\"\n                      initial={{ opacity: 0, rotate: -90 }}\n                      animate={{ opacity: 1, rotate: 0 }}\n                      exit={{ opacity: 0, rotate: 90 }}\n                      transition={{ duration: 0.15 }}\n                    >\n                      <EyeOff className=\"h-4 w-4\" />\n                    </motion.div>\n                  ) : (\n                    <motion.div\n                      key=\"show\"\n                      initial={{ opacity: 0, rotate: 90 }}\n                      animate={{ opacity: 1, rotate: 0 }}\n                      exit={{ opacity: 0, rotate: -90 }}\n                      transition={{ duration: 0.15 }}\n                    >\n                      <Eye className=\"h-4 w-4\" />\n                    </motion.div>\n                  )}\n                </AnimatePresence>\n              </motion.button>\n            )}\n          </div>\n        </div>\n      </motion.div>\n    );\n  }\n);\n\nAuthInput.displayName = \"AuthInput\";\n\ninterface PasswordStrengthProps {\n  password: string;\n}\n\nexport function PasswordStrengthMeter({ password }: PasswordStrengthProps) {\n  const getStrength = (pwd: string): { score: number; label: string; color: string } => {\n    if (!pwd) return { score: 0, label: \"\", color: \"\" };\n    \n    let score = 0;\n    if (pwd.length >= 8) score++;\n    if (pwd.length >= 12) score++;\n    if (/[A-Z]/.test(pwd)) score++;\n    if (/[a-z]/.test(pwd)) score++;\n    if (/[0-9]/.test(pwd)) score++;\n    if (/[^A-Za-z0-9]/.test(pwd)) score++;\n\n    if (score <= 2) return { score: 1, label: \"Weak\", color: \"bg-red-500\" };\n    if (score <= 4) return { score: 2, label: \"Fair\", color: \"bg-yellow-500\" };\n    if (score <= 5) return { score: 3, label: \"Good\", color: \"bg-blue-500\" };\n    return { score: 4, label: \"Strong\", color: \"bg-green-500\" };\n  };\n\n  const strength = getStrength(password);\n\n  if (!password) return null;\n\n  return (\n    <motion.div\n      className=\"space-y-2\"\n      initial={{ opacity: 0, height: 0 }}\n      animate={{ opacity: 1, height: \"auto\" }}\n      exit={{ opacity: 0, height: 0 }}\n    >\n      <div className=\"flex gap-1\">\n        {[1, 2, 3, 4].map((level) => (\n          <motion.div\n            key={level}\n            className={cn(\n              \"h-1.5 flex-1 rounded-full transition-colors duration-300\",\n              level <= strength.score ? strength.color : \"bg-zinc-800\"\n            )}\n            initial={{ scaleX: 0 }}\n            animate={{ scaleX: 1 }}\n            transition={{ delay: level * 0.1, duration: 0.3 }}\n          />\n        ))}\n      </div>\n      <div className=\"flex items-center justify-between text-xs\">\n        <span className={cn(\n          \"transition-colors\",\n          strength.score === 1 && \"text-red-400\",\n          strength.score === 2 && \"text-yellow-400\",\n          strength.score === 3 && \"text-blue-400\",\n          strength.score === 4 && \"text-green-400\"\n        )}>\n          {strength.label}\n        </span>\n        <div className=\"flex flex-wrap gap-x-3 gap-y-1 text-muted-foreground\">\n          <RequirementIndicator met={password.length >= 8} text=\"8+ chars\" />\n          <RequirementIndicator met={/[A-Z]/.test(password)} text=\"Uppercase\" />\n          <RequirementIndicator met={/[a-z]/.test(password)} text=\"Lowercase\" />\n          <RequirementIndicator met={/[0-9]/.test(password)} text=\"Number\" />\n          <RequirementIndicator met={/[^A-Za-z0-9]/.test(password)} text=\"Special\" />\n        </div>\n      </div>\n    </motion.div>\n  );\n}\n\nfunction RequirementIndicator({ met, text }: { met: boolean; text: string }) {\n  return (\n    <span className={cn(\n      \"flex items-center gap-1 transition-colors\",\n      met ? \"text-green-400\" : \"text-zinc-500\"\n    )}>\n      {met ? <Check className=\"h-3 w-3\" /> : <X className=\"h-3 w-3\" />}\n      {text}\n    </span>\n  );\n}\n\ninterface CapsLockWarningProps {\n  show: boolean;\n}\n\nexport function CapsLockWarning({ show }: CapsLockWarningProps) {\n  if (!show) return null;\n  \n  return (\n    <motion.div\n      className=\"flex items-center gap-2 text-xs text-yellow-400 bg-yellow-500/10 border border-yellow-500/20 rounded-lg px-3 py-2\"\n      initial={{ opacity: 0, y: -10, scale: 0.95 }}\n      animate={{ opacity: 1, y: 0, scale: 1 }}\n      exit={{ opacity: 0, y: -10, scale: 0.95 }}\n    >\n      <motion.div\n        animate={{ rotate: [0, -10, 10, 0] }}\n        transition={{ duration: 0.5, repeat: Infinity, repeatDelay: 2 }}\n      >\n        <AlertTriangle className=\"h-4 w-4\" />\n      </motion.div>\n      Caps Lock is on\n    </motion.div>\n  );\n}\n","path":null,"size_bytes":10804,"size_tokens":null},"server/email-service.ts":{"content":"import formData from \"form-data\";\nimport Mailgun from \"mailgun.js\";\n\nexport enum EmailErrorCode {\n  INVALID_API_KEY = \"EMAIL_INVALID_API_KEY\",\n  INVALID_FROM_EMAIL = \"EMAIL_INVALID_FROM_EMAIL\",\n  INVALID_TO_EMAIL = \"EMAIL_INVALID_TO_EMAIL\",\n  RATE_LIMITED = \"EMAIL_RATE_LIMITED\",\n  SEND_FAILED = \"EMAIL_SEND_FAILED\",\n  TEMPLATE_ERROR = \"EMAIL_TEMPLATE_ERROR\",\n  NETWORK_ERROR = \"EMAIL_NETWORK_ERROR\",\n  QUOTA_EXCEEDED = \"EMAIL_QUOTA_EXCEEDED\",\n  BOUNCE_DETECTED = \"EMAIL_BOUNCE_DETECTED\",\n  SPAM_REPORTED = \"EMAIL_SPAM_REPORTED\",\n  SERVICE_UNAVAILABLE = \"EMAIL_SERVICE_UNAVAILABLE\",\n  CONFIGURATION_ERROR = \"EMAIL_CONFIGURATION_ERROR\",\n}\n\nexport interface EmailError {\n  code: EmailErrorCode;\n  message: string;\n  statusCode?: number;\n  retryable: boolean;\n  details?: Record<string, unknown>;\n}\n\nexport interface EmailSendResult {\n  success: boolean;\n  messageId?: string;\n  timestamp: Date;\n  attempts: number;\n  error?: EmailError;\n}\n\nexport interface EmailOptions {\n  to: string;\n  subject: string;\n  html: string;\n  text?: string;\n  replyTo?: string;\n  category?: string[];\n  customArgs?: Record<string, string>;\n  sendAt?: number;\n  batchId?: string;\n}\n\ninterface RateLimitEntry {\n  count: number;\n  resetAt: number;\n}\n\ninterface RetryConfig {\n  maxAttempts: number;\n  baseDelayMs: number;\n  maxDelayMs: number;\n  backoffMultiplier: number;\n}\n\nconst EMAIL_REGEX = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n\nclass EmailRateLimiter {\n  private limits: Map<string, RateLimitEntry> = new Map();\n  private readonly windowMs: number;\n  private readonly maxRequests: number;\n\n  constructor(windowMs: number = 60 * 1000, maxRequests: number = 5) {\n    this.windowMs = windowMs;\n    this.maxRequests = maxRequests;\n    setInterval(() => this.cleanup(), windowMs);\n  }\n\n  canSend(key: string): boolean {\n    const now = Date.now();\n    const entry = this.limits.get(key);\n\n    if (!entry || now >= entry.resetAt) {\n      return true;\n    }\n\n    return entry.count < this.maxRequests;\n  }\n\n  recordSend(key: string): void {\n    const now = Date.now();\n    const entry = this.limits.get(key);\n\n    if (!entry || now >= entry.resetAt) {\n      this.limits.set(key, {\n        count: 1,\n        resetAt: now + this.windowMs,\n      });\n    } else {\n      entry.count++;\n    }\n  }\n\n  getRemainingQuota(key: string): number {\n    const now = Date.now();\n    const entry = this.limits.get(key);\n\n    if (!entry || now >= entry.resetAt) {\n      return this.maxRequests;\n    }\n\n    return Math.max(0, this.maxRequests - entry.count);\n  }\n\n  getResetTime(key: string): number | null {\n    const entry = this.limits.get(key);\n    if (!entry) return null;\n    return entry.resetAt;\n  }\n\n  private cleanup(): void {\n    const now = Date.now();\n    const keys = Array.from(this.limits.keys());\n    for (const key of keys) {\n      const entry = this.limits.get(key);\n      if (entry && now >= entry.resetAt) {\n        this.limits.delete(key);\n      }\n    }\n  }\n}\n\nclass CircuitBreaker {\n  private failures: number = 0;\n  private lastFailureTime: number = 0;\n  private state: \"closed\" | \"open\" | \"half-open\" = \"closed\";\n  \n  private readonly failureThreshold: number;\n  private readonly resetTimeMs: number;\n  private readonly halfOpenRequests: number;\n  private halfOpenAttempts: number = 0;\n\n  constructor(\n    failureThreshold: number = 5,\n    resetTimeMs: number = 60 * 1000,\n    halfOpenRequests: number = 2\n  ) {\n    this.failureThreshold = failureThreshold;\n    this.resetTimeMs = resetTimeMs;\n    this.halfOpenRequests = halfOpenRequests;\n  }\n\n  canExecute(): boolean {\n    this.checkStateTransition();\n\n    if (this.state === \"open\") {\n      return false;\n    }\n\n    if (this.state === \"half-open\") {\n      return this.halfOpenAttempts < this.halfOpenRequests;\n    }\n\n    return true;\n  }\n\n  recordSuccess(): void {\n    this.failures = 0;\n    this.state = \"closed\";\n    this.halfOpenAttempts = 0;\n  }\n\n  recordFailure(): void {\n    this.failures++;\n    this.lastFailureTime = Date.now();\n\n    if (this.state === \"half-open\") {\n      this.state = \"open\";\n      this.halfOpenAttempts = 0;\n    } else if (this.failures >= this.failureThreshold) {\n      this.state = \"open\";\n    }\n  }\n\n  getState(): string {\n    this.checkStateTransition();\n    return this.state;\n  }\n\n  private checkStateTransition(): void {\n    if (this.state === \"open\") {\n      if (Date.now() - this.lastFailureTime >= this.resetTimeMs) {\n        this.state = \"half-open\";\n        this.halfOpenAttempts = 0;\n      }\n    }\n  }\n}\n\nexport class EmailService {\n  private initialized: boolean = false;\n  private readonly fromEmail: string;\n  private readonly fromName: string;\n  private readonly appUrl: string;\n  private readonly rateLimiter: EmailRateLimiter;\n  private readonly circuitBreaker: CircuitBreaker;\n  private readonly retryConfig: RetryConfig;\n  private mg: any;\n  private readonly domain: string;\n\n  constructor(options?: {\n    rateLimitWindowMs?: number;\n    rateLimitMaxRequests?: number;\n    circuitBreakerThreshold?: number;\n    circuitBreakerResetMs?: number;\n    retryMaxAttempts?: number;\n    retryBaseDelayMs?: number;\n    retryMaxDelayMs?: number;\n    retryBackoffMultiplier?: number;\n  }) {\n    const apiKey = process.env.MAILGUN_API_KEY;\n    this.fromEmail = process.env.MAILGUN_FROM_EMAIL || \"no-reply@typemasterai.com\";\n    this.fromName = process.env.MAILGUN_FROM_NAME || \"TypeMasterAI\";\n    this.domain = process.env.MAILGUN_DOMAIN || \"sandbox3f76c67c33064dd69234ec4b94f9895c.mailgun.org\";\n    this.appUrl = process.env.APP_URL || \"https://typemasterai.com\";\n\n    if (apiKey) {\n      const mailgun = new Mailgun(formData);\n      this.mg = mailgun.client({\n        username: 'api',\n        key: apiKey,\n        url: 'https://api.mailgun.net'\n      });\n      this.initialized = true;\n      console.log(\"[EmailService] Initialized with Mailgun API\");\n      console.log(`[EmailService] From Email: ${this.fromEmail}`);\n      console.log(`[EmailService] From Name: ${this.fromName}`);\n      console.log(`[EmailService] Domain: ${this.domain}`);\n    } else {\n      console.warn(\"[EmailService] No Mailgun API key found - emails will be logged only\");\n    }\n\n    this.rateLimiter = new EmailRateLimiter(\n      options?.rateLimitWindowMs ?? 60 * 1000,\n      options?.rateLimitMaxRequests ?? 5\n    );\n\n    this.circuitBreaker = new CircuitBreaker(\n      options?.circuitBreakerThreshold ?? 5,\n      options?.circuitBreakerResetMs ?? 60 * 1000\n    );\n\n    this.retryConfig = {\n      maxAttempts: options?.retryMaxAttempts ?? 3,\n      baseDelayMs: options?.retryBaseDelayMs ?? 1000,\n      maxDelayMs: options?.retryMaxDelayMs ?? 30000,\n      backoffMultiplier: options?.retryBackoffMultiplier ?? 2,\n    };\n  }\n\n  private validateEmail(email: string): boolean {\n    if (!email || typeof email !== \"string\") return false;\n    if (email.length > 254) return false;\n    return EMAIL_REGEX.test(email);\n  }\n\n  private sanitizeEmail(email: string): string {\n    return email.toLowerCase().trim();\n  }\n\n  private async sleep(ms: number): Promise<void> {\n    return new Promise((resolve) => setTimeout(resolve, ms));\n  }\n\n  private calculateBackoff(attempt: number): number {\n    const delay = this.retryConfig.baseDelayMs * Math.pow(this.retryConfig.backoffMultiplier, attempt - 1);\n    const jitter = delay * 0.2 * Math.random();\n    return Math.min(delay + jitter, this.retryConfig.maxDelayMs);\n  }\n\n  private mapMailgunError(error: any): EmailError {\n    const statusCode = error.status || error.response?.status || 500;\n    const errorMessage = error.message || error.response?.data?.message || \"Unknown error\";\n\n    if (statusCode === 401) {\n      return {\n        code: EmailErrorCode.INVALID_API_KEY,\n        message: \"Invalid Mailgun API key\",\n        statusCode,\n        retryable: false,\n      };\n    }\n\n    if (statusCode === 403) {\n      return {\n        code: EmailErrorCode.CONFIGURATION_ERROR,\n        message: \"Mailgun API access forbidden - check sender authentication\",\n        statusCode,\n        retryable: false,\n        details: { error: errorMessage },\n      };\n    }\n\n    if (statusCode === 429) {\n      return {\n        code: EmailErrorCode.RATE_LIMITED,\n        message: \"Mailgun rate limit exceeded\",\n        statusCode,\n        retryable: true,\n      };\n    }\n\n    if (statusCode >= 500) {\n      return {\n        code: EmailErrorCode.SERVICE_UNAVAILABLE,\n        message: \"Mailgun service temporarily unavailable\",\n        statusCode,\n        retryable: true,\n      };\n    }\n\n    if (errorMessage.includes(\"to parameter\") || errorMessage.includes(\"invalid recipient\")) {\n      return {\n        code: EmailErrorCode.INVALID_TO_EMAIL,\n        message: `Invalid recipient: ${errorMessage}`,\n        statusCode,\n        retryable: false,\n      };\n    }\n\n    if (errorMessage.includes(\"from parameter\") || errorMessage.includes(\"invalid sender\")) {\n      return {\n        code: EmailErrorCode.INVALID_FROM_EMAIL,\n        message: `Invalid sender: ${errorMessage}`,\n        statusCode,\n        retryable: false,\n      };\n    }\n\n    if (error.code === \"ENOTFOUND\" || error.code === \"ECONNREFUSED\" || error.code === \"ETIMEDOUT\") {\n      return {\n        code: EmailErrorCode.NETWORK_ERROR,\n        message: `Network error: ${error.message}`,\n        statusCode: 0,\n        retryable: true,\n      };\n    }\n\n    return {\n      code: EmailErrorCode.SEND_FAILED,\n      message: errorMessage || \"Failed to send email\",\n      statusCode,\n      retryable: statusCode >= 500,\n      details: { originalError: errorMessage },\n    };\n  }\n\n  async send(options: EmailOptions): Promise<EmailSendResult> {\n    const startTime = Date.now();\n    const sanitizedTo = this.sanitizeEmail(options.to);\n\n    if (!this.validateEmail(sanitizedTo)) {\n      return {\n        success: false,\n        timestamp: new Date(),\n        attempts: 0,\n        error: {\n          code: EmailErrorCode.INVALID_TO_EMAIL,\n          message: \"Invalid recipient email address\",\n          retryable: false,\n        },\n      };\n    }\n\n    if (!this.fromEmail || !this.validateEmail(this.fromEmail)) {\n      console.error(\"[EmailService] Invalid or missing MAILGUN_FROM_EMAIL\");\n      return {\n        success: false,\n        timestamp: new Date(),\n        attempts: 0,\n        error: {\n          code: EmailErrorCode.INVALID_FROM_EMAIL,\n          message: \"Invalid sender email configuration\",\n          retryable: false,\n        },\n      };\n    }\n\n    if (!this.rateLimiter.canSend(sanitizedTo)) {\n      const resetTime = this.rateLimiter.getResetTime(sanitizedTo);\n      return {\n        success: false,\n        timestamp: new Date(),\n        attempts: 0,\n        error: {\n          code: EmailErrorCode.RATE_LIMITED,\n          message: \"Too many emails sent to this address. Please try again later.\",\n          retryable: false,\n          details: { resetTime },\n        },\n      };\n    }\n\n    if (!this.circuitBreaker.canExecute()) {\n      return {\n        success: false,\n        timestamp: new Date(),\n        attempts: 0,\n        error: {\n          code: EmailErrorCode.SERVICE_UNAVAILABLE,\n          message: \"Email service temporarily unavailable due to repeated failures\",\n          retryable: true,\n          details: { circuitState: this.circuitBreaker.getState() },\n        },\n      };\n    }\n\n    if (!this.initialized) {\n      console.log(\"[EmailService] Development mode - logging email instead of sending\");\n      console.log(`[EmailService] To: ${sanitizedTo}`);\n      console.log(`[EmailService] Subject: ${options.subject}`);\n      console.log(`[EmailService] Text: ${options.text || \"(HTML only)\"}`);\n      \n      this.rateLimiter.recordSend(sanitizedTo);\n      \n      return {\n        success: true,\n        messageId: `dev-${Date.now()}`,\n        timestamp: new Date(),\n        attempts: 1,\n      };\n    }\n\n    const msg: any = {\n      from: `${this.fromName} <${this.fromEmail}>`,\n      to: [sanitizedTo],\n      subject: options.subject,\n      html: options.html,\n      text: options.text || this.htmlToText(options.html),\n      'o:tracking': 'no',\n      'o:tracking-clicks': 'no',\n      'o:tracking-opens': 'no',\n      'h:X-Mailer': 'TypeMasterAI Email Service',\n      'h:List-Unsubscribe': `<mailto:support@typemasterai.com?subject=Unsubscribe>`,\n      'h:List-Unsubscribe-Post': 'List-Unsubscribe=One-Click',\n    };\n\n    if (options.replyTo) {\n      msg['h:Reply-To'] = options.replyTo;\n    }\n\n    if (options.category && options.category.length > 0) {\n      msg['o:tag'] = options.category;\n    }\n\n    if (options.customArgs) {\n      Object.entries(options.customArgs).forEach(([key, value]) => {\n        msg[`v:${key}`] = value;\n      });\n    }\n\n    if (options.sendAt) {\n      msg['o:deliverytime'] = new Date(options.sendAt * 1000).toUTCString();\n    }\n\n    if (options.batchId) {\n      msg['v:batch_id'] = options.batchId;\n    }\n\n    console.log(`[EmailService] Attempting to send email:`, {\n      to: sanitizedTo,\n      from: this.fromEmail,\n      fromName: this.fromName,\n      subject: options.subject,\n      domain: this.domain,\n      initialized: this.initialized,\n    });\n\n    let lastError: EmailError | undefined;\n    let attempts = 0;\n\n    for (let attempt = 1; attempt <= this.retryConfig.maxAttempts; attempt++) {\n      attempts = attempt;\n\n      try {\n        const response = await this.mg.messages.create(this.domain, msg);\n        \n        this.circuitBreaker.recordSuccess();\n        this.rateLimiter.recordSend(sanitizedTo);\n\n        const messageId = response.id || `mg-${Date.now()}`;\n        \n        console.log(`[EmailService] Email sent successfully to ${sanitizedTo} (attempt ${attempt}, messageId: ${messageId})`);\n\n        return {\n          success: true,\n          messageId,\n          timestamp: new Date(),\n          attempts,\n        };\n      } catch (error: any) {\n        lastError = this.mapMailgunError(error);\n        \n        console.error(`[EmailService] Send attempt ${attempt} failed:`, {\n          code: lastError.code,\n          message: lastError.message,\n          statusCode: lastError.statusCode,\n          retryable: lastError.retryable,\n        });\n        \n        if (error.response?.data) {\n          console.error(`[EmailService] Mailgun error data:`, JSON.stringify(error.response.data, null, 2));\n        }\n\n        this.circuitBreaker.recordFailure();\n\n        if (!lastError.retryable || attempt >= this.retryConfig.maxAttempts) {\n          break;\n        }\n\n        const backoffMs = this.calculateBackoff(attempt);\n        console.log(`[EmailService] Retrying in ${backoffMs}ms...`);\n        await this.sleep(backoffMs);\n      }\n    }\n\n    console.error(`[EmailService] All ${attempts} attempts failed for ${sanitizedTo}`);\n\n    return {\n      success: false,\n      timestamp: new Date(),\n      attempts,\n      error: lastError,\n    };\n  }\n\n  private htmlToText(html: string): string {\n    return html\n      .replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, \"\")\n      .replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, \"\")\n      .replace(/<br\\s*\\/?>/gi, \"\\n\")\n      .replace(/<\\/p>/gi, \"\\n\\n\")\n      .replace(/<\\/div>/gi, \"\\n\")\n      .replace(/<\\/li>/gi, \"\\n\")\n      .replace(/<li[^>]*>/gi, \"  â€¢ \")\n      .replace(/<a[^>]*href=\"([^\"]*)\"[^>]*>([^<]*)<\\/a>/gi, \"$2 ($1)\")\n      .replace(/<[^>]+>/g, \"\")\n      .replace(/&nbsp;/g, \" \")\n      .replace(/&amp;/g, \"&\")\n      .replace(/&lt;/g, \"<\")\n      .replace(/&gt;/g, \">\")\n      .replace(/&quot;/g, '\"')\n      .replace(/&#39;/g, \"'\")\n      .replace(/\\n{3,}/g, \"\\n\\n\")\n      .trim();\n  }\n\n  async sendPasswordResetEmail(\n    email: string,\n    token: string,\n    options?: {\n      username?: string;\n      ipAddress?: string;\n      userAgent?: string;\n      expiresInMinutes?: number;\n      timezone?: string;\n    }\n  ): Promise<EmailSendResult> {\n    const resetUrl = `${this.appUrl}/reset-password?token=${encodeURIComponent(token)}`;\n    const expiresIn = options?.expiresInMinutes ?? 60;\n\n    const html = this.generatePasswordResetEmailHtml({\n      resetUrl,\n      username: options?.username,\n      expiresInMinutes: expiresIn,\n      ipAddress: options?.ipAddress,\n      requestTime: new Date().toISOString(),\n      timezone: options?.timezone,\n    });\n\n    return this.send({\n      to: email,\n      subject: \"Reset Your Password - TypeMasterAI\",\n      html,\n      category: [\"password_reset\", \"transactional\"],\n      customArgs: {\n        email_type: \"password_reset\",\n        user_email: email,\n      },\n    });\n  }\n\n  async sendEmailVerificationEmail(\n    email: string,\n    token: string,\n    options?: {\n      username?: string;\n    }\n  ): Promise<EmailSendResult> {\n    const verifyUrl = `${this.appUrl}/verify-email?token=${encodeURIComponent(token)}`;\n\n    const html = this.generateEmailVerificationHtml({\n      verifyUrl,\n      username: options?.username,\n    });\n\n    return this.send({\n      to: email,\n      subject: \"Verify Your Email - TypeMasterAI\",\n      html,\n      category: [\"email_verification\", \"transactional\"],\n      customArgs: {\n        email_type: \"email_verification\",\n        user_email: email,\n      },\n    });\n  }\n\n  async sendPasswordChangedEmail(\n    email: string,\n    options?: {\n      username?: string;\n      ipAddress?: string;\n      timezone?: string;\n    }\n  ): Promise<EmailSendResult> {\n    const html = this.generatePasswordChangedEmailHtml({\n      username: options?.username,\n      ipAddress: options?.ipAddress,\n      changedAt: new Date().toISOString(),\n      timezone: options?.timezone,\n    });\n\n    return this.send({\n      to: email,\n      subject: \"Your Password Was Changed - TypeMasterAI\",\n      html,\n      category: [\"security_alert\", \"transactional\"],\n      customArgs: {\n        email_type: \"password_changed\",\n        user_email: email,\n      },\n    });\n  }\n\n  private generatePasswordChangedEmailHtml(params: {\n    username?: string;\n    ipAddress?: string;\n    changedAt: string;\n    timezone?: string;\n  }): string {\n    const greeting = params.username ? `Hi ${params.username},` : \"Hi there,\";\n    const formattedDate = new Date(params.changedAt).toLocaleString(\"en-US\", { \n      weekday: \"long\",\n      year: \"numeric\",\n      month: \"long\", \n      day: \"numeric\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n      timeZoneName: \"short\",\n      timeZone: params.timezone || \"UTC\",\n    });\n    \n    return `\n<!DOCTYPE html>\n<html lang=\"en\" xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n  <meta name=\"x-apple-disable-message-reformatting\">\n  <meta name=\"referrer\" content=\"no-referrer\">\n  <title>Password Changed Successfully</title>\n  <!--[if mso]>\n  <noscript>\n    <xml>\n      <o:OfficeDocumentSettings>\n        <o:PixelsPerInch>96</o:PixelsPerInch>\n      </o:OfficeDocumentSettings>\n    </xml>\n  </noscript>\n  <![endif]-->\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #f4f4f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;\">\n  <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"background-color: #f4f4f5;\">\n    <tr>\n      <td align=\"center\" style=\"padding: 40px 20px;\">\n        \n        <!-- Main Container -->\n        <table role=\"presentation\" width=\"600\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"max-width: 600px; width: 100%; background-color: #ffffff; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);\">\n          \n          <!-- Header with Logo -->\n          <tr>\n            <td style=\"background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 32px 40px; text-align: center;\">\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\">\n                    <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"background-color: #ffffff; width: 48px; height: 48px; border-radius: 12px; text-align: center; vertical-align: middle;\">\n                          <span style=\"font-size: 24px; line-height: 48px;\">âŒ¨ï¸</span>\n                        </td>\n                        <td style=\"padding-left: 12px;\">\n                          <span style=\"font-size: 24px; font-weight: 700; color: #ffffff; letter-spacing: -0.5px;\">TypeMasterAI</span>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n          <!-- Success Icon Banner -->\n          <tr>\n            <td style=\"background-color: #dcfce7; padding: 24px 40px; text-align: center; border-bottom: 1px solid #bbf7d0;\">\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\">\n                    <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"width: 56px; height: 56px; background-color: #22c55e; border-radius: 50%; text-align: center; vertical-align: middle;\">\n                          <span style=\"font-size: 28px; line-height: 56px; color: #ffffff;\">âœ“</span>\n                        </td>\n                      </tr>\n                    </table>\n                    <p style=\"margin: 16px 0 0; font-size: 20px; font-weight: 600; color: #166534;\">Password Changed Successfully</p>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n          <!-- Main Content -->\n          <tr>\n            <td style=\"padding: 40px;\">\n              <p style=\"margin: 0 0 16px; font-size: 16px; line-height: 1.6; color: #18181b;\">\n                ${greeting}\n              </p>\n              <p style=\"margin: 0 0 24px; font-size: 16px; line-height: 1.6; color: #3f3f46;\">\n                Your TypeMasterAI account password has been successfully updated. You can now use your new password to sign in.\n              </p>\n              \n              <!-- Change Details Card -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"margin-bottom: 24px;\">\n                <tr>\n                  <td style=\"background-color: #f4f4f5; border-radius: 12px; padding: 20px; border-left: 4px solid #6366f1;\">\n                    <p style=\"margin: 0 0 8px; font-size: 13px; font-weight: 600; color: #71717a; text-transform: uppercase; letter-spacing: 0.5px;\">Change Details</p>\n                    <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"padding: 4px 0;\">\n                          <span style=\"font-size: 14px; color: #71717a;\">Date & Time:</span>\n                        </td>\n                        <td style=\"padding: 4px 0; text-align: right;\">\n                          <span style=\"font-size: 14px; font-weight: 500; color: #18181b;\">${formattedDate}</span>\n                        </td>\n                      </tr>\n                      ${params.ipAddress ? `\n                      <tr>\n                        <td style=\"padding: 4px 0;\">\n                          <span style=\"font-size: 14px; color: #71717a;\">IP Address:</span>\n                        </td>\n                        <td style=\"padding: 4px 0; text-align: right;\">\n                          <span style=\"font-size: 14px; font-weight: 500; color: #18181b;\">${params.ipAddress}</span>\n                        </td>\n                      </tr>\n                      ` : \"\"}\n                    </table>\n                  </td>\n                </tr>\n              </table>\n              \n              <p style=\"margin: 0 0 24px; font-size: 14px; line-height: 1.6; color: #52525b;\">\n                For your security, all other active sessions have been automatically logged out.\n              </p>\n              \n              <!-- Warning Alert -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"margin-bottom: 24px;\">\n                <tr>\n                  <td style=\"background-color: #fef3c7; border-radius: 12px; padding: 20px; border: 1px solid #fcd34d;\">\n                    <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"width: 24px; vertical-align: top; padding-right: 12px;\">\n                          <span style=\"font-size: 20px;\">âš ï¸</span>\n                        </td>\n                        <td>\n                          <p style=\"margin: 0 0 4px; font-size: 14px; font-weight: 600; color: #92400e;\">Didn't make this change?</p>\n                          <p style=\"margin: 0; font-size: 14px; line-height: 1.5; color: #a16207;\">\n                            If you didn't change your password, your account may have been compromised. Please <a href=\"${this.appUrl}/forgot-password\" style=\"color: #b45309; font-weight: 600;\">reset your password immediately</a> and contact our support team.\n                          </p>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n              \n              <!-- CTA Button -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\" style=\"padding: 8px 0;\">\n                    <a href=\"${this.appUrl}/login\" style=\"display: inline-block; padding: 14px 32px; background-color: #6366f1; color: #ffffff; text-decoration: none; font-size: 15px; font-weight: 600; border-radius: 8px; mso-padding-alt: 0;\">\n                      <!--[if mso]>\n                      <i style=\"mso-font-width: 200%; mso-text-raise: 24pt;\">&nbsp;</i>\n                      <![endif]-->\n                      <span style=\"mso-text-raise: 12pt;\">Sign In to Your Account</span>\n                      <!--[if mso]>\n                      <i style=\"mso-font-width: 200%;\">&nbsp;</i>\n                      <![endif]-->\n                    </a>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n          <!-- Footer -->\n          <tr>\n            <td style=\"background-color: #f9fafb; padding: 24px 40px; border-top: 1px solid #e4e4e7;\">\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\">\n                    <p style=\"margin: 0 0 8px; font-size: 14px; color: #71717a;\">\n                      Need help? <a href=\"${this.appUrl}/contact\" style=\"color: #6366f1; text-decoration: none; font-weight: 500;\">Contact Support</a>\n                    </p>\n                    <p style=\"margin: 0; font-size: 12px; color: #a1a1aa; line-height: 1.6;\">\n                      Â© ${new Date().getFullYear()} TypeMasterAI. All rights reserved.<br>\n                      <a href=\"${this.appUrl}\" style=\"color: #a1a1aa; text-decoration: none;\">typemasterai.com</a><br>\n                      <span style=\"font-size: 11px;\">TypeMasterAI, Solapur, Maharashtra 413224, India</span>\n                    </p>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n        </table>\n        \n        <!-- Security Note -->\n        <table role=\"presentation\" width=\"600\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"max-width: 600px; width: 100%;\">\n          <tr>\n            <td style=\"padding: 24px 20px; text-align: center;\">\n              <p style=\"margin: 0 0 8px; font-size: 12px; color: #a1a1aa; line-height: 1.5;\">\n                This is an automated email. Please do not reply to this message.<br>\n                For assistance, contact us at <a href=\"mailto:support@typemasterai.com\" style=\"color: #6366f1; text-decoration: none;\">support@typemasterai.com</a> or visit our <a href=\"${this.appUrl}/contact\" style=\"color: #6366f1; text-decoration: none;\">Contact Support</a>.\n              </p>\n              <p style=\"margin: 0; font-size: 11px; color: #d4d4d8; line-height: 1.4;\">\n                ðŸ“¬ <strong>Can't find this email?</strong> Please check your Spam or Junk folder and mark us as \"Not Spam\" to ensure future emails arrive in your inbox.\n              </p>\n            </td>\n          </tr>\n        </table>\n        \n      </td>\n    </tr>\n  </table>\n</body>\n</html>`;\n  }\n\n  private generatePasswordResetEmailHtml(params: {\n    resetUrl: string;\n    username?: string;\n    expiresInMinutes: number;\n    ipAddress?: string;\n    requestTime: string;\n    timezone?: string;\n  }): string {\n    const greeting = params.username ? `Hi ${params.username},` : \"Hi there,\";\n    const formattedTime = new Date(params.requestTime).toLocaleString(\"en-US\", { \n      weekday: \"long\",\n      year: \"numeric\",\n      month: \"long\", \n      day: \"numeric\",\n      hour: \"2-digit\",\n      minute: \"2-digit\",\n      timeZoneName: \"short\",\n      timeZone: params.timezone || \"UTC\",\n    });\n    \n    return `\n<!DOCTYPE html>\n<html lang=\"en\" xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n  <meta name=\"x-apple-disable-message-reformatting\">\n  <meta name=\"referrer\" content=\"no-referrer\">\n  <title>Reset Your Password</title>\n  <!--[if mso]>\n  <noscript>\n    <xml>\n      <o:OfficeDocumentSettings>\n        <o:PixelsPerInch>96</o:PixelsPerInch>\n      </o:OfficeDocumentSettings>\n    </xml>\n  </noscript>\n  <![endif]-->\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #f4f4f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;\">\n  <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"background-color: #f4f4f5;\">\n    <tr>\n      <td align=\"center\" style=\"padding: 40px 20px;\">\n        \n        <!-- Main Container -->\n        <table role=\"presentation\" width=\"600\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"max-width: 600px; width: 100%; background-color: #ffffff; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);\">\n          \n          <!-- Header with Logo -->\n          <tr>\n            <td style=\"background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 32px 40px; text-align: center;\">\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\">\n                    <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"background-color: #ffffff; width: 48px; height: 48px; border-radius: 12px; text-align: center; vertical-align: middle;\">\n                          <span style=\"font-size: 24px; line-height: 48px;\">âŒ¨ï¸</span>\n                        </td>\n                        <td style=\"padding-left: 12px;\">\n                          <span style=\"font-size: 24px; font-weight: 700; color: #ffffff; letter-spacing: -0.5px;\">TypeMasterAI</span>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n          <!-- Header Banner -->\n          <tr>\n            <td style=\"background-color: #eef2ff; padding: 28px 40px; text-align: center; border-bottom: 1px solid #c7d2fe;\">\n              <p style=\"margin: 0; font-size: 22px; font-weight: 600; color: #4338ca;\">Password Reset Request</p>\n              <p style=\"margin: 8px 0 0; font-size: 14px; color: #6366f1;\">Secure your account with a new password</p>\n            </td>\n          </tr>\n          \n          <!-- Main Content -->\n          <tr>\n            <td style=\"padding: 40px;\">\n              <p style=\"margin: 0 0 16px; font-size: 16px; line-height: 1.6; color: #18181b;\">\n                ${greeting}\n              </p>\n              <p style=\"margin: 0 0 24px; font-size: 16px; line-height: 1.6; color: #3f3f46;\">\n                We received a request to reset your password for your TypeMasterAI account. Click the button below to create a new password:\n              </p>\n              \n              <!-- CTA Button -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\" style=\"padding: 16px 0 24px;\">\n                    <a href=\"${params.resetUrl}\" style=\"display: inline-block; padding: 16px 40px; background-color: #6366f1; color: #ffffff; text-decoration: none; font-size: 16px; font-weight: 600; border-radius: 8px; mso-padding-alt: 0;\">\n                      <!--[if mso]>\n                      <i style=\"mso-font-width: 200%; mso-text-raise: 24pt;\">&nbsp;</i>\n                      <![endif]-->\n                      <span style=\"mso-text-raise: 12pt;\">Reset My Password</span>\n                      <!--[if mso]>\n                      <i style=\"mso-font-width: 200%;\">&nbsp;</i>\n                      <![endif]-->\n                    </a>\n                  </td>\n                </tr>\n              </table>\n              \n              <!-- Expiry Notice -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"margin-bottom: 24px;\">\n                <tr>\n                  <td style=\"background-color: #fef3c7; border-radius: 8px; padding: 14px 16px; text-align: center;\">\n                    <p style=\"margin: 0; font-size: 14px; color: #92400e;\">\n                      <span style=\"font-weight: 600;\">â± This link expires in ${params.expiresInMinutes} minutes</span> for your security.\n                    </p>\n                  </td>\n                </tr>\n              </table>\n              \n              <!-- Security Details Card -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"margin-bottom: 24px;\">\n                <tr>\n                  <td style=\"background-color: #f4f4f5; border-radius: 12px; padding: 20px; border-left: 4px solid #6366f1;\">\n                    <p style=\"margin: 0 0 8px; font-size: 13px; font-weight: 600; color: #71717a; text-transform: uppercase; letter-spacing: 0.5px;\">Request Details</p>\n                    <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"padding: 4px 0;\">\n                          <span style=\"font-size: 14px; color: #71717a;\">Date & Time:</span>\n                        </td>\n                        <td style=\"padding: 4px 0; text-align: right;\">\n                          <span style=\"font-size: 14px; font-weight: 500; color: #18181b;\">${formattedTime}</span>\n                        </td>\n                      </tr>\n                      ${params.ipAddress ? `\n                      <tr>\n                        <td style=\"padding: 4px 0;\">\n                          <span style=\"font-size: 14px; color: #71717a;\">IP Address:</span>\n                        </td>\n                        <td style=\"padding: 4px 0; text-align: right;\">\n                          <span style=\"font-size: 14px; font-weight: 500; color: #18181b;\">${params.ipAddress}</span>\n                        </td>\n                      </tr>\n                      ` : \"\"}\n                    </table>\n                  </td>\n                </tr>\n              </table>\n              \n              <!-- Safety Note -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"margin-bottom: 24px;\">\n                <tr>\n                  <td style=\"background-color: #f0fdf4; border-radius: 12px; padding: 16px; border: 1px solid #bbf7d0;\">\n                    <p style=\"margin: 0; font-size: 14px; line-height: 1.5; color: #166534;\">\n                      <strong>Didn't request this?</strong> You can safely ignore this email. Your password will remain unchanged and no action is needed.\n                    </p>\n                  </td>\n                </tr>\n              </table>\n              \n              <!-- Alternative Link -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td style=\"border-top: 1px solid #e4e4e7; padding-top: 20px;\">\n                    <p style=\"margin: 0 0 8px; font-size: 13px; color: #71717a;\">\n                      If the button doesn't work, copy and paste this link into your browser:\n                    </p>\n                    <p style=\"margin: 0; font-size: 12px; word-break: break-all;\">\n                      <a href=\"${params.resetUrl}\" style=\"color: #6366f1; text-decoration: none;\">${params.resetUrl}</a>\n                    </p>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n          <!-- Footer -->\n          <tr>\n            <td style=\"background-color: #f9fafb; padding: 24px 40px; border-top: 1px solid #e4e4e7;\">\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\">\n                    <p style=\"margin: 0 0 8px; font-size: 14px; color: #71717a;\">\n                      Need help? <a href=\"${this.appUrl}/contact\" style=\"color: #6366f1; text-decoration: none; font-weight: 500;\">Contact Support</a>\n                    </p>\n                    <p style=\"margin: 0; font-size: 12px; color: #a1a1aa; line-height: 1.6;\">\n                      Â© ${new Date().getFullYear()} TypeMasterAI. All rights reserved.<br>\n                      <a href=\"${this.appUrl}\" style=\"color: #a1a1aa; text-decoration: none;\">typemasterai.com</a><br>\n                      <span style=\"font-size: 11px;\">TypeMasterAI, Solapur, Maharashtra 413224, India</span>\n                    </p>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n        </table>\n        \n        <!-- Security Note -->\n        <table role=\"presentation\" width=\"600\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"max-width: 600px; width: 100%;\">\n          <tr>\n            <td style=\"padding: 24px 20px; text-align: center;\">\n              <p style=\"margin: 0 0 8px; font-size: 12px; color: #a1a1aa; line-height: 1.5;\">\n                This is an automated email. Please do not reply to this message.<br>\n                For assistance, contact us at <a href=\"mailto:support@typemasterai.com\" style=\"color: #6366f1; text-decoration: none;\">support@typemasterai.com</a> or visit our <a href=\"${this.appUrl}/contact\" style=\"color: #6366f1; text-decoration: none;\">Contact Support</a>.\n              </p>\n              <p style=\"margin: 0; font-size: 11px; color: #d4d4d8; line-height: 1.4;\">\n                ðŸ“¬ <strong>Can't find this email?</strong> Please check your Spam or Junk folder and mark us as \"Not Spam\" to ensure future emails arrive in your inbox.\n              </p>\n            </td>\n          </tr>\n        </table>\n        \n      </td>\n    </tr>\n  </table>\n</body>\n</html>`;\n  }\n\n  private generateEmailVerificationHtml(params: {\n    verifyUrl: string;\n    username?: string;\n  }): string {\n    const greeting = params.username ? `Welcome, ${params.username}!` : \"Welcome!\";\n    \n    return `\n<!DOCTYPE html>\n<html lang=\"en\" xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n  <meta name=\"x-apple-disable-message-reformatting\">\n  <meta name=\"referrer\" content=\"no-referrer\">\n  <title>Verify Your Email - TypeMasterAI</title>\n  <!--[if mso]>\n  <noscript>\n    <xml>\n      <o:OfficeDocumentSettings>\n        <o:PixelsPerInch>96</o:PixelsPerInch>\n      </o:OfficeDocumentSettings>\n    </xml>\n  </noscript>\n  <![endif]-->\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #f4f4f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;\">\n  <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"background-color: #f4f4f5;\">\n    <tr>\n      <td align=\"center\" style=\"padding: 40px 20px;\">\n        \n        <!-- Main Container -->\n        <table role=\"presentation\" width=\"600\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"max-width: 600px; width: 100%; background-color: #ffffff; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);\">\n          \n          <!-- Header with Logo -->\n          <tr>\n            <td style=\"background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 32px 40px; text-align: center;\">\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\">\n                    <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"background-color: #ffffff; width: 48px; height: 48px; border-radius: 12px; text-align: center; vertical-align: middle;\">\n                          <span style=\"font-size: 24px; line-height: 48px;\">âŒ¨ï¸</span>\n                        </td>\n                        <td style=\"padding-left: 12px;\">\n                          <span style=\"font-size: 24px; font-weight: 700; color: #ffffff; letter-spacing: -0.5px;\">TypeMasterAI</span>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n          <!-- Welcome Banner -->\n          <tr>\n            <td style=\"background-color: #dbeafe; padding: 24px 40px; text-align: center; border-bottom: 1px solid #bfdbfe;\">\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\">\n                    <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"width: 56px; height: 56px; background-color: #3b82f6; border-radius: 50%; text-align: center; vertical-align: middle;\">\n                          <span style=\"font-size: 28px; line-height: 56px; color: #ffffff;\">âœ‰ï¸</span>\n                        </td>\n                      </tr>\n                    </table>\n                    <p style=\"margin: 16px 0 0; font-size: 20px; font-weight: 600; color: #1e40af;\">Verify Your Email Address</p>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n          <!-- Main Content -->\n          <tr>\n            <td style=\"padding: 40px;\">\n              <p style=\"margin: 0 0 8px; font-size: 20px; font-weight: 600; line-height: 1.4; color: #18181b;\">\n                ${greeting}\n              </p>\n              <p style=\"margin: 0 0 24px; font-size: 16px; line-height: 1.6; color: #3f3f46;\">\n                Thanks for signing up for TypeMasterAI! Please verify your email address to complete your registration and unlock all features.\n              </p>\n              \n              <!-- CTA Button -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\" style=\"padding: 8px 0 24px;\">\n                    <!--[if mso]>\n                    <v:roundrect xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:w=\"urn:schemas-microsoft-com:office:word\" href=\"${params.verifyUrl}\" style=\"height:52px;v-text-anchor:middle;width:220px;\" arcsize=\"12%\" stroke=\"f\" fillcolor=\"#22c55e\">\n                      <w:anchorlock/>\n                      <center style=\"color:#ffffff;font-family:sans-serif;font-size:16px;font-weight:600;\">Verify Email Address</center>\n                    </v:roundrect>\n                    <![endif]-->\n                    <!--[if !mso]><!-->\n                    <a href=\"${params.verifyUrl}\" style=\"display: inline-block; padding: 16px 40px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: #ffffff; text-decoration: none; font-size: 16px; font-weight: 600; border-radius: 12px; box-shadow: 0 4px 14px rgba(34, 197, 94, 0.3); transition: transform 0.2s;\">\n                      Verify Email Address\n                    </a>\n                    <!--<![endif]-->\n                  </td>\n                </tr>\n              </table>\n              \n              <!-- Expiry Notice -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"margin-bottom: 24px;\">\n                <tr>\n                  <td style=\"background-color: #fef3c7; border-radius: 12px; padding: 16px 20px; border-left: 4px solid #f59e0b;\">\n                    <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"width: 24px; vertical-align: top;\">\n                          <span style=\"font-size: 16px;\">â°</span>\n                        </td>\n                        <td style=\"padding-left: 12px;\">\n                          <p style=\"margin: 0; font-size: 14px; line-height: 1.5; color: #92400e;\">\n                            This verification link will expire in <strong>24 hours</strong>. If it expires, you can request a new one from the login page.\n                          </p>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n              \n              <!-- Features Card -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"margin-bottom: 24px;\">\n                <tr>\n                  <td style=\"background-color: #f4f4f5; border-radius: 12px; padding: 24px; border-left: 4px solid #6366f1;\">\n                    <p style=\"margin: 0 0 16px; font-size: 15px; font-weight: 600; color: #18181b;\">\n                      ðŸŽ‰ Here's what awaits you:\n                    </p>\n                    <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"padding: 6px 0;\">\n                          <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                            <tr>\n                              <td style=\"width: 24px; vertical-align: top;\">\n                                <span style=\"color: #22c55e; font-size: 14px;\">âœ“</span>\n                              </td>\n                              <td style=\"padding-left: 8px;\">\n                                <span style=\"font-size: 14px; color: #3f3f46;\">Real-time typing analytics & progress tracking</span>\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                      </tr>\n                      <tr>\n                        <td style=\"padding: 6px 0;\">\n                          <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                            <tr>\n                              <td style=\"width: 24px; vertical-align: top;\">\n                                <span style=\"color: #22c55e; font-size: 14px;\">âœ“</span>\n                              </td>\n                              <td style=\"padding-left: 8px;\">\n                                <span style=\"font-size: 14px; color: #3f3f46;\">Multiplayer racing with players worldwide</span>\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                      </tr>\n                      <tr>\n                        <td style=\"padding: 6px 0;\">\n                          <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                            <tr>\n                              <td style=\"width: 24px; vertical-align: top;\">\n                                <span style=\"color: #22c55e; font-size: 14px;\">âœ“</span>\n                              </td>\n                              <td style=\"padding-left: 8px;\">\n                                <span style=\"font-size: 14px; color: #3f3f46;\">AI-powered practice recommendations</span>\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                      </tr>\n                      <tr>\n                        <td style=\"padding: 6px 0;\">\n                          <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                            <tr>\n                              <td style=\"width: 24px; vertical-align: top;\">\n                                <span style=\"color: #22c55e; font-size: 14px;\">âœ“</span>\n                              </td>\n                              <td style=\"padding-left: 8px;\">\n                                <span style=\"font-size: 14px; color: #3f3f46;\">Achievements, challenges & leaderboards</span>\n                              </td>\n                            </tr>\n                          </table>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n              \n              <!-- Safety Note -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"margin-bottom: 24px;\">\n                <tr>\n                  <td style=\"background-color: #f0fdf4; border-radius: 12px; padding: 16px 20px; border-left: 4px solid #22c55e;\">\n                    <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"width: 24px; vertical-align: top;\">\n                          <span style=\"font-size: 16px;\">ðŸ’¡</span>\n                        </td>\n                        <td style=\"padding-left: 12px;\">\n                          <p style=\"margin: 0; font-size: 14px; line-height: 1.5; color: #166534;\">\n                            If you didn't create an account with TypeMasterAI, you can safely ignore this email. No action is required.\n                          </p>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n              \n              <!-- Fallback URL -->\n              <p style=\"margin: 0; font-size: 12px; line-height: 1.6; color: #71717a;\">\n                If the button above doesn't work, copy and paste this link into your browser:<br>\n                <a href=\"${params.verifyUrl}\" style=\"color: #6366f1; word-break: break-all; text-decoration: none;\">${params.verifyUrl}</a>\n              </p>\n            </td>\n          </tr>\n          \n          <!-- Footer -->\n          <tr>\n            <td style=\"background-color: #fafafa; padding: 24px 40px; border-top: 1px solid #e4e4e7;\">\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\">\n                    <p style=\"margin: 0 0 8px; font-size: 14px; color: #71717a;\">\n                      Need help? <a href=\"${this.appUrl}/contact\" style=\"color: #6366f1; text-decoration: none; font-weight: 500;\">Contact Support</a>\n                    </p>\n                    <p style=\"margin: 0; font-size: 12px; color: #a1a1aa;\">\n                      Â© ${new Date().getFullYear()} TypeMasterAI. All rights reserved.<br>\n                      <a href=\"${this.appUrl}\" style=\"color: #a1a1aa; text-decoration: none;\">typemasterai.com</a>\n                    </p>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n        </table>\n        \n        <!-- Security Note -->\n        <table role=\"presentation\" width=\"600\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"max-width: 600px; width: 100%;\">\n          <tr>\n            <td style=\"padding: 24px 20px; text-align: center;\">\n              <p style=\"margin: 0; font-size: 12px; color: #a1a1aa; line-height: 1.5;\">\n                This is an automated email from TypeMasterAI. Please do not reply to this email.<br>\n                If you have any questions, visit our <a href=\"${this.appUrl}/contact\" style=\"color: #6366f1; text-decoration: none;\">Contact Support</a>.\n              </p>\n            </td>\n          </tr>\n        </table>\n        \n      </td>\n    </tr>\n  </table>\n</body>\n</html>`;\n  }\n\n  async sendFeedbackResolutionEmail(\n    email: string,\n    options: {\n      feedbackId: number;\n      subject: string;\n      resolutionNotes?: string;\n      username?: string;\n      status: string;\n    }\n  ): Promise<EmailSendResult> {\n    const feedbackUrl = `${this.appUrl}/feedback/${options.feedbackId}`;\n    const statusLabel = options.status === 'resolved' ? 'Resolved' : 'Closed';\n    const statusColor = options.status === 'resolved' ? '#22c55e' : '#3b82f6';\n    \n    const html = this.generateFeedbackResolutionEmailHtml({\n      feedbackUrl,\n      feedbackId: options.feedbackId,\n      subject: options.subject,\n      resolutionNotes: options.resolutionNotes,\n      username: options.username,\n      statusLabel,\n      statusColor,\n    });\n\n    return this.send({\n      to: email,\n      subject: `Your Feedback Has Been ${statusLabel} - TypeMasterAI`,\n      html,\n      category: [\"feedback_resolution\", \"transactional\"],\n      customArgs: {\n        email_type: \"feedback_resolution\",\n        feedback_id: options.feedbackId.toString(),\n        user_email: email,\n      },\n    });\n  }\n\n  private generateFeedbackResolutionEmailHtml(params: {\n    feedbackUrl: string;\n    feedbackId: number;\n    subject: string;\n    resolutionNotes?: string;\n    username?: string;\n    statusLabel: string;\n    statusColor: string;\n  }): string {\n    const greeting = params.username ? `Hi ${params.username},` : \"Hi there,\";\n    \n    return `\n<!DOCTYPE html>\n<html lang=\"en\" xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\">\n<head>\n  <meta charset=\"UTF-8\">\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\">\n  <meta name=\"x-apple-disable-message-reformatting\">\n  <meta name=\"referrer\" content=\"no-referrer\">\n  <title>Feedback ${params.statusLabel} - TypeMasterAI</title>\n  <!--[if mso]>\n  <noscript>\n    <xml>\n      <o:OfficeDocumentSettings>\n        <o:PixelsPerInch>96</o:PixelsPerInch>\n      </o:OfficeDocumentSettings>\n    </xml>\n  </noscript>\n  <![endif]-->\n</head>\n<body style=\"margin: 0; padding: 0; background-color: #f4f4f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;\">\n  <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"background-color: #f4f4f5;\">\n    <tr>\n      <td align=\"center\" style=\"padding: 40px 20px;\">\n        \n        <!-- Main Container -->\n        <table role=\"presentation\" width=\"600\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"max-width: 600px; width: 100%; background-color: #ffffff; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);\">\n          \n          <!-- Header with Logo -->\n          <tr>\n            <td style=\"background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: 32px 40px; text-align: center;\">\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\">\n                    <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"background-color: #ffffff; width: 48px; height: 48px; border-radius: 12px; text-align: center; vertical-align: middle;\">\n                          <span style=\"font-size: 24px; line-height: 48px;\">âŒ¨ï¸</span>\n                        </td>\n                        <td style=\"padding-left: 12px;\">\n                          <span style=\"font-size: 24px; font-weight: 700; color: #ffffff; letter-spacing: -0.5px;\">TypeMasterAI</span>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n          <!-- Status Banner -->\n          <tr>\n            <td style=\"background-color: #dcfce7; padding: 24px 40px; text-align: center; border-bottom: 1px solid #bbf7d0;\">\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\">\n                    <table role=\"presentation\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"width: 56px; height: 56px; background-color: ${params.statusColor}; border-radius: 50%; text-align: center; vertical-align: middle;\">\n                          <span style=\"font-size: 28px; line-height: 56px; color: #ffffff;\">âœ“</span>\n                        </td>\n                      </tr>\n                    </table>\n                    <p style=\"margin: 16px 0 0; font-size: 20px; font-weight: 600; color: #166534;\">Feedback ${params.statusLabel}</p>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n          <!-- Main Content -->\n          <tr>\n            <td style=\"padding: 40px;\">\n              <p style=\"margin: 0 0 16px; font-size: 16px; line-height: 1.6; color: #18181b;\">\n                ${greeting}\n              </p>\n              <p style=\"margin: 0 0 24px; font-size: 16px; line-height: 1.6; color: #3f3f46;\">\n                Thank you for sharing your feedback with us! We're writing to let you know that your feedback has been ${params.statusLabel.toLowerCase()}.\n              </p>\n              \n              <!-- Feedback Details Card -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"margin-bottom: 24px;\">\n                <tr>\n                  <td style=\"background-color: #f4f4f5; border-radius: 12px; padding: 20px; border-left: 4px solid #6366f1;\">\n                    <p style=\"margin: 0 0 8px; font-size: 13px; font-weight: 500; color: #71717a; text-transform: uppercase; letter-spacing: 0.5px;\">\n                      Your Feedback\n                    </p>\n                    <p style=\"margin: 0 0 4px; font-size: 16px; font-weight: 600; color: #18181b;\">\n                      ${params.subject}\n                    </p>\n                    <p style=\"margin: 0; font-size: 13px; color: #71717a;\">\n                      Feedback ID: #${params.feedbackId}\n                    </p>\n                  </td>\n                </tr>\n              </table>\n              ${params.resolutionNotes ? `\n              <!-- Resolution Notes -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"margin-bottom: 24px;\">\n                <tr>\n                  <td style=\"background-color: #f0fdf4; border-radius: 12px; padding: 20px; border-left: 4px solid #22c55e;\">\n                    <p style=\"margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #166534;\">\n                      Resolution Details\n                    </p>\n                    <p style=\"margin: 0; font-size: 14px; line-height: 1.6; color: #166534;\">\n                      ${params.resolutionNotes}\n                    </p>\n                  </td>\n                </tr>\n              </table>\n              ` : ''}\n              \n              <!-- CTA Button -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"margin-bottom: 24px;\">\n                <tr>\n                  <td align=\"center\" style=\"padding: 8px 0;\">\n                    <!--[if mso]>\n                    <v:roundrect xmlns:v=\"urn:schemas-microsoft-com:vml\" xmlns:w=\"urn:schemas-microsoft-com:office:word\" href=\"${params.feedbackUrl}\" style=\"height:52px;v-text-anchor:middle;width:200px;\" arcsize=\"12%\" stroke=\"f\" fillcolor=\"#6366f1\">\n                      <w:anchorlock/>\n                      <center style=\"color:#ffffff;font-family:sans-serif;font-size:16px;font-weight:600;\">View Full Details</center>\n                    </v:roundrect>\n                    <![endif]-->\n                    <!--[if !mso]><!-->\n                    <a href=\"${params.feedbackUrl}\" style=\"display: inline-block; padding: 16px 32px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #ffffff; text-decoration: none; font-size: 16px; font-weight: 600; border-radius: 12px; box-shadow: 0 4px 14px rgba(99, 102, 241, 0.3);\">\n                      View Full Details\n                    </a>\n                    <!--<![endif]-->\n                  </td>\n                </tr>\n              </table>\n              \n              <!-- Thank You Note -->\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td style=\"background-color: #fef3c7; border-radius: 12px; padding: 20px; border-left: 4px solid #f59e0b;\">\n                    <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                      <tr>\n                        <td style=\"width: 24px; vertical-align: top;\">\n                          <span style=\"font-size: 16px;\">ðŸ’™</span>\n                        </td>\n                        <td style=\"padding-left: 12px;\">\n                          <p style=\"margin: 0; font-size: 14px; line-height: 1.6; color: #92400e;\">\n                            Your feedback helps us improve TypeMasterAI for everyone. We truly appreciate you taking the time to share your thoughts with us!\n                          </p>\n                        </td>\n                      </tr>\n                    </table>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n          <!-- Footer -->\n          <tr>\n            <td style=\"background-color: #f9fafb; padding: 24px 40px; border-top: 1px solid #e4e4e7;\">\n              <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\">\n                <tr>\n                  <td align=\"center\">\n                    <p style=\"margin: 0 0 8px; font-size: 14px; color: #71717a;\">\n                      Have more feedback? <a href=\"${this.appUrl}/feedback\" style=\"color: #6366f1; text-decoration: none; font-weight: 500;\">Share it with us</a>\n                    </p>\n                    <p style=\"margin: 0; font-size: 12px; color: #a1a1aa;\">\n                      Â© ${new Date().getFullYear()} TypeMasterAI. All rights reserved.<br>\n                      <a href=\"${this.appUrl}\" style=\"color: #a1a1aa; text-decoration: none;\">typemasterai.com</a>\n                    </p>\n                  </td>\n                </tr>\n              </table>\n            </td>\n          </tr>\n          \n        </table>\n        \n        <!-- Footer Note -->\n        <table role=\"presentation\" width=\"600\" cellspacing=\"0\" cellpadding=\"0\" border=\"0\" style=\"max-width: 600px; width: 100%;\">\n          <tr>\n            <td style=\"padding: 24px 20px; text-align: center;\">\n              <p style=\"margin: 0; font-size: 12px; color: #a1a1aa; line-height: 1.5;\">\n                This is an automated notification email. Please do not reply to this email.<br>\n                If you have questions, visit our <a href=\"${this.appUrl}/help\" style=\"color: #6366f1; text-decoration: none;\">Help Center</a>.\n              </p>\n            </td>\n          </tr>\n        </table>\n        \n      </td>\n    </tr>\n  </table>\n</body>\n</html>`;\n  }\n\n  isConfigured(): boolean {\n    return this.initialized && !!this.fromEmail;\n  }\n\n  getServiceStatus(): {\n    configured: boolean;\n    circuitBreakerState: string;\n    fromEmail: string;\n  } {\n    return {\n      configured: this.isConfigured(),\n      circuitBreakerState: this.circuitBreaker.getState(),\n      fromEmail: this.fromEmail ? `${this.fromEmail.substring(0, 3)}***` : \"not set\",\n    };\n  }\n}\n\nexport const emailService = new EmailService({\n  rateLimitWindowMs: 60 * 1000,\n  rateLimitMaxRequests: 3,\n  circuitBreakerThreshold: 5,\n  circuitBreakerResetMs: 60 * 1000,\n  retryMaxAttempts: 3,\n  retryBaseDelayMs: 1000,\n  retryMaxDelayMs: 30000,\n});\n","path":null,"size_bytes":65745,"size_tokens":null},"client/src/components/FeedbackWidget.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { z } from \"zod\";\nimport { toast } from \"sonner\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n  DialogTrigger,\n} from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Loader2, MessageSquare, Bug, Lightbulb, MessageCircle, Palette, Zap, FileText, X } from \"lucide-react\";\nimport { useAuth } from \"@/lib/auth-context\";\n\nconst feedbackFormSchema = z.object({\n  categoryId: z.string().optional(),\n  subject: z.string().min(5, \"Subject must be at least 5 characters\").max(200, \"Subject must be less than 200 characters\"),\n  message: z.string().min(20, \"Message must be at least 20 characters\").max(5000, \"Message must be less than 5000 characters\"),\n  priority: z.enum([\"low\", \"medium\", \"high\", \"critical\"]),\n  isAnonymous: z.boolean(),\n  contactEmail: z.string().email(\"Please enter a valid email\").optional().or(z.literal(\"\")),\n  honeypot: z.string().optional(),\n});\n\ntype FeedbackFormData = z.infer<typeof feedbackFormSchema>;\n\ninterface FeedbackCategory {\n  id: number;\n  name: string;\n  slug: string;\n  description: string | null;\n  icon: string | null;\n  color: string | null;\n  isActive: boolean;\n  sortOrder: number;\n}\n\nconst categoryIcons: Record<string, React.ReactNode> = {\n  \"bug-report\": <Bug className=\"h-4 w-4\" />,\n  \"feature-request\": <Lightbulb className=\"h-4 w-4\" />,\n  \"general-feedback\": <MessageCircle className=\"h-4 w-4\" />,\n  \"ux-ui-improvement\": <Palette className=\"h-4 w-4\" />,\n  \"performance-issue\": <Zap className=\"h-4 w-4\" />,\n  \"content-issue\": <FileText className=\"h-4 w-4\" />,\n};\n\nconst priorityLabels = {\n  low: { label: \"Low\", description: \"Minor issue or suggestion\" },\n  medium: { label: \"Medium\", description: \"Moderate impact\" },\n  high: { label: \"High\", description: \"Significant issue\" },\n  critical: { label: \"Critical\", description: \"Urgent, blocking issue\" },\n};\n\ninterface FeedbackWidgetProps {\n  triggerClassName?: string;\n  triggerVariant?: \"default\" | \"outline\" | \"ghost\" | \"secondary\" | \"destructive\" | \"link\";\n  triggerSize?: \"default\" | \"sm\" | \"lg\" | \"icon\";\n}\n\nexport default function FeedbackWidget({\n  triggerClassName,\n  triggerVariant = \"outline\",\n  triggerSize = \"default\",\n}: FeedbackWidgetProps) {\n  const [open, setOpen] = useState(false);\n  const { user } = useAuth();\n\n  const { data: categories = [], isLoading: categoriesLoading } = useQuery<FeedbackCategory[]>({\n    queryKey: [\"feedback-categories\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/feedback/categories\", { \n        credentials: \"include\",\n        cache: \"no-store\",\n      });\n      if (!res.ok) throw new Error(\"Failed to fetch categories\");\n      const data = await res.json();\n      return data.categories || [];\n    },\n    staleTime: 5 * 60 * 1000,\n  });\n\n  const form = useForm<FeedbackFormData>({\n    resolver: zodResolver(feedbackFormSchema),\n    defaultValues: {\n      categoryId: undefined,\n      subject: \"\",\n      message: \"\",\n      priority: \"medium\",\n      isAnonymous: false,\n      contactEmail: \"\",\n      honeypot: \"\",\n    },\n  });\n\n  const isAnonymous = form.watch(\"isAnonymous\");\n\n  const submitMutation = useMutation({\n    mutationFn: async (data: FeedbackFormData) => {\n      const parsedCategoryId = data.categoryId && data.categoryId.trim() !== \"\" \n        ? parseInt(data.categoryId, 10) \n        : undefined;\n      \n      const payload: Record<string, unknown> = {\n        subject: data.subject,\n        message: data.message,\n        priority: data.priority,\n        isAnonymous: data.isAnonymous,\n        pageUrl: window.location.href,\n      };\n      \n      if (parsedCategoryId && !isNaN(parsedCategoryId)) {\n        payload.categoryId = parsedCategoryId;\n      }\n      \n      if (data.contactEmail && data.contactEmail.trim() !== \"\") {\n        payload.contactEmail = data.contactEmail.trim();\n      }\n\n      const res = await fetch(\"/api/feedback\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(payload),\n      });\n\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.message || \"Failed to submit feedback\");\n      }\n\n      return res.json();\n    },\n    onSuccess: () => {\n      toast.success(\"Feedback submitted successfully!\", {\n        description: \"Thank you for helping us improve TypeMasterAI.\",\n      });\n      form.reset();\n      setOpen(false);\n    },\n    onError: (error: Error) => {\n      toast.error(\"Failed to submit feedback\", {\n        description: error.message,\n      });\n    },\n  });\n\n  const onSubmit = (data: FeedbackFormData) => {\n    if (data.honeypot) {\n      form.reset();\n      setOpen(false);\n      return;\n    }\n    submitMutation.mutate(data);\n  };\n\n  const activeCategories = categories.filter(c => c.isActive);\n\n  return (\n    <Dialog open={open} onOpenChange={setOpen}>\n      <DialogTrigger asChild>\n        <Button\n          variant={triggerVariant}\n          size={triggerSize}\n          className={`${triggerClassName} relative overflow-hidden group bg-gradient-to-r from-cyan-600 via-purple-600 to-pink-600 hover:from-cyan-500 hover:via-purple-500 hover:to-pink-500 border-0 text-white transition-all duration-300 font-semibold`}\n          data-testid=\"button-open-feedback\"\n          aria-label=\"Give feedback\"\n        >\n          <MessageSquare className=\"h-5 w-5 mr-2 group-hover:scale-110 transition-transform duration-200\" />\n          <span>Feedback</span>\n        </Button>\n      </DialogTrigger>\n      \n      <DialogContent className=\"sm:max-w-[480px] p-0 gap-0 bg-card border-border\">\n        <DialogHeader className=\"px-5 pt-5 pb-3 space-y-1.5\">\n          <DialogTitle className=\"text-xl font-semibold\">Share feedback</DialogTitle>\n          <DialogDescription className=\"text-sm text-muted-foreground\">\n            Help us improve TypeMasterAI\n          </DialogDescription>\n        </DialogHeader>\n\n        <form onSubmit={form.handleSubmit(onSubmit)} className=\"px-5 pb-5 space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"category\" className=\"text-xs font-medium\">\n              Category\n            </Label>\n            <Select\n              value={form.watch(\"categoryId\") || \"\"}\n              onValueChange={(value) => form.setValue(\"categoryId\", value)}\n            >\n              <SelectTrigger id=\"category\" data-testid=\"select-feedback-category\" className=\"h-10\">\n                <SelectValue placeholder=\"Select a category (optional)\" />\n              </SelectTrigger>\n              <SelectContent>\n                {categoriesLoading ? (\n                  <SelectItem value=\"loading\" disabled>Loading categories...</SelectItem>\n                ) : activeCategories.length === 0 ? (\n                  <SelectItem value=\"none\" disabled>No categories available</SelectItem>\n                ) : (\n                  activeCategories.map((category) => (\n                    <SelectItem key={category.id} value={String(category.id)}>\n                      <div className=\"flex items-center gap-2\">\n                        {categoryIcons[category.slug] || <MessageCircle className=\"h-4 w-4\" />}\n                        <span>{category.name}</span>\n                      </div>\n                    </SelectItem>\n                  ))\n                )}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"subject\" className=\"text-xs font-medium\">\n              Subject <span className=\"text-destructive\">*</span>\n            </Label>\n            <Input\n              id=\"subject\"\n              placeholder=\"Brief summary of your feedback\"\n              {...form.register(\"subject\")}\n              data-testid=\"input-feedback-subject\"\n              className=\"h-10\"\n            />\n            {form.formState.errors.subject && (\n              <p className=\"text-xs text-destructive\" data-testid=\"text-error-subject\">\n                {form.formState.errors.subject.message}\n              </p>\n            )}\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"message\" className=\"text-xs font-medium\">\n              Message <span className=\"text-destructive\">*</span>\n            </Label>\n            <Textarea\n              id=\"message\"\n              placeholder=\"Describe your feedback in detail...\"\n              rows={3}\n              {...form.register(\"message\")}\n              data-testid=\"textarea-feedback-message\"\n              className=\"resize-none\"\n            />\n            {form.formState.errors.message && (\n              <p className=\"text-xs text-destructive\" data-testid=\"text-error-message\">\n                {form.formState.errors.message.message}\n              </p>\n            )}\n            <p className=\"text-xs text-muted-foreground\">\n              {form.watch(\"message\")?.length || 0} / 5000\n            </p>\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"priority\" className=\"text-xs font-medium\">Priority</Label>\n            <Select\n              value={form.watch(\"priority\")}\n              onValueChange={(value) => form.setValue(\"priority\", value as \"low\" | \"medium\" | \"high\" | \"critical\")}\n            >\n              <SelectTrigger id=\"priority\" data-testid=\"select-feedback-priority\" className=\"h-10\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                {Object.entries(priorityLabels).map(([value, { label, description }]) => (\n                  <SelectItem key={value} value={value}>\n                    <div className=\"flex flex-col items-start\">\n                      <span className=\"font-medium\">{label}</span>\n                      <span className=\"text-xs text-muted-foreground\">{description}</span>\n                    </div>\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          {user && (\n            <div className=\"flex items-center justify-between p-3 rounded-lg border bg-muted/30\">\n              <div className=\"space-y-0\">\n                <Label htmlFor=\"anonymous\" className=\"text-xs font-medium cursor-pointer\">\n                  Submit anonymously\n                </Label>\n              </div>\n              <Switch\n                id=\"anonymous\"\n                checked={form.watch(\"isAnonymous\")}\n                onCheckedChange={(checked) => form.setValue(\"isAnonymous\", checked)}\n                data-testid=\"switch-feedback-anonymous\"\n              />\n            </div>\n          )}\n\n          {(isAnonymous || !user) && (\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"contactEmail\" className=\"text-xs font-medium\">\n                Contact email <span className=\"text-muted-foreground text-[10px]\">(Optional)</span>\n              </Label>\n              <Input\n                id=\"contactEmail\"\n                type=\"email\"\n                placeholder=\"your@email.com\"\n                {...form.register(\"contactEmail\")}\n                data-testid=\"input-feedback-email\"\n                className=\"h-9\"\n              />\n              {form.formState.errors.contactEmail && (\n                <p className=\"text-xs text-destructive\" data-testid=\"text-error-email\">\n                  {form.formState.errors.contactEmail.message}\n                </p>\n              )}\n            </div>\n          )}\n\n          <input\n            type=\"text\"\n            {...form.register(\"honeypot\")}\n            className=\"absolute -left-[9999px] opacity-0 pointer-events-none\"\n            tabIndex={-1}\n            autoComplete=\"off\"\n            aria-hidden=\"true\"\n          />\n\n          <div className=\"flex gap-2 pt-1\">\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => setOpen(false)}\n              data-testid=\"button-cancel-feedback\"\n              className=\"flex-1 h-9\"\n            >\n              Cancel\n            </Button>\n            <Button\n              type=\"submit\"\n              disabled={submitMutation.isPending}\n              data-testid=\"button-submit-feedback\"\n              className=\"flex-1 h-9 bg-primary hover:bg-primary/90\"\n            >\n              {submitMutation.isPending ? (\n                <>\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                  Submitting...\n                </>\n              ) : (\n                \"Submit feedback\"\n              )}\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":13101,"size_tokens":null},"server/feedback-processor.ts":{"content":"import OpenAI from \"openai\";\nimport type { Feedback, FeedbackCategory } from \"@shared/schema\";\n\nconst openai = new OpenAI({\n  baseURL: process.env.AI_INTEGRATIONS_OPENAI_BASE_URL,\n  apiKey: process.env.AI_INTEGRATIONS_OPENAI_API_KEY\n});\n\nexport interface FeedbackAnalysis {\n  sentimentScore: number;\n  sentimentLabel: string;\n  aiCategoryId?: number;\n  aiSummary?: string;\n  aiPriorityScore?: number;\n  aiTags?: string[];\n}\n\nexport interface FeedbackInput {\n  id: number;\n  subject: string;\n  message: string;\n  priority: string;\n  categoryId: number | null;\n}\n\nexport interface StorageInterface {\n  getFeedbackCategories(): Promise<FeedbackCategory[]>;\n  updateFeedbackAiAnalysis(id: number, analysis: FeedbackAnalysis): Promise<unknown>;\n}\n\nlet cachedCategories: FeedbackCategory[] | null = null;\nlet categoryCacheTime = 0;\nconst CATEGORY_CACHE_TTL = 5 * 60 * 1000;\n\nasync function getCachedCategories(storage: StorageInterface): Promise<FeedbackCategory[]> {\n  const now = Date.now();\n  if (cachedCategories && now - categoryCacheTime < CATEGORY_CACHE_TTL) {\n    return cachedCategories;\n  }\n  \n  try {\n    cachedCategories = await storage.getFeedbackCategories();\n    categoryCacheTime = now;\n    return cachedCategories;\n  } catch (error) {\n    console.error(\"[FeedbackProcessor] Failed to fetch categories:\", error);\n    return cachedCategories || [];\n  }\n}\n\nasync function analyzeFeedbackContent(\n  feedback: FeedbackInput,\n  categories: FeedbackCategory[]\n): Promise<FeedbackAnalysis> {\n  const categoryList = categories\n    .map(c => `${c.id}: ${c.name} (${c.description || c.slug})`)\n    .join(\"\\n\");\n\n  const systemPrompt = `You are an AI feedback analyst for TypeMasterAI, a typing practice application. Your job is to analyze user feedback and provide structured insights.\n\nAvailable feedback categories:\n${categoryList}\n\nAnalyze the feedback and respond with a JSON object containing:\n1. sentimentScore: A number from -1 (very negative) to 1 (very positive). 0 is neutral.\n2. sentimentLabel: One of \"negative\" (score < -0.2), \"neutral\" (-0.2 to 0.2), or \"positive\" (> 0.2)\n3. suggestedCategoryId: The ID of the most appropriate category from the list above (integer or null if uncertain)\n4. summary: A 1-2 sentence summary of the feedback (max 150 chars)\n5. priorityScore: A number from 0 to 1 indicating urgency. Consider:\n   - 0.0-0.3: Low priority (general suggestions, minor improvements)\n   - 0.3-0.5: Medium priority (feature requests, usability issues)\n   - 0.5-0.7: High priority (significant bugs, important features)\n   - 0.7-1.0: Critical (security issues, data loss, broken core features)\n6. tags: An array of 2-5 relevant tags (lowercase, hyphenated, e.g., \"ui-bug\", \"performance\", \"feature-request\")\n\nConsider the user-selected priority when calculating priorityScore:\n- User priority \"critical\" should push score towards 0.7+\n- User priority \"high\" should push score towards 0.5+\n- User priority \"low\" should cap score at 0.5 unless content suggests critical issue\n\nRespond ONLY with valid JSON, no markdown or explanation.`;\n\n  const userPrompt = `Analyze this feedback:\n\nSubject: ${feedback.subject}\nMessage: ${feedback.message}\nUser-Selected Priority: ${feedback.priority}\nUser-Selected Category ID: ${feedback.categoryId || \"None\"}`;\n\n  try {\n    const response = await openai.chat.completions.create({\n      model: \"gpt-4o-mini\",\n      messages: [\n        { role: \"system\", content: systemPrompt },\n        { role: \"user\", content: userPrompt }\n      ],\n      temperature: 0.3,\n      max_tokens: 500,\n      response_format: { type: \"json_object\" }\n    });\n\n    const content = response.choices[0]?.message?.content;\n    if (!content) {\n      console.error(\"[FeedbackProcessor] Empty response from OpenAI\");\n      return getDefaultAnalysis(feedback.priority);\n    }\n\n    const parsed = JSON.parse(content);\n    \n    const sentimentScore = Math.max(-1, Math.min(1, Number(parsed.sentimentScore) || 0));\n    let sentimentLabel: string;\n    if (sentimentScore < -0.2) {\n      sentimentLabel = \"negative\";\n    } else if (sentimentScore > 0.2) {\n      sentimentLabel = \"positive\";\n    } else {\n      sentimentLabel = \"neutral\";\n    }\n\n    const aiCategoryId = parsed.suggestedCategoryId && \n      categories.some(c => c.id === parsed.suggestedCategoryId)\n      ? parsed.suggestedCategoryId\n      : undefined;\n\n    const aiPriorityScore = Math.max(0, Math.min(1, Number(parsed.priorityScore) || 0.3));\n\n    const aiTags = Array.isArray(parsed.tags)\n      ? parsed.tags\n          .slice(0, 5)\n          .map((t: unknown) => String(t).toLowerCase().replace(/\\s+/g, \"-\").slice(0, 30))\n          .filter((t: string) => t.length > 0)\n      : [];\n\n    const aiSummary = typeof parsed.summary === \"string\"\n      ? parsed.summary.slice(0, 200)\n      : \"Feedback submitted.\";\n\n    return {\n      sentimentScore,\n      sentimentLabel,\n      aiCategoryId,\n      aiSummary,\n      aiPriorityScore,\n      aiTags\n    };\n  } catch (error) {\n    console.error(\"[FeedbackProcessor] Error analyzing feedback:\", error);\n    return getDefaultAnalysis(feedback.priority);\n  }\n}\n\nfunction getDefaultAnalysis(priority: string): FeedbackAnalysis {\n  const priorityScores: Record<string, number> = {\n    critical: 0.8,\n    high: 0.6,\n    medium: 0.4,\n    low: 0.2\n  };\n\n  return {\n    sentimentScore: 0,\n    sentimentLabel: \"neutral\",\n    aiCategoryId: undefined,\n    aiSummary: \"Unable to analyze feedback automatically.\",\n    aiPriorityScore: priorityScores[priority] || 0.4,\n    aiTags: []\n  };\n}\n\nexport function processFeedbackInBackground(\n  feedbackId: number,\n  feedback: FeedbackInput,\n  storage: StorageInterface\n): void {\n  setImmediate(async () => {\n    try {\n      console.log(`[FeedbackProcessor] Starting analysis for feedback #${feedbackId}`);\n      const startTime = Date.now();\n\n      const categories = await getCachedCategories(storage);\n      const analysis = await analyzeFeedbackContent(feedback, categories);\n      \n      await storage.updateFeedbackAiAnalysis(feedbackId, analysis);\n\n      const duration = Date.now() - startTime;\n      console.log(`[FeedbackProcessor] Completed analysis for feedback #${feedbackId} in ${duration}ms`);\n      console.log(`[FeedbackProcessor] Results: sentiment=${analysis.sentimentLabel} (${analysis.sentimentScore.toFixed(2)}), priority=${(analysis.aiPriorityScore || 0).toFixed(2)}, tags=${(analysis.aiTags || []).join(\", \")}`);\n    } catch (error) {\n      console.error(`[FeedbackProcessor] Failed to process feedback #${feedbackId}:`, error);\n    }\n  });\n}\n","path":null,"size_bytes":6521,"size_tokens":null},"client/src/pages/admin/feedback.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useAuth } from \"@/lib/auth-context\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\nimport { Tooltip, TooltipContent, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as ChartTooltip, ResponsiveContainer, Legend } from \"recharts\";\nimport { toast } from \"sonner\";\nimport { format, parseISO, subDays } from \"date-fns\";\nimport {\n  MessageSquare, Search, Filter, RefreshCw, Loader2, AlertTriangle, ChevronLeft, ChevronRight,\n  Clock, User, Tag, Flag, Activity, TrendingUp, Send, Eye, EyeOff, Archive,\n  Bug, Lightbulb, MessageCircle, Palette, Zap, FileText, Shield, BarChart2, History\n} from \"lucide-react\";\nimport { Link } from \"wouter\";\n\ninterface FeedbackCategory {\n  id: number;\n  name: string;\n  slug: string;\n  description: string | null;\n  icon: string | null;\n  color: string | null;\n  isActive: boolean;\n  sortOrder: number;\n}\n\ninterface Feedback {\n  id: number;\n  userId: string | null;\n  isAnonymous: boolean;\n  contactEmail: string | null;\n  categoryId: number | null;\n  subject: string;\n  message: string;\n  priority: string;\n  status: string;\n  sentimentScore: number | null;\n  sentimentLabel: string | null;\n  aiCategoryId: number | null;\n  aiSummary: string | null;\n  aiPriorityScore: number | null;\n  aiTags: string[] | null;\n  aiProcessedAt: string | null;\n  source: string;\n  pageUrl: string | null;\n  resolvedAt: string | null;\n  resolvedByUserId: string | null;\n  resolutionNotes: string | null;\n  userNotified: boolean;\n  isSpam: boolean;\n  isArchived: boolean;\n  upvotes: number;\n  createdAt: string;\n  updatedAt: string;\n}\n\ninterface FeedbackResponse {\n  id: number;\n  feedbackId: number;\n  adminUserId: string;\n  message: string;\n  isInternalNote: boolean;\n  templateName: string | null;\n  createdAt: string;\n  adminUsername?: string;\n}\n\ninterface FeedbackStatusHistory {\n  id: number;\n  feedbackId: number;\n  previousStatus: string | null;\n  newStatus: string;\n  previousPriority: string | null;\n  newPriority: string | null;\n  changedByUserId: string | null;\n  changeReason: string | null;\n  isAutomated: boolean;\n  createdAt: string;\n  changedByUsername?: string;\n}\n\ninterface FeedbackListResponse {\n  feedback: Feedback[];\n  pagination: {\n    page: number;\n    limit: number;\n    total: number;\n    totalPages: number;\n  };\n}\n\ninterface FeedbackDetailResponse {\n  feedback: Feedback;\n  responses: FeedbackResponse[];\n  history: FeedbackStatusHistory[];\n  attachments: any[];\n  category: FeedbackCategory | null;\n}\n\ninterface AnalyticsData {\n  totalFeedback: number;\n  statusBreakdown: Record<string, number>;\n  priorityBreakdown: Record<string, number>;\n  sentimentBreakdown: { negative: number; neutral: number; positive: number };\n  categoryBreakdown: Record<string, number>;\n  averageResolutionTimeHours: number | null;\n  recentTrend: number;\n}\n\nconst categoryIcons: Record<string, React.ReactNode> = {\n  \"bug-report\": <Bug className=\"h-4 w-4\" />,\n  \"feature-request\": <Lightbulb className=\"h-4 w-4\" />,\n  \"general-feedback\": <MessageCircle className=\"h-4 w-4\" />,\n  \"ux-ui-improvement\": <Palette className=\"h-4 w-4\" />,\n  \"performance-issue\": <Zap className=\"h-4 w-4\" />,\n  \"content-issue\": <FileText className=\"h-4 w-4\" />,\n};\n\nconst statusColors: Record<string, string> = {\n  new: \"bg-blue-500\",\n  under_review: \"bg-yellow-500\",\n  in_progress: \"bg-purple-500\",\n  resolved: \"bg-green-500\",\n  closed: \"bg-gray-500\",\n  wont_fix: \"bg-red-500\",\n};\n\nconst statusLabels: Record<string, string> = {\n  new: \"New\",\n  under_review: \"Under Review\",\n  in_progress: \"In Progress\",\n  resolved: \"Resolved\",\n  closed: \"Closed\",\n  wont_fix: \"Won't Fix\",\n};\n\nconst priorityColors: Record<string, string> = {\n  low: \"bg-gray-400\",\n  medium: \"bg-blue-500\",\n  high: \"bg-orange-500\",\n  critical: \"bg-red-600\",\n};\n\nconst sentimentColors: Record<string, string> = {\n  negative: \"#ef4444\",\n  neutral: \"#6b7280\",\n  positive: \"#22c55e\",\n};\n\nconst CHART_COLORS = [\"#3b82f6\", \"#22c55e\", \"#f59e0b\", \"#ef4444\", \"#8b5cf6\", \"#ec4899\"];\n\nexport default function AdminFeedbackDashboard() {\n  const { user } = useAuth();\n  const queryClient = useQueryClient();\n\n  const [page, setPage] = useState(1);\n  const [limit] = useState(20);\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState<string>(\"all\");\n  const [priorityFilter, setPriorityFilter] = useState<string>(\"all\");\n  const [categoryFilter, setCategoryFilter] = useState<string>(\"all\");\n  const [selectedFeedbackId, setSelectedFeedbackId] = useState<number | null>(null);\n  const [detailDialogOpen, setDetailDialogOpen] = useState(false);\n  const [responseMessage, setResponseMessage] = useState(\"\");\n  const [isInternalNote, setIsInternalNote] = useState(false);\n  const [statusChangeReason, setStatusChangeReason] = useState(\"\");\n  const [newStatus, setNewStatus] = useState<string>(\"\");\n  const [newPriority, setNewPriority] = useState<string>(\"\");\n\n  const { data: adminCheck, isLoading: adminCheckLoading, error: adminCheckError } = useQuery({\n    queryKey: [\"feedback-admin-check\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/feedback?page=1&limit=1\", { credentials: \"include\" });\n      if (res.status === 403) {\n        return { isAdmin: false };\n      }\n      if (!res.ok) throw new Error(\"Failed to check admin status\");\n      return { isAdmin: true };\n    },\n    retry: false,\n  });\n\n  const { data: categories = [] } = useQuery<FeedbackCategory[]>({\n    queryKey: [\"feedback-categories\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/feedback/categories\", { \n        credentials: \"include\",\n        cache: \"no-store\",\n      });\n      if (!res.ok) throw new Error(\"Failed to fetch categories\");\n      const data = await res.json();\n      return data.categories || [];\n    },\n    enabled: adminCheck?.isAdmin,\n    staleTime: 5 * 60 * 1000,\n  });\n\n  const { data: feedbackList, isLoading: feedbackLoading, refetch: refetchFeedback } = useQuery<FeedbackListResponse>({\n    queryKey: [\"admin-feedback-list\", page, limit, statusFilter, priorityFilter, categoryFilter, searchQuery],\n    queryFn: async () => {\n      const params = new URLSearchParams({\n        page: String(page),\n        limit: String(limit),\n      });\n      if (statusFilter !== \"all\") params.append(\"status\", statusFilter);\n      if (priorityFilter !== \"all\") params.append(\"priority\", priorityFilter);\n      if (categoryFilter !== \"all\") params.append(\"categoryId\", categoryFilter);\n      if (searchQuery.trim()) params.append(\"search\", searchQuery.trim());\n\n      const res = await fetch(`/api/admin/feedback?${params}`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch feedback\");\n      return res.json();\n    },\n    enabled: adminCheck?.isAdmin,\n    staleTime: 30000,\n  });\n\n  const { data: analyticsData, isLoading: analyticsLoading } = useQuery<AnalyticsData>({\n    queryKey: [\"admin-feedback-analytics\"],\n    queryFn: async () => {\n      const res = await fetch(\"/api/admin/feedback/analytics\", { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch analytics\");\n      return res.json();\n    },\n    enabled: adminCheck?.isAdmin,\n    staleTime: 60000,\n  });\n\n  const { data: feedbackDetail, isLoading: detailLoading } = useQuery<FeedbackDetailResponse>({\n    queryKey: [\"admin-feedback-detail\", selectedFeedbackId],\n    queryFn: async () => {\n      const res = await fetch(`/api/admin/feedback/${selectedFeedbackId}`, { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch feedback detail\");\n      return res.json();\n    },\n    enabled: !!selectedFeedbackId && detailDialogOpen,\n  });\n\n  const updateStatusMutation = useMutation({\n    mutationFn: async ({ id, status, priority, changeReason, resolutionNotes, notifyUser }: {\n      id: number;\n      status: string;\n      priority?: string;\n      changeReason?: string;\n      resolutionNotes?: string;\n      notifyUser?: boolean;\n    }) => {\n      const res = await fetch(`/api/admin/feedback/${id}/status`, {\n        method: \"PATCH\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ status, priority, changeReason, resolutionNotes, notifyUser }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.message || \"Failed to update status\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      toast.success(\"Status updated successfully\");\n      queryClient.invalidateQueries({ queryKey: [\"admin-feedback-list\"] });\n      queryClient.invalidateQueries({ queryKey: [\"admin-feedback-detail\", selectedFeedbackId] });\n      queryClient.invalidateQueries({ queryKey: [\"admin-feedback-analytics\"] });\n      setStatusChangeReason(\"\");\n      setNewStatus(\"\");\n      setNewPriority(\"\");\n    },\n    onError: (error: Error) => {\n      toast.error(\"Failed to update status\", { description: error.message });\n    },\n  });\n\n  const addResponseMutation = useMutation({\n    mutationFn: async ({ id, message, isInternalNote }: { id: number; message: string; isInternalNote: boolean }) => {\n      const res = await fetch(`/api/admin/feedback/${id}/responses`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ message, isInternalNote }),\n      });\n      if (!res.ok) {\n        const error = await res.json();\n        throw new Error(error.message || \"Failed to add response\");\n      }\n      return res.json();\n    },\n    onSuccess: () => {\n      toast.success(\"Response added successfully\");\n      queryClient.invalidateQueries({ queryKey: [\"admin-feedback-detail\", selectedFeedbackId] });\n      setResponseMessage(\"\");\n      setIsInternalNote(false);\n    },\n    onError: (error: Error) => {\n      toast.error(\"Failed to add response\", { description: error.message });\n    },\n  });\n\n  const archiveMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const res = await fetch(`/api/admin/feedback/${id}/archive`, {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n      if (!res.ok) throw new Error(\"Failed to archive feedback\");\n      return res.json();\n    },\n    onSuccess: () => {\n      toast.success(\"Feedback archived\");\n      queryClient.invalidateQueries({ queryKey: [\"admin-feedback-list\"] });\n      queryClient.invalidateQueries({ queryKey: [\"admin-feedback-analytics\"] });\n      setDetailDialogOpen(false);\n    },\n    onError: () => {\n      toast.error(\"Failed to archive feedback\");\n    },\n  });\n\n  const markSpamMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const res = await fetch(`/api/admin/feedback/${id}/spam`, {\n        method: \"POST\",\n        credentials: \"include\",\n      });\n      if (!res.ok) throw new Error(\"Failed to mark as spam\");\n      return res.json();\n    },\n    onSuccess: () => {\n      toast.success(\"Marked as spam\");\n      queryClient.invalidateQueries({ queryKey: [\"admin-feedback-list\"] });\n      queryClient.invalidateQueries({ queryKey: [\"admin-feedback-analytics\"] });\n      setDetailDialogOpen(false);\n    },\n    onError: () => {\n      toast.error(\"Failed to mark as spam\");\n    },\n  });\n\n  const handleOpenDetail = (id: number) => {\n    setSelectedFeedbackId(id);\n    setDetailDialogOpen(true);\n  };\n\n  const handleStatusUpdate = () => {\n    if (!selectedFeedbackId || !newStatus) return;\n    updateStatusMutation.mutate({\n      id: selectedFeedbackId,\n      status: newStatus,\n      priority: newPriority || undefined,\n      changeReason: statusChangeReason || undefined,\n    });\n  };\n\n  const handleAddResponse = () => {\n    if (!selectedFeedbackId || !responseMessage.trim()) return;\n    addResponseMutation.mutate({\n      id: selectedFeedbackId,\n      message: responseMessage.trim(),\n      isInternalNote,\n    });\n  };\n\n  if (adminCheckLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n      </div>\n    );\n  }\n\n  if (!user) {\n    return (\n      <div className=\"container max-w-4xl py-8\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center\">\n              <Shield className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold mb-2\">Authentication Required</h2>\n              <p className=\"text-muted-foreground mb-4\">Please log in to access the admin dashboard.</p>\n              <Link href=\"/login\">\n                <Button data-testid=\"link-login\">Log In</Button>\n              </Link>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (!adminCheck?.isAdmin) {\n    return (\n      <div className=\"container max-w-4xl py-8\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center\">\n              <AlertTriangle className=\"h-12 w-12 text-destructive mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold mb-2\">Access Denied</h2>\n              <p className=\"text-muted-foreground mb-4\">\n                You don't have permission to access the feedback admin dashboard.\n              </p>\n              <Link href=\"/\">\n                <Button variant=\"outline\" data-testid=\"link-home\">Return Home</Button>\n              </Link>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  const statusChartData = analyticsData?.statusBreakdown\n    ? Object.entries(analyticsData.statusBreakdown).map(([name, value]) => ({\n        name: statusLabels[name] || name,\n        value,\n      }))\n    : [];\n\n  const sentimentChartData = analyticsData?.sentimentBreakdown\n    ? [\n        { name: \"Negative\", value: analyticsData.sentimentBreakdown.negative, fill: sentimentColors.negative },\n        { name: \"Neutral\", value: analyticsData.sentimentBreakdown.neutral, fill: sentimentColors.neutral },\n        { name: \"Positive\", value: analyticsData.sentimentBreakdown.positive, fill: sentimentColors.positive },\n      ]\n    : [];\n\n  const priorityChartData = analyticsData?.priorityBreakdown\n    ? Object.entries(analyticsData.priorityBreakdown).map(([name, value]) => ({\n        name: name.charAt(0).toUpperCase() + name.slice(1),\n        value,\n      }))\n    : [];\n\n  return (\n    <div className=\"container max-w-7xl py-6 space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h1 className=\"text-3xl font-bold tracking-tight\">Feedback Dashboard</h1>\n          <p className=\"text-muted-foreground\">Manage and respond to user feedback</p>\n        </div>\n        <Button variant=\"outline\" size=\"sm\" onClick={() => refetchFeedback()} data-testid=\"button-refresh-feedback\">\n          <RefreshCw className=\"h-4 w-4 mr-2\" />\n          Refresh\n        </Button>\n      </div>\n\n      <Tabs defaultValue=\"list\" className=\"space-y-6\">\n        <TabsList>\n          <TabsTrigger value=\"list\" data-testid=\"tab-feedback-list\">\n            <MessageSquare className=\"h-4 w-4 mr-2\" />\n            Feedback List\n          </TabsTrigger>\n          <TabsTrigger value=\"analytics\" data-testid=\"tab-feedback-analytics\">\n            <BarChart2 className=\"h-4 w-4 mr-2\" />\n            Analytics\n          </TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"list\" className=\"space-y-4\">\n          <Card>\n            <CardHeader className=\"pb-4\">\n              <div className=\"flex flex-col md:flex-row gap-4 items-start md:items-center justify-between\">\n                <div className=\"relative flex-1 max-w-md\">\n                  <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                  <Input\n                    placeholder=\"Search feedback...\"\n                    value={searchQuery}\n                    onChange={(e) => {\n                      setSearchQuery(e.target.value);\n                      setPage(1);\n                    }}\n                    className=\"pl-10\"\n                    data-testid=\"input-search-feedback\"\n                  />\n                </div>\n                <div className=\"flex flex-wrap gap-2\">\n                  <Select value={statusFilter} onValueChange={(v) => { setStatusFilter(v); setPage(1); }}>\n                    <SelectTrigger className=\"w-[140px]\" data-testid=\"select-filter-status\">\n                      <SelectValue placeholder=\"Status\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Status</SelectItem>\n                      {Object.entries(statusLabels).map(([value, label]) => (\n                        <SelectItem key={value} value={value}>{label}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n\n                  <Select value={priorityFilter} onValueChange={(v) => { setPriorityFilter(v); setPage(1); }}>\n                    <SelectTrigger className=\"w-[130px]\" data-testid=\"select-filter-priority\">\n                      <SelectValue placeholder=\"Priority\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Priority</SelectItem>\n                      <SelectItem value=\"low\">Low</SelectItem>\n                      <SelectItem value=\"medium\">Medium</SelectItem>\n                      <SelectItem value=\"high\">High</SelectItem>\n                      <SelectItem value=\"critical\">Critical</SelectItem>\n                    </SelectContent>\n                  </Select>\n\n                  <Select value={categoryFilter} onValueChange={(v) => { setCategoryFilter(v); setPage(1); }}>\n                    <SelectTrigger className=\"w-[150px]\" data-testid=\"select-filter-category\">\n                      <SelectValue placeholder=\"Category\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"all\">All Categories</SelectItem>\n                      {categories.filter(c => c.isActive).map((cat) => (\n                        <SelectItem key={cat.id} value={String(cat.id)}>{cat.name}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"p-0\">\n              {feedbackLoading ? (\n                <div className=\"flex items-center justify-center py-12\">\n                  <Loader2 className=\"h-6 w-6 animate-spin text-primary\" />\n                </div>\n              ) : !feedbackList?.feedback.length ? (\n                <div className=\"text-center py-12 text-muted-foreground\">\n                  <MessageSquare className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No feedback found matching your criteria.</p>\n                </div>\n              ) : (\n                <>\n                  <div className=\"overflow-x-auto\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead className=\"w-[60px]\">ID</TableHead>\n                          <TableHead>Subject</TableHead>\n                          <TableHead className=\"w-[120px]\">Category</TableHead>\n                          <TableHead className=\"w-[100px]\">Priority</TableHead>\n                          <TableHead className=\"w-[120px]\">Status</TableHead>\n                          <TableHead className=\"w-[100px]\">Sentiment</TableHead>\n                          <TableHead className=\"w-[150px]\">Created</TableHead>\n                          <TableHead className=\"w-[80px]\">Actions</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {feedbackList.feedback.map((fb) => {\n                          const category = categories.find(c => c.id === fb.categoryId);\n                          return (\n                            <TableRow\n                              key={fb.id}\n                              className=\"cursor-pointer hover:bg-muted/50\"\n                              onClick={() => handleOpenDetail(fb.id)}\n                              data-testid={`row-feedback-${fb.id}`}\n                            >\n                              <TableCell className=\"font-mono text-sm\">#{fb.id}</TableCell>\n                              <TableCell>\n                                <div className=\"max-w-[300px] truncate font-medium\">{fb.subject}</div>\n                                {fb.isAnonymous && (\n                                  <span className=\"text-xs text-muted-foreground\">(Anonymous)</span>\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {category ? (\n                                  <div className=\"flex items-center gap-1.5\">\n                                    {categoryIcons[category.slug] || <Tag className=\"h-3.5 w-3.5\" />}\n                                    <span className=\"text-sm\">{category.name}</span>\n                                  </div>\n                                ) : (\n                                  <span className=\"text-muted-foreground text-sm\">â€”</span>\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                <Badge variant=\"secondary\" className={`${priorityColors[fb.priority]} text-white`}>\n                                  {fb.priority.charAt(0).toUpperCase() + fb.priority.slice(1)}\n                                </Badge>\n                              </TableCell>\n                              <TableCell>\n                                <Badge variant=\"secondary\" className={`${statusColors[fb.status]} text-white`}>\n                                  {statusLabels[fb.status] || fb.status}\n                                </Badge>\n                              </TableCell>\n                              <TableCell>\n                                {fb.sentimentLabel ? (\n                                  <Badge\n                                    variant=\"outline\"\n                                    style={{ borderColor: sentimentColors[fb.sentimentLabel] }}\n                                    className=\"capitalize\"\n                                  >\n                                    {fb.sentimentLabel}\n                                  </Badge>\n                                ) : (\n                                  <span className=\"text-muted-foreground text-sm\">â€”</span>\n                                )}\n                              </TableCell>\n                              <TableCell className=\"text-sm text-muted-foreground\">\n                                {format(parseISO(fb.createdAt), \"MMM d, yyyy HH:mm\")}\n                              </TableCell>\n                              <TableCell>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"icon\"\n                                  onClick={(e) => { e.stopPropagation(); handleOpenDetail(fb.id); }}\n                                  data-testid={`button-view-feedback-${fb.id}`}\n                                >\n                                  <Eye className=\"h-4 w-4\" />\n                                </Button>\n                              </TableCell>\n                            </TableRow>\n                          );\n                        })}\n                      </TableBody>\n                    </Table>\n                  </div>\n\n                  {feedbackList.pagination.totalPages > 1 && (\n                    <div className=\"flex items-center justify-between px-4 py-3 border-t\">\n                      <p className=\"text-sm text-muted-foreground\">\n                        Showing {((page - 1) * limit) + 1} to {Math.min(page * limit, feedbackList.pagination.total)} of {feedbackList.pagination.total} entries\n                      </p>\n                      <div className=\"flex items-center gap-2\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          disabled={page === 1}\n                          onClick={() => setPage(p => p - 1)}\n                          data-testid=\"button-prev-page\"\n                        >\n                          <ChevronLeft className=\"h-4 w-4\" />\n                        </Button>\n                        <span className=\"text-sm\">\n                          Page {page} of {feedbackList.pagination.totalPages}\n                        </span>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          disabled={page >= feedbackList.pagination.totalPages}\n                          onClick={() => setPage(p => p + 1)}\n                          data-testid=\"button-next-page\"\n                        >\n                          <ChevronRight className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n                </>\n              )}\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"analytics\" className=\"space-y-6\">\n          {analyticsLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"h-6 w-6 animate-spin text-primary\" />\n            </div>\n          ) : !analyticsData ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              <BarChart2 className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n              <p>No analytics data available.</p>\n            </div>\n          ) : (\n            <>\n              <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n                <Card>\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Total Feedback</p>\n                        <p className=\"text-3xl font-bold\">{analyticsData.totalFeedback}</p>\n                      </div>\n                      <MessageSquare className=\"h-8 w-8 text-primary opacity-80\" />\n                    </div>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Pending Review</p>\n                        <p className=\"text-3xl font-bold\">\n                          {(analyticsData.statusBreakdown?.new || 0) + (analyticsData.statusBreakdown?.under_review || 0)}\n                        </p>\n                      </div>\n                      <Clock className=\"h-8 w-8 text-yellow-500 opacity-80\" />\n                    </div>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Resolved</p>\n                        <p className=\"text-3xl font-bold\">{analyticsData.statusBreakdown?.resolved || 0}</p>\n                      </div>\n                      <Activity className=\"h-8 w-8 text-green-500 opacity-80\" />\n                    </div>\n                  </CardContent>\n                </Card>\n                <Card>\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Avg Resolution Time</p>\n                        <p className=\"text-3xl font-bold\">\n                          {analyticsData.averageResolutionTimeHours \n                            ? `${Math.round(analyticsData.averageResolutionTimeHours)}h`\n                            : \"â€”\"}\n                        </p>\n                      </div>\n                      <TrendingUp className=\"h-8 w-8 text-blue-500 opacity-80\" />\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-lg\">Status Distribution</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <ResponsiveContainer width=\"100%\" height={250}>\n                      <PieChart>\n                        <Pie\n                          data={statusChartData}\n                          dataKey=\"value\"\n                          nameKey=\"name\"\n                          cx=\"50%\"\n                          cy=\"50%\"\n                          outerRadius={80}\n                          label={({ name, percent }) => `${name} (${(percent * 100).toFixed(0)}%)`}\n                        >\n                          {statusChartData.map((_, index) => (\n                            <Cell key={`cell-${index}`} fill={CHART_COLORS[index % CHART_COLORS.length]} />\n                          ))}\n                        </Pie>\n                        <ChartTooltip />\n                      </PieChart>\n                    </ResponsiveContainer>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-lg\">Sentiment Analysis</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <ResponsiveContainer width=\"100%\" height={250}>\n                      <PieChart>\n                        <Pie\n                          data={sentimentChartData}\n                          dataKey=\"value\"\n                          nameKey=\"name\"\n                          cx=\"50%\"\n                          cy=\"50%\"\n                          outerRadius={80}\n                          label={({ name, percent }) => `${name} (${(percent * 100).toFixed(0)}%)`}\n                        >\n                          {sentimentChartData.map((entry, index) => (\n                            <Cell key={`cell-${index}`} fill={entry.fill} />\n                          ))}\n                        </Pie>\n                        <ChartTooltip />\n                      </PieChart>\n                    </ResponsiveContainer>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"text-lg\">Priority Breakdown</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <ResponsiveContainer width=\"100%\" height={250}>\n                      <BarChart data={priorityChartData}>\n                        <CartesianGrid strokeDasharray=\"3 3\" stroke=\"hsl(var(--border))\" />\n                        <XAxis dataKey=\"name\" tick={{ fill: 'hsl(var(--muted-foreground))' }} />\n                        <YAxis tick={{ fill: 'hsl(var(--muted-foreground))' }} />\n                        <ChartTooltip\n                          contentStyle={{\n                            backgroundColor: 'hsl(var(--card))',\n                            borderColor: 'hsl(var(--border))',\n                          }}\n                        />\n                        <Bar dataKey=\"value\" fill=\"hsl(var(--primary))\" radius={[4, 4, 0, 0]} />\n                      </BarChart>\n                    </ResponsiveContainer>\n                  </CardContent>\n                </Card>\n              </div>\n            </>\n          )}\n        </TabsContent>\n      </Tabs>\n\n      <Dialog open={detailDialogOpen} onOpenChange={setDetailDialogOpen}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-hidden flex flex-col\">\n          {detailLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <Loader2 className=\"h-6 w-6 animate-spin text-primary\" />\n            </div>\n          ) : feedbackDetail ? (\n            <>\n              <DialogHeader>\n                <div className=\"flex items-start justify-between gap-4\">\n                  <div>\n                    <DialogTitle className=\"text-xl\">\n                      #{feedbackDetail.feedback.id}: {feedbackDetail.feedback.subject}\n                    </DialogTitle>\n                    <DialogDescription className=\"mt-1\">\n                      {feedbackDetail.feedback.isAnonymous ? \"Anonymous\" : `User ID: ${feedbackDetail.feedback.userId}`}\n                      {feedbackDetail.feedback.contactEmail && ` â€¢ ${feedbackDetail.feedback.contactEmail}`}\n                      {\" â€¢ \"}Submitted {format(parseISO(feedbackDetail.feedback.createdAt), \"MMMM d, yyyy 'at' HH:mm\")}\n                    </DialogDescription>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <Badge className={`${priorityColors[feedbackDetail.feedback.priority]} text-white`}>\n                      {feedbackDetail.feedback.priority.charAt(0).toUpperCase() + feedbackDetail.feedback.priority.slice(1)}\n                    </Badge>\n                    <Badge className={`${statusColors[feedbackDetail.feedback.status]} text-white`}>\n                      {statusLabels[feedbackDetail.feedback.status]}\n                    </Badge>\n                  </div>\n                </div>\n              </DialogHeader>\n\n              <ScrollArea className=\"flex-1 pr-4\">\n                <Tabs defaultValue=\"details\" className=\"space-y-4\">\n                  <TabsList>\n                    <TabsTrigger value=\"details\">Details</TabsTrigger>\n                    <TabsTrigger value=\"responses\">\n                      Responses ({feedbackDetail.responses.length})\n                    </TabsTrigger>\n                    <TabsTrigger value=\"history\">\n                      History ({feedbackDetail.history.length})\n                    </TabsTrigger>\n                  </TabsList>\n\n                  <TabsContent value=\"details\" className=\"space-y-4\">\n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                      <Card>\n                        <CardHeader className=\"pb-2\">\n                          <CardTitle className=\"text-sm font-medium\">Message</CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                          <p className=\"text-sm whitespace-pre-wrap\">{feedbackDetail.feedback.message}</p>\n                        </CardContent>\n                      </Card>\n\n                      <div className=\"space-y-4\">\n                        {feedbackDetail.feedback.aiSummary && (\n                          <Card>\n                            <CardHeader className=\"pb-2\">\n                              <CardTitle className=\"text-sm font-medium flex items-center gap-2\">\n                                <Activity className=\"h-4 w-4\" />\n                                AI Analysis\n                              </CardTitle>\n                            </CardHeader>\n                            <CardContent className=\"space-y-2\">\n                              <p className=\"text-sm\">{feedbackDetail.feedback.aiSummary}</p>\n                              {feedbackDetail.feedback.sentimentScore !== null && (\n                                <div className=\"flex items-center gap-2\">\n                                  <span className=\"text-xs text-muted-foreground\">Sentiment:</span>\n                                  <Badge\n                                    variant=\"outline\"\n                                    style={{ borderColor: sentimentColors[feedbackDetail.feedback.sentimentLabel || \"neutral\"] }}\n                                    className=\"capitalize\"\n                                  >\n                                    {feedbackDetail.feedback.sentimentLabel} ({(feedbackDetail.feedback.sentimentScore * 100).toFixed(0)}%)\n                                  </Badge>\n                                </div>\n                              )}\n                              {feedbackDetail.feedback.aiTags && feedbackDetail.feedback.aiTags.length > 0 && (\n                                <div className=\"flex flex-wrap gap-1\">\n                                  {feedbackDetail.feedback.aiTags.map((tag, i) => (\n                                    <Badge key={i} variant=\"secondary\" className=\"text-xs\">{tag}</Badge>\n                                  ))}\n                                </div>\n                              )}\n                            </CardContent>\n                          </Card>\n                        )}\n\n                        <Card>\n                          <CardHeader className=\"pb-2\">\n                            <CardTitle className=\"text-sm font-medium\">Update Status</CardTitle>\n                          </CardHeader>\n                          <CardContent className=\"space-y-3\">\n                            <div className=\"grid grid-cols-2 gap-2\">\n                              <div>\n                                <Label className=\"text-xs\">Status</Label>\n                                <Select value={newStatus} onValueChange={setNewStatus}>\n                                  <SelectTrigger data-testid=\"select-new-status\">\n                                    <SelectValue placeholder=\"Change status\" />\n                                  </SelectTrigger>\n                                  <SelectContent>\n                                    {Object.entries(statusLabels).map(([value, label]) => (\n                                      <SelectItem key={value} value={value}>{label}</SelectItem>\n                                    ))}\n                                  </SelectContent>\n                                </Select>\n                              </div>\n                              <div>\n                                <Label className=\"text-xs\">Priority</Label>\n                                <Select value={newPriority} onValueChange={setNewPriority}>\n                                  <SelectTrigger data-testid=\"select-new-priority\">\n                                    <SelectValue placeholder=\"Change priority\" />\n                                  </SelectTrigger>\n                                  <SelectContent>\n                                    <SelectItem value=\"low\">Low</SelectItem>\n                                    <SelectItem value=\"medium\">Medium</SelectItem>\n                                    <SelectItem value=\"high\">High</SelectItem>\n                                    <SelectItem value=\"critical\">Critical</SelectItem>\n                                  </SelectContent>\n                                </Select>\n                              </div>\n                            </div>\n                            <div>\n                              <Label className=\"text-xs\">Reason (optional)</Label>\n                              <Input\n                                value={statusChangeReason}\n                                onChange={(e) => setStatusChangeReason(e.target.value)}\n                                placeholder=\"Why are you changing the status?\"\n                                data-testid=\"input-status-reason\"\n                              />\n                            </div>\n                            <Button\n                              size=\"sm\"\n                              onClick={handleStatusUpdate}\n                              disabled={!newStatus || updateStatusMutation.isPending}\n                              data-testid=\"button-update-status\"\n                            >\n                              {updateStatusMutation.isPending ? (\n                                <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n                              ) : null}\n                              Update Status\n                            </Button>\n                          </CardContent>\n                        </Card>\n                      </div>\n                    </div>\n\n                    <Card>\n                      <CardHeader className=\"pb-2\">\n                        <CardTitle className=\"text-sm font-medium\">Add Response</CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-3\">\n                        <Textarea\n                          value={responseMessage}\n                          onChange={(e) => setResponseMessage(e.target.value)}\n                          placeholder=\"Write your response...\"\n                          rows={4}\n                          data-testid=\"textarea-response\"\n                        />\n                        <div className=\"flex items-center justify-between\">\n                          <div className=\"flex items-center gap-2\">\n                            <Switch\n                              id=\"internal-note\"\n                              checked={isInternalNote}\n                              onCheckedChange={setIsInternalNote}\n                              data-testid=\"switch-internal-note\"\n                            />\n                            <Label htmlFor=\"internal-note\" className=\"text-sm\">\n                              {isInternalNote ? (\n                                <span className=\"flex items-center gap-1\">\n                                  <EyeOff className=\"h-3.5 w-3.5\" />\n                                  Internal note (not visible to user)\n                                </span>\n                              ) : (\n                                <span className=\"flex items-center gap-1\">\n                                  <Eye className=\"h-3.5 w-3.5\" />\n                                  Public response\n                                </span>\n                              )}\n                            </Label>\n                          </div>\n                          <Button\n                            size=\"sm\"\n                            onClick={handleAddResponse}\n                            disabled={!responseMessage.trim() || addResponseMutation.isPending}\n                            data-testid=\"button-send-response\"\n                          >\n                            {addResponseMutation.isPending ? (\n                              <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\n                            ) : (\n                              <Send className=\"h-4 w-4 mr-2\" />\n                            )}\n                            Send\n                          </Button>\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <div className=\"flex gap-2\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => archiveMutation.mutate(feedbackDetail.feedback.id)}\n                        disabled={archiveMutation.isPending}\n                        data-testid=\"button-archive-feedback\"\n                      >\n                        <Archive className=\"h-4 w-4 mr-2\" />\n                        Archive\n                      </Button>\n                      <Button\n                        variant=\"destructive\"\n                        size=\"sm\"\n                        onClick={() => markSpamMutation.mutate(feedbackDetail.feedback.id)}\n                        disabled={markSpamMutation.isPending}\n                        data-testid=\"button-mark-spam\"\n                      >\n                        Mark as Spam\n                      </Button>\n                    </div>\n                  </TabsContent>\n\n                  <TabsContent value=\"responses\" className=\"space-y-3\">\n                    {feedbackDetail.responses.length === 0 ? (\n                      <p className=\"text-sm text-muted-foreground text-center py-8\">No responses yet.</p>\n                    ) : (\n                      feedbackDetail.responses.map((response) => (\n                        <Card key={response.id} className={response.isInternalNote ? \"border-dashed border-yellow-500/50\" : \"\"}>\n                          <CardContent className=\"pt-4\">\n                            <div className=\"flex items-start justify-between mb-2\">\n                              <div className=\"flex items-center gap-2\">\n                                <User className=\"h-4 w-4 text-muted-foreground\" />\n                                <span className=\"text-sm font-medium\">\n                                  {response.adminUsername || `Admin #${response.adminUserId.slice(0, 8)}`}\n                                </span>\n                                {response.isInternalNote && (\n                                  <Badge variant=\"outline\" className=\"text-xs\">\n                                    <EyeOff className=\"h-3 w-3 mr-1\" />\n                                    Internal\n                                  </Badge>\n                                )}\n                              </div>\n                              <span className=\"text-xs text-muted-foreground\">\n                                {format(parseISO(response.createdAt), \"MMM d, yyyy HH:mm\")}\n                              </span>\n                            </div>\n                            <p className=\"text-sm whitespace-pre-wrap\">{response.message}</p>\n                          </CardContent>\n                        </Card>\n                      ))\n                    )}\n                  </TabsContent>\n\n                  <TabsContent value=\"history\" className=\"space-y-3\">\n                    {feedbackDetail.history.length === 0 ? (\n                      <p className=\"text-sm text-muted-foreground text-center py-8\">No status history.</p>\n                    ) : (\n                      <div className=\"relative\">\n                        <div className=\"absolute left-4 top-0 bottom-0 w-0.5 bg-border\" />\n                        {feedbackDetail.history.map((entry, index) => (\n                          <div key={entry.id} className=\"relative pl-10 pb-4\">\n                            <div className=\"absolute left-2.5 w-3 h-3 rounded-full bg-primary\" />\n                            <div className=\"text-sm\">\n                              <p className=\"font-medium\">\n                                {entry.previousStatus ? (\n                                  <>\n                                    Status: {statusLabels[entry.previousStatus]} â†’ {statusLabels[entry.newStatus]}\n                                  </>\n                                ) : (\n                                  <>Status set to {statusLabels[entry.newStatus]}</>\n                                )}\n                              </p>\n                              {entry.previousPriority && entry.newPriority && entry.previousPriority !== entry.newPriority && (\n                                <p className=\"text-muted-foreground\">\n                                  Priority: {entry.previousPriority} â†’ {entry.newPriority}\n                                </p>\n                              )}\n                              {entry.changeReason && (\n                                <p className=\"text-muted-foreground italic\">\"{entry.changeReason}\"</p>\n                              )}\n                              <p className=\"text-xs text-muted-foreground mt-1\">\n                                {entry.isAutomated ? \"Automated\" : entry.changedByUsername || \"Admin\"} â€¢{\" \"}\n                                {format(parseISO(entry.createdAt), \"MMM d, yyyy HH:mm\")}\n                              </p>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </TabsContent>\n                </Tabs>\n              </ScrollArea>\n            </>\n          ) : null}\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":49018,"size_tokens":null},"client/src/pages/learn.tsx":{"content":"import { useState } from \"react\";\nimport { Link } from \"wouter\";\nimport { motion } from \"framer-motion\";\nimport {\n  BookOpen,\n  Zap,\n  Trophy,\n  Target,\n  Brain,\n  Users,\n  BarChart3,\n  Code,\n  Mic,\n  Flame,\n  Sparkles,\n  Award,\n  TrendingUp,\n  Clock,\n  Keyboard,\n  Eye,\n  Volume2,\n  Settings,\n  Share2,\n  Globe,\n  CheckCircle2,\n  ArrowRight,\n  ChevronDown,\n  ChevronUp,\n  PlayCircle,\n  Lightbulb,\n  HelpCircle,\n  MessageSquare,\n  Download,\n  Shield,\n  Rocket,\n  Star,\n  BookMarked,\n  Headphones,\n  Skull,\n  Hash,\n  Gauge,\n  Binary,\n  Fingerprint,\n  Activity,\n  PieChart,\n  LineChart,\n  Map,\n  Crown,\n  Medal,\n  Heart,\n  Percent,\n  AlertTriangle,\n} from \"lucide-react\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from \"@/components/ui/accordion\";\nimport { Separator } from \"@/components/ui/separator\";\n\nexport default function LearnPage() {\n  const [activeSection, setActiveSection] = useState(\"getting-started\");\n\n  const sections = [\n    { id: \"getting-started\", label: \"Getting Started\", icon: Rocket },\n    { id: \"typing-modes\", label: \"Typing Modes\", icon: Keyboard },\n    { id: \"multiplayer\", label: \"Multiplayer\", icon: Users },\n    { id: \"analytics\", label: \"Analytics\", icon: BarChart3 },\n    { id: \"achievements\", label: \"Achievements\", icon: Trophy },\n    { id: \"advanced\", label: \"Advanced Features\", icon: Sparkles },\n    { id: \"tips\", label: \"Tips & Tricks\", icon: Lightbulb },\n  ];\n\n  const scrollToSection = (id: string) => {\n    setActiveSection(id);\n    const element = document.getElementById(id);\n    if (element) {\n      element.scrollIntoView({ behavior: \"smooth\", block: \"start\" });\n    }\n  };\n\n  return (\n    <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n      {/* Header */}\n      <motion.div\n        initial={{ opacity: 0, y: -20 }}\n        animate={{ opacity: 1, y: 0 }}\n        className=\"text-center mb-12\"\n      >\n        <div className=\"inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-primary to-purple-600 text-white mb-6\">\n          <BookOpen className=\"w-10 h-10\" />\n        </div>\n        <h1 className=\"text-5xl font-bold mb-4 bg-gradient-to-r from-primary via-purple-500 to-pink-500 bg-clip-text text-transparent\">\n          Complete TypeMasterAI Guide\n        </h1>\n        <p className=\"text-xl text-muted-foreground max-w-3xl mx-auto\">\n          Master every feature, unlock your potential, and become a typing champion. This comprehensive guide covers everything you need to know.\n        </p>\n      </motion.div>\n\n      {/* Quick Navigation */}\n      <Card className=\"mb-8 sticky top-4 z-10 backdrop-blur-lg bg-card/95\">\n        <CardContent className=\"p-4\">\n          <div className=\"flex flex-wrap gap-2 justify-center\">\n            {sections.map((section) => {\n              const Icon = section.icon;\n              return (\n                <Button\n                  key={section.id}\n                  variant={activeSection === section.id ? \"default\" : \"outline\"}\n                  size=\"sm\"\n                  onClick={() => scrollToSection(section.id)}\n                  className=\"gap-2\"\n                  data-testid={`nav-${section.id}`}\n                >\n                  <Icon className=\"w-4 h-4\" />\n                  {section.label}\n                </Button>\n              );\n            })}\n          </div>\n        </CardContent>\n      </Card>\n\n      <div className=\"grid grid-cols-1 gap-8\">\n        {/* Getting Started Section */}\n        <motion.section\n          id=\"getting-started\"\n          initial={{ opacity: 0 }}\n          whileInView={{ opacity: 1 }}\n          viewport={{ once: true }}\n          className=\"scroll-mt-24\"\n        >\n          <Card className=\"border-primary/20\">\n            <CardHeader>\n              <div className=\"flex items-center gap-3 mb-2\">\n                <div className=\"p-3 rounded-lg bg-primary/10\">\n                  <Rocket className=\"w-6 h-6 text-primary\" />\n                </div>\n                <div>\n                  <CardTitle className=\"text-3xl\">Getting Started</CardTitle>\n                  <CardDescription>Begin your typing journey in 3 simple steps</CardDescription>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"grid md:grid-cols-3 gap-4\">\n                <Card className=\"bg-gradient-to-br from-blue-500/10 to-cyan-500/10 border-blue-500/20\">\n                  <CardHeader>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold\">\n                        1\n                      </div>\n                      <CardTitle className=\"text-lg\">Create Account</CardTitle>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground mb-3\">\n                      Sign up to save progress, unlock achievements, and compete on leaderboards.\n                    </p>\n                    <Button asChild size=\"sm\" variant=\"outline\" data-testid=\"button-register\">\n                      <Link href=\"/register\">\n                        Sign Up Free <ArrowRight className=\"w-4 h-4 ml-2\" />\n                      </Link>\n                    </Button>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-gradient-to-br from-purple-500/10 to-pink-500/10 border-purple-500/20\">\n                  <CardHeader>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-8 h-8 rounded-full bg-purple-500 text-white flex items-center justify-center font-bold\">\n                        2\n                      </div>\n                      <CardTitle className=\"text-lg\">Take a Test</CardTitle>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground mb-3\">\n                      Start with a quick 60-second typing test to establish your baseline speed.\n                    </p>\n                    <Button asChild size=\"sm\" variant=\"outline\" data-testid=\"button-start-test\">\n                      <Link href=\"/\">\n                        Start Test <PlayCircle className=\"w-4 h-4 ml-2\" />\n                      </Link>\n                    </Button>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-gradient-to-br from-green-500/10 to-emerald-500/10 border-green-500/20\">\n                  <CardHeader>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold\">\n                        3\n                      </div>\n                      <CardTitle className=\"text-lg\">Track Progress</CardTitle>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <p className=\"text-sm text-muted-foreground mb-3\">\n                      View detailed analytics and AI-powered insights to improve your skills.\n                    </p>\n                    <Button asChild size=\"sm\" variant=\"outline\" data-testid=\"button-analytics\">\n                      <Link href=\"/analytics\">\n                        View Analytics <BarChart3 className=\"w-4 h-4 ml-2\" />\n                      </Link>\n                    </Button>\n                  </CardContent>\n                </Card>\n              </div>\n\n              <div className=\"bg-muted/50 rounded-lg p-6 border border-border\">\n                <h4 className=\"font-semibold mb-3 flex items-center gap-2\">\n                  <Lightbulb className=\"w-5 h-5 text-yellow-500\" />\n                  Pro Tip: Guest Mode Available\n                </h4>\n                <p className=\"text-sm text-muted-foreground\">\n                  You can start typing immediately without creating an account! However, your progress won't be saved. We recommend creating a free account to unlock all features including analytics, achievements, and multiplayer racing.\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n        </motion.section>\n\n        {/* Typing Modes Section */}\n        <motion.section\n          id=\"typing-modes\"\n          initial={{ opacity: 0 }}\n          whileInView={{ opacity: 1 }}\n          viewport={{ once: true }}\n          className=\"scroll-mt-24\"\n        >\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-3 mb-2\">\n                <div className=\"p-3 rounded-lg bg-purple-500/10\">\n                  <Keyboard className=\"w-6 h-6 text-purple-500\" />\n                </div>\n                <div>\n                  <CardTitle className=\"text-3xl\">Typing Test Modes</CardTitle>\n                  <CardDescription>Choose from 6+ specialized typing modes to match your goals</CardDescription>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <Tabs defaultValue=\"standard\" className=\"w-full\">\n                <TabsList className=\"grid w-full grid-cols-3 lg:grid-cols-6 mb-6\">\n                  <TabsTrigger value=\"standard\" data-testid=\"tab-standard\">Standard</TabsTrigger>\n                  <TabsTrigger value=\"code\" data-testid=\"tab-code\">Code</TabsTrigger>\n                  <TabsTrigger value=\"book\" data-testid=\"tab-book\">Book</TabsTrigger>\n                  <TabsTrigger value=\"dictation\" data-testid=\"tab-dictation\">Dictation</TabsTrigger>\n                  <TabsTrigger value=\"stress\" data-testid=\"tab-stress\">Stress</TabsTrigger>\n                  <TabsTrigger value=\"multiplayer\" data-testid=\"tab-multiplayer\">Multiplayer</TabsTrigger>\n                </TabsList>\n\n                <TabsContent value=\"standard\" className=\"space-y-4\">\n                  <div className=\"flex items-start gap-4\">\n                    <div className=\"p-3 rounded-lg bg-blue-500/10\">\n                      <Zap className=\"w-6 h-6 text-blue-500\" />\n                    </div>\n                    <div className=\"flex-1\">\n                      <h3 className=\"text-xl font-semibold mb-2\">Standard Typing Test</h3>\n                      <p className=\"text-muted-foreground mb-4\">\n                        The classic typing experience with AI-generated paragraphs tailored to your skill level.\n                      </p>\n                      \n                      <div className=\"grid md:grid-cols-2 gap-4 mb-4\">\n                        <div className=\"space-y-2\">\n                          <h4 className=\"font-semibold flex items-center gap-2\">\n                            <CheckCircle2 className=\"w-4 h-4 text-green-500\" />\n                            Features\n                          </h4>\n                          <ul className=\"text-sm space-y-1 text-muted-foreground ml-6\">\n                            <li>â€¢ Multiple time limits (15s, 30s, 60s, 120s, 180s)</li>\n                            <li>â€¢ 23+ language support</li>\n                            <li>â€¢ Adjustable difficulty levels</li>\n                            <li>â€¢ Real-time WPM and accuracy tracking</li>\n                            <li>â€¢ Customizable themes and sounds</li>\n                          </ul>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <h4 className=\"font-semibold flex items-center gap-2\">\n                            <Target className=\"w-4 h-4 text-orange-500\" />\n                            Best For\n                          </h4>\n                          <ul className=\"text-sm space-y-1 text-muted-foreground ml-6\">\n                            <li>â€¢ Beginners starting their journey</li>\n                            <li>â€¢ General typing skill improvement</li>\n                            <li>â€¢ Daily practice sessions</li>\n                            <li>â€¢ Speed benchmarking</li>\n                          </ul>\n                        </div>\n                      </div>\n\n                      <div className=\"flex gap-2\">\n                        <Button asChild size=\"sm\" data-testid=\"button-try-standard\">\n                          <Link href=\"/\">Try Standard Test</Link>\n                        </Button>\n                        <Button asChild size=\"sm\" variant=\"outline\" data-testid=\"button-1min\">\n                          <Link href=\"/1-minute-typing-test\">1 Min Test</Link>\n                        </Button>\n                        <Button asChild size=\"sm\" variant=\"outline\" data-testid=\"button-3min\">\n                          <Link href=\"/3-minute-typing-test\">3 Min Test</Link>\n                        </Button>\n                      </div>\n                    </div>\n                  </div>\n                </TabsContent>\n\n                <TabsContent value=\"code\" className=\"space-y-4\">\n                  <div className=\"flex items-start gap-4\">\n                    <div className=\"p-3 rounded-lg bg-green-500/10\">\n                      <Code className=\"w-6 h-6 text-green-500\" />\n                    </div>\n                    <div className=\"flex-1\">\n                      <h3 className=\"text-xl font-semibold mb-2\">Code Typing Mode</h3>\n                      <p className=\"text-muted-foreground mb-4\">\n                        Master typing code with syntax highlighting and real programming snippets in 50+ languages.\n                      </p>\n                      \n                      <div className=\"grid md:grid-cols-2 gap-4 mb-4\">\n                        <div className=\"space-y-2\">\n                          <h4 className=\"font-semibold flex items-center gap-2\">\n                            <Binary className=\"w-4 h-4 text-green-500\" />\n                            Languages Supported\n                          </h4>\n                          <div className=\"flex flex-wrap gap-1\">\n                            {[\"JavaScript\", \"TypeScript\", \"Python\", \"Java\", \"C++\", \"Go\", \"Rust\", \"Swift\", \"Ruby\", \"PHP\", \"HTML\", \"CSS\"].map((lang) => (\n                              <Badge key={lang} variant=\"secondary\" className=\"text-xs\">\n                                {lang}\n                              </Badge>\n                            ))}\n                            <Badge variant=\"outline\" className=\"text-xs\">+40 more</Badge>\n                          </div>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <h4 className=\"font-semibold flex items-center gap-2\">\n                            <Sparkles className=\"w-4 h-4 text-purple-500\" />\n                            Unique Features\n                          </h4>\n                          <ul className=\"text-sm space-y-1 text-muted-foreground ml-6\">\n                            <li>â€¢ AI-generated code snippets</li>\n                            <li>â€¢ Syntax highlighting</li>\n                            <li>â€¢ Line numbers & indentation guides</li>\n                            <li>â€¢ Difficulty: Easy, Medium, Hard</li>\n                            <li>â€¢ Language-specific leaderboards</li>\n                          </ul>\n                        </div>\n                      </div>\n\n                      <Button asChild size=\"sm\" data-testid=\"button-try-code\">\n                        <Link href=\"/code-mode\">\n                          <Code className=\"w-4 h-4 mr-2\" />\n                          Try Code Mode\n                        </Link>\n                      </Button>\n                    </div>\n                  </div>\n                </TabsContent>\n\n                <TabsContent value=\"book\" className=\"space-y-4\">\n                  <div className=\"flex items-start gap-4\">\n                    <div className=\"p-3 rounded-lg bg-amber-500/10\">\n                      <BookMarked className=\"w-6 h-6 text-amber-500\" />\n                    </div>\n                    <div className=\"flex-1\">\n                      <h3 className=\"text-xl font-semibold mb-2\">Book Mode</h3>\n                      <p className=\"text-muted-foreground mb-4\">\n                        Type passages from classic literature and famous books while improving your skills.\n                      </p>\n                      \n                      <div className=\"grid md:grid-cols-2 gap-4 mb-4\">\n                        <div className=\"space-y-2\">\n                          <h4 className=\"font-semibold flex items-center gap-2\">\n                            <CheckCircle2 className=\"w-4 h-4 text-green-500\" />\n                            Features\n                          </h4>\n                          <ul className=\"text-sm space-y-1 text-muted-foreground ml-6\">\n                            <li>â€¢ Classic literature library</li>\n                            <li>â€¢ Chapter-by-chapter progression</li>\n                            <li>â€¢ Multiple topics & genres</li>\n                            <li>â€¢ Difficulty filtering</li>\n                            <li>â€¢ Save reading progress</li>\n                          </ul>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <h4 className=\"font-semibold flex items-center gap-2\">\n                            <Heart className=\"w-4 h-4 text-red-500\" />\n                            Popular Books\n                          </h4>\n                          <ul className=\"text-sm space-y-1 text-muted-foreground ml-6\">\n                            <li>â€¢ Pride and Prejudice</li>\n                            <li>â€¢ Moby Dick</li>\n                            <li>â€¢ Alice in Wonderland</li>\n                            <li>â€¢ Sherlock Holmes</li>\n                            <li>â€¢ And many more...</li>\n                          </ul>\n                        </div>\n                      </div>\n\n                      <Button asChild size=\"sm\" data-testid=\"button-try-book\">\n                        <Link href=\"/book-mode\">\n                          <BookMarked className=\"w-4 h-4 mr-2\" />\n                          Browse Books\n                        </Link>\n                      </Button>\n                    </div>\n                  </div>\n                </TabsContent>\n\n                <TabsContent value=\"dictation\" className=\"space-y-4\">\n                  <div className=\"flex items-start gap-4\">\n                    <div className=\"p-3 rounded-lg bg-cyan-500/10\">\n                      <Headphones className=\"w-6 h-6 text-cyan-500\" />\n                    </div>\n                    <div className=\"flex-1\">\n                      <h3 className=\"text-xl font-semibold mb-2\">Dictation Mode</h3>\n                      <p className=\"text-muted-foreground mb-4\">\n                        Improve listening skills and typing accuracy by typing what you hear.\n                      </p>\n                      \n                      <div className=\"grid md:grid-cols-2 gap-4 mb-4\">\n                        <div className=\"space-y-2\">\n                          <h4 className=\"font-semibold flex items-center gap-2\">\n                            <Volume2 className=\"w-4 h-4 text-cyan-500\" />\n                            Practice Modes\n                          </h4>\n                          <ul className=\"text-sm space-y-1 text-muted-foreground ml-6\">\n                            <li>â€¢ Quick Practice (fast-paced)</li>\n                            <li>â€¢ Focus Mode (zen experience)</li>\n                            <li>â€¢ Challenge Mode (no hints)</li>\n                            <li>â€¢ Adjustable speech speed</li>\n                            <li>â€¢ Various difficulty levels</li>\n                          </ul>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <h4 className=\"font-semibold flex items-center gap-2\">\n                            <Sparkles className=\"w-4 h-4 text-purple-500\" />\n                            Special Features\n                          </h4>\n                          <ul className=\"text-sm space-y-1 text-muted-foreground ml-6\">\n                            <li>â€¢ Zen themes (Ocean, Forest, Sunset)</li>\n                            <li>â€¢ Bookmark difficult sentences</li>\n                            <li>â€¢ Session history tracking</li>\n                            <li>â€¢ Streak counter</li>\n                            <li>â€¢ Achievement unlocks</li>\n                          </ul>\n                        </div>\n                      </div>\n\n                      <Button asChild size=\"sm\" data-testid=\"button-try-dictation\">\n                        <Link href=\"/dictation-mode\">\n                          <Mic className=\"w-4 h-4 mr-2\" />\n                          Try Dictation\n                        </Link>\n                      </Button>\n\n                      {/* Dictation Session History - Detailed */}\n                      <div className=\"mt-6 bg-gradient-to-r from-cyan-500/5 to-blue-500/5 rounded-lg p-6 border border-cyan-500/20\">\n                        <h4 className=\"font-semibold mb-3 flex items-center gap-2 text-lg\">\n                          <Clock className=\"w-5 h-5 text-cyan-500\" />\n                          Session History & Progress Tracking\n                        </h4>\n                        <p className=\"text-sm text-muted-foreground mb-4\">\n                          Every dictation session is automatically saved with full details including accuracy, speed, sentences practiced, and difficulty level. Access your complete history anytime to track improvement over time.\n                        </p>\n                        <div className=\"grid md:grid-cols-2 gap-4\">\n                          <div>\n                            <h5 className=\"font-semibold text-sm mb-2\">What's Tracked:</h5>\n                            <ul className=\"text-sm space-y-1 text-muted-foreground\">\n                              <li>â€¢ Date and time of each session</li>\n                              <li>â€¢ Mode (Quick, Focus, Challenge)</li>\n                              <li>â€¢ Number of sentences completed</li>\n                              <li>â€¢ Average WPM and accuracy</li>\n                              <li>â€¢ Difficulty level attempted</li>\n                              <li>â€¢ Theme used during practice</li>\n                              <li>â€¢ Bookmarked difficult sentences</li>\n                            </ul>\n                          </div>\n                          <div>\n                            <h5 className=\"font-semibold text-sm mb-2\">How to Access:</h5>\n                            <ol className=\"text-sm space-y-2 text-muted-foreground\">\n                              <li className=\"flex gap-2\">\n                                <span className=\"font-semibold text-cyan-500\">1.</span>\n                                <span>Complete a dictation session</span>\n                              </li>\n                              <li className=\"flex gap-2\">\n                                <span className=\"font-semibold text-cyan-500\">2.</span>\n                                <span>Click \"View History\" in dictation mode</span>\n                              </li>\n                              <li className=\"flex gap-2\">\n                                <span className=\"font-semibold text-cyan-500\">3.</span>\n                                <span>Or navigate to Analytics â†’ Session History</span>\n                              </li>\n                              <li className=\"flex gap-2\">\n                                <span className=\"font-semibold text-cyan-500\">4.</span>\n                                <span>Filter by date range or mode</span>\n                              </li>\n                              <li className=\"flex gap-2\">\n                                <span className=\"font-semibold text-cyan-500\">5.</span>\n                                <span>Drill down into any session for details</span>\n                              </li>\n                            </ol>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </TabsContent>\n\n                <TabsContent value=\"stress\" className=\"space-y-4\">\n                  <div className=\"flex items-start gap-4\">\n                    <div className=\"p-3 rounded-lg bg-red-500/10\">\n                      <Skull className=\"w-6 h-6 text-red-500\" />\n                    </div>\n                    <div className=\"flex-1\">\n                      <h3 className=\"text-xl font-semibold mb-2\">Stress Test</h3>\n                      <p className=\"text-muted-foreground mb-4\">\n                        Challenge yourself with extreme visual and auditory effects designed to test your focus.\n                      </p>\n                      \n                      <div className=\"grid md:grid-cols-2 gap-4 mb-4\">\n                        <div className=\"space-y-2\">\n                          <h4 className=\"font-semibold flex items-center gap-2\">\n                            <Gauge className=\"w-4 h-4 text-red-500\" />\n                            Difficulty Levels\n                          </h4>\n                          <ul className=\"text-sm space-y-1 text-muted-foreground ml-6\">\n                            <li>â€¢ Beginner (screen shake, distractions)</li>\n                            <li>â€¢ Intermediate (+ blur, color shift)</li>\n                            <li>â€¢ Expert (+ gravity, rotation)</li>\n                            <li>â€¢ Nightmare (+ glitch, text fade)</li>\n                            <li>â€¢ Impossible (+ reverse, screen flip)</li>\n                          </ul>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <h4 className=\"font-semibold flex items-center gap-2\">\n                            <Shield className=\"w-4 h-4 text-blue-500\" />\n                            Effects\n                          </h4>\n                          <ul className=\"text-sm space-y-1 text-muted-foreground ml-6\">\n                            <li>â€¢ Screen shake & vibration</li>\n                            <li>â€¢ Emoji particle explosions</li>\n                            <li>â€¢ Chaotic sound effects</li>\n                            <li>â€¢ Text blur & fading</li>\n                            <li>â€¢ Screen rotation & flipping</li>\n                            <li>â€¢ Anti-cheat system</li>\n                          </ul>\n                        </div>\n                      </div>\n\n                      <div className=\"bg-red-500/10 border border-red-500/20 rounded-lg p-4 mb-4\">\n                        <p className=\"text-sm text-muted-foreground flex items-start gap-2\">\n                          <AlertTriangle className=\"w-4 h-4 text-red-500 flex-shrink-0 mt-0.5\" />\n                          <span>\n                            <strong>Warning:</strong> Stress Test contains intense visual effects. Not recommended for users sensitive to flashing lights or motion.\n                          </span>\n                        </p>\n                      </div>\n\n                      <Button asChild size=\"sm\" variant=\"destructive\" data-testid=\"button-try-stress\">\n                        <Link href=\"/stress-test\">\n                          <Flame className=\"w-4 h-4 mr-2\" />\n                          Enter Stress Test\n                        </Link>\n                      </Button>\n                    </div>\n                  </div>\n                </TabsContent>\n\n                <TabsContent value=\"multiplayer\" className=\"space-y-4\">\n                  <div className=\"flex items-start gap-4\">\n                    <div className=\"p-3 rounded-lg bg-purple-500/10\">\n                      <Users className=\"w-6 h-6 text-purple-500\" />\n                    </div>\n                    <div className=\"flex-1\">\n                      <h3 className=\"text-xl font-semibold mb-2\">Multiplayer Racing</h3>\n                      <p className=\"text-muted-foreground mb-4\">\n                        Compete in real-time against players worldwide or challenge friends in private rooms.\n                      </p>\n                      \n                      <div className=\"grid md:grid-cols-2 gap-4 mb-4\">\n                        <div className=\"space-y-2\">\n                          <h4 className=\"font-semibold flex items-center gap-2\">\n                            <Zap className=\"w-4 h-4 text-yellow-500\" />\n                            Race Modes\n                          </h4>\n                          <ul className=\"text-sm space-y-1 text-muted-foreground ml-6\">\n                            <li>â€¢ Quick Match (instant matchmaking)</li>\n                            <li>â€¢ Private Rooms (password-protected)</li>\n                            <li>â€¢ Custom Rooms (create your own)</li>\n                            <li>â€¢ Timed Races (30s, 60s, 120s, 180s)</li>\n                            <li>â€¢ Standard Races (finish paragraph)</li>\n                          </ul>\n                        </div>\n                        <div className=\"space-y-2\">\n                          <h4 className=\"font-semibold flex items-center gap-2\">\n                            <Trophy className=\"w-4 h-4 text-amber-500\" />\n                            Features\n                          </h4>\n                          <ul className=\"text-sm space-y-1 text-muted-foreground ml-6\">\n                            <li>â€¢ Real-time progress tracking</li>\n                            <li>â€¢ Live chat in race rooms</li>\n                            <li>â€¢ ELO rating system</li>\n                            <li>â€¢ AI Ghost Racers</li>\n                            <li>â€¢ Rematch functionality</li>\n                            <li>â€¢ Global leaderboards</li>\n                          </ul>\n                        </div>\n                      </div>\n\n                      <Button asChild size=\"sm\" data-testid=\"button-try-multiplayer\">\n                        <Link href=\"/multiplayer\">\n                          <Users className=\"w-4 h-4 mr-2\" />\n                          Join Multiplayer\n                        </Link>\n                      </Button>\n                    </div>\n                  </div>\n                </TabsContent>\n              </Tabs>\n            </CardContent>\n          </Card>\n        </motion.section>\n\n        {/* Analytics Section */}\n        <motion.section\n          id=\"analytics\"\n          initial={{ opacity: 0 }}\n          whileInView={{ opacity: 1 }}\n          viewport={{ once: true }}\n          className=\"scroll-mt-24\"\n        >\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-3 mb-2\">\n                <div className=\"p-3 rounded-lg bg-cyan-500/10\">\n                  <BarChart3 className=\"w-6 h-6 text-cyan-500\" />\n                </div>\n                <div>\n                  <CardTitle className=\"text-3xl\">Analytics & Progress Tracking</CardTitle>\n                  <CardDescription>Comprehensive insights powered by AI to accelerate your improvement</CardDescription>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                <Card className=\"bg-gradient-to-br from-blue-500/10 to-cyan-500/10 border-blue-500/20\">\n                  <CardHeader>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      <TrendingUp className=\"w-5 h-5 text-blue-500\" />\n                      Performance Metrics\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <ul className=\"text-sm space-y-2 text-muted-foreground\">\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>WPM progress over time</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Accuracy trend analysis</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Consistency metrics</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Historical trends (weekly/monthly)</span>\n                      </li>\n                    </ul>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-gradient-to-br from-purple-500/10 to-pink-500/10 border-purple-500/20\">\n                  <CardHeader>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      <Fingerprint className=\"w-5 h-5 text-purple-500\" />\n                      Keystroke Analysis\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <ul className=\"text-sm space-y-2 text-muted-foreground\">\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Keyboard heatmap</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Finger usage distribution</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Hand balance metrics</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Typing rhythm analysis</span>\n                      </li>\n                    </ul>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-gradient-to-br from-orange-500/10 to-red-500/10 border-orange-500/20\">\n                  <CardHeader>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      <Target className=\"w-5 h-5 text-orange-500\" />\n                      Mistake Analysis\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <ul className=\"text-sm space-y-2 text-muted-foreground\">\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Error-prone keys identification</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Common substitution patterns</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Slowest words tracking</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Targeted practice suggestions</span>\n                      </li>\n                    </ul>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-gradient-to-br from-green-500/10 to-emerald-500/10 border-green-500/20\">\n                  <CardHeader>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      <Brain className=\"w-5 h-5 text-green-500\" />\n                      AI-Powered Insights\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <ul className=\"text-sm space-y-2 text-muted-foreground\">\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Personalized recommendations</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Skill level assessment</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Practice plan generation</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Weekly improvement goals</span>\n                      </li>\n                    </ul>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-gradient-to-br from-yellow-500/10 to-orange-500/10 border-yellow-500/20\">\n                  <CardHeader>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      <PieChart className=\"w-5 h-5 text-yellow-500\" />\n                      Benchmark Comparison\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <ul className=\"text-sm space-y-2 text-muted-foreground\">\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Industry standard benchmarks</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Skill tier placement</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Percentile rankings</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Goal setting assistance</span>\n                      </li>\n                    </ul>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-gradient-to-br from-pink-500/10 to-purple-500/10 border-pink-500/20\">\n                  <CardHeader>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      <Activity className=\"w-5 h-5 text-pink-500\" />\n                      Session History\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    <ul className=\"text-sm space-y-2 text-muted-foreground\">\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Complete test history</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Performance timeline</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Personal best tracking</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 flex-shrink-0 mt-0.5\" />\n                        <span>Milestone achievements</span>\n                      </li>\n                    </ul>\n                  </CardContent>\n                </Card>\n              </div>\n\n              <div className=\"bg-gradient-to-r from-cyan-500/10 via-blue-500/10 to-purple-500/10 rounded-lg p-6 border border-cyan-500/20\">\n                <h4 className=\"font-semibold mb-3 flex items-center gap-2\">\n                  <Sparkles className=\"w-5 h-5 text-cyan-500\" />\n                  How to Use Analytics Effectively\n                </h4>\n                <ol className=\"space-y-2 text-sm text-muted-foreground\">\n                  <li className=\"flex gap-3\">\n                    <span className=\"font-semibold text-primary\">1.</span>\n                    <span>Complete at least 10 tests to get accurate baseline metrics</span>\n                  </li>\n                  <li className=\"flex gap-3\">\n                    <span className=\"font-semibold text-primary\">2.</span>\n                    <span>Review your Analytics page weekly to track improvements</span>\n                  </li>\n                  <li className=\"flex gap-3\">\n                    <span className=\"font-semibold text-primary\">3.</span>\n                    <span>Use AI Insights to identify weak areas and get practice recommendations</span>\n                  </li>\n                  <li className=\"flex gap-3\">\n                    <span className=\"font-semibold text-primary\">4.</span>\n                    <span>Focus on consistency over speed - accuracy builds muscle memory</span>\n                  </li>\n                  <li className=\"flex gap-3\">\n                    <span className=\"font-semibold text-primary\">5.</span>\n                    <span>Practice problem keys identified in your Mistake Analysis</span>\n                  </li>\n                </ol>\n              </div>\n\n              <Button asChild data-testid=\"button-view-analytics\">\n                <Link href=\"/analytics\">\n                  <BarChart3 className=\"w-4 h-4 mr-2\" />\n                  View Your Analytics\n                </Link>\n              </Button>\n            </CardContent>\n          </Card>\n        </motion.section>\n\n        {/* Achievements Section */}\n        <motion.section\n          id=\"achievements\"\n          initial={{ opacity: 0 }}\n          whileInView={{ opacity: 1 }}\n          viewport={{ once: true }}\n          className=\"scroll-mt-24\"\n        >\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-3 mb-2\">\n                <div className=\"p-3 rounded-lg bg-amber-500/10\">\n                  <Trophy className=\"w-6 h-6 text-amber-500\" />\n                </div>\n                <div>\n                  <CardTitle className=\"text-3xl\">Achievements & Gamification</CardTitle>\n                  <CardDescription>Unlock badges, climb leaderboards, and celebrate milestones</CardDescription>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"grid md:grid-cols-2 gap-6\">\n                <div>\n                  <h3 className=\"text-xl font-semibold mb-4 flex items-center gap-2\">\n                    <Award className=\"w-5 h-5 text-amber-500\" />\n                    Badge Categories\n                  </h3>\n                  <div className=\"space-y-3\">\n                    <Card className=\"bg-amber-500/10 border-amber-500/20\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          <Zap className=\"w-5 h-5 text-amber-500\" />\n                          <h4 className=\"font-semibold\">Speed Achievements</h4>\n                        </div>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Unlock badges at 30, 50, 80, 100, and 120+ WPM milestones\n                        </p>\n                      </CardContent>\n                    </Card>\n\n                    <Card className=\"bg-blue-500/10 border-blue-500/20\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          <Target className=\"w-5 h-5 text-blue-500\" />\n                          <h4 className=\"font-semibold\">Accuracy Achievements</h4>\n                        </div>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Earn badges for 95%, 98%, and 100% accuracy tests\n                        </p>\n                      </CardContent>\n                    </Card>\n\n                    <Card className=\"bg-orange-500/10 border-orange-500/20\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          <Flame className=\"w-5 h-5 text-orange-500\" />\n                          <h4 className=\"font-semibold\">Streak Achievements</h4>\n                        </div>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Maintain daily practice streaks: 7, 14, 30, 60, 100+ days\n                        </p>\n                      </CardContent>\n                    </Card>\n\n                    <Card className=\"bg-purple-500/10 border-purple-500/20\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          <Star className=\"w-5 h-5 text-purple-500\" />\n                          <h4 className=\"font-semibold\">Special & Secret Badges</h4>\n                        </div>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Discover hidden achievements and limited-time challenges\n                        </p>\n                      </CardContent>\n                    </Card>\n                  </div>\n                </div>\n\n                <div>\n                  <h3 className=\"text-xl font-semibold mb-4 flex items-center gap-2\">\n                    <Crown className=\"w-5 h-5 text-amber-500\" />\n                    Leaderboards & Rankings\n                  </h3>\n                  <div className=\"space-y-3\">\n                    <Card className=\"bg-gradient-to-br from-yellow-500/10 to-amber-500/10 border-yellow-500/20\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          <Globe className=\"w-5 h-5 text-yellow-500\" />\n                          <h4 className=\"font-semibold\">Global Leaderboard</h4>\n                        </div>\n                        <p className=\"text-sm text-muted-foreground mb-2\">\n                          Compete with typists worldwide across all standard tests\n                        </p>\n                        <Button asChild size=\"sm\" variant=\"outline\" data-testid=\"button-global-leaderboard\">\n                          <Link href=\"/leaderboard\">View Rankings</Link>\n                        </Button>\n                      </CardContent>\n                    </Card>\n\n                    <Card className=\"bg-gradient-to-br from-green-500/10 to-emerald-500/10 border-green-500/20\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          <Code className=\"w-5 h-5 text-green-500\" />\n                          <h4 className=\"font-semibold\">Code Leaderboard</h4>\n                        </div>\n                        <p className=\"text-sm text-muted-foreground mb-2\">\n                          Language-specific rankings for code typing tests\n                        </p>\n                        <Button asChild size=\"sm\" variant=\"outline\" data-testid=\"button-code-leaderboard\">\n                          <Link href=\"/code-leaderboard\">View Code Rankings</Link>\n                        </Button>\n                      </CardContent>\n                    </Card>\n\n                    <Card className=\"bg-gradient-to-br from-red-500/10 to-orange-500/10 border-red-500/20\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3 mb-2\">\n                          <Flame className=\"w-5 h-5 text-red-500\" />\n                          <h4 className=\"font-semibold\">Stress Test Leaderboard</h4>\n                        </div>\n                        <p className=\"text-sm text-muted-foreground mb-2\">\n                          Rankings for each difficulty level of stress tests\n                        </p>\n                        <Button asChild size=\"sm\" variant=\"outline\" data-testid=\"button-stress-leaderboard\">\n                          <Link href=\"/stress-leaderboard\">View Stress Rankings</Link>\n                        </Button>\n                      </CardContent>\n                    </Card>\n\n                    <div className=\"bg-muted/50 rounded-lg p-4 border border-border\">\n                      <h4 className=\"font-semibold mb-2 flex items-center gap-2\">\n                        <Hash className=\"w-4 h-4\" />\n                        ELO Rating System\n                      </h4>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Your competitive rating changes based on multiplayer race performance. Win against higher-rated players to gain more points!\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"bg-gradient-to-r from-purple-500/10 via-pink-500/10 to-red-500/10 rounded-lg p-6 border border-purple-500/20\">\n                <h4 className=\"font-semibold mb-3 flex items-center gap-2\">\n                  <Medal className=\"w-5 h-5 text-purple-500\" />\n                  Badge Tier System\n                </h4>\n                <div className=\"grid grid-cols-2 md:grid-cols-5 gap-3\">\n                  <div className=\"text-center\">\n                    <div className=\"w-12 h-12 rounded-full bg-amber-700/20 mx-auto mb-2 flex items-center justify-center\">\n                      <Medal className=\"w-6 h-6 text-amber-700\" />\n                    </div>\n                    <p className=\"font-semibold text-sm\">Bronze</p>\n                    <p className=\"text-xs text-muted-foreground\">10-25 XP</p>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"w-12 h-12 rounded-full bg-slate-400/20 mx-auto mb-2 flex items-center justify-center\">\n                      <Medal className=\"w-6 h-6 text-slate-400\" />\n                    </div>\n                    <p className=\"font-semibold text-sm\">Silver</p>\n                    <p className=\"text-xs text-muted-foreground\">25-50 XP</p>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"w-12 h-12 rounded-full bg-yellow-500/20 mx-auto mb-2 flex items-center justify-center\">\n                      <Medal className=\"w-6 h-6 text-yellow-500\" />\n                    </div>\n                    <p className=\"font-semibold text-sm\">Gold</p>\n                    <p className=\"text-xs text-muted-foreground\">50-100 XP</p>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"w-12 h-12 rounded-full bg-cyan-400/20 mx-auto mb-2 flex items-center justify-center\">\n                      <Medal className=\"w-6 h-6 text-cyan-400\" />\n                    </div>\n                    <p className=\"font-semibold text-sm\">Platinum</p>\n                    <p className=\"text-xs text-muted-foreground\">100-200 XP</p>\n                  </div>\n                  <div className=\"text-center\">\n                    <div className=\"w-12 h-12 rounded-full bg-blue-400/20 mx-auto mb-2 flex items-center justify-center\">\n                      <Medal className=\"w-6 h-6 text-blue-400\" />\n                    </div>\n                    <p className=\"font-semibold text-sm\">Diamond</p>\n                    <p className=\"text-xs text-muted-foreground\">200+ XP</p>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </motion.section>\n\n        {/* Advanced Features Section */}\n        <motion.section\n          id=\"advanced\"\n          initial={{ opacity: 0 }}\n          whileInView={{ opacity: 1 }}\n          viewport={{ once: true }}\n          className=\"scroll-mt-24\"\n        >\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-3 mb-2\">\n                <div className=\"p-3 rounded-lg bg-purple-500/10\">\n                  <Sparkles className=\"w-6 h-6 text-purple-500\" />\n                </div>\n                <div>\n                  <CardTitle className=\"text-3xl\">Advanced Features</CardTitle>\n                  <CardDescription>Power user tools and customization options</CardDescription>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              {/* AI Chat Assistant - Comprehensive Guide */}\n              <div className=\"bg-gradient-to-br from-blue-500/10 to-cyan-500/10 rounded-lg p-6 border border-blue-500/20 mb-6\">\n                <h3 className=\"text-2xl font-semibold mb-4 flex items-center gap-2\">\n                  <MessageSquare className=\"w-6 h-6 text-blue-500\" />\n                  AI Chat Assistant - Your 24/7 Personal Typing Coach\n                </h3>\n                <p className=\"text-muted-foreground mb-6\">\n                  Meet your intelligent typing coach! Our AI assistant analyzes your performance data, identifies improvement opportunities, and provides personalized coaching through natural conversation. It's like having a professional typing instructor available anytime.\n                </p>\n\n                {/* How to Access */}\n                <div className=\"mb-6\">\n                  <h4 className=\"font-semibold mb-3 text-lg flex items-center gap-2\">\n                    <Rocket className=\"w-5 h-5 text-cyan-500\" />\n                    How to Access the AI Assistant\n                  </h4>\n                  <div className=\"bg-background/50 rounded-lg p-4 border border-border\">\n                    <div className=\"grid md:grid-cols-3 gap-4\">\n                      <div>\n                        <p className=\"font-semibold text-sm mb-2 flex items-center gap-2\">\n                          <span className=\"bg-cyan-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs\">1</span>\n                          From Navigation\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">Click \"Chat\" in the main navigation menu at the top of any page</p>\n                      </div>\n                      <div>\n                        <p className=\"font-semibold text-sm mb-2 flex items-center gap-2\">\n                          <span className=\"bg-cyan-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs\">2</span>\n                          From Analytics\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">Click \"Ask AI\" button in your Analytics page for context-aware coaching</p>\n                      </div>\n                      <div>\n                        <p className=\"font-semibold text-sm mb-2 flex items-center gap-2\">\n                          <span className=\"bg-cyan-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs\">3</span>\n                          From Results\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">After any test, click \"Get AI Insights\" for immediate analysis</p>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                {/* What It Does */}\n                <div className=\"grid md:grid-cols-2 gap-6 mb-6\">\n                  <div>\n                    <h4 className=\"font-semibold mb-3 text-sm flex items-center gap-2\">\n                      <Brain className=\"w-4 h-4 text-purple-500\" />\n                      AI Capabilities & Features:\n                    </h4>\n                    <ul className=\"text-sm space-y-2 text-muted-foreground\">\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 mt-0.5\" />\n                        <span><strong>Performance Analysis:</strong> Reviews your test history and identifies patterns in errors, slow keys, and accuracy issues</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 mt-0.5\" />\n                        <span><strong>Personalized Coaching:</strong> Provides specific exercises targeting your weak areas</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 mt-0.5\" />\n                        <span><strong>Technique Tips:</strong> Suggests hand positioning, posture, and finger placement improvements</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 mt-0.5\" />\n                        <span><strong>Progress Tracking:</strong> Explains your analytics data in plain language</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 mt-0.5\" />\n                        <span><strong>Motivation & Support:</strong> Celebrates achievements and keeps you encouraged</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 mt-0.5\" />\n                        <span><strong>Q&A:</strong> Answers any typing-related questions instantly</span>\n                      </li>\n                    </ul>\n                  </div>\n                  <div>\n                    <h4 className=\"font-semibold mb-3 text-sm flex items-center gap-2\">\n                      <Lightbulb className=\"w-4 h-4 text-yellow-500\" />\n                      Sample Prompts to Try:\n                    </h4>\n                    <div className=\"space-y-2\">\n                      <div className=\"bg-blue-500/10 rounded p-2 border border-blue-500/20\">\n                        <p className=\"text-xs text-muted-foreground italic\">\"Why do I keep missing the 'p' key?\"</p>\n                      </div>\n                      <div className=\"bg-blue-500/10 rounded p-2 border border-blue-500/20\">\n                        <p className=\"text-xs text-muted-foreground italic\">\"Give me exercises to improve my left pinky finger\"</p>\n                      </div>\n                      <div className=\"bg-blue-500/10 rounded p-2 border border-blue-500/20\">\n                        <p className=\"text-xs text-muted-foreground italic\">\"How can I increase my WPM from 65 to 80?\"</p>\n                      </div>\n                      <div className=\"bg-blue-500/10 rounded p-2 border border-blue-500/20\">\n                        <p className=\"text-xs text-muted-foreground italic\">\"Explain my accuracy trend this week\"</p>\n                      </div>\n                      <div className=\"bg-blue-500/10 rounded p-2 border border-blue-500/20\">\n                        <p className=\"text-xs text-muted-foreground italic\">\"Create a 7-day practice plan for me\"</p>\n                      </div>\n                      <div className=\"bg-blue-500/10 rounded p-2 border border-blue-500/20\">\n                        <p className=\"text-xs text-muted-foreground italic\">\"What typing mode should I practice today?\"</p>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Conversation Workflow */}\n                <div className=\"mb-6\">\n                  <h4 className=\"font-semibold mb-3 text-lg flex items-center gap-2\">\n                    <MessageSquare className=\"w-5 h-5 text-blue-500\" />\n                    Typical Conversation Workflow\n                  </h4>\n                  <div className=\"bg-background/50 rounded-lg p-4 border border-border\">\n                    <div className=\"space-y-3 text-sm\">\n                      <div className=\"flex gap-3\">\n                        <div className=\"bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0\">1</div>\n                        <div>\n                          <p className=\"font-semibold mb-1\">Start Conversation</p>\n                          <p className=\"text-muted-foreground text-xs\">Open chat and type your question or concern (e.g., \"I want to improve my accuracy\")</p>\n                        </div>\n                      </div>\n                      <div className=\"flex gap-3\">\n                        <div className=\"bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0\">2</div>\n                        <div>\n                          <p className=\"font-semibold mb-1\">AI Analyzes Your Data</p>\n                          <p className=\"text-muted-foreground text-xs\">The assistant reviews your recent tests, identifies patterns, and prepares personalized advice</p>\n                        </div>\n                      </div>\n                      <div className=\"flex gap-3\">\n                        <div className=\"bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0\">3</div>\n                        <div>\n                          <p className=\"font-semibold mb-1\">Get Recommendations</p>\n                          <p className=\"text-muted-foreground text-xs\">Receive specific suggestions, practice exercises, or explanations tailored to your needs</p>\n                        </div>\n                      </div>\n                      <div className=\"flex gap-3\">\n                        <div className=\"bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0\">4</div>\n                        <div>\n                          <p className=\"font-semibold mb-1\">Take Action</p>\n                          <p className=\"text-muted-foreground text-xs\">Click suggested practice modes, view analytics details, or try recommended exercises directly from chat</p>\n                        </div>\n                      </div>\n                      <div className=\"flex gap-3\">\n                        <div className=\"bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs flex-shrink-0\">5</div>\n                        <div>\n                          <p className=\"font-semibold mb-1\">Follow Up</p>\n                          <p className=\"text-muted-foreground text-xs\">Ask clarifying questions, request more exercises, or get motivational support</p>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Integration with Analytics */}\n                <div className=\"bg-purple-500/10 border border-purple-500/20 rounded-lg p-4 mb-4\">\n                  <h4 className=\"font-semibold mb-2 text-sm flex items-center gap-2\">\n                    <BarChart3 className=\"w-4 h-4 text-purple-500\" />\n                    Analytics Integration\n                  </h4>\n                  <p className=\"text-xs text-muted-foreground mb-3\">\n                    The AI assistant has full access to your analytics dashboard, allowing it to provide context-aware coaching based on your actual performance data.\n                  </p>\n                  <div className=\"grid md:grid-cols-2 gap-2 text-xs\">\n                    <div className=\"flex items-center gap-2\">\n                      <Activity className=\"w-3 h-3 text-green-500\" />\n                      <span className=\"text-muted-foreground\">Keystroke heatmap analysis</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <Fingerprint className=\"w-3 h-3 text-green-500\" />\n                      <span className=\"text-muted-foreground\">Finger usage patterns</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <PieChart className=\"w-3 h-3 text-green-500\" />\n                      <span className=\"text-muted-foreground\">Hand balance metrics</span>\n                    </div>\n                    <div className=\"flex items-center gap-2\">\n                      <LineChart className=\"w-3 h-3 text-green-500\" />\n                      <span className=\"text-muted-foreground\">WPM & accuracy trends</span>\n                    </div>\n                  </div>\n                </div>\n\n                <div className=\"flex gap-3\">\n                  <Button asChild className=\"flex-1\" data-testid=\"button-ai-chat\">\n                    <Link href=\"/chat\">\n                      <Sparkles className=\"w-4 h-4 mr-2\" />\n                      Start Chat with AI Assistant\n                    </Link>\n                  </Button>\n                  <Button asChild variant=\"outline\" className=\"flex-1\" data-testid=\"button-view-analytics-ai\">\n                    <Link href=\"/analytics\">\n                      <BarChart3 className=\"w-4 h-4 mr-2\" />\n                      View Analytics & Ask AI\n                    </Link>\n                  </Button>\n                </div>\n              </div>\n\n              {/* Certificates & Sharing - Comprehensive Guide */}\n              <div className=\"bg-gradient-to-br from-green-500/10 to-emerald-500/10 rounded-lg p-6 border border-green-500/20 mb-6\">\n                <h3 className=\"text-2xl font-semibold mb-4 flex items-center gap-2\">\n                  <Award className=\"w-6 h-6 text-green-500\" />\n                  Achievement Certificates & Social Sharing\n                </h3>\n                <p className=\"text-muted-foreground mb-6\">\n                  Celebrate your typing milestones with professional certificates and share your achievements with the world. Every major accomplishment deserves recognition!\n                </p>\n\n                {/* How to Get Certificates */}\n                <div className=\"mb-6\">\n                  <h4 className=\"font-semibold mb-3 text-lg flex items-center gap-2\">\n                    <Download className=\"w-5 h-5 text-green-500\" />\n                    How to Download Certificates\n                  </h4>\n                  <div className=\"bg-background/50 rounded-lg p-4 border border-border mb-4\">\n                    <ol className=\"space-y-3 text-sm text-muted-foreground\">\n                      <li className=\"flex gap-3\">\n                        <span className=\"font-semibold text-green-500 flex-shrink-0\">Step 1:</span>\n                        <span>Complete a test or unlock an achievement (e.g., reach 100 WPM, achieve 100% accuracy, complete Stress Test)</span>\n                      </li>\n                      <li className=\"flex gap-3\">\n                        <span className=\"font-semibold text-green-500 flex-shrink-0\">Step 2:</span>\n                        <span>On the results page, click the \"Download Certificate\" button (appears for qualifying achievements)</span>\n                      </li>\n                      <li className=\"flex gap-3\">\n                        <span className=\"font-semibold text-green-500 flex-shrink-0\">Step 3:</span>\n                        <span>Customize your certificate: Add your name, choose color theme, select format (PDF or PNG)</span>\n                      </li>\n                      <li className=\"flex gap-3\">\n                        <span className=\"font-semibold text-green-500 flex-shrink-0\">Step 4:</span>\n                        <span>Preview the certificate to ensure all details are correct</span>\n                      </li>\n                      <li className=\"flex gap-3\">\n                        <span className=\"font-semibold text-green-500 flex-shrink-0\">Step 5:</span>\n                        <span>Click \"Generate & Download\" to save your certificate to your device</span>\n                      </li>\n                    </ol>\n                  </div>\n                </div>\n\n                {/* Certificate Types */}\n                <div className=\"grid md:grid-cols-2 gap-4 mb-6\">\n                  <div>\n                    <h4 className=\"font-semibold mb-3 text-sm flex items-center gap-2\">\n                      <Star className=\"w-4 h-4 text-amber-500\" />\n                      Certificate Types Available:\n                    </h4>\n                    <ul className=\"text-sm space-y-2 text-muted-foreground\">\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 mt-0.5\" />\n                        <span><strong>Speed Milestones:</strong> 50, 80, 100, 120+ WPM achievements</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 mt-0.5\" />\n                        <span><strong>Perfect Accuracy:</strong> 100% accuracy on any test</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 mt-0.5\" />\n                        <span><strong>Code Master:</strong> Complete all difficulty levels in Code Mode</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 mt-0.5\" />\n                        <span><strong>Stress Test Survivor:</strong> Complete Nightmare or Impossible levels</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 mt-0.5\" />\n                        <span><strong>Badge Collections:</strong> Earn all badges in a category</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <CheckCircle2 className=\"w-4 h-4 text-green-500 mt-0.5\" />\n                        <span><strong>Streak Champion:</strong> Maintain 30, 60, or 100-day streaks</span>\n                      </li>\n                    </ul>\n                  </div>\n                  <div>\n                    <h4 className=\"font-semibold mb-3 text-sm flex items-center gap-2\">\n                      <Settings className=\"w-4 h-4 text-purple-500\" />\n                      Customization Options:\n                    </h4>\n                    <ul className=\"text-sm space-y-2 text-muted-foreground\">\n                      <li>â€¢ Add your full name or username</li>\n                      <li>â€¢ Choose from 5 color themes</li>\n                      <li>â€¢ Select certificate size (A4, Letter, Square)</li>\n                      <li>â€¢ Include or hide detailed statistics</li>\n                      <li>â€¢ Add personalized message (premium)</li>\n                      <li>â€¢ Digital signature with verification code</li>\n                    </ul>\n                  </div>\n                </div>\n\n                {/* Social Sharing Guide */}\n                <div className=\"border-t border-border pt-6\">\n                  <h4 className=\"font-semibold mb-3 text-lg flex items-center gap-2\">\n                    <Share2 className=\"w-5 h-5 text-cyan-500\" />\n                    Social Sharing - Step by Step\n                  </h4>\n                  <div className=\"bg-background/50 rounded-lg p-4 border border-border mb-4\">\n                    <ol className=\"space-y-3 text-sm text-muted-foreground\">\n                      <li className=\"flex gap-3\">\n                        <span className=\"font-semibold text-cyan-500 flex-shrink-0\">Step 1:</span>\n                        <span>Complete any typing test or unlock an achievement</span>\n                      </li>\n                      <li className=\"flex gap-3\">\n                        <span className=\"font-semibold text-cyan-500 flex-shrink-0\">Step 2:</span>\n                        <span>On results page, click the \"Share\" button (top-right corner)</span>\n                      </li>\n                      <li className=\"flex gap-3\">\n                        <span className=\"font-semibold text-cyan-500 flex-shrink-0\">Step 3:</span>\n                        <span>Choose share format: Result Card (image) or Direct Link</span>\n                      </li>\n                      <li className=\"flex gap-3\">\n                        <span className=\"font-semibold text-cyan-500 flex-shrink-0\">Step 4:</span>\n                        <span>Select platform: Twitter, Facebook, LinkedIn, WhatsApp, or Copy Link</span>\n                      </li>\n                      <li className=\"flex gap-3\">\n                        <span className=\"font-semibold text-cyan-500 flex-shrink-0\">Step 5:</span>\n                        <span>Optional: Toggle \"Share Anonymously\" to hide your username</span>\n                      </li>\n                    </ol>\n                  </div>\n                  <div className=\"grid md:grid-cols-3 gap-3\">\n                    <div className=\"bg-blue-500/10 border border-blue-500/20 rounded p-3\">\n                      <p className=\"font-semibold text-sm mb-1\">Result Cards</p>\n                      <p className=\"text-xs text-muted-foreground\">Beautiful visual cards with your stats, automatically generated for sharing</p>\n                    </div>\n                    <div className=\"bg-purple-500/10 border border-purple-500/20 rounded p-3\">\n                      <p className=\"font-semibold text-sm mb-1\">Badge Showcase</p>\n                      <p className=\"text-xs text-muted-foreground\">Share unlocked badges with visual trophy display</p>\n                    </div>\n                    <div className=\"bg-green-500/10 border border-green-500/20 rounded p-3\">\n                      <p className=\"font-semibold text-sm mb-1\">Direct Links</p>\n                      <p className=\"text-xs text-muted-foreground\">Shareable URLs to your result pages with live data</p>\n                    </div>\n                  </div>\n                </div>\n\n                <div className=\"mt-6 bg-amber-500/10 border border-amber-500/20 rounded-lg p-4\">\n                  <p className=\"text-sm flex items-start gap-2\">\n                    <Lightbulb className=\"w-4 h-4 text-amber-500 flex-shrink-0 mt-0.5\" />\n                    <span className=\"text-muted-foreground\">\n                      <strong className=\"text-foreground\">Pro Tip:</strong> Access all your certificates anytime from Profile â†’ My Certificates. You can regenerate, re-download, or share any past achievement certificate!\n                    </span>\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-4\">\n                {/* Adaptive Difficulty - Detailed Expansion */}\n                <div className=\"col-span-full bg-gradient-to-br from-amber-500/10 to-orange-500/10 rounded-lg p-6 border border-amber-500/20\">\n                  <h4 className=\"font-semibold mb-3 text-lg flex items-center gap-2\">\n                    <TrendingUp className=\"w-5 h-5 text-amber-500\" />\n                    Intelligent Adaptive Difficulty System\n                  </h4>\n                  <p className=\"text-sm text-muted-foreground mb-4\">\n                    TypeMasterAI automatically adjusts content difficulty based on your performance, ensuring optimal challenge and continuous improvement. The system learns from your typing patterns to provide personalized practice content.\n                  </p>\n                  \n                  <div className=\"grid md:grid-cols-3 gap-4 mb-4\">\n                    <div className=\"bg-background/50 rounded-lg p-4 border border-border\">\n                      <h5 className=\"font-semibold text-sm mb-2 flex items-center gap-2\">\n                        <Brain className=\"w-4 h-4 text-purple-500\" />\n                        How It Works\n                      </h5>\n                      <ul className=\"text-xs space-y-1 text-muted-foreground\">\n                        <li>â€¢ Analyzes your recent 10-20 tests</li>\n                        <li>â€¢ Calculates average WPM & accuracy</li>\n                        <li>â€¢ Identifies problem keys and patterns</li>\n                        <li>â€¢ Adjusts word complexity in real-time</li>\n                        <li>â€¢ Increases difficulty as you improve</li>\n                      </ul>\n                    </div>\n                    \n                    <div className=\"bg-background/50 rounded-lg p-4 border border-border\">\n                      <h5 className=\"font-semibold text-sm mb-2 flex items-center gap-2\">\n                        <Gauge className=\"w-4 h-4 text-blue-500\" />\n                        Difficulty Levels\n                      </h5>\n                      <ul className=\"text-xs space-y-1 text-muted-foreground\">\n                        <li>â€¢ <strong>Beginner:</strong> Common 500 words (20-40 WPM)</li>\n                        <li>â€¢ <strong>Easy:</strong> Top 1,000 words (40-60 WPM)</li>\n                        <li>â€¢ <strong>Medium:</strong> Top 5,000 words (60-80 WPM)</li>\n                        <li>â€¢ <strong>Hard:</strong> Top 10,000 words (80-100 WPM)</li>\n                        <li>â€¢ <strong>Expert:</strong> Advanced vocabulary (100+ WPM)</li>\n                      </ul>\n                    </div>\n                    \n                    <div className=\"bg-background/50 rounded-lg p-4 border border-border\">\n                      <h5 className=\"font-semibold text-sm mb-2 flex items-center gap-2\">\n                        <Settings className=\"w-4 h-4 text-cyan-500\" />\n                        Manual Control\n                      </h5>\n                      <ul className=\"text-xs space-y-1 text-muted-foreground\">\n                        <li>â€¢ Override auto-difficulty in Settings</li>\n                        <li>â€¢ Lock to specific difficulty level</li>\n                        <li>â€¢ Practice problem keys only</li>\n                        <li>â€¢ Custom word lists (premium)</li>\n                        <li>â€¢ Reset progression anytime</li>\n                      </ul>\n                    </div>\n                  </div>\n                  \n                  <div className=\"bg-background/50 rounded-lg p-4 border border-border\">\n                    <h5 className=\"font-semibold text-sm mb-2\">Adaptive Triggers:</h5>\n                    <div className=\"grid md:grid-cols-2 gap-3 text-xs text-muted-foreground\">\n                      <div>\n                        <p className=\"font-semibold text-foreground mb-1\">â¬†ï¸ Difficulty Increases When:</p>\n                        <ul className=\"space-y-1\">\n                          <li>â€¢ Consistent 95%+ accuracy for 5 tests</li>\n                          <li>â€¢ WPM 10+ above current level average</li>\n                          <li>â€¢ Zero mistakes on problem keys</li>\n                        </ul>\n                      </div>\n                      <div>\n                        <p className=\"font-semibold text-foreground mb-1\">â¬‡ï¸ Difficulty Decreases When:</p>\n                        <ul className=\"space-y-1\">\n                          <li>â€¢ Accuracy drops below 85% for 3 tests</li>\n                          <li>â€¢ WPM significantly below level requirement</li>\n                          <li>â€¢ High error rate on new word types</li>\n                        </ul>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                <Card className=\"bg-indigo-500/10 border-indigo-500/20\">\n                  <CardHeader>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      <Clock className=\"w-5 h-5 text-indigo-500\" />\n                      Session History\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2\">\n                    <p className=\"text-sm text-muted-foreground\">\n                      Complete history of all your typing sessions and progress\n                    </p>\n                    <ul className=\"text-xs space-y-1 text-muted-foreground\">\n                      <li>â€¢ Every test result saved permanently</li>\n                      <li>â€¢ Dictation practice session logs</li>\n                      <li>â€¢ Multiplayer race history</li>\n                      <li>â€¢ Filter by date, mode, or performance</li>\n                    </ul>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-purple-500/10 border-purple-500/20\">\n                  <CardHeader>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      <Settings className=\"w-5 h-5 text-purple-500\" />\n                      Customization\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2\">\n                    <p className=\"text-sm text-muted-foreground\">\n                      Personalize your typing experience with extensive settings\n                    </p>\n                    <ul className=\"text-xs space-y-1 text-muted-foreground\">\n                      <li>â€¢ Themes (Dark/Light/Custom)</li>\n                      <li>â€¢ Typing sounds</li>\n                      <li>â€¢ Caret styles</li>\n                      <li>â€¢ Focus modes</li>\n                    </ul>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-orange-500/10 border-orange-500/20\">\n                  <CardHeader>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      <Download className=\"w-5 h-5 text-orange-500\" />\n                      PWA Support\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2\">\n                    <p className=\"text-sm text-muted-foreground\">\n                      Install as a Progressive Web App for offline access\n                    </p>\n                    <ul className=\"text-xs space-y-1 text-muted-foreground\">\n                      <li>â€¢ Offline typing practice</li>\n                      <li>â€¢ Push notifications</li>\n                      <li>â€¢ Desktop integration</li>\n                    </ul>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-red-500/10 border-red-500/20\">\n                  <CardHeader>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      <Shield className=\"w-5 h-5 text-red-500\" />\n                      Anti-Cheat System\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2\">\n                    <p className=\"text-sm text-muted-foreground\">\n                      Fair play enforcement with sophisticated validation\n                    </p>\n                    <ul className=\"text-xs space-y-1 text-muted-foreground\">\n                      <li>â€¢ Server-side verification</li>\n                      <li>â€¢ Keystroke validation</li>\n                      <li>â€¢ Pattern detection</li>\n                    </ul>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"bg-cyan-500/10 border-cyan-500/20\">\n                  <CardHeader>\n                    <CardTitle className=\"text-lg flex items-center gap-2\">\n                      <Globe className=\"w-5 h-5 text-cyan-500\" />\n                      Multi-Language\n                    </CardTitle>\n                  </CardHeader>\n                  <CardContent className=\"space-y-2\">\n                    <p className=\"text-sm text-muted-foreground\">\n                      Practice in 23+ languages with native content\n                    </p>\n                    <ul className=\"text-xs space-y-1 text-muted-foreground\">\n                      <li>â€¢ Language-specific paragraphs</li>\n                      <li>â€¢ Special character support</li>\n                      <li>â€¢ Unicode handling</li>\n                    </ul>\n                  </CardContent>\n                </Card>\n              </div>\n\n              <div className=\"bg-gradient-to-r from-indigo-500/10 via-purple-500/10 to-pink-500/10 rounded-lg p-6 border border-indigo-500/20\">\n                <h4 className=\"font-semibold mb-3 flex items-center gap-2\">\n                  <Eye className=\"w-5 h-5 text-indigo-500\" />\n                  Accessibility Features\n                </h4>\n                <div className=\"grid md:grid-cols-2 gap-4 text-sm text-muted-foreground\">\n                  <ul className=\"space-y-2\">\n                    <li className=\"flex items-center gap-2\">\n                      <CheckCircle2 className=\"w-4 h-4 text-green-500\" />\n                      Keyboard-only navigation\n                    </li>\n                    <li className=\"flex items-center gap-2\">\n                      <CheckCircle2 className=\"w-4 h-4 text-green-500\" />\n                      Screen reader support\n                    </li>\n                    <li className=\"flex items-center gap-2\">\n                      <CheckCircle2 className=\"w-4 h-4 text-green-500\" />\n                      High contrast themes\n                    </li>\n                  </ul>\n                  <ul className=\"space-y-2\">\n                    <li className=\"flex items-center gap-2\">\n                      <CheckCircle2 className=\"w-4 h-4 text-green-500\" />\n                      Adjustable font sizes\n                    </li>\n                    <li className=\"flex items-center gap-2\">\n                      <CheckCircle2 className=\"w-4 h-4 text-green-500\" />\n                      Focus indicators\n                    </li>\n                    <li className=\"flex items-center gap-2\">\n                      <CheckCircle2 className=\"w-4 h-4 text-green-500\" />\n                      ARIA labels\n                    </li>\n                  </ul>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </motion.section>\n\n        {/* Tips & Tricks Section */}\n        <motion.section\n          id=\"tips\"\n          initial={{ opacity: 0 }}\n          whileInView={{ opacity: 1 }}\n          viewport={{ once: true }}\n          className=\"scroll-mt-24\"\n        >\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center gap-3 mb-2\">\n                <div className=\"p-3 rounded-lg bg-yellow-500/10\">\n                  <Lightbulb className=\"w-6 h-6 text-yellow-500\" />\n                </div>\n                <div>\n                  <CardTitle className=\"text-3xl\">Tips & Best Practices</CardTitle>\n                  <CardDescription>Expert advice to accelerate your progress</CardDescription>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <div className=\"grid md:grid-cols-2 gap-6\">\n                <div>\n                  <h3 className=\"text-xl font-semibold mb-4 flex items-center gap-2\">\n                    <Target className=\"w-5 h-5 text-blue-500\" />\n                    For Beginners\n                  </h3>\n                  <div className=\"space-y-3\">\n                    <div className=\"bg-blue-500/10 rounded-lg p-4 border border-blue-500/20\">\n                      <h4 className=\"font-semibold mb-2\">1. Focus on Accuracy First</h4>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Speed will come naturally once you build muscle memory. Aim for 95%+ accuracy before pushing for higher WPM.\n                      </p>\n                    </div>\n                    <div className=\"bg-blue-500/10 rounded-lg p-4 border border-blue-500/20\">\n                      <h4 className=\"font-semibold mb-2\">2. Use Proper Technique</h4>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Keep wrists elevated, fingers curved, and use the home row position. Don't look at the keyboard.\n                      </p>\n                    </div>\n                    <div className=\"bg-blue-500/10 rounded-lg p-4 border border-blue-500/20\">\n                      <h4 className=\"font-semibold mb-2\">3. Practice Daily</h4>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Even 10-15 minutes daily is more effective than occasional long sessions. Build a streak!\n                      </p>\n                    </div>\n                  </div>\n                </div>\n\n                <div>\n                  <h3 className=\"text-xl font-semibold mb-4 flex items-center gap-2\">\n                    <Zap className=\"w-5 h-5 text-amber-500\" />\n                    For Advanced Users\n                  </h3>\n                  <div className=\"space-y-3\">\n                    <div className=\"bg-amber-500/10 rounded-lg p-4 border border-amber-500/20\">\n                      <h4 className=\"font-semibold mb-2\">1. Target Weak Keys</h4>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Use Analytics to identify error-prone keys and practice them specifically. Focus on digraphs (key combinations).\n                      </p>\n                    </div>\n                    <div className=\"bg-amber-500/10 rounded-lg p-4 border border-amber-500/20\">\n                      <h4 className=\"font-semibold mb-2\">2. Vary Your Practice</h4>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Mix standard tests with Code Mode, Book Mode, and Dictation to challenge different skills.\n                      </p>\n                    </div>\n                    <div className=\"bg-amber-500/10 rounded-lg p-4 border border-amber-500/20\">\n                      <h4 className=\"font-semibold mb-2\">3. Use Multiplayer for Motivation</h4>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Racing against others pushes you to type faster. Compete regularly to improve under pressure.\n                      </p>\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"bg-gradient-to-r from-green-500/10 via-emerald-500/10 to-teal-500/10 rounded-lg p-6 border border-green-500/20\">\n                <h4 className=\"font-semibold mb-4 flex items-center gap-2\">\n                  <TrendingUp className=\"w-5 h-5 text-green-500\" />\n                  Proven Improvement Strategies\n                </h4>\n                <div className=\"grid md:grid-cols-2 gap-4\">\n                  <div>\n                    <h5 className=\"font-semibold mb-2 text-sm\">Technique Tips:</h5>\n                    <ul className=\"text-sm space-y-1 text-muted-foreground\">\n                      <li>â€¢ Maintain consistent rhythm, don't rush</li>\n                      <li>â€¢ Use all fingers, not just index fingers</li>\n                      <li>â€¢ Press keys lightly, don't pound</li>\n                      <li>â€¢ Take breaks every 20-30 minutes</li>\n                      <li>â€¢ Sit with good posture</li>\n                    </ul>\n                  </div>\n                  <div>\n                    <h5 className=\"font-semibold mb-2 text-sm\">Mental Approach:</h5>\n                    <ul className=\"text-sm space-y-1 text-muted-foreground\">\n                      <li>â€¢ Read ahead of what you're typing</li>\n                      <li>â€¢ Don't dwell on mistakes, keep flowing</li>\n                      <li>â€¢ Practice when you're alert and focused</li>\n                      <li>â€¢ Set realistic, incremental goals</li>\n                      <li>â€¢ Celebrate small improvements</li>\n                    </ul>\n                  </div>\n                </div>\n              </div>\n\n              <div className=\"bg-muted/50 rounded-lg p-6 border border-border\">\n                <h4 className=\"font-semibold mb-3 flex items-center gap-2\">\n                  <Clock className=\"w-5 h-5 text-blue-500\" />\n                  Recommended Practice Schedule\n                </h4>\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-start gap-3\">\n                    <Badge variant=\"outline\">Week 1-2</Badge>\n                    <p className=\"text-sm text-muted-foreground\">\n                      15 min/day standard tests. Focus on accuracy (95%+). Learn proper finger placement.\n                    </p>\n                  </div>\n                  <div className=\"flex items-start gap-3\">\n                    <Badge variant=\"outline\">Week 3-4</Badge>\n                    <p className=\"text-sm text-muted-foreground\">\n                      20 min/day mixed practice. Add Code Mode or Book Mode. Target weak keys from analytics.\n                    </p>\n                  </div>\n                  <div className=\"flex items-start gap-3\">\n                    <Badge variant=\"outline\">Month 2+</Badge>\n                    <p className=\"text-sm text-muted-foreground\">\n                      30 min/day varied practice. Include multiplayer races. Use AI insights for targeted improvement.\n                    </p>\n                  </div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </motion.section>\n\n        {/* Call to Action */}\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          whileInView={{ opacity: 1, y: 0 }}\n          viewport={{ once: true }}\n          className=\"text-center py-12\"\n        >\n          <Card className=\"bg-gradient-to-br from-primary/20 via-purple-500/20 to-pink-500/20 border-primary/30\">\n            <CardContent className=\"p-8\">\n              <h2 className=\"text-3xl font-bold mb-4\">Ready to Master Your Typing?</h2>\n              <p className=\"text-lg text-muted-foreground mb-6 max-w-2xl mx-auto\">\n                Join thousands of users improving their typing speed and accuracy every day. Start your journey now!\n              </p>\n              <div className=\"flex flex-wrap gap-3 justify-center\">\n                <Button asChild size=\"lg\" data-testid=\"button-cta-start\">\n                  <Link href=\"/\">\n                    <PlayCircle className=\"w-5 h-5 mr-2\" />\n                    Start Typing Now\n                  </Link>\n                </Button>\n                <Button asChild size=\"lg\" variant=\"outline\" data-testid=\"button-cta-register\">\n                  <Link href=\"/register\">\n                    <Rocket className=\"w-5 h-5 mr-2\" />\n                    Create Free Account\n                  </Link>\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        </motion.div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":95987,"size_tokens":null},"client/src/pages/ai-transparency.tsx":{"content":"import { Link } from \"wouter\";\n\nexport default function AITransparency() {\n  return (\n    <div className=\"max-w-4xl mx-auto\" data-testid=\"page-ai-transparency\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-4xl font-bold mb-2\" data-testid=\"heading-ai-transparency\">AI Transparency Notice</h1>\n        <p className=\"text-muted-foreground text-sm mb-4\">Last Updated: December 9, 2025</p>\n        <p className=\"text-muted-foreground text-lg\">\n          TypeMasterAI is committed to transparency about our use of artificial intelligence. This page explains how we use AI technology, what data is processed, and your rights regarding AI-powered features.\n        </p>\n      </div>\n\n      <div className=\"space-y-10 prose prose-invert max-w-none\">\n        <section className=\"bg-primary/5 p-6 rounded-lg border border-primary/20\">\n          <h2 className=\"text-xl font-bold text-foreground mb-2\">AI Systems We Use</h2>\n          <p className=\"text-muted-foreground\">\n            TypeMasterAI uses third-party artificial intelligence platforms to power various features. When you interact with AI features on our platform, you are communicating with an automated artificial intelligence system, not a human.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">1. AI-Powered Features</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            The following features on TypeMasterAI use artificial intelligence:\n          </p>\n          <div className=\"grid md:grid-cols-2 gap-4\">\n            <div className=\"bg-card/30 p-4 rounded-lg border border-border\">\n              <h3 className=\"font-semibold text-foreground mb-2\">\n                AI Chat Assistant\n              </h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Our AI typing coach provides personalized tips, answers questions about typing improvement, and offers guidance using advanced language models.\n              </p>\n            </div>\n            <div className=\"bg-card/30 p-4 rounded-lg border border-border\">\n              <h3 className=\"font-semibold text-foreground mb-2\">\n                Paragraph Generation\n              </h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Typing test paragraphs are dynamically generated using AI to ensure fresh, contextually relevant content in 23+ languages.\n              </p>\n            </div>\n            <div className=\"bg-card/30 p-4 rounded-lg border border-border\">\n              <h3 className=\"font-semibold text-foreground mb-2\">\n                Code Snippet Generation\n              </h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Code typing mode generates programming code snippets across multiple languages using AI for realistic coding practice.\n              </p>\n            </div>\n            <div className=\"bg-card/30 p-4 rounded-lg border border-border\">\n              <h3 className=\"font-semibold text-foreground mb-2\">\n                AI Ghost Racers\n              </h3>\n              <p className=\"text-sm text-muted-foreground\">\n                In multiplayer races, AI-powered bots may join to ensure engaging competitions even when fewer human players are available.\n              </p>\n            </div>\n          </div>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">2. How AI Processes Your Data</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            When you use AI features, the following data may be sent to our third-party AI service providers for processing:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">AI Chat:</strong> Your messages and conversation history within the current session</li>\n            <li><strong className=\"text-foreground\">Paragraph Generation:</strong> Selected language, category preferences, and difficulty settings</li>\n            <li><strong className=\"text-foreground\">Code Generation:</strong> Selected programming language and complexity level</li>\n            <li><strong className=\"text-foreground\">Web Search:</strong> When enabled, your queries may be used to search the internet for current information</li>\n          </ul>\n          <p className=\"text-muted-foreground mt-4\">\n            <strong className=\"text-foreground\">Important:</strong> We do not send your personal account information, typing test results, or analytics data to AI providers unless you explicitly include it in your chat messages.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">3. Data Retention by AI Providers</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            Our third-party AI service providers handle data according to industry-standard practices:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>API data is typically retained for limited periods (e.g., 30 days) for security and abuse monitoring, then deleted</li>\n            <li>AI providers do not use API data to train their models without explicit consent</li>\n            <li>Data is processed internationally in countries where AI infrastructure providers operate</li>\n          </ul>\n          <p className=\"text-muted-foreground mt-4\">\n            <strong className=\"text-foreground\">Detailed Vendor Information:</strong> A complete list of our AI service providers and their data practices is available upon request. Contact us at <a href=\"mailto:support@typemasterai.com\" className=\"text-primary hover:underline\">support@typemasterai.com</a> for this information.\n          </p>\n        </section>\n\n        <section className=\"bg-amber-500/10 p-6 rounded-lg border border-amber-500/20\">\n          <h2 className=\"text-xl font-bold text-foreground mb-3 pb-2 border-b border-amber-500/20\">4. AI Limitations & Accuracy</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            Please be aware of the following limitations:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>AI-generated content may contain <strong className=\"text-foreground\">factual errors or inaccuracies</strong></li>\n            <li>AI responses are generated in real-time and may vary in quality</li>\n            <li>AI cannot provide <strong className=\"text-foreground\">professional advice</strong> (medical, legal, financial)</li>\n            <li>Generated code snippets may contain bugs or security vulnerabilities</li>\n            <li>AI chat does not have memory of previous sessions unless specifically designed</li>\n          </ul>\n          <p className=\"text-muted-foreground mt-4\">\n            <strong className=\"text-foreground\">Always verify important information</strong> from reliable sources before relying on AI-generated content.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">5. Your Rights & Controls</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            You have the following rights regarding AI features:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Opt-Out:</strong> You can use TypeMasterAI without interacting with AI features (use pre-generated paragraphs instead)</li>\n            <li><strong className=\"text-foreground\">Data Access:</strong> Request information about data sent to AI providers</li>\n            <li><strong className=\"text-foreground\">Deletion:</strong> Request deletion of your AI conversation history</li>\n            <li><strong className=\"text-foreground\">Report Issues:</strong> Flag inappropriate or harmful AI-generated content</li>\n            <li><strong className=\"text-foreground\">Vendor Details:</strong> Request a list of specific AI service providers we use</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">6. EU AI Act Compliance</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            In compliance with the European Union AI Act (Regulation (EU) 2024/1689):\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>We clearly disclose that our chatbot is powered by artificial intelligence</li>\n            <li>AI-generated content is identified where applicable</li>\n            <li>We do not use prohibited AI practices (social scoring, subliminal manipulation, etc.)</li>\n            <li>Our AI usage falls under \"limited-risk\" category requiring transparency obligations</li>\n            <li>Detailed technical information about our AI systems is available upon request</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">7. Updates to This Notice</h2>\n          <p className=\"text-muted-foreground\">\n            We may update this AI Transparency Notice as our AI features evolve or as regulations change. Significant updates will be communicated through our platform. We encourage you to review this page periodically.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">8. Related Policies</h2>\n          <ul className=\"space-y-2\">\n            <li>\n              <Link href=\"/privacy-policy\" className=\"text-primary hover:underline\">Privacy Policy</Link>\n              <span className=\"text-muted-foreground\"> - How we collect and protect your personal data</span>\n            </li>\n            <li>\n              <Link href=\"/terms-of-service\" className=\"text-primary hover:underline\">Terms of Service</Link>\n              <span className=\"text-muted-foreground\"> - Rules for using TypeMasterAI</span>\n            </li>\n            <li>\n              <Link href=\"/cookie-policy\" className=\"text-primary hover:underline\">Cookie Policy</Link>\n              <span className=\"text-muted-foreground\"> - How we use cookies and tracking technologies</span>\n            </li>\n          </ul>\n        </section>\n\n        <section className=\"bg-card/30 p-8 rounded-xl border border-border\">\n          <h2 className=\"text-2xl font-bold text-foreground mb-6\">Questions About Our AI?</h2>\n          <p className=\"text-muted-foreground mb-6\">\n            If you have questions about our use of artificial intelligence, please contact us:\n          </p>\n          <div className=\"space-y-4\">\n            <div>\n              <p className=\"text-sm font-semibold text-foreground mb-1\">Email</p>\n              <a href=\"mailto:support@typemasterai.com\" className=\"text-primary hover:underline text-lg\">\n                support@typemasterai.com\n              </a>\n            </div>\n            <div>\n              <p className=\"text-sm font-semibold text-foreground mb-1\">Mailing Address</p>\n              <p className=\"text-muted-foreground\">\n                TypeMasterAI<br />\n                Solapur, Maharashtra 413224<br />\n                India\n              </p>\n            </div>\n          </div>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":11545,"size_tokens":null},"client/src/components/cookie-consent-banner.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Link } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Cookie, X, Settings } from \"lucide-react\";\n\nconst COOKIE_CONSENT_KEY = \"typemasterai_cookie_consent\";\n\ninterface CookiePreferences {\n  necessary: boolean;\n  analytics: boolean;\n  marketing: boolean;\n  timestamp: number;\n}\n\nexport function CookieConsentBanner() {\n  const [showBanner, setShowBanner] = useState(false);\n  const [showSettings, setShowSettings] = useState(false);\n  const [preferences, setPreferences] = useState<CookiePreferences>({\n    necessary: true,\n    analytics: false,\n    marketing: false,\n    timestamp: 0,\n  });\n\n  useEffect(() => {\n    const stored = localStorage.getItem(COOKIE_CONSENT_KEY);\n    if (!stored) {\n      setShowBanner(true);\n    } else {\n      try {\n        const parsed = JSON.parse(stored) as CookiePreferences;\n        const sixMonthsAgo = Date.now() - 180 * 24 * 60 * 60 * 1000;\n        if (parsed.timestamp < sixMonthsAgo) {\n          setShowBanner(true);\n        }\n      } catch {\n        setShowBanner(true);\n      }\n    }\n  }, []);\n\n  const savePreferences = (prefs: CookiePreferences) => {\n    localStorage.setItem(COOKIE_CONSENT_KEY, JSON.stringify(prefs));\n    setShowBanner(false);\n    setShowSettings(false);\n  };\n\n  const acceptAll = () => {\n    savePreferences({\n      necessary: true,\n      analytics: true,\n      marketing: true,\n      timestamp: Date.now(),\n    });\n  };\n\n  const rejectAll = () => {\n    savePreferences({\n      necessary: true,\n      analytics: false,\n      marketing: false,\n      timestamp: Date.now(),\n    });\n  };\n\n  const saveCustom = () => {\n    savePreferences({\n      ...preferences,\n      timestamp: Date.now(),\n    });\n  };\n\n  if (!showBanner) return null;\n\n  return (\n    <div \n      className=\"fixed bottom-0 left-0 right-0 z-50 bg-card border-t border-border shadow-lg\"\n      role=\"dialog\"\n      aria-label=\"Cookie consent\"\n      aria-describedby=\"cookie-consent-description\"\n    >\n      <div className=\"container mx-auto px-4 py-4\">\n        {!showSettings ? (\n          <div className=\"flex flex-col md:flex-row items-start md:items-center gap-4\">\n            <div className=\"flex items-start gap-3 flex-1\">\n              <Cookie className=\"w-5 h-5 text-primary flex-shrink-0 mt-0.5\" aria-hidden=\"true\" />\n              <div>\n                <p id=\"cookie-consent-description\" className=\"text-sm text-muted-foreground\">\n                  We use cookies to enhance your experience. By continuing to visit this site you agree to our use of cookies.{\" \"}\n                  <Link href=\"/cookie-policy\" className=\"text-primary hover:underline\">\n                    Learn more\n                  </Link>\n                </p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2 flex-shrink-0\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={() => setShowSettings(true)}\n                className=\"text-xs\"\n                data-testid=\"button-cookie-settings\"\n              >\n                <Settings className=\"w-3 h-3 mr-1\" />\n                Customize\n              </Button>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={rejectAll}\n                className=\"text-xs\"\n                data-testid=\"button-cookie-reject\"\n              >\n                Reject All\n              </Button>\n              <Button\n                size=\"sm\"\n                onClick={acceptAll}\n                className=\"text-xs\"\n                data-testid=\"button-cookie-accept\"\n              >\n                Accept All\n              </Button>\n            </div>\n          </div>\n        ) : (\n          <div className=\"space-y-4\">\n            <div className=\"flex items-center justify-between\">\n              <h3 className=\"text-sm font-semibold flex items-center gap-2\">\n                <Cookie className=\"w-4 h-4 text-primary\" />\n                Cookie Preferences\n              </h3>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={() => setShowSettings(false)}\n                className=\"h-6 w-6\"\n                aria-label=\"Close cookie settings\"\n              >\n                <X className=\"w-4 h-4\" />\n              </Button>\n            </div>\n\n            <div className=\"space-y-3\">\n              <div className=\"flex items-start gap-3 p-2 rounded-lg bg-accent/30\">\n                <input\n                  type=\"checkbox\"\n                  id=\"necessary\"\n                  checked={true}\n                  disabled\n                  className=\"mt-1\"\n                  aria-describedby=\"necessary-desc\"\n                />\n                <div>\n                  <label htmlFor=\"necessary\" className=\"text-sm font-medium\">\n                    Necessary Cookies\n                  </label>\n                  <p id=\"necessary-desc\" className=\"text-xs text-muted-foreground\">\n                    Required for the website to function properly. Cannot be disabled.\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"flex items-start gap-3 p-2 rounded-lg hover:bg-accent/20\">\n                <input\n                  type=\"checkbox\"\n                  id=\"analytics\"\n                  checked={preferences.analytics}\n                  onChange={(e) => setPreferences({ ...preferences, analytics: e.target.checked })}\n                  className=\"mt-1\"\n                  aria-describedby=\"analytics-desc\"\n                />\n                <div>\n                  <label htmlFor=\"analytics\" className=\"text-sm font-medium cursor-pointer\">\n                    Analytics Cookies\n                  </label>\n                  <p id=\"analytics-desc\" className=\"text-xs text-muted-foreground\">\n                    Help us understand how visitors interact with our website.\n                  </p>\n                </div>\n              </div>\n\n              <div className=\"flex items-start gap-3 p-2 rounded-lg hover:bg-accent/20\">\n                <input\n                  type=\"checkbox\"\n                  id=\"marketing\"\n                  checked={preferences.marketing}\n                  onChange={(e) => setPreferences({ ...preferences, marketing: e.target.checked })}\n                  className=\"mt-1\"\n                  aria-describedby=\"marketing-desc\"\n                />\n                <div>\n                  <label htmlFor=\"marketing\" className=\"text-sm font-medium cursor-pointer\">\n                    Marketing Cookies\n                  </label>\n                  <p id=\"marketing-desc\" className=\"text-xs text-muted-foreground\">\n                    Used to track visitors across websites for marketing purposes.\n                  </p>\n                </div>\n              </div>\n            </div>\n\n            <div className=\"flex items-center justify-end gap-2 pt-2 border-t border-border\">\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                onClick={rejectAll}\n                className=\"text-xs\"\n                data-testid=\"button-cookie-reject-custom\"\n              >\n                Reject All\n              </Button>\n              <Button\n                size=\"sm\"\n                onClick={saveCustom}\n                className=\"text-xs\"\n                data-testid=\"button-cookie-save\"\n              >\n                Save Preferences\n              </Button>\n            </div>\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n\nexport function useCookieConsent() {\n  const [preferences, setPreferences] = useState<CookiePreferences | null>(null);\n\n  useEffect(() => {\n    const stored = localStorage.getItem(COOKIE_CONSENT_KEY);\n    if (stored) {\n      try {\n        setPreferences(JSON.parse(stored));\n      } catch {\n        setPreferences(null);\n      }\n    }\n  }, []);\n\n  return preferences;\n}\n","path":null,"size_bytes":7936,"size_tokens":null},"client/src/pages/accessibility.tsx":{"content":"import { Link } from \"wouter\";\n\nexport default function AccessibilityStatement() {\n  return (\n    <div className=\"max-w-4xl mx-auto\" data-testid=\"page-accessibility\">\n      <div className=\"mb-8\">\n        <h1 className=\"text-4xl font-bold mb-2\" data-testid=\"heading-accessibility\">Accessibility Statement</h1>\n        <p className=\"text-muted-foreground text-sm mb-4\">Last Updated: December 9, 2025</p>\n        <p className=\"text-muted-foreground text-lg\">\n          TypeMasterAI is committed to ensuring digital accessibility for people with disabilities. We are continually improving the user experience for everyone and applying the relevant accessibility standards.\n        </p>\n      </div>\n\n      <div className=\"space-y-10 prose prose-invert max-w-none\">\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">Our Commitment</h2>\n          <p className=\"text-muted-foreground\">\n            We believe that typing practice should be accessible to everyone, regardless of ability. TypeMasterAI strives to conform to the Web Content Accessibility Guidelines (WCAG) 2.1 Level AA standards. These guidelines explain how to make web content more accessible for people with disabilities and more user-friendly for everyone.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">Accessibility Features</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            TypeMasterAI implements the following accessibility features:\n          </p>\n          <div className=\"grid md:grid-cols-2 gap-4\">\n            <div className=\"bg-card/30 p-4 rounded-lg border border-border\">\n              <h3 className=\"font-semibold text-foreground mb-2\">\n                Keyboard Navigation\n              </h3>\n              <p className=\"text-sm text-muted-foreground\">\n                All interactive elements can be accessed using keyboard navigation. Use Tab to move forward, Shift+Tab to move backward, and Enter/Space to activate.\n              </p>\n            </div>\n            <div className=\"bg-card/30 p-4 rounded-lg border border-border\">\n              <h3 className=\"font-semibold text-foreground mb-2\">\n                Visual Contrast\n              </h3>\n              <p className=\"text-sm text-muted-foreground\">\n                We maintain a minimum 4.5:1 contrast ratio for normal text and 3:1 for large text, ensuring readability for users with visual impairments.\n              </p>\n            </div>\n            <div className=\"bg-card/30 p-4 rounded-lg border border-border\">\n              <h3 className=\"font-semibold text-foreground mb-2\">\n                Screen Reader Support\n              </h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Our platform is compatible with popular screen readers including NVDA, JAWS, and VoiceOver. We use semantic HTML and ARIA labels throughout the interface.\n              </p>\n            </div>\n            <div className=\"bg-card/30 p-4 rounded-lg border border-border\">\n              <h3 className=\"font-semibold text-foreground mb-2\">\n                Responsive Design\n              </h3>\n              <p className=\"text-sm text-muted-foreground\">\n                TypeMasterAI works across devices of all sizes. Text can be resized up to 200% without loss of functionality, and content reflows appropriately.\n              </p>\n            </div>\n            <div className=\"bg-card/30 p-4 rounded-lg border border-border\">\n              <h3 className=\"font-semibold text-foreground mb-2\">\n                Reduced Motion Support\n              </h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Animations are disabled for users who prefer reduced motion, ensuring a less distracting experience for those with vestibular disorders.\n              </p>\n            </div>\n            <div className=\"bg-card/30 p-4 rounded-lg border border-border\">\n              <h3 className=\"font-semibold text-foreground mb-2\">\n                Focus Indicators\n              </h3>\n              <p className=\"text-sm text-muted-foreground\">\n                Clear visual focus indicators help keyboard users understand which element is currently selected during navigation.\n              </p>\n            </div>\n          </div>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">Technical Implementation</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            Our accessibility compliance is built on industry-standard technologies and best practices:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Semantic HTML5:</strong> Proper use of heading hierarchy, landmarks, and meaningful element structure</li>\n            <li><strong className=\"text-foreground\">WAI-ARIA:</strong> Over 260 ARIA attributes throughout the application for enhanced screen reader support (aria-label, aria-live, aria-describedby, role attributes)</li>\n            <li><strong className=\"text-foreground\">Keyboard Accessibility:</strong> Full keyboard navigation with visible focus indicators and logical tab order</li>\n            <li><strong className=\"text-foreground\">Testing Coverage:</strong> 800+ test identifiers ensuring comprehensive automated accessibility testing</li>\n            <li><strong className=\"text-foreground\">Responsive Typography:</strong> Scalable text using relative units that respects user preferences</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">Conformance Status</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            TypeMasterAI aims to conform to WCAG 2.1 Level AA. Our current conformance status across the four principles:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Perceivable:</strong> We provide text alternatives for non-text content, captions where applicable, and sufficient color contrast</li>\n            <li><strong className=\"text-foreground\">Operable:</strong> All functionality is available from a keyboard, users have enough time to read content, and navigation is consistent</li>\n            <li><strong className=\"text-foreground\">Understandable:</strong> Text is readable, pages appear and operate in predictable ways, and input assistance is provided</li>\n            <li><strong className=\"text-foreground\">Robust:</strong> Content is compatible with current and future assistive technologies through proper markup and ARIA implementation</li>\n          </ul>\n        </section>\n\n        <section className=\"bg-amber-500/10 p-6 rounded-lg border border-amber-500/20\">\n          <h2 className=\"text-xl font-bold text-foreground mb-3 pb-2 border-b border-amber-500/20\">Known Limitations</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            We are actively working to address the following accessibility limitations:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Visual Typing Tests:</strong> The core typing test experience requires visual input tracking. We are exploring alternative modes and audio feedback for users with visual impairments.</li>\n            <li><strong className=\"text-foreground\">Real-time Multiplayer:</strong> Multiplayer racing and live leaderboards currently rely on visual feedback. Enhanced audio cues are planned for future updates.</li>\n            <li><strong className=\"text-foreground\">AI-Generated Content:</strong> Some dynamically generated content may not meet all accessibility standards. We continuously monitor and improve AI output quality.</li>\n            <li><strong className=\"text-foreground\">Complex Visualizations:</strong> Charts and analytics dashboards may present challenges for screen reader users. Alternative data formats are being developed.</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">Compatible Assistive Technologies</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            TypeMasterAI is designed to be compatible with the following assistive technologies:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li>Screen readers (NVDA, JAWS, VoiceOver, TalkBack, Narrator)</li>\n            <li>Screen magnification software (ZoomText, Windows Magnifier)</li>\n            <li>Speech recognition software (Dragon NaturallySpeaking, Windows Speech Recognition)</li>\n            <li>Keyboard-only navigation and alternative input devices</li>\n            <li>Browser zoom and text scaling features</li>\n            <li>High contrast mode and custom color schemes</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">Assessment Methods</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            We assess the accessibility of TypeMasterAI through multiple evaluation methods:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">Automated Testing:</strong> Regular scans using axe DevTools, WAVE, and Lighthouse accessibility audits</li>\n            <li><strong className=\"text-foreground\">Manual Testing:</strong> Comprehensive keyboard navigation testing across all features</li>\n            <li><strong className=\"text-foreground\">Screen Reader Testing:</strong> Regular testing with NVDA, JAWS, and VoiceOver</li>\n            <li><strong className=\"text-foreground\">Color Contrast Analysis:</strong> Verification of contrast ratios using specialized tools</li>\n            <li><strong className=\"text-foreground\">User Feedback:</strong> Continuous improvement based on accessibility reports from our community</li>\n            <li><strong className=\"text-foreground\">Code Reviews:</strong> Accessibility checks integrated into our development workflow</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">Feedback & Contact</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            We welcome your feedback on the accessibility of TypeMasterAI. Please let us know if you encounter accessibility barriers or have suggestions for improvement.\n          </p>\n          <div className=\"bg-primary/5 p-6 rounded-lg border border-primary/20\">\n            <p className=\"text-muted-foreground mb-4\">\n              <strong className=\"text-foreground\">Response Time:</strong> We aim to respond to accessibility feedback within 5 business days. Critical accessibility issues are prioritized and addressed as quickly as possible.\n            </p>\n            <div className=\"space-y-4\">\n              <div>\n                <p className=\"text-sm font-semibold text-foreground mb-1\">Email</p>\n                <a href=\"mailto:support@typemasterai.com\" className=\"text-primary hover:underline text-lg\">\n                  support@typemasterai.com\n                </a>\n              </div>\n              <div>\n                <p className=\"text-sm font-semibold text-foreground mb-1\">Mailing Address</p>\n                <p className=\"text-muted-foreground\">\n                  TypeMasterAI<br />\n                  Solapur, Maharashtra 413224<br />\n                  India\n                </p>\n              </div>\n            </div>\n          </div>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">Enforcement & Legal Rights</h2>\n          <p className=\"text-muted-foreground mb-4\">\n            If you are not satisfied with our response to your accessibility concern, you have the following options:\n          </p>\n          <ul className=\"list-disc pl-6 text-muted-foreground space-y-2\">\n            <li><strong className=\"text-foreground\">India:</strong> Contact the Department of Empowerment of Persons with Disabilities or your local consumer protection authority</li>\n            <li><strong className=\"text-foreground\">European Union:</strong> Contact your national equality body or digital accessibility enforcement authority</li>\n            <li><strong className=\"text-foreground\">United States:</strong> File a complaint with the Department of Justice under the Americans with Disabilities Act (ADA)</li>\n            <li><strong className=\"text-foreground\">Other Regions:</strong> Contact your local disability rights organization or human rights commission</li>\n          </ul>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">Continuous Improvement</h2>\n          <p className=\"text-muted-foreground\">\n            Accessibility is an ongoing journey, not a destination. We regularly review and update our accessibility practices as standards evolve and new assistive technologies emerge. This statement is reviewed and updated quarterly to reflect our current accessibility status and planned improvements.\n          </p>\n        </section>\n\n        <section>\n          <h2 className=\"text-2xl font-bold text-foreground mb-4 pb-2 border-b border-primary/20\">Related Resources</h2>\n          <ul className=\"space-y-2\">\n            <li>\n              <Link href=\"/privacy-policy\" className=\"text-primary hover:underline\">Privacy Policy</Link>\n              <span className=\"text-muted-foreground\"> - How we protect your personal information</span>\n            </li>\n            <li>\n              <Link href=\"/terms-of-service\" className=\"text-primary hover:underline\">Terms of Service</Link>\n              <span className=\"text-muted-foreground\"> - Rules for using TypeMasterAI</span>\n            </li>\n            <li>\n              <Link href=\"/contact\" className=\"text-primary hover:underline\">Contact Support</Link>\n              <span className=\"text-muted-foreground\"> - General inquiries and technical assistance</span>\n            </li>\n          </ul>\n        </section>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":14554,"size_tokens":null},"shared/platform-stats.ts":{"content":"export const PLATFORM_STATS = {\n  TOTAL_TESTS: 10_500_000,\n  TOTAL_USERS: 125_000,\n  TOTAL_LANGUAGES: 23,\n} as const;\n\nexport function formatNumber(num: number): string {\n  if (num >= 1_000_000) {\n    return (num / 1_000_000).toFixed(1).replace(/\\.0$/, '') + 'M+';\n  }\n  if (num >= 1_000) {\n    return (num / 1_000).toFixed(1).replace(/\\.0$/, '') + 'K+';\n  }\n  return num.toString();\n}\n","path":null,"size_bytes":386,"size_tokens":null},"client/src/components/BookCertificate.tsx":{"content":"import { useRef, useEffect, useMemo, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Download, Share2, Check, Clipboard, Award, Sparkles, BookOpen } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { getTypingPerformanceRating, triggerCelebration } from \"@/lib/share-utils\";\n\ninterface BookCertificateProps {\n  wpm: number;\n  accuracy: number;\n  consistency: number;\n  bookTitle: string;\n  author: string;\n  chapter?: number;\n  chapterTitle?: string;\n  paragraphsCompleted: number;\n  wordsTyped: number;\n  duration: number;\n  username?: string;\n  date?: Date;\n  difficulty?: string;\n}\n\ninterface TierVisuals {\n  primaryColor: string;\n  secondaryColor: string;\n  glowColor: string;\n  borderGradient: [string, string, string];\n  sealColor: string;\n}\n\nconst TIER_VISUALS: Record<string, TierVisuals> = {\n  Diamond: {\n    primaryColor: \"#00d4ff\",\n    secondaryColor: \"#9be7ff\",\n    glowColor: \"rgba(0, 212, 255, 0.5)\",\n    borderGradient: [\"#00d4ff\", \"#9be7ff\", \"#00d4ff\"],\n    sealColor: \"#00d4ff\",\n  },\n  Platinum: {\n    primaryColor: \"#c0c0c0\",\n    secondaryColor: \"#e8e8e8\",\n    glowColor: \"rgba(192, 192, 192, 0.5)\",\n    borderGradient: [\"#a0a0a0\", \"#e8e8e8\", \"#a0a0a0\"],\n    sealColor: \"#c0c0c0\",\n  },\n  Gold: {\n    primaryColor: \"#ffd700\",\n    secondaryColor: \"#ffed4a\",\n    glowColor: \"rgba(255, 215, 0, 0.5)\",\n    borderGradient: [\"#b8860b\", \"#ffd700\", \"#b8860b\"],\n    sealColor: \"#ffd700\",\n  },\n  Silver: {\n    primaryColor: \"#a8a8a8\",\n    secondaryColor: \"#d4d4d4\",\n    glowColor: \"rgba(168, 168, 168, 0.5)\",\n    borderGradient: [\"#808080\", \"#d4d4d4\", \"#808080\"],\n    sealColor: \"#a8a8a8\",\n  },\n  Bronze: {\n    primaryColor: \"#cd7f32\",\n    secondaryColor: \"#daa06d\",\n    glowColor: \"rgba(205, 127, 50, 0.5)\",\n    borderGradient: [\"#8b4513\", \"#cd7f32\", \"#8b4513\"],\n    sealColor: \"#cd7f32\",\n  },\n};\n\nexport function BookCertificate({\n  wpm,\n  accuracy,\n  consistency,\n  bookTitle,\n  author,\n  chapter,\n  chapterTitle,\n  paragraphsCompleted,\n  wordsTyped,\n  duration,\n  username,\n  date = new Date(),\n  difficulty = \"medium\",\n}: BookCertificateProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [isSharing, setIsSharing] = useState(false);\n  const [imageCopied, setImageCopied] = useState(false);\n  const { toast } = useToast();\n\n  const rating = getTypingPerformanceRating(wpm, accuracy);\n  const tierVisuals = TIER_VISUALS[rating.badge] || TIER_VISUALS.Bronze;\n\n  const certificateId = useMemo(() => {\n    const data = `${wpm}-${accuracy}-${consistency}-${bookTitle}-${wordsTyped}-${duration}`;\n    let hash = 0;\n    for (let i = 0; i < data.length; i++) {\n      const char = data.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash;\n    }\n    const chars = \"ABCDEFGHJKLMNPQRSTUVWXYZ23456789\";\n    let id = \"TM-BOOK-\";\n    const absHash = Math.abs(hash);\n    for (let i = 0; i < 8; i++) {\n      id += chars[(absHash >> (i * 4)) % chars.length];\n    }\n    return id;\n  }, [wpm, accuracy, consistency, bookTitle, wordsTyped, duration]);\n\n  useEffect(() => {\n    generateCertificate();\n  }, [wpm, accuracy, consistency, bookTitle, author, chapter, chapterTitle, paragraphsCompleted, wordsTyped, duration, username]);\n\n  const generateCertificate = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const ctx = canvas.getContext(\"2d\");\n    if (!ctx) return;\n\n    const displayName = username || \"Book Enthusiast\";\n\n    canvas.width = 1200;\n    canvas.height = 675;\n\n    // Premium dark gradient background with book theme\n    const bgGradient = ctx.createRadialGradient(\n      canvas.width / 2, canvas.height / 2, 0,\n      canvas.width / 2, canvas.height / 2, canvas.width * 0.7\n    );\n    bgGradient.addColorStop(0, \"#1a1a2e\");\n    bgGradient.addColorStop(0.5, \"#2e1a1a\");\n    bgGradient.addColorStop(1, \"#0f0f23\");\n    ctx.fillStyle = bgGradient;\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n\n    // Subtle book-themed pattern overlay\n    ctx.globalAlpha = 0.03;\n    for (let i = 0; i < canvas.width; i += 50) {\n      for (let j = 0; j < canvas.height; j += 50) {\n        if ((i + j) % 100 === 0) {\n          ctx.fillStyle = tierVisuals.primaryColor;\n          ctx.font = \"20px serif\";\n          ctx.fillText(\"ðŸ“–\", i, j);\n        }\n      }\n    }\n    ctx.globalAlpha = 1;\n\n    // Elegant outer border with tier color\n    const borderWidth = 6;\n    const borderGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);\n    borderGradient.addColorStop(0, tierVisuals.borderGradient[0]);\n    borderGradient.addColorStop(0.5, tierVisuals.borderGradient[1]);\n    borderGradient.addColorStop(1, tierVisuals.borderGradient[2]);\n    \n    ctx.strokeStyle = borderGradient;\n    ctx.lineWidth = borderWidth;\n    ctx.strokeRect(borderWidth / 2, borderWidth / 2, canvas.width - borderWidth, canvas.height - borderWidth);\n\n    // Inner decorative border\n    ctx.strokeStyle = \"rgba(255, 255, 255, 0.08)\";\n    ctx.lineWidth = 1;\n    ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);\n\n    // Corner decorations\n    const cornerSize = 35;\n    const cornerOffset = 15;\n    ctx.strokeStyle = tierVisuals.primaryColor;\n    ctx.lineWidth = 2;\n    \n    // Top-left\n    ctx.beginPath();\n    ctx.moveTo(cornerOffset, cornerOffset + cornerSize);\n    ctx.lineTo(cornerOffset, cornerOffset);\n    ctx.lineTo(cornerOffset + cornerSize, cornerOffset);\n    ctx.stroke();\n    \n    // Top-right\n    ctx.beginPath();\n    ctx.moveTo(canvas.width - cornerOffset - cornerSize, cornerOffset);\n    ctx.lineTo(canvas.width - cornerOffset, cornerOffset);\n    ctx.lineTo(canvas.width - cornerOffset, cornerOffset + cornerSize);\n    ctx.stroke();\n    \n    // Bottom-left\n    ctx.beginPath();\n    ctx.moveTo(cornerOffset, canvas.height - cornerOffset - cornerSize);\n    ctx.lineTo(cornerOffset, canvas.height - cornerOffset);\n    ctx.lineTo(cornerOffset + cornerSize, canvas.height - cornerOffset);\n    ctx.stroke();\n    \n    // Bottom-right\n    ctx.beginPath();\n    ctx.moveTo(canvas.width - cornerOffset - cornerSize, canvas.height - cornerOffset);\n    ctx.lineTo(canvas.width - cornerOffset, canvas.height - cornerOffset);\n    ctx.lineTo(canvas.width - cornerOffset, canvas.height - cornerOffset - cornerSize);\n    ctx.stroke();\n\n    // Header: ðŸ“š LITERARY TYPING CERTIFICATE\n    ctx.fillStyle = tierVisuals.primaryColor;\n    ctx.font = \"bold 28px serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"ðŸ“š\", canvas.width / 2 - 200, 65);\n    \n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 28px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"LITERARY TYPING CERTIFICATE\", canvas.width / 2 + 30, 68);\n\n    // Decorative line under header\n    const lineWidth = 500;\n    const lineY = 90;\n    const lineGradient = ctx.createLinearGradient(\n      canvas.width / 2 - lineWidth / 2, lineY,\n      canvas.width / 2 + lineWidth / 2, lineY\n    );\n    lineGradient.addColorStop(0, \"transparent\");\n    lineGradient.addColorStop(0.2, tierVisuals.primaryColor);\n    lineGradient.addColorStop(0.5, tierVisuals.secondaryColor);\n    lineGradient.addColorStop(0.8, tierVisuals.primaryColor);\n    lineGradient.addColorStop(1, \"transparent\");\n    \n    ctx.strokeStyle = lineGradient;\n    ctx.lineWidth = 2;\n    ctx.beginPath();\n    ctx.moveTo(canvas.width / 2 - lineWidth / 2, lineY);\n    ctx.lineTo(canvas.width / 2 + lineWidth / 2, lineY);\n    ctx.stroke();\n\n    // \"This certifies that\"\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.7)\";\n    ctx.font = \"italic 20px 'DM Sans', system-ui, sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"This certifies that\", canvas.width / 2, 130);\n\n    // User Name - Large and prominent with glow\n    ctx.save();\n    ctx.shadowColor = tierVisuals.glowColor;\n    ctx.shadowBlur = 30;\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 48px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(displayName, canvas.width / 2, 175);\n    ctx.restore();\n\n    // \"has successfully completed\"\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.7)\";\n    ctx.font = \"italic 18px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"has successfully completed\", canvas.width / 2, 210);\n\n    // Book title - Bold and prominent\n    const maxBookTitleLength = 50;\n    const truncatedTitle = bookTitle.length > maxBookTitleLength \n      ? bookTitle.substring(0, maxBookTitleLength) + \"...\"\n      : bookTitle;\n    \n    ctx.fillStyle = tierVisuals.primaryColor;\n    ctx.font = \"bold 24px serif\";\n    ctx.fillText(`\"${truncatedTitle}\"`, canvas.width / 2, 245);\n\n    // Author\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.8)\";\n    ctx.font = \"italic 18px serif\";\n    ctx.fillText(`by ${author}`, canvas.width / 2, 275);\n\n    // Chapter info (if applicable)\n    if (chapter && chapterTitle) {\n      ctx.fillStyle = tierVisuals.secondaryColor;\n      ctx.font = \"16px 'DM Sans', system-ui, sans-serif\";\n      ctx.fillText(`Chapter ${chapter}: ${chapterTitle}`, canvas.width / 2, 300);\n    } else if (chapter) {\n      ctx.fillStyle = tierVisuals.secondaryColor;\n      ctx.font = \"16px 'DM Sans', system-ui, sans-serif\";\n      ctx.fillText(`Chapter ${chapter}`, canvas.width / 2, 300);\n    }\n\n    // Stats box background\n    const statsBoxX = 150;\n    const statsBoxY = 330;\n    const statsBoxWidth = 900;\n    const statsBoxHeight = 110;\n    \n    ctx.fillStyle = \"rgba(255, 255, 255, 0.03)\";\n    ctx.beginPath();\n    ctx.roundRect(statsBoxX, statsBoxY, statsBoxWidth, statsBoxHeight, 12);\n    ctx.fill();\n    \n    ctx.strokeStyle = \"rgba(255, 255, 255, 0.1)\";\n    ctx.lineWidth = 1;\n    ctx.beginPath();\n    ctx.roundRect(statsBoxX, statsBoxY, statsBoxWidth, statsBoxHeight, 12);\n    ctx.stroke();\n\n    // Stats Row: WPM | Accuracy | Words | Duration\n    const rowY = statsBoxY + 45;\n    const statsStartX = statsBoxX + 100;\n    const statSpacing = 220;\n\n    // WPM\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 36px 'JetBrains Mono', monospace\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(`${wpm}`, statsStartX, rowY);\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"12px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"WPM\", statsStartX, rowY + 22);\n\n    // Divider\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.2)\";\n    ctx.fillText(\"|\", statsStartX + statSpacing / 2, rowY);\n\n    // Accuracy\n    ctx.fillStyle = \"#4ade80\";\n    ctx.font = \"bold 36px 'JetBrains Mono', monospace\";\n    ctx.fillText(`${accuracy}%`, statsStartX + statSpacing, rowY);\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"12px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"ACCURACY\", statsStartX + statSpacing, rowY + 22);\n\n    // Divider\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.2)\";\n    ctx.fillText(\"|\", statsStartX + statSpacing * 1.5, rowY);\n\n    // Words Typed\n    ctx.fillStyle = \"#c084fc\";\n    ctx.font = \"bold 36px 'JetBrains Mono', monospace\";\n    ctx.fillText(`${wordsTyped}`, statsStartX + statSpacing * 2, rowY);\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"12px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"WORDS\", statsStartX + statSpacing * 2, rowY + 22);\n\n    // Divider\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.2)\";\n    ctx.fillText(\"|\", statsStartX + statSpacing * 2.5, rowY);\n\n    // Duration\n    const formatDuration = (seconds: number) => {\n      const mins = Math.floor(seconds / 60);\n      const secs = seconds % 60;\n      return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;\n    };\n    ctx.fillStyle = \"#22d3ee\";\n    ctx.font = \"bold 28px 'JetBrains Mono', monospace\";\n    ctx.fillText(formatDuration(duration), statsStartX + statSpacing * 3, rowY);\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"12px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"TIME\", statsStartX + statSpacing * 3, rowY + 22);\n\n    // Additional stats below\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.6)\";\n    ctx.font = \"14px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(`${paragraphsCompleted} paragraph${paragraphsCompleted !== 1 ? 's' : ''} completed  â€¢  ${consistency}% consistency  â€¢  ${difficulty} difficulty`, canvas.width / 2, statsBoxY + statsBoxHeight + 35);\n\n    // Performance tier badge (on right side)\n    const badgeX = canvas.width - 100;\n    const badgeY = statsBoxY + statsBoxHeight / 2;\n    const badgeRadius = 35;\n    \n    ctx.save();\n    ctx.shadowColor = tierVisuals.glowColor;\n    ctx.shadowBlur = 15;\n    \n    const badgeGradient = ctx.createRadialGradient(badgeX, badgeY, 0, badgeX, badgeY, badgeRadius);\n    badgeGradient.addColorStop(0, tierVisuals.secondaryColor);\n    badgeGradient.addColorStop(0.7, tierVisuals.primaryColor);\n    badgeGradient.addColorStop(1, tierVisuals.borderGradient[0]);\n    \n    ctx.fillStyle = badgeGradient;\n    ctx.beginPath();\n    ctx.arc(badgeX, badgeY, badgeRadius, 0, Math.PI * 2);\n    ctx.fill();\n    \n    ctx.fillStyle = \"#1a1a2e\";\n    ctx.beginPath();\n    ctx.arc(badgeX, badgeY, badgeRadius - 6, 0, Math.PI * 2);\n    ctx.fill();\n    \n    ctx.restore();\n    \n    ctx.fillStyle = tierVisuals.primaryColor;\n    ctx.font = \"bold 12px 'DM Sans', system-ui, sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(rating.badge.toUpperCase(), badgeX, badgeY - 2);\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"9px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"TIER\", badgeX, badgeY + 12);\n\n    // Earned on date\n    const formattedDate = date.toLocaleDateString('en-GB', { \n      day: '2-digit', \n      month: '2-digit', \n      year: 'numeric' \n    });\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.7)\";\n    ctx.font = \"16px 'DM Sans', system-ui, sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(`Completed on: ${formattedDate}`, canvas.width / 2, 520);\n\n    // Motivational quote\n    ctx.fillStyle = tierVisuals.primaryColor;\n    ctx.font = \"italic 22px serif\";\n    ctx.fillText(`\"${rating.title}\"`, canvas.width / 2, 560);\n\n    // Signature section\n    const sigY = 610;\n    \n    // Signature line\n    ctx.strokeStyle = \"rgba(255, 255, 255, 0.3)\";\n    ctx.lineWidth = 1;\n    ctx.beginPath();\n    ctx.moveTo(canvas.width / 2 - 150, sigY);\n    ctx.lineTo(canvas.width / 2 + 150, sigY);\n    ctx.stroke();\n\n    // AI Coach signature\n    ctx.fillStyle = tierVisuals.primaryColor;\n    ctx.font = \"italic 18px serif\";\n    ctx.fillText(\"TypeMasterAI Literary Coach\", canvas.width / 2, sigY - 10);\n    \n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"11px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"AI Reading & Typing Coach â€¢ Certification Authority\", canvas.width / 2, sigY + 18);\n\n    // Footer with certificate ID and URL\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.4)\";\n    ctx.font = \"10px 'JetBrains Mono', monospace\";\n    ctx.textAlign = \"left\";\n    ctx.fillText(`ID: ${certificateId}`, 50, canvas.height - 25);\n\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"typemasterai.com/book-mode\", canvas.width / 2, canvas.height - 25);\n\n    ctx.textAlign = \"right\";\n    ctx.fillStyle = tierVisuals.primaryColor;\n    ctx.font = \"bold 10px 'JetBrains Mono', monospace\";\n    ctx.fillText(`${rating.emoji} ${rating.badge} CERTIFIED`, canvas.width - 50, canvas.height - 25);\n  };\n\n  const downloadCertificate = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const link = document.createElement(\"a\");\n    const safeBookTitle = bookTitle.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30);\n    link.download = `TypeMasterAI_Book_Certificate_${safeBookTitle}_${wpm}WPM_${certificateId}.png`;\n    link.href = canvas.toDataURL(\"image/png\");\n    link.click();\n    \n    triggerCelebration('medium');\n    \n    toast({\n      title: \"Certificate Downloaded!\",\n      description: \"Share your literary achievement!\",\n    });\n  };\n\n  const shareCertificate = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    setIsSharing(true);\n    try {\n      const blob = await new Promise<Blob>((resolve, reject) => {\n        canvas.toBlob((blob) => {\n          if (blob) resolve(blob);\n          else reject(new Error(\"Failed to create blob\"));\n        }, \"image/png\");\n      });\n\n      const file = new File([blob], `TypeMasterAI_Book_Certificate_${wpm}WPM.png`, { type: \"image/png\" });\n\n      if ('share' in navigator && navigator.canShare?.({ files: [file] })) {\n        await navigator.share({\n          title: `TypeMasterAI Book Typing Certificate - ${bookTitle}`,\n          text: `${rating.emoji} I earned a ${rating.badge} Certificate reading \"${bookTitle}\" by ${author} at ${wpm} WPM!\\n\\nðŸ… ${rating.title}\\nðŸ“– ${wordsTyped} words typed\\nðŸ“œ Certificate: ${certificateId}\\n\\nðŸ”— typemasterai.com/book-mode`,\n          files: [file],\n        });\n        triggerCelebration('medium');\n        toast({\n          title: \"Certificate Shared!\",\n          description: \"Your literary achievement is on its way!\",\n        });\n      } else {\n        downloadCertificate();\n      }\n    } catch (error: any) {\n      if (error.name !== 'AbortError') {\n        downloadCertificate();\n      }\n    } finally {\n      setIsSharing(false);\n    }\n  };\n\n  const copyImageToClipboard = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    try {\n      const blob = await new Promise<Blob>((resolve, reject) => {\n        canvas.toBlob((blob) => {\n          if (blob) resolve(blob);\n          else reject(new Error(\"Failed to create blob\"));\n        }, \"image/png\");\n      });\n\n      await navigator.clipboard.write([\n        new ClipboardItem({ \"image/png\": blob })\n      ]);\n      \n      setImageCopied(true);\n      setTimeout(() => setImageCopied(false), 2000);\n      triggerCelebration('small');\n      \n      toast({\n        title: \"Certificate Copied!\",\n        description: \"Paste directly into social media!\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Copy Failed\",\n        description: \"Your browser doesn't support image copying. Please download instead.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  return (\n    <div className=\"flex flex-col items-center gap-4\">\n      <div className=\"relative w-full overflow-hidden rounded-xl shadow-2xl\" data-testid=\"book-certificate-container\" style={{ boxShadow: `0 25px 50px -12px ${tierVisuals.glowColor}` }}>\n        <canvas\n          ref={canvasRef}\n          className=\"w-full h-auto\"\n          style={{ maxWidth: \"100%\" }}\n          data-testid=\"book-certificate-canvas\"\n        />\n        <div className=\"absolute top-3 left-3 flex items-center gap-1.5 px-3 py-1.5 bg-black/60 rounded-full backdrop-blur-sm border border-white/10\">\n          <Award className=\"w-3.5 h-3.5\" style={{ color: tierVisuals.primaryColor }} />\n          <span className=\"text-[10px] font-semibold uppercase tracking-wider\" style={{ color: tierVisuals.primaryColor }}>\n            {rating.badge} Tier\n          </span>\n        </div>\n      </div>\n      \n      <div className=\"w-full space-y-3\">\n        <div className=\"p-4 bg-gradient-to-br from-zinc-900 via-zinc-800 to-zinc-900 rounded-xl border border-zinc-700\">\n          <div className=\"flex items-center justify-center gap-2 mb-3\">\n            <Sparkles className=\"w-4 h-4\" style={{ color: tierVisuals.primaryColor }} />\n            <p className=\"text-sm font-medium\" style={{ color: tierVisuals.primaryColor }}>Share Your Literary Achievement</p>\n            <Sparkles className=\"w-4 h-4\" style={{ color: tierVisuals.primaryColor }} />\n          </div>\n          <div className=\"grid grid-cols-2 gap-3\">\n            <Button\n              onClick={copyImageToClipboard}\n              variant=\"outline\"\n              className=\"gap-2 h-10 bg-zinc-800/50 border-zinc-600 hover:bg-zinc-700/50 hover:border-zinc-500\"\n              data-testid=\"button-copy-book-certificate\"\n            >\n              {imageCopied ? <Check className=\"w-4 h-4 text-green-500\" /> : <Clipboard className=\"w-4 h-4\" style={{ color: tierVisuals.primaryColor }} />}\n              <span className=\"text-zinc-200\">{imageCopied ? \"Copied!\" : \"Copy Image\"}</span>\n            </Button>\n            <Button\n              onClick={downloadCertificate}\n              variant=\"outline\"\n              className=\"gap-2 h-10 bg-zinc-800/50 border-zinc-600 hover:bg-zinc-700/50 hover:border-zinc-500\"\n              data-testid=\"button-download-book-certificate\"\n            >\n              <Download className=\"w-4 h-4 text-purple-400\" />\n              <span className=\"text-zinc-200\">Download</span>\n            </Button>\n          </div>\n        </div>\n\n        {'share' in navigator && (\n          <Button\n            onClick={shareCertificate}\n            disabled={isSharing}\n            className=\"w-full gap-2 h-11 text-white font-semibold\"\n            style={{ \n              background: `linear-gradient(135deg, ${tierVisuals.borderGradient[0]}, ${tierVisuals.primaryColor}, ${tierVisuals.borderGradient[2]})`,\n            }}\n            data-testid=\"button-share-book-certificate\"\n          >\n            <Share2 className=\"w-4 h-4\" />\n            {isSharing ? \"Sharing...\" : \"Share Certificate\"}\n          </Button>\n        )}\n        \n        <p className=\"text-[10px] text-center text-zinc-500\" data-testid=\"text-book-certificate-id\">\n          Certificate ID: <span className=\"font-mono\" style={{ color: tierVisuals.primaryColor }}>{certificateId}</span>\n        </p>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":21269,"size_tokens":null},"client/src/components/RaceCertificate.tsx":{"content":"import { useRef, useEffect, useMemo, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Download, Share2, Check, Clipboard, Award, Sparkles, Trophy, Medal, Crown } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { getTypingPerformanceRating, triggerCelebration } from \"@/lib/share-utils\";\n\ninterface RaceCertificateProps {\n  wpm: number;\n  accuracy: number;\n  consistency: number;\n  placement: number;\n  totalParticipants: number;\n  characters: number;\n  errors: number;\n  duration: number;\n  username?: string;\n  date?: Date;\n  raceId?: string;\n}\n\ninterface TierVisuals {\n  primaryColor: string;\n  secondaryColor: string;\n  glowColor: string;\n  borderGradient: [string, string, string];\n  sealColor: string;\n}\n\nconst TIER_VISUALS: Record<string, TierVisuals> = {\n  Diamond: {\n    primaryColor: \"#00d4ff\",\n    secondaryColor: \"#9be7ff\",\n    glowColor: \"rgba(0, 212, 255, 0.5)\",\n    borderGradient: [\"#00d4ff\", \"#9be7ff\", \"#00d4ff\"],\n    sealColor: \"#00d4ff\",\n  },\n  Platinum: {\n    primaryColor: \"#c0c0c0\",\n    secondaryColor: \"#e8e8e8\",\n    glowColor: \"rgba(192, 192, 192, 0.5)\",\n    borderGradient: [\"#a0a0a0\", \"#e8e8e8\", \"#a0a0a0\"],\n    sealColor: \"#c0c0c0\",\n  },\n  Gold: {\n    primaryColor: \"#ffd700\",\n    secondaryColor: \"#ffed4a\",\n    glowColor: \"rgba(255, 215, 0, 0.5)\",\n    borderGradient: [\"#b8860b\", \"#ffd700\", \"#b8860b\"],\n    sealColor: \"#ffd700\",\n  },\n  Silver: {\n    primaryColor: \"#a8a8a8\",\n    secondaryColor: \"#d4d4d4\",\n    glowColor: \"rgba(168, 168, 168, 0.5)\",\n    borderGradient: [\"#808080\", \"#d4d4d4\", \"#808080\"],\n    sealColor: \"#a8a8a8\",\n  },\n  Bronze: {\n    primaryColor: \"#cd7f32\",\n    secondaryColor: \"#daa06d\",\n    glowColor: \"rgba(205, 127, 50, 0.5)\",\n    borderGradient: [\"#8b4513\", \"#cd7f32\", \"#8b4513\"],\n    sealColor: \"#cd7f32\",\n  },\n};\n\nconst PLACEMENT_VISUALS: Record<number, { emoji: string; text: string; color: string }> = {\n  1: { emoji: \"ðŸ¥‡\", text: \"1ST PLACE\", color: \"#ffd700\" },\n  2: { emoji: \"ðŸ¥ˆ\", text: \"2ND PLACE\", color: \"#c0c0c0\" },\n  3: { emoji: \"ðŸ¥‰\", text: \"3RD PLACE\", color: \"#cd7f32\" },\n};\n\nexport function RaceCertificate({\n  wpm,\n  accuracy,\n  consistency,\n  placement,\n  totalParticipants,\n  characters,\n  errors,\n  duration,\n  username,\n  date = new Date(),\n  raceId,\n}: RaceCertificateProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [isSharing, setIsSharing] = useState(false);\n  const [imageCopied, setImageCopied] = useState(false);\n  const { toast } = useToast();\n\n  const rating = getTypingPerformanceRating(wpm, accuracy);\n  const tierVisuals = TIER_VISUALS[rating.badge] || TIER_VISUALS.Bronze;\n  const placementVisuals = PLACEMENT_VISUALS[placement] || { \n    emoji: \"ðŸ\", \n    text: `${placement}${placement === 1 ? 'ST' : placement === 2 ? 'ND' : placement === 3 ? 'RD' : 'TH'} PLACE`, \n    color: \"#94a3b8\" \n  };\n\n  const certificateId = useMemo(() => {\n    const data = `${wpm}-${accuracy}-${placement}-${totalParticipants}-${characters}-${duration}${raceId || ''}`;\n    let hash = 0;\n    for (let i = 0; i < data.length; i++) {\n      const char = data.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash;\n    }\n    const chars = \"ABCDEFGHJKLMNPQRSTUVWXYZ23456789\";\n    let id = \"TM-RACE-\";\n    const absHash = Math.abs(hash);\n    for (let i = 0; i < 8; i++) {\n      id += chars[(absHash >> (i * 4)) % chars.length];\n    }\n    return id;\n  }, [wpm, accuracy, placement, totalParticipants, characters, duration, raceId]);\n\n  useEffect(() => {\n    generateCertificate();\n  }, [wpm, accuracy, consistency, placement, totalParticipants, characters, errors, duration, username]);\n\n  const generateCertificate = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const ctx = canvas.getContext(\"2d\");\n    if (!ctx) return;\n\n    const displayName = username || \"Racer\";\n\n    canvas.width = 1200;\n    canvas.height = 675;\n\n    // Dynamic background based on placement\n    const bgGradient = ctx.createRadialGradient(\n      canvas.width / 2, canvas.height / 2, 0,\n      canvas.width / 2, canvas.height / 2, canvas.width * 0.7\n    );\n    \n    if (placement === 1) {\n      bgGradient.addColorStop(0, \"#2a1a1a\");\n      bgGradient.addColorStop(0.5, \"#1e1a0e\");\n      bgGradient.addColorStop(1, \"#0f0f23\");\n    } else if (placement === 2) {\n      bgGradient.addColorStop(0, \"#1a1a2a\");\n      bgGradient.addColorStop(0.5, \"#1a1a1e\");\n      bgGradient.addColorStop(1, \"#0f0f23\");\n    } else if (placement === 3) {\n      bgGradient.addColorStop(0, \"#2a1a1a\");\n      bgGradient.addColorStop(0.5, \"#1e1616\");\n      bgGradient.addColorStop(1, \"#0f0f23\");\n    } else {\n      bgGradient.addColorStop(0, \"#1a1a2e\");\n      bgGradient.addColorStop(0.5, \"#16213e\");\n      bgGradient.addColorStop(1, \"#0f0f23\");\n    }\n    \n    ctx.fillStyle = bgGradient;\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n\n    // Racing-themed pattern overlay\n    ctx.globalAlpha = 0.02;\n    for (let i = 0; i < canvas.width; i += 60) {\n      for (let j = 0; j < canvas.height; j += 60) {\n        if ((i + j) % 120 === 0) {\n          ctx.fillStyle = placementVisuals.color;\n          ctx.fillText(\"ðŸ\", i, j);\n        }\n      }\n    }\n    ctx.globalAlpha = 1;\n\n    // Elegant outer border with placement color\n    const borderWidth = 6;\n    const borderGradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);\n    borderGradient.addColorStop(0, placementVisuals.color);\n    borderGradient.addColorStop(0.5, tierVisuals.primaryColor);\n    borderGradient.addColorStop(1, placementVisuals.color);\n    \n    ctx.strokeStyle = borderGradient;\n    ctx.lineWidth = borderWidth;\n    ctx.strokeRect(borderWidth / 2, borderWidth / 2, canvas.width - borderWidth, canvas.height - borderWidth);\n\n    // Inner decorative border\n    ctx.strokeStyle = \"rgba(255, 255, 255, 0.08)\";\n    ctx.lineWidth = 1;\n    ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);\n\n    // Corner decorations\n    const cornerSize = 35;\n    const cornerOffset = 15;\n    ctx.strokeStyle = placementVisuals.color;\n    ctx.lineWidth = 2;\n    \n    // Top-left\n    ctx.beginPath();\n    ctx.moveTo(cornerOffset, cornerOffset + cornerSize);\n    ctx.lineTo(cornerOffset, cornerOffset);\n    ctx.lineTo(cornerOffset + cornerSize, cornerOffset);\n    ctx.stroke();\n    \n    // Top-right\n    ctx.beginPath();\n    ctx.moveTo(canvas.width - cornerOffset - cornerSize, cornerOffset);\n    ctx.lineTo(canvas.width - cornerOffset, cornerOffset);\n    ctx.lineTo(canvas.width - cornerOffset, cornerOffset + cornerSize);\n    ctx.stroke();\n    \n    // Bottom-left\n    ctx.beginPath();\n    ctx.moveTo(cornerOffset, canvas.height - cornerOffset - cornerSize);\n    ctx.lineTo(cornerOffset, canvas.height - cornerOffset);\n    ctx.lineTo(cornerOffset + cornerSize, canvas.height - cornerOffset);\n    ctx.stroke();\n    \n    // Bottom-right\n    ctx.beginPath();\n    ctx.moveTo(canvas.width - cornerOffset - cornerSize, canvas.height - cornerOffset);\n    ctx.lineTo(canvas.width - cornerOffset, canvas.height - cornerOffset);\n    ctx.lineTo(canvas.width - cornerOffset, canvas.height - cornerOffset - cornerSize);\n    ctx.stroke();\n\n    // Header: ðŸ MULTIPLAYER RACE CERTIFICATE\n    ctx.fillStyle = placementVisuals.color;\n    ctx.font = \"bold 32px 'JetBrains Mono', monospace\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"ðŸ\", canvas.width / 2 - 220, 65);\n    \n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 28px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"MULTIPLAYER RACE CERTIFICATE\", canvas.width / 2 + 40, 68);\n\n    // Decorative line under header\n    const lineWidth = 500;\n    const lineY = 90;\n    const lineGradient = ctx.createLinearGradient(\n      canvas.width / 2 - lineWidth / 2, lineY,\n      canvas.width / 2 + lineWidth / 2, lineY\n    );\n    lineGradient.addColorStop(0, \"transparent\");\n    lineGradient.addColorStop(0.2, placementVisuals.color);\n    lineGradient.addColorStop(0.5, tierVisuals.primaryColor);\n    lineGradient.addColorStop(0.8, placementVisuals.color);\n    lineGradient.addColorStop(1, \"transparent\");\n    \n    ctx.strokeStyle = lineGradient;\n    ctx.lineWidth = 2;\n    ctx.beginPath();\n    ctx.moveTo(canvas.width / 2 - lineWidth / 2, lineY);\n    ctx.lineTo(canvas.width / 2 + lineWidth / 2, lineY);\n    ctx.stroke();\n\n    // \"This certifies that\"\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.7)\";\n    ctx.font = \"italic 20px 'DM Sans', system-ui, sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"This certifies that\", canvas.width / 2, 135);\n\n    // User Name - Large and prominent with glow\n    ctx.save();\n    ctx.shadowColor = placement <= 3 ? placementVisuals.color : tierVisuals.glowColor;\n    ctx.shadowBlur = 30;\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 48px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(displayName, canvas.width / 2, 185);\n    ctx.restore();\n\n    // Placement badge - HUGE and prominent\n    ctx.save();\n    ctx.shadowColor = placementVisuals.color;\n    ctx.shadowBlur = 40;\n    ctx.fillStyle = placementVisuals.color;\n    ctx.font = \"bold 64px 'JetBrains Mono', monospace\";\n    ctx.fillText(placementVisuals.emoji, canvas.width / 2 - 100, 255);\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 36px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(placementVisuals.text, canvas.width / 2 + 40, 255);\n    ctx.restore();\n\n    // \"in a multiplayer race against\"\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.7)\";\n    ctx.font = \"italic 18px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(`in a competitive race against ${totalParticipants - 1} other ${totalParticipants - 1 === 1 ? 'opponent' : 'opponents'}`, canvas.width / 2, 295);\n\n    // Stats box background\n    const statsBoxX = 150;\n    const statsBoxY = 320;\n    const statsBoxWidth = 900;\n    const statsBoxHeight = 110;\n    \n    ctx.fillStyle = \"rgba(255, 255, 255, 0.03)\";\n    ctx.beginPath();\n    ctx.roundRect(statsBoxX, statsBoxY, statsBoxWidth, statsBoxHeight, 12);\n    ctx.fill();\n    \n    ctx.strokeStyle = \"rgba(255, 255, 255, 0.1)\";\n    ctx.lineWidth = 1;\n    ctx.beginPath();\n    ctx.roundRect(statsBoxX, statsBoxY, statsBoxWidth, statsBoxHeight, 12);\n    ctx.stroke();\n\n    // Stats Row: WPM | Accuracy | Characters | Duration\n    const rowY = statsBoxY + 45;\n    const statsStartX = statsBoxX + 100;\n    const statSpacing = 220;\n\n    // WPM\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"bold 36px 'JetBrains Mono', monospace\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(`${wpm}`, statsStartX, rowY);\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"12px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"WPM\", statsStartX, rowY + 22);\n\n    // Divider\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.2)\";\n    ctx.fillText(\"|\", statsStartX + statSpacing / 2, rowY);\n\n    // Accuracy\n    ctx.fillStyle = \"#4ade80\";\n    ctx.font = \"bold 36px 'JetBrains Mono', monospace\";\n    ctx.fillText(`${accuracy}%`, statsStartX + statSpacing, rowY);\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"12px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"ACCURACY\", statsStartX + statSpacing, rowY + 22);\n\n    // Divider\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.2)\";\n    ctx.fillText(\"|\", statsStartX + statSpacing * 1.5, rowY);\n\n    // Characters\n    ctx.fillStyle = \"#c084fc\";\n    ctx.font = \"bold 36px 'JetBrains Mono', monospace\";\n    ctx.fillText(`${characters}`, statsStartX + statSpacing * 2, rowY);\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"12px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"CHARS\", statsStartX + statSpacing * 2, rowY + 22);\n\n    // Divider\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.2)\";\n    ctx.fillText(\"|\", statsStartX + statSpacing * 2.5, rowY);\n\n    // Duration\n    const formatDuration = (seconds: number) => {\n      const mins = Math.floor(seconds / 60);\n      const secs = seconds % 60;\n      return mins > 0 ? `${mins}:${secs.toString().padStart(2, '0')}` : `${secs}s`;\n    };\n    ctx.fillStyle = \"#22d3ee\";\n    ctx.font = \"bold 32px 'JetBrains Mono', monospace\";\n    ctx.fillText(formatDuration(duration), statsStartX + statSpacing * 3, rowY);\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"12px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"TIME\", statsStartX + statSpacing * 3, rowY + 22);\n\n    // Additional stats below\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.6)\";\n    ctx.font = \"14px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(`${errors} error${errors !== 1 ? 's' : ''}  â€¢  ${consistency}% consistency  â€¢  Victory against ${totalParticipants - 1} ${totalParticipants - 1 === 1 ? 'opponent' : 'opponents'}`, canvas.width / 2, statsBoxY + statsBoxHeight + 35);\n\n    // Performance tier badge (on right side)\n    const badgeX = canvas.width - 100;\n    const badgeY = statsBoxY + statsBoxHeight / 2;\n    const badgeRadius = 35;\n    \n    ctx.save();\n    ctx.shadowColor = tierVisuals.glowColor;\n    ctx.shadowBlur = 15;\n    \n    const badgeGradient = ctx.createRadialGradient(badgeX, badgeY, 0, badgeX, badgeY, badgeRadius);\n    badgeGradient.addColorStop(0, tierVisuals.secondaryColor);\n    badgeGradient.addColorStop(0.7, tierVisuals.primaryColor);\n    badgeGradient.addColorStop(1, tierVisuals.borderGradient[0]);\n    \n    ctx.fillStyle = badgeGradient;\n    ctx.beginPath();\n    ctx.arc(badgeX, badgeY, badgeRadius, 0, Math.PI * 2);\n    ctx.fill();\n    \n    ctx.fillStyle = \"#1a1a2e\";\n    ctx.beginPath();\n    ctx.arc(badgeX, badgeY, badgeRadius - 6, 0, Math.PI * 2);\n    ctx.fill();\n    \n    ctx.restore();\n    \n    ctx.fillStyle = tierVisuals.primaryColor;\n    ctx.font = \"bold 12px 'DM Sans', system-ui, sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(rating.badge.toUpperCase(), badgeX, badgeY - 2);\n    ctx.fillStyle = \"#ffffff\";\n    ctx.font = \"9px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"TIER\", badgeX, badgeY + 12);\n\n    // Earned on date\n    const formattedDate = date.toLocaleDateString('en-GB', { \n      day: '2-digit', \n      month: '2-digit', \n      year: 'numeric' \n    });\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.7)\";\n    ctx.font = \"16px 'DM Sans', system-ui, sans-serif\";\n    ctx.textAlign = \"center\";\n    ctx.fillText(`Completed on: ${formattedDate}`, canvas.width / 2, 520);\n\n    // Victory message based on placement\n    let victoryMessage = rating.title;\n    if (placement === 1) victoryMessage = \"Champion Performance\";\n    else if (placement === 2) victoryMessage = \"Outstanding Runner-Up\";\n    else if (placement === 3) victoryMessage = \"Strong Podium Finish\";\n    \n    ctx.fillStyle = placementVisuals.color;\n    ctx.font = \"italic 22px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(`\"${victoryMessage}\"`, canvas.width / 2, 560);\n\n    // Signature section\n    const sigY = 610;\n    \n    // Signature line\n    ctx.strokeStyle = \"rgba(255, 255, 255, 0.3)\";\n    ctx.lineWidth = 1;\n    ctx.beginPath();\n    ctx.moveTo(canvas.width / 2 - 150, sigY);\n    ctx.lineTo(canvas.width / 2 + 150, sigY);\n    ctx.stroke();\n\n    // AI Coach signature\n    ctx.fillStyle = placementVisuals.color;\n    ctx.font = \"italic 18px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"TypeMasterAI Race Official\", canvas.width / 2, sigY - 10);\n    \n    ctx.fillStyle = \"rgba(255, 255, 255, 0.5)\";\n    ctx.font = \"11px 'DM Sans', system-ui, sans-serif\";\n    ctx.fillText(\"Official Multiplayer Racing Authority\", canvas.width / 2, sigY + 18);\n\n    // Footer with certificate ID and URL\n    ctx.fillStyle = \"rgba(255, 255, 255, 0.4)\";\n    ctx.font = \"10px 'JetBrains Mono', monospace\";\n    ctx.textAlign = \"left\";\n    ctx.fillText(`ID: ${certificateId}`, 50, canvas.height - 25);\n\n    ctx.textAlign = \"center\";\n    ctx.fillText(\"typemasterai.com/multiplayer\", canvas.width / 2, canvas.height - 25);\n\n    ctx.textAlign = \"right\";\n    ctx.fillStyle = placementVisuals.color;\n    ctx.font = \"bold 10px 'JetBrains Mono', monospace\";\n    ctx.fillText(`${placementVisuals.emoji} ${placementVisuals.text}`, canvas.width - 50, canvas.height - 25);\n  };\n\n  const downloadCertificate = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const link = document.createElement(\"a\");\n    link.download = `TypeMasterAI_Race_Certificate_P${placement}_${wpm}WPM_${certificateId}.png`;\n    link.href = canvas.toDataURL(\"image/png\");\n    link.click();\n    \n    triggerCelebration(placement <= 3 ? 'large' : 'medium');\n    \n    toast({\n      title: \"Certificate Downloaded!\",\n      description: \"Share your racing achievement!\",\n    });\n  };\n\n  const shareCertificate = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    setIsSharing(true);\n    try {\n      const blob = await new Promise<Blob>((resolve, reject) => {\n        canvas.toBlob((blob) => {\n          if (blob) resolve(blob);\n          else reject(new Error(\"Failed to create blob\"));\n        }, \"image/png\");\n      });\n\n      const file = new File([blob], `TypeMasterAI_Race_Certificate_${wpm}WPM.png`, { type: \"image/png\" });\n\n      if ('share' in navigator && navigator.canShare?.({ files: [file] })) {\n        await navigator.share({\n          title: `TypeMasterAI Race Certificate - ${placementVisuals.text}`,\n          text: `${placementVisuals.emoji} I finished ${placementVisuals.text} in a multiplayer race!\\n\\nâš¡ ${wpm} WPM with ${accuracy}% accuracy\\nðŸ Beat ${totalParticipants - 1} ${totalParticipants - 1 === 1 ? 'opponent' : 'opponents'}\\nðŸ… ${victoryMessage}\\nðŸ“œ Certificate: ${certificateId}\\n\\nCan you beat my time?\\n\\nðŸ”— typemasterai.com/multiplayer`,\n          files: [file],\n        });\n        triggerCelebration(placement <= 3 ? 'large' : 'medium');\n        toast({\n          title: \"Certificate Shared!\",\n          description: \"Your racing achievement is on its way!\",\n        });\n      } else {\n        downloadCertificate();\n      }\n    } catch (error: any) {\n      if (error.name !== 'AbortError') {\n        downloadCertificate();\n      }\n    } finally {\n      setIsSharing(false);\n    }\n  };\n\n  const copyImageToClipboard = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    try {\n      const blob = await new Promise<Blob>((resolve, reject) => {\n        canvas.toBlob((blob) => {\n          if (blob) resolve(blob);\n          else reject(new Error(\"Failed to create blob\"));\n        }, \"image/png\");\n      });\n\n      await navigator.clipboard.write([\n        new ClipboardItem({ \"image/png\": blob })\n      ]);\n      \n      setImageCopied(true);\n      setTimeout(() => setImageCopied(false), 2000);\n      triggerCelebration('small');\n      \n      toast({\n        title: \"Certificate Copied!\",\n        description: \"Paste directly into social media!\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Copy Failed\",\n        description: \"Your browser doesn't support image copying. Please download instead.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const victoryMessage = placement === 1 ? \"Champion Performance\" : placement === 2 ? \"Outstanding Runner-Up\" : placement === 3 ? \"Strong Podium Finish\" : rating.title;\n\n  return (\n    <div className=\"flex flex-col items-center gap-4\">\n      <div className=\"relative w-full overflow-hidden rounded-xl shadow-2xl\" data-testid=\"race-certificate-container\" style={{ boxShadow: `0 25px 50px -12px ${placementVisuals.color}40` }}>\n        <canvas\n          ref={canvasRef}\n          className=\"w-full h-auto\"\n          style={{ maxWidth: \"100%\" }}\n          data-testid=\"race-certificate-canvas\"\n        />\n        <div className=\"absolute top-3 left-3 flex items-center gap-1.5 px-3 py-1.5 bg-black/60 rounded-full backdrop-blur-sm border border-white/10\">\n          <Trophy className=\"w-3.5 h-3.5\" style={{ color: placementVisuals.color }} />\n          <span className=\"text-[10px] font-semibold uppercase tracking-wider\" style={{ color: placementVisuals.color }}>\n            {placementVisuals.text}\n          </span>\n        </div>\n      </div>\n      \n      <div className=\"w-full space-y-3\">\n        <div className=\"p-4 bg-gradient-to-br from-zinc-900 via-zinc-800 to-zinc-900 rounded-xl border border-zinc-700\">\n          <div className=\"flex items-center justify-center gap-2 mb-3\">\n            <Sparkles className=\"w-4 h-4\" style={{ color: placementVisuals.color }} />\n            <p className=\"text-sm font-medium\" style={{ color: placementVisuals.color }}>Share Your Racing Victory</p>\n            <Sparkles className=\"w-4 h-4\" style={{ color: placementVisuals.color }} />\n          </div>\n          <div className=\"grid grid-cols-2 gap-3\">\n            <Button\n              onClick={copyImageToClipboard}\n              variant=\"outline\"\n              className=\"gap-2 h-10 bg-zinc-800/50 border-zinc-600 hover:bg-zinc-700/50 hover:border-zinc-500\"\n              data-testid=\"button-copy-race-certificate\"\n            >\n              {imageCopied ? <Check className=\"w-4 h-4 text-green-500\" /> : <Clipboard className=\"w-4 h-4\" style={{ color: placementVisuals.color }} />}\n              <span className=\"text-zinc-200\">{imageCopied ? \"Copied!\" : \"Copy Image\"}</span>\n            </Button>\n            <Button\n              onClick={downloadCertificate}\n              variant=\"outline\"\n              className=\"gap-2 h-10 bg-zinc-800/50 border-zinc-600 hover:bg-zinc-700/50 hover:border-zinc-500\"\n              data-testid=\"button-download-race-certificate\"\n            >\n              <Download className=\"w-4 h-4 text-purple-400\" />\n              <span className=\"text-zinc-200\">Download</span>\n            </Button>\n          </div>\n        </div>\n\n        {'share' in navigator && (\n          <Button\n            onClick={shareCertificate}\n            disabled={isSharing}\n            className=\"w-full gap-2 h-11 text-white font-semibold\"\n            style={{ \n              background: `linear-gradient(135deg, ${placement <= 3 ? placementVisuals.color : tierVisuals.borderGradient[0]}, ${tierVisuals.primaryColor}, ${placement <= 3 ? placementVisuals.color : tierVisuals.borderGradient[2]})`,\n            }}\n            data-testid=\"button-share-race-certificate\"\n          >\n            <Share2 className=\"w-4 h-4\" />\n            {isSharing ? \"Sharing...\" : \"Share Certificate\"}\n          </Button>\n        )}\n        \n        <p className=\"text-[10px] text-center text-zinc-500\" data-testid=\"text-race-certificate-id\">\n          Certificate ID: <span className=\"font-mono\" style={{ color: placementVisuals.color }}>{certificateId}</span>\n        </p>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":22506,"size_tokens":null},"client/src/components/DictationCertificate.tsx":{"content":"import { useRef, useEffect, useMemo, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Download, Share2, Check, Clipboard, Mic } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { getTypingPerformanceRating, triggerCelebration } from \"@/lib/share-utils\";\n\ninterface DictationCertificateProps {\n  wpm: number;\n  accuracy: number;\n  consistency: number;\n  speedLevel: string;\n  sentencesCompleted: number;\n  totalWords: number;\n  duration: number;\n  username?: string;\n  date?: Date;\n}\n\ninterface TierVisuals {\n  primaryColor: string;\n  secondaryColor: string;\n  glowColor: string;\n  borderGradient: [string, string, string];\n  sealColor: string;\n}\n\nconst TIER_VISUALS: Record<string, TierVisuals> = {\n  Diamond: {\n    primaryColor: \"#00d4ff\",\n    secondaryColor: \"#9be7ff\",\n    glowColor: \"rgba(0, 212, 255, 0.5)\",\n    borderGradient: [\"#00d4ff\", \"#9be7ff\", \"#00d4ff\"],\n    sealColor: \"#00d4ff\",\n  },\n  Platinum: {\n    primaryColor: \"#c0c0c0\",\n    secondaryColor: \"#e8e8e8\",\n    glowColor: \"rgba(192, 192, 192, 0.5)\",\n    borderGradient: [\"#a0a0a0\", \"#e8e8e8\", \"#a0a0a0\"],\n    sealColor: \"#c0c0c0\",\n  },\n  Gold: {\n    primaryColor: \"#ffd700\",\n    secondaryColor: \"#ffed4a\",\n    glowColor: \"rgba(255, 215, 0, 0.5)\",\n    borderGradient: [\"#b8860b\", \"#ffd700\", \"#b8860b\"],\n    sealColor: \"#ffd700\",\n  },\n  Silver: {\n    primaryColor: \"#a8a8a8\",\n    secondaryColor: \"#d4d4d4\",\n    glowColor: \"rgba(168, 168, 168, 0.5)\",\n    borderGradient: [\"#808080\", \"#d4d4d4\", \"#808080\"],\n    sealColor: \"#a8a8a8\",\n  },\n  Bronze: {\n    primaryColor: \"#cd7f32\",\n    secondaryColor: \"#daa06d\",\n    glowColor: \"rgba(205, 127, 50, 0.5)\",\n    borderGradient: [\"#8b4513\", \"#cd7f32\", \"#8b4513\"],\n    sealColor: \"#cd7f32\",\n  },\n};\n\nexport function DictationCertificate({\n  wpm,\n  accuracy,\n  consistency,\n  speedLevel,\n  sentencesCompleted,\n  totalWords,\n  duration,\n  username,\n  date = new Date(),\n}: DictationCertificateProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [isSharing, setIsSharing] = useState(false);\n  const [imageCopied, setImageCopied] = useState(false);\n  const { toast } = useToast();\n\n  const rating = getTypingPerformanceRating(wpm, accuracy);\n  const tierVisuals = TIER_VISUALS[rating.badge] || TIER_VISUALS.Bronze;\n\n  const certificateId = useMemo(() => {\n    const data = `${wpm}-${accuracy}-${consistency}-${speedLevel}-${totalWords}-${duration}`;\n    let hash = 0;\n    for (let i = 0; i < data.length; i++) {\n      const char = data.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash;\n    }\n    const chars = \"ABCDEFGHJKLMNPQRSTUVWXYZ23456789\";\n    let id = \"TM-DICT-\";\n    const absHash = Math.abs(hash);\n    for (let i = 0; i < 8; i++) {\n      id += chars[(absHash >> (i * 4)) % chars.length];\n    }\n    return id;\n  }, [wpm, accuracy, consistency, speedLevel, totalWords, duration]);\n\n  useEffect(() => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const ctx = canvas.getContext(\"2d\");\n    if (!ctx) return;\n\n    const drawCertificate = () => {\n      const width = 1200;\n      const height = 900;\n\n      ctx.fillStyle = \"#0a0a0a\";\n      ctx.fillRect(0, 0, width, height);\n\n      const gradient = ctx.createLinearGradient(0, 0, width, height);\n      gradient.addColorStop(0, tierVisuals.borderGradient[0]);\n      gradient.addColorStop(0.5, tierVisuals.borderGradient[1]);\n      gradient.addColorStop(1, tierVisuals.borderGradient[2]);\n\n      ctx.strokeStyle = gradient;\n      ctx.lineWidth = 10;\n      ctx.strokeRect(30, 30, width - 60, height - 60);\n\n      ctx.strokeStyle = tierVisuals.primaryColor;\n      ctx.lineWidth = 3;\n      ctx.strokeRect(40, 40, width - 80, height - 80);\n\n      ctx.font = \"bold 56px system-ui, -apple-system, sans-serif\";\n      ctx.fillStyle = tierVisuals.primaryColor;\n      ctx.textAlign = \"center\";\n      ctx.fillText(\"CERTIFICATE OF ACHIEVEMENT\", width / 2, 120);\n\n      ctx.font = \"italic 28px Georgia, serif\";\n      ctx.fillStyle = \"#888\";\n      ctx.fillText(\"TypeMasterAI - Dictation Mode\", width / 2, 160);\n\n      const iconSize = 80;\n      const iconX = (width - iconSize) / 2;\n      const iconY = 190;\n      \n      ctx.save();\n      ctx.translate(iconX + iconSize / 2, iconY + iconSize / 2);\n      ctx.strokeStyle = tierVisuals.primaryColor;\n      ctx.lineWidth = 4;\n      ctx.beginPath();\n      ctx.arc(0, -15, 20, 0, Math.PI * 2);\n      ctx.moveTo(0, 5);\n      ctx.lineTo(-15, 40);\n      ctx.lineTo(15, 40);\n      ctx.closePath();\n      ctx.stroke();\n      ctx.restore();\n\n      ctx.font = \"32px system-ui, -apple-system, sans-serif\";\n      ctx.fillStyle = \"#fff\";\n      ctx.fillText(\"This certifies that\", width / 2, 320);\n\n      ctx.font = \"bold 52px Georgia, serif\";\n      ctx.fillStyle = tierVisuals.secondaryColor;\n      ctx.fillText(username || \"Typing Expert\", width / 2, 390);\n\n      ctx.font = \"28px system-ui, -apple-system, sans-serif\";\n      ctx.fillStyle = \"#ccc\";\n      ctx.fillText(\"has successfully completed the Dictation Challenge\", width / 2, 440);\n      ctx.fillText(`with exceptional listening and typing mastery`, width / 2, 475);\n\n      const metrics = [\n        { label: \"Speed\", value: `${wpm} WPM`, x: 200 },\n        { label: \"Accuracy\", value: `${accuracy.toFixed(1)}%`, x: 450 },\n        { label: \"Consistency\", value: `${consistency}%`, x: 700 },\n        { label: \"Level\", value: speedLevel, x: 950 },\n      ];\n\n      metrics.forEach(({ label, value, x }) => {\n        ctx.font = \"20px system-ui, -apple-system, sans-serif\";\n        ctx.fillStyle = \"#888\";\n        ctx.fillText(label, x, 560);\n\n        ctx.font = \"bold 32px system-ui, -apple-system, sans-serif\";\n        ctx.fillStyle = tierVisuals.primaryColor;\n        ctx.fillText(value, x, 600);\n      });\n\n      ctx.font = \"22px system-ui, -apple-system, sans-serif\";\n      ctx.fillStyle = \"#aaa\";\n      ctx.fillText(`${sentencesCompleted} Sentences â€¢ ${totalWords} Words â€¢ ${Math.floor(duration / 60)} Minutes`, width / 2, 670);\n\n      ctx.beginPath();\n      ctx.arc(width / 2, 760, 50, 0, Math.PI * 2);\n      ctx.fillStyle = tierVisuals.sealColor + \"40\";\n      ctx.fill();\n      ctx.strokeStyle = tierVisuals.sealColor;\n      ctx.lineWidth = 4;\n      ctx.stroke();\n\n      ctx.font = \"bold 18px system-ui, -apple-system, sans-serif\";\n      ctx.fillStyle = tierVisuals.primaryColor;\n      ctx.fillText(rating.badge.toUpperCase(), width / 2, 768);\n\n      ctx.font = \"16px system-ui, -apple-system, sans-serif\";\n      ctx.fillStyle = \"#666\";\n      ctx.fillText(`Issued: ${date.toLocaleDateString()}`, 150, height - 50);\n      ctx.textAlign = \"right\";\n      ctx.fillText(`Certificate ID: ${certificateId}`, width - 150, height - 50);\n    };\n\n    drawCertificate();\n  }, [wpm, accuracy, consistency, speedLevel, sentencesCompleted, totalWords, duration, username, date, rating.badge, tierVisuals, certificateId]);\n\n  const downloadImage = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const link = document.createElement(\"a\");\n    link.download = `typemaster-dictation-certificate-${certificateId}.png`;\n    link.href = canvas.toDataURL(\"image/png\");\n    link.click();\n\n    toast({\n      title: \"Certificate Downloaded!\",\n      description: \"Your dictation certificate has been saved.\",\n    });\n\n    triggerCelebration();\n  };\n\n  const shareToSocial = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    setIsSharing(true);\n\n    try {\n      const blob = await new Promise<Blob>((resolve) => {\n        canvas.toBlob((b) => resolve(b!), \"image/png\");\n      });\n\n      if (navigator.share && navigator.canShare({ files: [new File([blob], \"certificate.png\", { type: \"image/png\" })] })) {\n        await navigator.share({\n          title: \"TypeMasterAI Dictation Certificate\",\n          text: `I achieved ${wpm} WPM with ${accuracy.toFixed(1)}% accuracy in Dictation Mode! ðŸŽ¯`,\n          files: [new File([blob], \"certificate.png\", { type: \"image/png\" })],\n        });\n      } else {\n        await navigator.clipboard.write([\n          new ClipboardItem({\n            \"image/png\": blob,\n          }),\n        ]);\n        setImageCopied(true);\n        setTimeout(() => setImageCopied(false), 2000);\n        toast({\n          title: \"Image Copied!\",\n          description: \"Certificate image copied to clipboard. Paste it anywhere!\",\n        });\n      }\n    } catch (error) {\n      console.error(\"Share error:\", error);\n      toast({\n        title: \"Share Failed\",\n        description: \"Please try downloading instead.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSharing(false);\n    }\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <canvas\n        ref={canvasRef}\n        width={1200}\n        height={900}\n        className=\"w-full border-2 border-border rounded-lg shadow-2xl\"\n        style={{ maxWidth: \"100%\" }}\n      />\n\n      <div className=\"flex gap-2 justify-center\">\n        <Button onClick={downloadImage} className=\"gap-2\" data-testid=\"button-download-certificate\">\n          <Download className=\"w-4 h-4\" />\n          Download Certificate\n        </Button>\n\n        <Button onClick={shareToSocial} variant=\"outline\" className=\"gap-2\" disabled={isSharing} data-testid=\"button-share-certificate\">\n          {imageCopied ? (\n            <>\n              <Check className=\"w-4 h-4\" />\n              Image Copied!\n            </>\n          ) : (\n            <>\n              <Share2 className=\"w-4 h-4\" />\n              {isSharing ? \"Sharing...\" : \"Share Certificate\"}\n            </>\n          )}\n        </Button>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":9604,"size_tokens":null},"client/src/components/StressCertificate.tsx":{"content":"import { useRef, useEffect, useMemo, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Download, Share2, Check, Zap } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { getTypingPerformanceRating, triggerCelebration } from \"@/lib/share-utils\";\n\ninterface StressCertificateProps {\n  wpm: number;\n  accuracy: number;\n  consistency: number;\n  difficulty: string;\n  stressScore: number;\n  maxCombo: number;\n  completionRate: number;\n  survivalTime: number;\n  activeChallenges: number;\n  duration: number;\n  username?: string;\n  date?: Date;\n}\n\ninterface TierVisuals {\n  primaryColor: string;\n  secondaryColor: string;\n  glowColor: string;\n  borderGradient: [string, string, string];\n  sealColor: string;\n}\n\nconst TIER_VISUALS: Record<string, TierVisuals> = {\n  Diamond: {\n    primaryColor: \"#00d4ff\",\n    secondaryColor: \"#9be7ff\",\n    glowColor: \"rgba(0, 212, 255, 0.5)\",\n    borderGradient: [\"#00d4ff\", \"#9be7ff\", \"#00d4ff\"],\n    sealColor: \"#00d4ff\",\n  },\n  Platinum: {\n    primaryColor: \"#c0c0c0\",\n    secondaryColor: \"#e8e8e8\",\n    glowColor: \"rgba(192, 192, 192, 0.5)\",\n    borderGradient: [\"#a0a0a0\", \"#e8e8e8\", \"#a0a0a0\"],\n    sealColor: \"#c0c0c0\",\n  },\n  Gold: {\n    primaryColor: \"#ffd700\",\n    secondaryColor: \"#ffed4a\",\n    glowColor: \"rgba(255, 215, 0, 0.5)\",\n    borderGradient: [\"#b8860b\", \"#ffd700\", \"#b8860b\"],\n    sealColor: \"#ffd700\",\n  },\n  Silver: {\n    primaryColor: \"#a8a8a8\",\n    secondaryColor: \"#d4d4d4\",\n    glowColor: \"rgba(168, 168, 168, 0.5)\",\n    borderGradient: [\"#808080\", \"#d4d4d4\", \"#808080\"],\n    sealColor: \"#a8a8a8\",\n  },\n  Bronze: {\n    primaryColor: \"#cd7f32\",\n    secondaryColor: \"#daa06d\",\n    glowColor: \"rgba(205, 127, 50, 0.5)\",\n    borderGradient: [\"#8b4513\", \"#cd7f32\", \"#8b4513\"],\n    sealColor: \"#cd7f32\",\n  },\n};\n\nexport function StressCertificate({\n  wpm,\n  accuracy,\n  consistency,\n  difficulty,\n  stressScore,\n  maxCombo,\n  completionRate,\n  survivalTime,\n  activeChallenges,\n  duration,\n  username,\n  date = new Date(),\n}: StressCertificateProps) {\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n  const [isSharing, setIsSharing] = useState(false);\n  const [imageCopied, setImageCopied] = useState(false);\n  const { toast } = useToast();\n\n  const rating = getTypingPerformanceRating(wpm, accuracy);\n  const tierVisuals = TIER_VISUALS[rating.badge] || TIER_VISUALS.Bronze;\n\n  const certificateId = useMemo(() => {\n    const data = `${wpm}-${accuracy}-${stressScore}-${difficulty}-${survivalTime}-${duration}`;\n    let hash = 0;\n    for (let i = 0; i < data.length; i++) {\n      const char = data.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash;\n    }\n    const chars = \"ABCDEFGHJKLMNPQRSTUVWXYZ23456789\";\n    let id = \"TM-STRESS-\";\n    const absHash = Math.abs(hash);\n    for (let i = 0; i < 8; i++) {\n      id += chars[(absHash >> (i * 4)) % chars.length];\n    }\n    return id;\n  }, [wpm, accuracy, stressScore, difficulty, survivalTime, duration]);\n\n  useEffect(() => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const ctx = canvas.getContext(\"2d\");\n    if (!ctx) return;\n\n    const drawCertificate = () => {\n      const width = 1200;\n      const height = 900;\n\n      ctx.fillStyle = \"#0a0a0a\";\n      ctx.fillRect(0, 0, width, height);\n\n      const gradient = ctx.createLinearGradient(0, 0, width, height);\n      gradient.addColorStop(0, tierVisuals.borderGradient[0]);\n      gradient.addColorStop(0.5, tierVisuals.borderGradient[1]);\n      gradient.addColorStop(1, tierVisuals.borderGradient[2]);\n\n      ctx.strokeStyle = gradient;\n      ctx.lineWidth = 10;\n      ctx.strokeRect(30, 30, width - 60, height - 60);\n\n      ctx.strokeStyle = tierVisuals.primaryColor;\n      ctx.lineWidth = 3;\n      ctx.strokeRect(40, 40, width - 80, height - 80);\n\n      ctx.font = \"bold 56px system-ui, -apple-system, sans-serif\";\n      ctx.fillStyle = tierVisuals.primaryColor;\n      ctx.textAlign = \"center\";\n      ctx.fillText(\"CERTIFICATE OF RESILIENCE\", width / 2, 120);\n\n      ctx.font = \"italic 28px Georgia, serif\";\n      ctx.fillStyle = \"#888\";\n      ctx.fillText(\"TypeMasterAI - Stress Test Mode\", width / 2, 160);\n\n      const iconSize = 80;\n      const iconX = (width - iconSize) / 2;\n      const iconY = 190;\n      \n      ctx.save();\n      ctx.translate(iconX + iconSize / 2, iconY + iconSize / 2);\n      ctx.strokeStyle = tierVisuals.primaryColor;\n      ctx.fillStyle = tierVisuals.primaryColor;\n      ctx.lineWidth = 4;\n      ctx.beginPath();\n      ctx.moveTo(-10, 20);\n      ctx.lineTo(-10, -20);\n      ctx.lineTo(10, 0);\n      ctx.closePath();\n      ctx.fill();\n      ctx.beginPath();\n      ctx.moveTo(-25, -15);\n      ctx.lineTo(-25, 15);\n      ctx.moveTo(15, -15);\n      ctx.lineTo(15, 15);\n      ctx.stroke();\n      ctx.restore();\n\n      ctx.font = \"32px system-ui, -apple-system, sans-serif\";\n      ctx.fillStyle = \"#fff\";\n      ctx.fillText(\"This certifies that\", width / 2, 320);\n\n      ctx.font = \"bold 52px Georgia, serif\";\n      ctx.fillStyle = tierVisuals.secondaryColor;\n      ctx.fillText(username || \"Typing Champion\", width / 2, 390);\n\n      ctx.font = \"28px system-ui, -apple-system, sans-serif\";\n      ctx.fillStyle = \"#ccc\";\n      ctx.fillText(\"has demonstrated exceptional composure under pressure\", width / 2, 440);\n      ctx.fillText(`conquering ${activeChallenges} simultaneous challenges`, width / 2, 475);\n\n      const metrics = [\n        { label: \"Stress Score\", value: `${stressScore}`, x: 200 },\n        { label: \"Max Combo\", value: `${maxCombo}`, x: 450 },\n        { label: \"Completion\", value: `${completionRate.toFixed(1)}%`, x: 700 },\n        { label: \"WPM\", value: `${wpm}`, x: 950 },\n      ];\n\n      metrics.forEach(({ label, value, x }) => {\n        ctx.font = \"20px system-ui, -apple-system, sans-serif\";\n        ctx.fillStyle = \"#888\";\n        ctx.fillText(label, x, 560);\n\n        ctx.font = \"bold 32px system-ui, -apple-system, sans-serif\";\n        ctx.fillStyle = tierVisuals.primaryColor;\n        ctx.fillText(value, x, 600);\n      });\n\n      ctx.font = \"22px system-ui, -apple-system, sans-serif\";\n      ctx.fillStyle = \"#aaa\";\n      ctx.fillText(`${difficulty.charAt(0).toUpperCase() + difficulty.slice(1)} Difficulty â€¢ Survived ${Math.floor(survivalTime / 60)}:${(survivalTime % 60).toString().padStart(2, '0')}`, width / 2, 670);\n\n      ctx.beginPath();\n      ctx.arc(width / 2, 760, 50, 0, Math.PI * 2);\n      ctx.fillStyle = tierVisuals.sealColor + \"40\";\n      ctx.fill();\n      ctx.strokeStyle = tierVisuals.sealColor;\n      ctx.lineWidth = 4;\n      ctx.stroke();\n\n      ctx.font = \"bold 18px system-ui, -apple-system, sans-serif\";\n      ctx.fillStyle = tierVisuals.primaryColor;\n      ctx.fillText(rating.badge.toUpperCase(), width / 2, 768);\n\n      ctx.font = \"16px system-ui, -apple-system, sans-serif\";\n      ctx.fillStyle = \"#666\";\n      ctx.fillText(`Issued: ${date.toLocaleDateString()}`, 150, height - 50);\n      ctx.textAlign = \"right\";\n      ctx.fillText(`Certificate ID: ${certificateId}`, width - 150, height - 50);\n    };\n\n    drawCertificate();\n  }, [wpm, accuracy, difficulty, stressScore, maxCombo, completionRate, survivalTime, activeChallenges, duration, username, date, rating.badge, tierVisuals, certificateId]);\n\n  const downloadImage = () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const link = document.createElement(\"a\");\n    link.download = `typemaster-stress-certificate-${certificateId}.png`;\n    link.href = canvas.toDataURL(\"image/png\");\n    link.click();\n\n    toast({\n      title: \"Certificate Downloaded!\",\n      description: \"Your stress test certificate has been saved.\",\n    });\n\n    triggerCelebration();\n  };\n\n  const shareToSocial = async () => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    setIsSharing(true);\n\n    try {\n      const blob = await new Promise<Blob>((resolve) => {\n        canvas.toBlob((b) => resolve(b!), \"image/png\");\n      });\n\n      if (navigator.share && navigator.canShare({ files: [new File([blob], \"certificate.png\", { type: \"image/png\" })] })) {\n        await navigator.share({\n          title: \"TypeMasterAI Stress Test Certificate\",\n          text: `I achieved a Stress Score of ${stressScore} with ${wpm} WPM under extreme pressure! ðŸ’ªâš¡`,\n          files: [new File([blob], \"certificate.png\", { type: \"image/png\" })],\n        });\n      } else {\n        await navigator.clipboard.write([\n          new ClipboardItem({\n            \"image/png\": blob,\n          }),\n        ]);\n        setImageCopied(true);\n        setTimeout(() => setImageCopied(false), 2000);\n        toast({\n          title: \"Image Copied!\",\n          description: \"Certificate image copied to clipboard. Paste it anywhere!\",\n        });\n      }\n    } catch (error) {\n      console.error(\"Share error:\", error);\n      toast({\n        title: \"Share Failed\",\n        description: \"Please try downloading instead.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsSharing(false);\n    }\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <canvas\n        ref={canvasRef}\n        width={1200}\n        height={900}\n        className=\"w-full border-2 border-border rounded-lg shadow-2xl\"\n        style={{ maxWidth: \"100%\" }}\n      />\n\n      <div className=\"flex gap-2 justify-center\">\n        <Button onClick={downloadImage} className=\"gap-2\" data-testid=\"button-download-certificate\">\n          <Download className=\"w-4 h-4\" />\n          Download Certificate\n        </Button>\n\n        <Button onClick={shareToSocial} variant=\"outline\" className=\"gap-2\" disabled={isSharing} data-testid=\"button-share-certificate\">\n          {imageCopied ? (\n            <>\n              <Check className=\"w-4 h-4\" />\n              Image Copied!\n            </>\n          ) : (\n            <>\n              <Share2 className=\"w-4 h-4\" />\n              {isSharing ? \"Sharing...\" : \"Share Certificate\"}\n            </>\n          )}\n        </Button>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":9991,"size_tokens":null},"client/src/hooks/useCertificates.ts":{"content":"import { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Certificate } from \"@shared/schema\";\n\ninterface CreateCertificateData {\n  certificateType: \"standard\" | \"code\" | \"book\" | \"race\" | \"dictation\" | \"stress\";\n  testResultId?: number;\n  codeTestId?: number;\n  bookTestId?: number;\n  raceId?: number;\n  dictationTestId?: number;\n  stressTestId?: number;\n  wpm: number;\n  accuracy: number;\n  consistency: number;\n  duration: number;\n  metadata?: Record<string, any>;\n}\n\nexport function useCreateCertificate() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: async (data: CreateCertificateData) => {\n      const response = await fetch(\"/api/certificates\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify(data),\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to create certificate\");\n      }\n\n      return response.json() as Promise<Certificate>;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"certificates\"] });\n      toast({\n        title: \"Certificate Created! ðŸŽ‰\",\n        description: \"Your achievement certificate has been generated successfully.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Certificate Creation Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n}\n\nexport function useUserCertificates(userId?: string, certificateType?: string) {\n  return useQuery({\n    queryKey: [\"certificates\", userId, certificateType],\n    queryFn: async () => {\n      const params = new URLSearchParams();\n      if (certificateType && certificateType !== \"all\") {\n        params.append(\"type\", certificateType);\n      }\n\n      const response = await fetch(`/api/certificates?${params.toString()}`, {\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch certificates\");\n      }\n\n      return response.json() as Promise<Certificate[]>;\n    },\n    enabled: !!userId,\n    staleTime: 30000,\n  });\n}\n\nexport function useCertificateById(id: number) {\n  return useQuery({\n    queryKey: [\"certificate\", id],\n    queryFn: async () => {\n      const response = await fetch(`/api/certificates/${id}`, {\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch certificate\");\n      }\n\n      return response.json() as Promise<Certificate>;\n    },\n    enabled: !!id,\n    staleTime: 60000,\n  });\n}\n\nexport function useCertificateByShareId(shareId: string) {\n  return useQuery({\n    queryKey: [\"certificate\", \"shared\", shareId],\n    queryFn: async () => {\n      const response = await fetch(`/api/certificates/share/${shareId}`, {\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        throw new Error(\"Failed to fetch shared certificate\");\n      }\n\n      return response.json() as Promise<Certificate>;\n    },\n    enabled: !!shareId,\n    staleTime: 60000,\n  });\n}\n\nexport function useDeleteCertificate() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  return useMutation({\n    mutationFn: async (id: number) => {\n      const response = await fetch(`/api/certificates/${id}`, {\n        method: \"DELETE\",\n        credentials: \"include\",\n      });\n\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || \"Failed to delete certificate\");\n      }\n\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"certificates\"] });\n      toast({\n        title: \"Certificate Deleted\",\n        description: \"Your certificate has been removed.\",\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Delete Failed\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n}\n","path":null,"size_bytes":4115,"size_tokens":null}},"version":2}